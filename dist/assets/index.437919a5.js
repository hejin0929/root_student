var lg=Object.defineProperty;var hg=(o,t,e)=>t in o?lg(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var Zd=(o,t,e)=>(hg(o,typeof t!="symbol"?t+"":t,e),e);import{u as cg}from"./index.0be79017.js";import{m as dg,o as ug,r as Jd,j as Qd}from"./vendor.0d2e9121.js";const fg="_rootRender_1vhy9_1",mg="_rootCanvas_1vhy9_5";var tu={rootRender:fg,rootCanvas:mg};/**
 * @license
 * PlayCanvas Engine v1.53.4 revision 25b117788
 * Copyright 2011-2022 PlayCanvas Ltd. All rights reserved.
 */function ti(o,t,e){o.prototype[t]||Object.defineProperty(o.prototype,t,{value:e,configurable:!0,enumerable:!1,writable:!0})}ti(Array,"fill",function(o){if(this==null)throw new TypeError("this is null or not defined");for(var t=Object(this),e=t.length>>>0,s=arguments[1],i=s>>0,n=i<0?Math.max(e+i,0):Math.min(i,e),r=arguments[2],a=r===void 0?e:r>>0,l=a<0?Math.max(e+a,0):Math.min(a,e);n<l;)t[n]=o,n++;return t});ti(Array,"find",function(o){if(this==null)throw TypeError('"this" is null or not defined');var t=Object(this),e=t.length>>>0;if(typeof o!="function")throw TypeError("predicate must be a function");for(var s=arguments[1],i=0;i<e;){var n=t[i];if(o.call(s,n,i,t))return n;i++}});ti(Array,"findIndex",function(o){if(this==null)throw new TypeError('"this" is null or not defined');var t=Object(this),e=t.length>>>0;if(typeof o!="function")throw new TypeError("predicate must be a function");for(var s=arguments[1],i=0;i<e;){var n=t[i];if(o.call(s,n,i,t))return i;i++}return-1});Math.log2=Math.log2||function(o){return Math.log(o)*Math.LOG2E};Math.sign||(Math.sign=function(o){return(o>0)-(o<0)||+o});Number.isFinite===void 0&&(Number.isFinite=function(o){return typeof o=="number"&&isFinite(o)});typeof Object.assign!="function"&&Object.defineProperty(Object,"assign",{value:function(t,e){if(t==null)throw new TypeError("Cannot convert undefined or null to object");for(var s=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(n!=null)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(s[r]=n[r])}return s},writable:!0,configurable:!0});(function(){if(!(typeof navigator=="undefined"||typeof document=="undefined")){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var o=function(){var s=document.createEvent("CustomEvent");s.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(s)},t=function(){var s=document.createEvent("CustomEvent");s.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(s)};document.addEventListener("webkitpointerlockchange",o,!1),document.addEventListener("webkitpointerlocklost",o,!1),document.addEventListener("mozpointerlockchange",o,!1),document.addEventListener("mozpointerlocklost",o,!1),document.addEventListener("webkitpointerlockerror",t,!1),document.addEventListener("mozpointerlockerror",t,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){var e=this;document.pointerLockElement=e,navigator.pointer.lock(e,o,t)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}})();(function(){if(typeof window!="undefined"){for(var o=0,t=["ms","moz","webkit","o"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(s,i){var n=new Date().getTime(),r=Math.max(0,16-(n-o)),a=window.setTimeout(function(){s(n+r)},r);return o=n+r,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(s){clearTimeout(s)})}})();ti(String,"endsWith",function(o,t){return(t===void 0||t>this.length)&&(t=this.length),this.substring(t-o.length,t)===o});ti(String,"includes",function(o,t){return typeof t!="number"&&(t=0),t+o.length>this.length?!1:this.indexOf(o,t)!==-1});ti(String,"startsWith",function(o,t){return this.substr(!t||t<0?0:+t,o.length)===o});const pg=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array];for(const o of pg)ti(o,"fill",Array.prototype.fill),ti(o,"join",Array.prototype.join);var sr={};function _g(o){window.console&&window.console.error&&window.console.error(o)}function gg(o){window.console&&window.console.log&&window.console.log(o)}function yg(o,t){sr[o]=!0,t!==void 0&&_g(t)}function xg(o){var t=o.getError;o.getError=function(){var e;do e=t.apply(o),e!=o.NO_ERROR&&(sr[e]=!0);while(e!=o.NO_ERROR);for(var e in sr)if(sr[e])return delete sr[e],parseInt(e);return o.NO_ERROR}}var ir=function o(t){var e=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var s=0;s<this.attribs.length;s++){var i=new o.VertexAttrib(e);this.attribs[s]=i}this.maxAttrib=0};ir.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};ir.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var wi=function(t){var e=this;this.gl=t,xg(t);var s=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(n){return n==e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject==e.defaultVertexArrayObject?null:e.currentVertexArrayObject:s.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(n){var r=e.currentVertexArrayObject;r.maxAttrib=Math.max(r.maxAttrib,n);var a=r.attribs[n];return a.enabled=!0,s.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(n){var r=e.currentVertexArrayObject;r.maxAttrib=Math.max(r.maxAttrib,n);var a=r.attribs[n];return a.enabled=!1,s.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(n,r){switch(n){case t.ARRAY_BUFFER:e.currentArrayBuffer=r;break;case t.ELEMENT_ARRAY_BUFFER:e.currentVertexArrayObject.elementArrayBuffer=r;break}return s.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(n,r){var a=e.currentVertexArrayObject,l=a.attribs[n];switch(r){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return l.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return l.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return l.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return l.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return l.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return l.normalized;default:return s.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(n,r,a,l,h,c){var d=e.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,n);var u=d.attribs[n];return u.buffer=e.currentArrayBuffer,u.size=r,u.type=a,u.normalized=l,u.stride=h,u.offset=c,u.recache(),s.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",function(){gg("OESVertexArrayObject emulation library context restored"),e.reset_()},!0),this.reset_()};wi.prototype.VERTEX_ARRAY_BINDING_OES=34229;wi.prototype.reset_=function(){var t=this.vertexArrayObjects!==void 0;if(t)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var s=this.gl;this.maxVertexAttribs=s.getParameter(s.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new ir(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};wi.prototype.createVertexArrayOES=function(){var t=new ir(this);return this.vertexArrayObjects.push(t),t};wi.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)};wi.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof ir&&t.hasBeenBound&&t.ext==this)};wi.prototype.bindVertexArrayOES=function(t){var e=this.gl;if(t&&!t.isAlive){yg(e.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}var s=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var n=this.currentVertexArrayObject;if(i!=n){(!i||n.elementArrayBuffer!=i.elementArrayBuffer)&&s.bindBuffer.call(e,e.ELEMENT_ARRAY_BUFFER,n.elementArrayBuffer);for(var r=this.currentArrayBuffer,a=Math.max(i?i.maxAttrib:0,n.maxAttrib),l=0;l<=a;l++){var h=n.attribs[l],c=i?i.attribs[l]:null;if((!i||h.enabled!=c.enabled)&&(h.enabled?s.enableVertexAttribArray.call(e,l):s.disableVertexAttribArray.call(e,l)),h.enabled){var d=!1;(!i||h.buffer!=c.buffer)&&(r!=h.buffer&&(s.bindBuffer.call(e,e.ARRAY_BUFFER,h.buffer),r=h.buffer),d=!0),(d||h.cached!=c.cached)&&s.vertexAttribPointer.call(e,l,h.size,h.type,h.normalized,h.stride,h.offset)}}this.currentArrayBuffer!=r&&s.bindBuffer.call(e,e.ARRAY_BUFFER,this.currentArrayBuffer)}};const vg=function(t){if(t.getSupportedExtensions){var e=t.getSupportedExtensions();if(e.indexOf("OES_vertex_array_object")!=-1)return}else if(t.getExtension){var s=t.getExtension("OES_vertex_array_object");if(s)return}if(t.getSupportedExtensions){var i=t.getSupportedExtensions;t.getSupportedExtensions=function(){var a=i.call(this)||[];return a.push("OES_vertex_array_object"),a}}var n=t.getExtension;t.getExtension=function(a){return a=="OES_vertex_array_object"?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new wi(t)),t.__OESVertexArrayObject):n?n.call(this,a):null}},Sg="1.53.4",bg="25b117788",wg=function(){const o={},t=["Array","Object","Function","Date","RegExp","Float32Array"];for(let e=0;e<t.length;e++)o["[object "+t[e]+"]"]=t[e].toLowerCase();return o}();function eu(o){if(o===null)return"null";const t=typeof o;return t==="undefined"||t==="number"||t==="string"||t==="boolean"?t:wg[Object.prototype.toString.call(o)]}function ei(o,t){for(const e in t){const s=t[e];eu(s)==="object"?o[e]=ei({},s):eu(s)==="array"?o[e]=ei([],s):o[e]=s}return o}function su(o){let t;return o!==t}class at{constructor(){this._callbacks={},this._callbackActive={}}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(t,e,s,i=!1){!t||typeof t!="string"||!e||(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:s||this,once:i}))}on(t,e,s){return this._addCallback(t,e,s,!1),this}off(t,e,s){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const i in this._callbackActive)!this._callbacks[i]||this._callbacks[i]===this._callbackActive[i]&&(this._callbackActive[i]=this._callbackActive[i].slice());if(!t)this._callbacks={};else if(!e)this._callbacks[t]&&(this._callbacks[t]=[]);else{const i=this._callbacks[t];if(!i)return this;let n=i.length;for(let r=0;r<n;r++)i[r].callback===e&&(s&&i[r].scope!==s||(i[r--]=i[--n]));i.length=n}return this}fire(t,e,s,i,n,r,a,l,h){if(!t||!this._callbacks[t])return this;let c;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),c=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let d=0;(c||this._callbackActive[t])&&d<(c||this._callbackActive[t]).length;d++){const u=(c||this._callbackActive[t])[d];if(u.callback.call(u.scope,e,s,i,n,r,a,l,h),u.once){const f=this._callbacks[t],m=f?f.indexOf(u):-1;m!==-1&&(this._callbackActive[t]===f&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(m,1))}}return c||(this._callbackActive[t]=null),this}once(t,e,s){return this._addCallback(t,e,s,!0),this}hasEvent(t){return this._callbacks[t]&&this._callbacks[t].length!==0||!1}}const Kl={attach:function(o){const t=Kl;return o._addCallback=t._addCallback,o.on=t.on,o.off=t.off,o.fire=t.fire,o.once=t.once,o.hasEvent=t.hasEvent,o._callbacks={},o._callbackActive={},o},_addCallback:at.prototype._addCallback,on:at.prototype.on,off:at.prototype.off,fire:at.prototype.fire,once:at.prototype.once,hasEvent:at.prototype.hasEvent},Tg={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){const t=Math.random()*16|0;return(o==="x"?t:t&3|8).toString(16)})}},ot={delimiter:"/",join:function(){const o=arguments.length;let t=arguments[0];for(let e=0;e<o-1;++e){const s=arguments[e],i=arguments[e+1];if(!su(s)||!su(i))throw new Error("undefined argument to pc.path.join");if(i[0]===ot.delimiter){t=i;continue}s&&i&&s[s.length-1]!==ot.delimiter&&i[0]!==ot.delimiter?t+=ot.delimiter+i:t+=i}return t},normalize:function(o){const t=o.startsWith(ot.delimiter),e=o.endsWith(ot.delimiter),s=o.split("/");let i="",n=[];for(let r=0;r<s.length;r++)if(s[r]!==""&&s[r]!=="."){if(s[r]===".."&&n.length>0){n=n.slice(0,n.length-2);continue}r>0&&n.push(ot.delimiter),n.push(s[r])}return i=n.join(""),!t&&i[0]===ot.delimiter&&(i=i.slice(1)),e&&i[i.length-1]!==ot.delimiter&&(i+=ot.delimiter),i},split:function(o){const t=o.split(ot.delimiter),e=t.slice(t.length-1)[0];return[t.slice(0,t.length-1).join(ot.delimiter),e]},getBasename:function(o){return ot.split(o)[1]},getDirectory:function(o){const t=o.split(ot.delimiter);return t.slice(0,t.length-1).join(ot.delimiter)},getExtension:function(o){const t=o.split("?")[0].split(".").pop();return t!==o?"."+t:""},isRelativePath:function(o){return o.charAt(0)!=="/"&&o.match(/:\/\//)===null},extractPath:function(o){let t="";const e=o.split("/");let s=0;if(e.length>1)if(ot.isRelativePath(o))if(e[0]===".")for(s=0;s<e.length-1;++s)t+=s===0?e[s]:"/"+e[s];else if(e[0]==="..")for(s=0;s<e.length-1;++s)t+=s===0?e[s]:"/"+e[s];else for(t=".",s=0;s<e.length-1;++s)t+="/"+e[s];else for(s=0;s<e.length-1;++s)t+=s===0?e[s]:"/"+e[s];return t}};let nr=!1,va=!1,iu=!1,nu=!1,ru=!1,au=!1,ou=!1,lu=!1,hu=!1,cu=!1;if(typeof navigator!="undefined"){const o=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(o)&&(nr=!0),/xbox/i.test(o)&&(nu=!0),/(windows phone|iemobile|wpdesktop)/i.test(o)?(nr=!1,va=!0,iu=!0):/android/i.test(o)?(nr=!1,va=!0,ru=!0):/ip([ao]d|hone)/i.test(o)&&(nr=!1,va=!0,au=!0),typeof window!="undefined"&&(ou="ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),lu="getGamepads"in navigator,hu=typeof Worker!="undefined";try{const t=Object.defineProperty({},"passive",{get:function(){return cu=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch{}}const Zl=typeof window!="undefined"?"browser":"node",Dt={environment:Zl,global:Zl==="browser"?window:global,browser:Zl==="browser",desktop:nr,mobile:va,ios:au,android:ru,windows:iu,xbox:nu,gamepads:lu,touch:ou,workers:hu,passiveEvents:cu},du="abcdefghijklmnopqrstuvwxyz",uu="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Cg=du+uu,Jl=55296,fu=56319,mu=56320,Ag=57343,Mg=8205,pu=127462,_u=127487,Pg=127995,Eg=127999,Rg=8400,Ig=8447,Ql=65024,th=65039;function eh(o,t=0){const e=o.length;if(t<0||t>=e)return null;const s=o.charCodeAt(t);if(e>1&&s>=Jl&&s<=fu){const i=o.charCodeAt(t+1);if(i>=mu&&i<=Ag)return{code:(s-Jl)*1024+i-mu+65536,long:!0}}return{code:s,long:!1}}function si(o,t,e){if(!o)return!1;const s=eh(o);if(s){const i=s.code;return i>=t&&i<=e}return!1}function Lg(o,t){if(t===o.length-1)return 1;if(si(o[t],Jl,fu)){const e=o.substring(t,t+2),s=o.substring(t+2,t+4);return si(s,Pg,Eg)||si(e,pu,_u)&&si(s,pu,_u)?4:si(s,Ql,th)?3:2}return si(o[t+1],Ql,th)?2:1}const an={ASCII_LOWERCASE:du,ASCII_UPPERCASE:uu,ASCII_LETTERS:Cg,format:function(o){for(let t=1;t<arguments.length;t++)o=o.replace("{"+(t-1)+"}",arguments[t]);return o},toBool:function(o,t=!1){if(o==="true")return!0;if(t){if(o==="false")return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(o,t){const e=eh(o,t);return e&&e.code},getCodePoints:function(o){if(typeof o!="string")throw new TypeError("Not a string");let t=0;const e=[];let s;for(;s=eh(o,t);)e.push(s.code),t+=s.long?2:1;return e},getSymbols:function(o){if(typeof o!="string")throw new TypeError("Not a string");let t=0;const e=o.length,s=[];let i=0,n;for(;t<e;){if(i+=Lg(o,t+i),n=o[t+i],si(n,Rg,Ig)&&(n=o[t+i++]),si(n,Ql,th)&&(n=o[t+i++]),n&&n.charCodeAt(0)===Mg){n=o[t+i++];continue}const r=o.substring(t,t+i);s.push(r),t+=i,i=0}return s},fromCodePoint:function(){const o=[];let t,e,s;for(let i=0;i<arguments.length;++i)t=Number(arguments[i]),e=t-65536,s=t>65535?[(e>>10)+55296,e%1024+56320]:[t],o.push(String.fromCharCode.apply(null,s));return o.join("")}};class Dg{constructor(){this._list=[],this._index={}}push(t,e){if(this._index[t])throw Error("Key already in index "+t);const s=this._list.push(e)-1;this._index[t]=s}has(t){return this._index[t]!==void 0}get(t){const e=this._index[t];return e!==void 0?this._list[e]:null}remove(t){const e=this._index[t];if(e!==void 0){this._list.splice(e,1),delete this._index[t];for(t in this._index){const s=this._index[t];s>e&&(this._index[t]=s-1)}return!0}return!1}list(){return this._list}clear(){this._list.length=0;for(const t in this._index)delete this._index[t]}}class gu{constructor(t){this.arraybuffer=t,this.dataView=new DataView(t),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const s=String.fromCharCode(this.readU8());if(s===`
`)break;e+=s}return e}}class Sa{constructor(t){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=t.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(t){let e=0,s=this.items.length-1;const i=t[this._sortBy];let n,r;for(;e<=s;)n=Math.floor((e+s)/2),r=this.items[n][this._sortBy],r<=i?e=n+1:r>i&&(s=n-1);return e}_doSort(t,e){const s=this._sortBy;return t[s]-e[s]}insert(t){const e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++}append(t){this.items.push(t),this.length++}remove(t){const e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)}sort(){const t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),t!==null&&(this.loopIndex=this.items.indexOf(t))}}class yu extends at{constructor(t){super();this._index={},this._list=[],this._parent=t}add(){let t=!1;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]||(t=!0,this._index[e[s]]=!0,this._list.push(e[s]),this.fire("add",e[s],this._parent));return t&&this.fire("change",this._parent),t}remove(){let t=!1;if(!this._list.length)return t;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)!this._index[e[s]]||(t=!0,delete this._index[e[s]],this._list.splice(this._list.indexOf(e[s]),1),this.fire("remove",e[s],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(){return this._list.length?this._has(this._processArguments(arguments)):!1}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(t[e].length===1){if(this._index[t[e][0]])return!0}else{let s=!0;for(let i=0;i<t[e].length;i++)if(!this._index[t[e][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let i=[];if(!t||!t.length)return s;for(let n=0;n<t.length;n++)if(t[n]instanceof Array){e||(i=[]);for(let r=0;r<t[n].length;r++)typeof t[n][r]=="string"&&(e?s.push(t[n][r]):i.push(t[n][r]));!e&&i.length&&s.push(i)}else typeof t[n]=="string"&&(e?s.push(t[n]):s.push([t[n]]));return s}get size(){return this._list.length}}const ds=typeof window!="undefined"&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now,Fg=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class sh{constructor(t){const e=t.match(Fg);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const i=s.split("=");t[i[0]]=i[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(e!==""&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));this.query=e}}const U={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(o,t,e){return o>=e?e:o<=t?t:o},intToBytes24:function(o){const t=o>>16&255,e=o>>8&255,s=o&255;return[t,e,s]},intToBytes32:function(o){const t=o>>24&255,e=o>>16&255,s=o>>8&255,i=o&255;return[t,e,s,i]},bytesToInt24:function(o,t,e){return o.length&&(e=o[2],t=o[1],o=o[0]),o<<16|t<<8|e},bytesToInt32:function(o,t,e,s){return o.length&&(s=o[3],e=o[2],t=o[1],o=o[0]),(o<<24|t<<16|e<<8|s)>>>0},lerp:function(o,t,e){return o+(t-o)*U.clamp(e,0,1)},lerpAngle:function(o,t,e){return t-o>180&&(t-=360),t-o<-180&&(t+=360),U.lerp(o,t,U.clamp(e,0,1))},powerOfTwo:function(o){return o!==0&&!(o&o-1)},nextPowerOfTwo:function(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o},random:function(o,t){const e=t-o;return Math.random()*e+o},smoothstep:function(o,t,e){return e<=o?0:e>=t?1:(e=(e-o)/(t-o),e*e*(3-2*e))},smootherstep:function(o,t,e){return e<=o?0:e>=t?1:(e=(e-o)/(t-o),e*e*e*(e*(e*6-15)+10))},roundUp:function(o,t){return t===0?o:Math.ceil(o/t)*t},between:function(o,t,e,s){const i=Math.min(t,e),n=Math.max(t,e);return s?o>=i&&o<=n:o>i&&o<n}};class dt{get(t,e,s){return typeof e=="function"&&(s=e,e={}),this.request("GET",t,e,s)}post(t,e,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=e,this.request("POST",t,s,i)}put(t,e,s,i){return typeof s=="function"&&(i=s,s={}),s.postdata=e,this.request("PUT",t,s,i)}del(t,e,s){return typeof e=="function"&&(s=e,e={}),this.request("DELETE",t,e,s)}request(t,e,s,i){let n,r,a,l=!1;if(typeof s=="function"&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,s.async==null&&(s.async=!0),s.headers==null&&(s.headers={}),s.postdata!=null)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let c=s.headers["Content-Type"];switch(c===void 0&&(s.headers["Content-Type"]=dt.ContentType.FORM_URLENCODED,c=s.headers["Content-Type"]),c){case dt.ContentType.FORM_URLENCODED:{a="";let d=!0;for(const u in s.postdata)if(s.postdata.hasOwnProperty(u)){d?d=!1:a+="&";const f=encodeURIComponent(u),m=encodeURIComponent(s.postdata[u]);a+=`${f}=${m}`}break}default:case dt.ContentType.JSON:c==null&&(s.headers["Content-Type"]=dt.ContentType.JSON),a=JSON.stringify(s.postdata);break}}else a=s.postdata;if(s.cache===!1){const c=ds();n=new sh(e),n.query?n.query=n.query+"&ts="+c:n.query="ts="+c,e=n.toString()}s.query&&(n=new sh(e),r=ei(n.getQuery(),s.query),n.setQuery(r),e=n.toString());const h=new XMLHttpRequest;h.open(t,e,s.async),h.withCredentials=s.withCredentials!==void 0?s.withCredentials:!1,h.responseType=s.responseType||this._guessResponseType(e);for(const c in s.headers)s.headers.hasOwnProperty(c)&&h.setRequestHeader(c,s.headers[c]);h.onreadystatechange=()=>{this._onReadyStateChange(t,e,s,h)},h.onerror=()=>{this._onError(t,e,s,h),l=!0};try{h.send(a)}catch(c){l||s.error(h.status,h,c)}return h}_guessResponseType(t){const e=new sh(t),s=ot.getExtension(e.path);return dt.binaryExtensions.indexOf(s)>=0?dt.ResponseType.ARRAY_BUFFER:s===".xml"?dt.ResponseType.DOCUMENT:dt.ResponseType.TEXT}_isBinaryContentType(t){return[dt.ContentType.MP4,dt.ContentType.WAV,dt.ContentType.OGG,dt.ContentType.MP3,dt.ContentType.BIN,dt.ContentType.DDS,dt.ContentType.BASIS,dt.ContentType.GLB].indexOf(t)>=0}_onReadyStateChange(t,e,s,i){if(i.readyState===4)switch(i.status){case 0:{i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(t,e,s,i):this._onError(t,e,s,i);break}case 200:case 201:case 206:case 304:{this._onSuccess(t,e,s,i);break}default:{this._onError(t,e,s,i);break}}}_onSuccess(t,e,s,i){let n,r;const a=i.getResponseHeader("Content-Type");a&&(r=a.split(";")[0].trim());try{r===dt.ContentType.JSON||e.split("?")[0].endsWith(".json")?n=JSON.parse(i.responseText):this._isBinaryContentType(r)||i.responseType===dt.ResponseType.ARRAY_BUFFER||i.responseType===dt.ResponseType.BLOB||i.responseType===dt.ResponseType.JSON?n=i.response:i.responseType===dt.ResponseType.DOCUMENT||r===dt.ContentType.XML?n=i.responseXML:n=i.responseText,s.callback(null,n)}catch(l){s.callback(l)}}_onError(t,e,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=U.clamp(Math.pow(2,s.retries)*dt.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${t}: ${e} - Error ${i.status}. Retrying in ${n} ms`),setTimeout(()=>{s.retrying=!1,this.request(t,e,s,s.callback)},n)}else s.callback(i.status===0?"Network error":i.status,null)}}dt.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"};dt.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"};dt.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb"];dt.retryDelay=100;const Ft=new dt,Og=0,ih=1,xu=2,Bg=3,vu=4,kg=5;class j{constructor(t=0,e=0,s=0,i=1){const n=t.length;n===3||n===4?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=t[3]!==void 0?t[3]:1):(this.r=t,this.g=e,this.b=s,this.a=i)}clone(){return new j(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,i=1){return this.r=t,this.g=e,this.b=s,this.a=i,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=U.intToBytes32(e):(s=U.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(t){let e="#"+((1<<24)+(Math.round(this.r*255)<<16)+(Math.round(this.g*255)<<8)+Math.round(this.b*255)).toString(16).slice(1);if(t===!0){const s=Math.round(this.a*255).toString(16);this.a<16/255?e+="0"+s:e+=s}return e}}j.BLACK=Object.freeze(new j(0,0,0,1));j.BLUE=Object.freeze(new j(0,0,1,1));j.CYAN=Object.freeze(new j(0,1,1,1));j.GRAY=Object.freeze(new j(.5,.5,.5,1));j.GREEN=Object.freeze(new j(0,1,0,1));j.MAGENTA=Object.freeze(new j(1,0,1,1));j.RED=Object.freeze(new j(1,0,0,1));j.WHITE=Object.freeze(new j(1,1,1,1));j.YELLOW=Object.freeze(new j(1,1,0,1));class Su{constructor(t,e=0){this._curve=t,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._reset(e)}evaluate(t,e=!1){(e||t<this._left||t>=this._right)&&this._reset(t);let s;const i=this._curve.type;if(i===kg)s=this._p0;else{const n=this._recip===0?0:(t-this._left)*this._recip;i===Og?s=U.lerp(this._p0,this._p1,n):i===ih?s=U.lerp(this._p0,this._p1,n*n*(3-2*n)):s=this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,n)}return s}_reset(t){const e=this._curve.keys,s=e.length;if(!s)this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0;else if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[s-1][0])this._left=e[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[s-1][1],this._m0=this._m1=0;else{let i=0;for(;t>=e[i+1][0];)i++;this._left=e[i][0],this._right=e[i+1][0];const n=1/(this._right-this._left);this._recip=isFinite(n)?n:0,this._p0=e[i][1],this._p1=e[i+1][1],this._isHermite()&&this._calcTangents(e,i)}}_isHermite(){return this._curve.type===xu||this._curve.type===Bg||this._curve.type===vu}_calcTangents(t,e){let s;const i=t[e],n=t[e+1];let r;if(e===0?s=[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:s=t[e-1],e===t.length-2?r=[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:r=t[e+2],this._curve.type===vu){const a=2*(n[0]-i[0])/(n[0]-s[0]),l=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(a)?a:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(l)?l:0)*(r[1]-i[1])}else{const a=(n[0]-i[0])/(i[0]-s[0]),l=(n[0]-i[0])/(r[0]-n[0]),h=i[1]+(s[1]-i[1])*(isFinite(a)?a:0),c=n[1]+(r[1]-n[1])*(isFinite(l)?l:0),d=this._curve.type===xu?.5:this._curve.tension;this._m0=d*(n[1]-h),this._m1=d*(c-i[1])}}_evaluateHermite(t,e,s,i,n){const r=n*n,a=n+n,l=1-n,h=l*l;return t*((1+a)*h)+s*(n*h)+e*(r*(3-a))+i*(r*(n-1))}}class fe{constructor(t){if(this.keys=[],this.type=ih,this.tension=.5,this._eval=new Su(this),t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}get length(){return this.keys.length}add(t,e){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>t);n++);const r=[t,e];return this.keys.splice(n,0,r),r}get(t){return this.keys[t]}sort(){this.keys.sort(function(t,e){return t[0]-e[0]})}value(t){return this._eval.evaluate(t,!0)}closest(t){const e=this.keys,s=e.length;let i=2,n=null;for(let r=0;r<s;r++){const a=Math.abs(t-e[r][0]);if(i>=a)i=a,n=e[r];else break}return n}clone(){const t=new fe;return t.keys=ei(t.keys,this.keys),t.type=this.type,t.tension=this.tension,t}quantize(t){t=Math.max(t,2);const e=new Float32Array(t),s=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(let i=1;i<t;i++)e[i]=this._eval.evaluate(s*i);return e}quantizeClamped(t,e,s){const i=this.quantize(t);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(e,i[n]));return i}}class us{constructor(){if(this.curves=[],this._type=ih,arguments.length>1)for(let t=0;t<arguments.length;t++)this.curves.push(new fe(arguments[t]));else if(arguments.length===0)this.curves.push(new fe);else{const t=arguments[0];if(typeof t=="number")for(let e=0;e<t;e++)this.curves.push(new fe);else for(let e=0;e<t.length;e++)this.curves.push(new fe(t[e]))}}get length(){return this.curves.length}set type(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}get type(){return this._type}get(t){return this.curves[t]}value(t,e=[]){const s=this.curves.length;e.length=s;for(let i=0;i<s;i++)e[i]=this.curves[i].value(t);return e}clone(){const t=new us;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t}quantize(t){t=Math.max(t,2);const e=this.curves.length,s=new Float32Array(t*e),i=1/(t-1);for(let n=0;n<e;n++){const r=new Su(this.curves[n]);for(let a=0;a<t;a++)s[a*e+n]=r.evaluate(i*a)}return s}quantizeClamped(t,e,s){const i=this.quantize(t);for(let n=0;n<i.length;++n)i[n]=Math.min(s,Math.max(e,i[n]));return i}}class y{constructor(t=0,e=0,s=0){t.length===3?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}clone(){return new y(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,i=t.y,n=t.z,r=e.x,a=e.y,l=e.z;return this.x=i*l-a*n,this.y=n*r-l*s,this.z=s*a-r*i,this}distance(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+s*s+i*i)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=this.x*t.x+this.y*t.y+this.z*t.z,s=t.x*t.x+t.y*t.y+t.z*t.z,i=e/s;return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}y.ZERO=Object.freeze(new y(0,0,0));y.ONE=Object.freeze(new y(1,1,1));y.UP=Object.freeze(new y(0,1,0));y.DOWN=Object.freeze(new y(0,-1,0));y.RIGHT=Object.freeze(new y(1,0,0));y.LEFT=Object.freeze(new y(-1,0,0));y.FORWARD=Object.freeze(new y(0,0,-1));y.BACK=Object.freeze(new y(0,0,1));class Qt{constructor(){const t=new Float32Array(9);t[0]=t[4]=t[8]=1,this.data=t}clone(){return new Qt().copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===1&&t[5]===0&&t[6]===0&&t[7]===0&&t[8]===1}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(){const t=this.data;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}transformVector(t,e=new y){const s=this.data,i=t.x,n=t.y,r=t.z;return e.x=i*s[0]+n*s[3]+r*s[6],e.y=i*s[1]+n*s[4]+r*s[7],e.z=i*s[2]+n*s[5]+r*s[8],e}}Qt.IDENTITY=Object.freeze(new Qt);Qt.ZERO=Object.freeze(new Qt().set([0,0,0,0,0,0,0,0,0]));class H{constructor(t=0,e=0){t.length===2?(this.x=t[0],this.y=t[1]):(this.x=t,this.y=e)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}clone(){return new H(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(){const t=this.x*this.x+this.y*this.y;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t,this.y=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}}H.ZERO=Object.freeze(new H(0,0));H.ONE=Object.freeze(new H(1,1));H.UP=Object.freeze(new H(0,1));H.DOWN=Object.freeze(new H(0,-1));H.RIGHT=Object.freeze(new H(1,0));H.LEFT=Object.freeze(new H(-1,0));class Z{constructor(t=0,e=0,s=0,i=0){t.length===4?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}clone(){return new Z(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}Z.ZERO=Object.freeze(new Z(0,0,0,0));Z.ONE=Object.freeze(new Z(1,1,1,1));const rr=new H,Ti=new y,ii=new y,ni=new y,ba=new y;class G{constructor(){const t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}static _getPerspectiveHalfSize(t,e,s,i,n){n?(t.x=i*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=i*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,i=e.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(t){return this.add2(this,t)}clone(){return new G().copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1}mul2(t,e){const s=t.data,i=e.data,n=this.data,r=s[0],a=s[1],l=s[2],h=s[3],c=s[4],d=s[5],u=s[6],f=s[7],m=s[8],p=s[9],_=s[10],g=s[11],w=s[12],v=s[13],x=s[14],S=s[15];let T,b,C,M;return T=i[0],b=i[1],C=i[2],M=i[3],n[0]=r*T+c*b+m*C+w*M,n[1]=a*T+d*b+p*C+v*M,n[2]=l*T+u*b+_*C+x*M,n[3]=h*T+f*b+g*C+S*M,T=i[4],b=i[5],C=i[6],M=i[7],n[4]=r*T+c*b+m*C+w*M,n[5]=a*T+d*b+p*C+v*M,n[6]=l*T+u*b+_*C+x*M,n[7]=h*T+f*b+g*C+S*M,T=i[8],b=i[9],C=i[10],M=i[11],n[8]=r*T+c*b+m*C+w*M,n[9]=a*T+d*b+p*C+v*M,n[10]=l*T+u*b+_*C+x*M,n[11]=h*T+f*b+g*C+S*M,T=i[12],b=i[13],C=i[14],M=i[15],n[12]=r*T+c*b+m*C+w*M,n[13]=a*T+d*b+p*C+v*M,n[14]=l*T+u*b+_*C+x*M,n[15]=h*T+f*b+g*C+S*M,this}mulAffine2(t,e){const s=t.data,i=e.data,n=this.data,r=s[0],a=s[1],l=s[2],h=s[4],c=s[5],d=s[6],u=s[8],f=s[9],m=s[10],p=s[12],_=s[13],g=s[14];let w,v,x;return w=i[0],v=i[1],x=i[2],n[0]=r*w+h*v+u*x,n[1]=a*w+c*v+f*x,n[2]=l*w+d*v+m*x,n[3]=0,w=i[4],v=i[5],x=i[6],n[4]=r*w+h*v+u*x,n[5]=a*w+c*v+f*x,n[6]=l*w+d*v+m*x,n[7]=0,w=i[8],v=i[9],x=i[10],n[8]=r*w+h*v+u*x,n[9]=a*w+c*v+f*x,n[10]=l*w+d*v+m*x,n[11]=0,w=i[12],v=i[13],x=i[14],n[12]=r*w+h*v+u*x+p,n[13]=a*w+c*v+f*x+_,n[14]=l*w+d*v+m*x+g,n[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new y){const s=this.data,i=t.x,n=t.y,r=t.z;return e.x=i*s[0]+n*s[4]+r*s[8]+s[12],e.y=i*s[1]+n*s[5]+r*s[9]+s[13],e.z=i*s[2]+n*s[6]+r*s[10]+s[14],e}transformVector(t,e=new y){const s=this.data,i=t.x,n=t.y,r=t.z;return e.x=i*s[0]+n*s[4]+r*s[8],e.y=i*s[1]+n*s[5]+r*s[9],e.z=i*s[2]+n*s[6]+r*s[10],e}transformVec4(t,e=new Z){const s=this.data,i=t.x,n=t.y,r=t.z,a=t.w;return e.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],e.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],e.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],e.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],e}setLookAt(t,e,s){ni.sub2(t,e).normalize(),ii.copy(s).normalize(),Ti.cross(ii,ni).normalize(),ii.cross(ni,Ti);const i=this.data;return i[0]=Ti.x,i[1]=Ti.y,i[2]=Ti.z,i[3]=0,i[4]=ii.x,i[5]=ii.y,i[6]=ii.z,i[7]=0,i[8]=ni.x,i[9]=ni.y,i[10]=ni.z,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}setFrustum(t,e,s,i,n,r){const a=2*n,l=e-t,h=i-s,c=r-n,d=this.data;return d[0]=a/l,d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=a/h,d[6]=0,d[7]=0,d[8]=(e+t)/l,d[9]=(i+s)/h,d[10]=(-r-n)/c,d[11]=-1,d[12]=0,d[13]=0,d[14]=-a*r/c,d[15]=0,this}setPerspective(t,e,s,i,n){return G._getPerspectiveHalfSize(rr,t,e,s,n),this.setFrustum(-rr.x,rr.x,-rr.y,rr.y,s,i)}setOrtho(t,e,s,i,n,r){const a=this.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(e+t)/(e-t),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(t,e){e*=U.DEG_TO_RAD;const s=t.x,i=t.y,n=t.z,r=Math.cos(e),a=Math.sin(e),l=1-r,h=l*s,c=l*i,d=this.data;return d[0]=h*s+r,d[1]=h*i+a*n,d[2]=h*n-a*i,d[3]=0,d[4]=h*i-a*n,d[5]=c*i+r,d[6]=c*n+a*s,d[7]=0,d[8]=h*n+a*i,d[9]=c*n-s*a,d[10]=l*n*n+r,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this}setTranslate(t,e,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,this}setScale(t,e,s){const i=this.data;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(t,e,s,i){const n=this.data;return n[0]=s*.5,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=i*.5,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=t+s*.5,n[13]=e+i*.5,n[14]=.5,n[15]=1,this}invert(){const t=this.data,e=t[0],s=t[1],i=t[2],n=t[3],r=t[4],a=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],f=t[11],m=t[12],p=t[13],_=t[14],g=t[15],w=e*a-s*r,v=e*l-i*r,x=e*h-n*r,S=s*l-i*a,T=s*h-n*a,b=i*h-n*l,C=c*p-d*m,M=c*_-u*m,E=c*g-f*m,D=d*_-u*p,I=d*g-f*p,k=u*g-f*_,N=w*k-v*I+x*D+S*E-T*M+b*C;if(N===0)this.setIdentity();else{const X=1/N;t[0]=(a*k-l*I+h*D)*X,t[1]=(-s*k+i*I-n*D)*X,t[2]=(p*b-_*T+g*S)*X,t[3]=(-d*b+u*T-f*S)*X,t[4]=(-r*k+l*E-h*M)*X,t[5]=(e*k-i*E+n*M)*X,t[6]=(-m*b+_*x-g*v)*X,t[7]=(c*b-u*x+f*v)*X,t[8]=(r*I-a*E+h*C)*X,t[9]=(-e*I+s*E-n*C)*X,t[10]=(m*T-p*x+g*w)*X,t[11]=(-c*T+d*x-f*w)*X,t[12]=(-r*D+a*M-l*C)*X,t[13]=(e*D-s*M+i*C)*X,t[14]=(-m*S+p*v-_*w)*X,t[15]=(c*S-d*v+u*w)*X}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const i=e.x,n=e.y,r=e.z,a=e.w,l=s.x,h=s.y,c=s.z,d=i+i,u=n+n,f=r+r,m=i*d,p=i*u,_=i*f,g=n*u,w=n*f,v=r*f,x=a*d,S=a*u,T=a*f,b=this.data;return b[0]=(1-(g+v))*l,b[1]=(p+T)*l,b[2]=(_-S)*l,b[3]=0,b[4]=(p-T)*h,b[5]=(1-(m+v))*h,b[6]=(w+x)*h,b[7]=0,b[8]=(_+S)*c,b[9]=(w-x)*c,b[10]=(1-(m+g))*c,b[11]=0,b[12]=t.x,b[13]=t.y,b[14]=t.z,b[15]=1,this}transpose(){let t;const e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invertTo3x3(t){const e=this.data,s=t.data,i=e[0],n=e[1],r=e[2],a=e[4],l=e[5],h=e[6],c=e[8],d=e[9],u=e[10],f=u*l-h*d,m=-u*n+r*d,p=h*n-r*l,_=-u*a+h*c,g=u*i-r*c,w=-h*i+r*a,v=d*a-l*c,x=-d*i+n*c,S=l*i-n*a,T=i*f+n*_+r*v;if(T===0)return this;const b=1/T;return s[0]=b*f,s[1]=b*m,s[2]=b*p,s[3]=b*_,s[4]=b*g,s[5]=b*w,s[6]=b*v,s[7]=b*x,s[8]=b*S,this}getTranslation(t=new y){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new y){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new y){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new y){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new y){return this.getX(Ti),this.getY(ii),this.getZ(ni),t.set(Ti.length(),ii.length(),ni.length()),t}setFromEulerAngles(t,e,s){t*=U.DEG_TO_RAD,e*=U.DEG_TO_RAD,s*=U.DEG_TO_RAD;const i=Math.sin(-t),n=Math.cos(-t),r=Math.sin(-e),a=Math.cos(-e),l=Math.sin(-s),h=Math.cos(-s),c=this.data;return c[0]=a*h,c[1]=-a*l,c[2]=r,c[3]=0,c[4]=n*l+h*i*r,c[5]=n*h-i*r*l,c[6]=-a*i,c[7]=0,c[8]=i*l-n*h*r,c[9]=h*i+n*r*l,c[10]=n*a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}getEulerAngles(t=new y){this.getScale(ba);const e=ba.x,s=ba.y,i=ba.z;if(e===0||s===0||i===0)return t.set(0,0,0);const n=this.data,r=Math.asin(-n[2]/e),a=Math.PI*.5;let l,h;return r<a?r>-a?(l=Math.atan2(n[6]/s,n[10]/i),h=Math.atan2(n[1]/e,n[0]/e)):(h=0,l=-Math.atan2(n[4]/s,n[5]/s)):(h=0,l=Math.atan2(n[4]/s,n[5]/s)),t.set(l,r,h).mulScalar(U.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}G.IDENTITY=Object.freeze(new G);G.ZERO=Object.freeze(new G().set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class tt{constructor(t=0,e=0,s=0,i=1){t.length===4?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}clone(){return new tt(this.x,this.y,this.z,this.w)}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getAxisAngle(t){let e=Math.acos(this.w)*2;const s=Math.sin(e/2);return s!==0?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*U.RAD_TO_DEG}getEulerAngles(t=new y){let e,s,i;const n=this.x,r=this.y,a=this.z,l=this.w,h=2*(l*r-n*a);return h<=-.99999?(e=2*Math.atan2(n,l),s=-Math.PI/2,i=0):h>=.99999?(e=2*Math.atan2(n,l),s=Math.PI/2,i=0):(e=Math.atan2(2*(l*n+r*a),1-2*(n*n+r*r)),s=Math.asin(h),i=Math.atan2(2*(l*a+n*r),1-2*(r*r+a*a))),t.set(e,s,i).mulScalar(U.RAD_TO_DEG)}invert(){return this.conjugate().normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(t){const e=this.x,s=this.y,i=this.z,n=this.w,r=t.x,a=t.y,l=t.z,h=t.w;return this.x=n*r+e*h+s*l-i*a,this.y=n*a+s*h+i*r-e*l,this.z=n*l+i*h+e*a-s*r,this.w=n*h-e*r-s*a-i*l,this}mul2(t,e){const s=t.x,i=t.y,n=t.z,r=t.w,a=e.x,l=e.y,h=e.z,c=e.w;return this.x=r*a+s*c+i*h-n*l,this.y=r*l+i*c+n*a-s*h,this.z=r*h+n*c+s*l-i*a,this.w=r*c-s*a-i*l-n*h,this}normalize(){let t=this.length();return t===0?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setFromAxisAngle(t,e){e*=.5*U.DEG_TO_RAD;const s=Math.sin(e),i=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=i,this}setFromEulerAngles(t,e,s){if(t instanceof y){const d=t;t=d.x,e=d.y,s=d.z}const i=.5*U.DEG_TO_RAD;t*=i,e*=i,s*=i;const n=Math.sin(t),r=Math.cos(t),a=Math.sin(e),l=Math.cos(e),h=Math.sin(s),c=Math.cos(s);return this.x=n*l*c-r*a*h,this.y=r*a*c+n*l*h,this.z=r*l*h-n*a*c,this.w=r*l*c+n*a*h,this}setFromMat4(t){let e,s,i,n,r,a,l,h,c,d,u,f,m,p;if(t=t.data,e=t[0],s=t[1],i=t[2],n=t[4],r=t[5],a=t[6],l=t[8],h=t[9],c=t[10],f=e*e+s*s+i*i,f===0)return this;if(f=1/Math.sqrt(f),m=n*n+r*r+a*a,m===0)return this;if(m=1/Math.sqrt(m),p=l*l+h*h+c*c,p===0)return this;p=1/Math.sqrt(p),e*=f,s*=f,i*=f,n*=m,r*=m,a*=m,l*=p,h*=p,c*=p;const _=e+r+c;return _>=0?(d=Math.sqrt(_+1),this.w=d*.5,d=.5/d,this.x=(a-h)*d,this.y=(l-i)*d,this.z=(s-n)*d):e>r?e>c?(u=e-(r+c)+1,u=Math.sqrt(u),this.x=u*.5,u=.5/u,this.w=(a-h)*u,this.y=(s+n)*u,this.z=(i+l)*u):(u=c-(e+r)+1,u=Math.sqrt(u),this.z=u*.5,u=.5/u,this.w=(s-n)*u,this.x=(l+i)*u,this.y=(h+a)*u):r>c?(u=r-(c+e)+1,u=Math.sqrt(u),this.y=u*.5,u=.5/u,this.w=(l-i)*u,this.z=(a+h)*u,this.x=(n+s)*u):(u=c-(e+r)+1,u=Math.sqrt(u),this.z=u*.5,u=.5/u,this.w=(s-n)*u,this.x=(l+i)*u,this.y=(h+a)*u),this}slerp(t,e,s){const i=t.x,n=t.y,r=t.z,a=t.w;let l=e.x,h=e.y,c=e.z,d=e.w,u=a*d+i*l+n*h+r*c;if(u<0&&(d=-d,l=-l,h=-h,c=-c,u=-u),Math.abs(u)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;const f=Math.acos(u),m=Math.sqrt(1-u*u);if(Math.abs(m)<.001)return this.w=a*.5+d*.5,this.x=i*.5+l*.5,this.y=n*.5+h*.5,this.z=r*.5+c*.5,this;const p=Math.sin((1-s)*f)/m,_=Math.sin(s*f)/m;return this.w=a*p+d*_,this.x=i*p+l*_,this.y=n*p+h*_,this.z=r*p+c*_,this}transformVector(t,e=new y){const s=t.x,i=t.y,n=t.z,r=this.x,a=this.y,l=this.z,h=this.w,c=h*s+a*n-l*i,d=h*i+l*s-r*n,u=h*n+r*i-a*s,f=-r*s-a*i-l*n;return e.x=c*h+f*-r+d*-l-u*-a,e.y=d*h+f*-a+u*-r-c*-l,e.z=u*h+f*-l+c*-a-d*-r,e}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}tt.IDENTITY=Object.freeze(new tt(0,0,0,1));tt.ZERO=Object.freeze(new tt(0,0,0,0));const ar=new y,or=new y,bu=new y,wu=new y,zg=new y;class gt{constructor(t=new y,e=new y(.5,.5,.5)){this.center=t,this.halfExtents=e,this._min=new y,this._max=new y}add(t){const e=this.center,s=e.x,i=e.y,n=e.z,r=this.halfExtents,a=r.x,l=r.y,h=r.z;let c=s-a,d=s+a,u=i-l,f=i+l,m=n-h,p=n+h;const _=t.center,g=_.x,w=_.y,v=_.z,x=t.halfExtents,S=x.x,T=x.y,b=x.z,C=g-S,M=g+S,E=w-T,D=w+T,I=v-b,k=v+b;C<c&&(c=C),M>d&&(d=M),E<u&&(u=E),D>f&&(f=D),I<m&&(m=I),k>p&&(p=k),e.x=(c+d)*.5,e.y=(u+f)*.5,e.z=(m+p)*.5,r.x=(d-c)*.5,r.y=(f-u)*.5,r.z=(p-m)*.5}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new gt(this.center.clone(),this.halfExtents.clone())}intersects(t){const e=this.getMax(),s=this.getMin(),i=t.getMax(),n=t.getMin();return s.x<=i.x&&e.x>=n.x&&s.y<=i.y&&e.y>=n.y&&s.z<=i.z&&e.z>=n.z}_intersectsRay(t,e){const s=ar.copy(this.getMin()).sub(t.origin),i=or.copy(this.getMax()).sub(t.origin),n=t.direction;n.x===0?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),n.y===0?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),n.z===0?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const r=bu.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=wu.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),l=Math.min(Math.min(a.x,a.y),a.z),h=Math.max(Math.max(r.x,r.y),r.z),c=l>=h&&h>=0;return c&&e.copy(t.direction).mulScalar(h).add(t.origin),c}_fastIntersectsRay(t){const e=ar,s=or,i=bu,n=wu,r=zg,a=t.direction;return e.sub2(t.origin,this.center),n.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i.mul2(e,a),!(n.x>this.halfExtents.x&&i.x>=0||n.y>this.halfExtents.y&&i.y>=0||n.z>this.halfExtents.z&&i.z>=0||(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)||s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x||s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.getMin(),s=this.getMax();return!(t.x<e.x||t.x>s.x||t.y<e.y||t.y>s.y||t.z<e.z||t.z>s.z)}setFromTransformedAabb(t,e,s=!1){const i=t.center,n=t.halfExtents,r=e.data;let a=r[0],l=r[4],h=r[8],c=r[1],d=r[5],u=r[9],f=r[2],m=r[6],p=r[10];if(s){let _=a*a+l*l+h*h;if(_>0){const g=1/Math.sqrt(_);a*=g,l*=g,h*=g}if(_=c*c+d*d+u*u,_>0){const g=1/Math.sqrt(_);c*=g,d*=g,u*=g}if(_=f*f+m*m+p*p,_>0){const g=1/Math.sqrt(_);f*=g,m*=g,p*=g}}this.center.set(r[12]+a*i.x+l*i.y+h*i.z,r[13]+c*i.x+d*i.y+u*i.z,r[14]+f*i.x+m*i.y+p*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(l)*n.y+Math.abs(h)*n.z,Math.abs(c)*n.x+Math.abs(d)*n.y+Math.abs(u)*n.z,Math.abs(f)*n.x+Math.abs(m)*n.y+Math.abs(p)*n.z)}compute(t,e){if(e=e===void 0?t.length/3:e,e>0){const s=ar.set(t[0],t[1],t[2]),i=or.set(t[0],t[1],t[2]);for(let n=1;n<e;n++){const r=t[n*3+0],a=t[n*3+1],l=t[n*3+2];r<s.x&&(s.x=r),a<s.y&&(s.y=a),l<s.z&&(s.z=l),r>i.x&&(i.x=r),a>i.y&&(i.y=a),l>i.z&&(i.z=l)}this.setMinMax(s,i)}}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let r=0;r<3;++r){let a=0;const l=t.center[n[r]],h=e[n[r]],c=s[n[r]];let d=0;l<h&&(d=h-l,a+=d*d),l>c&&(d=l-c,a+=d*d),i+=a}return i}_expand(t,e){ar.add2(this.getMin(),t),or.add2(this.getMax(),e),this.setMinMax(ar,or)}}const wa=new y,Ug=new y;class Ci{constructor(t=new y,e=.5){this.center=t,this.radius=e}containsPoint(t){const e=wa.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=wa.copy(t.origin).sub(this.center),i=s.dot(Ug.copy(t.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const r=i*i-n;if(r<0)return!1;const a=Math.abs(-i-Math.sqrt(r));return e&&e.copy(t.direction).mulScalar(a).add(t.origin),!0}intersectsBoundingSphere(t){wa.sub2(t.center,this.center);const e=t.radius+this.radius;return wa.lengthSq()<=e*e}}const Ng=0,Ta=1,Be=2,he=3,Je=4,Ca=5,Aa=6,nh=7,rh=8,ah=9,oh=10,lh="none",Vg="linear",hh=2,Wg=0,Gg=2,Tu=15,xe=0,fs=1,ch=2,ke=3,lr=4,lt=0,ut=1,_t=2,ne=0,Hg=1,Xg=2,jg=3,dh=0,qg=1,Kt=0,ms=1,Ms=2,ps=3,_s=4,Yg=5,Cu=6,Ai={};Ai[Kt]="PCF3";Ai[ms]="VSM8";Ai[Ms]="VSM16";Ai[ps]="VSM32";Ai[_s]="PCF5";Ai[Yg]="PCF1";const uh=1,fh=0,Au=0,gs=0,$g=1,Ma=0,Kg=1,ys=0,hr=1,cr=0,Mi=1,Pa=2,Zg=0,Jg=1,Pi=0,Ea=1,Qg="mul",mh=0,Mu=1,ty=2,Ra=3,Ia=0,ey=1,sy=2,iy=3,ny=4,ry=0,ph=1,ay=2,_h=1,La=2,Pu=4,Eu=8,Ru=16,Iu=32,Da=64,gh=128,Fa=256,Lu=512,Oa=1024,Ba=2048,ka=4096,yh=8192,xh=1,dr=0,ur=1,za=2,Ps=0,vh=1,xs=1,Es=2,Rs=4,on=0,Qe=1,ri=2,ai=3,fr=18,oi=0,Xt=1,Ut=2,Ua=1,ln=0,Du=1,Fu=2,Sh=0,oy=1,ly=2,Ou=3,hy=4,cy=5,dy=1,Na=2,Bu=4,uy=8,bh=0,wh=1,ht=0,St=1,fy=[new y,new y,new y,new y,new y,new y,new y,new y];class Th{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=[]}setFromMat4(t){const e=t.data;let s;const i=this.planes;s=i[0],s[0]=e[3]-e[0],s[1]=e[7]-e[4],s[2]=e[11]-e[8],s[3]=e[15]-e[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=e[3]+e[0],s[1]=e[7]+e[4],s[2]=e[11]+e[8],s[3]=e[15]+e[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=e[3]+e[1],s[1]=e[7]+e[5],s[2]=e[11]+e[9],s[3]=e[15]+e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=e[3]-e[1],s[1]=e[7]-e[5],s[2]=e[11]-e[9],s[3]=e[15]-e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=e[3]-e[2],s[1]=e[7]-e[6],s[2]=e[11]-e[10],s[3]=e[15]-e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=e[3]+e[2],s[1]=e[7]+e[6],s[2]=e[11]+e[10],s[3]=e[15]+e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(t){let e,s;for(e=0;e<6;e++)if(s=this.planes[e],s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3]<=0)return!1;return!0}containsSphere(t){let e=0,s,i;const n=t.radius,r=t.center,a=r.x,l=r.y,h=r.z,c=this.planes;let d;for(i=0;i<6;i++){if(d=c[i],s=d[0]*a+d[1]*l+d[2]*h+d[3],s<=-n)return 0;s>n&&e++}return e===6?2:1}static getPoints(t,e,s){e=e||t._nearClip,s=s||t._farClip;const i=t._fov*Math.PI/180;let n=t._projection===ys?Math.tan(i/2)*e:t._orthoHeight,r=n*t._aspectRatio;const a=fy;return a[0].x=r,a[0].y=-n,a[0].z=-e,a[1].x=r,a[1].y=n,a[1].z=-e,a[2].x=-r,a[2].y=n,a[2].z=-e,a[3].x=-r,a[3].y=-n,a[3].z=-e,t._projection===ys&&(n=Math.tan(i/2)*s,r=n*t._aspectRatio),a[4].x=r,a[4].y=-n,a[4].z=-s,a[5].x=r,a[5].y=n,a[5].z=-s,a[6].x=-r,a[6].y=n,a[6].z=-s,a[7].x=-r,a[7].y=-n,a[7].z=-s,a}}class hn{constructor(t=new y,e=new y(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}}new hn;new y;new Ci;new G;new y;const te=0,et=1,Ch=2,li=0,Pt=1,ku=2,Va=4,zu=5,Wa=6,Ga=8,Nt=0,Uu=3,Nu=4,ve=0,mr=1,my=2,py=3,Ha=1,pr=2,Vu=4,me=0,cn=1,Xa=2,Wu=3,bt=0,Yt=1,_r=2,ja=3,qa=4,Ei=5,_y=0,Ah=1,Ya=2,$a=3,gy=4,yy=5,xy=6,Ri=7,Gu=0,Is=1,Ii=2,Mh=0,Ph=1,Ka=2,Za=3,Eh=4,Ja=5,Ls=6,ct=7,dn=8,gr=9,Li=10,yr=11,ce=12,xr=13,Vt=14,Hu=15,vr=16,Qa=17,to=18,Rh=19,Ih=20,Sr=21,Lh=22,Dh=23,br=24,wr=25,eo=26,so=27,Xu=28,ju=29,qu=30,Tr=0,io=1,Yu=2,$u=3,ts=4,Cr=5,Di=6,Ot="POSITION",pe="NORMAL",vs="TANGENT",Ss="BLENDWEIGHT",Se="BLENDINDICES",de="COLOR",Ku="TEXCOORD",be="TEXCOORD0",hi="TEXCOORD1",no="TEXCOORD2",ro="TEXCOORD3",ao="TEXCOORD4",oo="TEXCOORD5",lo="TEXCOORD6",ho="TEXCOORD7",vy="ATTR",co="ATTR0",Fh="ATTR1",Zu="ATTR2",Ju="ATTR3",Qu="ATTR4",Sy="ATTR5",by="ATTR6",wy="ATTR7",Oh="ATTR8",Bh="ATTR9",kh="ATTR10",zh="ATTR11",Ar="ATTR12",Mr="ATTR13",Pr="ATTR14",Fi="ATTR15",tf=1,ze=0,Ty=2,Cy=3,Ay=5,My=2,_e="default",jt="rgbm",uo="rgbe",un="swizzleGGGR",ef="none",Uh="cube",fo="equirect",Py="octahedral",mo=0,ci=1,po=2,fn=3,sf=4,nf=5,wt=6,Nh=0,rf=1,Vh=2,Wh=3,Gh=4,Hh=5,Xh=6,jh=7,qh=8,af=9,of=10,lf=11,hf=12,cf=13,df=14,Ey=15,Ry=16,uf=17,Iy=18,Ly=19,Dy=20,ff=21,mf=22,pf=23,mn=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],_o=[1,1,2,2,4,4,4],Yh=[Uint8Array,Uint16Array,Uint32Array],Fy=[1,2,4],yt={};yt[Ot]=0;yt[pe]=1;yt[Ss]=2;yt[Se]=3;yt[de]=4;yt[be]=5;yt[hi]=6;yt[no]=7;yt[ro]=8;yt[ao]=9;yt[oo]=10;yt[lo]=11;yt[ho]=12;yt[vs]=13;yt[co]=0;yt[Fh]=1;yt[Zu]=2;yt[Ju]=3;yt[Qu]=4;yt[Sy]=5;yt[by]=6;yt[wy]=7;yt[Oh]=8;yt[Bh]=9;yt[kh]=10;yt[zh]=11;yt[Ar]=12;yt[Mr]=13;yt[Pr]=14;yt[Fi]=15;let Oy=0;class Ds{constructor(t,e,s,i=ve,n){this.device=t,this.format=e,this.numVertices=s,this.usage=i,this.id=Oy++,this.impl=t.createVertexBufferImpl(this,e),this.instancing=!1,this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,t._vram.vb+=this.numBytes,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);e!==-1&&t.buffers.splice(e,1),this.impl.destroy(t),t._vram.vb-=this.storage.byteLength}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength!==this.numBytes?!1:(this.storage=t,this.unlock(),!0)}}function Er(o){let t=0;for(let e=0,s=o.length;e<s;e++)t=(t<<5)-t+o.charCodeAt(e),t|=0;return t}class re{constructor(t,e,s){this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=s===void 0,this.size=e.reduce((r,a)=>r+Math.ceil(a.components*_o[a.type]/4)*4,0);let i=0,n;for(let r=0,a=e.length;r<a;r++){const l=e[r];n=l.components*_o[l.type],s&&(i=U.roundUp(i,n));const h={name:l.semantic,offset:s?i:l.hasOwnProperty("offset")?l.offset:i,stride:s?n:l.hasOwnProperty("stride")?l.stride:this.size,dataType:l.type,numComponents:l.components,normalize:l.normalize===void 0?!1:l.normalize,size:n};this._elements.push(h),s?i+=n*s:i+=Math.ceil(n/4)*4,l.semantic===be?this.hasUv0=!0:l.semantic===hi?this.hasUv1=!0:l.semantic===de?this.hasColor=!0:l.semantic===vs&&(this.hasTangents=!0)}s&&(this.verticesByteSize=i),this._evaluateHash()}get elements(){return this._elements}static get defaultInstancingFormat(){return re._defaultInstancingFormat||(re._defaultInstancingFormat=new re(null,[{semantic:Ar,components:4,type:wt},{semantic:Mr,components:4,type:wt},{semantic:Pr,components:4,type:wt},{semantic:Fi,components:4,type:wt}])),re._defaultInstancingFormat}_evaluateHash(){let t;const e=[];let s;const i=[],n=this._elements.length;for(let r=0;r<n;r++){const a=this._elements[r];t=a.name,t+=a.dataType,t+=a.numComponents,t+=a.normalize,e.push(t),s=t,s+=a.offset,s+=a.stride,s+=a.size,i.push(s)}e.sort(),this.batchingHash=Er(e.join()),this.renderingingHash=Er(i.join())}}re._defaultInstancingFormat=null;class Rr{constructor(){this._cache=new Map}get(t,e){return this._cache.has(t)||(this._cache.set(t,e()),t.on("destroy",()=>{this.remove(t)})),this._cache.get(t)}remove(t){var e;(e=this._cache.get(t))==null||e.destroy(),this._cache.delete(t)}}const By={type:Cr,base:0,count:4,indexed:!1},ky=new Rr;function zy(o){return ky.get(o,()=>{const t=new re(o,[{semantic:Ot,components:2,type:wt}]),e=new Float32Array(8);return e.set([-1,-1,1,-1,-1,1,1,1]),new Ds(o,t,4,ve,e)})}function es(o,t,e,s,i,n=!1){const r=o.renderTarget;o.setRenderTarget(t),o.updateBegin();let a,l,h,c,d,u,f,m;s?(a=s.x,l=s.y,h=s.z,c=s.w):(h=t?t.width:o.width,c=t?t.height:o.height,a=0,l=0),i?(d=i.x,u=i.y,f=i.z,m=i.w):(d=a,u=l,f=h,m=c);const p=o.vx,_=o.vy,g=o.vw,w=o.vh;o.setViewport(a,l,h,c);const v=o.sx,x=o.sy,S=o.sw,T=o.sh;o.setScissor(d,u,f,m);const b=o.getDepthTest(),C=o.getDepthWrite(),M=o.getCullMode(),E=o.writeRed,D=o.writeGreen,I=o.writeBlue,k=o.writeAlpha;o.setDepthTest(!1),o.setDepthWrite(!1),o.setCullMode(me),o.setColorWrite(!0,!0,!0,!0),n||o.setBlending(!1),o.setVertexBuffer(zy(o),0),o.setShader(e),o.draw(By),o.setDepthTest(b),o.setDepthWrite(C),o.setCullMode(M),o.setColorWrite(E,D,I,k),o.updateEnd(),o.setRenderTarget(r),o.updateBegin(),o.setViewport(p,_,g,w),o.setScissor(v,x,S,T)}class Ir{constructor(t,e){this.device=t,this.definition=e,this.init(),this.impl=t.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}destroy(){this.impl.destroy(this)}loseContext(){this.init()}restoreContext(){this.impl.restoreContext(this.device,this)}}var Uy=`uniform float alpha_ref;
void alphaTest(float a) {
	if (a < alpha_ref) discard;
}
`,Ny=`void addAmbient() {
	dDiffuseLight += light_globalAmbient;
}
`,Vy=`#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
void addAmbient() {
	vec3 dir = normalize(cubeMapRotate(dNormalW) * vec3(-1.0, 1.0, 1.0));
	vec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);
	vec4 raw = texture2D(texture_envAtlas, uv);
	vec3 linear = $DECODE(raw);
	dDiffuseLight += processEnvironment(linear);
}
`,Wy=`uniform vec3 ambientSH[9];
void addAmbient() {
	vec3 n = cubeMapRotate(dNormalW);
	vec3 color =
		ambientSH[0] +
		ambientSH[1] * n.x +
		ambientSH[2] * n.y +
		ambientSH[3] * n.z +
		ambientSH[4] * n.x * n.z +
		ambientSH[5] * n.z * n.y +
		ambientSH[6] * n.y * n.x +
		ambientSH[7] * (3.0 * n.z * n.z - 1.0) +
		ambientSH[8] * (n.x * n.x - n.y * n.y);
	dDiffuseLight += processEnvironment(max(color, vec3(0.0)));
}
`,Gy=`#ifdef MAPTEXTURE
uniform sampler2D texture_aoMap;
#endif
void getAO() {
	dAo = 1.0;
	#ifdef MAPTEXTURE
	dAo *= texture2D(texture_aoMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dAo *= saturate(vVertexColor.$VC);
	#endif
}
`,Hy=`void occludeDiffuse() {
	dDiffuseLight *= dAo;
}
`,Xy=`uniform float material_occludeSpecularIntensity;
void occludeSpecular() {
	float specPow = exp2(dGlossiness * 11.0);
	float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);
	specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
}
`,jy=`void occludeSpecular() {
	float specPow = exp2(dGlossiness * 11.0);
	float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
}
`,qy=`void occludeSpecular() {
	dSpecularLight *= dAo;
	dReflection *= dAo;
}
`,Yy=`uniform float material_occludeSpecularIntensity;
void occludeSpecular() {
	float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);
	dSpecularLight *= specOcc;
	dReflection *= specOcc;
}
`,$y=`	vec4 dirLm = texture2D(texture_dirLightMap, vUv1);
	if (bakeDir > 0.5) {
		if (dAtten > 0.00001) {
			dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);
			dAtten = saturate(dAtten);
			gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);
			gl_FragColor.a = dirLm.w + dAtten;
			gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);
		} else {
			gl_FragColor = dirLm;
		}
	} else {
		gl_FragColor.rgb = dirLm.xyz;
		gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);
	}
`,Ky=`	gl_FragColor.rgb = dDiffuseLight;
	gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));
	gl_FragColor.rgb /= 8.0;
	gl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );
	gl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;
	gl_FragColor.rgb /= gl_FragColor.a;
`,Zy=`uniform vec3 view_position;
uniform vec3 light_globalAmbient;
float square(float x) {
	return x*x;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 saturate(vec3 x) {
	return clamp(x, vec3(0.0), vec3(1.0));
}
`,Jy=`attribute vec3 vertex_position;
attribute vec3 vertex_normal;
attribute vec4 vertex_tangent;
attribute vec2 vertex_texCoord0;
attribute vec2 vertex_texCoord1;
attribute vec4 vertex_color;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
vec3 dPositionW;
mat4 dModelMatrix;
mat3 dNormalMatrix;
`,Qy=`#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,t0=`#define NINESLICED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
`,e0=`#define NINESLICED
#define NINESLICETILED
varying vec2 vMask;
varying vec2 vTiledUv;
uniform mediump vec4 innerOffset;
uniform mediump vec2 outerScale;
uniform mediump vec4 atlasRect;
vec2 nineSlicedUv;
`,s0=`#define SHADOWBIAS
float getShadowBias(float resolution, float maxBias) {
	return maxBias;
}
`,i0=`varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
#ifdef GAUSS
uniform float weight[SAMPLES];
#endif
#ifdef PACKED
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
#endif
void main(void) {
	vec3 moments = vec3(0.0);
	vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);
	for (int i=0; i<SAMPLES; i++) {
		vec4 c = texture2D(source, uv + pixelOffset * float(i));
		#ifdef PACKED
		c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));
		#endif
		#ifdef GAUSS
		moments += c.xyz * weight[i];
		#else
		moments += c.xyz;
		#endif
	}
	#ifndef GAUSS
	moments /= float(SAMPLES);
	#endif
	#ifdef PACKED
	gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));
	#else
	gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);
	#endif
}
`,n0=`#ifdef MAPFLOAT
uniform float material_clearCoat;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_clearCoatMap;
#endif
void getClearCoat() {
	ccSpecularity = 1.0;
	#ifdef MAPFLOAT
	ccSpecularity *= material_clearCoat;
	#endif
	#ifdef MAPTEXTURE
	ccSpecularity *= texture2D(texture_clearCoatMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	ccSpecularity *= saturate(vVertexColor.$VC);
	#endif
}
`,r0=`#ifdef MAPFLOAT
uniform float material_clearCoatGlossiness;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_clearCoatGlossMap;
#endif
void getClearCoatGlossiness() {
	ccGlossiness = 1.0;
	#ifdef MAPFLOAT
	ccGlossiness *= material_clearCoatGlossiness;
	#endif
	#ifdef MAPTEXTURE
	ccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	ccGlossiness *= saturate(vVertexColor.$VC);
	#endif
	ccGlossiness += 0.0000001;
}
`,a0=`#ifdef MAPTEXTURE
uniform sampler2D texture_clearCoatNormalMap;
uniform float material_clearCoatBumpiness;
#endif
void getClearCoatNormal() {
	#ifdef MAPTEXTURE
	vec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV, textureBias));
	normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));
	ccNormalW = dTBN * normalMap;
	#else
	ccNormalW = normalize(dVertexNormalW);
	#endif
	ccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));
}
`,o0=`vec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)
{
	vec3 vAbs = abs(dir);
	float ma;
	vec2 uv;
	if (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {
		faceIndex = dir.z < 0.0 ? 5.0 : 4.0;
		ma = 0.5 / vAbs.z;
		uv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);
		tileOffset.x = 2.0;
		tileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;
	} else if(vAbs.y >= vAbs.x) {
		faceIndex = dir.y < 0.0 ? 3.0 : 2.0;
		ma = 0.5 / vAbs.y;
		uv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);
		tileOffset.x = 1.0;
		tileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;
	} else {
		faceIndex = dir.x < 0.0 ? 1.0 : 0.0;
		ma = 0.5 / vAbs.x;
		uv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);
		tileOffset.x = 0.0;
		tileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;
	}
	return uv * ma + 0.5;
}
vec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {
	float faceIndex;
	vec2 tileOffset;
	vec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);
	float atlasFaceSize = omniAtlasViewport.z;
	float tileSize = shadowTextureResolution * atlasFaceSize;
	float offset = shadowEdgePixels / tileSize;
	uv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);
	uv *= atlasFaceSize;
	uv += tileOffset * atlasFaceSize;
	uv += omniAtlasViewport.xy;
	return uv;
}
`,l0=`vec3 _getCookieClustered(sampler2D tex, vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {
	vec4 pixel = mix(vec4(1.0), texture2D(tex, uv), intensity);
	return isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));
}
vec3 getCookie2DClustered(sampler2D tex, mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {
	vec4 projPos = transform * vec4(worldPosition, 1.0);
	return _getCookieClustered(tex, projPos.xy / projPos.w, intensity, isRgb, cookieChannel);
}
vec3 getCookieCubeClustered(sampler2D tex, vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {
	vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
	return _getCookieClustered(tex, uv, intensity, isRgb, cookieChannel);
}
`,h0=`#ifdef GL2
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowOmniClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
		float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
		return texture(shadowMap, vec3(uv, shadowZ));
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowOmniClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
		float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
		dShadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowParams.xyz);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
		float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
		dShadowCoord = vec3(uv, shadowZ);
		return getShadowPCF5x5(shadowMap, shadowParams.xyz);
	}
	#endif
#else
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
		float depth = unpackFloat(texture2D(shadowMap, uv));
		float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
		return depth > shadowZ ? 1.0 : 0.0;
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3) || defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {
		float shadowTextureResolution = shadowParams.x;
		vec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);
		float shadowZ = length(dir) * shadowParams.w + shadowParams.z;
		dShadowCoord = vec3(uv, shadowZ);
		return getShadowPCF3x3(shadowMap, shadowParams.xyz);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 dir) {
		return getShadowOmniClusteredPCF3(shadowMap, shadowParams, omniAtlasViewport, shadowEdgePixels, dir);
	}
	#endif
#endif
#ifdef GL2
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowSpotClusteredPCF1(sampler2DShadow shadowMap, vec4 shadowParams) {
		return texture(shadowMap, dShadowCoord);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3)
	float getShadowSpotClusteredPCF3(sampler2DShadow shadowMap, vec4 shadowParams) {
		return getShadowSpotPCF3x3(shadowMap, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF5(sampler2DShadow shadowMap, vec4 shadowParams) {
		return getShadowPCF5x5(shadowMap, shadowParams.xyz);
	}
	#endif
#else
	#if defined(CLUSTER_SHADOW_TYPE_PCF1)
	float getShadowSpotClusteredPCF1(sampler2D shadowMap, vec4 shadowParams) {
		float depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));
		return depth > dShadowCoord.z ? 1.0 : 0.0;
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF3) || defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF3(sampler2D shadowMap, vec4 shadowParams) {
		return getShadowSpotPCF3x3(shadowMap, shadowParams);
	}
	#endif
	#if defined(CLUSTER_SHADOW_TYPE_PCF5)
	float getShadowSpotClusteredPCF5(sampler2D shadowMap, vec4 shadowParams) {
		return getShadowSpotClusteredPCF3(shadowMap, shadowParams);
	}
	#endif
#endif
`,c0=`uniform sampler2D clusterWorldTexture;
uniform sampler2D lightsTexture8;
uniform highp sampler2D lightsTextureFloat;
#ifdef CLUSTER_SHADOWS
	#ifdef GL2
		uniform sampler2DShadow shadowAtlasTexture;
	#else
		uniform sampler2D shadowAtlasTexture;
	#endif
#endif
#ifdef CLUSTER_COOKIES
	uniform sampler2D cookieAtlasTexture;
#endif
uniform float clusterPixelsPerCell;
uniform vec3 clusterCellsCountByBoundsSize;
uniform vec4 lightsTextureInvSize;
uniform vec3 clusterTextureSize;
uniform vec3 clusterBoundsMin;
uniform vec3 clusterBoundsDelta;
uniform vec3 clusterCellsDot;
uniform vec3 clusterCellsMax;
uniform vec2 clusterCompressionLimit0;
uniform vec2 shadowAtlasParams;
float LTCLightValuesEvaluated = 0.0;
struct ClusterLightData {
	float lightV;
	float type;
	float shape;
	vec3 halfWidth;
	vec3 halfHeight;
	float falloffMode;
	float castShadows;
	float shadowBias;
	float shadowNormalBias;
	vec3 position;
	vec3 direction;
	float range;
	float innerConeAngleCos;
	float outerConeAngleCos;
	vec3 color;
	vec3 omniAtlasViewport;
	float cookie;
	float cookieRgb;
	float cookieIntensity;
	vec4 cookieChannelMask;
	float mask;
};
mat4 lightProjectionMatrix;
#define isClusteredLightCastShadow(light) ( light.castShadows > 0.5 )
#define isClusteredLightCookie(light) (light.cookie > 0.5 )
#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )
#define isClusteredLightSpot(light) ( light.type > 0.5 )
#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )
#define isClusteredLightArea(light) ( light.shape > 0.1 )
#define isClusteredLightRect(light) ( light.shape < 0.3 )
#define isClusteredLightDisk(light) ( light.shape < 0.6 )
#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS
	#define acceptLightMask(light) ( light.mask < 0.75)
#else
	#define acceptLightMask(light) ( light.mask > 0.25)
#endif
vec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {
	return vec4(
		bytes2floatRange4(d0, -2.0, 2.0),
		bytes2floatRange4(d1, -2.0, 2.0),
		bytes2floatRange4(d2, -2.0, 2.0),
		bytes2floatRange4(d3, -2.0, 2.0)
	);
}
#ifdef SUPPORTS_TEXLOD
	#define textureData(texture, uv) texture2DLodEXT(texture, uv, 0.0)
#else
	#define textureData(texture, uv) texture2D(texture, uv)
#endif
vec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {
	return textureData(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV));
}
vec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {
	return textureData(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV));
}
void decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {
	clusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;
	vec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);
	clusterLightData.type = lightInfo.x;
	clusterLightData.shape = lightInfo.y;
	clusterLightData.falloffMode = lightInfo.z;
	clusterLightData.castShadows = lightInfo.w;
	vec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);
	vec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);
	clusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;
	clusterLightData.cookie = colorB.z;
	clusterLightData.mask = colorB.w;
	#ifdef CLUSTER_TEXTURE_FLOAT
		vec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);
		clusterLightData.position = lightPosRange.xyz;
		clusterLightData.range = lightPosRange.w;
		vec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);
		clusterLightData.direction = lightDir_Unused.xyz;
	#else
		vec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);
		vec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);
		vec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);
		clusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;
		vec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);
		clusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;
		vec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);
		vec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);
		vec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);
		clusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;
	#endif
}
void decodeClusterLightSpot(inout ClusterLightData clusterLightData) {
	vec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);
	clusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;
	clusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;
}
void decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		clusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;
	#else
		vec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);
		vec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);
		clusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));
	#endif
}
void decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		clusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;
		clusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;
	#else
		vec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);
		vec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);
		vec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);
		clusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));
		vec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);
		vec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);
		vec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);
		clusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));
	#endif
}
void decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {
	#ifdef CLUSTER_TEXTURE_FLOAT
		vec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);
		vec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);
		vec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);
		vec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);
	#else
		vec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);
		vec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);
		vec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);
		vec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);
		vec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);
		vec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);
		vec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);
		vec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);
		vec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);
		vec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);
		vec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);
		vec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);
		vec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);
		vec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);
		vec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);
		vec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);
		vec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);
		vec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);
		vec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);
		vec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));
	#endif
	lightProjectionMatrix = mat4(m0, m1, m2, m3);
}
void decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {
	vec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);
	clusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),
	clusterLightData.shadowNormalBias = bytes2float2(biases.zw);
}
void decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {
	vec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);
	clusterLightData.cookieIntensity = cookieA.x;
	clusterLightData.cookieRgb = cookieA.y;
	clusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);
}
void evaluateLight(ClusterLightData light) {
	dAtten3 = vec3(1.0);
	getLightDirPoint(light.position);
	#ifdef CLUSTER_AREALIGHTS
	if (isClusteredLightArea(light)) {
		decodeClusterLightAreaData(light);
		if (LTCLightValuesEvaluated < 0.5) {
			LTCLightValuesEvaluated = 1.0;
			calcLTCLightValues();
		}
		if (isClusteredLightRect(light)) {
			calcRectLightValues(light.position, light.halfWidth, light.halfHeight);
		} else if (isClusteredLightDisk(light)) {
			calcDiskLightValues(light.position, light.halfWidth, light.halfHeight);
		} else {
			calcSphereLightValues(light.position, light.halfWidth, light.halfHeight);
		}
		dAtten = getFalloffWindow(light.range);
	} else
	#endif
	{
		if (isClusteredLightFalloffLinear(light))
			dAtten = getFalloffLinear(light.range);
		else
			dAtten = getFalloffInvSquared(light.range);
	}
	if (dAtten > 0.00001) {
		#ifdef CLUSTER_AREALIGHTS
		if (isClusteredLightArea(light)) {
			if (isClusteredLightRect(light)) {
				dAttenD = getRectLightDiffuse() * 16.0;
			} else if (isClusteredLightDisk(light)) {
				dAttenD = getDiskLightDiffuse() * 16.0;
			} else {
				dAttenD = getSphereLightDiffuse() * 16.0;
			}
		} else
		#endif
		{
			dAtten *= getLightDiffuse();
		}
		if (isClusteredLightSpot(light)) {
			decodeClusterLightSpot(light);
			dAtten *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos);
		}
		#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)
		if (dAtten > 0.00001) {
			if (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {
				if (isClusteredLightSpot(light)) {
					decodeClusterLightProjectionMatrixData(light);
				} else {
					decodeClusterLightOmniAtlasViewport(light);
				}
				float shadowTextureResolution = shadowAtlasParams.x;
				float shadowEdgePixels = shadowAtlasParams.y;
				#ifdef CLUSTER_COOKIES
				if (isClusteredLightCookie(light)) {
					decodeClusterLightCookieData(light);
					if (isClusteredLightSpot(light)) {
						dAtten3 = getCookie2DClustered(cookieAtlasTexture, lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);
					} else {
						dAtten3 = getCookieCubeClustered(cookieAtlasTexture, dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);
					}
				}
				#endif
				#ifdef CLUSTER_SHADOWS
				if (isClusteredLightCastShadow(light)) {
					decodeClusterLightShadowData(light);
					vec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);
					if (isClusteredLightSpot(light)) {
						getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							dAtten *= getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							dAtten *= getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowParams);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							dAtten *= getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowParams);
						#endif
					} else {
						normalOffsetPointShadow(shadowParams);
						#if defined(CLUSTER_SHADOW_TYPE_PCF1)
							dAtten *= getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF3)
							dAtten *= getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);
						#elif defined(CLUSTER_SHADOW_TYPE_PCF5)
							dAtten *= getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dLightDirW);
						#endif
					}
				}
				#endif
			}
		}
		#endif
		#ifdef CLUSTER_AREALIGHTS
		if (isClusteredLightArea(light)) {
			{
				vec3 areaDiffuse = (dAttenD * dAtten) * light.color * dAtten3;
				#if defined(CLUSTER_SPECULAR) && defined(CLUSTER_CONSERVE_ENERGY)
					areaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);
				#endif
				dDiffuseLight += areaDiffuse;
			}
			#ifdef CLUSTER_SPECULAR
				float areaLightSpecular;
				if (isClusteredLightRect(light)) {
					areaLightSpecular = getRectLightSpecular();
				} else if (isClusteredLightDisk(light)) {
					areaLightSpecular = getDiskLightSpecular();
				} else {
					areaLightSpecular = getSphereLightSpecular();
				}
				dSpecularLight += dLTCSpecFres * areaLightSpecular * dAtten * light.color * dAtten3;
				#ifdef CLUSTER_CLEAR_COAT
					float areaLightSpecularCC;
					if (isClusteredLightRect(light)) {
						areaLightSpecularCC = getRectLightSpecularCC();
					} else if (isClusteredLightDisk(light)) {
						areaLightSpecularCC = getDiskLightSpecularCC();
					} else {
						areaLightSpecularCC = getSphereLightSpecularCC();
					}
					ccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * dAtten * light.color	* dAtten3;
				#endif
			#endif
		} else
		#endif
		{
			{
				vec3 punctualDiffuse = dAtten * light.color * dAtten3;
				#if defined(CLUSTER_AREALIGHTS) && defined(CLUSTER_SPECULAR) && defined(CLUSTER_CONSERVE_ENERGY)
					punctualDiffuse = mix(punctualDiffuse, vec3(0), dSpecularity);
				#endif
				dDiffuseLight += punctualDiffuse;
			}
			#ifdef CLUSTER_SPECULAR
				{
					vec3 punctualSpecular = getLightSpecular() * dAtten * light.color * dAtten3;
					#if defined(CLUSTER_AREALIGHTS)
						punctualSpecular *= dSpecularity;
					#endif
					dSpecularLight += punctualSpecular;
				}
				#ifdef CLUSTER_CLEAR_COAT
					vec3 punctualCC = getLightSpecularCC() * dAtten * light.color * dAtten3;
					#if defined(CLUSTER_AREALIGHTS)
						punctualCC *= ccSpecularity;
					#endif
					ccSpecularLight += punctualCC;
				#endif
			#endif
		}
	}
}
void evaluateClusterLight(float lightIndex) {
	ClusterLightData clusterLightData;
	decodeClusterLightCore(clusterLightData, lightIndex);
	if (acceptLightMask(clusterLightData))
		evaluateLight(clusterLightData);
}
void addClusteredLights() {
	vec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);
	if (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {
		float cellIndex = dot(clusterCellsDot, cellCoords);
		float clusterV = floor(cellIndex * clusterTextureSize.y);
		float clusterU = cellIndex - (clusterV * clusterTextureSize.x);
		clusterV = (clusterV + 0.5) * clusterTextureSize.z;
		const float maxLightCells = 256.0 / 4.0;
		for (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {
			vec4 lightIndices = textureData(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV));
			vec4 indices = lightIndices * 255.0;
			for (int i = 0; i < 4; i++) {
				if (indices.x <= 0.0)
					return;
				evaluateClusterLight(indices.x);
				indices = indices.yzwx;
			}
			if (lightCellIndex > clusterPixelsPerCell) {
				break;
			}
		}
	}
}
`,d0=`vec3 combineColorCC() {
	return combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);
}
`,u0=`vec3 combineColor() {
	return dAlbedo * dDiffuseLight;
}
`,f0=`vec3 combineColor() {
	return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);
}
`,m0=`vec3 combineColor() {
	return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;
}
`,p0=`vec3 combineColor() {
	return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;
}
`,_0=`uniform vec3 material_ambient;
vec3 combineColor() {
	return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;
}
`,g0=`vec3 combineColor() {
	return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);
}
`,y0=`vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);
}
vec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {
	vec4 projPos = transform * vec4(vPositionW, 1.0);
	projPos.xy /= projPos.w;
	projPos.xy += cookieOffset;
	if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);
	vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);
	return mix(vec4(1.0), texture2D(tex, uv), intensity);
}
vec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {
	return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);
}
`,x0=`uniform vec3 envBoxMin, envBoxMax;
vec3 cubeMapProject(vec3 nrdir) {
	nrdir = cubeMapRotate(nrdir);
	vec3 rbmax = (envBoxMax - vPositionW) / nrdir;
	vec3 rbmin = (envBoxMin - vPositionW) / nrdir;
	vec3 rbminmax;
	rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;
	rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;
	rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;
	float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);
	vec3 posonbox = vPositionW + nrdir * fa;
	vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;
	return normalize(posonbox - envBoxPos);
}
`,v0=`vec3 cubeMapProject(vec3 dir) {
	return cubeMapRotate(dir);
}
`,S0=`#ifdef CUBEMAP_ROTATION
uniform mat3 cubeMapRotationMatrix;
#endif
vec3 cubeMapRotate(vec3 refDir) {
#ifdef CUBEMAP_ROTATION
	return refDir * cubeMapRotationMatrix;
#else
	return refDir;
#endif
}
`,b0=`vec3 decodeLinear(vec4 raw) {
	return raw.rgb;
}
vec3 decodeGamma(vec4 raw) {
	return pow(raw.xyz, vec3(2.2));
}
vec3 decodeRGBM(vec4 raw) {
	vec3 color = (8.0 * raw.a) * raw.rgb;
	return color * color;
}
vec3 decodeRGBE(vec4 raw) {
	if (raw.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);
	}
}
const float PI = 3.141592653589793;
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec2 toSphericalUv(vec3 dir) {
	vec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;
	return vec2(uv.x, 1.0 - uv.y);
}
const float atlasSize = 512.0;
const float seamSize = 1.0 / atlasSize;
vec2 mapUv(vec2 uv, vec4 rect) {
	return vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),
				mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));
}
vec2 mapRoughnessUv(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));
}
vec2 mapMip(vec2 uv, float level) {
	float t = 1.0 / exp2(level);
	return mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));
}
`,w0=`vec3 detailMode_mul(vec3 c1, vec3 c2) {
	return c1 * c2;
}
vec3 detailMode_add(vec3 c1, vec3 c2) {
	return c1 + c2;
}
vec3 detailMode_screen(vec3 c1, vec3 c2) {
	return 1.0 - (1.0 - c1)*(1.0 - c2);
}
vec3 detailMode_overlay(vec3 c1, vec3 c2) {
	return mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));
}
vec3 detailMode_min(vec3 c1, vec3 c2) {
	return min(c1, c2);
}
vec3 detailMode_max(vec3 c1, vec3 c2) {
	return max(c1, c2);
}
`,T0=`#ifdef MAPCOLOR
uniform vec3 material_diffuse;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_diffuseMap;
#endif
void getAlbedo() {
	dAlbedo = vec3(1.0);
	#ifdef MAPCOLOR
	dAlbedo *= material_diffuse.rgb;
	#endif
	#ifdef MAPTEXTURE
	dAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV, textureBias).$CH));
	#endif
	#ifdef MAPVERTEX
	dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));
	#endif
}
`,C0=`#ifdef MAPTEXTURE
uniform sampler2D texture_diffuseDetailMap;
#endif
vec3 addAlbedoDetail(vec3 albedo) {
	#ifdef MAPTEXTURE
	vec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV, textureBias).$CH);
	return detailMode_$DETAILMODE(albedo, albedoDetail);
	#else
	return albedo;
	#endif
}
`,A0=`#define SHADER_NAME Dilate
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
void main(void) {
	vec4 c = texture2D(source, vUv0);
	c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);
	c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));
	c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));
	c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));
	c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));
	c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));
	c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));
	c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);
	gl_FragColor = c;
}
`,M0=`#define SHADER_NAME BilateralDeNoise
float normpdf3(in vec3 v, in float sigma) {
	return 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 encodeRGBM(vec3 color) {
	vec4 encoded;
	encoded.rgb = pow(color.rgb, vec3(0.5));
	encoded.rgb *= 1.0 / 8.0;
	encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );
	encoded.a = ceil(encoded.a * 255.0) / 255.0;
	encoded.rgb /= encoded.a;
	return encoded;
}
#define MSIZE 15
varying vec2 vUv0;
uniform sampler2D source;
uniform vec2 pixelOffset;
uniform vec2 sigmas;
uniform float bZnorm;
uniform float kernel[MSIZE];
void main(void) {
	vec4 pixelRgbm = texture2D(source, vUv0);
	if (pixelRgbm.a <= 0.0) {
		gl_FragColor = pixelRgbm;
		return ;
	}
	float sigma = sigmas.x;
	float bSigma = sigmas.y;
	vec3 pixelHdr = decodeRGBM(pixelRgbm);
	vec3 accumulatedHdr = vec3(0.0);
	float accumulatedFactor = 0.0;
	const int kSize = (MSIZE-1)/2;
	for (int i = -kSize; i <= kSize; ++i) {
		for (int j = -kSize; j <= kSize; ++j) {
			vec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;
			vec4 rgbm = texture2D(source, coord);
			if (rgbm.a > 0.0) {
				vec3 hdr = decodeRGBM(rgbm);
				float factor = kernel[kSize + j] * kernel[kSize + i];
				factor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;
				accumulatedHdr += factor * hdr;
				accumulatedFactor += factor;
			}
		}
	}
	gl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);
}
`,P0=`#ifdef MAPCOLOR
uniform vec3 material_emissive;
#endif
#ifdef MAPFLOAT
uniform float material_emissiveIntensity;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_emissiveMap;
#endif
vec3 getEmission() {
	vec3 emission = vec3(1.0);
	#ifdef MAPFLOAT
	emission *= material_emissiveIntensity;
	#endif
	#ifdef MAPCOLOR
	emission *= material_emissive;
	#endif
	#ifdef MAPTEXTURE
	emission *= $texture2DSAMPLE(texture_emissiveMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	emission *= gammaCorrectInput(saturate(vVertexColor.$VC));
	#endif
	return emission;
}
`,E0=`	#ifdef CLEARCOAT
	gl_FragColor.rgb = combineColorCC();
	#else
	gl_FragColor.rgb = combineColor();
	#endif
	gl_FragColor.rgb += getEmission();
	gl_FragColor.rgb = addFog(gl_FragColor.rgb);
	#ifndef HDR
	gl_FragColor.rgb = toneMap(gl_FragColor.rgb);
	gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);
	#endif
`,R0=`
`,I0=`vec3 processEnvironment(vec3 color) {
	return color;
}
`,L0=`uniform float skyboxIntensity;
vec3 processEnvironment(vec3 color) {
	return color * skyboxIntensity;
}
`,D0=`
`,F0=`
`,O0=`float getFalloffWindow(float lightRadius) {
	float sqrDist = dot(dLightDirW, dLightDirW);
	float invRadius = 1.0 / lightRadius;
	return square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
}
float getFalloffInvSquared(float lightRadius) {
	float sqrDist = dot(dLightDirW, dLightDirW);
	float falloff = 1.0 / (sqrDist + 1.0);
	float invRadius = 1.0 / lightRadius;
	falloff *= 16.0;
	falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );
	return falloff;
}
`,B0=`float getFalloffLinear(float lightRadius) {
	float d = length(dLightDirW);
	return max(((lightRadius - d) / lightRadius), 0.0);
}
`,k0=`vec3 fixSeams(vec3 vec, float mipmapIndex) {
	return vec;
}
vec3 fixSeams(vec3 vec) {
	return vec;
}
vec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {
	return vec;
}
vec3 calcSeam(vec3 vec) {
	return vec3(0);
}
vec3 applySeam(vec3 vec, vec3 seam, float scale) {
	return vec;
}
`,z0=`vec3 fixSeams(vec3 vec, float mipmapIndex) {
	vec3 avec = abs(vec);
	float scale = 1.0 - exp2(mipmapIndex) / 128.0;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 fixSeams(vec3 vec) {
	vec3 avec = abs(vec);
	float scale = 1.0 - 1.0 / 128.0;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {
	vec3 avec = abs(vec);
	float scale = invRecMipSize;
	float M = max(max(avec.x, avec.y), avec.z);
	if (avec.x != M) vec.x *= scale;
	if (avec.y != M) vec.y *= scale;
	if (avec.z != M) vec.z *= scale;
	return vec;
}
vec3 calcSeam(vec3 vec) {
	vec3 avec = abs(vec);
	float M = max(avec.x, max(avec.y, avec.z));
	return vec3(avec.x != M ? 1.0 : 0.0,
				avec.y != M ? 1.0 : 0.0,
				avec.z != M ? 1.0 : 0.0);
}
vec3 applySeam(vec3 vec, vec3 seam, float scale) {
	return vec * (seam * -scale + vec3(1.0));
}
`,U0=`float bytes2float2(vec2 data) {
	return dot(data, vec2(1.0, 1.0 / 255.0));
}
float bytes2float3(vec3 data) {
	return dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));
}
float bytes2float4(vec4 data) {
	return dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));
}
float bytes2floatRange2(vec2 data, float min, float max) {
	return mix(min, max, bytes2float2(data));
}
float bytes2floatRange3(vec3 data, float min, float max) {
	return mix(min, max, bytes2float3(data));
}
float bytes2floatRange4(vec4 data, float min, float max) {
	return mix(min, max, bytes2float4(data));
}
float mantissaExponent2Float(vec4 pack)
{
	float value = bytes2floatRange3(pack.xyz, -1.0, 1.0);
	float exponent = floor(pack.w * 255.0 - 127.0);
	return value * exp2(exponent);
}
`,N0=`uniform vec3 fog_color;
uniform float fog_density;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = exp(-depth * fog_density);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,V0=`uniform vec3 fog_color;
uniform float fog_density;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = exp(-depth * depth * fog_density * fog_density);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,W0=`uniform vec3 fog_color;
uniform float fog_start;
uniform float fog_end;
float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	float depth = gl_FragCoord.z / gl_FragCoord.w;
	float fogFactor = (fog_end - depth) / (fog_end - fog_start);
	fogFactor = clamp(fogFactor, 0.0, 1.0);
	fogFactor = gammaCorrectInput(fogFactor);
	return mix(fog_color * dBlendModeFogFactor, color, fogFactor);
}
`,G0=`float dBlendModeFogFactor = 1.0;
vec3 addFog(vec3 color) {
	return color;
}
`,H0=`uniform float material_fresnelFactor;
void getFresnel() {
	float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);
	float fresnel2 = fresnel * fresnel;
	fresnel *= fresnel2 * fresnel2;
	fresnel *= dGlossiness * dGlossiness;
	dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;
	#ifdef CLEARCOAT
	fresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);
	fresnel2 = fresnel * fresnel;
	fresnel *= fresnel2 * fresnel2;
	fresnel *= ccGlossiness * ccGlossiness;
	ccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;
	#endif
}
`,X0=`varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,j0=`attribute vec2 vertex_position;
varying vec2 vUv0;
void main(void)
{
	gl_Position = vec4(vertex_position, 0.5, 1.0);
	vUv0 = vertex_position.xy*0.5+0.5;
}
`,q0=`vec4 texture2DSRGB(sampler2D tex, vec2 uv) {
	return texture2D(tex, uv);
}
vec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {
	return texture2D(tex, uv, bias);
}
vec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {
	return textureCube(tex, uvw);
}
vec3 gammaCorrectOutput(vec3 color) {
	return color;
}
vec3 gammaCorrectInput(vec3 color) {
	return color;
}
float gammaCorrectInput(float color) {
	return color;
}
vec4 gammaCorrectInput(vec4 color) {
	return color;
}
`,Y0=`vec3 gammaCorrectInput(vec3 color) {
	return pow(color, vec3(2.2));
}
float gammaCorrectInput(float color) {
	return pow(color, 2.2);
}
vec4 gammaCorrectInput(vec4 color) {
	return vec4(pow(color.rgb, vec3(2.2)), color.a);
}
vec4 texture2DSRGB(sampler2D tex, vec2 uv) {
	vec4 rgba = texture2D(tex, uv);
	rgba.rgb = gammaCorrectInput(rgba.rgb);
	return rgba;
}
vec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {
	vec4 rgba = texture2D(tex, uv, bias);
	rgba.rgb = gammaCorrectInput(rgba.rgb);
	return rgba;
}
vec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {
	vec4 rgba = textureCube(tex, uvw);
	rgba.rgb = gammaCorrectInput(rgba.rgb);
	return rgba;
}
vec3 gammaCorrectOutput(vec3 color) {
	#ifdef HDR
	return color;
	#else
	color += vec3(0.0000001);
	return pow(color, vec3(0.45));
	#endif
}
`,$0=`#define varying in
out highp vec4 pc_fragColor;
#define gl_FragColor pc_fragColor
#define texture2D texture
#define textureCube texture
#define texture2DProj textureProj
#define texture2DLodEXT textureLod
#define texture2DProjLodEXT textureProjLod
#define textureCubeLodEXT textureLod
#define texture2DGradEXT textureGrad
#define texture2DProjGradEXT textureProjGrad
#define textureCubeGradEXT textureGrad
#define GL2
#define SUPPORTS_TEXLOD
`,K0=`#define attribute in
#define varying out
#define texture2D texture
#define GL2
#define VERTEXSHADER
`,Z0=`#ifdef MAPFLOAT
uniform float material_shininess;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_glossMap;
#endif
void getGlossiness() {
	dGlossiness = 1.0;
	#ifdef MAPFLOAT
	dGlossiness *= material_shininess;
	#endif
	#ifdef MAPTEXTURE
	dGlossiness *= texture2D(texture_glossMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dGlossiness *= saturate(vVertexColor.$VC);
	#endif
	dGlossiness += 0.0000001;
}
`,J0=`attribute vec4 instance_line1;
attribute vec4 instance_line2;
attribute vec4 instance_line3;
attribute vec4 instance_line4;
`,Q0=`float getLightDiffuse() {
	return max(dot(dNormalW, -dLightDirNormW), 0.0);
}
`,tx=`void getLightDirPoint(vec3 lightPosW) {
	dLightDirW = vPositionW - lightPosW;
	dLightDirNormW = normalize(dLightDirW);
	dLightPosW = lightPosW;
}
`,ex=`uniform sampler2D texture_lightMap;
uniform sampler2D texture_dirLightMap;
void addLightMap() {
	vec3 color = $texture2DSAMPLE(texture_lightMap, $UV, textureBias).$CH;
	vec3 dir = texture2D(texture_dirLightMap, $UV, textureBias).xyz;
	if (dot(dir, vec3(1.0)) < 0.00001) {
		dDiffuseLight += color;
	} else {
		dLightDirNormW = normalize(dir * 2.0 - vec3(1.0));
		float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));
		float flight = saturate(dot(dLightDirNormW, -dNormalW));
		float nlight = (flight / max(vlight, 0.01)) * 0.5;
		dDiffuseLight += color * nlight * 2.0;
	}
	dSpecularLight += color * getLightSpecular();
}
`,sx=`#ifdef MAPTEXTURE
uniform sampler2D texture_lightMap;
#endif
void addLightMap() {
	vec3 lm = vec3(1.0);
	#ifdef MAPTEXTURE
	lm *= $texture2DSAMPLE(texture_lightMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	lm *= saturate(vVertexColor.$VC);
	#endif
	dDiffuseLight += lm;
}
`,ix=`void addLightMap() {
	dDiffuseLight += saturate(vVertexColor.$CH);
}
`,nx=`float calcLightSpecular(float tGlossiness, vec3 tNormalW) {
	float PI = 3.141592653589793;
	float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);
	float anisotropy = material_anisotropy * roughness;
	float at = max((roughness + anisotropy), roughness / 4.0);
	float ab = max((roughness - anisotropy), roughness / 4.0);
	vec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));
	float NoH = dot(tNormalW, h);
	float ToH = dot(dTBN[0], h);
	float BoH = dot(dTBN[1], h);
	float a2 = at * ab;
	vec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);
	float v2 = dot(v, v);
	float w2 = a2 / v2;
	float D = a2 * w2 * w2 * (1.0 / PI);
	float ToV = dot(dTBN[0], dViewDirW);
	float BoV = dot(dTBN[1], dViewDirW);
	float ToL = dot(dTBN[0], -dLightDirNormW);
	float BoL = dot(dTBN[1], -dLightDirNormW);
	float NoV = dot(tNormalW, dViewDirW);
	float NoL = dot(tNormalW, -dLightDirNormW);
	float lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));
	float lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));
	float G = 0.5 / (lambdaV + lambdaL);
	return D * G;
}
float getLightSpecular() {
	return calcLightSpecular(dGlossiness, dNormalW);
}
float getLightSpecularCC() {
	return calcLightSpecular(ccGlossiness, ccNormalW);
}
`,rx=`float calcLightSpecular(float tGlossiness, vec3 tNormalW) {
	vec3 h = normalize( -dLightDirNormW + dViewDirW );
	float nh = max( dot( h, tNormalW ), 0.0 );
	float specPow = exp2(tGlossiness * 11.0);
	specPow = antiAliasGlossiness(specPow);
	specPow = max(specPow, 0.0001);
	return pow(nh, specPow) * (specPow + 2.0) / 8.0;
}
float getLightSpecular() {
	return calcLightSpecular(dGlossiness, dNormalW);
}
float getLightSpecularCC() {
	return calcLightSpecular(ccGlossiness, ccNormalW);
}
`,ax=`float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {
	float specPow = tGlossiness;
	specPow = antiAliasGlossiness(specPow);
	return pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);
}
float getLightSpecular() {
	return calcLightSpecular(dGlossiness, dReflDirW);
}
float getLightSpecularCC() {
	return calcLightSpecular(ccGlossiness, ccReflDirW);
}
`,ox=`mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
struct Coords {
	vec3 coord0;
	vec3 coord1;
	vec3 coord2;
	vec3 coord3;
};
float LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {
	vec3 v1 = rectCoords.coord1 - rectCoords.coord0;
	vec3 v2 = rectCoords.coord3 - rectCoords.coord0;
	vec3 lightNormal = cross( v1, v2 );
	float factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 =	factor * cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords.coord0 - P );
	coords[ 1 ] = mat * ( rectCoords.coord1 - P );
	coords[ 2 ] = mat * ( rectCoords.coord2 - P );
	coords[ 3 ] = mat * ( rectCoords.coord3 - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return result;
}
Coords dLTCCoords;
Coords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	Coords coords;
	coords.coord0 = lightPos + halfWidth - halfHeight;
	coords.coord1 = lightPos - halfWidth - halfHeight;
	coords.coord2 = lightPos - halfWidth + halfHeight;
	coords.coord3 = lightPos + halfWidth + halfHeight;
	return coords;
}
float dSphereRadius;
Coords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){
	dSphereRadius = max(length(halfWidth), length(halfHeight));
	vec3 f = reflect(normalize(lightPos - view_position), vNormalW);
	vec3 w = normalize(cross(f, halfHeight));
	vec3 h = normalize(cross(f, w));
	return getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);
}
vec2 dLTCUV;
#ifdef CLEARCOAT
vec2 ccLTCUV;
#endif
vec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)
{
	float roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);
	return LTC_Uv( tNormalW, dViewDirW, roughness );
}
vec3 dLTCSpecFres;
#ifdef CLEARCOAT
vec3 ccLTCSpecFres;
#endif
vec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)
{
	vec4 t2 = texture2D( areaLightsLutTex2, uv );
	#ifdef AREA_R8_G8_B8_A8_LUTS
	t2 *= vec4(0.693103,1,1,1);
	t2 += vec4(0.306897,0,0,0);
	#endif
	return tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;
}
void calcLTCLightValues()
{
	dLTCUV = getLTCLightUV(dGlossiness, dNormalW);
	dLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);
#ifdef CLEARCOAT
	ccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);
	ccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(ccSpecularityNoFres));
#endif
}
void calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);
}
void calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	calcRectLightValues(lightPos, halfWidth, halfHeight);
}
void calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)
{
	dLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);
}
vec3 SolveCubic(vec4 Coefficient)
{
	float pi = 3.14159;
	Coefficient.xyz /= Coefficient.w;
	Coefficient.yz /= 3.0;
	float A = Coefficient.w;
	float B = Coefficient.z;
	float C = Coefficient.y;
	float D = Coefficient.x;
	vec3 Delta = vec3(
		-Coefficient.z * Coefficient.z + Coefficient.y,
		-Coefficient.y * Coefficient.z + Coefficient.x,
		dot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)
	);
	float Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);
	vec3 RootsA, RootsD;
	vec2 xlc, xsc;
	{
		float A_a = 1.0;
		float C_a = Delta.x;
		float D_a = -2.0 * B * Delta.x + Delta.y;
		float Theta = atan(sqrt(Discriminant), -D_a) / 3.0;
		float x_1a = 2.0 * sqrt(-C_a) * cos(Theta);
		float x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);
		float xl;
		if ((x_1a + x_3a) > 2.0 * B)
			xl = x_1a;
		else
			xl = x_3a;
		xlc = vec2(xl - B, A);
	}
	{
		float A_d = D;
		float C_d = Delta.z;
		float D_d = -D * Delta.y + 2.0 * C * Delta.z;
		float Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;
		float x_1d = 2.0 * sqrt(-C_d) * cos(Theta);
		float x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);
		float xs;
		if (x_1d + x_3d < 2.0 * C)
			xs = x_1d;
		else
			xs = x_3d;
		xsc = vec2(-D, xs + C);
	}
	float E =	xlc.y * xsc.y;
	float F = -xlc.x * xsc.y - xlc.y * xsc.x;
	float G =	xlc.x * xsc.x;
	vec2 xmc = vec2(C * F - B * G, -B * F + C * E);
	vec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);
	if (Root.x < Root.y && Root.x < Root.z)
		Root.xyz = Root.yxz;
	else if (Root.z < Root.x && Root.z < Root.y)
		Root.xyz = Root.xzy;
	return Root;
}
float LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)
{
	vec3 T1, T2;
	T1 = normalize(V - N * dot(V, N));
	T2 = cross(N, T1);
	mat3 R = transposeMat3( mat3( T1, T2, N ) );
	vec3 L_[ 3 ];
	L_[ 0 ] = R * ( points.coord0 - P );
	L_[ 1 ] = R * ( points.coord1 - P );
	L_[ 2 ] = R * ( points.coord2 - P );
	vec3 Lo_i = vec3(0);
	vec3 C	= 0.5 * (L_[0] + L_[2]);
	vec3 V1 = 0.5 * (L_[1] - L_[2]);
	vec3 V2 = 0.5 * (L_[1] - L_[0]);
	C	= Minv * C;
	V1 = Minv * V1;
	V2 = Minv * V2;
	float a, b;
	float d11 = dot(V1, V1);
	float d22 = dot(V2, V2);
	float d12 = dot(V1, V2);
	if (abs(d12) / sqrt(d11 * d22) > 0.0001)
	{
		float tr = d11 + d22;
		float det = -d12 * d12 + d11 * d22;
		det = sqrt(det);
		float u = 0.5 * sqrt(tr - 2.0 * det);
		float v = 0.5 * sqrt(tr + 2.0 * det);
		float e_max = (u + v) * (u + v);
		float e_min = (u - v) * (u - v);
		vec3 V1_, V2_;
		if (d11 > d22)
		{
			V1_ = d12 * V1 + (e_max - d11) * V2;
			V2_ = d12 * V1 + (e_min - d11) * V2;
		}
		else
		{
			V1_ = d12*V2 + (e_max - d22)*V1;
			V2_ = d12*V2 + (e_min - d22)*V1;
		}
		a = 1.0 / e_max;
		b = 1.0 / e_min;
		V1 = normalize(V1_);
		V2 = normalize(V2_);
	}
	else
	{
		a = 1.0 / dot(V1, V1);
		b = 1.0 / dot(V2, V2);
		V1 *= sqrt(a);
		V2 *= sqrt(b);
	}
	vec3 V3 = cross(V1, V2);
	if (dot(C, V3) < 0.0)
		V3 *= -1.0;
	float L	= dot(V3, C);
	float x0 = dot(V1, C) / L;
	float y0 = dot(V2, C) / L;
	float E1 = inversesqrt(a);
	float E2 = inversesqrt(b);
	a *= L * L;
	b *= L * L;
	float c0 = a * b;
	float c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;
	float c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);
	float c3 = 1.0;
	vec3 roots = SolveCubic(vec4(c0, c1, c2, c3));
	float e1 = roots.x;
	float e2 = roots.y;
	float e3 = roots.z;
	vec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);
	mat3 rotate = mat3(V1, V2, V3);
	avgDir = rotate * avgDir;
	avgDir = normalize(avgDir);
	float L1 = sqrt(-e2 / e3);
	float L2 = sqrt(-e2 / e1);
	float formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	vec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);
	uv = uv*LUT_SCALE + LUT_BIAS;
	float scale = texture2D( areaLightsLutTex2, uv ).w;
	return formFactor*scale;
}
float getRectLightDiffuse() {
	return LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getDiskLightDiffuse() {
	return LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );
}
float getSphereLightDiffuse() {
	float falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);
	return getLightDiffuse()*falloff;
}
mat3 getLTCLightInvMat(vec2 uv)
{
	vec4 t1 = texture2D( areaLightsLutTex1, uv );
	#ifdef AREA_R8_G8_B8_A8_LUTS
	t1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);
	t1 += vec4(0.0, -0.2976, -0.01381, 0.0);
	#endif
	return mat3(
		vec3( t1.x, 0, t1.y ),
		vec3(	0, 1,	0 ),
		vec3( t1.z, 0, t1.w )
	);
}
float calcRectLightSpecular(vec3 tNormalW, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );
}
float getRectLightSpecular() {
	return calcRectLightSpecular(dNormalW, dLTCUV);
}
#ifdef CLEARCOAT
float getRectLightSpecularCC() {
	return calcRectLightSpecular(ccNormalW, ccLTCUV);
}
#endif
float calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {
	mat3 mInv = getLTCLightInvMat(uv);
	return LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );
}
float getDiskLightSpecular() {
	return calcDiskLightSpecular(dNormalW, dLTCUV);
}
#ifdef CLEARCOAT
float getDiskLightSpecularCC() {
	return calcDiskLightSpecular(ccNormalW, ccLTCUV);
}
#endif
float getSphereLightSpecular() {
	return calcDiskLightSpecular(dNormalW, dLTCUV);
}
#ifdef CLEARCOAT
float getSphereLightSpecularCC() {
	return calcDiskLightSpecular(ccNormalW, ccLTCUV);
}
#endif
`,lx=`void processMetalness(float metalness) {
	const float dielectricF0 = 0.04;
	dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);
	dAlbedo *= 1.0 - metalness;
}
#ifdef MAPFLOAT
uniform float material_metalness;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_metalnessMap;
#endif
void getSpecularity() {
	float metalness = 1.0;
	#ifdef MAPFLOAT
	metalness *= material_metalness;
	#endif
	#ifdef MAPTEXTURE
	metalness *= texture2D(texture_metalnessMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	metalness *= saturate(vVertexColor.$VC);
	#endif
	processMetalness(metalness);
}
`,hx=`uniform sampler2D texture_msdfMap;
#ifdef GL_OES_standard_derivatives
#define USE_FWIDTH
#endif
#ifdef GL2
#define USE_FWIDTH
#endif
float median(float r, float g, float b) {
	return max(min(r, g), min(max(r, g), b));
}
float map (float min, float max, float v) {
	return (v - min) / (max - min);
}
uniform float font_sdfIntensity;
uniform float font_pxrange;
uniform float font_textureWidth;
uniform vec4 outline_color;
uniform float outline_thickness;
uniform vec4 shadow_color;
uniform vec2 shadow_offset;
vec4 applyMsdf(vec4 color) {
	vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;
	vec2 uvShdw = vUv0 - shadow_offset;
	vec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;
	float sigDist = median(tsample.r, tsample.g, tsample.b);
	float sigDistShdw = median(ssample.r, ssample.g, ssample.b);
	float smoothingMax = 0.2;
	#ifdef USE_FWIDTH
	vec2 w = fwidth(vUv0);
	float smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);
	#else
	float font_size = 16.0;
	float smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);
	#endif
	float mapMin = 0.05;
	float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);
	float sigDistInner = map(mapMin, mapMax, sigDist);
	float sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);
	sigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);
	float center = 0.5;
	float inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);
	float outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);
	float shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);
	vec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);
	tcolor = mix(tcolor, color, inside);
	vec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;
	tcolor = mix(scolor, tcolor, outline);
	return tcolor;
}
`,cx=`#ifdef MORPHING_TEXTURE_BASED_NORMAL
uniform highp sampler2D morphNormalTex;
#endif
vec3 getNormal() {
	#ifdef SKIN
	dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);
	#elif defined(INSTANCING)
	dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);
	#else
	dNormalMatrix = matrix_normal;
	#endif
	vec3 tempNormal = vertex_normal;
	#ifdef MORPHING
	#ifdef MORPHING_NRM03
	tempNormal += morph_weights_a[0] * morph_nrm0;
	tempNormal += morph_weights_a[1] * morph_nrm1;
	tempNormal += morph_weights_a[2] * morph_nrm2;
	tempNormal += morph_weights_a[3] * morph_nrm3;
	#endif
	#ifdef MORPHING_NRM47
	tempNormal += morph_weights_b[0] * morph_nrm4;
	tempNormal += morph_weights_b[1] * morph_nrm5;
	tempNormal += morph_weights_b[2] * morph_nrm6;
	tempNormal += morph_weights_b[3] * morph_nrm7;
	#endif
	#endif
	#ifdef MORPHING_TEXTURE_BASED_NORMAL
	vec2 morphUV = getTextureMorphCoords();
	vec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;
	tempNormal += morphNormal;
	#endif
	return normalize(dNormalMatrix * tempNormal);
}
`,dx=`#ifdef MAPTEXTURE
uniform sampler2D texture_normalDetailMap;
uniform float material_normalDetailMapBumpiness;
vec3 blendNormals(vec3 n1, vec3 n2) {
	n1 += vec3(0, 0, 1);
	n2 *= vec3(-1, -1, 1);
	return normalize(n1*dot(n1, n2)/n1.z - n2);
}
#endif
vec3 addNormalDetail(vec3 normalMap) {
	#ifdef MAPTEXTURE
	vec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV, textureBias));
	normalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));
	return blendNormals(normalMap, normalDetailMap);
	#else
	return normalMap;
	#endif
}
`,ux=`vec3 getNormal() {
	dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);
	return normalize(dNormalMatrix * vertex_normal);
}
`,fx=`uniform sampler2D texture_normalMap;
uniform float material_bumpiness;
void getNormal() {
	vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV, textureBias));
	normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));
	dNormalMap = addNormalDetail(normalMap);
	dNormalW = dTBN * dNormalMap;
}
`,mx=`uniform sampler2D texture_normalMap;
void getNormal() {
	vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV, textureBias));
	dNormalMap = addNormalDetail(normalMap);
	dNormalW = dTBN * dNormalMap;
}
`,px=`vec3 getNormal() {
	dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);
	return normalize(dNormalMatrix * vertex_normal);
}
`,_x=`void getNormal() {
	dNormalW = normalize(dVertexNormalW);
}
`,gx=`vec3 unpackNormal(vec4 nmap) {
	vec3 normal;
	normal.xy = nmap.wy * 2.0 - 1.0;
	normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));
	return normal;
}
`,yx=`vec3 unpackNormal(vec4 nmap) {
	return nmap.xyz * 2.0 - 1.0;
}
`,xx=`#ifdef MAPFLOAT
uniform float material_opacity;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_opacityMap;
#endif
void getOpacity() {
	dAlpha = 1.0;
	#ifdef MAPFLOAT
	dAlpha *= material_opacity;
	#endif
	#ifdef MAPTEXTURE
	dAlpha *= texture2D(texture_opacityMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);
	#endif
}
`,vx=`gl_FragColor.a = dAlpha;
`,Sx=`gl_FragColor.a = 1.0;
`,bx=`gl_FragColor.rgb *= dAlpha;
gl_FragColor.a = dAlpha;
`,wx=`varying vec2 vUv0;
uniform sampler2D source;
void main(void) {
	gl_FragColor = texture2D(source, vUv0);
}
`,Tx=`vec4 packFloat(float depth) {
	const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
	const vec4 bit_mask	= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
	vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);
	res -= res.xxyz * bit_mask;
	return res;
}
`,Cx=`uniform sampler2D texture_heightMap;
uniform float material_heightMapFactor;
void getParallax() {
	float parallaxScale = material_heightMapFactor;
	float height = texture2D(texture_heightMap, $UV, textureBias).$CH;
	height = height * parallaxScale - parallaxScale*0.5;
	vec3 viewDirT = dViewDirW * dTBN;
	viewDirT.z += 0.42;
	dUvOffset = height * (viewDirT.xy / viewDirT.z);
}
`,Ax=`varying vec4 texCoordsAlphaLife;
uniform sampler2D colorMap;
uniform sampler2D colorParam;
uniform float graphSampleSize;
uniform float graphNumSamples;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
uniform float softening;
uniform float colorMult;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	float depth = dot(rgbaDepth, bitShift);
	return depth;
}
#endif
void main(void) {
	vec4 tex	= texture2DSRGB(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));
	vec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));
	ramp.rgb *= colorMult;
	ramp.a += texCoordsAlphaLife.z;
	vec3 rgb = tex.rgb * ramp.rgb;
	float a	= tex.a * ramp.a;
`,Mx=`vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {
	return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );
}
vec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex,tc);
	vec4 b = texture2D(tex,tc + graphSampleSize);
	float c = fract(tc.x*graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a, b, c);
}
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY) {
	#ifdef SCREEN_SPACE
		vec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;
	#else
		vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	#endif
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY) {
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
vec2 safeNormalize(vec2 v) {
	float l = length(v);
	return (l > 1e-06) ? v / l : v;
}
void main(void) {
	vec3 meshLocalPos = particle_vertexData.xyz;
	float id = floor(particle_vertexData.w);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
	float uv = id / numParticlesPot;
	readInput(uv);
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);
	float particleLifetime = lifetime;
	if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);
	vec2 quadXY = meshLocalPos.xy;
	float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);
	vec3 paramDiv;
	vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);
	float scale = params.y;
	float scaleDiv = paramDiv.x;
	float alphaDiv = paramDiv.z;
	scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);
#ifndef USE_MESH
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#else
	texCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);
#endif
	vec3 particlePos = inPos;
	vec3 particlePosMoved = vec3(0.0);
	mat2 rotMatrix;
`,Px=`	float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);
`,Ex=`	float animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));
`,Rx=`	float animationIndex;
	if (animTexIndexParams.y == 1.0) {
		animationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);
	} else {
		animationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);
	}
	float atlasX = (animationIndex + animFrame) * animTexTilesParams.x;
	float atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;
	atlasX = fract(atlasX);
	texCoordsAlphaLife.xy *= animTexTilesParams.xy;
	texCoordsAlphaLife.xy += vec2(atlasX, atlasY);
`,Ix=`void readInput(float uv) {
	vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));
	inPos = tex.xyz;
	inVel = tex2.xyz;
	inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;
	inShow = tex.w >= 0.0;
	inLife = tex2.w;
}
`,Lx=`#define PI2 6.283185307179586
uniform vec3 inBoundsSize;
uniform vec3 inBoundsCenter;
uniform float maxVel;
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float decodeFloatRGBA( vec4 rgba ) {
	return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );
}
void readInput(float uv) {
	vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));
	vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));
	vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));
	vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));
	inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));
	inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;
	inVel = tex2.xyz;
	inVel = (inVel - vec3(0.5)) * maxVel;
	inAngle = decodeFloatRG(tex1.ba) * PI2;
	inShow = tex2.a > 0.5;
	inLife = decodeFloatRGBA(tex3);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;
}
`,Dx=`void writeOutput() {
	if (gl_FragCoord.y<1.0) {
		gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);
	} else {
		gl_FragColor = vec4(outVel, outLife);
	}
}
`,Fx=`uniform vec3 outBoundsMul;
uniform vec3 outBoundsAdd;
vec2 encodeFloatRG( float v ) {
	vec2 enc = vec2(1.0, 255.0) * v;
	enc = fract(enc);
	enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
	return enc;
}
vec4 encodeFloatRGBA( float v ) {
	vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	enc = fract(enc);
	enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	return enc;
}
void writeOutput() {
	outPos = outPos * outBoundsMul + outBoundsAdd;
	outAngle = fract(outAngle / PI2);
	outVel = (outVel / maxVel) + vec3(0.5);
	float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));
	float maxPosLife = lifetime+1.0;
	outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);
	if (gl_FragCoord.y < 1.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));
	} else if (gl_FragCoord.y < 2.0) {
		gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));
	} else if (gl_FragCoord.y < 3.0) {
		gl_FragColor = vec4(outVel, visMode*0.5+0.5);
	} else {
		gl_FragColor = encodeFloatRGBA(outLife);
	}
}
`,Ox=`uniform mat3 spawnBounds;
uniform vec3 spawnPosInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	vec3 pos = inBounds - vec3(0.5);
	vec3 posAbs = abs(pos);
	vec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));
	vec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;
	pos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);
	pos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);
	pos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);
#ifndef LOCAL_SPACE
	return emitterPos + spawnBounds * pos;
#else
	return spawnBounds * pos;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity -= vec3(0, 0, initialVelocity);
}
`,Bx=`	writeOutput();
}
`,kx=`varying vec2 vUv0;
uniform highp sampler2D particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform highp sampler2D internalTex3;
uniform mat3 emitterMatrix, emitterMatrixInv;
uniform vec3 emitterScale;
uniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;
uniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;
uniform float startAngle, startAngle2;
uniform float initialVelocity;
uniform float graphSampleSize;
uniform float graphNumSamples;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
float visMode;
vec3 outPos;
vec3 outVel;
float outAngle;
bool outShow;
float outLife;
`,zx=`	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = -1.0;
	}
`,Ux=`	visMode = outLife < 0.0? -1.0: visMode;
`,Nx=`	if (outLife >= lifetime) {
		outLife -= max(lifetime, (numParticles - 1.0) * particleRate);
		visMode = 1.0;
	}
	visMode = outLife < 0.0? 1.0: visMode;
`,Vx=`uniform float spawnBoundsSphere;
uniform float spawnBoundsSphereInnerRatio;
vec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {
	float rnd4 = fract(rndFactor * 1000.0);
	vec3 norm = normalize(inBounds.xyz - vec3(0.5));
	float r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;
#ifndef LOCAL_SPACE
	return emitterPos + norm * r * spawnBoundsSphere;
#else
	return norm * r * spawnBoundsSphere;
#endif
}
void addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {
	localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;
}
`,Wx=`float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 unpack3NFloats(float src) {
	float r = fract(src);
	float g = fract(src * 256.0);
	float b = fract(src * 65536.0);
	return vec3(r, g, b);
}
vec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {
	vec4 a = texture2D(tex, tc);
	vec4 b = texture2D(tex, tc + graphSampleSize);
	float c = fract(tc.x * graphNumSamples);
	vec3 unpackedA = unpack3NFloats(a.w);
	vec3 unpackedB = unpack3NFloats(b.w);
	w = mix(unpackedA, unpackedB, c);
	return mix(a.xyz, b.xyz, c);
}
#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)
vec4 hash41(float p) {
	vec4 p4 = fract(vec4(p) * HASHSCALE4);
	p4 += dot(p4, p4.wzxy+19.19);
	return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));
}
void main(void) {
	if (gl_FragCoord.x > numParticles) discard;
	readInput(vUv0.x);
	visMode = inShow? 1.0 : -1.0;
	vec4 rndFactor = hash41(gl_FragCoord.x + seed);
	float particleRate = rate + rateDiv * rndFactor.x;
	outLife = inLife + delta;
	float nlife = clamp(outLife / lifetime, 0.0, 1.0);
	vec3 localVelocityDiv;
	vec3 velocityDiv;
	vec3 paramDiv;
	vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);
	vec3 velocity =		tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);
	vec3 params =		tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);
	float rotSpeed = params.x;
	float rotSpeedDiv = paramDiv.y;
	vec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);
	float radialSpeed = radialParams.x;
	float radialSpeedDiv = radialParams.y;
	bool respawn = inLife <= 0.0 || outLife >= lifetime;
	inPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;
	inAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;
#ifndef LOCAL_SPACE
	vec3 radialVel = inPos - emitterPos;
#else
	vec3 radialVel = inPos;
#endif
	radialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);
	radialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;
	localVelocity +=	(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;
	velocity +=		 (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;
	rotSpeed +=		 (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;
	addInitialVelocity(localVelocity, rndFactor.xyz);
#ifndef LOCAL_SPACE
	outVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;
#else
	outVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;
#endif
	outPos = inPos + outVel * delta;
	outAngle = inAngle + rotSpeed * delta;
`,Gx=`	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = billboard(particlePos, quadXY);
`,Hx=`	dBlendModeFogFactor = 0.0;
	rgb *= saturate(gammaCorrectInput(max(a, 0.0)));
	if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;
`,Xx=`	rgb = mix(vec3(1.0), rgb, vec3(a));
	if (rgb.r + rgb.g + rgb.b > 2.99) discard;
`,jx=`	if (a < 0.01) discard;
`,qx=`attribute vec4 particle_vertexData;
attribute vec4 particle_vertexData2;
attribute vec4 particle_vertexData3;
attribute float particle_vertexData4;
#ifndef USE_MESH
#define VDATA5TYPE vec2
#else
#define VDATA5TYPE vec4
#endif
attribute VDATA5TYPE particle_vertexData5;
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
uniform float numParticles;
uniform float lifetime;
uniform float stretch;
uniform float seed;
uniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;
uniform sampler2D texLifeAndSourcePosOUT;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
uniform vec3 emitterPos;
varying vec4 texCoordsAlphaLife;
vec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)
{
	float c = cos(pRotation);
	float s = sin(pRotation);
	mat2 m = mat2(c, -s, s, c);
	rotMatrix = m;
	return m * quadXY;
}
vec3 billboard(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;
	return pos;
}
vec3 customFace(vec3 InstanceCoords, vec2 quadXY)
{
	vec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;
	return pos;
}
void main(void)
{
	vec3 particlePos = particle_vertexData.xyz;
	vec3 inPos = particlePos;
	vec3 vertPos = particle_vertexData3.xyz;
	vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);
	float id = floor(particle_vertexData4);
	float rndFactor = fract(sin(id + 1.0 + seed));
	vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));
#ifdef LOCAL_SPACE
	inVel = mat3(matrix_model) * inVel;
#endif
	vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);
	vec2 quadXY = vertPos.xy;
#ifdef USE_MESH
	texCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);
#else
	texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);
#endif
	mat2 rotMatrix;
	float inAngle = particle_vertexData2.x;
	vec3 particlePosMoved = vec3(0.0);
	vec3 meshLocalPos = particle_vertexData3.xyz;
`,Yx=`	localPos *= particle_vertexData2.y * emitterScale;
	localPos += particlePos;
	gl_Position = matrix_viewProjection * vec4(localPos, 1.0);
`,$x=`	quadXY = rotate(quadXY, inAngle, rotMatrix);
	vec3 localPos = customFace(particlePos, quadXY);
`,Kx=`	rgb = addFog(rgb);
	rgb = toneMap(rgb);
	rgb = gammaCorrectOutput(rgb);
	gl_FragColor = vec4(rgb, a);
}
`,Zx=`	localPos *= scale * emitterScale;
	localPos += particlePos;
	#ifdef SCREEN_SPACE
	gl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);
	#else
	gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);
	#endif
`,Jx=`	vec3 negNormal = normal*0.5+0.5;
	vec3 posNormal = -normal*0.5+0.5;
	negNormal *= negNormal;
	posNormal *= posNormal;
`,Qx=`attribute vec4 particle_vertexData;
#ifdef USE_MESH
attribute vec2 particle_uv;
#endif
uniform mat4 matrix_viewProjection;
uniform mat4 matrix_model;
uniform mat3 matrix_normal;
uniform mat4 matrix_viewInverse;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform float numParticles, numParticlesPot;
uniform float graphSampleSize;
uniform float graphNumSamples;
uniform float stretch;
uniform vec3 wrapBounds;
uniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;
uniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;
uniform sampler2D particleTexOUT, particleTexIN;
uniform highp sampler2D internalTex0;
uniform highp sampler2D internalTex1;
uniform highp sampler2D internalTex2;
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
varying vec4 texCoordsAlphaLife;
vec3 inPos;
vec3 inVel;
float inAngle;
bool inShow;
float inLife;
`,tv=`	vec3 negNormal = max(normal, vec3(0.0));
	vec3 posNormal = max(-normal, vec3(0.0));
`,ev=`	vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +
						negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +
						negNormal.z*lightCube[4] + posNormal.z*lightCube[5];
	rgb *= light;
`,sv=`	particlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;
`,iv=`	vec3 localPos = meshLocalPos;
	localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);
	localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);
	billboard(particlePos, quadXY);
`,nv=`	Normal = normalize(localPos + matrix_viewInverse[2].xyz);
`,rv=`	vec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);
	vec3 normal = ParticleMat * normalMap;
`,av=`	inAngle = atan(velocityV.x, velocityV.y);
`,ov=`	float depth = getLinearScreenDepth();
	float particleDepth = vDepth;
	float depthDiff = saturate(abs(particleDepth - depth) * softening);
	a *= depthDiff;
`,lv=`	vDepth = getLinearDepth(localPos);
`,hv=`	vec3 moveDir = inVel * stretch;
	vec3 posPrev = particlePos - moveDir;
	posPrev += particlePosMoved;
	vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);
	float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;
	particlePos = mix(particlePos, posPrev, interpolation);
`,cv=`	mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);
	ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;
`,dv=`	vec3 origParticlePos = particlePos;
	particlePos -= matrix_model[3].xyz;
	particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;
	particlePos += matrix_model[3].xyz;
	particlePosMoved = particlePos - origParticlePos;
`,uv=`void main(void) {
	gl_FragColor = vec4(2147483648.0);
}
`,fv=`uniform sampler2D source;
vec4 packFloat(float depth) {
	const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
	const vec4 bit_mask	= vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
	vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);
	res -= res.xxyz * bit_mask;
	return res;
}
void main(void) {
	float c = texture2D(source, vec2(0.0)).r;
	float diff = abs(c - 2147483648.0) / 2147483648.0;
	gl_FragColor = packFloat(diff);
}
`,mv=`void getReflDir() {
	dReflDirW = normalize(-reflect(dViewDirW, dNormalW));
}
`,pv=`void getReflDir() {
	float roughness = sqrt(1.0 - min(dGlossiness, 1.0));
	float anisotropy = material_anisotropy * roughness;
	vec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];
	vec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);
	vec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);
	vec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));
	dReflDirW = reflect(-dViewDirW, bentNormal);
}
`,_v=`#ifdef CLEARCOAT
uniform float material_clearCoatReflectivity;
void addReflectionCC() {
	ccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);
}
#endif
`,gv=`uniform samplerCube texture_cubeMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 tReflDirW, float tGlossiness) {
	vec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));
	lookupVec.x *= -1.0;
	return $DECODE(textureCube(texture_cubeMap, lookupVec));
}
void addReflection() {
	dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);
}
`,yv=`#ifndef ENV_ATLAS
#define ENV_ATLAS
uniform sampler2D texture_envAtlas;
#endif
uniform float material_reflectivity;
float shinyMipLevel(vec2 uv) {
	vec2 dx = dFdx(uv);
	vec2 dy = dFdy(uv);
	vec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);
	vec2 dx2 = dFdx(uv2);
	vec2 dy2 = dFdy(uv2);
	float maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));
	return clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);
}
vec3 calcReflection(vec3 tReflDirW, float tGlossiness) {
	vec3 dir = cubeMapProject(tReflDirW) * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(dir);
	float level = saturate(1.0 - tGlossiness) * 5.0;
	float ilevel = floor(level);
	float level2 = shinyMipLevel(uv * atlasSize);
	float ilevel2 = floor(level2);
	vec2 uv0, uv1;
	float weight;
	if (ilevel == 0.0) {
		uv0 = mapMip(uv, ilevel2);
		uv1 = mapMip(uv, ilevel2 + 1.0);
		weight = level2 - ilevel2;
	} else {
		uv0 = uv1 = mapRoughnessUv(uv, ilevel);
		weight = 0.0;
	}
	vec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));
	vec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));
	vec3 linear0 = mix(linearA, linearB, weight);
	vec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));
	return processEnvironment(mix(linear0, linear1, level - ilevel));
}
void addReflection() {
	dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);
}
`,xv=`#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 tReflDirW, float tGlossiness) {
	vec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;
	float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );
	vec2 sphereMapUv = reflDirV.xy / m + 0.5;
	return $DECODE(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection() {
	dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);
}
`,vv=`uniform sampler2D texture_sphereMap;
uniform float material_reflectivity;
vec3 calcReflection(vec3 tReflDirW, float tGlossiness) {
	vec3 reflDirV = vNormalV;
	vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;
	return $DECODE(texture2D(texture_sphereMap, sphereMapUv));
}
void addReflection() {
	dReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);
}
`,Sv=`uniform float material_refraction, material_refractionIndex;
vec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {
	float vn = dot(viewVec, Normal);
	float k = 1.0 - IOR * IOR * (1.0 - vn * vn);
	vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;
	return refrVec;
}
void addRefraction() {
	vec3 tmp = dReflDirW;
	vec4 tmp2 = dReflection;
	dReflection = vec4(0.0);
	dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);
	addReflection();
	dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);
	dReflDirW = tmp;
	dReflection = tmp2;
}
`,bv=`varying vec2 vUv0;
uniform sampler2D sourceTex;
uniform samplerCube sourceCube;
uniform sampler2D samplesTex;
uniform vec2 samplesTexInverseSize;
uniform vec4 params;
uniform vec2 params2;
float targetFace() { return params.x; }
float specularPower() { return params.y; }
float sourceCubeSeamScale() { return params.z; }
float targetCubeSeamScale() { return params.w; }
float targetTotalPixels() { return params2.x; }
float sourceTotalPixels() { return params2.y; }
float PI = 3.141592653589793;
float saturate(float x) {
	return clamp(x, 0.0, 1.0);
}
vec3 decodeLinear(vec4 source) {
	return source.rgb;
}
vec4 encodeLinear(vec3 source) {
	return vec4(source, 1.0);
}
vec3 decodeGamma(vec4 source) {
	return pow(source.xyz, vec3(2.2));
}
vec4 encodeGamma(vec3 source) {
	return vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);
}
vec3 decodeRGBM(vec4 rgbm) {
	vec3 color = (8.0 * rgbm.a) * rgbm.rgb;
	return color * color;
}
vec4 encodeRGBM(vec3 source) {
	vec4 result;
	result.rgb = pow(source.rgb, vec3(0.5));
	result.rgb *= 1.0 / 8.0;
	result.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );
	result.a = ceil(result.a * 255.0) / 255.0;
	result.rgb /= result.a;
	return result;
}
vec3 decodeRGBE(vec4 source) {
	if (source.a == 0.0) {
		return vec3(0.0, 0.0, 0.0);
	} else {
		return source.xyz * pow(2.0, source.w * 255.0 - 128.0);
	}
}
vec4 encodeRGBE(vec3 source) {
	float maxVal = max(source.x, max(source.y, source.z));
	if (maxVal < 1e-32) {
		return vec4(0, 0, 0, 0);
	} else {
		float e = ceil(log2(maxVal));
		return vec4(source / pow(2.0, e), (e + 128.0) / 255.0);
	}
}
vec3 modifySeams(vec3 dir, float scale) {
	vec3 adir = abs(dir);
	float M = max(max(adir.x, adir.y), adir.z);
	return dir / M * vec3(
		adir.x == M ? 1.0 : scale,
		adir.y == M ? 1.0 : scale,
		adir.z == M ? 1.0 : scale
	);
}
vec2 toSpherical(vec3 dir) {
	return vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));
}
vec3 fromSpherical(vec2 uv) {
	return vec3(cos(uv.y) * sin(uv.x),
				sin(uv.y),
				cos(uv.y) * cos(uv.x));
}
vec3 getDirectionEquirect() {
	return fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));
}
vec4 sampleEquirect(vec2 sph) {
	vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
	return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
}
vec4 sampleEquirect(vec3 dir) {
	return sampleEquirect(toSpherical(dir));
}
vec4 sampleCubemap(vec3 dir) {
	return textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));
}
vec4 sampleCubemap(vec2 sph) {
	return sampleCubemap(fromSpherical(sph));
}
vec4 sampleEquirect(vec2 sph, float mipLevel) {
	vec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;
#ifdef SUPPORTS_TEXLOD
	return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
#else
	return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
#endif
}
vec4 sampleEquirect(vec3 dir, float mipLevel) {
	return sampleEquirect(toSpherical(dir), mipLevel);
}
vec4 sampleCubemap(vec3 dir, float mipLevel) {
#ifdef SUPPORTS_TEXLOD
	return textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);
#else
	return textureCube(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()));
#endif
}
vec4 sampleCubemap(vec2 sph, float mipLevel) {
	return sampleCubemap(fromSpherical(sph), mipLevel);
}
float signNotZero(float k){
	return(k >= 0.0) ? 1.0 : -1.0;
}
vec2 signNotZero(vec2 v) {
	return vec2(signNotZero(v.x), signNotZero(v.y));
}
vec3 octDecode(vec2 o) {
	vec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);
	if (v.y < 0.0) {
		v.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);
	}
	return normalize(v);
}
vec3 getDirectionOctahedral() {
	return octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);
}
vec2 octEncode(in vec3 v) {
	float l1norm = abs(v.x) + abs(v.y) + abs(v.z);
	vec2 result = v.xz * (1.0 / l1norm);
	if (v.y < 0.0) {
		result = (1.0 - abs(result.yx)) * signNotZero(result.xy);
	}
	return result;
}
vec4 sampleOctahedral(vec3 dir) {
	vec2 uv = octEncode(dir) * 0.5 + 0.5;
	return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
}
vec4 sampleOctahedral(vec2 sph) {
	return sampleOctahedral(fromSpherical(sph));
}
vec4 sampleOctahedral(vec3 dir, float mipLevel) {
	vec2 uv = octEncode(dir) * 0.5 + 0.5;
#ifdef SUPPORTS_TEXLOD
	return texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);
#else
	return texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));
#endif
}
vec4 sampleOctahedral(vec2 sph, float mipLevel) {
	return sampleOctahedral(fromSpherical(sph), mipLevel);
}
vec3 getDirectionCubemap() {
	vec2 st = vUv0 * 2.0 - 1.0;
	float face = targetFace();
	vec3 vec;
	if (face == 0.0) {
		vec = vec3(1, -st.y, -st.x);
	} else if (face == 1.0) {
		vec = vec3(-1, -st.y, st.x);
	} else if (face == 2.0) {
		vec = vec3(st.x, 1, st.y);
	} else if (face == 3.0) {
		vec = vec3(st.x, -1, -st.y);
	} else if (face == 4.0) {
		vec = vec3(st.x, -st.y, 1);
	} else {
		vec = vec3(-st.x, -st.y, -1);
	}
	return normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));
}
mat3 matrixFromVector(vec3 n) {
	float a = 1.0 / (1.0 + n.z);
	float b = -n.x * n.y * a;
	vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
	vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
	return mat3(b1, b2, n);
}
mat3 matrixFromVectorSlow(vec3 n) {
	vec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);
	vec3 x = normalize(cross(up, n));
	vec3 y = cross(n, x);
	return mat3(x, y, n);
}
vec4 reproject() {
	if (NUM_SAMPLES <= 1) {
		return ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));
	} else {
		vec2 sph = toSpherical(TARGET_FUNC());
		vec2 sphu = dFdx(sph);
		vec2 sphv = dFdy(sph);
		const float NUM_SAMPLES_SQRT = sqrt(float(NUM_SAMPLES));
		vec3 result = vec3(0.0);
		for (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {
			for (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {
				result += DECODE_FUNC(SOURCE_FUNC(sph +
													sphu * (u / NUM_SAMPLES_SQRT - 0.5) +
													sphv * (v / NUM_SAMPLES_SQRT - 0.5)));
			}
		}
		return ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));
	}
}
vec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);
void unpackSample(int i, out vec3 L, out float mipLevel) {
	float u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;
	float v = (floor(u) + 0.5) * samplesTexInverseSize.y;
	vec4 raw;
	raw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
	raw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
	raw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;
	raw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);
	L.xyz = raw.xyz * 2.0 - 1.0;
	mipLevel = raw.w * 8.0;
}
vec4 prefilterSamples() {
	mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());
	vec3 L;
	float mipLevel;
	vec3 result = vec3(0.0);
	float totalWeight = 0.0;
	for (int i = 0; i < NUM_SAMPLES; ++i) {
		unpackSample(i, L, mipLevel);
		result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;
		totalWeight += L.z;
	}
	return ENCODE_FUNC(result / totalWeight);
}
vec4 prefilterSamplesUnweighted() {
	mat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());
	vec3 L;
	float mipLevel;
	vec3 result = vec3(0.0);
	float totalWeight = 0.0;
	for (int i = 0; i < NUM_SAMPLES; ++i) {
		unpackSample(i, L, mipLevel);
		result += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));
	}
	return ENCODE_FUNC(result / float(NUM_SAMPLES));
}
void main(void) {
	gl_FragColor = PROCESS_FUNC();
}
`,wv=`vec3 texture2DRGBM(sampler2D tex, vec2 uv) {
	return decodeRGBM(texture2D(tex, uv));
}
vec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {
	return decodeRGBM(texture2D(tex, uv, bias));
}
vec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {
	return decodeRGBM(textureCube(tex, uvw));
}
`,Tv=`uniform highp sampler2D uDepthMap;
#ifndef SCREENSIZE
#define SCREENSIZE
uniform vec4 uScreenSize;
#endif
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
#ifndef CAMERAPLANES
#define CAMERAPLANES
uniform vec4 camera_params;
#endif
#ifdef GL2
float linearizeDepth(float z) {
	z = z * 2.0 - 1.0;
	return 1.0 / (camera_params.z * z + camera_params.w);
}
#else
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
#endif
float getLinearScreenDepth(vec2 uv) {
	#ifdef GL2
	return linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;
	#else
	return unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;
	#endif
}
#ifndef VERTEXSHADER
float getLinearScreenDepth() {
	vec2 uv = gl_FragCoord.xy * uScreenSize.zw;
	return getLinearScreenDepth(uv);
}
#endif
float getLinearDepth(vec3 pos) {
	return -(matrix_view * vec4(pos, 1.0)).z;
}
`,Cv=`const float maxCascades = 4.0;
mat4 cascadeShadowMat;
void getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {
	float depth = 1.0 / gl_FragCoord.w;
	float cascadeIndex = 0.0;
	for (float i = 0.0; i < maxCascades; i++) {
		if (depth < shadowCascadeDistances[int(i)]) {
			cascadeIndex = i;
			break;
		}
	}
	cascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);
	#ifdef GL2
		cascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];
	#else
		if (cascadeIndex == 0.0) {
			cascadeShadowMat = shadowMatrixPalette[0];
		}
		else if (cascadeIndex == 1.0) {
			cascadeShadowMat = shadowMatrixPalette[1];
		}
		else if (cascadeIndex == 2.0) {
			cascadeShadowMat = shadowMatrixPalette[2];
		}
		else {
			cascadeShadowMat = shadowMatrixPalette[3];
		}
	#endif
}
void fadeShadow(float shadowCascadeDistances[4]) {
	float depth = 1.0 / gl_FragCoord.w;
	if (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {
		dShadowCoord.z = -9999999.0;
	}
}
`,Av=`void normalOffsetPointShadow(vec4 shadowParams) {
	float distScale = length(dLightDirW);
	vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;
	vec3 dir = wPos - dLightPosW;
	dLightDirW = dir;
}
`,Mv=`void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {
	dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;
	dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;
	#ifdef SHADOWBIAS
	dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);
	#endif
}
void _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xy /= projPos.w;
	dShadowCoord.xy = projPos.xy;
	dShadowCoord.z = length(dLightDirW) * shadowParams.w;
	#ifdef SHADOWBIAS
	dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);
	#endif
}
void getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {
	_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);
}
void getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {
	_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);
}
void getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {
	float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));
	vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;
	_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);
}
void getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {
	vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);
	_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);
}
`,Pv=`void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {
	vec4 projPos = shadowMatrix * vec4(wPos, 1.0);
	projPos.xyz /= projPos.w;
	dShadowCoord = projPos.xyz;
}
void getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {
	float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));
	vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;
	_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);
}
void getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {
	_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);
}
`,Ev=`float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec3 moments = texture2D(tex, texCoords).xyz;
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {
	return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {
	return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,Rv=`float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	float pixelSize = 1.0 / resolution;
	texCoords -= vec2(pixelSize);
	vec3 s00 = texture2D(tex, texCoords).xyz;
	vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;
	vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;
	vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;
	vec2 fr = fract(texCoords * resolution);
	vec3 h0 = mix(s00, s10, fr.x);
	vec3 h1 = mix(s01, s11, fr.x);
	vec3 moments = mix(h0, h1, fr.y);
	return calculateEVSM(moments, Z, vsmBias, exponent);
}
float getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {
	return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);
}
float getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {
	return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);
}
`,Iv=`vec3 lessThan2(vec3 a, vec3 b) {
	return clamp((b - a)*1000.0, 0.0, 1.0);
}
#ifndef UNPACKFLOAT
#define UNPACKFLOAT
float unpackFloat(vec4 rgbaDepth) {
	const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);
	return dot(rgbaDepth, bitShift);
}
#endif
#ifdef GL2
float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {
	float z = dShadowCoord.z;
	vec2 uv = dShadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float sum = 0.0;
	float uw0 = (3.0 - 2.0 * s);
	float uw1 = (1.0 + 2.0 * s);
	float u0 = (2.0 - s) / uw0 - 1.0;
	float u1 = s / uw1 + 1.0;
	float vw0 = (3.0 - 2.0 * t);
	float vw1 = (1.0 + 2.0 * t);
	float v0 = (2.0 - t) / vw0 - 1.0;
	float v1 = t / vw1 + 1.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));
	sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));
	sum *= 1.0f / 16.0;
	return sum;
}
float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowParams);
}
float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowParams.xyz);
}
#else
float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {
	mat3 shadowKernel;
	vec3 shadowCoord = dShadowCoord;
	vec3 shadowZ = vec3(shadowCoord.z);
	shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));
	shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));
	shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));
	vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );
	shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);
	shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);
	vec4 shadowValues;
	shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);
	shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);
	shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);
	shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);
	return dot( shadowValues, vec4( 1.0 ) ) * 0.25;
}
float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {
	vec3 shadowCoord = dShadowCoord;
	float xoffset = 1.0 / shadowParams.x;
	float dx0 = -xoffset;
	float dx1 = xoffset;
	mat3 depthKernel;
	depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));
	depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));
	depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));
	depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));
	depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));
	depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));
	depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));
	depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));
	depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));
	return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);
}
float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowParams);
}
float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {
	return _getShadowPCF3x3(shadowMap, shadowParams.xyz);
}
#endif
float _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {
	vec3 tc = normalize(dir);
	vec3 tcAbs = abs(tc);
	vec4 dirX = vec4(1,0,0, tc.x);
	vec4 dirY = vec4(0,1,0, tc.y);
	float majorAxisLength = tc.z;
	if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {
		dirX = vec4(0,0,1, tc.z);
		dirY = vec4(0,1,0, tc.y);
		majorAxisLength = tc.x;
	} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {
		dirX = vec4(1,0,0, tc.x);
		dirY = vec4(0,0,1, tc.z);
		majorAxisLength = tc.y;
	}
	float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);
	vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);
	vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);
	vec3 dx0 = -xoffset;
	vec3 dy0 = -yoffset;
	vec3 dx1 = xoffset;
	vec3 dy1 = yoffset;
	mat3 shadowKernel;
	mat3 depthKernel;
	depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));
	depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));
	depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));
	depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));
	depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));
	depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));
	depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));
	depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));
	depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));
	vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);
	shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));
	shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));
	shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));
	vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;
	vec2 fractionalCoord = fract( uv * shadowParams.x );
	shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);
	shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);
	vec4 shadowValues;
	shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);
	shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);
	shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);
	shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);
	return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;
}
float getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {
	return _getShadowPoint(shadowMap, shadowParams, dLightDirW);
}
`,Lv=`float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {
	float z = dShadowCoord.z;
	vec2 uv = dShadowCoord.xy * shadowParams.x;
	float shadowMapSizeInv = 1.0 / shadowParams.x;
	vec2 base_uv = floor(uv + 0.5);
	float s = (uv.x + 0.5 - base_uv.x);
	float t = (uv.y + 0.5 - base_uv.y);
	base_uv -= vec2(0.5);
	base_uv *= shadowMapSizeInv;
	float uw0 = (4.0 - 3.0 * s);
	float uw1 = 7.0;
	float uw2 = (1.0 + 3.0 * s);
	float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;
	float u1 = (3.0 + s) / uw1;
	float u2 = s / uw2 + 2.0;
	float vw0 = (4.0 - 3.0 * t);
	float vw1 = 7.0;
	float vw2 = (1.0 + 3.0 * t);
	float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;
	float v1 = (3.0 + t) / vw1;
	float v2 = t / vw2 + 2.0;
	float sum = 0.0;
	u0 = u0 * shadowMapSizeInv + base_uv.x;
	v0 = v0 * shadowMapSizeInv + base_uv.y;
	u1 = u1 * shadowMapSizeInv + base_uv.x;
	v1 = v1 * shadowMapSizeInv + base_uv.y;
	u2 = u2 * shadowMapSizeInv + base_uv.x;
	v2 = v2 * shadowMapSizeInv + base_uv.y;
	sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));
	sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));
	sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));
	sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));
	sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));
	sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));
	sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));
	sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));
	sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));
	sum *= 1.0f / 144.0;
	sum = gammaCorrectInput(sum);
	sum = saturate(sum);
	return sum;
}
float getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {
	return _getShadowPCF5x5(shadowMap, shadowParams);
}
float getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {
	return _getShadowPCF5x5(shadowMap, shadowParams.xyz);
}
`,Dv=`float calculateVSM8(vec3 moments, float Z, float vsmBias) {
	float VSMBias = vsmBias;
	float depthScale = VSMBias * Z;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);
}
float decodeFloatRG(vec2 rg) {
	return rg.y*(1.0/255.0) + rg.x;
}
float VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {
	vec4 c = texture2D(tex, texCoords);
	vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);
	return calculateVSM8(moments, Z, vsmBias);
}
float getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {
	return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);
}
float getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {
	return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);
}
`,Fv=`float linstep(float a, float b, float v) {
	return saturate((v - a) / (b - a));
}
float reduceLightBleeding(float pMax, float amount) {
	 return linstep(amount, 1.0, pMax);
}
float chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {
	float variance = moments.y - (moments.x * moments.x);
	variance = max(variance, minVariance);
	float d = mean - moments.x;
	float pMax = variance / (variance + (d * d));
	pMax = reduceLightBleeding(pMax, lightBleedingReduction);
	return (mean <= moments.x ? 1.0 : pMax);
}
float calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {
	Z = 2.0 * Z - 1.0;
	float warpedDepth = exp(exponent * Z);
	moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);
	float VSMBias = vsmBias;
	float depthScale = VSMBias * exponent * warpedDepth;
	float minVariance1 = depthScale * depthScale;
	return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);
}
`,Ov=`attribute float vertex_boneIndices;
uniform vec4 matrix_pose[BONE_LIMIT * 3];
mat4 getBoneMatrix(const in float i) {
	vec4 v1 = matrix_pose[int(3.0 * i)];
	vec4 v2 = matrix_pose[int(3.0 * i + 1.0)];
	vec4 v3 = matrix_pose[int(3.0 * i + 2.0)];
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,Bv=`attribute float vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
uniform vec4 texture_poseMapSize;
mat4 getBoneMatrix(const in float i) {
	float j = i * 3.0;
	float dx = texture_poseMapSize.z;
	float dy = texture_poseMapSize.w;
	float y = floor(j * dx);
	float x = j - (y * texture_poseMapSize.x);
	y = dy * (y + 0.5);
	vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));
	vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));
	vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, 1
	);
}
`,kv=`attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform vec4 matrix_pose[BONE_LIMIT * 3];
void getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {
	v1 = matrix_pose[int(3.0 * i)];
	v2 = matrix_pose[int(3.0 * i + 1.0)];
	v3 = matrix_pose[int(3.0 * i + 2.0)];
}
mat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {
	vec4 a1, a2, a3;
	getBoneMatrix(indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,zv=`attribute vec4 vertex_boneWeights;
attribute vec4 vertex_boneIndices;
uniform highp sampler2D texture_poseMap;
uniform vec4 texture_poseMapSize;
void getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {
	float j = i * 3.0;
	float dx = texture_poseMapSize.z;
	float dy = texture_poseMapSize.w;
	float y = floor(j * dx);
	float x = j - (y * texture_poseMapSize.x);
	y = dy * (y + 0.5);
	v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));
	v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));
	v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));
}
mat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {
	vec4 a1, a2, a3;
	getBoneMatrix(indices.x, a1, a2, a3);
	vec4 b1, b2, b3;
	getBoneMatrix(indices.y, b1, b2, b3);
	vec4 c1, c2, c3;
	getBoneMatrix(indices.z, c1, c2, c3);
	vec4 d1, d2, d3;
	getBoneMatrix(indices.w, d1, d2, d3);
	vec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;
	vec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;
	vec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;
	float one = dot(weights, vec4(1.0));
	return mat4(
		v1.x, v2.x, v3.x, 0,
		v1.y, v2.y, v3.y, 0,
		v1.z, v2.z, v3.z, 0,
		v1.w, v2.w, v3.w, one
	);
}
`,Uv=`varying vec3 vViewDir;
uniform sampler2D texture_envAtlas;
uniform float mipLevel;
void main(void) {
	vec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);
	vec2 uv = toSphericalUv(normalize(dir));
	vec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));
	gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);
}
`,Nv=`varying vec3 vViewDir;
uniform samplerCube texture_cubeMap;
void main(void) {
	vec3 dir=vViewDir;
	dir.x *= -1.0;
	vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);
	color = toneMap(color);
	color = gammaCorrectOutput(color);
	gl_FragColor = vec4(color, 1.0);
}
`,Vv=`attribute vec3 aPosition;
#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
uniform mat4 matrix_projectionSkybox;
uniform mat3 cubeMapRotationMatrix;
varying vec3 vViewDir;
void main(void) {
	mat4 view = matrix_view;
	view[3][0] = view[3][1] = view[3][2] = 0.0;
	gl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);
	gl_Position.z = gl_Position.w - 0.00001;
	vViewDir = aPosition * cubeMapRotationMatrix;
}
`,Wv=`#ifdef MAPCOLOR
uniform vec3 material_specular;
#endif
#ifdef MAPTEXTURE
uniform sampler2D texture_specularMap;
#endif
void getSpecularity() {
	dSpecularity = vec3(1.0);
	#ifdef MAPCOLOR
	dSpecularity *= material_specular;
	#endif
	#ifdef MAPTEXTURE
	dSpecularity *= texture2D(texture_specularMap, $UV, textureBias).$CH;
	#endif
	#ifdef MAPVERTEX
	dSpecularity *= saturate(vVertexColor.$VC);
	#endif
}
`,Gv=`float antiAliasGlossiness(float power) {
	return power;
}
`,Hv=`float antiAliasGlossiness(float power) {
	float rlen = 1.0 / saturate(length(dNormalMap));
	float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));
	return power * mix(1.0, toksvig, material_bumpiness);
}
`,Xv=`float antiAliasGlossiness(float power) {
	float rlen = 1.0 / saturate(length(dNormalMap));
	float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));
	return power * toksvig;
}
`,jv=`float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {
	float cosAngle = dot(dLightDirNormW, lightSpotDirW);
	return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);
}
`,qv=`void main(void) {
	dDiffuseLight = vec3(0);
	dSpecularLight = vec3(0);
	dReflection = vec4(0);
	dSpecularity = vec3(0);
	#ifdef CLEARCOAT
	ccSpecularLight = vec3(0);
	ccReflection = vec4(0);
	#endif
`,Yv=`void main(void) {
	gl_Position = getPosition();
`,$v=`	nineSlicedUv = vUv0;
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,Kv=`	vec2 tileMask = step(vMask, vec2(0.99999));
	vec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);
	vec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);
	vec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));
	clampedUv = clampedUv * atlasRect.zw + atlasRect.xy;
	nineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);
	nineSlicedUv.y = 1.0 - nineSlicedUv.y;
`,Zv=`float exponent = VSM_EXPONENT;
depth = 2.0 * depth - 1.0;
depth =	exp(exponent * depth);
gl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);
`,Jv=`vec3 getTangent() {
	return normalize(dNormalMatrix * vertex_tangent.xyz);
}
vec3 getBinormal() {
	return cross(vNormalW, vTangentW) * vertex_tangent.w;
}
vec3 getObjectSpaceUp() {
	return normalize(dNormalMatrix * vec3(0, 1, 0));
}
`,Qv=`void getTBN() {
	dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));
}
`,tS=`uniform float tbnBasis;
void getTBN() {
	vec2 uv = $UV;
	vec3 dp1 = dFdx( vPositionW );
	vec3 dp2 = dFdy( vPositionW );
	vec2 duv1 = dFdx( uv );
	vec2 duv2 = dFdy( uv );
	vec3 dp2perp = cross( dp2, dVertexNormalW );
	vec3 dp1perp = cross( dVertexNormalW, dp1 );
	vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;
	vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;
	float denom = max( dot(T,T), dot(B,B) );
	float invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );
	dTBN = mat3(T * invmax, -B * invmax, dVertexNormalW );
}
`,eS=`void getTBN() {
	dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);
}
`,sS=`void getTBN() {
	vec3 B = cross(dVertexNormalW, vObjectSpaceUpW);
	vec3 T = cross(dVertexNormalW, B);
	if (dot(B,B)==0.0)
	{
		float major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);
		if (dVertexNormalW.x==major)
		{
			B=cross(dVertexNormalW, vec3(0,1,0));
			T=cross(dVertexNormalW, B);
		}
		else if (dVertexNormalW.y==major)
		{
			B=cross(dVertexNormalW, vec3(0,0,1));
			T=cross(dVertexNormalW, B);
		}
		else if (dVertexNormalW.z==major)
		{
			B=cross(dVertexNormalW, vec3(1,0,0));
			T=cross(dVertexNormalW, B);
		}
	}
	dTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));
}
`,iS=`uniform float exposure;
vec3 toneMap(vec3 color) {
	float tA = 2.51;
	float tB = 0.03;
	float tC = 2.43;
	float tD = 0.59;
	float tE = 0.14;
	vec3 x = color * exposure;
	return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);
}
`,nS=`uniform float exposure;
const mat3 ACESInputMat = mat3(
	0.59719, 0.35458, 0.04823,
	0.07600, 0.90834, 0.01566,
	0.02840, 0.13383, 0.83777
);
const mat3 ACESOutputMat = mat3(
	 1.60475, -0.53108, -0.07367,
	-0.10208,	1.10813, -0.00605,
	-0.00327, -0.07276,	1.07602
);
vec3 RRTAndODTFit(vec3 v) {
	vec3 a = v * (v + 0.0245786) - 0.000090537;
	vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;
	return a / b;
}
vec3 toneMap(vec3 color) {
	color *= exposure;
	color = color * ACESInputMat;
	color = RRTAndODTFit(color);
	color = color * ACESOutputMat;
	color = clamp(color, 0.0, 1.0);
	return color;
}
`,rS=`const float A =	0.15;
const float B =	0.50;
const float C =	0.10;
const float D =	0.20;
const float E =	0.02;
const float F =	0.30;
const float W =	11.2;
uniform float exposure;
vec3 uncharted2Tonemap(vec3 x) {
	 return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}
vec3 toneMap(vec3 color) {
	color = uncharted2Tonemap(color * exposure);
	vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));
	color = color * whiteScale;
	return color;
}
`,aS=`uniform float exposure;
vec3 toneMap(vec3 color) {
	color *= exposure;
	const float	A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;
	const float Scl = 1.25;
	vec3 h = max( vec3(0.0), color - vec3(0.004) );
	return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);
}
`,oS=`uniform float exposure;
vec3 toneMap(vec3 color) {
	return color * exposure;
}
`,lS=`vec3 toneMap(vec3 color) {
	return color;
}
`,hS=`#ifdef PIXELSNAP
uniform vec4 uScreenSize;
#endif
#ifdef MORPHING
uniform vec4 morph_weights_a;
uniform vec4 morph_weights_b;
#endif
#ifdef MORPHING_TEXTURE_BASED
uniform vec4 morph_tex_params;
vec2 getTextureMorphCoords() {
	float vertexId = morph_vertex_id;
	vec2 textureSize = morph_tex_params.xy;
	vec2 invTextureSize = morph_tex_params.zw;
	float morphGridV = floor(vertexId * invTextureSize.x);
	float morphGridU = vertexId - (morphGridV * textureSize.x);
	return (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);
}
#endif
#ifdef MORPHING_TEXTURE_BASED_POSITION
uniform highp sampler2D morphPositionTex;
#endif
mat4 getModelMatrix() {
	#ifdef DYNAMICBATCH
	return getBoneMatrix(vertex_boneIndices);
	#elif defined(SKIN)
	return matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);
	#elif defined(INSTANCING)
	return mat4(instance_line1, instance_line2, instance_line3, instance_line4);
	#else
	return matrix_model;
	#endif
}
vec4 getPosition() {
	dModelMatrix = getModelMatrix();
	vec3 localPos = vertex_position;
	#ifdef NINESLICED
	localPos.xz *= outerScale;
	vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
	vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
	localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
	vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;
	localPos.xz *= -0.5;
	localPos = localPos.xzy;
	#endif
	#ifdef MORPHING
	#ifdef MORPHING_POS03
	localPos.xyz += morph_weights_a[0] * morph_pos0;
	localPos.xyz += morph_weights_a[1] * morph_pos1;
	localPos.xyz += morph_weights_a[2] * morph_pos2;
	localPos.xyz += morph_weights_a[3] * morph_pos3;
	#endif
	#ifdef MORPHING_POS47
	localPos.xyz += morph_weights_b[0] * morph_pos4;
	localPos.xyz += morph_weights_b[1] * morph_pos5;
	localPos.xyz += morph_weights_b[2] * morph_pos6;
	localPos.xyz += morph_weights_b[3] * morph_pos7;
	#endif
	#endif
	#ifdef MORPHING_TEXTURE_BASED_POSITION
	vec2 morphUV = getTextureMorphCoords();
	vec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;
	localPos += morphPos;
	#endif
	vec4 posW = dModelMatrix * vec4(localPos, 1.0);
	#ifdef SCREENSPACE
	posW.zw = vec2(0.0, 1.0);
	#endif
	dPositionW = posW.xyz;
	vec4 screenPos;
	#ifdef UV1LAYOUT
	screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);
	#else
	#ifdef SCREENSPACE
	screenPos = posW;
	#else
	screenPos = matrix_viewProjection * posW;
	#endif
	#ifdef PIXELSNAP
	screenPos.xy = (screenPos.xy * 0.5) + 0.5;
	screenPos.xy *= uScreenSize.xy;
	screenPos.xy = floor(screenPos.xy);
	screenPos.xy *= uScreenSize.zw;
	screenPos.xy = (screenPos.xy * 2.0) - 1.0;
	#endif
	#endif
	return screenPos;
}
vec3 getWorldPosition() {
	return dPositionW;
}
`,cS=`attribute vec3 vertex_position;
uniform mat4 matrix_model;
uniform mat4 matrix_viewProjection;
vec3 dPositionW;
mat4 dModelMatrix;
`,dS=`#ifdef NINESLICED
vec2 getUv0() {
	vec2 uv = vertex_position.xz;
	vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));
	vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));
	uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;
	uv = uv * -0.5 + 0.5;
	uv = uv * atlasRect.zw + atlasRect.xy;
	vMask = vertex_texCoord0.xy;
	return uv;
}
#else
vec2 getUv0() {
	return vertex_texCoord0;
}
#endif
`,uS=`vec2 getUv1() {
	return vertex_texCoord1;
}
`,fS=`void getViewDir() {
	dViewDirW = normalize(view_position - vPositionW);
}
`,mS=`#ifndef VIEWMATRIX
#define VIEWMATRIX
uniform mat4 matrix_view;
#endif
vec3 getViewNormal() {
	return mat3(matrix_view) * vNormalW;
}
`;const F={alphaTestPS:Uy,ambientConstantPS:Ny,ambientEnvPS:Vy,ambientSHPS:Wy,aoPS:Gy,aoDiffuseOccPS:Hy,aoSpecOccPS:Xy,aoSpecOccConstPS:jy,aoSpecOccConstSimplePS:qy,aoSpecOccSimplePS:Yy,bakeDirLmEndPS:$y,bakeLmEndPS:Ky,basePS:Zy,baseVS:Jy,baseNineSlicedPS:Qy,baseNineSlicedVS:t0,baseNineSlicedTiledPS:e0,biasConstPS:s0,blurVSMPS:i0,clearCoatPS:n0,clearCoatGlossPS:r0,clearCoatNormalPS:a0,clusteredLightCookiesPS:l0,clusteredLightShadowsPS:h0,clusteredLightUtilsPS:o0,clusteredLightPS:c0,combineClearCoatPS:d0,combineDiffusePS:u0,combineDiffuseSpecularPS:f0,combineDiffuseSpecularNoConservePS:m0,combineDiffuseSpecularNoReflPS:p0,combineDiffuseSpecularNoReflSeparateAmbientPS:_0,combineDiffuseSpecularOldPS:g0,cookiePS:y0,cubeMapProjectBoxPS:x0,cubeMapProjectNonePS:v0,cubeMapRotatePS:S0,detailModesPS:w0,diffusePS:T0,diffuseDetailMapPS:C0,dilatePS:A0,bilateralDeNoisePS:M0,decodePS:b0,emissivePS:P0,endPS:E0,endVS:R0,envConstPS:I0,envMultiplyPS:L0,extensionPS:D0,extensionVS:F0,falloffInvSquaredPS:O0,falloffLinearPS:B0,fixCubemapSeamsNonePS:k0,fixCubemapSeamsStretchPS:z0,floatUnpackingPS:U0,fogExpPS:N0,fogExp2PS:V0,fogLinearPS:W0,fogNonePS:G0,fresnelSchlickPS:H0,fullscreenQuadPS:X0,fullscreenQuadVS:j0,gamma1_0PS:q0,gamma2_2PS:Y0,gles3PS:$0,gles3VS:K0,glossPS:Z0,instancingVS:J0,lightDiffuseLambertPS:Q0,lightDirPointPS:tx,lightmapDirPS:ex,lightmapSinglePS:sx,lightmapSingleVertPS:ix,lightSpecularAnisoGGXPS:nx,lightSpecularBlinnPS:rx,lightSpecularPhongPS:ax,ltc:ox,metalnessPS:lx,msdfPS:hx,normalVS:cx,normalDetailMapPS:dx,normalInstancedVS:ux,normalMapPS:fx,normalMapFastPS:mx,normalSkinnedVS:px,normalVertexPS:_x,normalXYPS:gx,normalXYZPS:yx,opacityPS:xx,outputAlphaPS:vx,outputAlphaOpaquePS:Sx,outputAlphaPremulPS:bx,outputTex2DPS:wx,packDepthPS:Tx,parallaxPS:Cx,particlePS:Ax,particleVS:Mx,particleAnimFrameClampVS:Px,particleAnimFrameLoopVS:Ex,particleAnimTexVS:Rx,particleInputFloatPS:Ix,particleInputRgba8PS:Lx,particleOutputFloatPS:Dx,particleOutputRgba8PS:Fx,particleUpdaterAABBPS:Ox,particleUpdaterEndPS:Bx,particleUpdaterInitPS:kx,particleUpdaterNoRespawnPS:zx,particleUpdaterOnStopPS:Ux,particleUpdaterRespawnPS:Nx,particleUpdaterSpherePS:Vx,particleUpdaterStartPS:Wx,particle_billboardVS:Gx,particle_blendAddPS:Hx,particle_blendMultiplyPS:Xx,particle_blendNormalPS:jx,particle_cpuVS:qx,particle_cpu_endVS:Yx,particle_customFaceVS:$x,particle_endPS:Kx,particle_endVS:Zx,particle_halflambertPS:Jx,particle_initVS:Qx,particle_lambertPS:tv,particle_lightingPS:ev,particle_localShiftVS:sv,particle_meshVS:iv,particle_normalVS:nv,particle_normalMapPS:rv,particle_pointAlongVS:av,particle_softPS:ov,particle_softVS:lv,particle_stretchVS:hv,particle_TBNVS:cv,particle_wrapVS:dv,precisionTestPS:uv,precisionTest2PS:fv,reflDirPS:mv,reflDirAnisoPS:pv,reflectionCCPS:_v,reflectionCubePS:gv,reflectionEnvPS:yv,reflectionSpherePS:xv,reflectionSphereLowPS:vv,refractionPS:Sv,reprojectPS:bv,rgbmPS:wv,screenDepthPS:Tv,shadowCascadesPS:Cv,shadowCommonPS:Av,shadowCoordPS:Mv,shadowCoordPerspZbufferPS:Pv,shadowEVSMPS:Ev,shadowEVSMnPS:Rv,shadowStandardPS:Iv,shadowStandardGL2PS:Lv,shadowVSM8PS:Dv,shadowVSM_commonPS:Fv,skinBatchConstVS:Ov,skinBatchTexVS:Bv,skinConstVS:kv,skinTexVS:zv,skyboxEnvPS:Uv,skyboxHDRPS:Nv,skyboxVS:Vv,specularPS:Wv,specularAaNonePS:Gv,specularAaToksvigPS:Hv,specularAaToksvigFastPS:Xv,spotPS:jv,startPS:qv,startVS:Yv,startNineSlicedPS:$v,startNineSlicedTiledPS:Kv,storeEVSMPS:Zv,tangentBinormalVS:Jv,TBNPS:Qv,TBNderivativePS:tS,TBNfastPS:eS,TBNObjectSpacePS:sS,tonemappingAcesPS:iS,tonemappingAces2PS:nS,tonemappingFilmicPS:rS,tonemappingHejlPS:aS,tonemappingLinearPS:oS,tonemappingNonePS:lS,transformVS:hS,transformDeclVS:cS,uv0VS:dS,uv1VS:uS,viewDirPS:fS,viewNormalVS:mS};function Lr(o,t){return t||(t=F),o===Mu||o===ty?t.gamma2_2PS?t.gamma2_2PS:F.gamma2_2PS:o===Ra?`#define HDR
`+(t.gamma2_2PS?t.gamma2_2PS:F.gamma2_2PS):t.gamma1_0PS?t.gamma1_0PS:F.gamma1_0PS}function Dr(o,t){return t||(t=F),o===ey?t.tonemappingFilmicPS?t.tonemappingFilmicPS:F.tonemappingFilmicPS:o===Ia?t.tonemappingLinearPS?t.tonemappingLinearPS:F.tonemappingLinearPS:o===sy?t.tonemappingHejlPS?t.tonemappingHejlPS:F.tonemappingHejlPS:o===iy?t.tonemappingAcesPS?t.tonemappingAcesPS:F.tonemappingAcesPS:o===ny?t.tonemappingAces2PS?t.tonemappingAces2PS:F.tonemappingAces2PS:t.tonemapingNonePS?t.tonemapingNonePS:F.tonemappingNonePS}function $h(o,t){return t||(t=F),o==="linear"?t.fogLinearPS?t.fogLinearPS:F.fogLinearPS:o==="exp"?t.fogExpPS?t.fogExpPS:F.fogExpPS:o==="exp2"?t.fogExp2PS?t.fogExp2PS:F.fogExp2PS:t.fogNonePS?t.fogNonePS:F.fogNonePS}function Kh(o,t){return t||(t=F),o.supportsBoneTextures?t.skinTexVS:"#define BONE_LIMIT "+o.getBoneLimit()+`
`+t.skinConstVS}function di(o){let t="precision "+o.precision+` float;
`;return o.webgl2&&(t+=`#ifdef GL2
precision `+o.precision+` sampler2DShadow;
#endif
`),t}function Oi(o){return o.webgl2?`#version 300 es
`:""}function _f(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function pn(){return`void main(void)
{
`}function Bi(){return`}
`}const pS={vertex_position:Ot,vertex_normal:pe,vertex_tangent:vs,vertex_texCoord0:be,vertex_texCoord1:hi,vertex_texCoord2:no,vertex_texCoord3:ro,vertex_texCoord4:ao,vertex_texCoord5:oo,vertex_texCoord6:lo,vertex_texCoord7:ho,vertex_color:de,vertex_boneIndices:Se,vertex_boneWeights:Ss};function go(o){const t={};let e=0,s=o.indexOf("attribute");for(;s>=0&&!(s>0&&o[s-1]==="/");){const i=o.indexOf(";",s),n=o.lastIndexOf(" ",i),r=o.substr(n+1,i-(n+1)),a=pS[r];a!==void 0?t[r]=a:(t[r]="ATTR"+e,e++),s=o.indexOf("attribute",s+1)}return t}function _S(o,t,e,s=!1){let i=F[t],n=di(o)+`
`+F[e];const r=go(i);return o.webgl2&&(i=Oi(o)+F.gles3VS+i,n=Oi(o)+F.gles3PS+n),new Ir(o,{attributes:r,vshader:i,fshader:n,useTransformFeedback:s})}function we(o,t,e,s,i=!1,n=""){const r=o.programLib._cache,a=r[s];if(a!==void 0)return a;e=di(o)+`
`+(e||_f());const l=go(t);return o.webgl2&&(t=Oi(o)+F.gles3VS+t,e=Oi(o)+F.gles3PS+e),r[s]=new Ir(o,{attributes:l,vshader:t,fshader:n+e,useTransformFeedback:i}),r[s]}F.collectAttribs=go;F.createShader=_S;F.createShaderFromCode=we;class gf{constructor(){this.globalId=0,this.revision=0}equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}}let yf=0;class gS{constructor(){yf++,this.version=new gf,this.version.globalId=yf}increment(){this.version.revision++}}class yS{constructor(t){this.name=t,this.value=null,this.versionObject=new gS}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class xS{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new yS(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}const vS={generateKey:function(o){let t="basic";return o.fog&&(t+="_fog"),o.alphaTest&&(t+="_atst"),o.vertexColors&&(t+="_vcol"),o.diffuseMap&&(t+="_diff"),o.skin&&(t+="_skin"),o.screenSpace&&(t+="_ss"),o.useInstancing&&(t+="_inst"),o.useMorphPosition&&(t+="_morphp"),o.useMorphNormal&&(t+="_morphn"),o.useMorphTextureBased&&(t+="_morpht"),t+="_"+o.pass,t},createShaderDefinition:function(o,t){const e={vertex_position:Ot};t.skin&&(e.vertex_boneWeights=Ss,e.vertex_boneIndices=Se),t.vertexColors&&(e.vertex_color=de),t.diffuseMap&&(e.vertex_texCoord0=be);let s="";s+=F.transformDeclVS,t.skin?(s+=Kh(o),s+=F.transformSkinnedVS):s+=F.transformVS,t.vertexColors&&(s+=`attribute vec4 vertex_color;
`,s+=`varying vec4 vColor;
`),t.diffuseMap&&(s+=`attribute vec2 vertex_texCoord0;
`,s+=`varying vec2 vUv0;
`),t.pass===ri&&(s+=`varying float vDepth;
`,s+=`#ifndef VIEWMATRIX
`,s+=`#define VIEWMATRIX
`,s+=`uniform mat4 matrix_view;
`,s+=`#endif
`,s+=`#ifndef CAMERAPLANES
`,s+=`#define CAMERAPLANES
`,s+=`uniform vec4 camera_params;

`,s+=`#endif
`),s+=pn(),s+=`	 gl_Position = getPosition();
`,t.pass===ri&&(s+=`		vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;
`),t.vertexColors&&(s+=`		vColor = vertex_color;
`),t.diffuseMap&&(s+=`		vUv0 = vertex_texCoord0;
`),s+=Bi();const i=s;return s=di(o),t.vertexColors?s+=`varying vec4 vColor;
`:s+=`uniform vec4 uColor;
`,t.diffuseMap&&(s+=`varying vec2 vUv0;
`,s+=`uniform sampler2D texture_diffuseMap;
`),t.fog&&(s+=$h(t.fog)),t.alphatest&&(s+=F.alphaTestPS),t.pass===ri&&(s+=`varying float vDepth;
`,s+=F.packDepthPS),s+=pn(),t.vertexColors?s+=`		gl_FragColor = vColor;
`:s+=`		gl_FragColor = uColor;
`,t.diffuseMap&&(s+=`		gl_FragColor *= texture2D(texture_diffuseMap, vUv0);
`),t.alphatest&&(s+=`	 alphaTest(gl_FragColor.a);
`),t.pass!==fr&&(t.pass===ri?s+=`		gl_FragColor = packFloat(vDepth);
`:t.fog&&(s+=`	 glFragColor.rgb = addFog(gl_FragColor.rgb);
`)),s+=Bi(),{attributes:e,vshader:i,fshader:s}}},SS={generateKey:function(o){let t="particle";for(const e in o)o.hasOwnProperty(e)&&(t+=o[e]);return t},_animTex:function(o){let t="";return t+=o.animTexLoop?F.particleAnimFrameLoopVS:F.particleAnimFrameClampVS,t+=F.particleAnimTexVS,t},createShaderDefinition:function(o,t){let e="",s=di(o)+`
`;s+=`#define PARTICLE
`,o.webgl2&&(e+=`#define GL2
`,s+=`#define GL2
`),e+=`#define VERTEXSHADER
`,t.mesh&&(e+=`#define USE_MESH
`),t.localSpace&&(e+=`#define LOCAL_SPACE
`),t.screenSpace&&(e+=`#define SCREEN_SPACE
`),t.animTex&&(e+=`
uniform vec2 animTexTilesParams;
`),t.animTex&&(e+=`
uniform vec4 animTexParams;
`),t.animTex&&(e+=`
uniform vec2 animTexIndexParams;
`),t.normal===2&&(e+=`
varying mat3 ParticleMat;
`),t.normal===1&&(e+=`
varying vec3 Normal;
`),t.soft&&(e+=`
varying float vDepth;
`);const i=t.customFace?F.particle_customFaceVS:F.particle_billboardVS;return t.useCpu?(t.soft>0&&(e+=F.screenDepthPS),e+=F.particle_cpuVS,t.localSpace&&(e+=F.particle_localShiftVS),t.animTex&&(e+=this._animTex(t)),t.alignToMotion&&(e+=F.particle_pointAlongVS),e+=t.mesh?F.particle_meshVS:i,t.normal===1&&(e+=F.particle_normalVS),t.normal===2&&(e+=F.particle_TBNVS),t.stretch>0&&(e+=F.particle_stretchVS),e+=F.particle_cpu_endVS,t.soft>0&&(e+=F.particle_softVS)):(e+=F.particle_initVS,e+=t.pack8?F.particleInputRgba8PS:F.particleInputFloatPS,t.soft>0&&(e+=F.screenDepthPS),e+=F.particleVS,t.localSpace&&(e+=F.particle_localShiftVS),t.animTex&&(e+=this._animTex(t)),t.wrap&&(e+=F.particle_wrapVS),t.alignToMotion&&(e+=F.particle_pointAlongVS),e+=t.mesh?F.particle_meshVS:i,t.normal===1&&(e+=F.particle_normalVS),t.normal===2&&(e+=F.particle_TBNVS),t.stretch>0&&(e+=F.particle_stretchVS),e+=F.particle_endVS,t.soft>0&&(e+=F.particle_softVS)),e+=`}
`,t.normal>0&&(t.normal===1?s+=`
varying vec3 Normal;
`:t.normal===2&&(s+=`
varying mat3 ParticleMat;
`),s+=`
uniform vec3 lightCube[6];
`),t.soft&&(s+=`
varying float vDepth;
`),t.normal===0&&t.fog==="none"&&(t.srgb=!1),s+=Lr(t.gamma),s+=Dr(t.toneMap),t.fog==="linear"?s+=F.fogLinearPS:t.fog==="exp"?s+=F.fogExpPS:t.fog==="exp2"?s+=F.fogExp2PS:s+=F.fogNonePS,t.normal===2&&(s+=`
uniform sampler2D normalMap;
`),t.soft>0&&(s+=F.screenDepthPS),s+=F.particlePS,t.soft>0&&(s+=F.particle_softPS),t.normal===1&&(s+=`
vec3 normal = Normal;
`),t.normal===2&&(s+=F.particle_normalMapPS),t.normal>0&&(s+=t.halflambert?F.particle_halflambertPS:F.particle_lambertPS),t.normal>0&&(s+=F.particle_lightingPS),t.blend===Be?s+=F.particle_blendNormalPS:t.blend===Ta?s+=F.particle_blendAddPS:t.blend===Ca&&(s+=F.particle_blendMultiplyPS),s+=F.particle_endPS,{attributes:go(e),vshader:e,fshader:s}}},bS={generateKey:function(o){return o.type==="cubemap"?`skybox-${o.type}-${o.rgbm}-${o.hdr}-${o.fixSeams}-${o.toneMapping}-${o.gamma}-${o.useIntensity}-${o.mip}`:`skybox-${o.type}-${o.encoding}-${o.useIntensity}-${o.gamma}-${o.toneMapping}`},createShaderDefinition:function(o,t){let e;if(t.type==="cubemap"){const s=[128,64,16,8,4,2];e=di(o),e+=t.mip?F.fixCubemapSeamsStretchPS:F.fixCubemapSeamsNonePS,e+=t.useIntensity?F.envMultiplyPS:F.envConstPS,e+=Lr(t.gamma),e+=Dr(t.toneMapping),e+=F.decodePS,e+=F.rgbmPS,e+=F.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,t.rgbm?"textureCubeRGBM":t.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/s[t.mip]+"")}else{const s={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"};e=di(o),e+=t.useIntensity?F.envMultiplyPS:F.envConstPS,e+=Lr(t.gamma),e+=Dr(t.toneMapping),e+=F.decodePS,e+=F.skyboxEnvPS.replace(/\$DECODE/g,s[t.encoding]||"decodeGamma")}return{attributes:{aPosition:Ot},vshader:F.skyboxVS,fshader:e}}},Zh=1/255,xf=new Float32Array(1),wS=new Int32Array(xf.buffer);class It{static float2Half(t){xf[0]=t;const e=wS[0];let s=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?s:n>142?(s|=31744,s|=(n===255?0:1)&&e&8388607,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=i&1,s)}static float2Bytes(t,e,s,i){const n=255*t%1;if(e[s+0]=Math.round((t%1-Zh*n)*255),i>1){const r=65025*t%1;if(e[s+1]=Math.round((n-Zh*r)*255),i>2){const a=16581375*t%1;e[s+2]=Math.round((r-Zh*a)*255),i>3&&(e[s+3]=Math.round(a*255))}}}static float2BytesRange(t,e,s,i,n,r){t=U.clamp((t-i)/(n-i),0,1),It.float2Bytes(t,e,s,r)}static float2MantissaExponent(t,e,s,i){const n=Math.floor(Math.log2(Math.abs(t)))+1;t/=Math.pow(2,n),It.float2BytesRange(t,e,s,-1,1,i-1),e[s+i-1]=Math.round(n+127)}}let zt=null,ee=null;class nt{constructor(t,e){this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._format=ct,this.type=_e,this.projection=ef,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!1,this._premultiplyAlpha=!1,this._isRenderTarget=!1,this._mipmaps=!0,this._minFilter=Ei,this._magFilter=Yt,this._anisotropy=1,this._addressU=te,this._addressV=te,this._addressW=te,this._compareOnRead=!1,this._compareFunc=Ah,e!==void 0&&(e.name!==void 0&&(this.name=e.name),this._width=e.width!==void 0?e.width:this._width,this._height=e.height!==void 0?e.height:this._height,this._format=e.format!==void 0?e.format:this._format,e.hasOwnProperty("type")?this.type=e.type:e.hasOwnProperty("rgbm")?this.type=e.rgbm?jt:_e:e.hasOwnProperty("swizzleGGGR")&&(this.type=e.swizzleGGGR?un:_e),e.mipmaps!==void 0?this._mipmaps=e.mipmaps:this._mipmaps=e.autoMipmap!==void 0?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._cubemap=e.cubemap!==void 0?e.cubemap:this._cubemap,this.fixCubemapSeams=e.fixCubemapSeams!==void 0?e.fixCubemapSeams:this.fixCubemapSeams,this._cubemap?this.projection=Uh:e.projection&&e.projection!==Uh&&(this.projection=e.projection),this._minFilter=e.minFilter!==void 0?e.minFilter:this._minFilter,this._magFilter=e.magFilter!==void 0?e.magFilter:this._magFilter,this._anisotropy=e.anisotropy!==void 0?e.anisotropy:this._anisotropy,this._addressU=e.addressU!==void 0?e.addressU:this._addressU,this._addressV=e.addressV!==void 0?e.addressV:this._addressV,this._compareOnRead=e.compareOnRead!==void 0?e.compareOnRead:this._compareOnRead,this._compareFunc=e._compareFunc!==void 0?e._compareFunc:this._compareFunc,this._flipY=e.flipY!==void 0?e.flipY:this._flipY,this._premultiplyAlpha=e.premultiplyAlpha!==void 0?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=e.depth!==void 0?e.depth:this._depth,this._volume=e.volume!==void 0?e.volume:this._volume,this._addressW=e.addressW!==void 0?e.addressW:this._addressW)),this._compressed=this._format===dn||this._format===gr||this._format===Li||this._format>=Sr,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0,this.impl=t.createTextureImpl(),t.textures.push(this)}destroy(){if(this.device){const t=this.device,e=t.textures.indexOf(this);e!==-1&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(t,e){t.tex+=e}set minFilter(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}get addressV(){return this._addressV}set addressW(t){!this.device.webgl2||!this._volume||t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16)}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}get anisotropy(){return this._anisotropy}set autoMipmap(t){this._mipmaps=t}get autoMipmap(){return this._mipmaps}set mipmaps(t){this._mipmaps!==t&&(this._mipmaps=t,t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return nt.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get volume(){return this._volume}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return U.powerOfTwo(this._width)&&U.powerOfTwo(this._height)}get encoding(){return this.type===jt?"rgbm":this.type===uo?"rgbe":this.format===ce||this.format===Vt?"linear":"srgb"}static calcGpuSize(t,e,s,i,n,r){zt||(zt=[],zt[Mh]=1,zt[Ph]=1,zt[Ka]=2,zt[Za]=2,zt[Eh]=2,zt[Ja]=2,zt[Ls]=4,zt[ct]=4,zt[yr]=8,zt[ce]=8,zt[xr]=16,zt[Vt]=16,zt[Hu]=4,zt[vr]=4,zt[Qa]=4,zt[to]=4,zt[Rh]=4,zt[Ih]=4),ee||(ee=[],ee[Sr]=8,ee[Lh]=8,ee[br]=8,ee[wr]=8,ee[eo]=8,ee[so]=8,ee[dn]=8,ee[ju]=8,ee[Dh]=16,ee[gr]=16,ee[Li]=16,ee[Xu]=16,ee[qu]=16);const a=zt.hasOwnProperty(i)?zt[i]:0,l=ee.hasOwnProperty(i)?ee[i]:0;let h=0;for(;;){if(a>0)h+=t*e*s*a;else{let c=Math.floor((t+3)/4);const d=Math.floor((e+3)/4),u=Math.floor((s+3)/4);(i===br||i===wr)&&(c=Math.max(Math.floor(c/2),1)),h+=c*d*u*l}if(!n||t===1&&e===1&&s===1)break;t=Math.max(Math.floor(t/2),1),e=Math.max(Math.floor(e/2),1),s=Math.max(Math.floor(s/2),1)}return h*(r?6:1)}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255}lock(t={}){if(t.level===void 0&&(t.level=0),t.face===void 0&&(t.face=0),t.mode===void 0&&(t.mode=My),this._lockedLevel=t.level,this._levels[t.level]===null)switch(this._format){case Mh:case Ph:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case Ka:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case Za:case Eh:case Ja:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case Ls:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case ct:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case dn:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case gr:case Li:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case yr:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case xr:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case ce:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case Vt:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4);break}return this._levels[t.level]}setSource(t,e=0){let s=!1,i,n;if(this._cubemap){if(t[0]){i=t[0].width||0,n=t[0].height||0;for(let r=0;r<6;r++){const a=t[r];if(!a||a.width!==i||a.height!==n||!this.device._isBrowserInterface(a)){s=!0;break}}}else s=!0;if(!s)for(let r=0;r<6;r++)this._levels[e][r]!==t[r]&&(this._levelsUpdated[e][r]=!0)}else this.device._isBrowserInterface(t)||(s=!0),s||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),i=t.width,n=t.height);if(s)if(this._width=4,this._height=4,this._cubemap)for(let r=0;r<6;r++)this._levels[e][r]=null,this._levelsUpdated[e][r]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else e===0&&(this._width=i,this._height=n),this._levels[e]=t;(this._invalid!==s||!s)&&(this._invalid=s,this.upload())}getSource(t=0){return this._levels[t]}unlock(){this._lockedLevel===-1,this.upload(),this._lockedLevel=-1}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps}getDds(){let t=128,e=0;for(;this._levels[e];){if(this.cubemap)for(let v=0;v<6;v++){if(!this._levels[e][v])return;const x=this._levels[e][v].length;if(!x)return;t+=x}else{const v=this._levels[e].length;if(!v)return;t+=v}t+=this._levels[e].length,e++}const s=new ArrayBuffer(t),i=new Uint32Array(s,0,128/4),n=542327876,r=124,a=1|2|4|4096|524288,l=131072,h=32,c=1|64,d=4096,u=4194304,f=8,m=512|1024|2048|4096|8192|16384|32768;let p=a;this._levels.length>1&&(p|=l);let _=d;this._levels.length>1&&(_|=u),(this._levels.length>1||this.cubemap)&&(_|=f);const g=this.cubemap?m:0;i[0]=n,i[1]=r,i[2]=p,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let v=0;v<11;v++)i[8+v]=0;i[19]=h,i[20]=c,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=_,i[28]=g,i[29]=0,i[30]=0,i[31]=0;let w=128;if(this.cubemap)for(let v=0;v<6;v++)for(let x=0;x<this._levels.length;x++){const S=this._levels[x][v],T=new Uint8Array(s,w,S.length);for(let b=0;b<S.length;b++)T[b]=S[b];w+=S.length}else for(let v=0;v<this._levels.length;v++){const x=this._levels[v],S=new Uint8Array(s,w,x.length);for(let T=0;T<x.length;T++)S[T]=x[T];w+=x.length}return s}}const _n=new y,Fr=new y,vf=new y,Sf=new G;class Or{constructor(){this._aspectRatio=16/9,this._aspectRatioMode=bh,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new j(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[xe,fs,ch,lr,ke],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=ys,this._rect=new Z(0,0,1,1),this._renderTarget=null,this._scissorRect=new Z(0,0,1,1),this._scissorRectClear=!1,this._vrDisplay=null,this._projMat=new G,this._projMatDirty=!0,this._projMatSkybox=new G,this._viewMat=new G,this._viewMatDirty=!0,this._viewProjMat=new G,this._viewProjMatDirty=!0,this.frustum=new Th}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatio(){return this._aspectRatio}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(t){this._calculateTransform=t}get calculateTransform(){return this._calculateTransform}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(t){this._clearDepth=t}get clearDepth(){return this._clearDepth}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(t){this._clearStencil=t}get clearStencil(){return this._clearStencil}set clearStencilBuffer(t){this._clearStencilBuffer=t}get clearStencilBuffer(){return this._clearStencilBuffer}set cullingMask(t){this._cullingMask=t}get cullingMask(){return this._cullingMask}set cullFaces(t){this._cullFaces=t}get cullFaces(){return this._cullFaces}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get farClip(){return this._farClip}set flipFaces(t){this._flipFaces=t}get flipFaces(){return this._flipFaces}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get fov(){return this._fov}set frustumCulling(t){this._frustumCulling=t}get frustumCulling(){return this._frustumCulling}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get horizontalFov(){return this._horizontalFov}set layers(t){this._layers=t.slice(0)}get layers(){return this._layers}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get nearClip(){return this._nearClip}set node(t){this._node=t}get node(){return this._node}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(t){this._rect.copy(t)}get rect(){return this._rect}set renderTarget(t){this._renderTarget=t}get renderTarget(){return this._renderTarget}set scissorRect(t){this._scissorRect.copy(t)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}set vrDisplay(t){this._vrDisplay=t,t&&(t._camera=this)}get vrDisplay(){return this._vrDisplay}clone(){return new Or().copy(this)}copy(t){return this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.cullingMask=t.cullingMask,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.vrDisplay=t.vrDisplay,this}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,i=new y){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,i);const n=this._viewProjMat.data,r=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15];return i.x=(i.x/r+1)*.5*e,i.y=(1-i.y/r)*.5*s,i}screenToWorld(t,e,s,i,n,r=new y){const a=this._farClip-this._nearClip;if(_n.set(t/i,(n-e)/n,s/a),_n.mulScalar(2),_n.sub(y.ONE),this._projection===ys){G._getPerspectiveHalfSize(Fr,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),Fr.x*=_n.x,Fr.y*=_n.y;const l=this._node.getWorldTransform();Fr.z=-this._nearClip,l.transformPoint(Fr,vf);const h=this._node.getPosition();r.sub2(vf,h),r.normalize(),r.mulScalar(s),r.add(h)}else this._updateViewProjMat(),Sf.copy(this._viewProjMat).invert(),Sf.transformPoint(_n,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(this._projection===ys)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this._aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getScreenSize(t){if(this._projection===ys){const e=this._node.getPosition().distance(t.center);if(e<t.radius)return 1;const s=Math.asin(t.radius/e),i=Math.tan(s),n=Math.tan(this._fov/2*U.DEG_TO_RAD);return Math.min(i/n,1)}return U.clamp(t.radius/this._orthoHeight,0,1)}}const bf=new G,Jh=new y,wf=new tt,Qh=new tt,Tf=new y,Cf=new y,TS=new G,CS=new tt,Te=new y,Af=new G,Ce=new tt,gn=new tt,Mf=new G,tc=new y,yo=new y;class xt extends at{constructor(t="Untitled"){super();this.name=t,this.tags=new yu(this),this._labels={},this.localPosition=new y,this.localRotation=new tt,this.localScale=new y(1,1,1),this.localEulerAngles=new y,this.position=new y,this.rotation=new tt,this.eulerAngles=new y,this._scale=null,this.localTransform=new G,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new G,this._dirtyWorld=!1,this.normalMatrix=new Qt,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1}get right(){return this._right||(this._right=new y),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new y),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new y),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}set enabled(t){if(this._enabled!==t){var e;this._enabled=t,(t&&(e=this._parent)!=null&&e.enabled||!t)&&this._notifyHierarchyStateChanged(this,t)}}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let i=0,n=s.length;i<n;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],e)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new xt;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}find(t,e){let s,i=[];const n=this._children.length;if(t instanceof Function){const r=t;s=r(this),s&&i.push(this);for(let a=0;a<n;a++){const l=this._children[a].find(r);l.length&&(i=i.concat(l))}}else{let r;this[t]&&(this[t]instanceof Function?r=this[t]():r=this[t],r===e&&i.push(this));for(let a=0;a<n;++a){const l=this._children[a].find(t,e);l.length&&(i=i.concat(l))}}return i}findOne(t,e){const s=this._children.length;let i=null;if(t instanceof Function){const n=t;if(i=n(this),i)return this;for(let r=0;r<s;r++)if(i=this._children[r].findOne(n),i)return i}else{let n;if(this[t]&&(this[t]instanceof Function?n=this[t]():n=this[t],n===e))return this;for(let r=0;r<s;r++)if(i=this._children[r].findOne(t,e),i!==null)return i}return null}findByTag(){const t=arguments,e=[],s=(i,n)=>{n&&i.tags.has(...t)&&e.push(i);for(let r=0;r<i._children.length;r++)s(i._children[r],!0)};return s(this,!1),e}findByName(t){if(this.name===t)return this;for(let e=0;e<this._children.length;e++){const s=this._children[e].findByName(t);if(s!==null)return s}return null}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let i=0,n=e.length;i<n;++i)if(s=s.children.find(r=>r.name===e[i]),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children;for(let i=0;i<s.length;i++)s[i].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new y),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return!this._dirtyLocal&&!this._dirtyWorld?this.worldTransform:(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform)}reparent(t,e){const s=this._parent;s&&s.removeChild(this),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof y?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,i){t instanceof tt?this.localRotation.copy(t):this.localRotation.set(t,e,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof y?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++}setPosition(t,e,s){t instanceof y?Te.copy(t):Te.set(t,e,s),this._parent===null?this.localPosition.copy(Te):(Af.copy(this._parent.getWorldTransform()).invert(),Af.transformPoint(Te,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,i){if(t instanceof tt?Ce.copy(t):Ce.set(t,e,s,i),this._parent===null)this.localRotation.copy(Ce);else{const n=this._parent.getRotation();gn.copy(n).invert(),this.localRotation.copy(gn).mul(Ce)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(this.localRotation.setFromEulerAngles(t,e,s),this._parent!==null){const i=this._parent.getRotation();gn.copy(i).invert(),this.localRotation.mul2(gn,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){if(t._parent!==null)throw new Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation(),i=t._parent;i&&i.removeChild(t),t.setPosition(TS.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(CS.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){if(t._parent!==null)throw new Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.indexOf(t);e!==-1&&(this._children.splice(e,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(t=i.worldTransform.getScale(),Tf.mul2(t,this.localScale),s=Tf))}Qh.setFromMat4(e.worldTransform),wf.mul2(Qh,this.localRotation);let n=e.worldTransform;e.scaleCompensation&&(Cf.mul2(t,e.getLocalScale()),bf.setTRS(e.worldTransform.getTranslation(Jh),Qh,Cf),n=bf),n.transformPoint(this.localPosition,Jh),this.worldTransform.setTRS(Jh,wf,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled||this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,i=0,n=1,r=0){if(t instanceof y)tc.copy(t),e instanceof y?yo.copy(e):yo.copy(y.UP);else{if(s===void 0)return;tc.set(t,e,s),yo.set(i,n,r)}Mf.setLookAt(this.getPosition(),tc,yo),Ce.setFromMat4(Mf),this.setRotation(Ce)}translate(t,e,s){t instanceof y?Te.copy(t):Te.set(t,e,s),Te.add(this.getPosition()),this.setPosition(Te)}translateLocal(t,e,s){t instanceof y?Te.copy(t):Te.set(t,e,s),this.localRotation.transformVector(Te,Te),this.localPosition.add(Te),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(Ce.setFromEulerAngles(t,e,s),this._parent===null)this.localRotation.mul2(Ce,this.localRotation);else{const i=this.getRotation(),n=this._parent.getRotation();gn.copy(n).invert(),Ce.mul2(gn,Ce),this.localRotation.mul2(Ce,i)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){Ce.setFromEulerAngles(t,e,s),this.localRotation.mul(Ce),this._dirtyLocal||this._dirtifyLocal()}}const Pf=new G,Ef=new G,Rf=new G;class ss{static create(t,e,s){const i=new Or;switch(i.node=new xt(t),i.aspectRatio=1,i.aspectRatioMode=wh,i._scissorRectClear=!0,e){case ut:i.node.setRotation(ss.pointLightRotations[s]),i.fov=90,i.projection=ys;break;case _t:i.projection=ys;break;case lt:i.projection=hr;break}return i}static evalSpotCookieMatrix(t){let e=ss._spotCookieCamera;e||(e=ss.create("SpotCookieCamera",_t),ss._spotCookieCamera=e),e.fov=t._outerConeAngle*2;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),Pf.setTRS(s.getPosition(),s.getRotation(),y.ONE).invert(),Ef.mul2(e.projectionMatrix,Pf);const i=t.cookieMatrix,n=t.atlasViewport;return Rf.setViewport(n.x,n.y,n.z,n.w),i.mul2(Rf,Ef),i}}ss.pointLightRotations=[new tt().setFromEulerAngles(0,90,180),new tt().setFromEulerAngles(0,-90,180),new tt().setFromEulerAngles(90,0,0),new tt().setFromEulerAngles(-90,0,0),new tt().setFromEulerAngles(0,180,180),new tt().setFromEulerAngles(0,0,180)];ss._spotCookieCamera=null;const Br=1e-6,se=new y,ki=new Float32Array(6),AS=new y(-.5,0,0),MS=new y(0,0,.5),Ae={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},$t={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class Ct{static initShaderDefines(){const t=Ct.lightTextureFormat===Ct.FORMAT_FLOAT?"FLOAT":"8BIT";Ct.shaderDefines=`
						
#define CLUSTER_TEXTURE_${t}
						${Ct.buildShaderDefines(Ae,"CLUSTER_TEXTURE_8_")}
						${Ct.buildShaderDefines($t,"CLUSTER_TEXTURE_F_")}
				`}static buildShaderDefines(t,e){let s="";return Object.keys(t).forEach(i=>{s+=`
#define ${e}${i} ${t[i]}.5`}),s}static init(t){Ct.lightTextureFormat=t.extTextureFloat&&t.maxTextures>8?Ct.FORMAT_FLOAT:Ct.FORMAT_8BIT,Ct.initShaderDefines()}static createTexture(t,e,s,i,n){return new nt(t,{name:n,width:e,height:s,mipmaps:!1,format:i,addressU:et,addressV:et,type:_e,magFilter:bt,minFilter:bt,anisotropy:1})}constructor(t){this.device=t,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let e=Ae.COUNT_ALWAYS,s=0;Ct.lightTextureFormat===Ct.FORMAT_FLOAT?s=$t.COUNT:e=Ae.COUNT,this.lights8=new Uint8ClampedArray(4*e*this.maxLights),this.lightsTexture8=Ct.createTexture(this.device,e,this.maxLights,ct,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=Ct.createTexture(this.device,s,this.maxLights,Vt,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new y,this.boundsDelta=new y}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}setCompressionRanges(t,e){this.invMaxColorValue=1/e,this.invMaxAttenuation=1/t}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),Ct.lightTextureFormat===Ct.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(AS,se),ki[0]=se.x,ki[1]=se.y,ki[2]=se.z,e.transformVector(MS,se),ki[3]=se.x,ki[4]=se.y,ki[5]=se.z,ki}addLightDataFlags(t,e,s,i,n){t[e+0]=i?255:0,t[e+1]=s._shape*64,t[e+2]=s._falloffMode*255,t[e+3]=n?255:0}addLightDataColor(t,e,s,i,n){const r=this.invMaxColorValue,a=i?s._linearFinalColor:s._finalColor;It.float2Bytes(a[0]*r,t,e+0,2),It.float2Bytes(a[1]*r,t,e+2,2),It.float2Bytes(a[2]*r,t,e+4,2),t[e+6]=n?255:0;const l=!!(s.mask&xs),h=!!(s.mask&Es);t[e+7]=l&&h?127:h?255:0}addLightDataSpotAngles(t,e,s){It.float2Bytes(s._innerConeAngleCos*(.5-Br)+.5,t,e+0,2),It.float2Bytes(s._outerConeAngleCos*(.5-Br)+.5,t,e+2,2)}addLightDataShadowBias(t,e,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);It.float2BytesRange(n.bias,t,e,-1,20,2),It.float2Bytes(n.normalBias,t,e+2,2)}addLightDataPositionRange(t,e,s,i){const n=se.sub2(i,this.boundsMin).div(this.boundsDelta);It.float2Bytes(n.x,t,e+0,4),It.float2Bytes(n.y,t,e+4,4),It.float2Bytes(n.z,t,e+8,4),It.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,t,e+12,4)}addLightDataSpotDirection(t,e,s){this.getSpotDirection(se,s),It.float2Bytes(se.x*(.5-Br)+.5,t,e+0,4),It.float2Bytes(se.y*(.5-Br)+.5,t,e+4,4),It.float2Bytes(se.z*(.5-Br)+.5,t,e+8,4)}addLightDataLightProjMatrix(t,e,s){const i=s.data;for(let n=0;n<12;n++)It.float2BytesRange(i[n],t,e+4*n,-2,2,4);for(let n=12;n<16;n++)It.float2MantissaExponent(i[n],t,e+4*n,4)}addLightDataCookies(t,e,s){const i=s._cookieChannel==="rgb";if(t[e+0]=Math.floor(s.cookieIntensity*255),t[e+1]=i?255:0,!i){const n=s._cookieChannel;t[e+4]=n==="rrr"?255:0,t[e+5]=n==="ggg"?255:0,t[e+6]=n==="bbb"?255:0,t[e+7]=n==="aaa"?255:0}}addLightAtlasViewport(t,e,s){It.float2Bytes(s.x,t,e+0,2),It.float2Bytes(s.y,t,e+2,2),It.float2Bytes(s.z/3,t,e+4,2)}addLightAreaSizes(t,e,s){const i=this.getLightAreaSizes(s);for(let n=0;n<6;n++)It.float2MantissaExponent(i[n],t,e+4*n,4)}addLightData(t,e,s){const i=t._type===_t,n=t.atlasViewportAllocated,r=this.cookiesEnabled&&!!t._cookie&&n,a=this.areaLightsEnabled&&t.shape!==ne,l=this.shadowsEnabled&&t.castShadows&&n,h=t._node.getPosition();let c=null,d=null;i?l?c=t.getRenderData(null,0).shadowMatrix:r&&(c=ss.evalSpotCookieMatrix(t)):(l||r)&&(d=t.atlasViewport);const u=this.lights8,f=e*this.lightsTexture8.width*4;if(this.addLightDataFlags(u,f+4*Ae.FLAGS,t,i,l),this.addLightDataColor(u,f+4*Ae.COLOR_A,t,s,r),i&&this.addLightDataSpotAngles(u,f+4*Ae.SPOT_ANGLES,t),t.castShadows&&this.addLightDataShadowBias(u,f+4*Ae.SHADOW_BIAS,t),r&&this.addLightDataCookies(u,f+4*Ae.COOKIE_A,t),Ct.lightTextureFormat===Ct.FORMAT_FLOAT){const m=this.lightsFloat,p=e*this.lightsTextureFloat.width*4;if(m[p+4*$t.POSITION_RANGE+0]=h.x,m[p+4*$t.POSITION_RANGE+1]=h.y,m[p+4*$t.POSITION_RANGE+2]=h.z,m[p+4*$t.POSITION_RANGE+3]=t.attenuationEnd,i&&(this.getSpotDirection(se,t),m[p+4*$t.SPOT_DIRECTION+0]=se.x,m[p+4*$t.SPOT_DIRECTION+1]=se.y,m[p+4*$t.SPOT_DIRECTION+2]=se.z),c){const _=c.data;for(let g=0;g<16;g++)m[p+4*$t.PROJ_MAT_0+g]=_[g]}if(d&&(m[p+4*$t.ATLAS_VIEWPORT+0]=d.x,m[p+4*$t.ATLAS_VIEWPORT+1]=d.y,m[p+4*$t.ATLAS_VIEWPORT+2]=d.z/3),a){const _=this.getLightAreaSizes(t);m[p+4*$t.AREA_DATA_WIDTH+0]=_[0],m[p+4*$t.AREA_DATA_WIDTH+1]=_[1],m[p+4*$t.AREA_DATA_WIDTH+2]=_[2],m[p+4*$t.AREA_DATA_HEIGHT+0]=_[3],m[p+4*$t.AREA_DATA_HEIGHT+1]=_[4],m[p+4*$t.AREA_DATA_HEIGHT+2]=_[5]}}else this.addLightDataPositionRange(u,f+4*Ae.POSITION_X,t,h),i&&this.addLightDataSpotDirection(u,f+4*Ae.SPOT_DIRECTION_X,t),c&&this.addLightDataLightProjMatrix(u,f+4*Ae.PROJ_MAT_00,c),d&&this.addLightAtlasViewport(u,f+4*Ae.ATLAS_VIEWPORT_A,d),a&&this.addLightAreaSizes(u,f+4*Ae.AREA_DATA_WIDTH_X,t)}}Ct.FORMAT_FLOAT=0;Ct.FORMAT_8BIT=1;Ct.lightTextureFormat=Ct.FORMAT_8BIT;Ct.shaderDefines="";const bs=[],PS={rgbm:"decodeRGBM",rgbe:"decodeRGBE",linear:"decodeLinear"},ec={optionsContext:{},optionsContextMin:{},generateKey:function(o){const t=function(n){const r=[];for(const a in n)n.hasOwnProperty(a)&&a!=="chunks"&&a!=="lights"&&r.push(a);return r.sort()};let e;o===this.optionsContextMin?(this.propsMin||(this.propsMin=t(o)),e=this.propsMin):o===this.optionsContext?(this.props||(this.props=t(o)),e=this.props):e=t(o);let s="standard";for(let i=0;i<e.length;i++)o[e[i]]&&(s+=e[i]+o[e[i]]);if(o.chunks){const i=[];for(const n in o.chunks)o.chunks.hasOwnProperty(n)&&i.push(n+o.chunks[n]);i.sort(),s+=i}if(o.lights){const i=o.clusteredLightingEnabled;for(let n=0;n<o.lights.length;n++){const r=o.lights[n];(!i||r._type===lt)&&(s+=r.key)}}return Er(s)},_correctChannel:function(o,t){if(bs[o]>0){if(bs[o]<t.length)return t.substring(0,bs[o]);if(bs[o]>t.length){let e=t;const s=e.charAt(e.length-1),i=bs[o]-e.length;for(let n=0;n<i;n++)e+=s;return e}return t}},_setMapTransform:function(o,t,e,s){const i=`texture_${t}MapTransform`,n=e+s*100;return o[0]+=`uniform vec3 ${i}0;
`,o[0]+=`uniform vec3 ${i}1;
`,o[3][n]||(o[1]+=`varying vec2 vUV${s}_${e};
`,o[2]+=`	 vUV${s}_${e} = vec2(dot(vec3(uv${s}, 1), ${i}0), dot(vec3(uv${s}, 1), ${i}1));
`,o[3][n]=!0),o},_getUvSourceExpression:function(o,t,e){const s=e[o],i=e[t],n=e.pass===on||e.pass===Qe;let r;return n&&e.nineSlicedMode===Xt||n&&e.nineSlicedMode===Ut?r="nineSlicedUv":(s===0?r="vUv"+i:r="vUV"+i+"_"+s,e.heightMap&&o!=="heightMapTransform"&&(r+=" + dUvOffset")),r},_addMapDef:function(o,t){let e=`
#undef `+o+`
`;return t&&(e+=" #define "+o+`
`),e},_addMapDefs:function(o,t,e,s){let i="";return i+=this._addMapDef("MAPFLOAT",o),i+=this._addMapDef("MAPCOLOR",t),i+=this._addMapDef("MAPVERTEX",e),i+=this._addMapDef("MAPTEXTURE",s),i},_addMap:function(o,t,e,s,i){const n=o+"Map",r=n+"Uv",a=n+"Transform",l=n+"Channel",h=o+"VertexColorChannel",c=o+"Tint",d=o+"VertexColor",u=o+"Mode",f=e[c],m=e[d],p=e[n],_=e[u];let g=s[t];if(p){const x=this._getUvSourceExpression(a,r,e);if(g=g.replace(/\$UV/g,x).replace(/\$CH/g,e[l]),i!==void 0){const S=i===0?"texture2DSRGB":i===1?"texture2DRGBM":"texture2D";g=g.replace(/\$texture2DSAMPLE/g,S)}}m&&(g=g.replace(/\$VC/g,e[h])),_&&(g=g.replace(/\$DETAILMODE/g,_));const w=!!(f&1),v=!!(f&2);return g=this._addMapDefs(w,v,m,p)+g,g.replace(/\$/g,"")},_directionalShadowMapProjection:function(o,t,e,s,i){let n="";return o.numCascades>1&&(n+=`getShadowCascadeMatrix(light${s}_shadowMatrixPalette, light${s}_shadowCascadeDistances, light${s}_shadowCascadeCount);
`,t=`(cascadeShadowMat, ${e});
`),n+=i+t,n+=`fadeShadow(light${s}_shadowCascadeDistances);
`,n},_nonPointShadowMapProjection:function(o,t,e,s,i){const n=`(${e}, ${s});
`;return!t._normalOffsetBias||t._isVsm?t._type===_t?t._isPcf&&(o.webgl2||o.extStandardDerivatives)?"			 getShadowCoordPerspZbuffer"+n:"			 getShadowCoordPersp"+n:this._directionalShadowMapProjection(t,n,s,i,"getShadowCoordOrtho"):t._type===_t?t._isPcf&&(o.webgl2||o.extStandardDerivatives)?"			 getShadowCoordPerspZbufferNormalOffset"+n:"			 getShadowCoordPerspNormalOffset"+n:this._directionalShadowMapProjection(t,n,s,i,"getShadowCoordOrthoNormalOffset")},_addVaryingIfNeeded:function(o,t,e){return o.indexOf(e)>=0?"varying "+t+" "+e+`;
`:""},_getLightSourceShapeString:function(o){switch(o){case Hg:return"Rect";case Xg:return"Disk";case jg:return"Sphere";default:return""}},_getPassDefineString:function(o){return o===fr?`#define PICK_PASS
`:o===ri?`#define DEPTH_PASS
`:o>=ai&&o<=17?`#define SHADOW_PASS
`:""},_vsAddTransformCode:function(o,t,e,s){return o+=e.transformVS,o},_vsAddBaseCode:function(o,t,e,s){return o+=e.baseVS,(s.nineSlicedMode===Xt||s.nineSlicedMode===Ut)&&(o+=e.baseNineSlicedVS),o},_fsAddBaseCode:function(o,t,e,s){return o+=e.basePS,s.nineSlicedMode===Xt?o+=e.baseNineSlicedPS:s.nineSlicedMode===Ut&&(o+=e.baseNineSlicedTiledPS),s.nineSlicedMode===Ut?o+=`const float textureBias = -1000.0;
`:o+=`uniform float textureBias;
`,o},_decodeFunc:function(o){return PS[o]||"decodeGamma"},_fsAddStartCode:function(o,t,e,s){return o+=e.startPS,s.nineSlicedMode===Xt?o+=e.startNineSlicedPS:s.nineSlicedMode===Ut&&(o+=e.startNineSlicedTiledPS),o},_buildShadowPassFragmentCode:function(o,t,e,s,i){const n=s.pass-ai,r=Cu,a=Math.floor(n/r),l=n-a*r;return t.extStandardDerivatives&&!t.webgl2&&(o+=`uniform vec2 polygonOffset;
`),l===ps?t.textureFloatHighPrecision?o+=`#define VSM_EXPONENT 15.0

`:o+=`#define VSM_EXPONENT 5.54

`:l===Ms&&(o+=`#define VSM_EXPONENT 5.54

`),a!==lt&&(o+=`uniform vec3 view_position;
`,o+=`uniform float light_radius;
`),o+=i,s.alphaTest&&(o+="uniform float textureBias;",o+=`float dAlpha;
`,o+=this._addMap("opacity","opacityPS",s,e),o+=e.alphaTestPS),l===Kt&&(!t.webgl2||a===ut)?o+=e.packDepthPS:l===ms&&(o+=`vec2 encodeFloatRG( float v ) {
`,o+=`		vec2 enc = vec2(1.0, 255.0) * v;
`,o+=`		enc = fract(enc);
`,o+=`		enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);
`,o+=`		return enc;
`,o+=`}

`),o+=pn(),s.alphaTest&&(o+=`	 getOpacity();
`,o+=`	 alphaTest(dAlpha);
`),a===ut||(l===ms||l===Ms||l===ps)&&a!==lt?o+=`	 float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);
`:o+=`	 float depth = gl_FragCoord.z;
`,l===Kt&&(!t.webgl2||a===ut&&!s.clusteredLightingEnabled)?(t.extStandardDerivatives&&!t.webgl2&&(o+=`	 float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);
`,o+=`	 depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;
`),o+=`	 gl_FragColor = packFloat(depth);
`):l===Kt||l===_s?(o+=`	 gl_FragColor = vec4(1.0);
`,s.clusteredLightingEnabled&&a===ut&&t.webgl2&&(o+=`	 gl_FragDepth = depth;
`)):l===ms?o+=`	 gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));
`:o+=e.storeEVSMPS,o+=Bi(),o},createShaderDefinition:function(o,t){let e=t.lights.length>0;t.dirLightMap&&(e=!0),t.clusteredLightingEnabled&&(e=!0),t.shadingModel===Pi?(t.fresnelModel=0,t.specularAntialias=!1,t.ambientSH=!1):t.fresnelModel=t.fresnelModel===0?hh:t.fresnelModel;const s=!!t.reflectionSource;t.useSpecular||(t.specularMap=t.glossMap=null);const i=t.pass>=ai&&t.pass<=17,n=e||s||t.ambientSH||t.heightMap||t.enableGGXSpecular||t.clusteredLightingEnabled&&!i||t.clearCoatNormalMap;this.options=t;let r="",a="",l="",h=F,c,d;const u={vertex_position:Ot};if(t.chunks){const P={};for(const B in h)h.hasOwnProperty(B)&&(t.chunks[B]?(d=t.chunks[B],d.indexOf("vertex_normal")>=0&&(u.vertex_normal=pe),d.indexOf("vertex_tangent")>=0&&(u.vertex_tangent=vs),d.indexOf("vertex_texCoord0")>=0&&(u.vertex_texCoord0=be),d.indexOf("vertex_texCoord1")>=0&&(u.vertex_texCoord1=hi),d.indexOf("vertex_color")>=0&&(u.vertex_color=de),d.indexOf("vertex_boneWeights")>=0&&(u.vertex_boneWeights=Ss),d.indexOf("vertex_boneIndices")>=0&&(u.vertex_boneIndices=Se),P[B]=d):P[B]=h[B]);h=P}r+=this._getPassDefineString(t.pass),r=this._vsAddBaseCode(r,o,h,t),a+=`	 vPositionW		= getWorldPosition();
`,t.pass===ri&&(r+=`varying float vDepth;
`,r+=`#ifndef VIEWMATRIX
`,r+=`#define VIEWMATRIX
`,r+=`uniform mat4 matrix_view;
`,r+=`#endif
`,r+=`#ifndef CAMERAPLANES
`,r+=`#define CAMERAPLANES
`,r+=`uniform vec4 camera_params;

`,r+=`#endif
`,a+=`		vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;
`),t.useInstancing&&(u.instance_line1=Ar,u.instance_line2=Mr,u.instance_line3=Pr,u.instance_line4=Fi,r+=h.instancingVS),n&&(u.vertex_normal=pe,a+=`	 vNormalW = getNormal();
`,t.reflectionSource==="sphereMap"&&o.fragmentUniformsCount<=16&&(r+=h.viewNormalVS,a+=`	 vNormalV		= getViewNormal();
`),(t.heightMap||t.normalMap||t.enableGGXSpecular)&&t.hasTangents?(u.vertex_tangent=vs,r+=h.tangentBinormalVS,a+=`	 vTangentW	 = getTangent();
`,a+=`	 vBinormalW	= getBinormal();
`):t.enableGGXSpecular&&(r+=h.tangentBinormalVS,a+=`	 vObjectSpaceUpW	= getObjectSpaceUp();
`));const f=[],m=[],p=2;for(const P in bs){const B=P+"Map";if(t[P+"VertexColor"]){const Y=P+"VertexColorChannel";t[Y]=this._correctChannel(P,t[Y])}if(t[B]){const Y=B+"Channel",it=B+"Transform",Tt=B+"Uv";t[Tt]=Math.min(t[Tt],p-1),t[Y]=this._correctChannel(P,t[Y]);const $=t[Tt];f[$]=!0,m[$]=m[$]||t[B]&&!t[it]}}t.forceUv1&&(f[1]=!0,m[1]=m[1]!==void 0?m[1]:!0);for(let P=0;P<p;P++)f[P]&&(u["vertex_texCoord"+P]="TEXCOORD"+P,r+=h["uv"+P+"VS"],a+="	 vec2 uv"+P+" = getUv"+P+`();
`),m[P]&&(a+="	 vUv"+P+" = uv"+P+`;
`);const _=[r,l,a,[]];for(const P in bs){const B=P+"Map";if(t[B]){const Y=B+"Transform";if(t[Y]){const it=B+"Uv";this._setMapTransform(_,P,t[Y],t[it])}}}r=_[0],l=_[1],a=_[2],t.vertexColors&&(u.vertex_color=de,a+=`	 vVertexColor = vertex_color;
`),(t.useMorphPosition||t.useMorphNormal)&&(t.useMorphTextureBased?(r+=`#define MORPHING_TEXTURE_BASED
`,t.useMorphPosition&&(r+=`#define MORPHING_TEXTURE_BASED_POSITION
`),t.useMorphNormal&&(r+=`#define MORPHING_TEXTURE_BASED_NORMAL
`),u.morph_vertex_id=Fi,r+=`attribute float morph_vertex_id;
`):(r+=`#define MORPHING
`,t.useMorphPosition?(u.morph_pos0=Oh,u.morph_pos1=Bh,u.morph_pos2=kh,u.morph_pos3=zh,r+=`#define MORPHING_POS03
`,r+=`attribute vec3 morph_pos0;
`,r+=`attribute vec3 morph_pos1;
`,r+=`attribute vec3 morph_pos2;
`,r+=`attribute vec3 morph_pos3;
`):t.useMorphNormal&&(u.morph_nrm0=Oh,u.morph_nrm1=Bh,u.morph_nrm2=kh,u.morph_nrm3=zh,r+=`#define MORPHING_NRM03
`,r+=`attribute vec3 morph_nrm0;
`,r+=`attribute vec3 morph_nrm1;
`,r+=`attribute vec3 morph_nrm2;
`,r+=`attribute vec3 morph_nrm3;
`),t.useMorphNormal?(u.morph_nrm4=Ar,u.morph_nrm5=Mr,u.morph_nrm6=Pr,u.morph_nrm7=Fi,r+=`#define MORPHING_NRM47
`,r+=`attribute vec3 morph_nrm4;
`,r+=`attribute vec3 morph_nrm5;
`,r+=`attribute vec3 morph_nrm6;
`,r+=`attribute vec3 morph_nrm7;
`):(u.morph_pos4=Ar,u.morph_pos5=Mr,u.morph_pos6=Pr,u.morph_pos7=Fi,r+=`#define MORPHING_POS47
`,r+=`attribute vec3 morph_pos4;
`,r+=`attribute vec3 morph_pos5;
`,r+=`attribute vec3 morph_pos6;
`,r+=`attribute vec3 morph_pos7;
`))),t.skin?(u.vertex_boneWeights=Ss,u.vertex_boneIndices=Se,r+=Kh(o,h),r+=`#define SKIN
`):t.useInstancing&&(r+=`#define INSTANCING
`),t.screenSpace&&(r+=`#define SCREENSPACE
`),t.pixelSnap&&(r+=`#define PIXELSNAP
`),r=this._vsAddTransformCode(r,o,h,t),n&&(r+=h.normalVS),r+=`
`,r+=h.startVS,r+=a,r+=h.endVS,r+="}";let g=r;const w=l;l="",l+=this._addVaryingIfNeeded(r,"vec4","vVertexColor"),l+=this._addVaryingIfNeeded(r,"vec3","vPositionW"),l+=this._addVaryingIfNeeded(r,"vec3","vNormalV"),l+=this._addVaryingIfNeeded(r,"vec3","vNormalW"),l+=this._addVaryingIfNeeded(r,"vec3","vTangentW"),l+=this._addVaryingIfNeeded(r,"vec3","vBinormalW"),l+=this._addVaryingIfNeeded(r,"vec3","vObjectSpaceUpW"),l+=this._addVaryingIfNeeded(r,"vec2","vUv0"),l+=this._addVaryingIfNeeded(r,"vec2","vUv1"),l+=w,g=l+g;let v="";o.webgl2?(v=Oi(o),h.extensionVS&&(v+=h.extensionVS+`
`),g=v+h.gles3VS+g):(h.extensionVS&&(v=h.extensionVS+`
`),g=v+g),t.forceFragmentPrecision&&t.forceFragmentPrecision!=="highp"&&t.forceFragmentPrecision!=="mediump"&&t.forceFragmentPrecision!=="lowp"&&(t.forceFragmentPrecision=null),t.forceFragmentPrecision&&(t.forceFragmentPrecision==="highp"&&o.maxPrecision!=="highp"&&(t.forceFragmentPrecision="mediump"),t.forceFragmentPrecision==="mediump"&&o.maxPrecision==="lowp"&&(t.forceFragmentPrecision="lowp"));let x;if(r="",o.webgl2&&(r+=Oi(o)),o.webgl2||(o.extStandardDerivatives&&(r+=`#extension GL_OES_standard_derivatives : enable
`),o.extTextureLod&&(r+=`#extension GL_EXT_shader_texture_lod : enable
`,r+=`#define SUPPORTS_TEXLOD
`)),h.extensionPS&&(r+=h.extensionPS+`
`),o.webgl2&&(r+=h.gles3PS),r+=t.forceFragmentPrecision?"precision "+t.forceFragmentPrecision+` float;

`:di(o),r+=this._getPassDefineString(t.pass),t.pass===fr)return r+=`uniform vec4 uColor;
`,r+=l,t.alphaTest&&(r+="uniform float textureBias;",r+=`float dAlpha;
`,r+=this._addMap("opacity","opacityPS",t,h),r+=h.alphaTestPS),r+=pn(),t.alphaTest&&(r+=`	 getOpacity();
`,r+=`	 alphaTest(dAlpha);
`),r+=`		gl_FragColor = uColor;
`,r+=Bi(),{attributes:u,vshader:g,fshader:r};if(t.pass===ri)return r+=`varying float vDepth;
`,r+=l,r+=h.packDepthPS,t.alphaTest&&(r+="uniform float textureBias;",r+=`float dAlpha;
`,r+=this._addMap("opacity","opacityPS",t,h),r+=h.alphaTestPS),r+=pn(),t.alphaTest&&(r+=`	 getOpacity();
`,r+=`	 alphaTest(dAlpha);
`),r+=`		gl_FragColor = packFloat(vDepth);
`,r+=Bi(),{attributes:u,vshader:g,fshader:r};if(i)return{attributes:u,vshader:g,fshader:this._buildShadowPassFragmentCode(r,o,h,t,l)};if(t.customFragmentShader)return x=r+t.customFragmentShader,{attributes:u,vshader:g,fshader:x,tag:tf};r+=l,r=this._fsAddBaseCode(r,o,h,t),t.detailModes&&(r+=h.detailModesPS);const S=r;r="",t.clearCoat>0&&(r+=`#define CLEARCOAT
`,r+=`#define CLUSTER_CLEAR_COAT
`),t.opacityFadesSpecular===!1&&(r+=`uniform float material_alphaFade;
`);let T=0;const b=[];let C=!1,M=!1,E=!1,D=t.lights.some(function(P){return P._shape&&P._shape!==ne});t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(D=!0),o.areaLightLutFormat===ct?(r+=`#define AREA_R8_G8_B8_A8_LUTS
`,r+=`#define AREA_LUTS_PRECISION lowp
`):r+=`#define AREA_LUTS_PRECISION highp
`,(D||t.clusteredLightingEnabled)&&(r+=`#define AREA_LIGHTS
`,r+=`uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex1;
`,r+=`uniform AREA_LUTS_PRECISION sampler2D areaLightsLutTex2;
`);for(let P=0;P<t.lights.length;P++){const B=t.lights[P],Y=B._type;if(t.clusteredLightingEnabled&&Y!==lt)continue;const it=D&&B._shape?B._shape:ne;r+="uniform vec3 light"+P+`_color;
`,Y===lt?r+="uniform vec3 light"+P+`_direction;
`:(r+="uniform vec3 light"+P+`_position;
`,r+="uniform float light"+P+`_radius;
`,Y===_t&&(r+="uniform vec3 light"+P+`_direction;
`,r+="uniform float light"+P+`_innerConeAngle;
`,r+="uniform float light"+P+`_outerConeAngle;
`)),it!==ne&&(Y===lt&&(r+="uniform vec3 light"+P+`_position;
`),r+="uniform vec3 light"+P+`_halfWidth;
`,r+="uniform vec3 light"+P+`_halfHeight;
`),B.castShadows&&!t.noShadow&&(r+="uniform mat4 light"+P+`_shadowMatrix;
`,Y===lt&&(r+="uniform mat4 light"+P+`_shadowMatrixPalette[4];
`,r+="uniform float light"+P+`_shadowCascadeDistances[4];
`,r+="uniform float light"+P+`_shadowCascadeCount;
`),Y!==lt?r+="uniform vec4 light"+P+`_shadowParams;
`:(C=!0,r+="uniform vec3 light"+P+`_shadowParams;
`),Y===ut?r+="uniform samplerCube light"+P+`_shadowMap;
`:B._isPcf&&o.webgl2?r+="uniform sampler2DShadow light"+P+`_shadowMap;
`:r+="uniform sampler2D light"+P+`_shadowMap;
`,T++,b[B._shadowType]=!0,B._isVsm&&(M=!0),B._isPcf&&(o.webgl2||o.extStandardDerivatives)&&Y===_t&&(E=!0)),B._cookie&&(B._cookie._cubemap?Y===ut&&(r+="uniform samplerCube light"+P+`_cookie;
`,r+="uniform float light"+P+`_cookieIntensity;
`,(!B.castShadows||t.noShadow)&&(r+="uniform mat4 light"+P+`_shadowMatrix;
`)):Y===_t&&(r+="uniform sampler2D light"+P+`_cookie;
`,r+="uniform float light"+P+`_cookieIntensity;
`,(!B.castShadows||t.noShadow)&&(r+="uniform mat4 light"+P+`_shadowMatrix;
`),B._cookieTransform&&(r+="uniform vec4 light"+P+`_cookieMatrix;
`,r+="uniform vec2 light"+P+`_cookieOffset;
`)))}r+=`
`;let I;if(!t.hasTangents&&o.extStandardDerivatives?I=h.TBNderivativePS:t.fastTbn?I=h.TBNfastPS:I=h.TBNPS,n)if(t.normalMap||t.clearCoatNormalMap){if(r+=t.packedNormal?h.normalXYPS:h.normalXYZPS,!t.hasTangents){const P=t.normalMap?"normalMap":"clearCoatNormalMap",B=this._getUvSourceExpression(`${P}Transform`,`${P}Uv`,t);I=I.replace(/\$UV/g,B)}r+=I}else t.enableGGXSpecular&&!t.heightMap&&(r+=h.normalVertexPS,r+=h.TBNObjectSpacePS);if(n)if(t.normalMap){t.normalDetail&&(r+=this._addMap("normalDetail","normalDetailMapPS",t,h));const P=this._getUvSourceExpression("normalMapTransform","normalMapUv",t);t.normalizeNormalMap?r+=h.normalMapPS.replace(/\$UV/g,P):r+=h.normalMapFastPS.replace(/\$UV/g,P)}else t.enableGGXSpecular&&!t.heightMap||(r+=h.normalVertexPS);if(r+=Lr(t.gamma,h),r+=Dr(t.toneMap,h),r+=$h(t.fog,h),r+=h.decodePS,t.useRgbm&&(r+=h.rgbmPS),t.useCubeMapRotation&&(r+=`#define CUBEMAP_ROTATION
`),n&&(r+=h.cubeMapRotatePS,r+=t.cubeMapProjection>0?h.cubeMapProjectBoxPS:h.cubeMapProjectNonePS,r+=t.skyboxIntensity?h.envMultiplyPS:h.envConstPS),t.diffuseDetail&&(r+=this._addMap("diffuseDetail","diffuseDetailMapPS",t,h)),r+=this._addMap("diffuse","diffusePS",t,h),(t.blendType!==he||t.alphaTest||t.alphaToCoverage)&&(r+=this._addMap("opacity","opacityPS",t,h)),r+=this._addMap("emissive","emissivePS",t,h,t.emissiveFormat),e&&t.useSpecular||s){t.specularAntialias&&t.normalMap?t.normalizeNormalMap&&n?r+=h.specularAaToksvigPS:r+=h.specularAaToksvigFastPS:r+=h.specularAaNonePS;const P=t.useMetalness?"metalness":"specular";r+=this._addMap(P,P+"PS",t,h),r+=this._addMap("gloss","glossPS",t,h),t.fresnelModel===hh&&(r+=h.fresnelSchlickPS)}if(t.clearCoat>0&&(r+=this._addMap("clearCoat","clearCoatPS",t,h),r+=this._addMap("clearCoatGloss","clearCoatGlossPS",t,h),r+=this._addMap("clearCoatNormal","clearCoatNormalPS",t,h)),t.heightMap){if(!t.normalMap){const P=this._getUvSourceExpression("heightMapTransform","heightMapUv",t);t.hasTangents||(I=I.replace(/\$UV/g,P)),r+=I}r+=this._addMap("height","parallaxPS",t,h)}const k=t.aoMap||t.aoVertexColor;k&&(r+=this._addMap("ao","aoPS",t,h),r+=h.aoDiffuseOccPS,t.occludeSpecular&&(t.occludeSpecular===ph?r+=t.occludeSpecularFloat?h.aoSpecOccSimplePS:h.aoSpecOccConstSimplePS:r+=t.occludeSpecularFloat?h.aoSpecOccPS:h.aoSpecOccConstPS)),t.reflectionSource==="envAtlas"?r+=h.reflectionEnvPS.replace(/\$DECODE/g,this._decodeFunc(t.reflectionEncoding)):t.reflectionSource==="cubeMap"?(r+=t.fixSeams?h.fixCubemapSeamsStretchPS:h.fixCubemapSeamsNonePS,r+=h.reflectionCubePS.replace(/\$DECODE/g,this._decodeFunc(t.reflectionEncoding))):t.reflectionSource==="sphereMap"&&(r+=(o.fragmentUniformsCount>16?h.reflectionSpherePS:h.reflectionSphereLowPS).replace(/\$DECODE/g,this._decodeFunc(t.reflectionEncoding))),s&&(t.clearCoat>0&&(r+=h.reflectionCCPS),t.refraction&&(r+=h.refractionPS)),t.clusteredLightingEnabled&&(r+=h.clusteredLightUtilsPS,r+=h.clusteredLightCookiesPS,b[Kt]=!0,b[_s]=!0,E=!0),(T>0||t.clusteredLightingEnabled)&&(C&&(r+=h.shadowCascadesPS),b[Kt]&&(r+=h.shadowStandardPS),b[_s]&&o.webgl2&&(r+=h.shadowStandardGL2PS),M&&(r+=h.shadowVSM_commonPS,b[ms]&&(r+=h.shadowVSM8PS),b[Ms]&&(r+=o.extTextureHalfFloatLinear?h.shadowEVSMPS.replace(/\$/g,"16"):h.shadowEVSMnPS.replace(/\$/g,"16")),b[ps]&&(r+=o.extTextureFloatLinear?h.shadowEVSMPS.replace(/\$/g,"32"):h.shadowEVSMnPS.replace(/\$/g,"32"))),o.webgl2||o.extStandardDerivatives||(r+=h.biasConstPS),r+=h.shadowCoordPS+h.shadowCommonPS,E&&(r+=h.shadowCoordPerspZbufferPS)),t.enableGGXSpecular&&(r+=`uniform float material_anisotropy;
`),e&&(r+=h.lightDiffuseLambertPS,(D||t.clusteredLightingEnabled)&&(r+=h.ltc)),r+=`
`;let N=!1;t.useSpecular?(r+=`#define CLUSTER_SPECULAR
`,t.conserveEnergy&&(r+=`#define CLUSTER_CONSERVE_ENERGY
`),e&&(r+=t.shadingModel===Pi?h.lightSpecularPhongPS:t.enableGGXSpecular?h.lightSpecularAnisoGGXPS:h.lightSpecularBlinnPS),t.fresnelModel>0?t.conserveEnergy&&!D?r+=h.combineDiffuseSpecularPS:r+=h.combineDiffuseSpecularNoConservePS:s?r+=h.combineDiffuseSpecularOldPS:t.diffuseMap?r+=h.combineDiffuseSpecularNoReflPS:(r+=h.combineDiffuseSpecularNoReflSeparateAmbientPS,N=!0)):r+=h.combineDiffusePS,t.clearCoat>0&&(r+=h.combineClearCoatPS);let X=!0;if(t.lightMap||t.lightVertexColor){const P=t.dirLightMap&&t.useSpecular?"lightmapDirPS":"lightmapSinglePS";r+=this._addMap("light",P,t,h,t.lightMapFormat),X=t.lightMapWithoutAmbient}X&&(t.ambientSource==="ambientSH"?r+=h.ambientSHPS:t.ambientSource==="envAtlas"?r+=h.ambientEnvPS.replace(/\$DECODE/g,this._decodeFunc(t.ambientEncoding)):r+=h.ambientConstantPS),t.ambientTint&&!N&&(r+=`uniform vec3 material_ambient;
`),t.alphaTest&&(r+=h.alphaTestPS),t.msdf&&(r+=h.msdfPS),n&&(r+=h.viewDirPS,t.useSpecular&&(r+=t.enableGGXSpecular?h.reflDirAnisoPS:h.reflDirPS));let q=!1,A=!1,R=!1,L=!1,O=!1,z;t.clusteredLightingEnabled&&e&&(L=!0,q=!0,A=!0,O=!0,r+=h.floatUnpackingPS,t.lightMaskDynamic&&(r+=`
#define CLUSTER_MESH_DYNAMIC_LIGHTS`),t.clusteredLightingCookiesEnabled&&(r+=`
#define CLUSTER_COOKIES`),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(r+=`
#define CLUSTER_SHADOWS`,r+=`
#define CLUSTER_SHADOW_TYPE_`+Ai[t.clusteredLightingShadowType]),t.clusteredLightingAreaLightsEnabled&&(r+=`
#define CLUSTER_AREALIGHTS`),r+=Ct.shaderDefines,r+=h.clusteredLightShadowsPS,r+=h.clusteredLightPS),t.twoSidedLighting&&(r+=`uniform float twoSidedLightingNegScaleFactor;
`),r=this._fsAddStartCode(r,o,h,t),n&&(!t.hasTangents&&o.extStandardDerivatives&&!t.fastTbn?t.twoSidedLighting?r+=`	 dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);
`:r+=`	 dVertexNormalW = normalize(vNormalW);
`:t.twoSidedLighting?r+=`	 dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;
`:r+=`	 dVertexNormalW = vNormalW;
`,(t.heightMap||t.normalMap)&&t.hasTangents&&(t.twoSidedLighting?(r+=`	 dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;
`,r+=`	 dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;
`):(r+=`	 dTangentW = vTangentW;
`,r+=`	 dBinormalW = vBinormalW;
`)));let W=!1;t.blendType===he&&!t.alphaTest&&!t.alphaToCoverage?r+=`	 dAlpha = 1.0;
`:t.heightMap&&t.opacityMap?W=!0:(r+=`	 getOpacity();
`,t.alphaTest&&(r+=`	 alphaTest(dAlpha);
`));let K=!1;if(n&&(r+=`	 getViewDir();
`,(t.heightMap||t.normalMap||t.clearCoatNormalMap||t.enableGGXSpecular)&&(r+=`	 getTBN();
`),t.heightMap&&(r+=`	 getParallax();
`),W&&(r+=`	 getOpacity();
`,t.alphaTest&&(r+=`	 alphaTest(dAlpha);
`)),r+=`	 getNormal();
`,t.useSpecular&&(e&&t.enableGGXSpecular&&(r+=`	 getGlossiness();
`,K=!0),r+=`	 getReflDir();
`)),r+=`	 getAlbedo();
`,t.clearCoat>0&&(r+=`	 getClearCoat();
`,r+=`	 getClearCoatGlossiness();
`,r+=`	 getClearCoatNormal();
`),(e&&t.useSpecular||s)&&(r+=`	 getSpecularity();
`,K||(r+=`	 getGlossiness();
`),D&&(r+=`	 #ifdef AREA_LIGHTS
`,r+=`	 dSpecularityNoFres = dSpecularity;
`,r+=`	 #ifdef CLEARCOAT
`,r+=`	 ccSpecularityNoFres = ccSpecularity;
`,r+=`	 #endif
`,r+=`	 #endif
`),t.fresnelModel>0&&(r+=`	 getFresnel();
`)),k&&(r+=`	getAO();
`),X&&(r+=`	 addAmbient();
`,t.separateAmbient&&(r+=`
										vec3 dAmbientLight = dDiffuseLight;
										dDiffuseLight = vec3(0);
								`)),t.ambientTint&&!N&&(r+=`	 dDiffuseLight *= material_ambient;
`),k&&!t.occludeDirect&&(r+=`		occludeDiffuse();
`),(t.lightMap||t.lightVertexColor)&&(r+=`	 addLightMap();
`),e||s){s&&(t.clearCoat>0&&(r+=`	 addReflectionCC();
`),r+=`	 addReflection();
`),D&&(r+=`	 ccReflection.rgb *= ccSpecularity;
`,r+=`	 dReflection.rgb *= dSpecularity;
`,r+=`	 dSpecularLight *= dSpecularity;
`,r+=`	 float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);
`,r+=`	 calcLTCLightValues();
`);for(let P=0;P<t.lights.length;P++){const B=t.lights[P],Y=B._type;if(t.clusteredLightingEnabled&&Y!==lt)continue;z=!1;const it=D&&B._shape?B.shape:ne,Tt=D&&B._shape?this._getLightSourceShapeString(it):"";if(it!==ne&&(r+="	 calc"+Tt+"LightValues(light"+P+"_position, light"+P+"_halfWidth, light"+P+`_halfHeight);
`),Y===lt?(r+="	 dLightDirNormW = light"+P+`_direction;
`,r+=`	 dAtten = 1.0;
`):(B._cookie&&(Y===_t&&!B._cookie._cubemap||Y===ut&&B._cookie._cubemap)&&(O=!0,z=!0),r+="	 getLightDirPoint(light"+P+`_position);
`,q=!0,z&&(Y===_t?r+="	 dAtten3 = getCookie2D"+(B._cookieFalloff?"":"Clip")+(B._cookieTransform?"Xform":"")+"(light"+P+"_cookie, light"+P+"_shadowMatrix, light"+P+"_cookieIntensity"+(B._cookieTransform?", light"+P+"_cookieMatrix, light"+P+"_cookieOffset":"")+")."+B._cookieChannel+`;
`:r+="	 dAtten3 = getCookieCube(light"+P+"_cookie, light"+P+"_shadowMatrix, light"+P+"_cookieIntensity)."+B._cookieChannel+`;
`),it===ne?B._falloffMode===dh?(r+="	 dAtten = getFalloffLinear(light"+P+`_radius);
`,A=!0):(r+="	 dAtten = getFalloffInvSquared(light"+P+`_radius);
`,R=!0):(r+="	 dAtten = getFalloffWindow(light"+P+`_radius);
`,R=!0),r+=`	 if (dAtten > 0.00001) {
`,Y===_t&&(z&&!B._cookieFalloff||(r+="			 dAtten *= getSpotEffect(light"+P+"_direction, light"+P+"_innerConeAngle, light"+P+`_outerConeAngle);
`,L=!0))),it!==ne?Y===lt?r+=`			 dAttenD = getLightDiffuse();
`:r+="			 dAttenD = get"+Tt+`LightDiffuse() * 16.0;
`:r+=`			 dAtten *= getLightDiffuse();
`,B.castShadows&&!t.noShadow){let $=null,kt;if(B._shadowType===ms?($="VSM8",kt="0.0"):B._shadowType===Ms?($="VSM16",kt="5.54"):B._shadowType===ps?($="VSM32",o.textureFloatHighPrecision?kt="15.0":kt="5.54"):B._shadowType===_s?$="PCF5x5":$="PCF3x3",$!==null)if(Y===ut)c="(light"+P+"_shadowMap, light"+P+`_shadowParams);
`,B._normalOffsetBias&&(r+="			 normalOffsetPointShadow(light"+P+`_shadowParams);
`),r+="			 dAtten *= getShadowPoint"+$+c;else{const Oe=`light${P}_shadowMatrix`,er=`light${P}_shadowParams`;r+=this._nonPointShadowMapProjection(o,t.lights[P],Oe,er,P),Y===_t&&($="Spot"+$),r+="			 dAtten *= getShadow"+$+"(light"+P+"_shadowMap, light"+P+"_shadowParams"+(B._isVsm?", "+kt:"")+`);
`}}it!==ne?t.conserveEnergy&&t.useSpecular?r+="			 dDiffuseLight += mix((dAttenD * dAtten) * light"+P+"_color"+(z?" * dAtten3":"")+`, vec3(0), dLTCSpecFres);
`:r+="			 dDiffuseLight += (dAttenD * dAtten) * light"+P+"_color"+(z?" * dAtten3":"")+`;
`:D&&t.conserveEnergy&&t.useSpecular?r+="			 dDiffuseLight += mix(dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`, vec3(0), dSpecularity);
`:r+="			 dDiffuseLight += dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`,it!==ne?(t.clearCoat>0&&(r+="			 ccSpecularLight += ccLTCSpecFres * get"+Tt+"LightSpecularCC() * dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`),t.useSpecular&&(r+="			 dSpecularLight += dLTCSpecFres * get"+Tt+"LightSpecular() * dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`)):D?(t.clearCoat>0&&(r+="			 ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`),t.useSpecular&&(r+="			 dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`)):(t.clearCoat>0&&(r+="			 ccSpecularLight += getLightSpecularCC() * dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`),t.useSpecular&&(r+="			 dSpecularLight += getLightSpecular() * dAtten * light"+P+"_color"+(z?" * dAtten3":"")+`;
`)),Y!==lt&&(r+=`	 }
`),r+=`
`}t.clusteredLightingEnabled&&e&&(A=!0,R=!0,q=!0,r+=`	 addClusteredLights();
`),D&&(t.clearCoat>0&&(r+=`	 ccSpecularity = 1.0;
`),t.useSpecular&&(r+=`	 dSpecularity = vec3(1);
`)),s&&t.refraction&&(r+=`	 addRefraction();
`)}r+=`
`,k&&(t.occludeDirect&&(r+=`		occludeDiffuse();
`),t.occludeSpecular&&(r+=`		occludeSpecular();
`)),t.opacityFadesSpecular===!1&&((t.blendType===Be||t.blendType===Je)&&(r+=`float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));
`,r+=`#ifdef CLEARCOAT
 specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));
#endif
`,r+=`dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);
`),r+=`dAlpha *= material_alphaFade;
`),r+=h.endPS,t.blendType===Be||t.blendType===Aa||t.alphaToCoverage?r+=h.outputAlphaPS:t.blendType===Je?r+=h.outputAlphaPremulPS:r+=h.outputAlphaOpaquePS,t.msdf&&(r+=`	 gl_FragColor = applyMsdf(gl_FragColor);
`),r+=`
`,r+=Bi(),q&&(r=h.lightDirPointPS+r),A&&(r=h.falloffLinearPS+r),R&&(r=h.falloffInvSquaredPS+r),L&&(r=h.spotPS+r),O&&(r=h.cookiePS+r);let V="";return r.includes("dReflection")&&(V+=`vec4 dReflection;
`),r.includes("dTBN")&&(V+=`mat3 dTBN;
`),r.includes("dAlbedo")&&(V+=`vec3 dAlbedo;
`),r.includes("dEmission")&&(V+=`vec3 dEmission;
`),r.includes("dNormalW")&&(V+=`vec3 dNormalW;
`),r.includes("dVertexNormalW")&&(V+=`vec3 dVertexNormalW;
`),r.includes("dTangentW")&&(V+=`vec3 dTangentW;
`),r.includes("dBinormalW")&&(V+=`vec3 dBinormalW;
`),r.includes("dViewDirW")&&(V+=`vec3 dViewDirW;
`),r.includes("dReflDirW")&&(V+=`vec3 dReflDirW;
`),r.includes("dDiffuseLight")&&(V+=`vec3 dDiffuseLight;
`),r.includes("dSpecularLight")&&(V+=`vec3 dSpecularLight;
`),r.includes("dLightDirNormW")&&(V+=`vec3 dLightDirNormW;
`),r.includes("dLightDirW")&&(V+=`vec3 dLightDirW;
`),r.includes("dLightPosW")&&(V+=`vec3 dLightPosW;
`),r.includes("dShadowCoord")&&(V+=`vec3 dShadowCoord;
`),r.includes("dNormalMap")&&(V+=`vec3 dNormalMap;
`),r.includes("dSpecularity")&&(V+=`vec3 dSpecularity;
`),r.includes("dSpecularityNoFres")&&(V+=`vec3 dSpecularityNoFres;
`),r.includes("dUvOffset")&&(V+=`vec2 dUvOffset;
`),r.includes("dGlossiness")&&(V+=`float dGlossiness;
`),r.includes("dAlpha")&&(V+=`float dAlpha;
`),r.includes("dAtten")&&(V+=`float dAtten;
`),r.includes("dAttenD")&&(V+=`float dAttenD;
`),r.includes("dAtten3")&&(V+=`vec3 dAtten3;
`),r.includes("dAo")&&(V+=`float dAo;
`),r.includes("dMsdf")&&(V+=`vec4 dMsdf;
`),r.includes("ccReflection")&&(V+=`vec4 ccReflection;
`),r.includes("ccNormalW")&&(V+=`vec3 ccNormalW;
`),r.includes("ccReflDirW")&&(V+=`vec3 ccReflDirW;
`),r.includes("ccSpecularLight")&&(V+=`vec3 ccSpecularLight;
`),r.includes("ccSpecularity")&&(V+=`float ccSpecularity;
`),r.includes("ccSpecularityNoFres")&&(V+=`float ccSpecularityNoFres;
`),r.includes("ccGlossiness")&&(V+=`float ccGlossiness;
`),r=S+V+r,x=r,{attributes:u,vshader:g,fshader:x,tag:tf}}},If={begin:pn,dummyFragmentCode:_f,end:Bi,fogCode:$h,gammaCode:Lr,precisionCode:di,skinCode:Kh,tonemapCode:Dr,versionCode:Oi,basic:vS,particle:SS,skybox:bS,standard:ec},Lf=2.399963229728653,kr={circlePoint:function(o){const t=Math.sqrt(Math.random()),e=Math.random()*2*Math.PI;o.x=t*Math.cos(e),o.y=t*Math.sin(e)},circlePointDeterministic:function(o,t,e){const s=t*Lf,i=Math.sqrt(t)/Math.sqrt(e);o.x=i*Math.cos(s),o.y=i*Math.sin(s)},spherePointDeterministic:function(o,t,e,s=0,i=1){s=1-2*s,i=1-2*i;const n=U.lerp(s,i,t/e),r=Math.sqrt(1-n*n),a=Lf*t;o.x=Math.cos(a)*r,o.y=n,o.z=Math.sin(a)*r},radicalInverse:function(o){let t=(o<<16|o>>>16)>>>0;return t=((t&1431655765)<<1|(t&2863311530)>>>1)>>>0,t=((t&858993459)<<2|(t&3435973836)>>>2)>>>0,t=((t&252645135)<<4|(t&4042322160)>>>4)>>>0,t=((t&16711935)<<8|(t&4278255360)>>>8)>>>0,t*23283064365386963e-26}},Df=o=>{switch(o.type){case jt:return"RGBM";case uo:return"RGBE";default:switch(o.format){case yr:case xr:case ce:case Vt:return"Linear";default:return"Gamma"}}},Ff=o=>{switch(o===ef&&(o=fo),o){case Uh:return"Cubemap";case fo:return"Equirect";case Py:return"Octahedral"}},xo=(o,t,e)=>{if(o<=0)t[e+0]=0,t[e+1]=0,t[e+2]=0,t[e+3]=0;else if(o>=1)t[e+0]=255,t[e+1]=0,t[e+2]=0,t[e+3]=0;else{let s=1*o%1,i=255*o%1,n=65025*o%1;const r=16581375*o%1;s-=i/255,i-=n/255,n-=r/255,t[e+0]=Math.min(255,Math.floor(s*256)),t[e+1]=Math.min(255,Math.floor(i*256)),t[e+2]=Math.min(255,Math.floor(n*256)),t[e+3]=Math.min(255,Math.floor(r*256))}},ES=o=>{const t=o.length,e=Math.min(t,512),s=Math.ceil(t/e),i=new Uint8Array(e*s*4);let n=0;for(let r=0;r<t;++r)xo(o[r*4+0]*.5+.5,i,n+0),xo(o[r*4+1]*.5+.5,i,n+4),xo(o[r*4+2]*.5+.5,i,n+8),xo(o[r*4+3]/8,i,n+12),n+=16;return{width:e,height:s,data:i}},RS=(o,t,e,s)=>{const i=e*2*Math.PI,n=Math.pow(1-t,1/(s+1)),r=Math.sqrt(1-n*n);o.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},IS=(o,t,e)=>{const s=e*2*Math.PI,i=Math.sqrt(1-t),n=Math.sqrt(t);o.set(Math.cos(s)*n,Math.sin(s)*n,i).normalize()},LS=(o,t,e,s)=>{const i=e*2*Math.PI,n=Math.sqrt((1-t)/(1+(s*s-1)*t)),r=Math.sqrt(1-n*n);o.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},DS=(o,t)=>{const e=o*t,s=t/(1-o*o+e*e);return s*s*(1/Math.PI)},FS=(o,t)=>{const e=new y,s=[];for(let i=0;i<o;++i)RS(e,i/o,kr.radicalInverse(i),t),s.push(e.x,e.y,e.z,0);return s},OS=(o,t)=>{const e=t/o,s=new y,i=[];for(let n=0;n<o;++n){IS(s,n/o,kr.radicalInverse(n));const r=s.z/Math.PI,a=.5*Math.log2(e/r);i.push(s.x,s.y,s.z,a)}return i},BS={"16":{"2":26,"8":20,"32":17,"128":16,"512":16},"32":{"2":53,"8":40,"32":34,"128":32,"512":32},"128":{"2":214,"8":163,"32":139,"128":130,"512":128},"1024":{"2":1722,"8":1310,"32":1114,"128":1041,"512":1025}},kS=(o,t)=>{const e=BS[o];return e&&e[t]||o},zS=(o,t,e)=>{const s=e/o,i=1-Math.log2(t)/11,n=i*i,r=new y,a=new y,l=new y(0,0,1),h=[],c=kS(o,t);for(let d=0;d<c;++d){LS(r,d/c,kr.radicalInverse(d),n);const u=r.z;if(a.set(r.x,r.y,r.z).mulScalar(2*u).sub(l),a.z>0){const f=DS(Math.min(1,u),n)/4+.001,m=.5*Math.log2(s/f);h.push(a.x,a.y,a.z,m)}}for(;h.length<o*4;)h.push(0,0,0,0);return h},US=(o,t,e)=>{const s=ES(e);return new nt(o,{name:t,width:s.width,height:s.height,mipmaps:!1,minFilter:bt,magFilter:bt,levels:[s.data]})};class Of{constructor(t=!0){this.map=new Map,this.destroyContent=t}destroy(){this.destroyContent&&this.map.forEach((t,e)=>{t.destroy()})}get(t,e){if(!this.map.has(t)){const s=e();return this.map.set(t,s),s}return this.map.get(t)}}const NS=new Of(!1),VS=new Rr,sc=(o,t,e)=>VS.get(o,()=>new Of).get(t,()=>US(o,t,NS.get(t,e))),WS=(o,t,e)=>{const s=`lambert-samples-${t}-${e}`;return sc(o,s,()=>OS(t,e))},GS=(o,t,e)=>{const s=`phong-samples-${t}-${e}`;return sc(o,s,()=>FS(t,e))},HS=(o,t,e,s)=>{const i=`ggx-samples-${t}-${e}-${s}`;return sc(o,i,()=>zS(t,e,s))},XS=`
attribute vec2 vertex_position;

uniform vec4 uvMod;

varying vec2 vUv0;

void main(void) {
		gl_Position = vec4(vertex_position, 0.5, 1.0);
		vUv0 = (vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw;
}
`;function Fs(o,t,e={}){var s;o instanceof oc&&(o=arguments[1],t=arguments[2],e={},arguments[3]!==void 0&&(e.specularPower=arguments[3]),arguments[4]!==void 0&&(e.numSamples=arguments[4]));const i={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"},n=e.hasOwnProperty("specularPower")?e.specularPower:1,r=e.hasOwnProperty("face")?e.face:null,a=e.hasOwnProperty("distribution")?e.distribution:n===1?"none":"phong",l=i[a]||"reproject",h=`decode${Df(o)}`,c=`encode${Df(t)}`,d=`sample${Ff(o.projection)}`,u=`getDirection${Ff(t.projection)}`,f=e.hasOwnProperty("numSamples")?e.numSamples:1024,m=`${l}_${h}_${c}_${d}_${u}_${f}`,p=o.device;let _=p.programLib._cache[m];if(!_){const C=`#define PROCESS_FUNC ${l}
#define DECODE_FUNC ${h}
#define ENCODE_FUNC ${c}
#define SOURCE_FUNC ${d}
#define TARGET_FUNC ${u}
#define NUM_SAMPLES ${f}
`+(p.extTextureLod?`#define SUPPORTS_TEXLOD
`:"");let M="";p.webgl2||(M=`#extension GL_OES_standard_derivatives: enable
`,p.extTextureLod&&(M+=`#extension GL_EXT_shader_texture_lod: enable

`)),_=we(p,XS,`${C}
${F.reprojectPS}`,m,!1,M)}p.scope.resolve(o.cubemap?"sourceCube":"sourceTex").setValue(o);const w=p.scope.resolve("params"),v=p.scope.resolve("params2"),x=p.scope.resolve("uvMod");if((s=e)!=null&&s.seamPixels){const C=e.seamPixels,M=e.rect?e.rect.z:t.width,E=e.rect?e.rect.w:t.height,D=M-C*2,I=E-C*2;x.setValue([(D+C*2)/D,(I+C*2)/I,-C/D,-C/I])}else x.setValue([1,1,0,0]);const S=[0,n,o.fixCubemapSeams?1/o.width:0,t.fixCubemapSeams?1/t.width:0],T=[t.width*t.height*(t.cubemap?6:1),o.width*o.height*(o.cubemap?6:1)];if(l.startsWith("prefilterSamples")){const C=o.width*o.height*(o.cubemap?6:1),M=a==="ggx"?HS(p,f,n,C):a==="lambert"?WS(p,f,C):GS(p,f,n);p.scope.resolve("samplesTex").setValue(M),p.scope.resolve("samplesTexInverseSize").setValue([1/M.width,1/M.height])}for(let C=0;C<(t.cubemap?6:1);C++)if(r===null||C===r){var b;const M=new oe({colorBuffer:t,face:C,depth:!1});S[0]=C,w.setValue(S),v.setValue(T),es(p,M,_,(b=e)==null?void 0:b.rect),M.destroy()}}const jS=!0,ic=(o,t=0)=>1+Math.floor(Math.log2(Math.max(o,t))),qS=o=>o.extTextureHalfFloat&&o.textureHalfFloatRenderable,YS=o=>o.extTextureFloat&&o.textureFloatRenderable,$S=o=>qS(o)?ce:YS(o)?Vt:ct,Bf=o=>ct,KS=(o,t,e,s)=>new nt(o,{name:`lighting-${t}`,cubemap:!0,width:t,height:t,format:e,type:e===ct?jt:_e,addressU:et,addressV:et,fixCubemapSeams:jS,mipmaps:!!s});class kf{static generateSkyboxCubemap(t,e){const s=t.device,i=KS(s,e||(t.cubemap?t.width:t.width/4),ct,!1);return Fs(t,i,{numSamples:1024}),i}static generateLightingSource(t,e=null){const s=t.device,i=$S(s),n=(e==null?void 0:e.target)||new nt(s,{name:"lighting-source",cubemap:!0,width:(e==null?void 0:e.size)||128,height:(e==null?void 0:e.size)||128,format:i,type:i===ct?jt:_e,addressU:et,addressV:et,fixCubemapSeams:!1,mipmaps:!0});return Fs(t,n,{numSamples:t.mipmaps?1:1024}),n}static generateAtlas(t,e=null){const s=t.device,i=Bf(),n=(e==null?void 0:e.target)||new nt(s,{width:(e==null?void 0:e.size)||512,height:(e==null?void 0:e.size)||512,format:i,type:jt,projection:fo,addressU:et,addressV:et,mipmaps:!1}),r=n.width/512,a=new Z(0,0,512*r,256*r),l=ic(256)-ic(4);for(let h=0;h<l;++h)Fs(t,n,{numSamples:1,rect:a,seamPixels:r}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(a.z*.5)),a.w=Math.max(1,Math.floor(a.w*.5));a.set(0,256*r,256*r,128*r);for(let h=1;h<7;++h)Fs(t,n,{numSamples:(e==null?void 0:e.numReflectionSamples)||1024,distribution:(e==null?void 0:e.distribution)||"ggx",specularPower:Math.max(1,2048>>h*2),rect:a,seamPixels:r}),a.y+=a.w,a.z=Math.max(1,Math.floor(a.z*.5)),a.w=Math.max(1,Math.floor(a.w*.5));return a.set(128*r,(256+128)*r,64*r,32*r),Fs(t,n,{numSamples:(e==null?void 0:e.numAmbientSamples)||2048,distribution:"lambert",rect:a,seamPixels:r}),n}static generatePrefilteredAtlas(t,e=null){const s=t[0].device,i=Bf(),n=(e==null?void 0:e.target)||new nt(s,{width:(e==null?void 0:e.size)||512,height:(e==null?void 0:e.size)||512,format:i,type:jt,projection:fo,addressU:et,addressV:et,mipmaps:!1}),r=n.width/512,a=new Z(0,0,512*r,256*r),l=ic(512);for(let h=0;h<l;++h)Fs(t[0],n,{numSamples:1,rect:a,seamPixels:r}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(a.z*.5)),a.w=Math.max(1,Math.floor(a.w*.5));a.set(0,256*r,256*r,128*r);for(let h=1;h<t.length;++h)Fs(t[h],n,{numSamples:1,rect:a,seamPixels:r}),a.y+=a.w,a.z=Math.max(1,Math.floor(a.z*.5)),a.w=Math.max(1,Math.floor(a.w*.5));return a.set(128*r,(256+128)*r,64*r,32*r),e!=null&&e.legacyAmbient?Fs(t[5],n,{numSamples:1,rect:a,seamPixels:r}):Fs(t[0],n,{numSamples:(e==null?void 0:e.numSamples)||2048,distribution:"lambert",rect:a,seamPixels:r}),n}}const zf=new Rr;function zi(o){return zf.get(o)}function ZS(o,t){zf.get(o,()=>t)}let JS=0;class Ue{constructor(){this.name="Untitled",this.id=JS++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this.blend=!1,this.blendSrc=Pt,this.blendDst=li,this.blendEquation=Nt,this.separateAlphaBlend=!1,this.blendSrcAlpha=Pt,this.blendDstAlpha=li,this.blendAlphaEquation=Nt,this.cull=cn,this.depthTest=!0,this.depthFunc=$a,this.depthWrite=!0,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}set shader(t){this._shader=t}get shader(){return this._shader}get transparent(){return this.blend||this.blendSrc!==Pt||this.blendDst!==li||this.blendEquation!==Nt}set blendType(t){const e=this.blend;switch(t){case he:this.blend=!1,this.blendSrc=Pt,this.blendDst=li,this.blendEquation=Nt;break;case Be:this.blend=!0,this.blendSrc=Wa,this.blendDst=Ga,this.blendEquation=Nt;break;case Je:this.blend=!0,this.blendSrc=Pt,this.blendDst=Ga,this.blendEquation=Nt;break;case Ta:this.blend=!0,this.blendSrc=Pt,this.blendDst=Pt,this.blendEquation=Nt;break;case Aa:this.blend=!0,this.blendSrc=Wa,this.blendDst=Pt,this.blendEquation=Nt;break;case nh:this.blend=!0,this.blendSrc=Va,this.blendDst=ku,this.blendEquation=Nt;break;case rh:this.blend=!0,this.blendSrc=zu,this.blendDst=Pt,this.blendEquation=Nt;break;case Ca:this.blend=!0,this.blendSrc=Va,this.blendDst=li,this.blendEquation=Nt;break;case ah:this.blend=!0,this.blendSrc=Pt,this.blendDst=Pt,this.blendEquation=Uu;break;case oh:this.blend=!0,this.blendSrc=Pt,this.blendDst=Pt,this.blendEquation=Nu;break}e!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}get blendType(){if(this.transparent){if(this.blend&&this.blendSrc===Wa&&this.blendDst===Ga&&this.blendEquation===Nt)return Be;if(this.blend&&this.blendSrc===Pt&&this.blendDst===Pt&&this.blendEquation===Nt)return Ta;if(this.blend&&this.blendSrc===Wa&&this.blendDst===Pt&&this.blendEquation===Nt)return Aa;if(this.blend&&this.blendSrc===Va&&this.blendDst===ku&&this.blendEquation===Nt)return nh;if(this.blend&&this.blendSrc===zu&&this.blendDst===Pt&&this.blendEquation===Nt)return rh;if(this.blend&&this.blendSrc===Pt&&this.blendDst===Pt&&this.blendEquation===Uu)return ah;if(this.blend&&this.blendSrc===Pt&&this.blendDst===Pt&&this.blendEquation===Nu)return oh;if(this.blend&&this.blendSrc===Va&&this.blendDst===li&&this.blendEquation===Nt)return Ca;if(this.blend&&this.blendSrc===Pt&&this.blendDst===Ga&&this.blendEquation===Nt)return Je}else return he;return Be}copy(t){return this.name=t.name,this.shader=t.shader,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.blend=t.blend,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.separateAlphaBlend=t.separateAlphaBlend,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendAlphaEquation=t.blendAlphaEquation,this.cull=t.cull,this.depthTest=t.depthTest,this.depthFunc=t.depthFunc,this.depthWrite=t.depthWrite,this.depthBias=t.depthBias,this.slopeDepthBias=t.slopeDepthBias,t.stencilFront&&(this.stencilFront=t.stencilFront.clone()),t.stencilBack&&(t.stencilFront===t.stencilBack?this.stencilBack=this.stencilFront:this.stencilBack=t.stencilBack.clone()),this.redWrite=t.redWrite,this.greenWrite=t.greenWrite,this.blueWrite=t.blueWrite,this.alphaWrite=t.alphaWrite,this}clone(){return new this.constructor().copy(this)}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){}updateShader(t,e,s,i,n,r){}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants={};for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let s=0;s<e._shader.length;s++)e._shader[s]=null}}getParameter(t){return this.parameters[t]}setParameter(t,e){if(e===void 0&&typeof t=="object"){const i=t;if(i.length){for(let n=0;n<i.length;n++)this.setParameter(i[n]);return}t=i.name,e=i.value}const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;e===void 0&&(e=s);for(const i in e){const n=s[i];n&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}destroy(){this.variants={},this.shader=null;for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];for(let s=0;s<e._shader.length;s++)e._shader[s]=null;if(e._material=null,e.mesh){const s=zi(e.mesh.device);this!==s&&(e.material=s)}}}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);s!==-1&&e.splice(s,1)}}const Uf=(o,t)=>{if(o.length!==t.length)return!1;for(let e=0;e<o.length;++e)if(o[e]!==t[e])return!1;return!0},nc=o=>o.r!==1||o.g!==1||o.b!==1,QS=o=>o.r!==0||o.g!==0||o.b!==0;class tb{constructor(){this._mapXForms=null}updateMinRef(t,e,s,i,n,r,a,l){this._updateSharedOptions(t,s,i,n,a),this._updateMinOptions(t,i),this._updateUVOptions(t,i,n,!0)}updateRef(t,e,s,i,n,r,a,l){this._updateSharedOptions(t,s,i,n,a),this._updateEnvOptions(t,e,i,s),this._updateMaterialOptions(t,i),a===Qe&&(t.gamma&&(t.gamma=Ra),t.toneMap=Ia),t.hasTangents=n&&i.normalMap&&(n&Lu)!=0,this._updateLightOptions(t,i,n,l,r),this._updateUVOptions(t,i,n,!1)}_updateSharedOptions(t,e,s,i,n){t.pass=n,t.alphaTest=s.alphaTest>0,t.forceFragmentPrecision=s.forceFragmentPrecision||"",t.chunks=s.chunks||"",t.blendType=s.blendType,t.forceUv1=s.forceUv1,t.separateAmbient=!1,t.screenSpace=i&&(i&Fa)!=0,t.skin=i&&(i&La)!=0,t.useInstancing=i&&(i&Iu)!=0,t.useMorphPosition=i&&(i&Oa)!=0,t.useMorphNormal=i&&(i&Ba)!=0,t.useMorphTextureBased=i&&(i&ka)!=0,t.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&(t.clusteredLightingEnabled=!0,t.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.clusteredLightingShadowType=e.lighting.shadowType,t.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled)}_updateUVOptions(t,e,s,i){let n=!1,r=!1,a=!1;s&&(n=(s&Pu)!=0,r=(s&Eu)!=0,a=(s&Ru)!=0),t.vertexColors=!1,this._mapXForms=[];for(const l in bs)this._updateTexOptions(t,e,l,n,r,a,i);this._mapXForms=null}_updateMinOptions(t,e){t.opacityTint=e.opacity!==1&&e.blendType!==he,t.lights=[]}_updateMaterialOptions(t,e){const s=(e.diffuseTint||!e.diffuseMap&&!e.diffuseVertexColor)&&nc(e.diffuse),i=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||QS(e.specular)||e.enableGGXSpecular||e.clearCoat>0),n=i&&!e.useMetalness&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&nc(e.specular),r=!e.emissiveMap||nc(e.emissive)&&e.emissiveTint,a=e.emissiveIntensity!==1,l=e.normalMap?e.normalMap.format===Li||e.normalMap.type===un:!1;t.opacityTint=e.opacity!==1&&e.blendType!==he?1:0,t.blendMapsWithColors=!0,t.ambientTint=e.ambientTint,t.diffuseTint=s?2:0,t.specularTint=n?2:0,t.metalnessTint=e.useMetalness&&e.metalness<1?1:0,t.glossTint=1,t.emissiveTint=(r?2:0)+(a?1:0),t.alphaToCoverage=e.alphaToCoverage,t.normalizeNormalMap=e.normalizeNormalMap,t.ambientSH=!!e.ambientSH,t.useSpecular=i,t.emissiveFormat=e.emissiveMap?e.emissiveMap.type===jt?1:e.emissiveMap.format===Vt?2:0:null,t.lightMapFormat=e.lightMap?e.lightMap.type===jt?1:e.lightMap.format===Vt?2:0:null,t.specularAntialias=e.specularAntialias&&!!e.normalMap&&!!e.normalMap.mipmaps&&!l,t.conserveEnergy=e.conserveEnergy,t.opacityFadesSpecular=e.opacityFadesSpecular,t.alphaFade=e.alphaFade,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=e.occludeSpecularIntensity!==1,t.occludeDirect=e.occludeDirect,t.shadingModel=e.shadingModel,t.fresnelModel=e.fresnelModel,t.packedNormal=l,t.fastTbn=e.fastTbn,t.cubeMapProjection=e.cubeMapProjection,t.customFragmentShader=e.customFragmentShader,t.refraction=!!e.refraction,t.useMetalness=e.useMetalness,t.enableGGXSpecular=e.enableGGXSpecular,t.msdf=!!e.msdfMap,t.twoSidedLighting=e.twoSidedLighting,t.pixelSnap=e.pixelSnap,t.aoMapUv=e.aoUvSet,t.diffuseDetail=!!e.diffuseMap,t.normalDetail=!!e.normalMap,t.diffuseDetailMode=e.diffuseDetailMode,t.detailModes=!!t.diffuseDetail,t.clearCoat=!!e.clearCoat,t.clearCoatTint=e.clearCoat!==1?1:0,t.clearCoatGlossiness=!!e.clearCoatGlossiness,t.clearCoatGlossTint=e.clearCoatGlossiness!==1?1:0}_updateEnvOptions(t,e,s,i){t.fog=s.useFog?i.fog:"none",t.gamma=s.useGammaTonemap?i.gammaCorrection:mh,t.toneMap=s.useGammaTonemap?i.toneMapping:-1,t.useRgbm=s.emissiveMap&&s.emissiveMap.type===jt||s.lightMap&&s.lightMap.type===jt,t.fixSeams=s.cubeMap?s.cubeMap.fixCubemapSeams:!1;const n=s.shadingModel===Pi;let r=!1;if(s.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=s.envAtlas.encoding):s.cubeMap?(t.reflectionSource="cubeMap",t.reflectionEncoding=s.cubeMap.encoding):s.sphereMap?(t.reflectionSource="sphereMap",t.reflectionEncoding=s.sphereMap.encoding):s.useSkybox&&i.envAtlas&&!n?(t.reflectionSource="envAtlas",t.reflectionEncoding=i.envAtlas.encoding,r=!0):(t.reflectionSource=null,t.reflectionEncoding=null),s.ambientSH&&!n)t.ambientSource="ambientSH",t.ambientEncoding=null;else{const a=s.envAtlas||(s.useSkybox&&i.envAtlas?i.envAtlas:null);a&&!n?(t.ambientSource="envAtlas",t.ambientEncoding=a.encoding):(t.ambientSource="constant",t.ambientEncoding=null)}t.skyboxIntensity=r&&i.skyboxIntensity!==1,t.useCubeMapRotation=r&&i.skyboxRotation&&!i.skyboxRotation.equals(tt.IDENTITY)}_updateLightOptions(t,e,s,i,n){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.lightMapWithoutAmbient=!1,t.dirLightMap=!1,s&&(t.noShadow=(s&_h)!=0,(s&Da)!=0&&(t.lightMapFormat=1,t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.lightMapWithoutAmbient=!e.lightMap,t.useRgbm=!0,(s&gh)!=0&&(t.dirLightMap=!0),(s&yh)!=0&&(t.lightMapWithoutAmbient=!1))),e.useLighting){const r=[],a=s?s>>16:xs;t.lightMaskDynamic=!!(a&xs),i&&(this._collectLights(lt,i[lt],r,a),this._collectLights(ut,i[ut],r,a,n),this._collectLights(_t,i[_t],r,a,n)),t.lights=r}else t.lights=[];t.lights.length===0&&(t.noShadow=!0)}_updateTexOptions(t,e,s,i,n,r,a){const l=s+"Map",h=s+"VertexColor",c=s+"VertexColorChannel",d=l+"Channel",u=l+"Transform",f=l+"Uv";s!=="light"&&(t[l]=!1,t[d]="",t[u]=0,t[f]=0),t[h]=!1,t[c]="";const m=s==="opacity";if(m&&e.blendType===he&&e.alphaTest===0&&!e.alphaToCoverage)return t;if((!a||m)&&(s!=="height"&&e[h]&&r&&(t[h]=e[h],t[c]=e[c],t.vertexColors=!0),e[l])){let p=!0;e[f]===0&&!i&&(p=!1),e[f]===1&&!n&&(p=!1),p&&(t[l]=!!e[l],t[u]=this._getMapTransformID(e.getUniform(u),e[f]),t[d]=e[d],t[f]=e[f])}}_collectLights(t,e,s,i,n){for(let r=0;r<e.length;r++){const a=e[r];if(a.enabled&&a.mask&i){if(t!==lt&&a.isStatic)continue;s.push(a)}}if(n)for(let r=0;r<n.length;r++){const a=n[r];a._type===t&&s.push(a)}}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let i=0;i<s.length;i++)if(Uf(s[i][0].value,t[0].value)&&Uf(s[i][1].value,t[1].value))return i+1;return s.push(t)}}const yn={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",aoMapRotation:"number",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapRotation:"number",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMapRotation:"number",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapRotation:"number",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",netalnessMapRotation:"number",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",glossMapRotation:"number",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatMapRotation:"number",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatGlossMapRotation:"number",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",clearCoatNormalMapRotation:"number",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapMapRotation:"number",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapRotation:"number",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapRotation:"number",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapRotation:"number",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityMapRotation:"number",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",lightMapRotation:"number",depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture"},vo=[];for(const o in yn)yn[o]==="texture"&&vo.push(o);const rc=[];for(const o in yn)yn[o]==="cubemap"&&rc.push(o);const So={},Nf={};let zr=new Set;class ue extends Ue{constructor(){super();this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new tb,this.reset()}reset(){Object.keys(So).forEach(t=>{this[`_${t}`]=So[t].value()}),this._chunks={},this._uniformCache={}}set chunks(t){this._dirtyShader=!0,this._chunks=t}get chunks(){return this._dirtyShader=!0,this._chunks}copy(t){super.copy(t),Object.keys(So).forEach(e=>{this[e]=t[e]});for(const e in t._chunks)t._chunks.hasOwnProperty(e)&&(this._chunks[e]=t._chunks[e]);return this}_setParameter(t,e){zr.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach(e=>{this._setParameter(e.name,e.value)})}_processParameters(t){const e=this[t];e.forEach(s=>{zr.has(s)||delete this.parameters[s]}),this[t]=zr,zr=e,zr.clear()}_updateMap(t){const e=t+"Map",s=this[e];if(s){this._setParameter("texture_"+e,s);const i=e+"Transform",n=this.getUniform(i);n&&this._setParameters(n)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return Nf[t](this,e,s)}updateUniforms(t,e){const s=i=>this.getUniform(i,t,e);this._setParameter("material_ambient",s("ambient")),(!this.diffuseMap||this.diffuseTint)&&this._setParameter("material_diffuse",s("diffuse")),this.useMetalness?(!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness):(!this.specularMap||this.specularTint)&&this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_shininess",s("shininess")),(!this.emissiveMap||this.emissiveTint)&&this._setParameter("material_emissive",s("emissive")),this.emissiveIntensity!==1&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),this.opacityFadesSpecular===!1&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),this.cubeMapProjection===Jg&&this._setParameter(s("cubeMapProjectionBox"));for(const i in bs)this._updateMap(i);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&(this.shader=null,this.clearVariants())}updateEnvUniforms(t,e){const s=this.envAtlas||(this.useSkybox?e.envAtlas:null);s&&(this._setParameter("texture_envAtlas",s),this.useSkybox&&!e.skyboxRotation.equals(tt.IDENTITY)&&e._skyboxRotationMat3&&this._setParameter("cubeMapRotationMatrix",e._skyboxRotationMat3.data)),this._processParameters("_activeLightingParams")}updateShader(t,e,s,i,n,r){this.updateEnvUniforms(t,e);const a=n>Qe&&n<=fr;let l=a?ec.optionsContextMin:ec.optionsContext;a?this.shaderOptBuilder.updateMinRef(l,t,e,this,s,i,n,r):this.shaderOptBuilder.updateRef(l,t,e,this,s,i,n,r),this.onUpdateShader&&(l=this.onUpdateShader(l));const h=t.getProgramLibrary();this.shader=h.getProgram("standard",l),s||(this.clearVariants(),this.variants[0]=this.shader),this._dirtyShader=!1}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,super.destroy()}}ue.TEXTURE_PARAMETERS=vo;ue.CUBEMAP_PARAMETERS=rc;const bo=(o,t)=>{Nf[o]=t},ac=(o,t,e,s)=>{Object.defineProperty(ue.prototype,o,{get:s||function(){return this[`_${o}`]},set:e}),So[o]={value:t}},eb=o=>{const t=`_${o.name}`,e=o.dirtyShaderFunc||(()=>!0),s=function(n){const r=this[t];r!==n&&(this._dirtyShader=this._dirtyShader||e(r,n),this[t]=n)};ac(o.name,()=>o.defaultValue,s,o.getterFunc)},sb=o=>{const t=`_${o.name}`,e=o.dirtyShaderFunc||(()=>!0),s=function(n){const r=this[t];r.equals(n)||(this._dirtyShader=this._dirtyShader||e(r,n),this[t]=r.copy(n))};ac(o.name,()=>o.defaultValue.clone(),s,o.getterFunc)},Me=o=>o.defaultValue&&o.defaultValue.clone?sb(o):eb(o);function ae(o,t,e,s,i,n){bs[o]=e,Me({name:`${o}Map`,defaultValue:null,dirtyShaderFunc:(c,d)=>!!c!=!!d||c&&(c.type!==d.type||c.fixCubemapSeams!==d.fixCubemapSeams||c.format!==d.format)}),Me({name:`${o}MapTiling`,defaultValue:new H(1,1)}),Me({name:`${o}MapOffset`,defaultValue:new H(0,0)}),Me({name:`${o}MapRotation`,defaultValue:0}),Me({name:`${o}MapUv`,defaultValue:t}),e>0&&Me({name:`${o}MapChannel`,defaultValue:s||(e>1?"rgb":"g")}),i&&(Me({name:`${o}VertexColor`,defaultValue:!1}),e>0&&Me({name:`${o}VertexColorChannel`,defaultValue:s||(e>1?"rgb":"g")})),n&&Me({name:`${o}Mode`,defaultValue:Qg});const r=`${o}MapTiling`,a=`${o}MapOffset`,l=`${o}MapRotation`,h=`${o}MapTransform`;bo(h,(c,d,u)=>{const f=c[r],m=c[a],p=c[l];if(f.x===1&&f.y===1&&m.x===0&&m.y===0&&p===0)return null;const _=c._allocUniform(h,()=>[{name:`texture_${h}0`,value:new Float32Array(3)},{name:`texture_${h}1`,value:new Float32Array(3)}]),g=Math.cos(p*U.DEG_TO_RAD),w=Math.sin(p*U.DEG_TO_RAD),v=_[0].value;v[0]=g*f.x,v[1]=-w*f.y,v[2]=m.x;const x=_[1].value;return x[0]=w*f.x,x[1]=g*f.y,x[2]=1-f.y-m.y,_})}function wo(o,t){Me({name:o,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this[`_${o}`]}}),bo(o,(e,s,i)=>{const n=e._allocUniform(o,()=>new Float32Array(3)),r=e[o];return e.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(r.r,2.2),n[1]=Math.pow(r.g,2.2),n[2]=Math.pow(r.b,2.2)):(n[0]=r.r,n[1]=r.g,n[2]=r.b),n})}function Zt(o,t,e){Me({name:o,defaultValue:t,dirtyShaderFunc:(s,i)=>(s===0||s===1)!=(i===0||i===1)}),bo(o,e)}function Ur(o,t){Me({name:o,defaultValue:null,dirtyShaderFunc:(e,s)=>!!e==!!s}),bo(o,t)}function Et(o,t){Me({name:o,defaultValue:t})}function ib(){wo("ambient",new j(.7,.7,.7)),wo("diffuse",new j(1,1,1)),wo("specular",new j(0,0,0)),wo("emissive",new j(0,0,0)),Zt("emissiveIntensity",1),Zt("shininess",25,(s,i,n)=>s.shadingModel===Pi?Math.pow(2,s.shininess*.01*11):s.shininess*.01),Zt("heightMapFactor",1,(s,i,n)=>s.heightMapFactor*.025),Zt("opacity",1),Zt("alphaFade",1),Zt("alphaTest",0),Zt("bumpiness",1),Zt("normalDetailMapBumpiness",1),Zt("reflectivity",1),Zt("occludeSpecularIntensity",1),Zt("refraction",0),Zt("refractionIndex",1/1.5),Zt("metalness",1),Zt("anisotropy",0),Zt("clearCoat",0),Zt("clearCoatGlossiness",1),Zt("clearCoatBumpiness",1),Zt("aoUvSet",0,null),Ur("ambientSH"),Ur("cubeMapProjectionBox",(s,i,n)=>{const r=s._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),a=s.cubeMapProjectionBox.getMin(),l=r[0].value;l[0]=a.x,l[1]=a.y,l[2]=a.z;const h=s.cubeMapProjectionBox.getMax(),c=r[1].value;return c[0]=h.x,c[1]=h.y,c[2]=h.z,r}),Et("ambientTint",!1),Et("diffuseTint",!1),Et("specularTint",!1),Et("emissiveTint",!1),Et("fastTbn",!1),Et("specularAntialias",!1),Et("useMetalness",!1),Et("enableGGXSpecular",!1),Et("occludeDirect",!1),Et("normalizeNormalMap",!0),Et("conserveEnergy",!0),Et("opacityFadesSpecular",!0),Et("occludeSpecular",ph),Et("shadingModel",Ea),Et("fresnelModel",hh),Et("cubeMapProjection",Zg),Et("customFragmentShader",null),Et("forceFragmentPrecision",null),Et("useFog",!0),Et("useLighting",!0),Et("useGammaTonemap",!0),Et("useSkybox",!0),Et("forceUv1",!1),Et("pixelSnap",!1),Et("twoSidedLighting",!1),Et("nineSlicedMode",void 0),ae("diffuse",0,3,"",!0),ae("specular",0,3,"",!0),ae("emissive",0,3,"",!0),ae("normal",0,-1,"",!1),ae("metalness",0,1,"",!0),ae("gloss",0,1,"",!0),ae("opacity",0,1,"a",!0),ae("height",0,1,"",!1),ae("ao",0,1,"",!0),ae("light",1,3,"",!0),ae("msdf",0,3,"",!1),ae("diffuseDetail",0,3,"",!1,!0),ae("normalDetail",0,-1,"",!1),ae("clearCoat",0,1,"",!0),ae("clearCoatGloss",0,1,"",!0),ae("clearCoatNormal",0,-1,"",!1),Ur("cubeMap"),Ur("sphereMap"),Ur("envAtlas");const o=function(){return this._prefilteredCubemaps},t=function(i){const n=this._prefilteredCubemaps;i=i||[];let r=!1,a=!0;for(let l=0;l<6;++l){const h=i[l]||null;n[l]!==h&&(n[l]=h,r=!0),a=a&&!!n[l]}r&&(a?this.envAtlas=kf.generatePrefilteredAtlas(n,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},e=[null,null,null,null,null,null];ac("prefilteredCubemaps",()=>e.slice(),t,o)}ib();class nb{constructor(t){this._device=t,this._cache={},this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};const e=new ue;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,t,{},e,null,[],on,null,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,t,{},e,null,[],ai,null,null)}register(t,e){this.isRegistered(t)||(this._generators[t]=e)}unregister(t){this.isRegistered(t)&&delete this._generators[t]}isRegistered(t){return this._generators[t]!==void 0}getProgram(t,e){const s=this._generators[t];if(s===void 0)return null;const i=this._device,n=s.generateKey(e);let r=this._cache[n];if(!r){let a;e.lights&&(a=e.lights,e.lights=a.map(function(h){const c=h.clone?h.clone():h;return c.key=h.key,c})),this.storeNewProgram(t,e),e.lights&&(e.lights=a),this._precached&&console.warn(`ProgramLibrary#getProgram: Cache miss for shader ${t} key ${n} after shaders precaching`);const l=s.createShaderDefinition(i,e);r=this._cache[n]=new Ir(i,l)}return r}storeNewProgram(t,e){let s={};if(t==="standard"){const i=this._getDefaultStdMatOptions(e.pass);for(const n in e)(e.hasOwnProperty(n)&&i[n]!==e[n]||n==="pass")&&(s[n]=e[n])}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t=`let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;
`;t+="let shaders = [",this._programsCollection[0]&&(t+=`
	`+this._programsCollection[0]);for(let s=1;s<this._programsCollection.length;++s)t+=`,
	`+this._programsCollection[s];t+=`
];
`,t+=`device.programLib.precompile(shaders);
`,t+='if (pc.version != "'+Sg+'" || pc.revision != "'+bg+`")
`,t+='	console.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}clearCache(){const t=this._cache;this._isClearingCache=!0;for(const e in t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1}removeFromCache(t){if(this._isClearingCache)return;const e=this._cache;for(const s in e)if(e.hasOwnProperty(s)&&e[s]===t){delete e[s];break}}_getDefaultStdMatOptions(t){return t>Qe&&t<=fr?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if(t[s].name==="standard"){const i=t[s].options,n=this._getDefaultStdMatOptions(i.pass);for(const r in n)n.hasOwnProperty(r)&&i[r]===void 0&&(i[r]=n[r])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}const Vf="resizecanvas";class oc extends at{constructor(t){super();this.canvas=void 0,this.scope=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.precision=void 0,this.supportsInstancing=void 0,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.canvas=t,this._width=0,this._height=0,this._maxPixelRatio=1,this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let e=Tr;e<=Di;e++)this._primsPerFrame[e]=0;this._renderTargetCreationTime=0,this.scope=new xS("Device"),this.programLib=new nb(this);for(const e in If)this.programLib.register(e,If[e])}destroy(){this.fire("destroy")}postDestroy(){this.scope=null,this.canvas=null}toJSON(t){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null}getProgramLibrary(){return this.programLib}setProgramLibrary(t){this.programLib=t}setRenderTarget(t){this.renderTarget=t}getRenderTarget(){return this.renderTarget}_isBrowserInterface(t){return typeof HTMLCanvasElement!="undefined"&&t instanceof HTMLCanvasElement||typeof HTMLImageElement!="undefined"&&t instanceof HTMLImageElement||typeof HTMLVideoElement!="undefined"&&t instanceof HTMLVideoElement||typeof ImageBitmap!="undefined"&&t instanceof ImageBitmap}resizeCanvas(t,e){this._width=t,this._height=e;const s=Math.min(this._maxPixelRatio,Dt.browser?window.devicePixelRatio:1);t=Math.floor(t*s),e=Math.floor(e*s),(this.canvas.width!==t||this.canvas.height!==e)&&(this.canvas.width=t,this.canvas.height=e,this.fire(Vf,t,e))}setResolution(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire(Vf,t,e)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(t){}get fullscreen(){return!1}set maxPixelRatio(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}get maxPixelRatio(){return this._maxPixelRatio}}const rb={depth:!0,face:0};class oe{constructor(t){var e,s;const i=arguments[1],n=arguments[2];if(t instanceof oc?(this._colorBuffer=i,t=n):this._colorBuffer=t.colorBuffer,this._colorBuffer&&(this._colorBuffer._isRenderTarget=!0),t=t!==void 0?t:rb,this._depthBuffer=t.depthBuffer,this._face=t.face!==void 0?t.face:0,this._depthBuffer){const l=this._depthBuffer._format;l===vr?(this._depth=!0,this._stencil=!1):l===Qa?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else this._depth=t.depth!==void 0?t.depth:!0,this._stencil=t.stencil!==void 0?t.stencil:!1;if(this._device=((e=this._colorBuffer)==null?void 0:e.device)||((s=this._depthBuffer)==null?void 0:s.device),this._samples=t.samples!==void 0?Math.min(t.samples,this._device.maxSamples):1,this.autoResolve=t.autoResolve!==void 0?t.autoResolve:!0,this.name=t.name,!this.name){var r;this.name=(r=this._colorBuffer)==null?void 0:r.name}if(!this.name){var a;this.name=(a=this._depthBuffer)==null?void 0:a.name}this.name||(this.name="Untitled"),this.flipY=!!t.flipY,this.impl=this._device.createRenderTargetImpl(this)}destroy(){const t=this._device;if(t){const e=t.targets.indexOf(this);e!==-1&&t.targets.splice(e,1),this.destroyFrameBuffers()}}destroyFrameBuffers(){const t=this._device;t&&this.impl.destroy(t)}destroyTextureBuffers(){this._depthBuffer&&(this._depthBuffer.destroy(),this._depthBuffer=null),this._colorBuffer&&(this._colorBuffer.destroy(),this._colorBuffer=null)}init(){this.impl.init(this._device,this)}loseContext(){this.impl.loseContext()}resolve(t=!0,e=!!this._depthBuffer){this._device&&this.impl.resolve(this._device,this,t,e)}copy(t,e,s){if(!this._device)if(t._device)this._device=t._device;else return!1;return this._device.copyRenderTarget(t,this,e,s)}get colorBuffer(){return this._colorBuffer}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}get height(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}class ui{constructor(t,e,s,i=ve,n){this.device=t,this.format=e,this.numIndices=s,this.usage=i,this.impl=t.createIndexBufferImpl(this);const r=Fy[e];this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes,this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);e!==-1&&t.buffers.splice(e,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.destroy(t),this.device._vram.ib-=this.storage.byteLength}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength!==this.numBytes?!1:(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return this.format===Ii?new Uint32Array(t):this.format===Is?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let i=0;i<e;i++)s[i]=t[i];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let i=0;i<s;i++)t[i]=e[i]}return s}}function ab(o){this.array[this.index]=o}function ob(o,t){this.array[this.index]=o,this.array[this.index+1]=t}function lb(o,t,e){this.array[this.index]=o,this.array[this.index+1]=t,this.array[this.index+2]=e}function hb(o,t,e,s){this.array[this.index]=o,this.array[this.index+1]=t,this.array[this.index+2]=e,this.array[this.index+3]=s}function cb(o,t,e){this.array[o]=t[e]}function db(o,t,e){this.array[o]=t[e],this.array[o+1]=t[e+1]}function ub(o,t,e){this.array[o]=t[e],this.array[o+1]=t[e+1],this.array[o+2]=t[e+2]}function fb(o,t,e){this.array[o]=t[e],this.array[o+1]=t[e+1],this.array[o+2]=t[e+2],this.array[o+3]=t[e+3]}function mb(o,t,e){t[e]=this.array[o]}function pb(o,t,e){t[e]=this.array[o],t[e+1]=this.array[o+1]}function _b(o,t,e){t[e]=this.array[o],t[e+1]=this.array[o+1],t[e+2]=this.array[o+2]}function gb(o,t,e){t[e]=this.array[o],t[e+1]=this.array[o+1],t[e+2]=this.array[o+2],t[e+3]=this.array[o+3]}class yb{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new mn[e.dataType](t,e.offset):this.array=new mn[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=ab,this.getToArray=mb,this.setFromArray=cb;break;case 2:this.set=ob,this.getToArray=pb,this.setFromArray=db;break;case 3:this.set=lb,this.getToArray=_b,this.setFromArray=ub;break;case 4:this.set=hb,this.getToArray=gb,this.setFromArray=fb;break}}get(t){return this.array[this.index+t]}set(t,e,s,i){}getToArray(t,e,s){}setFromArray(t,e,s){}}class Nr{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let s=0;s<e.elements.length;s++){const i=e.elements[s];this.accessors[s]=new yb(this.buffer,i,e),this.element[i.name]=this.accessors[s]}}next(t=1){let e=0;const s=this.accessors,i=this.accessors.length;for(;e<i;){const n=s[e++];n.index+=t*n.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const i=this.element[t];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const n=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let r=0;for(let a=0;a<s;a++)i.setFromArray(r,e,a*n),r+=i.stride}else if(e.length>s*n){const r=s*n;if(ArrayBuffer.isView(e))e=e.subarray(0,r),i.array.set(e);else for(let a=0;a<r;a++)i.array[a]=e[a]}else i.array.set(e)}}readData(t,e){const s=this.element[t];let i=0;if(s){i=this.vertexBuffer.numVertices;let n;const r=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let a=0;for(n=0;n<i;n++)s.getToArray(a,e,n*r),a+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const a=i*r;for(n=0;n<a;n++)e[n]=s.array[n]}}return i}}class xb{constructor(t,e){this.device=t,this.useAlpha=e,this.useMipmaps=t.webgl2,this.texture=null,this.renderTarget=null,this.textureId=null}destroy(){this.textureId=null,this.renderTarget&&(this.renderTarget.destroy(),this.renderTarget=null),this.texture&&(this.texture.destroy(),this.texture=null)}create(){if(!this.texture){const t=new nt(this.device,{name:"texture_grabPass",format:this.useAlpha?ct:Ls,minFilter:this.useMipmaps?Ei:Yt,magFilter:Yt,addressU:et,addressV:et,mipmaps:this.useMipmaps});this.texture=t,this.renderTarget=new oe({colorBuffer:t,depth:!1}),this.textureId=this.device.scope.resolve(t.name),this.textureId.setValue(t)}}update(){const t=this.device,e=t.gl;if(!t.grabPassAvailable)return!1;const s=t.renderTarget,i=s&&s.impl._glResolveFrameBuffer,n=this.texture,r=t.width,a=t.height;if(t.webgl2&&!t._tempMacChromeBlitFramebufferWorkaround&&r===n._width&&a===n._height){i&&s.resolve(!0);const l=s?s.impl._glFrameBuffer:null,h=s?s.impl._glResolveFrameBuffer||s.impl._glFrameBuffer:null;t.initRenderTarget(this.renderTarget);const c=this.renderTarget.impl._glFrameBuffer;e.bindFramebuffer(e.READ_FRAMEBUFFER,h),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,c),e.blitFramebuffer(0,0,r,a,0,0,r,a,e.COLOR_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,l)}else{i&&(s.resolve(!0),e.bindFramebuffer(e.FRAMEBUFFER,s.impl._glResolveFrameBuffer));const l=n.impl._glFormat;e.copyTexImage2D(e.TEXTURE_2D,0,l,0,0,r,a,0),n._width=r,n._height=a,i&&e.bindFramebuffer(e.FRAMEBUFFER,s.impl._glFrameBuffer)}return!0}generateMipmaps(){this.useMipmaps&&this.device.gl.generateMipmap(this.texture.impl._glTarget)}prepareTexture(){const t=this.update();return t&&this.generateMipmaps(),t}}class Wf{constructor(){this.bufferId=null}destroy(t){this.bufferId&&(t.gl.deleteBuffer(this.bufferId),this.bufferId=null)}loseContext(){this.bufferId=null}unlock(t,e,s,i){const n=t.gl;this.bufferId||(this.bufferId=n.createBuffer());let r;switch(e){case ve:r=n.STATIC_DRAW;break;case mr:r=n.DYNAMIC_DRAW;break;case my:r=n.STREAM_DRAW;break;case py:t.webgl2?r=n.DYNAMIC_COPY:r=n.STATIC_DRAW;break}n.bindBuffer(s,this.bufferId),n.bufferData(s,i,r)}}class vb extends Wf{constructor(...t){super(...t);this.vao=null}destroy(t){super.destroy(t),t.boundVao=null,t.gl.bindVertexArray(null)}loseContext(){super.loseContext(),this.vao=null}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ARRAY_BUFFER,t.storage)}}class Sb extends Wf{constructor(t){super();const e=t.device.gl,s=t.format;s===Gu?this.glFormat=e.UNSIGNED_BYTE:s===Is?this.glFormat=e.UNSIGNED_SHORT:s===Ii&&(this.glFormat=e.UNSIGNED_INT)}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ELEMENT_ARRAY_BUFFER,t.storage)}}class Gf{constructor(t,e,s,i){if(this.locationId=i,this.scopeId=t.scope.resolve(e),this.version=new gf,e.substr(e.length-3)==="[0]")switch(s){case Vh:s=uf;break;case Wh:s=ff;break;case Gh:s=mf;break;case Hh:s=pf;break}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}class bb{constructor(t){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null,this.compileAndLink(t.device,t),t.device.shaders.push(t)}destroy(t){const e=t.device,s=e.shaders.indexOf(t);s!==-1&&e.shaders.splice(s,1),this.glProgram&&(e.gl.deleteProgram(this.glProgram),this.glProgram=null,e.removeShaderFromCache(t))}restoreContext(t,e){this.compileAndLink(t,e)}compileAndLink(t,e){const s=e.definition,i=this._compileShaderSource(t,s.vshader,!0),n=this._compileShaderSource(t,s.fshader,!1),r=t.gl,a=r.createProgram();r.attachShader(a,i),r.attachShader(a,n);const l=s.attributes;if(t.webgl2&&s.useTransformFeedback){const c=[];for(const d in l)l.hasOwnProperty(d)&&c.push("out_"+d);r.transformFeedbackVaryings(a,c,r.INTERLEAVED_ATTRIBS)}const h={};for(const c in l)if(l.hasOwnProperty(c)){const d=l[c],u=yt[d];h[u]=c,r.bindAttribLocation(a,u,c)}r.linkProgram(a),this.glVertexShader=i,this.glFragmentShader=n,this.glProgram=a}_compileShaderSource(t,e,s){const i=t.gl,n=s?t.vertexShaderCache:t.fragmentShaderCache;let r=n[e];return r||(r=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(r,e),i.compileShader(r),n[e]=r),r}postLink(t,e){const s=t.gl,i=this.glProgram,n=e.definition;if(!this._isCompiled(t,e,this.glVertexShader,n.vshader,"vertex")||!this._isCompiled(t,e,this.glFragmentShader,n.fshader,"fragment"))return!1;if(!s.getProgramParameter(i,s.LINK_STATUS)){const u="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(u),!1}let r,a,l,h;r=0;const c=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(;r<c;)a=s.getActiveAttrib(i,r++),l=s.getAttribLocation(i,a.name),n.attributes[a.name]===void 0&&console.error(`Vertex shader attribute "${a.name}" is not mapped to a semantic in shader definition.`),h=new Gf(t,n.attributes[a.name],t.pcUniformType[a.type],l),this.attributes.push(h);r=0;const d=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(;r<d;)a=s.getActiveUniform(i,r++),l=s.getUniformLocation(i,a.name),h=new Gf(t,a.name,t.pcUniformType[a.type],l),a.type===s.SAMPLER_2D||a.type===s.SAMPLER_CUBE||t.webgl2&&(a.type===s.SAMPLER_2D_SHADOW||a.type===s.SAMPLER_CUBE_SHADOW||a.type===s.SAMPLER_3D)?this.samplers.push(h):this.uniforms.push(h);return e.ready=!0,!0}_isCompiled(t,e,s,i,n){const r=t.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=r.getShaderInfoLog(s),[l,h]=this._processError(i,a),c=`Failed to compile ${n} shader:

${a}
${l}`;return console.error(c),!1}return!0}_processError(t,e){if(!t)return"";const s=t.split(`
`),i={};let n="",r=0,a=s.length;if(e&&e.startsWith("ERROR:")){const l=e.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);l&&(i.message=l[3],i.line=parseInt(l[2],10),r=Math.max(0,i.line-6),a=Math.min(s.length,i.line+5))}for(let l=r;l<a;l++)n+=l+1+":	"+s[l]+`
`;return i.source=t,[n,i]}}function Hf(o,t){const e=o.width,s=o.height;if(e>t||s>t){const i=t/Math.max(e,s),n=Math.floor(e*i),r=Math.floor(s*i),a=document.createElement("canvas");return a.width=n,a.height=r,a.getContext("2d").drawImage(o,0,0,e,s,0,0,n,r),a}return o}class wb{constructor(){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0}destroy(t){if(this._glTexture){for(let e=0;e<t.textureUnits.length;e++){const s=t.textureUnits[e];for(let i=0;i<s.length;i++)s[i]===this._glTexture&&(s[i]=null)}t.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}initialize(t,e){const s=t.gl;let i;switch(this._glTexture=s.createTexture(),this._glTarget=e._cubemap?s.TEXTURE_CUBE_MAP:e._volume?s.TEXTURE_3D:s.TEXTURE_2D,e._format){case Mh:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case Ph:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case Ka:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case Za:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case Eh:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case Ja:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case Ls:this._glFormat=s.RGB,this._glInternalFormat=t.webgl2?s.RGB8:s.RGB,this._glPixelType=s.UNSIGNED_BYTE;break;case ct:this._glFormat=s.RGBA,this._glInternalFormat=t.webgl2?s.RGBA8:s.RGBA,this._glPixelType=s.UNSIGNED_BYTE;break;case dn:i=t.extCompressedTextureS3TC,this._glFormat=s.RGB,this._glInternalFormat=i.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case gr:i=t.extCompressedTextureS3TC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Li:i=t.extCompressedTextureS3TC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case Sr:i=t.extCompressedTextureETC1,this._glFormat=s.RGB,this._glInternalFormat=i.COMPRESSED_RGB_ETC1_WEBGL;break;case br:i=t.extCompressedTexturePVRTC,this._glFormat=s.RGB,this._glInternalFormat=i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case wr:i=t.extCompressedTexturePVRTC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case eo:i=t.extCompressedTexturePVRTC,this._glFormat=s.RGB,this._glInternalFormat=i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case so:i=t.extCompressedTexturePVRTC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case Lh:i=t.extCompressedTextureETC,this._glFormat=s.RGB,this._glInternalFormat=i.COMPRESSED_RGB8_ETC2;break;case Dh:i=t.extCompressedTextureETC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA8_ETC2_EAC;break;case Xu:i=t.extCompressedTextureASTC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case ju:i=t.extCompressedTextureATC,this._glFormat=s.RGB,this._glInternalFormat=i.COMPRESSED_RGB_ATC_WEBGL;break;case qu:i=t.extCompressedTextureATC,this._glFormat=s.RGBA,this._glInternalFormat=i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case yr:i=t.extTextureHalfFloat,this._glFormat=s.RGB,t.webgl2?(this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGB,this._glPixelType=i.HALF_FLOAT_OES);break;case ce:i=t.extTextureHalfFloat,this._glFormat=s.RGBA,t.webgl2?(this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGBA,this._glPixelType=i.HALF_FLOAT_OES);break;case xr:this._glFormat=s.RGB,t.webgl2?this._glInternalFormat=s.RGB32F:this._glInternalFormat=s.RGB,this._glPixelType=s.FLOAT;break;case Vt:this._glFormat=s.RGBA,t.webgl2?this._glInternalFormat=s.RGBA32F:this._glInternalFormat=s.RGBA,this._glPixelType=s.FLOAT;break;case Hu:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case vr:t.webgl2?(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT):(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT,this._glPixelType=s.UNSIGNED_SHORT);break;case Qa:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case to:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case Rh:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case Ih:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break}}upload(t,e){const s=t.gl;if(!e._needsUpload&&(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot))return;let i=0,n,r;const a=Math.log2(Math.max(e._width,e._height))+1;for(;e._levels[i]||i===0;){if(!e._needsUpload&&i===0){i++;continue}else if(i&&(!e._needsMipmapsUpload||!e._mipmaps))break;if(n=e._levels[i],i===1&&!e._compressed&&e._levels.length<a&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._cubemap){let l;if(t._isBrowserInterface(n[0]))for(l=0;l<6;l++){if(!e._levelsUpdated[0][l])continue;let h=n[l];h instanceof HTMLImageElement&&(h.width>t.maxCubeMapSize||h.height>t.maxCubeMapSize)&&(h=Hf(h,t.maxCubeMapSize),i===0&&(e._width=h.width,e._height=h.height)),t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,this._glFormat,this._glPixelType,h)}else for(r=1/Math.pow(2,i),l=0;l<6;l++){if(!e._levelsUpdated[0][l])continue;const h=n[l];e._compressed?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(e._width*r,1),Math.max(e._height*r,1),0,h):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,i,this._glInternalFormat,Math.max(e._width*r,1),Math.max(e._height*r,1),0,this._glFormat,this._glPixelType,h))}}else e._volume?(r=1/Math.pow(2,i),e._compressed?s.compressedTexImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(e._width*r,1),Math.max(e._height*r,1),Math.max(e._depth*r,1),0,n):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,i,this._glInternalFormat,Math.max(e._width*r,1),Math.max(e._height*r,1),Math.max(e._depth*r,1),0,this._glFormat,this._glPixelType,n))):(t._isBrowserInterface(n)?(n instanceof HTMLImageElement&&(n.width>t.maxTextureSize||n.height>t.maxTextureSize)&&(n=Hf(n,t.maxTextureSize),i===0&&(e._width=n.width,e._height=n.height)),t.setUnpackFlipY(e._flipY),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,this._glFormat,this._glPixelType,n)):(r=1/Math.pow(2,i),e._compressed?s.compressedTexImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(Math.floor(e._width*r),1),Math.max(Math.floor(e._height*r),1),0,n):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,i,this._glInternalFormat,Math.max(e._width*r,1),Math.max(e._height*r,1),0,this._glFormat,this._glPixelType,n))),i===0?e._mipmapsUploaded=!1:e._mipmapsUploaded=!0);i++}if(e._needsUpload)if(e._cubemap)for(let l=0;l<6;l++)e._levelsUpdated[0][l]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&e._mipmaps&&e._needsMipmapsUpload&&(e.pot||t.webgl2)&&e._levels.length===1&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize)}}class Tb{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}destroy(t){const e=t.gl;this._glFrameBuffer&&(e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(e.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(e.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}init(t,e){const s=t.gl;this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const i=e._colorBuffer;i&&(i.impl._glTexture||(i._width=Math.min(i.width,t.maxRenderBufferSize),i._height=Math.min(i.height,t.maxRenderBufferSize),t.setTexture(i,0)),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,i._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,i.impl._glTexture,0));const n=e._depthBuffer;if(n&&t.webgl2)n.impl._glTexture||(n._width=Math.min(n.width,t.maxRenderBufferSize),n._height=Math.min(n.height,t.maxRenderBufferSize),t.setTexture(n,0)),e._stencil?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,e._depthBuffer.impl._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,n._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,e._depthBuffer.impl._glTexture,0);else if(e._depth&&!(e._samples>1&&t.webgl2)){if(this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),e._stencil)s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer);else{const a=t.webgl2?s.DEPTH_COMPONENT32F:s.DEPTH_COMPONENT16;s.renderbufferStorage(s.RENDERBUFFER,a,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glDepthBuffer)}s.bindRenderbuffer(s.RENDERBUFFER,null)}t.webgl2&&e._samples>1&&(this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer),i&&(this._glMsaaColorBuffer||(this._glMsaaColorBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaColorBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,i.impl._glInternalFormat,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,this._glMsaaColorBuffer)),e._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer()),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),e._stencil?(s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,s.DEPTH24_STENCIL8,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer)):(s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,s.DEPTH_COMPONENT32F,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,this._glMsaaDepthBuffer))))}_checkFbo(t){const e=t.gl;switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case e.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");break;case e.FRAMEBUFFER_COMPLETE:break}}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null}resolve(t,e,s,i){if(t.webgl2){const n=t.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,this._glFrameBuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}}function Xf(o,t){let e=!0;const s=o.createTexture();o.bindTexture(o.TEXTURE_2D,s),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,2,2,0,o.RGBA,t,null);const i=o.createFramebuffer();return o.bindFramebuffer(o.FRAMEBUFFER,i),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,s,0),o.checkFramebufferStatus(o.FRAMEBUFFER)!==o.FRAMEBUFFER_COMPLETE&&(e=!1),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(s),o.bindFramebuffer(o.FRAMEBUFFER,null),o.deleteFramebuffer(i),e}function Cb(o,t){let e=!0;const s=o.createTexture();o.bindTexture(o.TEXTURE_2D,s),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);const i=new Uint16Array(4*2*2);return o.texImage2D(o.TEXTURE_2D,0,o.RGBA,2,2,0,o.RGBA,t,i),o.getError()!==o.NO_ERROR&&(e=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),o.bindTexture(o.TEXTURE_2D,null),o.deleteTexture(s),e}function Ab(o){if(!o.textureFloatRenderable)return!1;const t=we(o,F.fullscreenQuadVS,F.precisionTestPS,"ptest1"),e=we(o,F.fullscreenQuadVS,F.precisionTest2PS,"ptest2"),s={format:Vt,width:1,height:1,mipmaps:!1,minFilter:bt,magFilter:bt},i=new nt(o,s);i.name="testFHP";const n=new oe({colorBuffer:i,depth:!1});es(o,n,t),s.format=ct;const r=new nt(o,s);r.name="testFHP";const a=new oe({colorBuffer:r,depth:!1});o.constantTexSource.setValue(i),es(o,a,e);const l=o.activeFramebuffer;o.setFramebuffer(a.impl._glFrameBuffer);const h=new Uint8Array(4);o.readPixels(0,0,1,1,h),o.setFramebuffer(l);const c=h[0]/255,d=h[1]/255,u=h[2]/255,f=h[3]/255,m=c/(256*256*256)+d/(256*256)+u/256+f;return i.destroy(),n.destroy(),r.destroy(),a.destroy(),m===0}class Mb extends oc{constructor(t,e={}){super(t);this.gl=void 0,this.webgl2=void 0,this.defaultFramebuffer=null,this.updateClientRect(),this.contextLost=!1,this._contextLostHandler=p=>{p.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")},e.stencil=!0,e.powerPreference||(e.powerPreference="high-performance");const s=typeof navigator!="undefined"&&navigator.userAgent;this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(e.antialias=!1);const n=(e.preferWebGl2!==void 0?e.preferWebGl2:!0)?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];let r=null;for(let p=0;p<n.length;p++)if(r=t.getContext(n[p],e),r){this.webgl2=n[p]==="webgl2";break}if(!r)throw new Error("WebGL not supported");const a=Dt.browser&&!!window.chrome,l=Dt.browser&&navigator.appVersion.indexOf("Mac")!==-1;this.gl=r,this._tempEnableSafariTextureUnitWorkaround=Dt.browser&&!!window.safari,this._tempMacChromeBlitFramebufferWorkaround=l&&a&&!e.alpha,this.webgl2||vg(r),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:Ha|pr},this.glAddress=[r.REPEAT,r.CLAMP_TO_EDGE,r.MIRRORED_REPEAT],this.glBlendEquation=[r.FUNC_ADD,r.FUNC_SUBTRACT,r.FUNC_REVERSE_SUBTRACT,this.webgl2?r.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:r.FUNC_ADD,this.webgl2?r.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:r.FUNC_ADD],this.glBlendFunction=[r.ZERO,r.ONE,r.SRC_COLOR,r.ONE_MINUS_SRC_COLOR,r.DST_COLOR,r.ONE_MINUS_DST_COLOR,r.SRC_ALPHA,r.SRC_ALPHA_SATURATE,r.ONE_MINUS_SRC_ALPHA,r.DST_ALPHA,r.ONE_MINUS_DST_ALPHA,r.CONSTANT_COLOR,r.ONE_MINUS_CONSTANT_COLOR,r.CONSTANT_ALPHA,r.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[r.NEVER,r.LESS,r.EQUAL,r.LEQUAL,r.GREATER,r.NOTEQUAL,r.GEQUAL,r.ALWAYS],this.glStencilOp=[r.KEEP,r.ZERO,r.REPLACE,r.INCR,r.INCR_WRAP,r.DECR,r.DECR_WRAP,r.INVERT],this.glClearFlag=[0,r.COLOR_BUFFER_BIT,r.DEPTH_BUFFER_BIT,r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT,r.STENCIL_BUFFER_BIT,r.STENCIL_BUFFER_BIT|r.COLOR_BUFFER_BIT,r.STENCIL_BUFFER_BIT|r.DEPTH_BUFFER_BIT,r.STENCIL_BUFFER_BIT|r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT],this.glCull=[0,r.BACK,r.FRONT,r.FRONT_AND_BACK],this.glFilter=[r.NEAREST,r.LINEAR,r.NEAREST_MIPMAP_NEAREST,r.NEAREST_MIPMAP_LINEAR,r.LINEAR_MIPMAP_NEAREST,r.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[r.POINTS,r.LINES,r.LINE_LOOP,r.LINE_STRIP,r.TRIANGLES,r.TRIANGLE_STRIP,r.TRIANGLE_FAN],this.glType=[r.BYTE,r.UNSIGNED_BYTE,r.SHORT,r.UNSIGNED_SHORT,r.INT,r.UNSIGNED_INT,r.FLOAT],this.pcUniformType={},this.pcUniformType[r.BOOL]=Nh,this.pcUniformType[r.INT]=rf,this.pcUniformType[r.FLOAT]=Vh,this.pcUniformType[r.FLOAT_VEC2]=Wh,this.pcUniformType[r.FLOAT_VEC3]=Gh,this.pcUniformType[r.FLOAT_VEC4]=Hh,this.pcUniformType[r.INT_VEC2]=Xh,this.pcUniformType[r.INT_VEC3]=jh,this.pcUniformType[r.INT_VEC4]=qh,this.pcUniformType[r.BOOL_VEC2]=af,this.pcUniformType[r.BOOL_VEC3]=of,this.pcUniformType[r.BOOL_VEC4]=lf,this.pcUniformType[r.FLOAT_MAT2]=hf,this.pcUniformType[r.FLOAT_MAT3]=cf,this.pcUniformType[r.FLOAT_MAT4]=df,this.pcUniformType[r.SAMPLER_2D]=Ey,this.pcUniformType[r.SAMPLER_CUBE]=Ry,this.webgl2&&(this.pcUniformType[r.SAMPLER_2D_SHADOW]=Iy,this.pcUniformType[r.SAMPLER_CUBE_SHADOW]=Ly,this.pcUniformType[r.SAMPLER_3D]=Dy),this.targetToSlot={},this.targetToSlot[r.TEXTURE_2D]=0,this.targetToSlot[r.TEXTURE_CUBE_MAP]=1,this.targetToSlot[r.TEXTURE_3D]=2;let h,c,d,u,f;this.commitFunction=[],this.commitFunction[Nh]=function(p,_){p.value!==_&&(r.uniform1i(p.locationId,_),p.value=_)},this.commitFunction[rf]=this.commitFunction[Nh],this.commitFunction[Vh]=function(p,_){p.value!==_&&(r.uniform1f(p.locationId,_),p.value=_)},this.commitFunction[Wh]=function(p,_){f=p.value,h=_[0],c=_[1],(f[0]!==h||f[1]!==c)&&(r.uniform2fv(p.locationId,_),f[0]=h,f[1]=c)},this.commitFunction[Gh]=function(p,_){f=p.value,h=_[0],c=_[1],d=_[2],(f[0]!==h||f[1]!==c||f[2]!==d)&&(r.uniform3fv(p.locationId,_),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[Hh]=function(p,_){f=p.value,h=_[0],c=_[1],d=_[2],u=_[3],(f[0]!==h||f[1]!==c||f[2]!==d||f[3]!==u)&&(r.uniform4fv(p.locationId,_),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[Xh]=function(p,_){f=p.value,h=_[0],c=_[1],(f[0]!==h||f[1]!==c)&&(r.uniform2iv(p.locationId,_),f[0]=h,f[1]=c)},this.commitFunction[af]=this.commitFunction[Xh],this.commitFunction[jh]=function(p,_){f=p.value,h=_[0],c=_[1],d=_[2],(f[0]!==h||f[1]!==c||f[2]!==d)&&(r.uniform3iv(p.locationId,_),f[0]=h,f[1]=c,f[2]=d)},this.commitFunction[of]=this.commitFunction[jh],this.commitFunction[qh]=function(p,_){f=p.value,h=_[0],c=_[1],d=_[2],u=_[3],(f[0]!==h||f[1]!==c||f[2]!==d||f[3]!==u)&&(r.uniform4iv(p.locationId,_),f[0]=h,f[1]=c,f[2]=d,f[3]=u)},this.commitFunction[lf]=this.commitFunction[qh],this.commitFunction[hf]=function(p,_){r.uniformMatrix2fv(p.locationId,!1,_)},this.commitFunction[cf]=function(p,_){r.uniformMatrix3fv(p.locationId,!1,_)},this.commitFunction[df]=function(p,_){r.uniformMatrix4fv(p.locationId,!1,_)},this.commitFunction[uf]=function(p,_){r.uniform1fv(p.locationId,_)},this.commitFunction[ff]=function(p,_){r.uniform2fv(p.locationId,_)},this.commitFunction[mf]=function(p,_){r.uniform3fv(p.locationId,_)},this.commitFunction[pf]=function(p,_){r.uniform4fv(p.locationId,_)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let m=this.vertexUniformsCount;m-=4*4,m-=8,m-=1,m-=4*4,this.boneLimit=Math.floor(m/3),this.boneLimit=Math.min(this.boneLimit,128),this.unmaskedRenderer==="Mali-450 MP"&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=Xf(r,r.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=Xf(r,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore=this.maxPrecision==="highp"&&this.maxVertexTextures>=2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.grabPassAvailable=!0,this.grabPass=new xb(this,e.alpha),this.grabPass.create(),this.areaLightLutFormat=ct,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=ce:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=Vt)}destroy(){super.destroy();const t=this.gl;this.grabPass.destroy(),this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createVertexBufferImpl(t,e){return new vb}createIndexBufferImpl(t){return new Sb(t)}createShaderImpl(t){return new bb(t)}createTextureImpl(){return new wb}createRenderTargetImpl(t){return new Tb(t)}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=s.precision>0&&n.precision>0,l=i.precision>0&&r.precision>0;a||(l?e="mediump":e="lowp")}return e}initializeExtensions(){const t=this.gl,e=t.getSupportedExtensions(),s=function(){for(let n=0;n<arguments.length;n++)if(e.indexOf(arguments[n])!==-1)return t.getExtension(arguments[n]);return null};if(this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=s("EXT_color_buffer_float"),this.extDisjointTimerQuery=s("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query"),this.extDepthTexture=!0;else{if(this.extBlendMinmax=s("EXT_blend_minmax"),this.extDrawBuffers=s("EXT_draw_buffers"),this.extInstancing=s("ANGLE_instanced_arrays"),this.extInstancing){const i=this.extInstancing;t.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),t.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),t.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)}if(this.extStandardDerivatives=s("OES_standard_derivatives"),this.extTextureFloat=s("OES_texture_float"),this.extTextureHalfFloat=s("OES_texture_half_float"),this.extTextureLod=s("EXT_shader_texture_lod"),this.extUintElement=s("OES_element_index_uint"),this.extVertexArrayObject=s("OES_vertex_array_object"),this.extVertexArrayObject){const i=this.extVertexArrayObject;t.createVertexArray=i.createVertexArrayOES.bind(i),t.deleteVertexArray=i.deleteVertexArrayOES.bind(i),t.isVertexArray=i.isVertexArrayOES.bind(i),t.bindVertexArray=i.bindVertexArrayOES.bind(i)}this.extColorBufferFloat=null,this.extDisjointTimerQuery=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture")}this.extDebugRendererInfo=s("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=s("OES_texture_float_linear"),this.extTextureHalfFloatLinear=s("OES_texture_half_float_linear"),this.extFloatBlend=s("EXT_float_blend"),this.extTextureFilterAnisotropic=s("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=s("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=s("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=s("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=s("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=s("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=s("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=s("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=s("EXT_color_buffer_half_float")}initializeCapabilities(){const t=this.gl;let e;const s=typeof navigator!="undefined"?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const i=t.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(e=this.extDrawBuffers,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";const n=/SM-[a-zA-Z0-9]+\)/;this.supportsGpuParticles=!(this.unmaskedVendor==="ARM"&&s.match(n)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2&&!this.forceDisableMultisampling?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!Dt.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){const t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=Pt,this.blendDst=li,this.blendSrcAlpha=Pt,this.blendDstAlpha=li,this.separateAlphaBlend=!1,this.blendEquation=Nt,this.blendAlphaEquation=Nt,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.blendColor=new j(0,0,0,0),t.blendColor(0,0,0,0),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=cn,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=$a,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=Ri,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=ze,this.stencilZfailFront=this.stencilZfailBack=ze,this.stencilZpassFront=this.stencilZpassBack=ze,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new j(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){super.initializeContextCaches(),this.vertexShaderCache={},this.fragmentShaderCache={},this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();this.grabPass.destroy();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock();this.grabPass.create()}setViewport(t,e,s,i){(this.vx!==t||this.vy!==e||this.vw!==s||this.vh!==i)&&(this.gl.viewport(t,e,s,i),this.vx=t,this.vy=e,this.vw=s,this.vh=i)}setScissor(t,e,s,i){(this.sx!==t||this.sy!==e||this.sw!==s||this.sh!==i)&&(this.gl.scissor(t,e,s,i),this.sx=t,this.sy=e,this.sw=s,this.sh=i)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,s,i){const n=this.gl;if(!this.webgl2&&i)return!1;if(s){if(e){if(!t._colorBuffer||!e._colorBuffer||t._colorBuffer._format!==e._colorBuffer._format)return!1}else if(!t._colorBuffer)return!1}if(i&&(!t._depthBuffer||!e._depthBuffer||t._depthBuffer._format!==e._depthBuffer._format))return!1;if(this.webgl2&&e){const r=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t.impl._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e.impl._glFrameBuffer);const a=t?t.width:e.width,l=t?t.height:e.height;n.blitFramebuffer(0,0,a,l,0,0,a,l,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r.impl._glFrameBuffer:null)}else{const r=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),es(this,e,r)}return!0}initRenderTarget(t){t.impl._glFrameBuffer||(t.init(),this.targets.push(t))}getCopyShader(){if(!this._copyShader){const t=F.fullscreenQuadVS,e=F.outputTex2DPS;this._copyShader=we(this,t,e,"outputTex2D")}return this._copyShader}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let e=0;e<this.textureUnits.length;++e)for(let s=0;s<3;++s)this.textureUnits[e][s]=null;const t=this.renderTarget;t?t.impl._glFrameBuffer?this.setFramebuffer(t.impl._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){const t=this.gl;this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null));const e=this.renderTarget;if(e){const s=e._colorBuffer;s&&s.impl._glTexture&&s.mipmaps&&(s.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(s),t.generateMipmap(s.impl._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,s=e._glTarget,i=e._glTexture,n=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[n][r]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][r]=i)}bindTextureOnUnit(t,e){const s=t.impl,i=s._glTarget,n=s._glTexture,r=this.targetToSlot[i];this.textureUnits[e][r]!==n&&(this.activeTexture(e),this.gl.bindTexture(i,n),this.textureUnits[e][r]=n)}setTextureParameters(t){const e=this.gl,s=t._parameterFlags,i=t.impl._glTarget;if(s&1){let n=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&t._levels.length===1)&&(n===_r||n===ja?n=bt:(n===qa||n===Ei)&&(n=Yt)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,this.glFilter[n])}if(s&2&&e.texParameteri(i,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),s&4&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:et])),s&8&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:et])),s&16&&this.webgl2&&e.texParameteri(i,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),s&32&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),s&64&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),s&128){const n=this.extTextureFilterAnisotropic;n&&e.texParameterf(i,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}}setTexture(t,e){t.impl._glTexture||t.impl.initialize(this,t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload||t===this.grabPass.texture?(this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0),!(t===this.grabPass.texture&&this.grabPass.prepareTexture())&&(t._needsUpload||t._needsMipmapsUpload)&&(t.impl.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const i=t.length>1;if(i){e="";for(let n=0;n<t.length;n++){const r=t[n];e+=r.id+r.format.renderingingHash}s=this._vaoMap.get(e)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let r=0;r<t.length;r++){const a=t[r];n.bindBuffer(n.ARRAY_BUFFER,a.impl.bufferId);const l=a.format.elements;for(let h=0;h<l.length;h++){const c=l[h],d=yt[c.name];n.vertexAttribPointer(d,c.numComponents,this.glType[c.dataType],c.normalize,c.stride,c.offset),n.enableVertexAttribArray(d),a.instancing&&n.vertexAttribDivisor(d,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(e,s)}return s}setBuffers(){const t=this.gl;let e;if(this.vertexBuffers.length===1){const i=this.vertexBuffers[0];i.impl.vao||(i.impl.vao=this.createVertexArray(this.vertexBuffers)),e=i.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s)}draw(t,e,s){const i=this.gl;let n,r,a,l,h,c,d,u;const f=this.shader;if(!f)return;const m=f.impl.samplers,p=f.impl.uniforms;s||this.setBuffers();let _=0;for(let v=0,x=m.length;v<x;v++)if(n=m[v],r=n.scopeId.value,!!r)if(r instanceof nt)a=r,this.setTexture(a,_),n.slot!==_&&(i.uniform1i(n.locationId,_),n.slot=_),_++;else{n.array.length=0,l=r.length;for(let S=0;S<l;S++)a=r[S],this.setTexture(a,_),n.array[S]=_,_++;i.uniform1iv(n.locationId,n.array)}for(let v=0,x=p.length;v<x;v++)h=p[v],c=h.scopeId,d=h.version,u=c.versionObject.version,(d.globalId!==u.globalId||d.revision!==u.revision)&&(d.globalId=u.globalId,d.revision=u.revision,c.value!==null&&this.commitFunction[h.dataType](h,c.value));this.webgl2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const g=this.glPrimitive[t.type],w=t.count;if(t.indexed){const v=this.indexBuffer,x=v.impl.glFormat,S=t.base*v.bytesPerIndex;e>0?i.drawElementsInstanced(g,w,x,S,e):i.drawElements(g,w,x,S)}else{const v=t.base;e>0?i.drawArraysInstanced(g,v,w,e):i.drawArrays(g,v,w)}this.webgl2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){const e=this.defaultClearOptions;t=t||e;const s=t.flags==null?e.flags:t.flags;if(s!==0){const i=this.gl;if(s&Ha){const n=t.color==null?e.color:t.color;this.setClearColor(n[0],n[1],n[2],n[3])}if(s&pr){const n=t.depth==null?e.depth:t.depth;this.setClearDepth(n),this.depthWrite||i.depthMask(!0)}if(s&Vu){const n=t.stencil==null?e.stencil:t.stencil;this.setClearStencil(n)}i.clear(this.glClearFlag[s]),s&pr&&(this.depthWrite||i.depthMask(!1))}}readPixels(t,e,s,i,n){const r=this.gl;r.readPixels(t,e,s,i,r.RGBA,r.UNSIGNED_BYTE,n)}setClearDepth(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)}setClearColor(t,e,s,i){const n=this.clearColor;(t!==n.r||e!==n.g||s!==n.b||i!==n.a)&&(this.gl.clearColor(t,e,s,i),this.clearColor.set(t,e,s,i))}setClearStencil(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)}getDepthTest(){return this.depthTest}setDepthTest(t){if(this.depthTest!==t){const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}}setDepthFunc(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)}getDepthWrite(){return this.depthWrite}setDepthWrite(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)}setColorWrite(t,e,s,i){(this.writeRed!==t||this.writeGreen!==e||this.writeBlue!==s||this.writeAlpha!==i)&&(this.gl.colorMask(t,e,s,i),this.writeRed=t,this.writeGreen=e,this.writeBlue=s,this.writeAlpha=i)}setAlphaToCoverage(t){!this.webgl2||this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}getBlending(){return this.blending}setBlending(t){if(this.blending!==t){const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s||this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s)&&(this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,i){(this.stencilFailFront!==t||this.stencilZfailFront!==e||this.stencilZpassFront!==s||this.stencilFailBack!==t||this.stencilZfailBack!==e||this.stencilZpassBack!==s)&&(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),(this.stencilWriteMaskFront!==i||this.stencilWriteMaskBack!==i)&&(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(t,e,s,i){(this.stencilFailFront!==t||this.stencilZfailFront!==e||this.stencilZpassFront!==s)&&(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(t,e,s,i){(this.stencilFailBack!==t||this.stencilZfailBack!==e||this.stencilZpassBack!==s)&&(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendFunction(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)}setBlendFunctionSeparate(t,e,s,i){(this.blendSrc!==t||this.blendDst!==e||this.blendSrcAlpha!==s||this.blendDstAlpha!==i||!this.separateAlphaBlend)&&(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[s],this.glBlendFunction[i]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=s,this.blendDstAlpha=i,this.separateAlphaBlend=!0)}setBlendEquation(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)}setBlendEquationSeparate(t,e){(this.blendEquation!==t||this.blendAlphaEquation!==e||!this.separateAlphaEquation)&&(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)}setBlendColor(t,e,s,i){const n=this.blendColor;(t!==n.r||e!==n.g||s!==n.b||i!==n.a)&&(this.gl.blendColor(t,e,s,i),n.set(t,e,s,i))}setCullMode(t){if(this.cullMode!==t){if(t===me)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===me&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}getCullMode(){return this.cullMode}setIndexBuffer(t){this.indexBuffer=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}setShader(t){if(t!==this.shader){if(t.failed)return!1;if(!t.ready&&!t.impl.postLink(this,t))return t.failed=!0,!1;this.shader=t,this.gl.useProgram(t.impl.glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(){return this.textureHalfFloatRenderable?ce:this.textureFloatRenderable?Vt:ct}getBoneLimit(){return this.boneLimit}setBoneLimit(t){this.boneLimit=t}clearShaderCache(){const t=this.gl;for(const e in this.fragmentShaderCache)t.deleteShader(this.fragmentShaderCache[e]),delete this.fragmentShaderCache[e];for(const e in this.vertexShaderCache)t.deleteShader(this.vertexShaderCache[e]),delete this.vertexShaderCache[e];this.programLib.clearCache()}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach((e,s,i)=>{t.deleteVertexArray(e)}),this._vaoMap.clear()}removeShaderFromCache(t){this.programLib.removeFromCache(t)}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(t){t?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return this._textureFloatHighPrecision===void 0&&(this._textureFloatHighPrecision=Ab(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return this._textureHalfFloatUpdatable===void 0&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=Cb(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}class lc{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}let jf;function Ne(){return jf}function hc(o){jf=o}let Pb=0;class ws{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=ve,this.indicesUsage=ve,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}}ws.DEFAULT_COMPONENTS_POSITION=3;ws.DEFAULT_COMPONENTS_NORMAL=3;ws.DEFAULT_COMPONENTS_UV=2;ws.DEFAULT_COMPONENTS_COLORS=4;class Eb{constructor(t,e,s,i){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=i}}class is extends lc{constructor(t){super();this.id=Pb++,this.device=t||Ne().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this._aabb=new gt,this.boneAabb=null}set morph(t){t!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=t,t&&t.incRefCount())}get morph(){return this._morph}set aabb(t){this._aabb=t}get aabb(){return this._aabb}destroy(){const t=this.morph;t&&(this.morph=null,t.refCount<1&&t.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){this.boneAabb=[],this.boneUsed=[];let e,s,i,n,r;const a=[],l=[],h=this.boneUsed,c=this.skin.boneNames.length;let d,u,f;for(let x=0;x<c;x++)a[x]=new y(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l[x]=new y(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const m=new Nr(this.vertexBuffer),p=m.element[Ot],_=m.element[Ss],g=m.element[Se],w=this.vertexBuffer.numVertices;for(let x=0;x<w;x++){for(let S=0;S<4;S++)if(_.array[_.index+S]>0){const b=g.array[g.index+S];if(h[b]=!0,e=p.array[p.index],s=p.array[p.index+1],i=p.array[p.index+2],n=l[b],r=a[b],r.x>e&&(r.x=e),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<e&&(n.x=e),n.y<s&&(n.y=s),n.z<i&&(n.z=i),t){let C=d=e,M=u=s,E=f=i;for(let D=0;D<t.length;D++){const I=t[D],k=I.deltaPositions[x*3],N=I.deltaPositions[x*3+1],X=I.deltaPositions[x*3+2];k<0?C+=k:d+=k,N<0?M+=N:u+=N,X<0?E+=X:f+=X}r.x>C&&(r.x=C),r.y>M&&(r.y=M),r.z>E&&(r.z=E),n.x<d&&(n.x=d),n.y<u&&(n.y=u),n.z<f&&(n.z=f)}}m.next()}const v=this.vertexBuffer.getFormat().elements.find(x=>x.name===Ot);if(v&&v.normalize){const x=(()=>{switch(v.dataType){case mo:return S=>Math.max(S/127,-1);case ci:return S=>S/255;case po:return S=>Math.max(S/32767,-1);case fn:return S=>S/65535;default:return S=>S}})();for(let S=0;S<c;S++)if(h[S]){const T=a[S],b=l[S];T.set(x(T.x),x(T.y),x(T.z)),b.set(x(b.x),x(b.y),x(b.z))}}for(let x=0;x<c;x++){const S=new gt;S.setMinMax(a[x],l[x]),this.boneAabb.push(S)}}_initGeometryData(){this._geometryData||(this._geometryData=new ws,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=t?ve:mr,this._geometryData.indicesUsage=e?ve:mr}setVertexStream(t,e,s,i,n=wt,r=!1){this._initGeometryData();const a=i||e.length/s;this._geometryData._changeVertexCount(a,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new Eb(e,s,n,r)}getVertexStream(t,e){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[t];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}return i||this.vertexBuffer&&(s=new Nr(this.vertexBuffer).readData(t,e)),s}setPositions(t,e=ws.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(Ot,t,e,s,wt,!1)}setNormals(t,e=ws.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(pe,t,e,s,wt,!1)}setUvs(t,e,s=ws.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(Ku+t,e,s,i,wt,!1)}setColors(t,e=ws.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(de,t,e,s,wt,!1)}setColors32(t,e){this.setVertexStream(de,t,ws.DEFAULT_COMPONENTS_COLORS,e,ci,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream(Ot,t)}getNormals(t){return this.getVertexStream(pe,t)}getUvs(t,e){return this.getVertexStream(Ku+t,e)}getColors(t){return this.getVertexStream(de,t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;e=this._geometryData.indexCount,ArrayBuffer.isView(t)?t.set(s):(t.length=0,t.push(s))}else this.indexBuffer.length>0&&this.indexBuffer[0]&&(e=this.indexBuffer[0].readData(t));return e}update(t=ts,e=!0){if(this._geometryData){if(e){const n=this._geometryData.vertexStreamDictionary[Ot];n&&n.componentCount===3&&this._aabb.compute(n.data,this._geometryData.vertexCount)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.push({semantic:s,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize})}return new re(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const s=this._geometryData.maxVertices,i=this._buildVertexFormat(s);this.vertexBuffer=new Ds(this.device,i,s,this._geometryData.verticesUsage)}const t=new Nr(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.writeData(s,i.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const e=this._geometryData.maxVertices>65535?Ii:Is;this.indexBuffer[0]=new ui(this.device,e,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const t=this._geometryData.indices;t&&(this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(t){t===Mi?this.generateWireframe():t===Pa&&(this.primitive[Pa]={type:Tr,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[Pa]&&this.prepareRenderState(Pa),this.primitive[Mi]&&this.prepareRenderState(Mi)}generateWireframe(){this._destroyIndexBuffer(Mi);const t=[];let e;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const n=[[0,1],[1,2],[2,0]],r=this.primitive[cr].base,a=this.primitive[cr].count,l=this.indexBuffer[cr],h=new Yh[l.format](l.storage),c={};for(let d=r;d<r+a;d+=3)for(let u=0;u<3;u++){const f=h[d+n[u][0]],m=h[d+n[u][1]],p=f>m?m<<16|f:f<<16|m;c[p]===void 0&&(c[p]=0,t.push(f,m))}e=l.format}else{for(let n=0;n<this.vertexBuffer.numVertices;n+=3)t.push(n,n+1,n+1,n+2,n+2,n);e=t.length>65535?Ii:Is}const s=new ui(this.vertexBuffer.device,e,t.length);new Yh[s.format](s.storage).set(t),s.unlock(),this.primitive[Mi]={type:io,base:0,count:t.length,indexed:!0},this.indexBuffer[Mi]=s}}const Pe=4/64,Ve=1-Pe*2,Vr=[];function Rb(o,t){const e=t.length/3,s=o.length/3,i=new y,n=new y,r=new y,a=new y,l=new y,h=new y,c=[];for(let d=0;d<o.length;d++)c[d]=0;for(let d=0;d<e;d++){const u=t[d*3],f=t[d*3+1],m=t[d*3+2];i.set(o[u*3],o[u*3+1],o[u*3+2]),n.set(o[f*3],o[f*3+1],o[f*3+2]),r.set(o[m*3],o[m*3+1],o[m*3+2]),a.sub2(n,i),l.sub2(r,i),h.cross(a,l).normalize(),c[u*3]+=h.x,c[u*3+1]+=h.y,c[u*3+2]+=h.z,c[f*3]+=h.x,c[f*3+1]+=h.y,c[f*3+2]+=h.z,c[m*3]+=h.x,c[m*3+1]+=h.y,c[m*3+2]+=h.z}for(let d=0;d<s;d++){const u=c[d*3],f=c[d*3+1],m=c[d*3+2],p=1/Math.sqrt(u*u+f*f+m*m);c[d*3]*=p,c[d*3+1]*=p,c[d*3+2]*=p}return c}function xn(o,t,e,s){const i=s.length/3,n=o.length/3,r=new y,a=new y,l=new y,h=new H,c=new H,d=new H,u=new y,f=new y,m=new Float32Array(n*3),p=new Float32Array(n*3),_=[];for(let S=0;S<i;S++){const T=s[S*3],b=s[S*3+1],C=s[S*3+2];r.set(o[T*3],o[T*3+1],o[T*3+2]),a.set(o[b*3],o[b*3+1],o[b*3+2]),l.set(o[C*3],o[C*3+1],o[C*3+2]),h.set(e[T*2],e[T*2+1]),c.set(e[b*2],e[b*2+1]),d.set(e[C*2],e[C*2+1]);const M=a.x-r.x,E=l.x-r.x,D=a.y-r.y,I=l.y-r.y,k=a.z-r.z,N=l.z-r.z,X=c.x-h.x,q=d.x-h.x,A=c.y-h.y,R=d.y-h.y,L=X*R-q*A;if(L===0)u.set(0,1,0),f.set(1,0,0);else{const O=1/L;u.set((R*M-A*E)*O,(R*D-A*I)*O,(R*k-A*N)*O),f.set((X*E-q*M)*O,(X*I-q*D)*O,(X*N-q*k)*O)}m[T*3+0]+=u.x,m[T*3+1]+=u.y,m[T*3+2]+=u.z,m[b*3+0]+=u.x,m[b*3+1]+=u.y,m[b*3+2]+=u.z,m[C*3+0]+=u.x,m[C*3+1]+=u.y,m[C*3+2]+=u.z,p[T*3+0]+=f.x,p[T*3+1]+=f.y,p[T*3+2]+=f.z,p[b*3+0]+=f.x,p[b*3+1]+=f.y,p[b*3+2]+=f.z,p[C*3+0]+=f.x,p[C*3+1]+=f.y,p[C*3+2]+=f.z}const g=new y,w=new y,v=new y,x=new y;for(let S=0;S<n;S++){v.set(t[S*3],t[S*3+1],t[S*3+2]),g.set(m[S*3],m[S*3+1],m[S*3+2]),w.set(p[S*3],p[S*3+1],p[S*3+2]);const T=v.dot(g);x.copy(v).mulScalar(T),x.sub2(g,x).normalize(),_[S*4]=x.x,_[S*4+1]=x.y,_[S*4+2]=x.z,x.cross(v,g),_[S*4+3]=x.dot(w)<0?-1:1}return _}function Os(o,t,e){const s=new is(o);return s.setPositions(t),e&&(e.normals&&s.setNormals(e.normals),e.tangents&&s.setVertexStream(vs,e.tangents,4),e.colors&&s.setColors32(e.colors),e.uvs&&s.setUvs(0,e.uvs),e.uvs1&&s.setUvs(1,e.uvs1),e.blendIndices&&s.setVertexStream(Se,e.blendIndices,4,e.blendIndices.length/4,ci),e.blendWeights&&s.setVertexStream(Ss,e.blendWeights,4),e.indices&&s.setIndices(e.indices)),s.update(),s}function cc(o,t,e,s,i,n){const r=new y,a=new y,l=new y,h=new y,c=new y,d=new y,u=[],f=[],m=[],p=[],_=[];let g;if(e>0)for(let w=0;w<=s;w++)for(let v=0;v<=i;v++){const x=v/i*2*Math.PI-Math.PI,S=Math.sin(x),T=Math.cos(x);c.set(S*o,-e/2,T*o),h.set(S*t,e/2,T*t),r.lerp(c,h,w/s),a.sub2(h,c).normalize(),d.set(T,0,-S),l.cross(d,a).normalize(),u.push(r.x,r.y,r.z),f.push(l.x,l.y,l.z);let b=v/i,C=w/s;m.push(b,1-C);const M=C;if(C=b,b=M,b=b*Ve+Pe,C=C*Ve+Pe,b/=3,p.push(b,1-C),w<s&&v<i){const E=w*(i+1)+v,D=w*(i+1)+(v+1),I=(w+1)*(i+1)+v,k=(w+1)*(i+1)+(v+1);_.push(E,D,I),_.push(D,k,I)}}if(n){const w=Math.floor(i/2),v=i,x=e/2;for(let S=0;S<=w;S++){const T=S*Math.PI*.5/w,b=Math.sin(T),C=Math.cos(T);for(let M=0;M<=v;M++){const E=M*2*Math.PI/v-Math.PI/2,D=Math.sin(E),k=Math.cos(E)*b,N=C,X=D*b;let q=1-M/v,A=1-S/w;u.push(k*t,N*t+x,X*t),f.push(k,N,X),m.push(q,1-A),q=q*Ve+Pe,A=A*Ve+Pe,q/=3,A/=3,q+=1/3,p.push(q,1-A)}}g=(s+1)*(i+1);for(let S=0;S<w;++S)for(let T=0;T<v;++T){const b=S*(v+1)+T,C=b+v+1;_.push(g+b+1,g+C,g+b),_.push(g+b+1,g+C+1,g+C)}for(let S=0;S<=w;S++){const T=Math.PI*.5+S*Math.PI*.5/w,b=Math.sin(T),C=Math.cos(T);for(let M=0;M<=v;M++){const E=M*2*Math.PI/v-Math.PI/2,D=Math.sin(E),k=Math.cos(E)*b,N=C,X=D*b;let q=1-M/v,A=1-S/w;u.push(k*t,N*t-x,X*t),f.push(k,N,X),m.push(q,1-A),q=q*Ve+Pe,A=A*Ve+Pe,q/=3,A/=3,q+=2/3,p.push(q,1-A)}}g=(s+1)*(i+1)+(v+1)*(w+1);for(let S=0;S<w;++S)for(let T=0;T<v;++T){const b=S*(v+1)+T,C=b+v+1;_.push(g+b+1,g+C,g+b),_.push(g+b+1,g+C+1,g+C)}}else{if(g=(s+1)*(i+1),o>0)for(let w=0;w<i;w++){const v=w/i*2*Math.PI,x=Math.sin(v),S=-e/2,T=Math.cos(v);let b=1-(x+1)/2,C=(T+1)/2;u.push(x*o,S,T*o),f.push(0,-1,0),m.push(b,1-C),b=b*Ve+Pe,C=C*Ve+Pe,b/=3,C/=3,b+=1/3,p.push(b,1-C),w>1&&_.push(g,g+w,g+w-1)}if(g+=i,t>0)for(let w=0;w<i;w++){const v=w/i*2*Math.PI,x=Math.sin(v),S=e/2,T=Math.cos(v);let b=1-(x+1)/2,C=(T+1)/2;u.push(x*t,S,T*t),f.push(0,1,0),m.push(b,1-C),b=b*Ve+Pe,C=C*Ve+Pe,b/=3,C/=3,b+=2/3,p.push(b,1-C),w>1&&_.push(g,g+w-1,g+w)}}return{positions:u,normals:f,uvs:m,uvs1:p,indices:_}}function Ib(o,t){let e=t&&(t.radius||t.baseRadius);e=e!==void 0?e:.5;const s=t&&t.height!==void 0?t.height:1,i=t&&t.heightSegments!==void 0?t.heightSegments:5,n=t&&t.capSegments!==void 0?t.capSegments:20,r=t&&t.calculateTangents!==void 0?t.calculateTangents:!1,a=cc(e,e,s,i,n,!1);return r&&(a.tangents=xn(a.positions,a.normals,a.uvs,a.indices)),Os(o,a.positions,a)}function Lb(o,t){const e=t&&t.radius!==void 0?t.radius:.3,s=t&&t.height!==void 0?t.height:1,i=t&&t.heightSegments!==void 0?t.heightSegments:1,n=t&&t.sides!==void 0?t.sides:20,r=t&&t.calculateTangents!==void 0?t.calculateTangents:!1,a=cc(e,e,s-2*e,i,n,!0);return r&&(a.tangents=xn(a.positions,a.normals,a.uvs,a.indices)),Os(o,a.positions,a)}function Db(o,t){const e=t&&t.baseRadius!==void 0?t.baseRadius:.5,s=t&&t.peakRadius!==void 0?t.peakRadius:0,i=t&&t.height!==void 0?t.height:1,n=t&&t.heightSegments!==void 0?t.heightSegments:5,r=t&&t.capSegments!==void 0?t.capSegments:18,a=t&&t.calculateTangents!==void 0?t.calculateTangents:!1,l=cc(e,s,i,n,r,!1);return a&&(l.tangents=xn(l.positions,l.normals,l.uvs,l.indices)),Os(o,l.positions,l)}function Fb(o,t){const e=t&&t.radius!==void 0?t.radius:.5,s=t&&t.latitudeBands!==void 0?t.latitudeBands:16,i=t&&t.longitudeBands!==void 0?t.longitudeBands:16,n=t&&t.calculateTangents!==void 0?t.calculateTangents:!1,r=[],a=[],l=[],h=[];for(let d=0;d<=s;d++){const u=d*Math.PI/s,f=Math.sin(u),m=Math.cos(u);for(let p=0;p<=i;p++){const _=p*2*Math.PI/i-Math.PI/2,g=Math.sin(_),v=Math.cos(_)*f,x=m,S=g*f,T=1-p/i,b=1-d/s;r.push(v*e,x*e,S*e),a.push(v,x,S),l.push(T,1-b)}}for(let d=0;d<s;++d)for(let u=0;u<i;++u){const f=d*(i+1)+u,m=f+i+1;h.push(f+1,m,f),h.push(f+1,m+1,m)}const c={normals:a,uvs:l,uvs1:l,indices:h};return n&&(c.tangents=xn(r,a,l,h)),Os(o,r,c)}function Ob(o,t){const e=t&&t.halfExtents!==void 0?t.halfExtents:new H(.5,.5),s=t&&t.widthSegments!==void 0?t.widthSegments:5,i=t&&t.lengthSegments!==void 0?t.lengthSegments:5,n=t&&t.calculateTangents!==void 0?t.calculateTangents:!1,r=[],a=[],l=[],h=[];let c=0;for(let u=0;u<=s;u++)for(let f=0;f<=i;f++){const m=-e.x+2*e.x*u/s,p=0,_=-(-e.y+2*e.y*f/i),g=u/s,w=f/i;r.push(m,p,_),a.push(0,1,0),l.push(g,1-w),u<s&&f<i&&(h.push(c+i+1,c+1,c),h.push(c+i+1,c+i+2,c+1)),c++}const d={normals:a,uvs:l,uvs1:l,indices:h};return n&&(d.tangents=xn(r,a,l,h)),Os(o,r,d)}function qf(o,t){const e=t&&t.halfExtents!==void 0?t.halfExtents:new y(.5,.5,.5),s=t&&t.widthSegments!==void 0?t.widthSegments:1,i=t&&t.lengthSegments!==void 0?t.lengthSegments:1,n=t&&t.heightSegments!==void 0?t.heightSegments:1,r=t&&t.calculateTangents!==void 0?t.calculateTangents:!1,a=[new y(-e.x,-e.y,e.z),new y(e.x,-e.y,e.z),new y(e.x,e.y,e.z),new y(-e.x,e.y,e.z),new y(e.x,-e.y,-e.z),new y(-e.x,-e.y,-e.z),new y(-e.x,e.y,-e.z),new y(e.x,e.y,-e.z)],l=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],c={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},d=[],u=[],f=[],m=[],p=[];let _=0;const g=(v,x,S)=>{const T=new y,b=new y,C=new y,M=new y;for(let E=0;E<=x;E++)for(let D=0;D<=S;D++){T.lerp(a[l[v][0]],a[l[v][1]],E/x),b.lerp(a[l[v][0]],a[l[v][2]],D/S),C.sub2(b,a[l[v][0]]),M.add2(T,C);let I=E/x,k=D/S;d.push(M.x,M.y,M.z),u.push(h[v][0],h[v][1],h[v][2]),f.push(I,1-k),I=I*Ve+Pe,k=k*Ve+Pe,I/=3,k/=3,I+=v%3/3,k+=Math.floor(v/3)/3,m.push(I,1-k),E<x&&D<S&&(p.push(_+S+1,_+1,_),p.push(_+S+1,_+S+2,_+1)),_++}};g(c.FRONT,s,n),g(c.BACK,s,n),g(c.TOP,s,i),g(c.BOTTOM,s,i),g(c.RIGHT,i,n),g(c.LEFT,i,n);const w={normals:u,uvs:f,uvs1:m,indices:p};return r&&(w.tangents=xn(d,u,f,p)),Os(o,d,w)}function Yf(o,t){let e=null;for(let s=0;s<Vr.length;s++)Vr[s].type===t&&Vr[s].device===o&&(e=Vr[s].primData);if(!e){let s,i;switch(t){case"box":s=qf(o,{halfExtents:new y(.5,.5,.5)}),i={x:2,y:2,z:2,uv:2/3};break;case"capsule":s=Lb(o,{radius:.5,height:2}),i={x:Math.PI*2,y:Math.PI,z:Math.PI*2,uv:1/3+1/3/3*2};break;case"cone":s=Db(o,{baseRadius:.5,peakRadius:0,height:1}),i={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":s=Ib(o,{radius:.5,height:1}),i={x:Math.PI,y:.79*2,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":s=Ob(o,{halfExtents:new H(.5,.5),widthSegments:1,lengthSegments:1}),i={x:0,y:1,z:0,uv:1};break;case"sphere":s=Fb(o,{radius:.5}),i={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}s.incRefCount(),e={mesh:s,area:i},Vr.push({type:t,device:o,primData:e})}return e}class Bb extends Ue{constructor(){super();this.color=new j(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(t){return super.copy(t),this.color.copy(t.color),this.colorMap=t.colorMap,this.vertexColors=t.vertexColors,this}updateUniforms(t,e){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}updateShader(t,e,s,i,n,r){const a={skin:s&&(s&La)!=0,screenSpace:s&&(s&Fa)!=0,useInstancing:s&&(s&Iu)!=0,useMorphPosition:s&&(s&Oa)!=0,useMorphNormal:s&&(s&Ba)!=0,useMorphTextureBased:s&&(s&ka)!=0,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},l=t.getProgramLibrary();this.shader=l.getProgram("basic",a)}}class dc{constructor(t,e,s){this.origMeshInstances=t,this._aabb=new gt,this.meshInstance=null,this.dynamic=e,this.batchGroupId=s}destroy(t,e){this.meshInstance&&(this.removeFromLayers(t,e),this.meshInstance.destroy())}addToLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.addMeshInstances([this.meshInstance])}}removeFromLayers(t,e){for(let s=0;s<e.length;s++){const i=t.layers.getLayerById(e[s]);i&&i.removeMeshInstances([this.meshInstance])}}updateBoundingBox(){this._aabb.copy(this.origMeshInstances[0].aabb);for(let t=1;t<this.origMeshInstances.length;t++)this._aabb.add(this.origMeshInstances[t].aabb);this.meshInstance.aabb=this._aabb,this.meshInstance._aabbVer=0}}class Wt{constructor(t,e,s,i,n=[xe]){this.dynamic=s,this.maxAabbSize=i,this.id=t,this.name=e,this.layers=n,this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]}}}Wt.MODEL="model";Wt.ELEMENT="element";Wt.SPRITE="sprite";Wt.RENDER="render";const $f=new G;class Wr{constructor(t){this.bones=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}set rootBone(t){this._rootBone=t}get rootBone(){return this._rootBone}init(t,e){if(t.supportsBoneTextures){const s=e*3;let i=Math.ceil(Math.sqrt(s));i=U.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new nt(t,{width:i,height:n,format:Vt,mipmaps:!1,minFilter:bt,magFilter:bt}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(e*12)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(t,e){this.rootBone=t;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const r=s.boneNames[n];let a=t.findByName(r);a||(a=e),i.push(a)}this.bones=i}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let s=0;s<e;s++)this.matrices[s]=new G}uploadBones(t){t.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,$f.copy(t.getWorldTransform()).invert();for(let s=this.bones.length-1;s>=0;s--)this.matrices[s].mulAffine2($f,this.bones[s].getWorldTransform()),this.matrices[s].mulAffine2(this.matrices[s],this.skin.inverseBindPose[s])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const r=this.matrices[n].data,a=n*12;s[a]=r[0],s[a+1]=r[4],s[a+2]=r[8],s[a+3]=r[12],s[a+4]=r[1],s[a+5]=r[5],s[a+6]=r[9],s[a+7]=r[13],s[a+8]=r[2],s[a+9]=r[6],s[a+10]=r[10],s[a+11]=r[14]}this.uploadBones(this.skin.device)}}class Kf extends Wr{constructor(t,e,s){super();const i=e.length;this.init(t,i),this.device=t,this.rootNode=s,this.bones=e}updateMatrices(t,e){}updateMatrixPalette(t,e){const s=this.matrixPalette,i=this.bones.length;for(let n=0;n<i;n++){const r=this.bones[n].getWorldTransform().data,a=n*12;s[a]=r[0],s[a+1]=r[4],s[a+2]=r[8],s[a+3]=r[12],s[a+4]=r[1],s[a+5]=r[5],s[a+6]=r[9],s[a+7]=r[13],s[a+8]=r[2],s[a+9]=r[6],s[a+10]=r[10],s[a+11]=r[14]}this.uploadBones(this.device)}}class kb{constructor(){this.cache=new Map}destroy(){this.cache.forEach((t,e)=>{e.destroy()}),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,e===0?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}}class Bs{static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}Bs.cache=new kb;const zb=new gt,To=new gt,uc=new Ci,fc=new Set;class Ub{constructor(t){this.vertexBuffer=null,this.count=t}}class vt{constructor(t,e,s=null){if(this._material=void 0,t instanceof xt){const i=t;t=e,e=s,s=i}this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,this._shaderDefs=xs<<16,this._shaderDefs|=t.vertexBuffer.format.hasUv0?Pu:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?Eu:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?Ru:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?Lu:0,this._lightHash=0,this.visible=!0,this.layer=Tu,this._renderStyle=cr,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new gt,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFaces=!1}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=zb,this.skinInstance){if(!this.mesh.boneAabb){const n=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(n)}const s=this.mesh.boneUsed;let i=!0;for(let n=0;n<this.mesh.boneAabb.length;n++)s[n]&&(To.setFromTransformedAabb(this.mesh.boneAabb[n],this.skinInstance.matrices[n]),i?(i=!1,t.center.copy(To.center),t.halfExtents.copy(To.halfExtents)):t.add(To));e=!0}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&t._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),e=!0,this._aabbVer=this.node._aabbVer);return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}set material(t){for(let s=0;s<this._shader.length;s++)this._shader[s]=null;const e=this._material;if(e&&e.removeMeshInstanceRef(this),this._material=t,this._material){this._material.addMeshInstanceRef(this),this.updateKey();const s=e&&e.blendType!==he,i=this._material.blendType!==he;if(s!==i){let n=this._material._scene;!n&&e&&e._scene&&(n=e._scene),n?n.layers._dirtyBlend=!0:this._material._dirtyBlend=!0}}}get material(){return this._material}set layer(t){this._layer=t,this.updateKey()}get layer(){return this._layer}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow=t,this._shaderDefs=t?this._shaderDefs&~_h:this._shaderDefs|_h,this._shader[on]=null,this._shader[Qe]=null}get receiveShadow(){return this._receiveShadow}set skinInstance(t){this._skinInstance=t,this._shaderDefs=t?this._shaderDefs|La:this._shaderDefs&~La;for(let e=0;e<this._shader.length;e++)this._shader[e]=null;this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){this._morphInstance=t,this._morphInstance&&(this._morphInstance.meshInstance=this),this._shaderDefs=t&&t.morph.useTextureMorph?this._shaderDefs|ka:this._shaderDefs&~ka,this._shaderDefs=t&&t.morph.morphPositions?this._shaderDefs|Oa:this._shaderDefs&~Oa,this._shaderDefs=t&&t.morph.morphNormals?this._shaderDefs|Ba:this._shaderDefs&~Ba;for(let e=0;e<this._shader.length;e++)this._shader[e]=null}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|Fa:this._shaderDefs&~Fa,this._shader[on]=null}get screenSpace(){return this._screenSpace}set key(t){this._key[Ps]=t}get key(){return this._key[Ps]}set mask(t){const e=this._shaderDefs&65535;this._shaderDefs=e|t<<16,this._shader[on]=null,this._shader[Qe]=null}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){const t=this.mesh;t&&(this.mesh=null,t.refCount<1&&t.destroy()),this.setRealtimeLightmap(vt.lightmapParamNames[0],null),this.setRealtimeLightmap(vt.lightmapParamNames[1],null),this._skinInstance&&(this._skinInstance.destroy(),this._skinInstance=null),this.morphInstance&&(this.morphInstance.destroy(),this.morphInstance=null),this.material=null}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const i=t[s].mesh;fc.has(i)||(fc.add(i),i.prepareRenderState(e))}fc.clear()}}_isVisible(t){return this.visible?this.isVisibleFunc?this.isVisibleFunc(t):(uc.center=this.aabb.center,uc.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(uc)):!1}updateKey(){const t=this.material;this._key[Ps]=Nb(this.layer,t.alphaToCoverage||t.alphaTest?Be:t.blendType,!1,t.id)}setInstancing(t){t?(this.instancingData=new Ub(t.numVertices),this.instancingData.vertexBuffer=t,t.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=-262141){if(e===void 0&&typeof t=="object"){const n=t;if(n.length){for(let r=0;r<n.length;r++)this.setParameter(n[r]);return}t=n.name,e=n.value}const i=this.parameters[t];i?(i.data=e,i.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&Bs.decRef(s.data),e?(Bs.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(t){t?this.mask=(this.mask|Es)&~(xs|Rs):(this.setRealtimeLightmap(vt.lightmapParamNames[0],null),this.setRealtimeLightmap(vt.lightmapParamNames[1],null),this._shaderDefs&=~(Da|gh|yh),this.mask=(this.mask|xs)&~(Es|Rs))}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}vt.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];function Nb(o,t,e,s){return(o&15)<<27|(t===he?1:0)<<26|(e?1:0)<<25|(s&33554431)<<0}function Zf(o,t){if(o&&!t||!o&&t)return!1;if(o=o.data,t=t.data,o===t)return!0;if(o instanceof Float32Array&&t instanceof Float32Array){if(o.length!==t.length)return!1;for(let e=0;e<o.length;e++)if(o[e]!==t[e])return!1;return!0}return!1}function Vb(o,t){for(const e in o)if(o.hasOwnProperty(e)&&!Zf(o[e],t[e]))return!1;for(const e in t)if(t.hasOwnProperty(e)&&!Zf(t[e],o[e]))return!1;return!0}function Wb(o,t){for(let e=0;e<o.length;e++)if(t.indexOf(o[e])<0)return!1;for(let e=0;e<t.length;e++)if(o.indexOf(t[e])<0)return!1;return!0}const mc=new Qt,Co=new y,Jf=new y,Qf=new y;function pc(o){const t=o.node.worldTransform;return t.getX(Co),t.getY(Jf),t.getZ(Qf),Co.cross(Co,Jf),Co.dot(Qf)>=0?1:-1}class Gb{constructor(t,e,s){this.device=t,this.rootNode=e,this.scene=s,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}destroy(){this.device=null,this.rootNode=null,this.scene=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]}addGroup(t,e,s,i,n){if(i===void 0&&(i=this._batchGroupCounter,this._batchGroupCounter++),this._batchGroups[i])return;const r=new Wt(i,t,e,s,n);return this._batchGroups[i]=r,r}removeGroup(t){if(!this._batchGroups[t])return;const e=[];for(let s=0;s<this._batchList.length;s++)this._batchList[s].batchGroupId===t?this.destroyBatch(this._batchList[s]):e.push(this._batchList[s]);this._batchList=e,this._removeModelsFromBatchGroup(this.rootNode,t),delete this._batchGroups[t]}markGroupDirty(t){this._dirtyGroups.indexOf(t)<0&&this._dirtyGroups.push(t)}getGroupByName(t){const e=this._batchGroups;for(const s in e)if(!!e.hasOwnProperty(s)&&e[s].name===t)return e[s];return null}getBatches(t){const e=[],s=this._batchList.length;for(let i=0;i<s;i++){const n=this._batchList[i];n.batchGroupId===t&&e.push(n)}return e}_removeModelsFromBatchGroup(t,e){if(!!t.enabled){t.model&&t.model.batchGroupId===e&&(t.model.batchGroupId=-1),t.render&&t.render.batchGroupId===e&&(t.render.batchGroupId=-1),t.element&&t.element.batchGroupId===e&&(t.element.batchGroupId=-1),t.sprite&&t.sprite.batchGroupId===e&&(t.sprite.batchGroupId=-1);for(let s=0;s<t._children.length;s++)this._removeModelsFromBatchGroup(t._children[s],e)}}insert(t,e,s){const i=this._batchGroups[e];i&&i._obj[t].indexOf(s)<0&&(i._obj[t].push(s),this.markGroupDirty(e))}remove(t,e,s){const i=this._batchGroups[e];if(i){const n=i._obj[t].indexOf(s);n>=0&&(i._obj[t].splice(n,1),this.markGroupDirty(e))}}_extractRender(t,e,s,i){if(t.render){if(t.render.isStatic){const n=this.scene.drawCalls,r=t.render.meshInstances;for(let a=0;a<n.length;a++)!n[a]._staticSource||r.indexOf(n[a]._staticSource)<0||e.push(n[a]);for(let a=0;a<r.length;a++)n.indexOf(r[a])>=0&&e.push(r[a])}else e=i[t.render.batchGroupId]=e.concat(t.render.meshInstances);t.render.removeFromLayers()}return e}_extractModel(t,e,s,i){if(t.model&&t.model.model){if(t.model.isStatic){const n=this.scene.drawCalls,r=t.model.meshInstances;for(let a=0;a<n.length;a++)!n[a]._staticSource||r.indexOf(n[a]._staticSource)<0||e.push(n[a]);for(let a=0;a<r.length;a++)n.indexOf(r[a])>=0&&e.push(r[a])}else e=i[t.model.batchGroupId]=e.concat(t.model.meshInstances);t.model.removeModelFromLayers()}return e}_extractElement(t,e,s){if(!t.element)return;let i=!1;t.element._text&&t.element._text._model.meshInstances.length>0?(e.push(t.element._text._model.meshInstances[0]),t.element.removeModelFromLayers(t.element._text._model),i=!0):t.element._image&&(e.push(t.element._image._renderable.meshInstance),t.element.removeModelFromLayers(t.element._image._renderable.model),t.element._image._renderable.unmaskMeshInstance&&(e.push(t.element._image._renderable.unmaskMeshInstance),(!t.element._image._renderable.unmaskMeshInstance.stencilFront||!t.element._image._renderable.unmaskMeshInstance.stencilBack)&&(t.element._dirtifyMask(),t.element._onPrerender())),i=!0),i&&(s._ui=!0)}_collectAndRemoveMeshInstances(t,e){for(let s=0;s<e.length;s++){const i=e[s],n=this._batchGroups[i];if(!n)continue;let r=t[i];r||(r=t[i]=[]);for(let a=0;a<n._obj.model.length;a++)r=this._extractModel(n._obj.model[a],r,n,t);for(let a=0;a<n._obj.render.length;a++)r=this._extractRender(n._obj.render[a],r,n,t);for(let a=0;a<n._obj.element.length;a++)this._extractElement(n._obj.element[a],r,n);for(let a=0;a<n._obj.sprite.length;a++){const l=n._obj.sprite[a];l.sprite&&l.sprite._meshInstance&&(n.dynamic||l.sprite.sprite._renderMode===oi)&&(r.push(l.sprite._meshInstance),l.sprite.removeModelFromLayers(),n._sprite=!0,l.sprite._batchGroup=n)}}}generate(t){const e={};t||(t=Object.keys(this._batchGroups));const s=[];for(let l=0;l<this._batchList.length;l++){if(t.indexOf(this._batchList[l].batchGroupId)<0){s.push(this._batchList[l]);continue}this.destroyBatch(this._batchList[l])}if(this._batchList=s,this._collectAndRemoveMeshInstances(e,t),t===this._dirtyGroups)this._dirtyGroups.length=0;else{const l=[];for(let h=0;h<this._dirtyGroups.length;h++)t.indexOf(this._dirtyGroups[h])<0&&l.push(this._dirtyGroups[h]);this._dirtyGroups=l}let i,n,r,a;for(const l in e)if(!!e.hasOwnProperty(l)&&(i=e[l],r=this._batchGroups[l],!!r)){n=this.prepare(i,r.dynamic,r.maxAabbSize,r._ui||r._sprite);for(let h=0;h<n.length;h++)a=this.create(n[h],r.dynamic,parseInt(l,10)),a&&a.addToLayers(this.scene,r.layers)}}prepare(t,e,s=Number.POSITIVE_INFINITY,i){if(t.length===0)return[];const n=s*.5,r=this.device.supportsBoneTextures?1024:this.device.boneLimit,a=this.device.extUintElement?4294967295:65535,l=new gt,h=new gt;let c=null,d;const u=[];let f=0;i&&t.sort(function(g,w){return g.drawOrder-w.drawOrder});let m=t,p;const _=i?function(g){c?c.add(g.aabb):c=g.aabb.clone(),p.push(g)}:function(g){p.push(g)};for(;m.length>0;){u[f]=[m[0]],p=[];const g=m[0].material,w=m[0].layer,v=m[0]._shaderDefs,x=m[0].parameters,S=m[0].stencilFront,T=m[0]._staticLightList;let b=m[0].mesh.vertexBuffer.getNumVertices();const C=m[0].drawOrder;l.copy(m[0].aabb);const M=pc(m[0]),E=m[0].mesh.vertexBuffer.format.batchingHash,D=m[0].mesh.primitive[0].indexed;c=null;for(let I=1;I<m.length;I++){const k=m[I];if(e&&u[f].length>=r){p=p.concat(m.slice(I));break}if(g!==k.material||w!==k.layer||E!==k.mesh.vertexBuffer.format.batchingHash||D!==k.mesh.primitive[0].indexed||v!==k._shaderDefs||b+k.mesh.vertexBuffer.getNumVertices()>a){_(k);continue}if(h.copy(l),h.add(k.aabb),h.halfExtents.x>n||h.halfExtents.y>n||h.halfExtents.z>n){_(k);continue}if(S&&(!(d=k.stencilFront)||S.func!==d.func||S.zpass!==d.zpass)){_(k);continue}if(M!==pc(k)){_(k);continue}if(!Vb(x,k.parameters)){_(k);continue}const N=k._staticLightList;if(T&&N){if(!Wb(T,N)){_(k);continue}}else if(T||N){_(k);continue}if(i&&c&&c.intersects(k.aabb)&&k.drawOrder!==C){_(k);continue}l.add(k.aabb),b+=k.mesh.vertexBuffer.getNumVertices(),u[f].push(k)}f++,m=p}return u}collectBatchedMeshData(t,e){let s=null,i=0,n=0,r=null;for(let a=0;a<t.length;a++)if(t[a].visible){const l=t[a].mesh;if(i+=l.vertexBuffer.numVertices,n+=l.primitive[0].indexed?l.primitive[0].count:l.primitive[0].type===Di&&l.primitive[0].count===4?6:0,!s){r=t[a].material,s={};const c=l.vertexBuffer.format.elements;for(let d=0;d<c.length;d++){const u=c[d].name;s[u]={numComponents:c[d].numComponents,dataType:c[d].dataType,normalize:c[d].normalize,count:0}}e&&(s[Se]={numComponents:1,dataType:wt,normalize:!1,count:0})}}return{streams:s,batchNumVerts:i,batchNumIndices:n,material:r}}create(t,e,s){if(!this._init){const c="#define BONE_LIMIT "+this.device.getBoneLimit()+`
`;this.transformVS=c+`#define DYNAMICBATCH
`+F.transformVS,this.skinTexVS=F.skinBatchTexVS,this.skinConstVS=F.skinBatchConstVS,this.vertexFormats={},this._init=!0}let i=null,n,r,a,l=null;const h=this.collectBatchedMeshData(t,e);if(h.streams){const c=h.streams;let d=h.material;const u=h.batchNumVerts,f=h.batchNumIndices;l=new dc(t,e,s),this._batchList.push(l);let m,p,_,g=0,w=0,v;const x=new y,S=u<=65535?Uint16Array:Uint32Array,T=new S(f);for(n in c)i=c[n],i.typeArrayType=mn[i.dataType],i.elementByteSize=_o[i.dataType],i.buffer=new i.typeArrayType(u*i.numComponents);for(let M=0;M<t.length;M++)if(!!t[M].visible){r=t[M].mesh,a=r.vertexBuffer.numVertices,e||(v=t[M].node.getWorldTransform());for(n in c)if(n!==Se){i=c[n];const E=new i.typeArrayType(i.buffer.buffer,i.elementByteSize*i.count),D=r.getVertexStream(n,E)*i.numComponents;if(i.count+=D,!e&&i.numComponents>=3){if(n===Ot)for(let I=0;I<D;I+=i.numComponents)x.set(E[I],E[I+1],E[I+2]),v.transformPoint(x,x),E[I]=x.x,E[I+1]=x.y,E[I+2]=x.z;else if(n===pe||n===vs){v.invertTo3x3(mc),mc.transpose();for(let I=0;I<D;I+=i.numComponents)x.set(E[I],E[I+1],E[I+2]),mc.transformVector(x,x),E[I]=x.x,E[I+1]=x.y,E[I+2]=x.z}}}if(e){i=c[Se];for(let E=0;E<a;E++)i.buffer[i.count++]=M}if(r.primitive[0].indexed){m=r.primitive[0].base,p=r.primitive[0].count;const E=r.indexBuffer[0].getFormat();_=new Yh[E](r.indexBuffer[0].storage)}else if(r.primitive[0].type===Di&&r.primitive[0].count===4)m=0,p=6,_=[0,1,3,2,3,1];else{p=0;continue}for(let E=0;E<p;E++)T[E+w]=_[m+E]+g;w+=p,g+=a}r=new is(this.device);for(n in c)i=c[n],r.setVertexStream(n,i.buffer,i.numComponents,void 0,i.dataType,i.normalize);T.length>0&&r.setIndices(T),r.update(ts,!1),e&&(d=d.clone(),d.chunks.transformVS=this.transformVS,d.chunks.skinTexVS=this.skinTexVS,d.chunks.skinConstVS=this.skinConstVS,d.update());const b=new vt(r,d,this.rootNode);b.castShadow=l.origMeshInstances[0].castShadow,b.parameters=l.origMeshInstances[0].parameters,b.isStatic=l.origMeshInstances[0].isStatic,b.layer=l.origMeshInstances[0].layer,b._staticLightList=l.origMeshInstances[0]._staticLightList,b._shaderDefs=l.origMeshInstances[0]._shaderDefs,b.cull=l.origMeshInstances[0].cull;const C=this._batchGroups[s];if(C&&C._ui&&(b.cull=!1),e){const M=[];for(let E=0;E<l.origMeshInstances.length;E++)M.push(l.origMeshInstances[E].node);b.skinInstance=new Kf(this.device,M,this.rootNode)}b._updateAabb=!1,b.drawOrder=l.origMeshInstances[0].drawOrder,b.stencilFront=l.origMeshInstances[0].stencilFront,b.stencilBack=l.origMeshInstances[0].stencilBack,b.flipFaces=pc(l.origMeshInstances[0])<0,b.castShadow=l.origMeshInstances[0].castShadow,l.meshInstance=b,l.updateBoundingBox()}return l}updateAll(){this._dirtyGroups.length>0&&this.generate(this._dirtyGroups);for(let t=0;t<this._batchList.length;t++)!this._batchList[t].dynamic||this._batchList[t].updateBoundingBox()}clone(t,e){const s=new dc(e,t.dynamic,t.batchGroupId);this._batchList.push(s);const i=[];for(let n=0;n<e.length;n++)i.push(e[n].node);return s.meshInstance=new vt(t.meshInstance.mesh,t.meshInstance.material,t.meshInstance.node),s.meshInstance._updateAabb=!1,s.meshInstance.parameters=e[0].parameters,s.meshInstance.isStatic=e[0].isStatic,s.meshInstance.cull=e[0].cull,s.meshInstance.layer=e[0].layer,s.meshInstance._staticLightList=e[0]._staticLightList,t.dynamic&&(s.meshInstance.skinInstance=new Kf(this.device,i,this.rootNode)),s.meshInstance.castShadow=t.meshInstance.castShadow,s.meshInstance._shader=t.meshInstance._shader,s.meshInstance.castShadow=t.meshInstance.castShadow,s}destroyBatch(t){t.destroy(this.scene,this._batchGroups[t.batchGroupId].layers)}}const Ao=new y,Mo=new y,Po=new y,_c=new gt,tm=1e-6;class em{constructor(){this.light=null,this.min=new y,this.max=new y}}class gc{constructor(t){this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new y,this.boundsMax=new y,this.boundsDelta=new y,this._cells=new y(1,1,1),this._cellsLimit=new y,this.cells=this._cells,this._maxCellLightCount=0,this._pixelsPerCellCount=0,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new em),this.lightsBuffer=new Ct(t),this.registerUniforms(t)}set maxCellLightCount(t){const e=U.roundUp(t,4);e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._pixelsPerCellCount=this._maxCellLightCount/4,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(t){Ao.copy(t).floor(),this._cells.equals(Ao)||(this._cells.copy(Ao),this._cellsLimit.copy(Ao).sub(y.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterPixelsPerCellId=t.scope.resolve("clusterPixelsPerCell"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=t.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,i=t*e*s,n=this._pixelsPerCellCount*i;let r=Math.ceil(Math.sqrt(n));r=U.roundUp(r,this._pixelsPerCellCount);const a=Math.ceil(n/r);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this._pixelsPerCellCount,this._clusterCellsDotData[1]=t*s*this._pixelsPerCellCount,this._clusterCellsDotData[2]=t*this._pixelsPerCellCount,this.clusters=new Uint8ClampedArray(4*n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=Ct.createTexture(this.device,r,a,ct,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterPixelsPerCellId.setValue(this._pixelsPerCellCount),this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(y.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;for(let n=0;n<t.length;n++){const r=t[n],a=!!(r.mask&(xs|Es));if(r.enabled&&r.type!==lt&&r.visibleThisFrame&&r.intensity>0&&a)if(i<e){let l;i<s.length?l=s[i]:(l=new em,s.push(l)),l.light=r,r.getBoundingBox(_c),l.min.copy(_c.getMin()),l.max.copy(_c.getMax()),i++}else{console.warn(`Clustered lighting: more than ${e-1} lights in the frame, ignoring some.`);break}}s.length=i}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let i=2;i<t.length;i++)e.min(t[i].min),s.max(t[i].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}evaluateCompressionLimits(t){let e=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const r=i[n].light;e=Math.max(r.attenuationEnd,e);const a=t?r._linearFinalColor:r._finalColor;s=Math.max(a[0],s),s=Math.max(a[1],s),s=Math.max(a[2],s)}this._maxAttenuation=e+tm,this._maxColorValue=s+tm,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0);const e=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this._pixelsPerCellCount,l=this._usedLights;for(let h=1;h<l.length;h++){const c=l[h],d=c.light;this.lightsBuffer.addLightData(d,h,t),this.evalLightCellMinMax(c,Mo,Po);const u=Mo.x,f=Po.x,m=Mo.y,p=Po.y,_=Mo.z,g=Po.z;for(let w=u;w<=f;w++)for(let v=_;v<=g;v++)for(let x=m;x<=p;x++){const S=w+e*(v+x*s),T=i[S];T<n&&(r[a*S*4+T]=h,i[S]=T+1)}}}update(t,e,s){this.updateParams(s),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.evaluateCompressionLimits(e),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}const Hb=`
		attribute vec2 vertex_position;
		varying vec2 uv0;
		void main(void) {
				gl_Position = vec4(vertex_position, 0.5, 1.0);
				uv0 = vertex_position.xy * 0.5 + 0.5;
		}`,Xb=`
		varying vec2 uv0;
		uniform sampler2D blitTexture;
		void main(void) {
				gl_FragColor = texture2D(blitTexture, uv0);
		}`,jb=`
		varying vec2 uv0;
		uniform samplerCube blitTexture;
		uniform mat4 invViewProj;
		void main(void) {
				vec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);
				vec4 worldPos = invViewProj * projPos;
				gl_FragColor = textureCube(blitTexture, worldPos.xyz);
		}`,fi=new Z;class mi{constructor(t,e){this.device=t,this.lightTextureAtlas=e,this.blitShader2d=null,this.blitShaderCube=null,this.blitTextureId=null,this.invViewProjId=null}destroy(){}getShader(t,e){return this[t]||(this[t]=we(this.device,Hb,e,`cookie_renderer_${t}`)),this.blitTextureId||(this.blitTextureId=this.device.scope.resolve("blitTexture")),this.invViewProjId||(this.invViewProjId=this.device.scope.resolve("invViewProj")),this[t]}get shader2d(){return this.getShader("blitShader2d",Xb)}get shaderCube(){return this.getShader("blitShaderCube",jb)}static createTexture(t,e){return new nt(t,{name:"CookieAtlas",width:e,height:e,format:ct,cubemap:!1,mipmaps:!1,minFilter:bt,magFilter:bt,addressU:et,addressV:et})}initInvViewProjMatrices(){if(!mi._invViewProjMatrices){mi._invViewProjMatrices=[];for(let t=0;t<6;t++){const e=ss.create(null,ut,t),s=e.projectionMatrix,i=e.node.getLocalTransform().clone().invert();mi._invViewProjMatrices[t]=new G().mul2(s,i).invert()}}}render(t,e){if(t.enabled&&t.cookie&&t.visibleThisFrame){const s=t.numShadowFaces,i=s>1?this.shaderCube:this.shader2d,n=this.device;s>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(t.cookie);for(let r=0;r<s;r++){if(fi.copy(t.atlasViewport),s>1){const a=fi.z/3,l=this.lightTextureAtlas.cubeSlotsOffsets[r];fi.x+=a*l.x,fi.y+=a*l.y,fi.z=a,fi.w=a,this.invViewProjId.setValue(mi._invViewProjMatrices[r].data)}fi.mulScalar(e.colorBuffer.width),es(n,e,i,fi)}}}}mi._invViewProjMatrices=null;class Ui{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static getShadowFormat(t,e){return e===ps?Vt:e===Ms?ce:e===_s||e===Kt&&t.webgl2?vr:ct}static getShadowFiltering(t,e){return e===Kt&&!t.webgl2?bt:e===ps?t.extTextureFloatLinear?Yt:bt:e===Ms?t.extTextureHalfFloatLinear?Yt:bt:Yt}static create(t,e){let s=null;return e._type===ut?s=this.createCubemap(t,e._shadowResolution):s=this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const i=this.create2dMap(t,e,s),n=i.renderTargets,r=n[0];for(let a=0;a<5;a++)n.push(r);return i}static create2dMap(t,e,s){const i=this.getShadowFormat(t,s),n=this.getShadowFiltering(t,s),r=new nt(t,{format:i,width:e,height:e,mipmaps:!1,minFilter:n,magFilter:n,addressU:et,addressV:et});r.name="ShadowMap2D";let a=null;return s===_s||s===Kt&&t.webgl2?(r.compareOnRead=!0,r.compareFunc=Ah,a=new oe({depthBuffer:r})):a=new oe({colorBuffer:r,depth:!0}),new Ui(r,[a])}static createCubemap(t,e){const s=new nt(t,{format:ct,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:bt,magFilter:bt,addressU:et,addressV:et});s.name="ShadowMapCube";const i=[];for(let n=0;n<6;n++){const r=new oe({colorBuffer:s,face:n,depth:!0});i.push(r)}return new Ui(s,i)}}const qb=[],Yb=[],ks=new Z,yc=new Z;class xc{constructor(t){this.size=Math.floor(t.w*1024),this.used=!1,this.lightId=-1,this.rect=t}}class $b{constructor(t){this.device=t,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=2048,this.cookieAtlas=null,this.cookieRenderTarget=null,this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new H(0,0),new H(0,1),new H(1,0),new H(1,1),new H(2,0),new H(2,1)],this.scissorVec=new Z,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas&&(this.shadowAtlas.destroy(),this.shadowAtlas=null)}destroyCookieAtlas(){this.cookieAtlas&&(this.cookieAtlas.destroy(),this.cookieAtlas=null),this.cookieRenderTarget&&(this.cookieRenderTarget.destroy(),this.cookieRenderTarget=null)}allocateShadowAtlas(t){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==t){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=Ui.createAtlas(this.device,t,Kt),this.shadowAtlas.cached=!0;const e=4/this.shadowAtlasResolution;this.scissorVec.set(e,e,-2*e,-2*e)}}allocateCookieAtlas(t){(!this.cookieAtlas||this.cookieAtlas.width!==t)&&(this.version++,this.destroyCookieAtlas(),this.cookieAtlas=mi.createTexture(this.device,t),this.cookieRenderTarget=new oe({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}))}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=!0,e=this.shadowAtlas.renderTargets[0],s=this.device.webgl2&&t?e.depthBuffer:e.colorBuffer;this._shadowAtlasTextureId.setValue(s),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t,e){let s=e.atlasSplit;if(!s){const n=Math.ceil(Math.sqrt(t));s=Yb,s[0]=n,s.length=1}if(!((n,r)=>n.length===r.length&&n.every((a,l)=>a===r[l]))(s,this.atlasSplit)){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const n=this.atlasSplit[0];if(n>1){const r=1/n;for(let a=0;a<n;a++)for(let l=0;l<n;l++){const h=new Z(a*r,l*r,r,r),c=this.atlasSplit[1+a*n+l];if(c>1)for(let d=0;d<c;d++)for(let u=0;u<c;u++){const f=r/c,m=new Z(h.x+d*f,h.y+u*f,f,f);this.slots.push(new xc(m))}else this.slots.push(new xc(h))}}else this.slots.push(new xc(new Z(0,0,1,1)));this.slots.sort((r,a)=>a.size-r.size)}}collectLights(t,e,s){const i=s.cookiesEnabled,n=s.shadowsEnabled;let r=!1,a=!1;const l=qb;l.length=0;const h=c=>{for(let d=0;d<c.length;d++){const u=c[d];if(u.visibleThisFrame){const f=n&&u.castShadows,m=i&&!!u.cookie;r||(r=f),a||(a=m),(f||m)&&l.push(u)}}};return(i||n)&&(h(t),h(e)),l.sort((c,d)=>d.maxScreenSize-c.maxScreenSize),r&&this.allocateShadowAtlas(this.shadowAtlasResolution),a&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||a)&&this.subdivide(l.length,s),l}setupSlot(t,e){t.atlasViewport.copy(e);const s=t.numShadowFaces;for(let i=0;i<s;i++)if(t.castShadows||t._cookie){if(ks.copy(e),yc.copy(e),t._type===_t&&ks.add(this.scissorVec),t._type===ut){const n=ks.z/3,r=this.cubeSlotsOffsets[i];ks.x+=n*r.x,ks.y+=n*r.y,ks.z=n,ks.w=n,yc.copy(ks)}if(t.castShadows){const n=t.getRenderData(null,i);n.shadowViewport.copy(ks),n.shadowScissor.copy(yc)}}}assignSlot(t,e,s){t.atlasViewportAllocated=!0;const i=this.slots[e];i.lightId=t.id,i.used=!0,s&&(t.atlasSlotUpdated=!0,t.atlasVersion=this.version,t.atlasSlotIndex=e)}update(t,e,s){this.shadowAtlasResolution=s.shadowAtlasResolution,this.cookieAtlasResolution=s.cookieAtlasResolution;const i=this.collectLights(t,e,s);if(i.length>0){const n=this.slots;for(let l=0;l<n.length;l++)n[l].used=!1;const r=Math.min(i.length,n.length);for(let l=0;l<r;l++){const h=i[l];h.castShadows&&(h._shadowMap=this.shadowAtlas);const c=n[h.atlasSlotIndex];if(h.atlasVersion===this.version&&h.id===(c==null?void 0:c.lightId)){const d=n[h.atlasSlotIndex];d.size===n[l].size&&!d.used&&this.assignSlot(h,h.atlasSlotIndex,!1)}}let a=0;for(let l=0;l<r;l++){for(;a<n.length&&n[a].used;)a++;const h=i[l];h.atlasViewportAllocated||this.assignSlot(h,a,!0);const c=n[h.atlasSlotIndex];this.setupSlot(h,c.rect)}}this.updateUniforms()}}class Kb{constructor(){this.shadowMapCache=new Map}destroy(){this.clear(),this.shadowMapCache=null}clear(){this.shadowMapCache.forEach(t=>{t.forEach(e=>{e.destroy()})}),this.shadowMapCache.clear()}getKey(t){const e=t._type===ut,s=t._shadowType,i=t._shadowResolution;return`${e}-${s}-${i}`}get(t,e){const s=this.getKey(e),i=this.shadowMapCache.get(s);if(i&&i.length)return i.pop();const n=Ui.create(t,e);return n.cached=!0,n}add(t,e){const s=this.getKey(t),i=this.shadowMapCache.get(s);i?i.push(e):this.shadowMapCache.set(s,[e])}}const At=[new y,new y,new y,new y,new y,new y,new y,new y],vc={min:0,max:0};function Zb(o,t,e){At[0].x=At[1].x=At[2].x=At[3].x=t.x,At[1].y=At[3].y=At[7].y=At[5].y=t.y,At[2].z=At[3].z=At[6].z=At[7].z=t.z,At[4].x=At[5].x=At[6].x=At[7].x=e.x,At[0].y=At[2].y=At[4].y=At[6].y=e.y,At[0].z=At[1].z=At[4].z=At[5].z=e.z;let s=9999999999,i=-9999999999;for(let n=0;n<8;++n){o.transformPoint(At[n],At[n]);const r=At[n].z;r<s&&(s=r),r>i&&(i=r)}return vc.min=s,vc.max=i,vc}function Jb(o,t){return Math.exp(-(o*o)/(2*t*t))}const sm=25;function Qb(o){o>sm&&(o=sm);const t=(o-1)/(2*3),e=(o-1)*.5,s=new Array(o);let i=0;for(let n=0;n<o;++n)s[n]=Jb(n-e,t),i+=s[n];for(let n=0;n<o;++n)s[n]/=i;return s}const Eo=new gt,Ro=new G,im=new G,Ni=new Float32Array(2),Gr=new Z(1,1,0,0),tw={r:1,g:2,b:3,a:4},zs=new y,nm=new G;function ew(o){const t=o.material,e=o.skinInstance?10:0;let s=0;if(t.opacityMap){const i=t.opacityMapChannel;i&&(s=tw[i])}return e+s}class Io{constructor(t,e){this.device=t.device,this.forwardRenderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[F.blurVSMPS,`#define GAUSS
`+F.blurVSMPS];const i=`#define PACKED
`;this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.shadowMapCache=new Kb}destroy(){this.shadowMapCache.destroy(),this.shadowMapCache=null}static createShadowCamera(t,e,s,i){const n=ss.create("ShadowCamera",s,i);return e>=ms&&e<=ps?n.clearColor=new j(0,0,0,0):n.clearColor=new j(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(t,e,s,i,n){let r=s===_s||s===Kt&&e.webgl2;i===ut&&!n&&(r=!1),t.clearColorBuffer=!r}cullShadowCasters(t,e,s){let i=0;const n=t.length;for(let r=0;r<n;r++){const a=t[r];(!a.cull||a._isVisible(s))&&(a.visibleThisFrame=!0,e[i]=a,i++)}e.length=i,e.sort(this.forwardRenderer.depthSortCompare)}cullLocal(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,s||t._shadowMap||(t._shadowMap=Ui.create(this.device,t));const i=t._type,n=i===_t?1:6;for(let r=0;r<n;r++){const a=t.getRenderData(null,r),l=a.shadowCamera;l.nearClip=t.attenuationEnd/1e3,l.farClip=t.attenuationEnd;const h=l._node,c=t._node;if(h.setPosition(c.getPosition()),i===_t)l.fov=t._outerConeAngle*2,h.setRotation(c.getRotation()),h.rotateLocal(-90,0,0);else if(i===ut)if(s){const d=this.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3,f=2/d*this.lightTextureAtlas.shadowEdgePixels;l.fov=Math.atan(1+f)*U.RAD_TO_DEG*2}else l.fov=90;this.forwardRenderer.updateCameraFrustum(l),this.cullShadowCasters(e,a.visibleCasters,l)}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let i=1;i<t.numCascades;i++){const n=i/t.numCascades,r=e+(s-e)*n,a=e*(s/e)**n,l=U.lerp(r,a,t.cascadeDistribution);t._shadowCascadeDistances[i-1]=l}}cullDirectional(t,e,s){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=Ui.create(this.device,t));const i=s._nearClip;this.generateSplitDistances(t,i,t.shadowDistance);for(let n=0;n<t.numCascades;n++){const r=t.getRenderData(s,n),a=r.shadowCamera;a.renderTarget=t._shadowMap.renderTargets[0],r.shadowViewport.copy(t.cascades[n]),r.shadowScissor.copy(t.cascades[n]);const l=a._node,h=t._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);const c=n===0?i:t._shadowCascadeDistances[n-1],d=t._shadowCascadeDistances[n],u=Th.getPoints(s,c,d);zs.set(0,0,0);const f=s.node.getWorldTransform();for(let I=0;I<8;I++)f.transformPoint(u[I],u[I]),zs.add(u[I]);zs.mulScalar(1/8);let m=0;for(let I=0;I<8;I++){const k=u[I].sub(zs).length();k>m&&(m=k)}const p=l.right,_=l.up,g=l.forward,w=.25*t._shadowResolution/m,v=Math.ceil(zs.dot(_)*w)/w,x=Math.ceil(zs.dot(p)*w)/w,S=_.mulScalar(v),T=p.mulScalar(x),b=zs.dot(g),C=g.mulScalar(b);zs.add2(S,T).add(C),l.setPosition(zs),l.translateLocal(0,0,1e6),a.nearClip=0,a.farClip=2e6,a.orthoHeight=m,this.forwardRenderer.updateCameraFrustum(a),this.cullShadowCasters(e,r.visibleCasters,a);let M=!0;const E=r.visibleCasters;for(let I=0;I<E.length;I++){const k=E[I];M?(M=!1,Eo.copy(k.aabb)):Eo.add(k.aabb)}Ro.copy(l.getWorldTransform()).invert();const D=Zb(Ro,Eo.getMin(),Eo.getMax());l.translateLocal(0,0,D.max+.1),a.farClip=D.max-D.min+.2}}setupRenderState(t,e){const s=this.forwardRenderer.scene.clusteredLightingEnabled;t.webgl2?e._type===ut&&!s?t.setDepthBias(!1):(t.setDepthBias(!0),t.setDepthBiasValues(e.shadowBias*-1e3,e.shadowBias*-1e3)):t.extStandardDerivatives&&(e._type===ut?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=e.shadowBias*-1e3,this.polygonOffset[1]=e.shadowBias*-1e3,this.polygonOffsetId.setValue(this.polygonOffset))),t.setBlending(!1),t.setDepthWrite(!0),t.setDepthTest(!0),t.setDepthFunc($a),(s?e._isPcf&&t.webgl2:e._isPcf&&t.webgl2&&e._type!==ut)?t.setColorWrite(!1,!1,!1,!1):t.setColorWrite(!0,!0,!0,!0)}restoreRenderState(t){t.webgl2?t.setDepthBias(!1):t.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))}dispatchUniforms(t,e,s,i){const n=e._node;t._type!==lt&&(this.forwardRenderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),Ro.setTRS(n.getPosition(),n.getRotation(),y.ONE).invert(),im.mul2(e.projectionMatrix,Ro);const r=s.shadowViewport;e.rect=r,e.scissorRect=s.shadowScissor,nm.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(nm,im),t._type===lt&&t._shadowMatrixPalette.set(s.shadowMatrix.data,i*16)}submitCasters(t,e){const s=this.device,i=this.forwardRenderer,n=1<<ai,a=e._shadowType+e._type*Cu,l=t.length;for(let h=0;h<l;h++){const c=t[h],d=c.mesh,u=c.material;i.setBaseConstants(s,u),i.setSkinning(s,c,u),u.dirty&&(u.updateUniforms(s,i.scene),u.dirty=!1),u.chunks&&(i.setCullMode(!0,!1,c),u.setParameters(s),c.setParameters(s,n));let f=c._shader[ai+a];f||(i.updateShader(c,c._shaderDefs,null,ai+a),f=c._shader[ai+a],c._key[vh]=ew(c)),s.setShader(f),i.setVertexBuffers(s,d),i.setMorphing(s,c.morphInstance);const m=c.renderStyle;s.setIndexBuffer(d.indexBuffer[m]),i.drawInstance(s,c,d,m),i._shadowDrawCalls++}}render(t,e){if(t.enabled&&t.castShadows&&t.shadowUpdateMode!==dr&&t.visibleThisFrame){const s=this.device;t.shadowUpdateMode===ur&&(t.shadowUpdateMode=dr);const i=t._type,n=t._shadowType,r=t.numShadowFaces,a=this.forwardRenderer;a._shadowMapUpdates+=r;const l=a.scene.clusteredLightingEnabled;this.setupRenderState(s,t);for(let h=0;h<r;h++){const c=t.getRenderData(i===lt?e:null,h),d=c.shadowCamera;Io.setShadowCameraSettings(d,s,n,i,l);const u=i===lt?0:h;d.renderTarget=t._shadowMap.renderTargets[u],this.dispatchUniforms(t,d,c,h),a.setCamera(d,d.renderTarget,!0),this.submitCasters(c.visibleCasters,t)}t._isVsm&&t._vsmBlurSize>1&&(!this.forwardRenderer.scene.clusteredLightingEnabled||i===lt)&&this.applyVsmBlur(t,e),this.restoreRenderState(s)}}getVsmBlurShader(t,e,s){let i=(t?this.blurPackedVsmShader:this.blurVsmShader)[e][s];if(!i){this.blurVsmWeights[s]=Qb(s);const n=F.fullscreenQuadVS;let r="#define SAMPLES "+s+`
`;t?r+=this.blurPackedVsmShaderCode[e]:r+=this.blurVsmShaderCode[e];const a="blurVsm"+e+""+s+""+t;i=we(this.device,n,r,a),t?this.blurPackedVsmShader[e][s]=i:this.blurVsmShader[e][s]=i}return i}applyVsmBlur(t,e){const s=this.device,r=t.getRenderData(t._type===lt?e:null,0).shadowCamera.renderTarget,a=this.shadowMapCache.get(s,t),l=a.renderTargets[0],h=t._shadowType===ms,c=t.vsmBlurMode,d=t._vsmBlurSize,u=this.getVsmBlurShader(h,c,d);Gr.z=t._shadowResolution-2,Gr.w=Gr.z,this.sourceId.setValue(r.colorBuffer),Ni[0]=1/t._shadowResolution,Ni[1]=0,this.pixelOffsetId.setValue(Ni),c===uh&&this.weightId.setValue(this.blurVsmWeights[d]),es(s,l,u,null,Gr),this.sourceId.setValue(l.colorBuffer),Ni[1]=Ni[0],Ni[0]=0,this.pixelOffsetId.setValue(Ni),es(s,r,u,null,Gr),this.shadowMapCache.add(t,a)}}const Hr=new Ci;class vn{static lightCompare(t,e){return t.key-e.key}static prepare(t,e,s,i){const n=s,r=n.length,a=[],l=new y,h=new y,c=new gt,d=new G,u=[],f=[],m=[],p=[];for(let _=0;_<r;_++){const g=n[_];if(!g.isStatic)a.push(g);else{const w=g.aabb;p.length=0;for(let N=ut;N<=_t;N++)for(let X=0;X<i.length;X++){const q=i[X];if(q._type===N&&q.enabled&&q.mask&g.mask&&q.isStatic){if(f[X]||(f[X]=new gt,q._node.getWorldTransform(),q.getBoundingSphere(Hr),f[X].center.copy(Hr.center),f[X].halfExtents.set(Hr.radius,Hr.radius,Hr.radius)),!f[X].intersects(w))continue;p.push(X)}}if(p.length===0){a.push(g);continue}const v=g.mesh,x=v.vertexBuffer,S=v.indexBuffer[g.renderStyle],T=S.bytesPerIndex===2?new Uint16Array(S.lock()):new Uint32Array(S.lock()),b=v.primitive[g.renderStyle].count/3,C=v.primitive[g.renderStyle].base,M=x.format.elements,E=x.format.size/4,D=new Float32Array(x.storage);let I;for(let N=0;N<M.length;N++)M[N].name===Ot&&(I=M[N].offset/4);u.length=b;for(let N=0;N<b;N++)u[N]=0;let k=!1;m.length=b*6;for(let N=0;N<b;N++){let X=Number.MAX_VALUE,q=Number.MAX_VALUE,A=Number.MAX_VALUE,R=-Number.MAX_VALUE,L=-Number.MAX_VALUE,O=-Number.MAX_VALUE;for(let W=0;W<3;W++){let K=T[N*3+W+C];K=K*E+I;const V=D[K],P=D[K+1],B=D[K+2];V<X&&(X=V),P<q&&(q=P),B<A&&(A=B),V>R&&(R=V),P>L&&(L=P),B>O&&(O=B)}const z=N*6;m[z]=X,m[z+1]=q,m[z+2]=A,m[z+3]=R,m[z+4]=L,m[z+5]=O}for(let N=0;N<p.length;N++){const X=p[N];d.copy(g.node.worldTransform).invert(),c.setFromTransformedAabb(f[X],d);const q=c.getMin(),A=c.getMax(),R=1<<N;for(let L=0;L<b;L++){const O=L*6;m[O]<=A.x&&m[O+3]>=q.x&&m[O+1]<=A.y&&m[O+4]>=q.y&&m[O+2]<=A.z&&m[O+5]>=q.z&&(u[L]|=R,k=!0)}}if(k){const N={};for(let X=0;X<b;X++){const q=X*3+C,A=u[X];N[A]||(N[A]=[]);const R=N[A];R.push(T[q]),R.push(T[q+1]),R.push(T[q+2])}for(const X in N){const q=N[X],A=new ui(t,S.format,q.length,S.usage);(A.bytesPerIndex===2?new Uint16Array(A.lock()):new Uint32Array(A.lock())).set(q),A.unlock();let L=Number.MAX_VALUE,O=Number.MAX_VALUE,z=Number.MAX_VALUE,W=-Number.MAX_VALUE,K=-Number.MAX_VALUE,V=-Number.MAX_VALUE;for(let it=0;it<q.length;it++){const Tt=q[it],$=D[Tt*E+I],kt=D[Tt*E+I+1],Oe=D[Tt*E+I+2];$<L&&(L=$),kt<O&&(O=kt),Oe<z&&(z=Oe),$>W&&(W=$),kt>K&&(K=kt),Oe>V&&(V=Oe)}l.set(L,O,z),h.set(W,K,V);const P=new gt;P.setMinMax(l,h);const B=new is(t);B.vertexBuffer=x,B.indexBuffer[0]=A,B.primitive[0].type=ts,B.primitive[0].base=0,B.primitive[0].count=q.length,B.primitive[0].indexed=!0,B.aabb=P;const Y=new vt(B,g.material,g.node);Y.isStatic=g.isStatic,Y.visible=g.visible,Y.layer=g.layer,Y.castShadow=g.castShadow,Y._receiveShadow=g._receiveShadow,Y.cull=g.cull,Y.pick=g.pick,Y.mask=g.mask,Y.parameters=g.parameters,Y._shaderDefs=g._shaderDefs,Y._staticSource=g,g._staticLightList?Y._staticLightList=g._staticLightList:Y._staticLightList=[];for(let it=0;it<p.length;it++){const Tt=1<<it;if(X&Tt){const $=i[p[it]];Y._staticLightList.indexOf($)<0&&Y._staticLightList.push($)}}Y._staticLightList.sort(vn.lightCompare),a.push(Y)}}else a.push(g)}}s.length=a.length;for(let _=0;_<a.length;_++)s[_]=a[_]}static revert(t){const e=t,s=e.length,i=[];let n;for(let r=0;r<s;r++){const a=e[r];a._staticSource?a._staticSource!==n&&(i.push(a._staticSource),n=a._staticSource):i.push(a)}t.length=i.length;for(let r=0;r<i.length;r++)t[r]=i[r]}}new y(1,1,1);new y(40,0,0);const We=new G,ge=new G,rm=new Qt,Ge=new G;let He;const am=new G().setScale(1,-1,1),om=new G,lm=new G,Us=new G,Ns=new G,Sn=new G,bn=new G,Lo=new y,Do=new y;let Xr,jr;const hm=new Qt,cm=new Qt,dm=new G,um=new G,pi=new y,Fo=new y,Oo=new y,Sc=new Ci,qr=[0,0,0,0];let wn,Vs,bc,Bo,Tn,Cn,wc=0;const _i={drawCalls:[],isNewMaterial:[],lightMaskChanged:[]},Tc=new Set;class sw{constructor(t){this.device=t,this.scene=null,this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._numDrawCallsCulled=0,this._instancedDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._layerCompositionUpdateTime=0,this._lightClustersTime=0,this._lightClusters=0;const e=this.device;this.library=e.getProgramLibrary(),this.lightTextureAtlas=new $b(e),this._shadowRenderer=new Io(this,this.lightTextureAtlas),this._cookieRenderer=new mi(e,this.lightTextureAtlas);const s=e.scope;this.projId=s.resolve("matrix_projection"),this.projSkyboxId=s.resolve("matrix_projectionSkybox"),this.viewId=s.resolve("matrix_view"),this.viewId3=s.resolve("matrix_view3"),this.viewInvId=s.resolve("matrix_viewInverse"),this.viewProjId=s.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=s.resolve("view_position"),this.nearClipId=s.resolve("camera_near"),this.farClipId=s.resolve("camera_far"),this.cameraParamsId=s.resolve("camera_params"),this.tbnBasis=s.resolve("tbnBasis"),this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.modelMatrixId=s.resolve("matrix_model"),this.normalMatrixId=s.resolve("matrix_normal"),this.poseMatrixId=s.resolve("matrix_pose[0]"),this.boneTextureId=s.resolve("texture_poseMap"),this.boneTextureSizeId=s.resolve("texture_poseMapSize"),this.morphWeightsA=s.resolve("morph_weights_a"),this.morphWeightsB=s.resolve("morph_weights_b"),this.morphPositionTex=s.resolve("morphPositionTex"),this.morphNormalTex=s.resolve("morphNormalTex"),this.morphTexParams=s.resolve("morph_tex_params"),this.alphaTestId=s.resolve("alpha_ref"),this.opacityMapId=s.resolve("texture_opacityMap"),this.ambientId=s.resolve("light_globalAmbient"),this.exposureId=s.resolve("exposure"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.depthMapId=s.resolve("uDepthMap"),this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.twoSidedLightingNegScaleFactorId=s.resolve("twoSidedLightingNegScaleFactor"),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4)}destroy(){this._shadowRenderer.destroy(),this._shadowRenderer=null,this._cookieRenderer.destroy(),this._cookieRenderer=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist;if(t.zdist2&&e.zdist2)return t.zdist2-e.zdist2}return e._key[Ps]-t._key[Ps]}sortCompareMesh(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist}return Tn=t._key[Ps],Cn=e._key[Ps],Tn===Cn&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Cn-Tn}depthSortCompare(t,e){return Tn=t._key[vh],Cn=e._key[vh],Tn===Cn&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Cn-Tn}updateCameraFrustum(t){if(t.vrDisplay&&t.vrDisplay.presenting){He=t.vrDisplay.combinedProj;const e=t._node.parent;e?ge.copy(e.getWorldTransform()).mul(t.vrDisplay.combinedViewInv).invert():ge.copy(t.vrDisplay.combinedView),We.copy(ge).invert(),this.viewInvId.setValue(We.data),Ge.mul2(He,ge),t.frustum.setFromMat4(Ge)}else if(t.xr&&t.xr.views.length){const e=t.xr.views[0];Ge.mul2(e.projMat,e.viewOffMat),t.frustum.setFromMat4(Ge);return}if(He=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(He,ln),t.calculateTransform)t.calculateTransform(We,ln);else{const e=t._node.getPosition(),s=t._node.getRotation();We.setTRS(e,s,y.ONE),this.viewInvId.setValue(We.data)}ge.copy(We).invert(),Ge.mul2(He,ge),t.frustum.setFromMat4(Ge)}setCamera(t,e,s){const i=t.vrDisplay;let n;if(i&&i.presenting){if(Xr=i.leftProj,jr=i.rightProj,He=i.combinedProj,t.calculateProjection&&(t.calculateProjection(Xr,Du),t.calculateProjection(jr,Fu),t.calculateProjection(He,ln)),t.calculateTransform)t.calculateTransform(Us,Du),t.calculateTransform(Ns,Fu),t.calculateTransform(We,ln),Sn.copy(Us).invert(),bn.copy(Ns).invert(),ge.copy(We).invert();else{const l=t._node.parent;l?(n=l.getWorldTransform(),Us.mul2(n,i.leftViewInv),Ns.mul2(n,i.rightViewInv),Sn.copy(Us).invert(),bn.copy(Ns).invert(),ge.copy(l.getWorldTransform()).mul(i.combinedViewInv).invert()):(Us.copy(i.leftViewInv),Ns.copy(i.rightViewInv),Sn.copy(i.leftView),bn.copy(i.rightView),ge.copy(i.combinedView))}hm.setFromMat4(Sn),cm.setFromMat4(bn),dm.mul2(Xr,Sn),um.mul2(jr,bn),Lo.x=Us.data[12],Lo.y=Us.data[13],Lo.z=Us.data[14],Do.x=Ns.data[12],Do.y=Ns.data[13],Do.z=Ns.data[14],Ge.mul2(He,ge),t.frustum.setFromMat4(Ge)}else if(t.xr&&t.xr.session){const l=t._node.parent;l&&(n=l.getWorldTransform());const h=t.xr.views;for(let c=0;c<h.length;c++){const d=h[c];l?(d.viewInvOffMat.mul2(n,d.viewInvMat),d.viewOffMat.copy(d.viewInvOffMat).invert()):(d.viewInvOffMat.copy(d.viewInvMat),d.viewOffMat.copy(d.viewMat)),d.viewMat3.setFromMat4(d.viewOffMat),d.projViewOffMat.mul2(d.projMat,d.viewOffMat),d.position[0]=d.viewInvOffMat.data[12],d.position[1]=d.viewInvOffMat.data[13],d.position[2]=d.viewInvOffMat.data[14],t.frustum.setFromMat4(d.projViewOffMat)}}else{if(He=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(He,ln),this.projId.setValue(He.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data),t.calculateTransform)t.calculateTransform(We,ln);else{const l=t._node.getPosition(),h=t._node.getRotation();We.setTRS(l,h,y.ONE)}this.viewInvId.setValue(We.data),ge.copy(We).invert(),this.viewId.setValue(ge.data),rm.setFromMat4(ge),this.viewId3.setValue(rm.data),Ge.mul2(He,ge),e&&e.flipY?(om.mul2(am,Ge),lm.mul2(am,t.getProjectionMatrixSkybox()),this.viewProjId.setValue(om.data),this.projSkyboxId.setValue(lm.data)):(this.viewProjId.setValue(Ge.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data)),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(Ge)}this.tbnBasis.setValue(e&&e.flipY?-1:1),this.nearClipId.setValue(t._nearClip),this.farClipId.setValue(t._farClip);const r=t._nearClip,a=t._farClip;this.cameraParams[0]=1/a,this.cameraParams[1]=a,this.cameraParams[2]=(1-a/r)*.5,this.cameraParams[3]=(1+a/r)*.5,this.cameraParamsId.setValue(this.cameraParams),this.clearView(t,e,s,!1)}clearView(t,e,s,i,n){const r=this.device;r.setRenderTarget(e),r.updateBegin(),i&&(r.setColorWrite(!0,!0,!0,!0),r.setDepthWrite(!0));const a=e?e.width:r.width,l=e?e.height:r.height,h=t.rect;let c=Math.floor(h.x*a),d=Math.floor(h.y*l),u=Math.floor(h.z*a),f=Math.floor(h.w*l);if(r.setViewport(c,d,u,f),t._scissorRectClear){const m=t.scissorRect;c=Math.floor(m.x*a),d=Math.floor(m.y*l),u=Math.floor(m.z*a),f=Math.floor(m.w*l)}r.setScissor(c,d,u,f),s&&(n||(n=t._clearOptions),r.clear(n||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?Ha:0)|(t._clearDepthBuffer?pr:0)|(t._clearStencilBuffer?Vu:0),stencil:t._clearStencil}))}dispatchGlobalLights(t){if(this.ambientColor[0]=t.ambientLight.r,this.ambientColor[1]=t.ambientLight.g,this.ambientColor[2]=t.ambientLight.b,t.gammaCorrection)for(let e=0;e<3;e++)this.ambientColor[e]=Math.pow(this.ambientColor[e],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(t.exposure),t.skyboxModel&&this.skyboxIntensityId.setValue(t.skyboxIntensity)}_resolveLight(t,e){const s="light"+e;this.lightColorId[e]=t.resolve(s+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(s+"_direction"),this.lightShadowMapId[e]=t.resolve(s+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(s+"_shadowParams"),this.lightRadiusId[e]=t.resolve(s+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(s+"_position"),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(s+"_halfWidth"),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(s+"_halfHeight"),this.lightInAngleId[e]=t.resolve(s+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(s+"_outerConeAngle"),this.lightCookieId[e]=t.resolve(s+"_cookie"),this.lightCookieIntId[e]=t.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(s+"_cookieOffset"),this.shadowMatrixPaletteId[e]=t.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[e]=t.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[e]=t.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(t,e,s,i,n){this.lightPos[e][0]=i.x-s.x*n,this.lightPos[e][1]=i.y-s.y*n,this.lightPos[e][2]=i.z-s.z*n,this.lightPosId[e].setValue(this.lightPos[e]);const r=t.transformVector(new y(-.5,0,0));this.lightWidth[e][0]=r.x*n,this.lightWidth[e][1]=r.y*n,this.lightWidth[e][2]=r.z*n,this.lightWidthId[e].setValue(this.lightWidth[e]);const a=t.transformVector(new y(0,0,.5));this.lightHeight[e][0]=a.x*n,this.lightHeight[e][1]=a.y*n,this.lightHeight[e][2]=a.z*n,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s,i){let n=0;const r=this.device.scope;for(let a=0;a<t.length;a++){if(!(t[a].mask&s))continue;const l=t[a],h=l._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(r,n),this.lightColorId[n].setValue(e.gammaCorrection?l._linearFinalColor:l._finalColor),h.getY(l._direction).mulScalar(-1),l._direction.normalize(),this.lightDir[n][0]=l._direction.x,this.lightDir[n][1]=l._direction.y,this.lightDir[n][2]=l._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),l.shape!==ne&&this.setLTCDirectionalLight(h,n,l._direction,i._node.getPosition(),i.farClip),l.castShadows){const c=l.getRenderData(i,0),d=l._getUniformBiasValues(c);this.lightShadowMapId[n].setValue(c.shadowBuffer),this.lightShadowMatrixId[n].setValue(c.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(l._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(l._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(l.numCascades);const u=l._shadowRenderParams;u.length=3,u[0]=l._shadowResolution,u[1]=d.normalBias,u[2]=d.bias,this.lightShadowParamsId[n].setValue(u)}n++}return n}setLTCPositionalLight(t,e){const s=t.transformVector(new y(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const i=t.transformVector(new y(0,0,.5));this.lightHeight[e][0]=i.x,this.lightHeight[e][1]=i.y,this.lightHeight[e][2]=i.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==ne&&this.setLTCPositionalLight(n,i),s.castShadows){const r=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(r.shadowBuffer);const a=s._getUniformBiasValues(r),l=s._shadowRenderParams;l.length=4,l[0]=s._shadowResolution,l[1]=a.normalBias,l[2]=a.bias,l[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(l)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),s.shape!==ne&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const r=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(r.shadowBuffer),this.lightShadowMatrixId[i].setValue(r.shadowMatrix.data);const a=s._getUniformBiasValues(r),l=s._shadowRenderParams;l.length=4,l[0]=s._shadowResolution,l[1]=a.normalBias,l[2]=a.bias,l[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(l)}if(s._cookie){if(!s.castShadows){const r=ss.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(r.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(t,e,s,i,n){let r=i;const a=this.device.scope,l=t[ut],h=l.length;for(let f=0;f<h;f++){const m=l[f];!(m.mask&s)||m.isStatic||(this.dispatchOmniLight(e,a,m,r),r++)}let c=0;if(n){let f=n[c];for(;f&&f._type===ut;)this.dispatchOmniLight(e,a,f,r),r++,c++,f=n[c]}const d=t[_t],u=d.length;for(let f=0;f<u;f++){const m=d[f];!(m.mask&s)||m.isStatic||(this.dispatchSpotLight(e,a,m,r),r++)}if(n){let f=n[c];for(;f&&f._type===_t;)this.dispatchSpotLight(e,a,f,r),r++,c++,f=n[c]}}cull(t,e,s){let i=0;const n=e.length,r=t.cullingMask||4294967295;if(!t.frustumCulling){for(let a=0;a<n;a++){const l=e[a];!l.visible&&!l.command||l.mask&&(l.mask&r)==0||(s[i]=l,i++,l.visibleThisFrame=!0)}return i}for(let a=0;a<n;a++){const l=e[a];if(l.command)s[i]=l,i++,l.visibleThisFrame=!0;else{if(!l.visible)continue;let h=!0;if(l.mask&&(l.mask&r)==0)continue;l.cull&&(h=l._isVisible(t)),h&&(s[i]=l,i++,l.visibleThisFrame=!0)}}return i}cullLights(t,e){const s=this.scene.clusteredLightingEnabled;for(let i=0;i<e.length;i++){const n=e[i];if(n.enabled&&n._type!==lt)if(n.getBoundingSphere(Sc),t.frustum.containsSphere(Sc)){n.visibleThisFrame=!0;const r=t.getScreenSize(Sc);n.maxScreenSize=Math.max(n.maxScreenSize,r)}else s||n.castShadows&&!n.shadowMap&&(n.visibleThisFrame=!0)}}updateCpuSkinMatrices(t){wc++;const e=t.length;if(e!==0)for(let s=0;s<e;s++){const i=t[s].skinInstance;i&&(i.updateMatrices(t[s].node,wc),i._dirty=!0)}}updateGpuSkinMatrices(t){const e=t.length;for(let s=0;s<e;s++){if(!t[s].visibleThisFrame)continue;const i=t[s].skinInstance;i&&i._dirty&&(i.updateMatrixPalette(t[s].node,wc),i._dirty=!1)}}updateMorphing(t){const e=t.length;for(let s=0;s<e;s++){const i=t[s].morphInstance;i&&i._dirty&&t[s].visibleThisFrame&&i.update()}}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&(this.opacityMapId.setValue(e.opacityMap),this.alphaTestId.setValue(e.alphaTest))}setSkinning(t,e,s){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(wn=e.skinInstance.boneTexture,this.boneTextureId.setValue(wn),qr[0]=wn.width,qr[1]=wn.height,qr[2]=1/wn.width,qr[3]=1/wn.height,this.boneTextureSizeId.setValue(qr)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))}drawInstance(t,e,s,i,n){Vs=e.instancingData,Vs?Vs.count>0&&(this._instancedDrawCalls++,t.setVertexBuffer(Vs.vertexBuffer),t.draw(s.primitive[i],Vs.count)):(bc=e.node.worldTransform,this.modelMatrixId.setValue(bc.data),n&&(Bo=e.node.normalMatrix,e.node._dirtyNormal&&(bc.invertTo3x3(Bo),Bo.transpose(),e.node._dirtyNormal=!1),this.normalMatrixId.setValue(Bo.data)),t.draw(s.primitive[i]))}drawInstance2(t,e,s,i){Vs=e.instancingData,Vs?Vs.count>0&&(this._instancedDrawCalls++,t.draw(s.primitive[i],Vs.count,!0)):t.draw(s.primitive[i],void 0,!0)}renderShadows(t,e){const s=this.scene.clusteredLightingEnabled,i=this.device;i.grabPassAvailable=!1;for(let n=0;n<t.length;n++){const r=t[n];if(s&&r._type!==lt){if(!r.atlasViewportAllocated)continue;r.atlasSlotUpdated&&r.shadowUpdateMode===dr&&(r.shadowUpdateMode=ur)}this._shadowRenderer.render(r,e)}i.grabPassAvailable=!0}renderCookies(t){const e=this.lightTextureAtlas.cookieRenderTarget;for(let s=0;s<t.length;s++){const i=t[s];!i.atlasViewportAllocated||!i.atlasSlotUpdated||this._cookieRenderer.render(i,e)}}updateShader(t,e,s,i,n){t.material._scene=this.scene,t.material._dirtyBlend&&(this.scene.layers._dirtyBlend=!0),t.material.updateShader(this.device,this.scene,e,s,i,n),t._shader[i]=t.material.shader}setCullMode(t,e,s){const i=s.material;let n=me;if(t){let r=1;if(i.cull>me&&i.cull<Wu){s.flipFaces&&(r*=-1),e&&(r*=-1);const a=s.node.worldTransform;a.getX(pi),a.getY(Fo),a.getZ(Oo),pi.cross(pi,Fo),pi.dot(Oo)<0&&(r*=-1)}r<0?n=i.cull===Xa?cn:Xa:n=i.cull}if(this.device.setCullMode(n),n===me&&i.cull===me){const r=s.node.worldTransform;r.getX(pi),r.getY(Fo),r.getZ(Oo),pi.cross(pi,Fo),pi.dot(Oo)<0?this.twoSidedLightingNegScaleFactorId.setValue(-1):this.twoSidedLightingNegScaleFactorId.setValue(1)}}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){if(e)if(e.morph.useTextureMorph)t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams);else{for(let s=0;s<e._activeVertexBuffers.length;s++){const i=e._activeVertexBuffers[s];if(i){const n=vy+(s+8);i.format.elements[0].name=n,i.format.elements[0].scopeId=t.scope.resolve(n),i.format.update(),t.setVertexBuffer(i)}}this.morphWeightsA.setValue(e._shaderMorphWeightsA),this.morphWeightsB.setValue(e._shaderMorphWeightsB)}}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}renderForwardPrepareMaterials(t,e,s,i,n,r,a){const l=(_,g,w)=>{_i.drawCalls.push(_),_i.isNewMaterial.push(g),_i.lightMaskChanged.push(w)};_i.drawCalls.length=0,_i.isNewMaterial.length=0,_i.lightMaskChanged.length=0;const h=this.device,c=this.scene,d=r?r._lightHash:0;let u=null,f,m,p;for(let _=0;_<s;_++){const g=e[_];if(!(n&&g.mask&&!(n&g.mask)))if(g.command)l(g,!1,!1);else{g.material||(g.material=zi(h));const w=g.material,v=g._shaderDefs,x=g.mask;if(w&&w===u&&v!==f&&(u=null),(g.isStatic||m)&&(u=null),w!==u&&(this._materialSwitches++,w.dirty&&(w.updateUniforms(h,c),w.dirty=!1),!g._shader[a]||g._shaderDefs!==v||g._lightHash!==d)){if(g.isStatic)this.updateShader(g,v,g._staticLightList,a,i);else{const S=a+"_"+v+"_"+d;g._shader[a]=w.variants[S],g._shader[a]||(this.updateShader(g,v,null,a,i),w.variants[S]=g._shader[a])}g._shaderDefs=v,g._lightHash=d}l(g,w!==u,!u||x!==p),u=w,f=v,p=x,m=g.isStatic}}return _i}renderForward(t,e,s,i,n,r,a,l,h){const c=this.device,d=this.scene,u=t.vrDisplay,f=1<<n,m=c.width*.5,p=this.renderForwardPrepareMaterials(t,e,s,i,r,l,n),_=p.drawCalls.length;for(let g=0;g<_;g++){const w=p.drawCalls[g];if(w.command)w.command();else{const v=p.isNewMaterial[g],x=p.lightMaskChanged[g],S=w.material;w._shaderDefs;const T=w.mask;if(v){const D=w._shader[n];if(!D.failed&&!c.setShader(D),S.setParameters(c),x){const I=this.dispatchDirectLights(i[lt],d,T,t);this.dispatchLocalLights(i,d,T,I,w._staticLightList)}this.alphaTestId.setValue(S.alphaTest),c.setBlending(S.blend),S.blend&&(S.separateAlphaBlend?(c.setBlendFunctionSeparate(S.blendSrc,S.blendDst,S.blendSrcAlpha,S.blendDstAlpha),c.setBlendEquationSeparate(S.blendEquation,S.blendAlphaEquation)):(c.setBlendFunction(S.blendSrc,S.blendDst),c.setBlendEquation(S.blendEquation))),c.setColorWrite(S.redWrite,S.greenWrite,S.blueWrite,S.alphaWrite),c.setDepthWrite(S.depthWrite),S.depthWrite&&!S.depthTest?(c.setDepthFunc(Ri),c.setDepthTest(!0)):(c.setDepthFunc(S.depthFunc),c.setDepthTest(S.depthTest)),c.setAlphaToCoverage(S.alphaToCoverage),S.depthBias||S.slopeDepthBias?(c.setDepthBias(!0),c.setDepthBiasValues(S.depthBias,S.slopeDepthBias)):c.setDepthBias(!1)}this.setCullMode(t._cullFaces,h,w);const b=w.stencilFront||S.stencilFront,C=w.stencilBack||S.stencilBack;b||C?(c.setStencilTest(!0),b===C?(c.setStencilFunc(b.func,b.ref,b.readMask),c.setStencilOperation(b.fail,b.zfail,b.zpass,b.writeMask)):(b?(c.setStencilFuncFront(b.func,b.ref,b.readMask),c.setStencilOperationFront(b.fail,b.zfail,b.zpass,b.writeMask)):(c.setStencilFuncFront(Ri,0,255),c.setStencilOperationFront(ze,ze,ze,255)),C?(c.setStencilFuncBack(C.func,C.ref,C.readMask),c.setStencilOperationBack(C.fail,C.zfail,C.zpass,C.writeMask)):(c.setStencilFuncBack(Ri,0,255),c.setStencilOperationBack(ze,ze,ze,255)))):c.setStencilTest(!1);const M=w.mesh;w.setParameters(c,f),this.setVertexBuffers(c,M),this.setMorphing(c,w.morphInstance),this.setSkinning(c,w,S);const E=w.renderStyle;if(c.setIndexBuffer(M.indexBuffer[E]),a&&a(w,g),u&&u.presenting)c.setViewport(0,0,m,c.height),this.projId.setValue(Xr.data),this.projSkyboxId.setValue(Xr.data),this.viewInvId.setValue(Us.data),this.viewId.setValue(Sn.data),this.viewId3.setValue(hm.data),this.viewProjId.setValue(dm.data),this.dispatchViewPos(Lo),this.drawInstance(c,w,M,E,!0),this._forwardDrawCalls++,c.setViewport(m,0,m,c.height),this.projId.setValue(jr.data),this.projSkyboxId.setValue(jr.data),this.viewInvId.setValue(Ns.data),this.viewId.setValue(bn.data),this.viewId3.setValue(cm.data),this.viewProjId.setValue(um.data),this.dispatchViewPos(Do),this.drawInstance2(c,w,M,E),this._forwardDrawCalls++;else if(t.xr&&t.xr.session&&t.xr.views.length){const D=t.xr.views;for(let I=0;I<D.length;I++){const k=D[I];c.setViewport(k.viewport.x,k.viewport.y,k.viewport.z,k.viewport.w),this.projId.setValue(k.projMat.data),this.projSkyboxId.setValue(k.projMat.data),this.viewId.setValue(k.viewOffMat.data),this.viewInvId.setValue(k.viewInvOffMat.data),this.viewId3.setValue(k.viewMat3.data),this.viewProjId.setValue(k.projViewOffMat.data),this.viewPosId.setValue(k.position),I===0?this.drawInstance(c,w,M,E,!0):this.drawInstance2(c,w,M,E),this._forwardDrawCalls++}}else this.drawInstance(c,w,M,E,!0),this._forwardDrawCalls++;g<_-1&&!p.isNewMaterial[g+1]&&S.setParameters(c,w.parameters)}}c.updateEnd(),_i.length=0}updateShaders(t,e){const s=t.length;for(let i=0;i<s;i++){const n=t[i].material;if(n&&!Tc.has(n)&&(Tc.add(n),n.updateShader!==Ue.prototype.updateShader)){if(e&&(!n.useLighting||n.emitter&&!n.emitter.lighting))continue;n.clearVariants(),n.shader=null}}Tc.clear()}beginFrame(t,e){const s=t._meshInstances,i=this.scene;if(i.updateShaders||e){const l=!i.updateShaders&&e;this.updateShaders(s,l),i.updateShaders=!1,i._shaderVersion++}this.updateCpuSkinMatrices(s);const n=s.length;for(let l=0;l<n;l++)s[l].visibleThisFrame=!1;const r=t._lights,a=r.length;for(let l=0;l<a;l++)r[l].beginFrame()}beginLayers(t){const e=t.layerList.length;for(let n=0;n<e;n++)t.layerList[n]._postRenderCounter=0;const s=this.scene,i=s._shaderVersion;for(let n=0;n<e;n++){const r=t.layerList[n];r._shaderVersion=i,r._preRenderCalledForCameras=0,r._postRenderCalledForCameras=0,t.subLayerList[n]?r._postRenderCounter|=2:r._postRenderCounter|=1,r._postRenderCounterMax=r._postRenderCounter;for(let l=0;l<r.cameras.length;l++)r.instances.prepare(l);r._needsStaticPrepare&&r._staticLightHash&&!this.scene.clusteredLightingEnabled&&(r._staticPrepareDone&&(vn.revert(r.opaqueMeshInstances),vn.revert(r.transparentMeshInstances)),vn.prepare(this.device,s,r.opaqueMeshInstances,r._lights),vn.prepare(this.device,s,r.transparentMeshInstances,r._lights),t._dirty=!0,s.updateShaders=!0,r._needsStaticPrepare=!1,r._staticPrepareDone=!0)}}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t)}setSceneConstants(){const t=this.scene;if(this.dispatchGlobalLights(t),t.fog!==lh){if(this.fogColor[0]=t.fogColor.r,this.fogColor[1]=t.fogColor.g,this.fogColor[2]=t.fogColor.b,t.gammaCorrection)for(let s=0;s<3;s++)this.fogColor[s]=Math.pow(this.fogColor[s],2.2);this.fogColorId.setValue(this.fogColor),t.fog===Vg?(this.fogStartId.setValue(t.fogStart),this.fogEndId.setValue(t.fogEnd)):this.fogDensityId.setValue(t.fogDensity)}const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize)}updateLightStats(t,e){}cullShadowmaps(t){for(let s=0;s<t._lights.length;s++){const i=t._lights[s];if(i._type!==lt&&i.visibleThisFrame&&i.castShadows&&i.shadowUpdateMode!==dr){const n=t._lightCompositionData[s].shadowCastersList;this._shadowRenderer.cullLocal(i,n)}}const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.directionalLightsIndices.length;for(let r=0;r<n;r++){const a=i.directionalLightsIndices[r],l=t._lights[a],h=t._lightCompositionData[a].shadowCastersList;this._shadowRenderer.cullDirectional(l,h,i.camera.camera)}}}cullComposition(t){const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.layerIndex,r=t.layerList[n];if(!r.enabled||!t.subLayerEnabled[n])continue;const a=t.subLayerList[n],l=i.cameraIndex,h=r.cameras[l];if(h){h.frameBegin(i.renderTarget),i.firstCameraUse&&(this.updateCameraFrustum(h.camera),this._camerasRendered++),this.cullLights(h.camera,r._lights);const c=r.instances,d=a?c.visibleTransparent[l]:c.visibleOpaque[l];if(!d.done){r.onPreCull&&r.onPreCull(l);const u=a?r.transparentMeshInstances:r.opaqueMeshInstances;d.length=this.cull(h.camera,u,d.list),d.done=!0,r.onPostCull&&r.onPostCull(l)}h.frameEnd()}}this.cullShadowmaps(t)}updateLightTextureAtlas(t){this.lightTextureAtlas.update(t._splitLights[_t],t._splitLights[ut],this.scene.lighting)}updateClusters(t){for(let e=0;e<t._worldClusters.length;e++)t._worldClusters[e].update(t._lights,this.scene.gammaCorrection,this.scene.lighting)}renderComposition(t){const e=this.device,s=this.scene.clusteredLightingEnabled;this.scene._updateSkybox(this.device),this.beginLayers(t);const i=t._update(e,s),n=(i&Na)!=0;this.updateLightStats(t,i),this.beginFrame(t,n),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(t._meshInstances),s&&(this.updateLightTextureAtlas(t),this.scene.lighting.cookiesEnabled&&(this.renderCookies(t._splitLights[_t]),this.renderCookies(t._splitLights[ut]))),(!s||s&&this.scene.lighting.shadowsEnabled)&&(this.renderShadows(t._splitLights[_t]),this.renderShadows(t._splitLights[ut])),s&&this.updateClusters(t);let r=!1;const a=t._renderActions;for(let h=0;h<a.length;h++){const c=a[h],d=c.layerIndex,u=t.layerList[d],f=t.subLayerList[d],m=c.cameraIndex,p=u.cameras[m];if(c.directionalLights.length>0&&this.renderShadows(c.directionalLights,p.camera),!(!u.enabled||!t.subLayerEnabled[d])){if(p&&(p.frameBegin(c.renderTarget),c.firstCameraUse&&p.onPreRender&&p.onPreRender()),!f&&u.onPreRenderOpaque?u.onPreRenderOpaque(m):f&&u.onPreRenderTransparent&&u.onPreRenderTransparent(m),u._preRenderCalledForCameras&1<<m||(u.onPreRender&&u.onPreRender(m),u._preRenderCalledForCameras|=1<<m),p){var l;if(c.clearColor||c.clearDepth||c.clearStencil){const x=p.camera._clearColorBuffer,S=p.camera._clearDepthBuffer,T=p.camera._clearStencilBuffer;p.camera._clearColorBuffer=c.clearColor,p.camera._clearDepthBuffer=c.clearDepth,p.camera._clearStencilBuffer=c.clearStencil,this.clearView(p.camera,c.renderTarget,!0,!0),p.camera._clearColorBuffer=x,p.camera._clearDepthBuffer=S,p.camera._clearStencilBuffer=T}u._sortVisible(f,p.camera.node,m);const _=u.instances,g=f?_.visibleTransparent[m]:_.visibleOpaque[m];this.scene.immediate.onPreRenderLayer(u,g,f),this.scene._activeCamera=p.camera,this.setCamera(p.camera,c.renderTarget),s&&c.lightClusters&&(c.lightClusters.activate(this.lightTextureAtlas),!r&&this.scene.lighting.debugLayer===u.id&&(r=!0));const w=!!(p.camera._flipFaces^(c==null||(l=c.renderTarget)==null?void 0:l.flipY)),v=this._forwardDrawCalls;this.renderForward(p.camera,g.list,g.length,u._splitLights,u.shaderPass,u.cullingMask,u.onDrawCall,u,w),u._forwardDrawCalls+=this._forwardDrawCalls-v,e.setColorWrite(!0,!0,!0,!0),e.setStencilTest(!1),e.setAlphaToCoverage(!1),e.setDepthBias(!1),p.frameEnd(),c.lastCameraUse&&p.onPostRender&&p.onPostRender(),c.triggerPostprocess&&p.onPostprocessing&&p.onPostprocessing()}!f&&u.onPostRenderOpaque?u.onPostRenderOpaque(m):f&&u.onPostRenderTransparent&&u.onPostRenderTransparent(m),u.onPostRender&&!(u._postRenderCalledForCameras&1<<m)&&(u._postRenderCounter&=~(f?2:1),u._postRenderCounter===0&&(u.onPostRender(m),u._postRenderCalledForCameras|=1<<m,u._postRenderCounter=u._postRenderCounterMax))}}}}let Cc,Ac,ko,zo;function iw(o,t){return o.drawOrder-t.drawOrder}function nw(o,t){return Cc=o._key[Ps],Ac=t._key[Ps],Cc===Ac&&o.mesh&&t.mesh?t.mesh.id-o.mesh.id:Ac-Cc}function rw(o,t){return t.zdist-o.zdist}function aw(o,t){return o.zdist-t.zdist}const ow=[null,iw,nw,rw,aw];function lw(o,t){return t.key-o.key}let Mc=0;class fm{constructor(){this.list=[],this.length=0,this.done=!1}}class hw{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(t){this.visibleOpaque[t]||(this.visibleOpaque[t]=new fm),this.visibleTransparent[t]||(this.visibleTransparent[t]=new fm),this.visibleOpaque[t].done=!1,this.visibleTransparent[t].done=!1}delete(t){t<this.visibleOpaque.length&&this.visibleOpaque.splice(t,1),t<this.visibleTransparent.length&&this.visibleTransparent.splice(t,1)}}class Vi{constructor(t={}){t.id!==void 0?(this.id=t.id,Mc=Math.max(this.id+1,Mc)):this.id=Mc++,this.name=t.name,this._enabled=t.enabled===void 0?!0:t.enabled,this._refCounter=this._enabled?1:0,this.opaqueSortMode=t.opaqueSortMode===void 0?ly:t.opaqueSortMode,this.transparentSortMode=t.transparentSortMode===void 0?Ou:t.transparentSortMode,this.renderTarget=t.renderTarget,this.shaderPass=t.shaderPass===void 0?on:t.shaderPass,this.passThrough=t.passThrough===void 0?!1:t.passThrough,this._clearColorBuffer=t.clearColorBuffer?t.clearColorBuffer:!1,this._clearDepthBuffer=t.clearDepthBuffer?t.clearDepthBuffer:!1,this._clearStencilBuffer=t.clearStencilBuffer?t.clearStencilBuffer:!1,this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=t.layerReference,this.instances=t.layerReference?t.layerReference.instances:new hw,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}set renderTarget(t){this._renderTarget=t,this._dirtyCameras=!0}get renderTarget(){return this._renderTarget}set enabled(t){t!==this._enabled&&(this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyCameras=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){this._refCounter===0&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(this._refCounter===1)this._enabled=!1,this.onDisable&&this.onDisable();else if(this._refCounter===0)return;this._refCounter--}addMeshInstances(t,e){const s=this._shaderVersion,i=this.shadowCasters;for(let n=0;n<t.length;n++){const r=t[n],a=r.material,l=a.blendType===he?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(r)<0&&this.transparentMeshInstances.indexOf(r)<0&&l.push(r),!e&&r.castShadow&&i.indexOf(r)<0&&i.push(r),!this.passThrough&&s>=0&&a._shaderVersion!==s&&(a.updateShader!==Ue.prototype.updateShader&&(a.clearVariants(),a.shader=null),a._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(t,e){let s=-1,i=0;const n=e.length;for(let r=0;r<n;r++){const a=e[r];if(a===t){s=r,i=1;break}if(a._staticSource===t)s<0&&(s=r),i++;else if(s>=0)break}s>=0&&e.splice(s,i)}removeMeshInstances(t,e){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,n=this.shadowCasters;for(let r=0;r<t.length;r++){const a=t[r];if(this.removeMeshInstanceFromArray(a,s),this.removeMeshInstanceFromArray(a,i),!e){const l=n.indexOf(a);l>=0&&n.splice(l,1)}}this._dirty=!0}clearMeshInstances(t){this.opaqueMeshInstances.length===0&&this.transparentMeshInstances.length===0&&(t||this.shadowCasters.length===0)||(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),e.type!==lt&&this._clusteredLightsSet.add(e),this._lights.push(e),this._dirtyLights=!0,this._generateLightHash())}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),e.type!==lt&&this._clusteredLightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this._dirtyLights=!0,this._generateLightHash())}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}addShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=t[s];!i.castShadow||e.indexOf(i)<0&&e.push(i)}this._dirtyLights=!0}removeShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=e.indexOf(t[s]);i>=0&&e.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(lw);let t="",e="";for(let s=0;s<this._lights.length;s++)this._lights[s].isStatic?e+=this._lights[s].key:t+=this._lights[s].key;t.length===0?this._lightHash=0:this._lightHash=Er(t),e.length===0?this._staticLightHash=0:this._staticLightHash=Er(e)}else this._lightHash=0,this._staticLightHash=0}addCamera(t){this.cameras.indexOf(t)>=0||(this.cameras.push(t),this._dirtyCameras=!0)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this._dirtyCameras=!0,this.instances.delete(e))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(t,e,s,i){for(let n=0;n<e;n++){const r=t[n];if(r.command||r.layer<=Gg)continue;if(r.calculateSortDistance){r.zdist=r.calculateSortDistance(r,s,i);continue}const a=r.aabb.center,l=a.x-s.x,h=a.y-s.y,c=a.z-s.z;r.zdist=l*i.x+h*i.y+c*i.z}}_sortVisible(t,e,s){const i=this.instances,n=t?this.transparentSortMode:this.opaqueSortMode;if(n===Sh)return;const r=t?i.visibleTransparent[s]:i.visibleOpaque[s];n===cy?(ko=e.getPosition(),zo=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(r.list,r.length,ko,zo),r.list.length!==r.length&&(r.list.length=r.length),this.customSortCallback&&r.list.sort(this.customSortCallback)):((n===Ou||n===hy)&&(ko=e.getPosition(),zo=e.forward,this._calculateSortDistances(r.list,r.length,ko,zo)),r.list.length!==r.length&&(r.list.length=r.length),r.list.sort(ow[n]))}}const cw={equals:function(o,t){if(o.size!==t.size)return!1;for(const e of o)if(!t.has(e))return!1;return!0}},dw=(o,t)=>o.priority-t.priority,Yr=o=>o.sort(dw);class uw{constructor(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[]}reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0}collectDirectionalLights(t,e,s){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(let i=0;i<e.length;i++){const n=e[i];if(n.castShadows){for(let r=0;r<t.length;r++)if(t[r]._splitLights[lt].indexOf(n)>=0&&!this.directionalLightsSet.has(n)){this.directionalLightsSet.add(n),this.directionalLights.push(n);const a=s.indexOf(n);this.directionalLightsIndices.push(a)}}}}}class fw{constructor(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0}addShadowCasters(t){for(let e=0;e<t.length;e++){const s=t[e];this.shadowCastersSet.has(s)||(this.shadowCastersSet.add(s),this.shadowCastersList.push(s))}}}const An=new Set,$r=[];class mm extends at{constructor(t="Untitled"){super();this.name=t,this.logRenderActions=!1,this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirty=!1,this._dirtyBlend=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._meshInstances=[],this._meshInstancesSet=new Set,this._lights=[],this._lightsMap=new Map,this._lightCompositionData=[],this._splitLights=[[],[],[]],this.cameras=[],this._renderActions=[],this._worldClusters=[],this._emptyWorldClusters=null}destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach(t=>{t.destroy()}),this._worldClusters=null}getEmptyWorldClusters(t){return this._emptyWorldClusters||(this._emptyWorldClusters=new gc(t),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1,null)),this._emptyWorldClusters}_splitLightsArray(t){const e=t._lights;t._splitLights[lt].length=0,t._splitLights[ut].length=0,t._splitLights[_t].length=0;for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&t._splitLights[i._type].push(i)}}_update(t,e=!1){const s=this.layerList.length;let i=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(let a=0;a<s;a++){const l=this.layerList[a];l._dirty&&(this._dirty=!0),l._dirtyLights&&(this._dirtyLights=!0),l._dirtyCameras&&(this._dirtyCameras=!0)}function n(a,l,h){let c=!1;const d=h.length;for(let u=0;u<d;u++){const f=h[u];if(!l.has(f)){l.add(f),a.push(f);const m=f.material;m&&m._dirtyBlend&&(c=!0,m._dirtyBlend=!1)}}return c}if(this._dirty){i|=dy,this._meshInstances.length=0,this._meshInstancesSet.clear();for(let a=0;a<s;a++){const l=this.layerList[a];l.passThrough||(this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,l.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,l.transparentMeshInstances)||this._dirtyBlend),l._dirty=!1}this._dirty=!1}function r(a,l,h){for(let d=0;d<l.length;){var c;((c=l[d].material)==null?void 0:c.transparent)===h?(a.push(l[d]),l[d]=l[l.length-1],l.length--):d++}}if(this._dirtyBlend){i|=uy;for(let a=0;a<s;a++){const l=this.layerList[a];l.passThrough||(r(l.opaqueMeshInstances,l.transparentMeshInstances,!1),r(l.transparentMeshInstances,l.opaqueMeshInstances,!0))}this._dirtyBlend=!1}if(this._dirtyLights&&(i|=Na,this._dirtyLights=!1,this.updateLights()),i&&this.updateShadowCasters(),this._dirtyCameras||i&Na){this._dirtyCameras=!1,i|=Bu,this.cameras.length=0;for(let h=0;h<s;h++){const c=this.layerList[h];c._dirtyCameras=!1;for(let d=0;d<c.cameras.length;d++){const u=c.cameras[d];this.cameras.indexOf(u)<0&&this.cameras.push(u)}}this.cameras.length>1&&Yr(this.cameras);const a=[];let l=0;for(let h=0;h<this.cameras.length;h++){const c=this.cameras[h];a.length=0;let d=!0;const u=l;let f=null,m=!1;for(let p=0;p<s;p++){const _=this.layerList[p];if(_&&_.cameras.length>0&&c.layers.indexOf(_.id)>=0){a.push(_),!m&&_.id===c.disablePostEffectsLayer&&(m=!0,f&&(f.triggerPostprocess=!0));const g=_.cameras.indexOf(c);g>=0&&(f=this.addRenderAction(this._renderActions,l,_,p,g,d,m),l++,d=!1)}}u<l&&(this._renderActions[u].collectDirectionalLights(a,this._splitLights[lt],this._lights),f.lastCameraUse=!0),!m&&f&&(f.triggerPostprocess=!0),c.renderTarget&&c.postEffectsEnabled&&this.propagateRenderTarget(u-1,c)}this._renderActions.length=l,e&&this.allocateLightClusters(t)}return(i&Na||i&Bu)&&this._logRenderActions(),i}updateShadowCasters(){const t=this._lights.length;for(let s=0;s<t;s++)this._lightCompositionData[s].clearShadowCasters();const e=this.layerList.length;for(let s=0;s<e;s++){const i=this.layerList[s];if(!An.has(i)){An.add(i);const n=i._lights;for(let r=0;r<n.length;r++)if(n[r].castShadows){const a=this._lightsMap.get(n[r]);this._lightCompositionData[a].addShadowCasters(i.shadowCasters)}}}An.clear()}updateLights(){this._lights.length=0,this._lightsMap.clear();const t=this.layerList.length;for(let s=0;s<t;s++){const i=this.layerList[s];if(!An.has(i)){An.add(i);const n=i._lights;for(let r=0;r<n.length;r++){const a=n[r];let l=this._lightsMap.get(a);if(l===void 0){l=this._lights.length,this._lightsMap.set(a,l),this._lights.push(a);let h=this._lightCompositionData[l];h||(h=new fw,this._lightCompositionData[l]=h)}}}this._splitLightsArray(i),i._dirtyLights=!1}An.clear(),this._splitLightsArray(this);const e=this._lights.length;this._lightCompositionData.length=e}findCompatibleCluster(t,e){for(let s=0;s<e;s++){const i=this._renderActions[s],n=this.layerList[i.layerIndex];if(t===n||i.lightClusters&&cw.equals(t._clusteredLightsSet,n._clusteredLightsSet))return i.lightClusters}return null}allocateLightClusters(t){$r.push(...this._worldClusters),this._worldClusters.length=0;const e=this._renderActions.length;for(let s=0;s<e;s++){const i=this._renderActions[s],n=this.layerList[i.layerIndex];if(n._clusteredLightsSet.size&&(this.subLayerList[i.layerIndex]?n.transparentMeshInstances:n.opaqueMeshInstances).length){let l=this.findCompatibleCluster(n,s);l||($r.length&&(l=$r.pop()),l||(l=new gc(t)),l.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(l)),i.lightClusters=l}i.lightClusters||(i.lightClusters=this.getEmptyWorldClusters(t))}$r.forEach(s=>{s.destroy()}),$r.length=0}addRenderAction(t,e,s,i,n,r,a){let l=t[e];l||(l=t[e]=new uw);let h=s.renderTarget;const c=s.cameras[n];c&&c.renderTarget&&s.id!==fs&&(h=c.renderTarget);let d=!1;for(let _=e-1;_>=0;_--)if(t[_].camera===c&&t[_].renderTarget===h){d=!0;break}const u=r||!d;let f=u?c.clearColorBuffer:!1,m=u?c.clearDepthBuffer:!1,p=u?c.clearStencilBuffer:!1;return f|=s.clearColorBuffer,m|=s.clearDepthBuffer,p|=s.clearStencilBuffer,a&&c.postEffectsEnabled&&(h=null),l.reset(),l.triggerPostprocess=!1,l.layerIndex=i,l.cameraIndex=n,l.camera=c,l.renderTarget=h,l.clearColor=f,l.clearDepth=m,l.clearStencil=p,l.firstCameraUse=r,l.lastCameraUse=!1,l}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const i=this._renderActions[s],n=this.layerList[i.layerIndex];if(i.renderTarget&&n.id!==fs)break;if(n.id===fs)continue;const r=i==null?void 0:i.camera.camera;if(r&&(!e.camera.rect.equals(r.rect)||!e.camera.scissorRect.equals(r.scissorRect)))break;i.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerList.indexOf(t)>=0}_isSublayerAdded(t,e){for(let s=0;s<this.layerList.length;s++)if(this.layerList[s]===t&&this.subLayerList[s]===e)return!0;return!1}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1)}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.layerList.indexOf(t)<0&&this.fire("remove",t);return}}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.layerList.indexOf(t)<0&&this.fire("remove",t);return}}_getSublayerIndex(t,e){let s=this.layerList.indexOf(t);return s<0||this.subLayerList[s]!==e&&(s=this.layerList.indexOf(t,s+1),s<0||this.subLayerList[s]!==e)?-1:s}getOpaqueIndex(t){return this._getSublayerIndex(t,!1)}getTransparentIndex(t){return this._getSublayerIndex(t,!0)}getLayerById(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].id===t)return this.layerList[e];return null}getLayerByName(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].name===t)return this.layerList[e];return null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)this.subLayerList[s]===!1&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)this.subLayerList[s]===!0&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let i=-1,n=-1;for(let r=0,a=t.length;r<a;r++){const l=t[r];s.hasOwnProperty(l)&&(i=Math.max(i,s[l]))}for(let r=0,a=e.length;r<a;r++){const l=e[r];s.hasOwnProperty(l)&&(n=Math.max(n,s[l]))}return i===-1&&n!==-1?1:n===-1&&i!==-1?-1:n-i}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const Uo=new y,No=new y,Pc=new y,ns={bias:0,normalBias:0},Ec={r:0,g:1,b:2,a:3},mw=[[new Z(0,0,1,1)],[new Z(0,0,.5,.5),new Z(0,.5,.5,.5)],[new Z(0,0,.5,.5),new Z(0,.5,.5,.5),new Z(.5,0,.5,.5)],[new Z(0,0,.5,.5),new Z(0,.5,.5,.5),new Z(.5,0,.5,.5),new Z(.5,.5,.5,.5)]];let pw=0;class _w{constructor(t,e,s,i){this.light=i,this.camera=e,this.shadowCamera=Io.createShadowCamera(t,i._shadowType,i._type,s),this.shadowMatrix=new G,this.shadowViewport=new Z(0,0,1,1),this.shadowScissor=new Z(0,0,1,1),this.face=s,this.visibleCasters=[]}get shadowBuffer(){const t=this.shadowCamera.renderTarget;if(t){const e=this.light;return e._type===ut?t.colorBuffer:e._isPcf&&e.device.webgl2?t.depthBuffer:t.colorBuffer}return null}}class Rc{constructor(t){this.device=t,this.id=pw++,this._type=lt,this._color=new j(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this.mask=xs,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=dh,this._shadowType=Kt,this._vsmBlurSize=11,this.vsmBlurMode=uh,this.vsmBias=.01*.25,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=ne,this._finalColor=new Float32Array([.8,.8,.8]);const e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new y(0,0,0),this._direction=new y(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowMap=null,this._shadowRenderParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=za,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0}destroy(){this._destroyShadowMap(),this._renderData=null}set numCascades(t){(!this.cascades||this.numCascades!=t)&&(this.cascades=mw[t-1],this._shadowMatrixPalette=new Float32Array(4*16),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}get numShadowFaces(){const t=this._type;return t===lt?this.numCascades:t===ut?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set shadowType(t){if(this._shadowType===t)return;const e=this.device;this._type===ut&&(t=Kt),t===_s&&!e.webgl2&&(t=Kt),t===ps&&!e.textureFloatRenderable&&(t=Ms),t===Ms&&!e.textureHalfFloatRenderable&&(t=ms),this._isVsm=t>=ms&&t<=ps,this._isPcf=t===_s||t===Kt,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&this.mask!==Rs&&this.mask!==0}set shadowResolution(t){this._shadowResolution!==t&&(this._type===ut?t=Math.min(t,this.device.maxCubeMapSize):t=Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180))}get outerConeAngle(){return this._outerConeAngle}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}get intensity(){return this._intensity}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new G),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new Z(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new H,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!!(this._cookieTransformSet||t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new Z(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=this._type===lt&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){this._renderData&&(this._renderData.length=0),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),this.shadowUpdateMode===dr&&(this.shadowUpdateMode=ur)}getRenderData(t,e){for(let i=0;i<this._renderData.length;i++){const n=this._renderData[i];if(n.camera===t&&n.face===e)return n}const s=new _w(this.device,t,e,this);return this._renderData.push(s),s}clone(){const t=new Rc(this.device);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.shape=this._shape,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case ut:ns.bias=this.shadowBias,ns.normalBias=this._normalOffsetBias;break;case _t:this._isVsm?ns.bias=-1e-5*20:(ns.bias=this.shadowBias*20,!this.device.webgl2&&this.device.extStandardDerivatives&&(ns.bias*=-100)),ns.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case lt:this._isVsm?ns.bias=-1e-5*20:(ns.bias=this.shadowBias/e*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(ns.bias*=-100)),ns.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias;break}return ns}getColor(){return this._color}getBoundingSphere(t){if(this._type===_t){const e=this.attenuationEnd,s=this._outerConeAngle,i=Math.cos(s*U.DEG_TO_RAD),n=this._node;Uo.copy(n.up),Uo.mulScalar(-e*.5*i),Uo.add(n.getPosition()),t.center=Uo,No.copy(n.up),No.mulScalar(-e),Pc.copy(n.right),Pc.mulScalar(Math.sin(s*U.DEG_TO_RAD)*e),No.add(Pc),t.radius=No.length()*.5}else this._type===ut&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(this._type===_t){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*U.DEG_TO_RAD)*e);t.center.set(0,-e*.5,0),t.halfExtents.set(n,e*.5,n),t.setFromTransformedAabb(t,i.getWorldTransform(),!0)}else this._type===ut&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const t=this._color,e=t.r,s=t.g,i=t.b,n=this._intensity,r=this._finalColor,a=this._linearFinalColor;r[0]=e*n,r[1]=s*n,r[2]=i*n,n>=1?(a[0]=Math.pow(e,2.2)*n,a[1]=Math.pow(s,2.2)*n,a[2]=Math.pow(i,2.2)*n):(a[0]=Math.pow(r[0],2.2),a[1]=Math.pow(r[1],2.2),a[2]=Math.pow(r[2],2.2))}setColor(){arguments.length===1?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):arguments.length===3&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}updateShadow(){this.shadowUpdateMode!==za&&(this.shadowUpdateMode=ur)}layersDirty(){var t;(t=this._scene)!=null&&t.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Ec[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8;this._cookieChannel.length===3&&(t|=Ec[this._cookieChannel.charAt(1)]<<16,t|=Ec[this._cookieChannel.charAt(2)]<<14),t!==this.key&&this._scene!==null&&this.layersDirty(),this.key=t}}class pm{constructor(t,e,s){this._maxTextureSize=e,this._supportsAreaLights=t,this._dirtyLightsFnc=s,this._areaLightsEnabled=!1,this._cells=new y(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=Kt,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this.debugLayer=void 0}set cells(t){this._cells.copy(t)}get cells(){return this._cells}set maxLightsPerCell(t){this._maxLightsPerCell=U.clamp(t,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(t){this._cookieAtlasResolution=U.clamp(t,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=U.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const Kr=new Ci;class _m{constructor(t,e){this.scene=t,this.light=e,this.store(),e.numCascades=1,e.type!==lt&&(e._node.getWorldTransform(),e.getBoundingSphere(Kr),this.lightBounds=new gt,this.lightBounds.center.copy(Kr.center),this.lightBounds.halfExtents.set(Kr.radius,Kr.radius,Kr.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&(e.shadowMap.cached&&t.add(e,e.shadowMap),e.shadowMap=null)}}const Vo=new H;class gw extends _m{get numVirtualLights(){return this.light.type===lt?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const r=s.bakeArea;kr.circlePointDeterministic(Vo,t,e),Vo.mulScalar(r*.5),s._node.rotateLocal(Vo.x,0,Vo.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/e,1/i)}}class yw{constructor(t,e){this.texture0=t,this.texture1=e}destroy(){var t,e;(t=this.texture0)==null||t.destroy(),(e=this.texture1)==null||e.destroy()}}const gm=new Rr;class Wi{static createTexture(t,e,s,i=""){const n=new nt(t,{width:s,height:s,format:e,addressU:et,addressV:et,type:_e,magFilter:Yt,minFilter:bt,anisotropy:1});return n.name=`AreaLightLUT${i}`,n}static applyTextures(t,e,s){gm.remove(t),gm.get(t,()=>new yw(e,e===s?null:s)),t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=Wi.createTexture(t,ct,2,"placeholder");e.lock().fill(0),e.unlock(),Wi.applyTextures(t,e,e)}static set(t,e){function s(c,d,u){const f=Wi.createTexture(c,u,64);return f.lock().set(d),f.unlock(),f.upload(),f}function i(c,d,u){const f=c.length,m=new Float32Array(f);for(let p=0;p<f;p++){const _=p%4;m[p]=(c[p]+d[_])*u[_]}return m}function n(c){const d=c.length,u=new Uint16Array(d),f=It.float2Half;for(let m=0;m<d;m++)u[m]=f(c[m]);return u}function r(c){const d=c.length,u=new Uint8ClampedArray(d);for(let f=0;f<d;f++)u[f]=c[f]*255;return u}const a=new Int16Array(e,0,2),l=a[0],h=a[1];if(!(l!==0||h!==1)){const c=new Float32Array(e,4,16384),d=new Float32Array(e,4+16384*4,16384);let u,f;const m=t.areaLightLutFormat;if(m===Vt)u=c,f=d;else if(m===ce)u=n(c),f=n(d);else{const g=[0,.2976,.01381,0],w=[.999,3.08737,1.6546,.603249],v=[-.306897,0,0,0],x=[1.442787,1,1,1];u=r(i(c,g,w)),f=r(i(d,v,x))}const p=s(t,u,m),_=s(t,f,m);Wi.applyTextures(t,p,_)}}}const ym=.2;class Ee extends lc{constructor(t,e){super();this.device=e||Ne().graphicsDevice,this._targets=t,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=Ee.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=Ee.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=Ee.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=Ee.FORMAT_FLOAT),this._renderTextureFormat!==void 0&&this._textureFormat!==void 0&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_initTextureBased(){const t=[],e=[];for(let _=0;_<this._targets.length;_++){const g=this._targets[_];g.options.deltaPositions&&(t.push(g.options.deltaPositions),e.push({target:g,name:"texturePositions"})),g.options.deltaNormals&&(t.push(g.options.deltaNormals),e.push({target:g,name:"textureNormals"}))}const s=[],i=[];let n=1;const r=t[0].length;for(let _=0;_<r;_+=3){let g=!1;for(let w=0;w<t.length;w++){const v=t[w];if(v[_]!==0||v[_+1]!==0||v[_+2]!==0){g=!0;break}}g?(s.push(n+ym),i.push(_/3),n++):s.push(0+ym)}const a=Math.min(this.device.maxTextureSize,4096);let l=Math.ceil(Math.sqrt(n));l=Math.min(l,a);const h=Math.ceil(n/l);if(h>a)return!1;this.morphTextureWidth=l,this.morphTextureHeight=h;let c=!1,d=3;const u=It.float2Half;this._textureFormat===Ee.FORMAT_HALF_FLOAT&&(c=!0,d=4);const f=this.morphTextureWidth*this.morphTextureHeight*d,m=c?new Uint16Array(f):new Float32Array(f);for(let _=0;_<t.length;_++){const g=t[_];for(let x=0;x<i.length;x++){const S=i[x];c?(m[x*d+d]=u(g[S*3]),m[x*d+d+1]=u(g[S*3+1]),m[x*d+d+2]=u(g[S*3+2])):(m[x*d+d]=g[S*3],m[x*d+d+1]=g[S*3+1],m[x*d+d+2]=g[S*3+2])}const w=e[_].target,v=this._textureFormat===Ee.FORMAT_FLOAT?xr:ce;w._setTexture(e[_].name,this._createTexture("MorphTarget",v,m))}const p=[{semantic:Fi,components:1,type:wt}];return this.vertexBufferIds=new Ds(this.device,new re(this.device,p),s.length,ve,new Float32Array(s)),!0}destroy(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_calculateAabb(){const t=new y,e=new y;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;t.min(i.getMin()),e.max(i.getMax())}this.aabb=new gt,this.aabb.setMinMax(t,e)}_createTexture(t,e,s){const i=new nt(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:bt,magFilter:bt,addressU:et,addressV:et});return i.name=t,s&&(i.lock().set(s),i.unlock()),i}}Ee.FORMAT_FLOAT=0;Ee.FORMAT_HALF_FLOAT=1;const xw=`
		attribute vec2 vertex_position;
		varying vec2 uv0;
		void main(void) {
				gl_Position = vec4(vertex_position, 0.5, 1.0);
				uv0 = vertex_position.xy * 0.5 + 0.5;
		}
		`;class Gi{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device,this.meshInstance=null,this._weights=[];for(let e=0;e<t._targets.length;e++)this.setWeight(e,t._targets[e].defaultWeight);if(this._activeTargets=[],t.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const e=(s,i)=>{const n=t._renderTextureFormat===Ee.FORMAT_FLOAT?Vt:ce;return this[i]=t._createTexture(s,n),new oe({colorBuffer:this[i],depth:!1})};t.morphPositions&&(this.rtPositions=e("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=e("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight,1/t.morphTextureWidth,1/t.morphTextureHeight]);for(let s=0;s<this.maxSubmitCount;s++)this["morphBlendTex"+s]=this.device.scope.resolve("morphBlendTex"+s);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,4*4,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.meshInstance=null,this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.refCount<1&&t.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new Gi(this.morph)}getWeight(t){return this._weights[t]}setWeight(t,e){this._weights[t]=e,this._dirty=!0}_getFragmentShader(t){let e="";t>0&&(e+=`varying vec2 uv0;
uniform highp float morphFactor[`+t+`];
`);for(let s=0;s<t;s++)e+="uniform highp sampler2D morphBlendTex"+s+`;
`;e+=`void main (void) {
		highp vec4 color = vec4(0, 0, 0, 1);
`;for(let s=0;s<t;s++)e+="		color.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+`, uv0).xyz;
`;return e+=`		gl_FragColor = color;
}
`,e}_getShader(t){let e=this.shaderCache[t];if(!e){const s=this._getFragmentShader(t);e=we(this.device,xw,s,"textureMorph"+t),this.shaderCache[t]=e}return e}_updateTextureRenderTarget(t,e){const s=this.device,i=(l,h)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlending(h),h&&(s.setBlendFunction(Pt,Pt),s.setBlendEquation(Nt));const c=this._getShader(l);es(s,t,c,void 0,void 0,h)};let n=0,r=!1;const a=this._activeTargets.length;for(let l=0;l<a;l++){const h=this._activeTargets[l],c=h.target[e];c&&(this["morphBlendTex"+n].setValue(c),this._shaderMorphWeights[n]=h.weight,n++,n>=this.maxSubmitCount&&(i(n,r),n=0,r=!0))}(n>0||a===0&&!this.zeroTextures)&&i(n,r)}_updateTextureMorph(){this.device,(this._activeTargets.length>0||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=this._activeTargets.length===0)}_updateVertexMorph(){const t=this.maxSubmitCount;for(let i=0;i<t;i++)this._shaderMorphWeights[i]=0,this._activeVertexBuffers[i]=null;let e=0,s=this.morph.morphPositions?4:0;for(let i=0;i<this._activeTargets.length;i++){const n=this._activeTargets[i].target;n._vertexBufferPositions&&(this._activeVertexBuffers[e]=n._vertexBufferPositions,this._shaderMorphWeights[e]=this._activeTargets[i].weight,e++),n._vertexBufferNormals&&(this._activeVertexBuffers[s]=n._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[i].weight,s++)}}update(){this._dirty=!1;const t=this.morph._targets;let e=0;const s=1e-5;for(let n=0;n<t.length;n++){const r=Math.abs(this.getWeight(n));if(r>s){this._activeTargets.length<=e&&(this._activeTargets[e]={});const a=this._activeTargets[e++];a.absWeight=r,a.weight=this.getWeight(n),a.target=t[n]}}this._activeTargets.length=e;const i=this.morph.maxActiveTargets;this._activeTargets.length>i&&(this._activeTargets.sort(function(n,r){return n.absWeight<r.absWeight?1:r.absWeight<n.absWeight?-1:0}),this._activeTargets.length=i),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class Ts{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];t.indexOf(s.material)===-1&&t.push(s.material)}return t}clone(){const t=[],e=[],i=function h(c){const d=c.clone();t.push(c),e.push(d);for(let u=0;u<c._children.length;u++)d.addChild(h(c._children[u]));return d}(this.graph),n=[],r=[],a=[];for(let h=0;h<this.skinInstances.length;h++){const c=this.skinInstances[h].skin,d=new Wr(c),u=[];for(let f=0;f<c.boneNames.length;f++){const m=c.boneNames[f],p=i.findByName(m);u.push(p)}d.bones=u,r.push(d)}for(let h=0;h<this.morphInstances.length;h++){const c=this.morphInstances[h].morph,d=new Gi(c);a.push(d)}for(let h=0;h<this.meshInstances.length;h++){const c=this.meshInstances[h],d=t.indexOf(c.node),u=new vt(c.mesh,c.material,e[d]);if(c.skinInstance){const f=this.skinInstances.indexOf(c.skinInstance);u.skinInstance=r[f]}if(c.morphInstance){const f=this.morphInstances.indexOf(c.morphInstance);u.morphInstance=a[f]}n.push(u)}const l=new Ts;return l.graph=i,l.meshInstances=n,l.skinInstances=r,l.morphInstances=a,l.getGraph().syncHierarchy(),l}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){vt._prepareRenderStyleForArray(this.meshInstances,Mi)}}const Wo=new xt;Wo.worldTransform=G.IDENTITY;Wo._dirtyWorld=Wo._dirtyNormal=!1;class vw{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new is(t),this.meshInstance=null}addLines(t,e){const s=this.positions,i=t.length;for(let r=0;r<i;r++){const a=t[r];s.push(a.x,a.y,a.z)}const n=this.colors;if(e.length)for(let r=0;r<i;r++){const a=e[r];n.push(a.r,a.g,a.b,a.a)}else for(let r=0;r<i;r++)n.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){this.positions.push(...t);const s=this.colors;if(e.length)s.push(...e);else{const i=t.length/3;for(let n=0;n<i;n++)s.push(e.r,e.g,e.b,e.a)}}onPreRender(t,e){this.positions.length>0&&this.material.transparent===e&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(io,!1),this.meshInstance||(this.meshInstance=new vt(this.mesh,this.material,Wo)),this.positions.length=0,this.colors.length=0,t.list.push(this.meshInstance),t.length++)}}class Sw{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new vw(this.device,t,e),this.map.set(t,s)),s}onPreRender(t,e){this.map.forEach(s=>{s.onPreRender(t,e)})}}const rs=[];class Go{constructor(t){this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(t){const e=new Bb;return e.vertexColors=!0,e.blend=!0,e.blendType=Be,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new Sw(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const i=e?this.materialDepth:this.materialNoDepth;return s.getBatch(i,t)}static getTextureVS(){return`
						attribute vec2 aPosition;
						uniform mat4 matrix_model;
						varying vec2 uv0;
						void main(void) {
								gl_Position = matrix_model * vec4(aPosition, 0, 1);
								uv0 = aPosition.xy + 0.5;
						}
				`}getTextureShader(){if(!this.textureShader){const t={attributes:{aPosition:Ot},vshader:Go.getTextureVS(),fshader:`
										precision lowp float;
										varying vec2 uv0;
										uniform sampler2D colorMap;
										void main (void) {
												gl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);
										}
								`};this.textureShader=new Ir(this.device,t)}return this.textureShader}getDepthTextureShader(){if(!this.depthTextureShader){const t=this.device.webgl2?"#define GL2":"",e={attributes:{aPosition:Ot},vshader:Go.getTextureVS(),fshader:`
										precision ${this.device.precision} float;
										${t}
										${F.screenDepthPS}
										varying vec2 uv0;
										void main() {
												float depth = getLinearScreenDepth(uv0) * camera_params.x;
												gl_FragColor = vec4(vec3(depth), 1.0);
										}
										`};this.depthTextureShader=new Ir(this.device,e)}return this.depthTextureShader}getQuadMesh(){return this.quadMesh||(this.quadMesh=new is(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(Cr)),this.quadMesh}drawMesh(t,e,s,i,n){if(!i){const a=this.getGraphNode(e);i=new vt(s,t,a)}let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(t,e,s,i,n){rs.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z),this.getBatch(n,i).addLinesArrays(rs,s),rs.length=0}drawWireSphere(t,e,s,i,n,r){const a=2*Math.PI/i;let l=0;for(let c=0;c<i;c++){const d=Math.sin(l),u=Math.cos(l);l+=a;const f=Math.sin(l),m=Math.cos(l);rs.push(t.x+e*d,t.y,t.z+e*u),rs.push(t.x+e*f,t.y,t.z+e*m),rs.push(t.x+e*d,t.y+e*u,t.z),rs.push(t.x+e*f,t.y+e*m,t.z),rs.push(t.x,t.y+e*d,t.z+e*u),rs.push(t.x,t.y+e*f,t.z+e*m)}this.getBatch(r,n).addLinesArrays(rs,s),rs.length=0}getGraphNode(t){const e=new xt;return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRenderLayer(t,e,s){if(this.batchesMap.forEach((i,n)=>{n===t&&i.onPreRender(e,s)}),!this.updatedLayers.has(t)){this.updatedLayers.add(t);const i=this.layerMeshInstances.get(t);if(i){for(let n=0;n<i.length;n++)e.list[e.length+n]=i[n];e.length+=i.length,i.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class Ic extends at{constructor(t){super();this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new j(0,0,0),this.exposure=1,this.fogColor=new j(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=Ua,this.lightmapFilterEnabled=!1,this.root=null,this.device=t||Ne().graphicsDevice,this._gravity=new y(0,-9.8,0),this._layers=null,this._fog=lh,this._gammaCorrection=Mu,this._toneMapping=0,this._skyboxCubeMap=null,this._prefilteredCubemaps=[null,null,null,null,null,null],this._envAtlas=null,this._internalEnvAtlas=null,this.skyboxModel=null,this._skyboxIntensity=1,this._skyboxMip=0,this._skyboxRotation=new tt,this._skyboxRotationMat3=null,this._skyboxRotationMat4=null,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!1,this._lightingParams=new pm(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this._layers._dirtyLights=!0}),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[],this.immediate=new Go(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(ke)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=U.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=U.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){if(this._clusteredLightingEnabled&&!t){console.error("Turning off enabled clustered lighting is not currently supported");return}this._clusteredLightingEnabled=t}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set drawCalls(t){}get drawCalls(){let t=this.layers._meshInstances;return t.length||(this.layers._update(this.device,this.clusteredLightingEnabled),t=this.layers._meshInstances),t}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,this.updateShaders=!0)}get envAtlas(){return this._envAtlas}set fog(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get lighting(){return this._lightingParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const r=t[n]||null;e[n]!==r&&(e[n]=r,s=!0),i=i&&!!e[n]}s&&(this._resetSkyboxModel(),i?(this._internalEnvAtlas=kf.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas||(this.envAtlas=this._internalEnvAtlas)):this._internalEnvAtlas&&(this._envAtlas===this._internalEnvAtlas&&(this.envAtlas=null),this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null))}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSkyboxModel())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSkyboxModel())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSkyboxModel())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(t){this._skyboxRotation.equals(t)||(this._skyboxRotation.copy(t),this._resetSkyboxModel())}get skyboxRotation(){return this._skyboxRotation}set toneMapping(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSkyboxModel(),this.root=null,this.off()}drawLine(t,e,s=j.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([t,e],[s,s])}drawLines(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(t,e)}applySettings(t){const e=t.physics,s=t.render;this._gravity.set(e.gravity[0],e.gravity[1],e.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this._fog=s.fog,this.fogColor.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fogStart=s.fog_start,this.fogEnd=s.fog_end,this.fogDensity=s.fog_density,this._gammaCorrection=s.gamma_correction,this._toneMapping=s.tonemapping,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=s.skyboxIntensity===void 0?1:s.skyboxIntensity,this._skyboxMip=s.skyboxMip===void 0?0:s.skyboxMip,s.skyboxRotation&&this._skyboxRotation.setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2]),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(i=>{s.hasOwnProperty(i)&&(this[i]=s[i])}),this._resetSkyboxModel()}_getSkyboxTex(){const t=this._prefilteredCubemaps;return this._skyboxMip?t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap:this._skyboxCubeMap||t[0]||this._envAtlas}_updateSkybox(t){if(this.skyboxModel)return;const e=this._getSkyboxTex();if(!e)return;const s=new Ue,i=this;s.updateShader=function(r,a,l,h,c){const d=t.getProgramLibrary();e.cubemap?this.shader=d.getProgram("skybox",{type:"cubemap",rgbm:e.type===jt,hdr:e.type===jt||e.format===Vt,useIntensity:i.skyboxIntensity!==1,mip:e.fixCubemapSeams?i.skyboxMip:0,fixSeams:e.fixCubemapSeams,gamma:c===Qe?i.gammaCorrection?Ra:mh:i.gammaCorrection,toneMapping:c===Qe?Ia:i.toneMapping}):this.shader=d.getProgram("skybox",{type:"envAtlas",encoding:e.encoding,useIntensity:i.skyboxIntensity!==1,gamma:c===Qe?i.gammaCorrection?Ra:mh:i.gammaCorrection,toneMapping:c===Qe?Ia:i.toneMapping})},s.updateShader(),e.cubemap?s.setParameter("texture_cubeMap",e):(s.setParameter("texture_envAtlas",e),s.setParameter("mipLevel",this._skyboxMip)),this.skyboxRotation.equals(tt.IDENTITY)?s.setParameter("cubeMapRotationMatrix",Qt.IDENTITY.data):(this._skyboxRotationMat4||(this._skyboxRotationMat4=new G),this._skyboxRotationMat3||(this._skyboxRotationMat3=new Qt),this._skyboxRotationMat4.setTRS(y.ZERO,this._skyboxRotation,y.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3),s.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)),s.cull=Xa,s.depthWrite=!1;const n=this.layers.getLayerById(ch);if(n){const r=new xt("Skybox"),a=qf(t),l=new vt(a,s,r);l.cull=!1,l._noDepthDrawGl1=!0,l.pick=!1;const h=new Ts;h.graph=r,h.meshInstances=[l],this.skyboxModel=h,n.addMeshInstances(h.meshInstances),this.skyLayer=n,this.fire("set:skybox",e)}}_resetSkyboxModel(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.prefilteredCubemaps=[null,null,null,null,null,null])}addModel(t){if(this.containsModel(t))return;const e=this.layers.getLayerById(xe);!e||(e.addMeshInstances(t.meshInstances),this._models.push(t))}addShadowCaster(t){const e=this.layers.getLayerById(xe);!e||e.addShadowCasters(t.meshInstances)}removeModel(t){const e=this._models.indexOf(t);if(e!==-1){const s=this.layers.getLayerById(xe);if(!s)return;s.removeMeshInstances(t.meshInstances),this._models.splice(e,1)}}removeShadowCasters(t){const e=this.layers.getLayerById(xe);!e||e.removeShadowCasters(t.meshInstances)}containsModel(t){return this._models.indexOf(t)>=0}getModels(t){return this._models}}function as(){return typeof AudioContext!="undefined"||typeof webkitAudioContext!="undefined"}class Ho{constructor(t,e,s={}){if(this.volume=s.volume===void 0?1:s.volume,this.loop=s.loop===void 0?!1:s.loop,this.pitch=s.pitch===void 0?1:s.pitch,this.sound=e,this.paused=!1,this.suspended=!1,this.manager=t,this.source=null,as()){this.startTime=0,this.startOffset=0;const i=t.context;this.gain=i.createGain()}else e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())}getVolume(){return this.volume}getLoop(){return this.loop}setLoop(t){this.loop=t,this.source&&(this.source.loop=t)}getPitch(){return this.pitch}onManagerVolumeChange(){this.setVolume(this.getVolume())}onManagerSuspend(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())}onManagerResume(){this.suspended&&(this.suspended=!1,this.unpause())}play(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),!!this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())}pause(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)}unpause(){if(this.source||!this.paused){console.warn("Call pause() before unpausing.");return}this._createSource(),!!this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)}stop(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)}setVolume(t){t=U.clamp(t,0,1),this.volume=t,this.gain&&(this.gain.gain.value=t*this.manager.volume)}setPitch(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)}isPlaying(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE}getDuration(){return this.source?this.source.buffer.duration:0}_createSource(){const t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}as()||Object.assign(Ho.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(o){o=U.clamp(o,0,1),this.volume=o,this.source&&(this.source.volume=o*this.manager.volume)},setPitch:function(o){this.pitch=o,this.source&&(this.source.playbackRate=o)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}});const Xo="linear",jo="inverse",xm="exponential",bw=1e4;class gi extends Ho{constructor(t,e,s){super(t,e,s);this.position=new y,this.velocity=new y,as()?this.panner=t.context.createPanner():(this.maxDistance=bw,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=jo)}getPosition(){return this.position}setPosition(t){this.position.copy(t);const e=this.panner;"positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z)}getVelocity(){return this.velocity}setVelocity(t){this.velocity.copy(t)}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(t){this.panner.maxDistance=t}getMinDistance(){return this.panner.refDistance}setMinDistance(t){this.panner.refDistance=t}getRollOffFactor(){return this.panner.rolloffFactor}setRollOffFactor(t){this.panner.rolloffFactor=t}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(t){this.panner.distanceModel=t}_createSource(){const t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}}if(!as()){let o=new y;const t=function(s,i,n,r,a,l){o=o.sub2(s,i);const h=o.length();if(h<n)return 1;if(h>r)return 0;let c=0;return l===Xo?c=1-a*(h-n)/(r-n):l===jo?c=n/(n+a*(h-n)):l===xm&&(c=Math.pow(h/n,-a)),U.clamp(c,0,1)};Object.assign(gi.prototype,{setPosition:function(e){if(this.position.copy(e),this.source){const i=this.manager.listener.getPosition(),n=t(i,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),r=this.getVolume();this.source.volume=r*n}},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(e){this.maxDistance=e},getMinDistance:function(){return this.minDistance},setMinDistance:function(e){this.minDistance=e},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(e){this.rollOffFactor=e},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(e){this.distanceModel=e}})}class ww{constructor(t){this._manager=t,this.position=new y,this.velocity=new y,this.orientation=new G}getPosition(){return this.position}setPosition(t){this.position.copy(t);const e=this.listener;e&&("positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z))}getVelocity(){return this.velocity}setVelocity(t){}setOrientation(t){this.orientation.copy(t);const e=this.listener;if(e){const s=t.data;"forwardX"in e?(e.forwardX.value=-s[8],e.forwardY.value=-s[9],e.forwardZ.value=-s[10],e.upX.value=s[4],e.upY.value=s[5],e.upZ.value=s[6]):e.setOrientation&&e.setOrientation(-s[8],-s[9],-s[10],s[4],s[5],s[6])}}getOrientation(){return this.orientation}get listener(){const t=this._manager.context;return t?t.listener:null}}const Tw="not created",vm="running",Sm="suspended",bm="interrupted",Lc=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","pointerup","touchend","keydown","keyup"];class qo extends at{constructor(t){super();this._context=null,this._state=Tw,this._forceWebAudioApi=t.forceWebAudioApi,this._resumeContext=null,this._resumeContextAttached=!1,this._unlock=null,this._unlockAttached=!1,as()||this._forceWebAudioApi?this._addAudioContextUserInteractionListeners():console.warn("No support for 3D audio found"),this.listener=new ww(this),this._volume=1,this.suspended=!1}set volume(t){t=U.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}get volume(){return this._volume}get context(){return this._context||(as()||this._forceWebAudioApi)&&(typeof AudioContext!="undefined"?this._context=new AudioContext:typeof webkitAudioContext!="undefined"&&(this._context=new webkitAudioContext),this._context&&(this._state=this._context.state,this._context.onstatechange=()=>{!this._context||((this._state===bm||this._state===Sm)&&this._safelyResumeContext(),this._state=this._context.state)})),this._context}suspend(){this.suspended=!0,this.fire("suspend")}resume(){this.suspended=!1,this.fire("resume"),this.context&&(this._state===bm||this._state===Sm)&&this._safelyResumeContext()}destroy(){this._resumeContext&&this._resumeContextAttached&&Lc.forEach(t=>{window.removeEventListener(t,this._resumeContext)}),this._unlock&&this._unlockAttached&&window.removeEventListener("touchend",this._unlock),this.fire("destroy"),this._context&&this._context.close&&(this._context.close(),this._context=null)}playSound(t,e={}){let s=null;return Ho&&(s=new Ho(this,t,e),s.play()),s}playSound3d(t,e,s={}){let i=null;return gi&&(i=new gi(this,t,s),i.setPosition(e),s.volume&&i.setVolume(s.volume),s.loop&&i.setLoop(s.loop),s.maxDistance&&i.setMaxDistance(s.maxDistance),s.minDistance&&i.setMinDistance(s.minDistance),s.rollOffFactor&&i.setRollOffFactor(s.rollOffFactor),s.distanceModel&&i.setDistanceModel(s.distanceModel),i.play()),i}_safelyResumeContext(){!this._context||this._context.resume().then(()=>{this._context.state!==vm&&this._addAudioContextUserInteractionListeners()}).catch(()=>{this._addAudioContextUserInteractionListeners()})}_addAudioContextUserInteractionListeners(){this._resumeContext||(this._resumeContext=()=>{!this.context||this.context.state===vm?(Lc.forEach(t=>{window.removeEventListener(t,this._resumeContext)}),this._resumeContextAttached=!1):this.context.resume()}),this._resumeContextAttached||(Lc.forEach(t=>{window.addEventListener(t,this._resumeContext)}),this._resumeContextAttached=!0),Dt.ios&&(this._unlock||(this._unlock=()=>{window.removeEventListener("touchend",this._unlock),this._unlockAttached=!1;const t=this.context;if(t){const e=t.createBuffer(1,1,44100),s=t.createBufferSource();s.buffer=e,s.connect(t.destination),s.start(0),s.disconnect()}}),this._unlockAttached||(window.addEventListener("touchend",this._unlock),this._unlockAttached=!0))}}class wm{constructor(t,e,s,i){this.time=t,this.position=e,this.rotation=s,this.scale=i}}class Tm{constructor(){this._name="",this._keys=[]}}class Hi{constructor(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}getNode(t){return this._nodeDict[t]}addNode(t){this._nodes.push(t),this._nodeDict[t._name]=t}get nodes(){return this._nodes}}class Cm{constructor(t){arguments.length===2&&(t=arguments[1]),this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this.aabb=t.aabb,this.aabb||(this.aabb=new gt,t.deltaPositions&&this.aabb.compute(t.deltaPositions)),this.deltaPositions=t.deltaPositions}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}_postInit(){this.options=null}_initVertexBuffers(t){const e=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,e.deltaPositions,e.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(t,e.deltaNormals,e.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(t,e,s=wt){if(e){const i=[{semantic:co,components:3,type:s}];return new Ds(t,new re(t,i),e.length/3,ve,e)}return null}_setTexture(t,e){this[t]=e}destroy(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}class Am{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}class Mm extends at{constructor(){super();this._meshes=null}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++){const s=this._meshes[e];s&&(s.decRefCount(),s.refCount<1&&(s.destroy(),this._meshes[e]=null))}}}incRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++)this._meshes[e]&&this._meshes[e].incRefCount()}}}class Pm{constructor(t,e,s,i){this._paths=t,this._input=e,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class Dc{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}class Em{constructor(t){this._events=[...t],this._events.sort((e,s)=>e.time-s.time)}get events(){return this._events}}class Yo{constructor(t,e,s,i,n,r=new Em([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(t){this._animEvents=t}get events(){return this._animEvents.events}eval(t,e){e._time=t;const s=this._inputs,i=this._outputs,n=this._curves,r=e._cache,a=e._results;for(let l=0;l<s.length;++l)r[l].update(t,s[l]._data);for(let l=0;l<n.length;++l){const h=n[l],c=i[h._output],d=a[l];r[h._input].eval(d,h._interpolation,c)}}}const Rm=0,Fc=1,Oc=2,$o="en-US",Ko={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Bc={};function yi(o,t){for(let e=0,s=o.length;e<s;e++)Bc[o[e]]=t}function Ws(o){const t=o.indexOf("-");return t!==-1?o.substring(0,t):o}function Cw(o,t){const e=o.indexOf("-");return e!==-1?t+o.substring(e):t}function Im(o,t){if(t[o])return o;let e=Ko[o];if(e&&t[e])return e;const s=Ws(o);return e=Ko[s],t[e]?e:t[s]?s:$o}yi(["ja","ko","th","vi","zh","id"],function(o){return 0});yi(["fa","hi"],function(o){return o>=0&&o<=1?0:1});yi(["fr","pt"],function(o){return o>=0&&o<2?0:1});yi(["da"],function(o){return o===1||!Number.isInteger(o)&&o>=0&&o<=1?0:1});yi(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(o){return o===1?0:1});yi(["ru","uk"],function(o){if(Number.isInteger(o)){const t=o%10,e=o%100;if(t===1&&e!==11)return 0;if(t>=2&&t<=4&&(e<12||e>14))return 1;if(t===0||t>=5&&t<=9||e>=11&&e<=14)return 2}return 3});yi(["pl"],function(o){if(Number.isInteger(o)){if(o===1)return 0;const t=o%10,e=o%100;if(t>=2&&t<=4&&(e<12||e>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||e>=12&&e<=14)return 2}return 3});yi(["ar"],function(o){if(o===0)return 0;if(o===1)return 1;if(o===2)return 2;if(Number.isInteger(o)){const t=o%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5});const Aw=Bc[Ws($o)];function kc(o){return Bc[o]||Aw}const Zo=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i");class Mw{constructor(t,e,s,i,n,r){this.url=t||"",this.filename=e||"",this.hash=s===void 0?null:s,this.size=i===void 0?null:i,this.opt=n===void 0?null:n,this.contents=r||null}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let Pw=-1;const Ew={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Lm=["pvr","dxt","etc2","etc1","basis"];class rt extends at{constructor(t,e,s,i,n){super();this._id=Pw--,this.name=t||"",this.type=e,this.tags=new yu(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(t){this._id=t}get id(){return this._id}set file(t){if(t&&t.variants&&["texture","textureatlas","bundle"].indexOf(this.type)!==-1){var e,s;const r=((e=this.registry)==null||(s=e._loader)==null?void 0:s._app)||Ne(),a=r==null?void 0:r.graphicsDevice;if(a)for(let l=0,h=Lm.length;l<h;l++){const c=Lm[l];if(t.variants[c]&&a[Ew[c]]){t=t.variants[c];break}if(r.enableBundles){const d=r.bundles.listBundlesForAsset(this);if(d&&d.find(u=>{var f;return u==null||(f=u.file)==null?void 0:f.variants[c]}))break}}}const i=this._file,n=t?new Mw(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!n!=!!i||n&&!n.equals(i))&&(this._file=n,this.fire("change",this,"file",n,i),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,(!this.hasOwnProperty("_loadFaces")||t!==this._loadFaces)&&(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;return this.registry&&this.registry.prefix&&!Zo.test(e)&&(e=this.registry.prefix+e),this.type!=="script"&&t.hash&&(e+=(e.indexOf("?")!==-1?"&":"?")+"t="+t.hash),e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=ot.getDirectory(this.file.url);return ot.join(e,t)}getLocalizedAssetId(t){return t=Im(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.resource?t.call(e,this):this.once("load",function(s){t.call(e,s)})}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&this._resources.length===0)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){var n;s!=null&&(n=s.file)!=null&&n.contents?setTimeout(()=>{e(null,s.file.contents)}):Ft.get(t,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},e)}}class Rw extends lc{constructor(t,e){super();this.skin=t,this.skinInstance=e}}class Xe{static createCachedSkinInstance(t,e,s){let i=Xe.getCachedSkinInstance(t,e);return i||(i=new Wr(t),i.resolve(e,s),Xe.addCachedSkinInstance(t,e,i)),i}static getCachedSkinInstance(t,e){let s=null;const i=Xe._skinInstanceCache.get(e);if(i){const n=i.find(r=>r.skin===t);n&&(n.incRefCount(),s=n.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let i=Xe._skinInstanceCache.get(e);i||(i=[],Xe._skinInstanceCache.set(e,i));let n=i.find(r=>r.skin===t);n||(n=new Rw(t,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=Xe._skinInstanceCache.get(e);if(s){const i=s.findIndex(n=>n.skinInstance===t);if(i>=0){const n=s[i];n.decRefCount(),n.refCount===0&&(s.splice(i,1),s.length||Xe._skinInstanceCache.delete(e),t&&(t.destroy(),n.skinInstance=null))}}}}}}Xe._skinInstanceCache=new Map;class xi{constructor(t,e,s,i){const n=function(c,d,u){const f=xi.createAsset(e.name,c,d,u);return s.add(f),f},r=[];for(let h=0;h<t.renders.length;++h)r.push(n("render",t.renders[h],h));const a=[];for(let h=0;h<t.materials.length;++h)a.push(n("material",t.materials[h],h));const l=[];for(let h=0;h<t.animations.length;++h)l.push(n("animation",t.animations[h],h));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=i,this.renders=r,this.materials=a,this.textures=t.textures,this.animations=l}get model(){if(!this._model){const t=xi.createModel(this.data,this._defaultMaterial),e=xi.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new rt(t+"/"+e+"/"+i,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){const e=new pt;return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(l,h,c,d,u,f){const m=c.materialIndex===void 0?e:d[c.materialIndex],p=new vt(c,m);return c.morph&&(p.morphInstance=new Gi(c.morph)),f.hasOwnProperty("skin")&&s.push({meshInstance:p,rootBone:l,entity:h}),p},n=(a,l,h)=>{const c=new pt;l._cloneInternal(c),a||(a=c);let d=null,u=null;for(let p=0;p<h.nodes.length;p++)if(h.nodes[p]===l){const g=h.gltf.nodes[p];if(g.hasOwnProperty("mesh")){const w=h.renders[g.mesh].meshes;u=this.renders[g.mesh];for(var f=0;f<w.length;f++){const v=w[f];if(v){const x=i(a,c,v,h.materials,h.skins,g);d||(d=[]),d.push(x)}}}if(h.lights){const w=h.lights.get(g);w&&c.addChild(w.clone())}if(h.cameras){const w=h.cameras.get(g);w&&w.camera.system.cloneComponent(w,c)}}d&&(c.addComponent("render",Object.assign({type:"asset",meshInstances:d,rootBone:a},t)),c.render.assignAsset(u));const m=l.children;for(let p=0;p<m.length;p++){const _=n(a,m[p],h);c.addChild(_)}return c},r=[];for(const a of this.data.scenes)r.push(n(null,a,this.data));return s.forEach(a=>{a.meshInstance.skinInstance=Xe.createCachedSkinInstance(a.meshInstance.mesh.skin,a.rootBone,a.entity)}),xi.createSceneHierarchy(r,"Entity")}static createSceneHierarchy(t,e){let s=null;if(t.length===1)s=t[0];else{s=new e("SceneGroup");for(const i of t)s.addChild(i)}return s}static createModel(t,e){const s=function(l,h,c,d,u,f,m){const p=h.materialIndex===void 0?e:u[h.materialIndex],_=new vt(h,p,f);if(h.morph){const g=new Gi(h.morph);_.morphInstance=g,l.morphInstances.push(g)}if(m.hasOwnProperty("skin")){const g=m.skin,w=c[g];h.skin=w;const v=d[g];_.skinInstance=v,l.skinInstances.push(v)}l.meshInstances.push(_)},i=new Ts,n=[];for(const a of t.skins){const l=new Wr(a);l.bones=a.bones,n.push(l)}i.graph=xi.createSceneHierarchy(t.scenes,"GraphNode");for(let a=0;a<t.nodes.length;a++){const l=t.nodes[a];if(l.root===i.graph){const h=t.gltf.nodes[a];if(h.hasOwnProperty("mesh")){const c=t.renders[h.mesh].meshes;for(var r=0;r<c.length;r++){const d=c[r];d&&s(i,d,t.skins,n,t.materials,l,h)}}}}return i}destroy(){const t=this._assets,e=function(n){t.remove(n),n.unload()},s=function(n){n.forEach(function(r){e(r)})};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class Iw{constructor(t){this.gltf=t,this.nodes=null,this.scenes=null,this.animations=null,this.textures=null,this.materials=null,this.renders=null,this.skins=null,this.lights=null,this.cameras=null}destroy(){this.renders&&this.renders.forEach(t=>{t.meshes=null})}}const Dm=function(t){return/^data:.*,.*$/i.test(t)},Lw=function(t){return t.substring(t.indexOf(":")+1,t.indexOf(";"))},Jo=function(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},zc=function(t){switch(t){case 5120:return mo;case 5121:return ci;case 5122:return po;case 5123:return fn;case 5124:return sf;case 5125:return nf;case 5126:return wt;default:return 0}},Dw=function(t){switch(t){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},Fw=function(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},Qo={POSITION:Ot,NORMAL:pe,TANGENT:vs,COLOR_0:de,JOINTS_0:Se,WEIGHTS_0:Ss,TEXCOORD_0:be,TEXCOORD_1:hi,TEXCOORD_2:no,TEXCOORD_3:ro,TEXCOORD_4:ao,TEXCOORD_5:oo,TEXCOORD_6:lo,TEXCOORD_7:ho},Ow=o=>{switch(o){case mo:return t=>Math.max(t/127,-1);case ci:return t=>t/255;case po:return t=>Math.max(t/32767,-1);case fn:return t=>t/65535;default:return t=>t}},Uc=function(t,e,s){const i=Ow(s),n=e.length;for(let r=0;r<n;++r)t[r]=i(e[r]);return t},tl=function o(t,e,s=!1){const i=Jo(t.type),n=Fw(t.componentType);if(!n)return null;const r=e[t.bufferView];let a;if(t.sparse){const l=t.sparse,h={count:l.count,type:"SCALAR"},c=o(Object.assign(h,l.indices),e,!0),d={count:l.count,type:t.scalar,componentType:t.componentType},u=o(Object.assign(d,l.values),e,!0);if(t.hasOwnProperty("bufferView")){const f={bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type};a=o(f,e,!0).slice()}else a=new n(t.count*i);for(let f=0;f<l.count;++f){const m=c[f];for(let p=0;p<i;++p)a[m*i+p]=u[f*i+p]}}else if(s&&r.hasOwnProperty("byteStride")){const l=i*n.BYTES_PER_ELEMENT,h=new ArrayBuffer(t.count*l),c=new Uint8Array(h);let d=0;for(let u=0;u<t.count;++u){let f=(t.byteOffset||0)+u*r.byteStride;for(let m=0;m<l;++m)c[d++]=r[f++]}a=new n(h)}else a=new n(r.buffer,r.byteOffset+(t.byteOffset||0),t.count*i);return a},Nc=function(t,e){const s=tl(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const i=new Float32Array(s.length);return Uc(i,s,zc(t.componentType)),i},Fm=function(t){let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const i=zc(t.componentType);e=Uc([],e,i),s=Uc([],s,i)}return new gt(new y((s[0]+e[0])*.5,(s[1]+e[1])*.5,(s[2]+e[2])*.5),new y((s[0]-e[0])*.5,(s[1]-e[1])*.5,(s[2]-e[2])*.5))},Bw=function(t){if(!t.hasOwnProperty("mode"))return ts;switch(t.mode){case 0:return Tr;case 1:return io;case 2:return Yu;case 3:return $u;case 4:return ts;case 5:return Cr;case 6:return Di;default:return ts}},kw=function(t){const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e},Om=function(t,e){const s=t[Ot];if(!s||s.components!==3)return;let i;if(s.size!==s.stride){const l=s.stride/_o[s.type],h=new mn[s.type](s.buffer,s.offset,s.count*l);i=new mn[s.type](s.count*3);for(let c=0;c<s.count;++c)i[c*3+0]=h[c*l+0],i[c*3+1]=h[c*l+1],i[c*3+2]=h[c*l+2]}else i=new mn[s.type](s.buffer,s.offset,s.count*3);const n=s.count;e||(e=kw(n));const r=Rb(i,e),a=new Float32Array(r.length);a.set(r),t[pe]={buffer:a.buffer,size:12,offset:0,stride:12,count:n,components:3,type:wt}},zw=function(t){let e,s;const i=[],n=[],r=[];for(e=0;e<t.format.elements.length;++e){const l=t.format.elements[e];if(l.name===be||l.name===hi)switch(l.dataType){case wt:i.push({offset:l.offset/4+1,stride:l.stride/4});break;case fn:n.push({offset:l.offset/2+1,stride:l.stride/2});break;case ci:r.push({offset:l.offset+1,stride:l.stride});break}}const a=function(h,c,d){const u=new c(t.storage);for(e=0;e<h.length;++e){let f=h[e].offset;const m=h[e].stride;for(s=0;s<t.numVertices;++s)u[f]=d-u[f],f+=m}};i.length>0&&a(i,Float32Array,1),n.length>0&&a(n,Uint16Array,65535),r.length>0&&a(r,Uint8Array,255)},Uw=function(t){const e=function(n){const r=[];for(let a=0;a<n._levels.length;++a){let l=[];if(n.cubemap)for(let h=0;h<6;++h)l.push(n._levels[a][h]);else l=n._levels[a];r.push(l)}return r},s=new nt(t.device,t);return s._levels=e(t),s},Nw=function(t){const e=new rt(t.name+"_clone",t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=Uw(t.resource),t.registry.add(e),e},Bm=function(t,e,s){const i=e[Ot];if(!i)return null;const n=i.count,r=[];for(const x in e)e.hasOwnProperty(x)&&r.push({semantic:x,components:e[x].components,type:e[x].type,normalize:!!e[x].normalize});const a=[Ot,pe,vs,de,Se,Ss,be,hi];r.sort(function(x,S){const T=a.indexOf(x.semantic),b=a.indexOf(S.semantic);return T<b?-1:b<T?1:0});let l,h,c,d,u,f;const m=new re(t,r);let p=!0;for(l=0;l<m.elements.length;++l)if(u=m.elements[l],d=e[u.name],f=d.offset-i.offset,d.buffer!==i.buffer||d.stride!==u.stride||d.size!==u.size||f!==u.offset){p=!1;break}const _=new Ds(t,m,n,ve),g=_.lock(),w=new Uint32Array(g);let v;if(p)v=new Uint32Array(i.buffer,i.offset,n*_.format.size/4),w.set(v);else{let x,S;for(l=0;l<_.format.elements.length;++l){u=_.format.elements[l],x=u.stride/4,d=e[u.name],S=d.stride/4,v=new Uint32Array(d.buffer,d.offset,(d.count-1)*S+(d.size+3)/4);let T=0,b=u.offset/4;const C=Math.floor((d.size+3)/4);for(h=0;h<n;++h){for(c=0;c<C;++c)w[b+c]=v[T+c];T+=S,b+=x}}}return s&&zw(_),_.unlock(),_},Vw=function(t,e,s,i,n,r,a){const l={},h=[];for(const u in e)e.hasOwnProperty(u)&&Qo.hasOwnProperty(u)&&(l[u]=e[u],h.push(u+":"+e[u]));h.sort();const c=h.join();let d=a[c];if(!d){const u={};for(const f in l){const m=i[e[f]],p=tl(m,n),_=n[m.bufferView],g=Qo[f],w=Jo(m.type)*Dw(m.componentType),v=_.hasOwnProperty("byteStride")?_.byteStride:w;u[g]={buffer:p.buffer,size:w,offset:p.byteOffset,stride:v,count:m.count,components:Jo(m.type),type:zc(m.componentType),normalize:m.normalized}}u.hasOwnProperty(pe)||Om(u,s),d=Bm(t,u,r),a[c]=d}return d},Ww=function(t,e,s,i,n,r,a){const l=e.num_points(),h=function(f){const m=i.GetAttributeByUniqueId(e,f),p=l*m.num_components(),_=m.data_type();let g,w,v,x;switch(_){case n.DT_UINT8:x=ci,v=1,g=n._malloc(p*v),i.GetAttributeDataArrayForAllPoints(e,m,n.DT_UINT8,p*v,g),w=new Uint8Array(n.HEAPU8.buffer,g,p).slice();break;case n.DT_UINT16:x=fn,v=2,g=n._malloc(p*v),i.GetAttributeDataArrayForAllPoints(e,m,n.DT_UINT16,p*v,g),w=new Uint16Array(n.HEAPU16.buffer,g,p).slice();break;case n.DT_FLOAT32:default:x=wt,v=4,g=n._malloc(p*v),i.GetAttributeDataArrayForAllPoints(e,m,n.DT_FLOAT32,p*v,g),w=new Float32Array(n.HEAPF32.buffer,g,p).slice();break}return n._free(g),{values:w,numComponents:m.num_components(),componentSizeInBytes:v,storageType:x,normalized:m.normalized()}},c={},d=s.attributes;for(const u in d)if(d.hasOwnProperty(u)&&Qo.hasOwnProperty(u)){const f=Qo[u],m=h(d[u]),p=m.numComponents*m.componentSizeInBytes;c[f]={values:m.values,buffer:m.values.buffer,size:p,offset:0,stride:p,count:l,components:m.numComponents,type:m.storageType,normalize:m.normalized}}return c.hasOwnProperty(pe)||Om(c,r),Bm(t,c,a)},Gw=function(t,e,s,i,n,r){let a,l,h;const c=e.joints,d=c.length,u=[];if(e.hasOwnProperty("inverseBindMatrices")){const _=e.inverseBindMatrices,g=tl(s[_],i,!0),w=[];for(a=0;a<d;a++){for(l=0;l<16;l++)w[l]=g[a*16+l];h=new G,h.set(w),u.push(h)}}else for(a=0;a<d;a++)h=new G,u.push(h);const f=[];for(a=0;a<d;a++)f[a]=n[c[a]].name;const m=f.join("#");let p=r.get(m);return p||(p=new Am(t,u,f),r.set(m,p)),p},el=new G,Mn=new y,Hw=function(t,e,s,i,n,r,a){const l=[];return e.primitives.forEach(function(h){let c,d,u,f=null,m=!0;if(h.hasOwnProperty("extensions")){const _=h.extensions;if(_.hasOwnProperty("KHR_draco_mesh_compression")){const g=window.DracoDecoderModule;if(g){const w=_.KHR_draco_mesh_compression;if(w.hasOwnProperty("attributes")){const v=i[w.bufferView],x=new g.DecoderBuffer;x.Init(v,v.length);const S=new g.Decoder,T=S.GetEncodedGeometryType(x);let b,C;switch(T){case g.POINT_CLOUD:c=Tr,b=new g.PointCloud,C=S.DecodeBufferToPointCloud(x,b);break;case g.TRIANGULAR_MESH:c=ts,b=new g.Mesh,C=S.DecodeBufferToMesh(x,b);break;case g.INVALID_GEOMETRY_TYPE:}if(!C||!C.ok()||b.ptr==0){n("Failed to decode draco compressed asset: "+(C?C.error_msg():"Mesh asset - invalid draco compressed geometry type: "+T));return}const M=b.num_faces();if(T===g.TRIANGULAR_MESH){const E=b.num_points()>65535;u=M*3;const D=u*(E?4:2),I=g._malloc(D);E?(S.GetTrianglesUInt32Array(b,D,I),f=new Uint32Array(g.HEAPU32.buffer,I,u).slice()):(S.GetTrianglesUInt16Array(b,D,I),f=new Uint16Array(g.HEAPU16.buffer,I,u).slice()),g._free(I)}d=Ww(t,b,w,S,g,f,r),g.destroy(b),g.destroy(S),g.destroy(x),m=!1}}}}d||(f=h.hasOwnProperty("indices")?tl(s[h.indices],i,!0):null,d=Vw(t,h.attributes,f,s,i,r,a),c=Bw(h));let p=null;if(d){if(p=new is(t),p.vertexBuffer=d,p.primitive[0].type=c,p.primitive[0].base=0,p.primitive[0].indexed=f!==null,f!==null){let g;f instanceof Uint8Array?g=Gu:f instanceof Uint16Array?g=Is:g=Ii,g===Ii&&!t.extUintElement&&(g=Is,f=new Uint16Array(f));const w=new ui(t,g,f.length,ve,f);p.indexBuffer[0]=w,p.primitive[0].count=f.length}else p.primitive[0].count=d.numVertices;p.materialIndex=h.material;let _=s[h.attributes.POSITION];if(p.aabb=Fm(_),m&&h.hasOwnProperty("targets")){const g=[];h.targets.forEach(function(w,v){const x={};w.hasOwnProperty("POSITION")&&(_=s[w.POSITION],x.deltaPositions=Nc(_,i),x.deltaPositionsType=wt,x.aabb=Fm(_)),w.hasOwnProperty("NORMAL")&&(_=s[w.NORMAL],x.deltaNormals=Nc(_,i),x.deltaNormalsType=wt),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?x.name=e.extras.targetNames[v]:x.name=v.toString(10),e.hasOwnProperty("weights")&&(x.defaultWeight=e.weights[v]),g.push(new Cm(x))}),p.morph=new Ee(g,t)}}l.push(p)}),l},Xw=function(t,e,s){const i=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","		dGlossiness = 1.0;","","#ifdef MAPFLOAT","		dGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","		dGlossiness *= texture2D(texture_glossMap, $UV, textureBias).$CH;","#endif","","#ifdef MAPVERTEX","		dGlossiness *= saturate(vVertexColor.$VC);","#endif","","		dGlossiness = 1.0 - dGlossiness;","","		dGlossiness += 0.0000001;","}"].join(`
`),n=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","		dSpecularity = vec3(1.0);","","		#ifdef MAPCOLOR","				dSpecularity *= material_specular;","		#endif","","		#ifdef MAPTEXTURE","				vec3 srgb = texture2D(texture_specularMap, $UV, textureBias).$CH;","				dSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","		#endif","","		#ifdef MAPVERTEX","				dSpecularity *= saturate(vVertexColor.$VC);","		#endif","}"].join(`
`),r=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","		ccGlossiness = 1.0;","","#ifdef MAPFLOAT","		ccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","		ccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV, textureBias).$CH;","#endif","","#ifdef MAPVERTEX","		ccGlossiness *= saturate(vVertexColor.$VC);","#endif","","		ccGlossiness = 1.0 - ccGlossiness;","","		ccGlossiness += 0.0000001;","}"].join(`
`),a=[0,0],l=[1,1],h=function(m,p,_){var g;let w;const v=m.texCoord;if(v)for(w=0;w<_.length;++w)p[_[w]+"MapUv"]=v;const x=(g=m.extensions)==null?void 0:g.KHR_texture_transform;if(x){const S=x.offset||a,T=x.scale||l,b=x.rotation?-x.rotation*U.RAD_TO_DEG:0,C=new H(T[0],T[1]),M=new H(S[0],1-T[1]-S[1]);for(w=0;w<_.length;++w)p[`${_[w]}MapTiling`]=C,p[`${_[w]}MapOffset`]=M,p[`${_[w]}MapRotation`]=b}},c=new ue;c.occludeSpecular=!0,c.diffuseTint=!0,c.diffuseVertexColor=!0,c.specularTint=!0,c.specularVertexColor=!0,t.hasOwnProperty("name")&&(c.name=t.name);let d,u;if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){const f=t.extensions.KHR_materials_pbrSpecularGlossiness;if(f.hasOwnProperty("diffuseFactor")?(d=f.diffuseFactor,c.diffuse.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2)),c.opacity=d[3]):(c.diffuse.set(1,1,1),c.opacity=1),f.hasOwnProperty("diffuseTexture")){const m=f.diffuseTexture;u=e[m.index],c.diffuseMap=u,c.diffuseMapChannel="rgb",c.opacityMap=u,c.opacityMapChannel="a",h(m,c,["diffuse","opacity"])}if(c.useMetalness=!1,f.hasOwnProperty("specularFactor")?(d=f.specularFactor,c.specular.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2))):c.specular.set(1,1,1),f.hasOwnProperty("glossinessFactor")?c.shininess=100*f.glossinessFactor:c.shininess=100,f.hasOwnProperty("specularGlossinessTexture")){const m=f.specularGlossinessTexture;c.specularMap=c.glossMap=e[m.index],c.specularMapChannel="rgb",c.glossMapChannel="a",h(m,c,["gloss","metalness"])}c.chunks.specularPS=n}else if(t.hasOwnProperty("pbrMetallicRoughness")){const f=t.pbrMetallicRoughness;if(f.hasOwnProperty("baseColorFactor")?(d=f.baseColorFactor,c.diffuse.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2)),c.opacity=d[3]):(c.diffuse.set(1,1,1),c.opacity=1),f.hasOwnProperty("baseColorTexture")){const m=f.baseColorTexture;u=e[m.index],c.diffuseMap=u,c.diffuseMapChannel="rgb",c.opacityMap=u,c.opacityMapChannel="a",h(m,c,["diffuse","opacity"])}if(c.useMetalness=!0,f.hasOwnProperty("metallicFactor")?c.metalness=f.metallicFactor:c.metalness=1,f.hasOwnProperty("roughnessFactor")?c.shininess=100*f.roughnessFactor:c.shininess=100,f.hasOwnProperty("metallicRoughnessTexture")){const m=f.metallicRoughnessTexture;c.metalnessMap=c.glossMap=e[m.index],c.metalnessMapChannel="b",c.glossMapChannel="g",h(m,c,["gloss","metalness"])}c.chunks.glossPS=i}if(t.hasOwnProperty("normalTexture")){const f=t.normalTexture;c.normalMap=e[f.index],h(f,c,["normal"]),f.hasOwnProperty("scale")&&(c.bumpiness=f.scale)}if(t.hasOwnProperty("occlusionTexture")){const f=t.occlusionTexture;c.aoMap=e[f.index],c.aoMapChannel="r",h(f,c,["ao"])}if(t.hasOwnProperty("emissiveFactor")?(d=t.emissiveFactor,c.emissive.set(Math.pow(d[0],1/2.2),Math.pow(d[1],1/2.2),Math.pow(d[2],1/2.2)),c.emissiveTint=!0):(c.emissive.set(0,0,0),c.emissiveTint=!1),t.hasOwnProperty("emissiveTexture")){const f=t.emissiveTexture;c.emissiveMap=e[f.index],h(f,c,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":c.blendType=he,t.hasOwnProperty("alphaCutoff")?c.alphaTest=t.alphaCutoff:c.alphaTest=.5;break;case"BLEND":c.blendType=Be,c.depthWrite=!1;break;default:case"OPAQUE":c.blendType=he;break}else c.blendType=he;if(t.hasOwnProperty("doubleSided")?(c.twoSidedLighting=t.doubleSided,c.cull=t.doubleSided?me:cn):(c.twoSidedLighting=!1,c.cull=cn),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_clearcoat")){const f=t.extensions.KHR_materials_clearcoat;if(f.hasOwnProperty("clearcoatFactor")?c.clearCoat=f.clearcoatFactor*.25:c.clearCoat=0,f.hasOwnProperty("clearcoatTexture")){const m=f.clearcoatTexture;c.clearCoatMap=e[m.index],c.clearCoatMapChannel="r",h(m,c,["clearCoat"])}if(f.hasOwnProperty("clearcoatRoughnessFactor")?c.clearCoatGlossiness=f.clearcoatRoughnessFactor:c.clearCoatGlossiness=0,f.hasOwnProperty("clearcoatRoughnessTexture")){const m=f.clearcoatRoughnessTexture;c.clearCoatGlossMap=e[m.index],c.clearCoatGlossMapChannel="g",h(m,c,["clearCoatGloss"])}if(f.hasOwnProperty("clearcoatNormalTexture")){const m=f.clearcoatNormalTexture;c.clearCoatNormalMap=e[m.index],h(m,c,["clearCoatNormal"]),m.hasOwnProperty("scale")&&(c.clearCoatBumpiness=m.scale)}c.chunks.clearCoatGlossPS=r}return t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_unlit")&&(c.useLighting=!1,c.emissive.copy(c.diffuse),c.emissiveTint=c.diffuseTint,c.emissiveMap=c.diffuseMap,c.emissiveMapUv=c.diffuseMapUv,c.emissiveMapTiling.copy(c.diffuseMapTiling),c.emissiveMapOffset.copy(c.diffuseMapOffset),c.emissiveMapChannel=c.diffuseMapChannel,c.emissiveVertexColor=c.diffuseVertexColor,c.emissiveVertexColorChannel=c.diffuseVertexColorChannel,c.diffuse.set(0,0,0),c.diffuseTint=!1,c.diffuseMap=null,c.diffuseVertexColor=!1),c.update(),c},jw=function(t,e,s,i,n){const r=function(S){return new Dc(Jo(S.type),Nc(S,i))},a={STEP:Rm,LINEAR:Fc,CUBICSPLINE:Oc},l={},h=[],c={},d=[],u=[];let f;for(f=0;f<t.samplers.length;++f){const x=t.samplers[f];l.hasOwnProperty(x.input)||(l[x.input]=h.length,h.push(r(s[x.input]))),c.hasOwnProperty(x.output)||(c[x.output]=d.length,d.push(r(s[x.output])));const S=x.hasOwnProperty("interpolation")&&a.hasOwnProperty(x.interpolation)?a[x.interpolation]:Fc;u.push(new Pm([],l[x.input],c[x.output],S))}const m=[],p={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"},_=x=>{const S=[];for(;x;)S.unshift(x.name),x=x.parent;return S};for(f=0;f<t.channels.length;++f){const x=t.channels[f],S=x.target,T=u[x.sampler],b=n[S.node],C=_(b);T._paths.push({entityPath:C,component:"graph",propertyPath:[p[S.path]]}),S.path.startsWith("rotation")&&T.interpolation!==Oc?m.push(T.output):S.path.startsWith("weights")&&(d[T.output]._components=d[T.output].data.length/h[T.input].data.length)}m.sort();let g=null,w;for(f=0;f<m.length;++f){const x=m[f];if(f===0||x!==g){if(w=d[x],w.components===4){const S=w.data,T=S.length-4;for(let b=0;b<T;b+=4)S[b+0]*S[b+4]+S[b+1]*S[b+5]+S[b+2]*S[b+6]+S[b+3]*S[b+7]<0&&(S[b+4]*=-1,S[b+5]*=-1,S[b+6]*=-1,S[b+7]*=-1)}g=x}}let v=0;for(f=0;f<h.length;f++)w=h[f]._data,v=Math.max(v,w.length===0?0:w[w.length-1]);return new Yo(t.hasOwnProperty("name")?t.name:"animation_"+e,v,h,d,u)},qw=function(t,e){const s=new xt;if(t.hasOwnProperty("name")&&t.name.length>0?s.name=t.name:s.name="node_"+e,t.hasOwnProperty("matrix")&&(el.data.set(t.matrix),el.getTranslation(Mn),s.setLocalPosition(Mn),el.getEulerAngles(Mn),s.setLocalEulerAngles(Mn),el.getScale(Mn),s.setLocalScale(Mn)),t.hasOwnProperty("rotation")){const i=t.rotation;s.setLocalRotation(i[0],i[1],i[2],i[3])}if(t.hasOwnProperty("translation")){const i=t.translation;s.setLocalPosition(i[0],i[1],i[2])}if(t.hasOwnProperty("scale")){const i=t.scale;s.setLocalScale(i[0],i[1],i[2])}return s},Yw=function(t,e){const s=t.type==="orthographic"?hr:ys,i=s===hr?t.orthographic:t.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:bh};i.zfar&&(n.farClip=i.zfar),s===hr?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=wh,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*U.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=wh,n.aspectRatio=i.aspectRatio));const r=new pt(t.name);return r.addComponent("camera",n),r},$w=function(t,e){const s={enabled:!1,type:t.type==="point"?"omni":t.type,color:t.hasOwnProperty("color")?new j(t.color):j.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:qg,intensity:t.hasOwnProperty("intensity")?U.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*U.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*U.RAD_TO_DEG:Math.PI/4);const i=new pt(e.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},Kw=function(t,e,s,i){if(!e.hasOwnProperty("skins")||e.skins.length===0)return[];const n=new Map;return e.skins.map(function(r){return Gw(t,r,e.accessors,i,s,n)})},Zw=function(t,e,s,i,n){if(!e.hasOwnProperty("meshes")||e.meshes.length===0||!e.hasOwnProperty("accessors")||e.accessors.length===0||!e.hasOwnProperty("bufferViews")||e.bufferViews.length===0)return[];const r={};return e.meshes.map(function(a){return Hw(t,a,e.accessors,s,i,n,r)})},Jw=function(t,e,s,i){if(!t.hasOwnProperty("materials")||t.materials.length===0)return[];const n=s&&s.material&&s.material.preprocess,r=s&&s.material&&s.material.process||Xw,a=s&&s.material&&s.material.postprocess;return t.materials.map(function(l){n&&n(l);const h=r(l,e,i);return a&&a(l,h),h})},Qw=function(t,e,s,i){if(!t.hasOwnProperty("animations")||t.animations.length===0)return[];const n=i&&i.animation&&i.animation.preprocess,r=i&&i.animation&&i.animation.postprocess;return t.animations.map(function(a,l){n&&n(a);const h=jw(a,l,t.accessors,s,e);return r&&r(a,h),h})},tT=function(t,e){if(!t.hasOwnProperty("nodes")||t.nodes.length===0)return[];const s=e&&e.node&&e.node.preprocess,i=e&&e.node&&e.node.process||qw,n=e&&e.node&&e.node.postprocess,r=t.nodes.map(function(a,l){s&&s(a);const h=i(a,l);return n&&n(a,h),h});for(let a=0;a<t.nodes.length;++a){const l=t.nodes[a];if(l.hasOwnProperty("children")){const h=r[a],c={};for(let d=0;d<l.children.length;++d){const u=r[l.children[d]];u.parent||(c.hasOwnProperty(u.name)?u.name+=c[u.name]++:c[u.name]=1,h.addChild(u))}}}return r},eT=function(t,e){var s;const i=[],n=t.scenes.length;if(n===1&&((s=t.scenes[0].nodes)==null?void 0:s.length)===1){const r=t.scenes[0].nodes[0];i.push(e[r])}else for(let r=0;r<n;r++){const a=t.scenes[r];if(a.nodes){const l=new xt(a.name);for(let h=0;h<a.nodes.length;h++){const c=e[a.nodes[h]];l.addChild(c)}i.push(l)}}return i},sT=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){const n=s&&s.camera&&s.camera.preprocess,r=s&&s.camera&&s.camera.process||Yw,a=s&&s.camera&&s.camera.postprocess;t.nodes.forEach(function(l,h){if(l.hasOwnProperty("camera")){const c=t.cameras[l.camera];if(c){n&&n(c);const d=r(c,e[h]);a&&a(c,d),d&&(i||(i=new Map),i.set(l,d))}}})}return i},iT=function(t,e,s){let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const n=t.extensions.KHR_lights_punctual.lights;if(n.length){const r=s&&s.light&&s.light.preprocess,a=s&&s.light&&s.light.process||$w,l=s&&s.light&&s.light.postprocess;t.nodes.forEach(function(h,c){if(h.hasOwnProperty("extensions")&&h.extensions.hasOwnProperty("KHR_lights_punctual")&&h.extensions.KHR_lights_punctual.hasOwnProperty("light")){const d=h.extensions.KHR_lights_punctual.light,u=n[d];if(u){r&&r(u);const f=a(u,e[c]);l&&l(u,f),f&&(i||(i=new Map),i.set(h,f))}}})}}return i},nT=function(t,e,s){t.nodes.forEach(i=>{i.hasOwnProperty("mesh")&&i.hasOwnProperty("skin")&&e[i.mesh].meshes.forEach(r=>{r.skin=s[i.skin]})})},km=function(t,e,s,i,n,r){const a=n&&n.global&&n.global.preprocess,l=n&&n.global&&n.global.postprocess;a&&a(e);const h=e.asset&&e.asset.generator==="PlayCanvas",c=tT(e,n),d=eT(e,c),u=iT(e,c,n),f=sT(e,c,n),m=Qw(e,c,s,n),p=Jw(e,i.map(function(x){return x.resource}),n,h),_=Zw(t,e,s,r,h),g=Kw(t,e,c,s),w=[];for(let x=0;x<_.length;x++)w[x]=new Mm,w[x].meshes=_[x];nT(e,w,g);const v=new Iw(e);v.nodes=c,v.scenes=d,v.animations=m,v.textures=i,v.materials=p,v.renders=w,v.skins=g,v.lights=u,v.cameras=f,l&&l(e,v),r(null,v)},rT=function(t,e){const s=function(r,a){switch(r){case 9728:return bt;case 9729:return Yt;case 9984:return _r;case 9985:return qa;case 9986:return ja;case 9987:return Ei;default:return a}},i=function(r,a){switch(r){case 33071:return et;case 33648:return Ch;case 10497:return te;default:return a}};t&&(e=e||{},t.minFilter=s(e.minFilter,Ei),t.magFilter=s(e.magFilter,Yt),t.addressU=i(e.wrapS,te),t.addressV=i(e.wrapT,te))};let aT=0;const oT=function(t,e,s,i,n,r,a){const l=r&&r.image&&r.image.preprocess,h=r&&r.image&&r.image.processAsync||function(m,p){p(null,null)},c=r&&r.image&&r.image.postprocess,d=function(p){c&&c(t,p),a(null,p)},u={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},f=function(p,_,g,w){const v=(t.name||"gltf-texture")+"-"+aT++,x={url:p||v};if(_&&(x.contents=_.slice(0).buffer),g){const T=u[g];T&&(x.filename=x.url+"."+T)}const S=new rt(v,"texture",x,null,w);S.on("load",d),S.on("error",a),n.add(S),n.load(S)};l&&l(t),h(t,function(m,p){m?a(m):p?d(p):t.hasOwnProperty("uri")?Dm(t.uri)?f(t.uri,null,Lw(t.uri),null):f(ot.join(i,t.uri),null,null,{crossOrigin:"anonymous"}):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?f(null,s[t.bufferView],t.mimeType,null):a("Invalid image found in gltf (neither uri or bufferView found). index="+e)})},lT=function(t,e,s,i,n,r){if(!t.hasOwnProperty("images")||t.images.length===0||!t.hasOwnProperty("textures")||t.textures.length===0){r(null,[]);return}const a=n&&n.texture&&n.texture.preprocess,l=n&&n.texture&&n.texture.processAsync||function(m,p,_){_(null,null)},h=n&&n.texture&&n.texture.postprocess,c=[],d=[];let u=t.textures.length;const f=function(p,_){if(d[_]||(d[_]=[]),d[_].push(p),--u==0){const g=[];d.forEach(function(w,v){w.forEach(function(x,S){const T=S===0?c[v]:Nw(c[v]);rT(T.resource,(t.samplers||[])[t.textures[x].sampler]),g[x]=T,h&&h(t.textures[x],T)})}),r(null,g)}};for(let m=0;m<t.textures.length;++m){const p=t.textures[m];a&&a(p),l(p,t.images,function(_,g,w,v){if(w)r(w);else{if(v==null){var x,S;v=g==null||(x=g.extensions)==null||(S=x.KHR_texture_basisu)==null?void 0:S.source,v===void 0&&(v=g.source)}if(c[v])f(_,v);else{const T=t.images[v];oT(T,_,e,s,i,n,function(b,C){b?r(b):(c[v]=C,f(_,v))})}}}.bind(null,m,p))}},hT=function(t,e,s,i,n){const r=[];if(!t.buffers||t.buffers.length===0){n(null,r);return}const a=i&&i.buffer&&i.buffer.preprocess,l=i&&i.buffer&&i.buffer.processAsync||function(u,f){f(null,null)},h=i&&i.buffer&&i.buffer.postprocess;let c=t.buffers.length;const d=function(f,m){r[f]=m,h&&h(t.buffers[f],m),--c==0&&n(null,r)};for(let u=0;u<t.buffers.length;++u){const f=t.buffers[u];a&&a(f),l(f,function(m,p,_,g){if(_)n(_);else if(g)d(m,new Uint8Array(g));else if(p.hasOwnProperty("uri"))if(Dm(p.uri)){const w=atob(p.uri.split(",")[1]),v=new Uint8Array(w.length);for(let x=0;x<w.length;x++)v[x]=w.charCodeAt(x);d(m,v)}else Ft.get(ot.join(s,p.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(w,v,x){v?n(v):d(w,new Uint8Array(x))}.bind(null,m));else d(m,e)}.bind(null,u,f))}},zm=function(t,e){const s=function(r){if(typeof TextDecoder!="undefined")return new TextDecoder().decode(r);let a="";for(let l=0;l<r.length;l++)a+=String.fromCharCode(r[l]);return decodeURIComponent(escape(a))},i=JSON.parse(s(t));if(i.asset&&i.asset.version&&parseFloat(i.asset.version)<2){e(`Invalid gltf version. Expected version 2.0 or above but found version '${i.asset.version}'.`);return}e(null,i)},cT=function(t,e){const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),r=s.getUint32(8,!0);if(i!==1179937895){e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));return}if(n!==2){e("Invalid version number found in glb header. Expected 2, found "+n);return}if(r<=0||r>s.byteLength){e("Invalid length found in glb header. Found "+r);return}const a=[];let l=12;for(;l<r;){const h=s.getUint32(l,!0);if(l+h+8>s.byteLength)throw new Error("Invalid chunk length found in glb. Found "+h);const c=s.getUint32(l+4,!0),d=new Uint8Array(s.buffer,s.byteOffset+l+8,h);a.push({length:h,type:c,data:d}),l+=h+8}if(a.length!==1&&a.length!==2){e("Invalid number of chunks found in glb file.");return}if(a[0].type!==1313821514){e("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+a[0].type.toString(16));return}if(a.length>1&&a[1].type!==5130562){e("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+a[1].type.toString(16));return}e(null,{gltfChunk:a[0].data,binaryChunk:a.length===2?a[1].data:null})},Um=function(t,e,s){t&&t.toLowerCase().endsWith(".glb")?cT(e,s):s(null,{gltfChunk:e,binaryChunk:null})},Nm=function(t,e,s,i){const n=[],r=s&&s.bufferView&&s.bufferView.preprocess,a=s&&s.bufferView&&s.bufferView.processAsync||function(d,u,f){f(null,null)},l=s&&s.bufferView&&s.bufferView.postprocess;let h=t.bufferViews?t.bufferViews.length:0;if(!h){i(null,null);return}const c=function(u,f){const m=t.bufferViews[u];m.hasOwnProperty("byteStride")&&(f.byteStride=m.byteStride),n[u]=f,l&&l(m,f),--h==0&&i(null,n)};for(let d=0;d<t.bufferViews.length;++d){const u=t.bufferViews[d];r&&r(u),a(u,e,function(f,m,p,_){if(p)i(p);else if(_)c(f,_);else{const g=e[m.buffer],w=new Uint8Array(g.buffer,g.byteOffset+(m.byteOffset||0),m.byteLength);c(f,w)}}.bind(null,d,u))}};class Zr{static parseAsync(t,e,s,i,n,r,a){Um(t,s,function(l,h){if(l){a(l);return}zm(h.gltfChunk,function(c,d){if(c){a(c);return}hT(d,h.binaryChunk,e,r,function(u,f){if(u){a(u);return}Nm(d,f,r,function(m,p){if(m){a(m);return}lT(d,p,e,n,r,function(_,g){if(_){a(_);return}km(i,d,p,g,r,a)})})})})})}static parse(t,e,s,i){let n=null;return i=i||{},Um(t,e,function(r,a){r?console.error(r):zm(a.gltfChunk,function(l,h){l?console.error(l):Nm(h,[a.binaryChunk],i,function(c,d){c?console.error(c):km(s,h,d,[],i,function(u,f){u?console.error(u):n=f})})})}),n}constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=zi(t),this._maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){rt.fetchArrayBuffer(t.load,(i,n)=>{i?e(i):Zr.parseAsync(this._getUrlWithoutParams(t.original),ot.extractPath(t.load),n,this._device,s.registry,s.options,(r,a)=>{r?e(r):e(null,new xi(a,s,this._assets,this._defaultMaterial))})},s,this._maxRetries)}open(t,e,s){return e}patch(t,e){}}class dT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(ot.getExtension(t.original).toLowerCase()===".glb"?s.responseType=dt.ResponseType.ARRAY_BUFFER:s.responseType=dt.ResponseType.JSON),Ft.get(t.load,s,function(i,n){i?e(`Error loading animation resource: ${t.original} [${i}]`):e(null,n)})}open(t,e){if(ot.getExtension(t).toLowerCase()===".glb"){const s=Zr.parse("filename.glb",e,null);if(s){const i=s.animations;return s.destroy(),i}return null}return this["_parseAnimationV"+e.animation.version](e)}patch(t,e){}_parseAnimationV3(t){const e=t.animation,s=new Hi;s.name=e.name,s.duration=e.duration;for(let i=0;i<e.nodes.length;i++){const n=new Tm,r=e.nodes[i];n._name=r.name;for(let a=0;a<r.keys.length;a++){const l=r.keys[a],h=l.time,c=l.pos,d=l.rot,u=l.scale,f=new y(c[0],c[1],c[2]),m=new tt().setFromEulerAngles(d[0],d[1],d[2]),p=new y(u[0],u[1],u[2]),_=new wm(h,f,m,p);n._keys.push(_)}s.addNode(n)}return s}_parseAnimationV4(t){const e=t.animation,s=new Hi;s.name=e.name,s.duration=e.duration;for(let i=0;i<e.nodes.length;i++){const n=new Tm,r=e.nodes[i];n._name=r.name;const a=r.defaults.p,l=r.defaults.r,h=r.defaults.s;for(let c=0;c<r.keys.length;c++){const d=r.keys[c],u=d.t,f=a||d.p,m=l||d.r,p=h||d.s,_=new y(f[0],f[1],f[2]),g=new tt().setFromEulerAngles(m[0],m[1],m[2]),w=new y(p[0],p[1],p[2]),v=new wm(u,_,g,w);n._keys.push(v)}s.addNode(n)}return s}}class uT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=dt.ResponseType.JSON),Ft.get(t.load,s,function(i,n){i?e(`Error loading animation clip resource: ${t.original} [${i}]`):e(null,n)})}open(t,e){const s=e.name,i=e.duration,n=e.inputs.map(function(l){return new Dc(1,l)}),r=e.outputs.map(function(l){return new Dc(l.components,l.data)}),a=e.curves.map(function(l){return new Pm([l.path],l.inputIndex,l.outputIndex,l.interpolation)});return new Yo(s,i,n,r,a)}patch(t,e){}}class sl{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let n=0;n<s.states.length;n++)i.states.push(t.states[s.states[n]]);for(let n=0;n<s.transitions.length;n++){const r=t.transitions[s.transitions[n]];if(r.conditions&&!Array.isArray(r.conditions)){const a=Object.keys(r.conditions),l=[];for(let h=0;h<a.length;h++){const c=r.conditions[a[h]];c.parameterName&&l.push(c)}r.conditions=l}Number.isInteger(r.from)&&(r.from=t.states[r.from].name),Number.isInteger(r.to)&&(r.to=t.states[r.to].name),i.transitions.push(r)}this._layers.push(i)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class fT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=dt.ResponseType.JSON),Ft.get(t.load,s,function(i,n){i?e(`Error loading animation state graph resource: ${t.original} [${i}]`):e(null,n)})}open(t,e){return new sl(e)}patch(t,e){}}class mT{constructor(t){this.audio=void 0,this.buffer=void 0,t instanceof Audio?this.audio=t:this.buffer=t}get duration(){let t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}}const Vc=function(){if(typeof window=="undefined")return!1;const o=window.navigator.userAgent,t=o.indexOf("MSIE ");if(t>0)return parseInt(o.substring(t+5,o.indexOf(".",t)),10);if(o.indexOf("Trident/")>0){const s=o.indexOf("rv:");return parseInt(o.substring(s+3,o.indexOf(".",s)),10)}return!1}(),pT={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"};class _T{constructor(t){this.manager=t,this.maxRetries=0}_isSupported(t){const e=ot.getExtension(t);return!!pT[e]}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s=function(r){e(null,new mT(r))},i=function(r){let a="Error loading audio url: "+t.original;r&&(a+=": "+(r.message||r)),console.warn(a),e(a)};if(this._createSound){if(!this._isSupported(t.original)){i(`Audio format for ${t.original} not supported`);return}this._createSound(t.load,s,i)}else i(null)}open(t,e){return e}patch(t,e){}_createSound(t,e,s){if(as()){const i=this.manager;if(!i.context){s("Audio manager has no audio context");return}const n={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.startsWith("blob:")||t.startsWith("data:"))&&(n.responseType=dt.ResponseType.ARRAY_BUFFER),Ft.get(t,n,function(r,a){if(r){s(r);return}i.context.decodeAudioData(a,e,s)})}else{let i=null;try{i=new Audio}catch{s("No support for Audio element");return}Vc&&document.body.appendChild(i);const n=function r(){i.removeEventListener("canplaythrough",r),Vc&&document.body.removeChild(i),e(i)};i.onerror=function(){i.onerror=null,Vc&&document.body.removeChild(i),s()},i.addEventListener("canplaythrough",n),i.src=t}}}class gT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),Ft.get(t.load,{responseType:dt.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e(`Error loading binary resource: ${t.original} [${s}]`):e(null,i)})}open(t,e){return e}patch(t,e){}}class yT{constructor(t){this._blobUrls={};for(let e=0,s=t.length;e<s;e++)t[e].url&&(this._blobUrls[t[e].name]=t[e].url)}hasBlobUrl(t){return!!this._blobUrls[t]}getBlobUrl(t){return this._blobUrls[t]}destroy(){for(const t in this._blobUrls)URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null}}let Vm;function Wm(o){let t,e;if(typeof TextDecoder!="undefined")try{t=new TextDecoder("utf-8"),e=new TextDecoder("windows-1252")}catch{console.warn("TextDecoder not supported - pc.Untar module will not work")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function s(n){this._fields=n}s.parse=function(n,r,a){const l=new Uint8Array(n,r,a);let h=0;const c=[];for(;h<a;){let d;for(d=h;d<a&&l[d]!==32;d++);if(d>=a)throw new Error("Invalid PAX header data format.");const u=parseInt(t.decode(new Uint8Array(n,r+h,d-h)),10),m=t.decode(new Uint8Array(n,r+d+1,u-(d-h)-2)).split("=");if(m.length!==2)throw new Error("Invalid PAX header data format.");m[1].length===0&&(m[1]=null),c.push({name:m[0],value:m[1]}),h+=u}return new s(c)},s.prototype.applyHeader=function(n){for(let r=0;r<this._fields.length;r++){let a=this._fields[r].name;const l=this._fields[r].value;a==="path"&&(a="name"),l===null?delete n[a]:n[a]=l}};function i(n){this._arrayBuffer=n||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}o||(Vm=i),i.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&this._bufferView.getUint32(this._bytesRead)!==0},i.prototype._readNextFile=function(){const n=new DataView(this._arrayBuffer,this._bytesRead,512),r=e.decode(n);this._bytesRead+=512;let a=r.substr(0,100).replace(/\0/g,"");const l=r.substr(257,6),h=parseInt(r.substr(124,12),8),c=r.substr(156,1),d=this._bytesRead;let u=null,f=!1;switch(c){case"0":case"":if(f=!0,!o){const _=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+h)]);u=URL.createObjectURL(_)}break;case"g":this._globalPaxHeader=s.parse(this._arrayBuffer,this._bytesRead,h);break;case"x":this._paxHeader=s.parse(this._arrayBuffer,this._bytesRead,h);break}this._bytesRead+=h;const m=h%512;if(m!==0&&(this._bytesRead+=512-m),!f)return null;if(l.indexOf("ustar")!==-1){const _=r.substr(345,155).replace(/\0/g,"");_.length>0&&(a=_.trim()+a.trim())}const p={name:a,start:d,size:h,url:u};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(p),this._paxHeader&&(this._paxHeader.applyHeader(p),this._paxHeader=null),p},i.prototype.untar=function(n){if(!t)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];const r=[];for(;this._hasNext();){const a=this._readNextFile();!a||(n&&a.name&&(a.name=n+a.name),r.push(a))}return r},o&&(self.onmessage=function(n){const r=n.data.id;try{const l=new i(n.data.arrayBuffer).untar(n.data.prefix);postMessage({id:r,files:l,arrayBuffer:n.data.arrayBuffer},[n.data.arrayBuffer])}catch(a){postMessage({id:r,error:a.toString()})}})}let Wc=null;function xT(){if(!Wc){const o="("+Wm.toString()+`)(true)

`,t=new Blob([o],{type:"application/javascript"});Wc=URL.createObjectURL(t)}return Wc}class vT{constructor(t){this._requestId=0,this._pendingRequests={},this._filenamePrefix=t,this._worker=new Worker(xT()),this._worker.addEventListener("message",this._onMessage.bind(this))}_onMessage(t){const e=t.data.id;if(!this._pendingRequests[e])return;const s=this._pendingRequests[e];if(delete this._pendingRequests[e],t.data.error)s(t.data.error);else{const i=t.data.arrayBuffer;for(let n=0,r=t.data.files.length;n<r;n++){const a=t.data.files[n],l=new Blob([i.slice(a.start,a.start+a.size)]);a.url=URL.createObjectURL(l)}s(null,t.data.files)}}untar(t,e){const s=this._requestId++;this._pendingRequests[s]=e,this._worker.postMessage({id:s,prefix:this._filenamePrefix,arrayBuffer:t},[t])}hasPendingRequests(){return Object.keys(this._pendingRequests).length>0}destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)}}Wm();class ST{constructor(t){this._assets=t,this._worker=null,this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s=this;Ft.get(t.load,{responseType:dt.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(i,n){if(i)e("Error loading bundle resource "+t.original+": "+i);else try{s._untar(n,e)}catch(r){e("Error loading bundle resource "+t.original+": "+r)}})}_untar(t,e){const s=this;if(Dt.workers)s._worker||(s._worker=new vT(s._assets.prefix)),s._worker.untar(t,function(i,n){e(i,n),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)});else{const n=new Vm(t).untar(s._assets.prefix);e(null,n)}}open(t,e){return new yT(e)}patch(t,e){}}class bT{constructor(t,e){this.glbParser=new Zr(t,e,0),this.parsers={}}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=t?ot.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""):null;return this.parsers[e]||this.glbParser}load(t,e,s){typeof t=="string"&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}patch(t,e){}}class wT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e(`Error loading css resource: ${t.original} [${s}]`):e(null,i)})}open(t,e){return e}patch(t,e){}}class TT{constructor(t,e,s){this._device=t,this._registry=e,this._loader=s}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,function(s,i){s&&(e.fire("error",t),e.fire("error:"+t.id,s,t),t.fire("error",t))})}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||typeof t=="string"?t===e:t.url===e.url:t!==null==(e!==null)}update(t,e,s){const i=t.data||{},n=t._handlerState.assets,r=t._resources;let a,l,h;const c=[null,null,null,null,null,null,null],d=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?jt:_e:null};if(!t.loaded||s[0]!==n[0]){if(s[0])for(a=s[0].resource,h=0;h<6;++h)c[h+1]=new nt(this._device,{name:t.name+"_prelitCubemap"+(a.width>>h),cubemap:!0,type:d()||a.type,width:a.width>>h,height:a.height>>h,format:a.format,levels:[a._levels[h]],fixCubemapSeams:!0,addressU:et,addressV:et,mipmaps:h===0})}else c[1]=r[1]||null,c[2]=r[2]||null,c[3]=r[3]||null,c[4]=r[4]||null,c[5]=r[5]||null,c[6]=r[6]||null;const u=s.slice(1);if(!t.loaded||!this.cmpArrays(u,n.slice(1))){if(u.indexOf(null)===-1){const f=u.map(function(g){return g.resource}),m=[];for(l=0;l<f[0]._levels.length;++l)m.push(f.map(function(g){return g._levels[l]}));const p=f[0].format,_=new nt(this._device,{name:t.name+"_faces",cubemap:!0,type:d()||f[0].type,width:f[0].width,height:f[0].height,format:p===Ls?ct:p,levels:m,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:f[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:f[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:et,addressV:et,fixCubemapSeams:!!s[0]});c[0]=_}}else c[0]=r[0]||null;if(!this.cmpArrays(c,r))for(t.resources=c,t._handlerState.assetIds=e,t._handlerState.assets=s,h=0;h<r.length;++h)r[h]!==null&&c.indexOf(r[h])===-1&&r[h].destroy();for(h=0;h<n.length;++h)n[h]!==null&&s.indexOf(n[h])===-1&&n[h].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(t),n=[null,null,null,null,null,null,null],r=t._handlerState.assetIds,a=t._handlerState.assets,l=s._registry;let h=7;const c=function(p,_){n[p]=_,h--,h===0&&(s.update(t,i,n),e(null,t.resources))},d=function(p,_,g){e(_)},u=function(p,_){_.loaded?c(p,_):(l.once("load:"+_.id,c.bind(s,p)),l.once("error:"+_.id,d.bind(s,p)),_.loading||l.load(_))};let f;for(let m=0;m<7;++m){const p=this.resolveId(i[m]);if(!p)c(m,null);else if(s.compareAssetIds(p,r[m]))c(m,a[m]);else if(parseInt(p,10)===p)f=l.get(p),f?u(m,f):setTimeout(function(_,g){const w=l.get(g);w?u(_,w):d(_,"failed to find dependent cubemap asset="+g)}.bind(null,m,p));else{const _=typeof p=="string"?{url:p,filename:p}:p;f=new rt(t.name+"_part_"+m,"texture",_),l.add(f),l.once("load:"+f.id,c.bind(s,m)),l.once("error:"+f.id,d.bind(s,m)),l.load(f)}}}}class CT{load(t,e){e(null,null)}open(t,e){return e}}const il="msdf",AT="bitmap";class Gm{constructor(t,e){this.type=e&&e.type||il,this.em=1,this.textures=t,this.intensity=0,this._data=null,this.data=e}set data(t){if(this._data=t,!!t&&(this._data.intensity!==void 0&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(const e in this._data.chars)this._data.chars[e].map=0}get data(){return this._data}}function Gc(o){return o.version<3&&(o.version<2&&(o.info.maps=o.info.maps||[{width:o.info.width,height:o.info.height}]),o.chars=Object.keys(o.chars||{}).reduce(function(t,e){const s=o.chars[e],i=s.letter!==void 0?s.letter:an.fromCodePoint(e);return o.version<2&&(s.map=s.map||0),t[i]=s,t},{}),o.version=3),o}class MT{constructor(t){this._loader=t,this.maxRetries=0}load(t,e,s){typeof t=="string"&&(t={load:t,original:t});const i=this;ot.getExtension(t.original)===".json"?Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){if(n)e(`Error loading font resource: ${t.original} [${n}]`);else{const a=Gc(r);i._loadTextures(t.load.replace(".json",".png"),a,function(l,h){if(l)return e(l);e(null,{data:a,textures:h})})}}):(s&&s.data&&(s.data=Gc(s.data)),this._loadTextures(t.load,s&&s.data,e))}_loadTextures(t,e,s){const i=e.info.maps.length;let n=0,r=null;const a=new Array(i),l=this._loader,h=function(d){const u=function(m,p){if(!r){if(m)return r=m,s(m);p.upload(),a[d]=p,n++,n===i&&s(null,a)}};d===0?l.load(t,"texture",u):l.load(t.replace(".png",d+".png"),"texture",u)};for(let c=0;c<i;c++)h(c)}open(t,e,s){let i;return e.textures?i=new Gm(e.textures,e.data):i=new Gm(e,null),i}patch(t,e){const s=t.resource;!s.data&&t.data?s.data=t.data:!t.data&&s.data&&(t.data=s.data),t.data&&(t.data=Gc(t.data))}}const Hc={setCompressedPRS:function(o,t,e){const s=e.singleVecs;let i,n;const r=t.___1;r||(i=e.tripleVecs,n=t.___2);let a=r?r[0]:i[n];o.setLocalPosition(s[a],s[a+1],s[a+2]),a=r?r[1]:i[n+1],o.setLocalEulerAngles(s[a],s[a+1],s[a+2]),a=r?r[2]:i[n+2],o.setLocalScale(s[a],s[a+1],s[a+2])},oneCharToKey:function(o,t){const e=o.charCodeAt(0)-t.fieldFirstCode;return t.fieldArray[e]},multCharToKey:function(o,t){let e=0;for(let s=0;s<o.length;s++)e=e*t.fieldCodeBase+o.charCodeAt(s)-t.fieldFirstCode;return t.fieldArray[e]}};class nl{constructor(t,e){this._node=t,this._data=e}run(){const t=Object.prototype.toString.call(this._node);return t==="[object Object]"?this._handleMap():t==="[object Array]"?this._handleArray():this._result=this._node,this._result}_handleMap(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)}_handleKey(t){let e=t;const s=t.length;s===1?e=Hc.oneCharToKey(t,this._data):s===2&&(e=Hc.multCharToKey(t,this._data)),this._result[e]=new nl(this._node[t],this._data).run()}_handleArray(){this._result=[],this._node.forEach(this._handleArElt,this)}_handleArElt(t){const e=new nl(t,this._data).run();this._result.push(e)}}class Xc{constructor(t,e){this._app=t,this._isTemplate=e}parse(t){const e={};let s=null;const i=t.compressedFormat;i&&!t.entDecompressed&&(t.entDecompressed=!0,t.entities=new nl(t.entities,i).run());for(const n in t.entities){const r=t.entities[n],a=this._createEntity(r,i);e[n]=a,r.parent===null&&(s=a)}for(const n in t.entities){const r=e[n],a=t.entities[n].children,l=a.length;for(let h=0;h<l;h++){const c=e[a[h]];c&&r.addChild(c)}}return this._openComponentData(s,t.entities),s}_createEntity(t,e){const s=new pt(t.name,this._app);if(s.setGuid(t.resource_id),this._setPosRotScale(s,t,e),s._enabled=t.enabled!==void 0?t.enabled:!0,this._isTemplate?s._template=!0:s._enabledInHierarchy=s._enabled,s.template=t.template,t.tags)for(let i=0;i<t.tags.length;i++)s.tags.add(t.tags[i]);return t.labels&&t.labels.forEach(function(i){s.addLabel(i)}),s}_setPosRotScale(t,e,s){if(s)Hc.setCompressedPRS(t,e,s);else{const i=e.position,n=e.rotation,r=e.scale;t.setLocalPosition(i[0],i[1],i[2]),t.setLocalEulerAngles(n[0],n[1],n[2]),t.setLocalScale(r[0],r[1],r[2])}}_openComponentData(t,e){const s=this._app.systems.list;let i=s.length;const n=e[t.getGuid()];for(let a=0;a<i;a++){const l=s[a],h=n.components[l.id];h&&l.addComponent(t,h)}i=n.children.length;const r=t._children;for(let a=0;a<i;a++)r[a]=this._openComponentData(r[a],e);return t}}const Hm={load:function(o,t,e){typeof o=="string"&&(o={load:o,original:o}),Ft.get(o.load,{retry:t>0,maxRetries:t},function(s,i){if(!s)e(s,i);else{let n="Error while loading scene JSON "+o.original;s.message?(n+=": "+s.message,s.stack&&(n+=`
`+s.stack)):n+=": "+s,e(n)}})}};class PT{constructor(t){this._app=t,this.maxRetries=0}load(t,e){Hm.load(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const i=new Xc(this._app,!1).parse(e);return this._app.systems.script.preloading=!1,i}}class ET{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e(`Error loading html resource: ${t.original} [${s}]`):e(null,i)})}open(t,e){return e}patch(t,e){}}class RT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=dt.ResponseType.JSON),Ft.get(t.load,s,function(i,n){i?e(`Error loading JSON resource: ${t.original} [${i}]`):e(null,n)})}open(t,e){return e}patch(t,e){}}class rl{constructor(t,e,s,i,n){this.propertyName=t,this.parent=e,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}}function Pn(){return Pn=Object.assign||function(o){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(o[s]=e[s])}return o},Pn.apply(this,arguments)}class IT{constructor(){this.removeInvalid=!0,this.valid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([ry,ph,ay]),cull:this._createEnumValidator([me,cn,Xa,Wu]),blendType:this._createEnumValidator([Ng,Ta,Be,he,Je,Ca,Aa,nh,rh,ah,oh]),depthFunc:this._createEnumValidator([_y,Ah,Ya,$a,gy,yy,xy,Ri]),shadingModel:this._createEnumValidator([Pi,Ea])}}setInvalid(t,e){this.valid=!1,this.removeInvalid&&delete e[t]}validate(t){const e=yn,s=t.mappingFormat==="path";for(const i in t){const n=e[i];if(!n){this.valid=!1;continue}if(n.startsWith("enum")){const r=n.split(":")[1];this.enumValidators[r]&&(this.enumValidators[r](t[i])||this.setInvalid(i,t))}else if(n==="number")typeof t[i]!="number"&&this.setInvalid(i,t);else if(n==="boolean")typeof t[i]!="boolean"&&this.setInvalid(i,t);else if(n==="string")typeof t[i]!="string"&&this.setInvalid(i,t);else if(n==="vec2")t[i]instanceof Array&&t[i].length===2||this.setInvalid(i,t);else if(n==="rgb")t[i]instanceof Array&&t[i].length===3||this.setInvalid(i,t);else if(n==="texture")s?typeof t[i]=="string"||t[i]===null||t[i]instanceof nt||this.setInvalid(i,t):typeof t[i]=="number"||t[i]===null||t[i]instanceof nt||this.setInvalid(i,t);else if(n==="boundingbox")t[i].center&&t[i].center instanceof Array&&t[i].center.length===3||this.setInvalid(i,t),t[i].halfExtents&&t[i].halfExtents instanceof Array&&t[i].halfExtents.length===3||this.setInvalid(i,t);else if(n==="cubemap")typeof t[i]=="number"||t[i]===null||t[i]===void 0||t[i]instanceof nt&&t[i].cubemap||this.setInvalid(i,t);else if(n==="chunks"){const r=Object.keys(t[i]);for(let a=0;a<r.length;a++)typeof t[i][r[a]]!="string"&&this.setInvalid(r[a],t[i])}else console.error("Unknown material type: "+n)}return t.validated=!0,this.valid}_createEnumValidator(t){return function(e){return t.indexOf(e)>=0}}}class LT{constructor(){this._validator=null}parse(t){const e=this.migrate(t),s=this._validate(e),i=new ue;return this.initialize(i,s),i}initialize(t,e){e.validated||(e=this._validate(e)),e.chunks&&(t.chunks=Pn({},e.chunks));for(const s in e){const i=yn[s],n=e[s];if(i==="vec2")t[s]=new H(n[0],n[1]);else if(i==="rgb")t[s]=new j(n[0],n[1],n[2]);else if(i==="texture")n instanceof nt?t[s]=n:t[s]instanceof nt&&typeof n=="number"&&n>0||(t[s]=null);else if(i==="cubemap")n instanceof nt?t[s]=n:t[s]instanceof nt&&typeof n=="number"&&n>0||(t[s]=null),s==="cubeMap"&&!n&&(t.prefilteredCubemaps=null);else if(i==="boundingbox"){const r=new y(n.center[0],n.center[1],n.center[2]),a=new y(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]);t[s]=new gt(r,a)}else t[s]=e[s]}t.update()}migrate(t){t.shadingModel===void 0&&(t.shader==="blinn"?t.shadingModel=Ea:t.shadingModel=Pi),t.shader&&delete t.shader,t.mapping_format&&(t.mappingFormat=t.mapping_format,delete t.mapping_format);let e;const s=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(e=0;e<s.length;e++){const n=s[e][0],r=s[e][1];t[n]!==void 0&&t[r]===void 0&&(t[r]=t[n],delete t[n])}const i=["fresnelFactor","shadowSampleType"];for(e=0;e<i.length;e++){const n=i[e];t.hasOwnProperty(n)&&delete t[n]}return t}_validate(t){return t.validated||(this._validator||(this._validator=new IT),this._validator.validate(t)),t}}const DT={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};class FT{constructor(t){this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this._parser=new LT,this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e&&e(`Error loading material: ${t.original} [${s}]`):e&&(i._engine=!0,e(null,i))})}open(t,e){const s=this._parser.parse(e);return e._engine&&(s._data=e,delete e._engine),s}_createPlaceholders(){this._placeholderTextures={};const t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(const e in t){if(!t.hasOwnProperty(e))continue;this._placeholderTextures[e]=new nt(this._device,{width:2,height:2,format:ct}),this._placeholderTextures[e].name="placeholder";const s=this._placeholderTextures[e].lock();for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[i*4+n]=t[e][n];this._placeholderTextures[e].unlock()}}patch(t,e){t.resource._data&&(t._data=t.resource._data,delete t.resource._data),t.data.name=t.name,t.resource.name=t.name,this._bindAndAssignAssets(t,e),t.off("unload",this._onAssetUnload,this),t.on("unload",this._onAssetUnload,this)}_onAssetUnload(t){delete t.data.parameters,delete t.data.chunks,delete t.data.name}_assignTexture(t,e,s){e.resource[t]=s}_getPlaceholderTexture(t){this._placeholderTextures||this._createPlaceholders();const e=DT[t];return this._placeholderTextures[e]}_assignPlaceholderTexture(t,e){e.resource[t]=this._getPlaceholderTexture(t)}_onTextureLoad(t,e,s){this._assignTexture(t,e,s.resource),e.resource.update()}_onTextureAdd(t,e,s){this._assets.load(s)}_onTextureRemoveOrUnload(t,e,s){const i=e.resource;i&&e.resource[t]===s.resource&&(this._assignPlaceholderTexture(t,e),i.update())}_assignCubemap(t,e,s){e.resource[t]=s[0],t==="cubeMap"&&(e.resource.prefilteredCubemaps=s.slice(1))}_onCubemapLoad(t,e,s){this._assignCubemap(t,e,s.resources),this._parser.initialize(e.resource,e.data)}_onCubemapAdd(t,e,s){e.data.shadingModel===Pi&&(e.loadFaces=!0),this._assets.load(s)}_onCubemapRemoveOrUnload(t,e,s){const i=e.resource;e.data.prefilteredCubeMap128===s.resources[1]&&(this._assignCubemap(t,e,[null,null,null,null,null,null,null]),i.update())}_bindAndAssignAssets(t,e){const s=this._parser.migrate(t.data),i=t.resource,n=s.mappingFormat==="path",r=vo;let a,l,h;for(a=0;a<r.length;a++){l=r[a],h=i._assetReferences[l];const d=s[l],u=i[l],f=u===this._getPlaceholderTexture(l),m=s.validated;d&&(!u||!m||f)?(h||(h=new rl(l,t,e,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemoveOrUnload,unload:this._onTextureRemoveOrUnload},this),i._assetReferences[l]=h),n?h.url=t.getAbsoluteUrl(d):h.id=d,h.asset&&(h.asset.resource?this._assignTexture(l,t,h.asset.resource):this._assignPlaceholderTexture(l,t),e.load(h.asset))):h&&(n?h.url=null:h.id=null)}const c=rc;for(a=0;a<c.length;a++)l=c[a],h=i._assetReferences[l],s[l]&&!t.data.prefilteredCubeMap128&&(h||(h=new rl(l,t,e,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemoveOrUnload,unload:this._onCubemapRemoveOrUnload},this),i._assetReferences[l]=h),n?h.url=s[l]:h.id=s[l],h.asset&&(h.asset.loaded&&this._assignCubemap(l,t,h.asset.resources),e.load(h.asset)));this._parser.initialize(i,s)}}class OT{constructor(t,e){this._device=t,this._defaultMaterial=e}parse(t){const e=Zr.parse("filename.glb",t,this._device);if(e){const s=xi.createModel(e,this._defaultMaterial);return e.destroy(),s}return null}}class BT{constructor(){this.index=0,this.boneIndices=[0,0,0,0]}}class kT{constructor(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={},this.originalMesh=null}addVertex(t,e,s){let i=-1;if(this.indexMap[e]!==void 0)i=this.indexMap[e],this.indices.push(i);else{for(let n=0;n<4;n++){if(s.blendWeight.data[e*4+n]===0)continue;const r=s.blendIndices.data[t.index*4+n];t.boneIndices[n]=this.getBoneRemap(r)}i=this.vertices.length,this.indices.push(i),this.vertices.push(t),this.indexMap[e]=i}}addPrimitive(t,e,s,i){const n=[];let r=0;const a=t.length;for(let l=0;l<a;l++){const c=t[l].index;for(let d=0;d<4;d++)if(s.blendWeight.data[c*4+d]>0){const u=s.blendIndices.data[c*4+d];let f=!0;for(let m=0;m<r;m++)if(n[m]===u){f=!1;break}f&&(n[r]=u,r+=this.getBoneRemap(u)===-1?1:0)}}if(this.boneIndices.length+r>i)return!1;for(let l=0;l<r;l++)this.boneIndices.push(n[l]);for(let l=0;l<a;l++)this.addVertex(t[l],e[l],s);return!0}getBoneRemap(t){for(let e=0;e<this.boneIndices.length;e++)if(this.boneIndices[e]===t)return e;return-1}}function zT(o){const t=o.vertices,e=o.skins,s=o.meshes,i=o.meshInstances;for(let n=0;n<s.length;n++)s[n].vertices=t[s[n].vertices],s[n].skin!==void 0&&(s[n].skin=e[s[n].skin]);for(let n=0;n<i.length;n++)i[n].mesh=s[i[n].mesh]}function UT(o){const t=o.vertices,e=o.skins,s=o.meshes,i=o.meshInstances;for(let n=0;n<s.length;n++)s[n].vertices=t.indexOf(s[n].vertices),s[n].skin!==void 0&&(s[n].skin=e.indexOf(s[n].skin));for(let n=0;n<i.length;n++)i[n].mesh=s.indexOf(i[n].mesh)}function NT(o,t,e){let s,i,n,r;zT(o);const a=o.vertices,l=o.skins;let h;const c=o.meshes,d=o.meshInstances,u=function(m){const p=new BT;return p.index=m,p};for(s=l.length-1;s>=0;s--)if(l[s].boneNames.length>e){const f=l.splice(s,1)[0],m=[];for(i=0;i<c.length;i++)c[i].skin===f&&m.push(c[i]);for(i=0;i<m.length;i++)r=c.indexOf(m[i]),r!==-1&&c.splice(r,1);if(m.length===0)throw new Error("partitionSkin: There should be at least one mesh that references a skin");const p=m[0].vertices;for(i=1;i<m.length;i++)if(m[i].vertices!==p)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");let _;const g=[],w=[],v=[];let x=0;for(i=0;i<m.length;i++){h=m[i];const k=h.indices;for(let N=h.base;N<h.base+h.count;){r=k[N++],w[0]=u(r),v[0]=r,r=k[N++],w[1]=u(r),v[1]=r,r=k[N++],w[2]=u(r),v[2]=r;let X=!1;for(let q=x;q<g.length;q++)if(_=g[q],_.addPrimitive(w,v,p,e)){X=!0;break}X||(_=new kT,_.originalMesh=h,_.addPrimitive(w,v,p,e),g.push(_))}x=g.length}const S=[],T=[];for(i=0;i<g.length;i++)if(_=g[i],_.vertices.length&&_.indices.length){const k=S.length,N=_.vertices.length,X=T.length,q=_.indices.length;_.partition=i,_.vertexStart=k,_.vertexCount=N,_.indexStart=X,_.indexCount=q;let A,R;for(A=0,R=k;A<N;)S[R++]=_.vertices[A++];for(A=0,R=X;A<q;)T[R++]=_.indices[A++]+k}const b=[];for(i=0;i<g.length;i++){_=g[i];const k=[],N=[];for(n=0;n<_.boneIndices.length;n++)k.push(f.inverseBindMatrices[_.boneIndices[n]]),N.push(f.boneNames[_.boneIndices[n]]);const X={inverseBindMatrices:k,boneNames:N};b.push(X),l.push(X)}let C,M,E,D;const I={};for(M in p)I[M]={components:p[M].components,data:[],type:p[M].type};for(M in p)if(M==="blendIndices"){const k=I[M].data;for(i=0;i<S.length;i++){const N=S[i].boneIndices;k.push(N[0],N[1],N[2],N[3])}}else for(C=p[M],E=C.data,D=C.components,i=0;i<S.length;i++)for(r=S[i].index,n=0;n<D;n++)I[M].data.push(E[r*D+n]);for(a[a.indexOf(p)]=I,i=0;i<g.length;i++)for(_=g[i],h={aabb:{min:[0,0,0],max:[0,0,0]},vertices:I,skin:b[i],indices:T.splice(0,_.indexCount),type:"triangles",base:0,count:_.indexCount},c.push(h),n=d.length-1;n>=0;n--)d[n].mesh===_.originalMesh&&(d.push({mesh:h,node:d[n].node}),t&&t.push({material:t[n].material,path:t[n].path}));for(i=0;i<g.length;i++)for(_=g[i],n=d.length-1;n>=0;n--)d[n].mesh===_.originalMesh&&(d.splice(n,1),t&&t.splice(n,1))}UT(o)}const VT={points:Tr,lines:io,lineloop:Yu,linestrip:$u,triangles:ts,trianglestrip:Cr,trianglefan:Di},WT={int8:mo,uint8:ci,int16:po,uint16:fn,int32:sf,uint32:nf,float32:wt};class GT{constructor(t,e){this._device=t,this._defaultMaterial=e}parse(t){const e=t.model;if(!e||e.version<=1)return null;const s=this._parseNodes(t),i=this._parseSkins(t,s),n=this._parseVertexBuffers(t),r=this._parseIndexBuffers(t,n),a=this._parseMorphs(t,s,n),l=this._parseMeshes(t,i.skins,a.morphs,n,r.buffer,r.data),h=this._parseMeshInstances(t,s,l,i.skins,i.instances,a.morphs,a.instances),c=new Ts;return c.graph=s[0],c.meshInstances=h,c.skinInstances=i.instances,c.morphInstances=a.instances,c.getGraph().syncHierarchy(),c}_parseNodes(t){const e=t.model,s=[];let i;for(i=0;i<e.nodes.length;i++){const n=e.nodes[i],r=new xt(n.name);r.setLocalPosition(n.position[0],n.position[1],n.position[2]),r.setLocalEulerAngles(n.rotation[0],n.rotation[1],n.rotation[2]),r.setLocalScale(n.scale[0],n.scale[1],n.scale[2]),r.scaleCompensation=!!n.scaleCompensation,s.push(r)}for(i=1;i<e.parents.length;i++)s[e.parents[i]].addChild(s[i]);return s}_parseSkins(t,e){const s=t.model,i=[],n=[];let r,a;if(!this._device.supportsBoneTextures&&s.skins.length>0){const l=this._device.getBoneLimit();NT(s,null,l)}for(r=0;r<s.skins.length;r++){const l=s.skins[r],h=[];for(a=0;a<l.inverseBindMatrices.length;a++){const f=l.inverseBindMatrices[a];h[a]=new G().set(f)}const c=new Am(this._device,h,l.boneNames);i.push(c);const d=new Wr(c),u=[];for(a=0;a<c.boneNames.length;a++){const f=c.boneNames[a],m=e[0].findByName(f);u.push(m)}d.bones=u,n.push(d)}return{skins:i,instances:n}}_getMorphVertexCount(t,e,s){for(let i=0;i<t.meshes.length;i++){const n=t.meshes[i];if(n.morph===e)return s[n.vertices].numVertices}}_parseMorphs(t,e,s){const i=t.model,n=[],r=[];let a,l,h,c,d,u;if(i.morphs){const f=function(p,_,g){const w=new Float32Array(g*3);for(let v=0;v<_.length;v++){const x=_[v]*3;w[x]=p[v*3],w[x+1]=p[v*3+1],w[x+2]=p[v*3+2]}return w};for(a=0;a<i.morphs.length;a++){for(c=i.morphs[a].targets,u=[],h=this._getMorphVertexCount(i,a,s),l=0;l<c.length;l++){const _=c[l].aabb,g=_.min,w=_.max,v=new gt(new y((w[0]+g[0])*.5,(w[1]+g[1])*.5,(w[2]+g[2])*.5),new y((w[0]-g[0])*.5,(w[1]-g[1])*.5,(w[2]-g[2])*.5)),x=c[l].indices;let S=c[l].deltaPositions,T=c[l].deltaNormals;x&&(S=f(S,x,h),T=f(T,x,h)),d=new Cm({deltaPositions:S,deltaNormals:T,name:c[l].name,aabb:v}),u.push(d)}const m=new Ee(u,this._device);n.push(m);const p=new Gi(m);r.push(p)}}return{morphs:n,instances:r}}_parseVertexBuffers(t){const e=t.model,s=[],i={position:Ot,normal:pe,tangent:vs,blendWeight:Ss,blendIndices:Se,color:de,texCoord0:be,texCoord1:hi,texCoord2:no,texCoord3:ro,texCoord4:ao,texCoord5:oo,texCoord6:lo,texCoord7:ho};for(let n=0;n<e.vertices.length;n++){const r=e.vertices[n],a=[];for(const u in r){const f=r[u];a.push({semantic:i[u],components:f.components,type:WT[f.type],normalize:i[u]===de})}const l=new re(this._device,a),h=r.position.data.length/r.position.components,c=new Ds(this._device,l,h),d=new Nr(c);for(let u=0;u<h;u++){for(const f in r){const m=r[f];switch(m.components){case 1:d.element[i[f]].set(m.data[u]);break;case 2:d.element[i[f]].set(m.data[u*2],1-m.data[u*2+1]);break;case 3:d.element[i[f]].set(m.data[u*3],m.data[u*3+1],m.data[u*3+2]);break;case 4:d.element[i[f]].set(m.data[u*4],m.data[u*4+1],m.data[u*4+2],m.data[u*4+3]);break}}d.next()}d.end(),s.push(c)}return s}_parseIndexBuffers(t,e){const s=t.model;let i=null,n=null,r,a=0;for(r=0;r<s.meshes.length;r++){const h=s.meshes[r];h.indices!==void 0&&(a+=h.indices.length)}let l=0;for(r=0;r<e.length;r++)l=Math.max(l,e[r].numVertices);return a>0&&(l>65535&&this._device.extUintElement?(i=new ui(this._device,Ii,a),n=new Uint32Array(i.lock())):(i=new ui(this._device,Is,a),n=new Uint16Array(i.lock()))),{buffer:i,data:n}}_parseMeshes(t,e,s,i,n,r){const a=t.model,l=[];let h=0;for(let c=0;c<a.meshes.length;c++){const d=a.meshes[c],u=d.aabb,f=u.min,m=u.max,p=new gt(new y((m[0]+f[0])*.5,(m[1]+f[1])*.5,(m[2]+f[2])*.5),new y((m[0]-f[0])*.5,(m[1]-f[1])*.5,(m[2]-f[2])*.5)),_=d.indices!==void 0,g=new is(this._device);g.vertexBuffer=i[d.vertices],g.indexBuffer[0]=_?n:null,g.primitive[0].type=VT[d.type],g.primitive[0].base=_?d.base+h:d.base,g.primitive[0].count=d.count,g.primitive[0].indexed=_,g.skin=d.skin!==void 0?e[d.skin]:null,g.morph=d.morph!==void 0?s[d.morph]:null,g.aabb=p,_&&(r.set(d.indices,h),h+=d.indices.length),l.push(g)}return n!==null&&n.unlock(),l}_parseMeshInstances(t,e,s,i,n,r,a){const l=t.model,h=[];let c;for(c=0;c<l.meshInstances.length;c++){const d=l.meshInstances[c],u=e[d.node],f=s[d.mesh],m=new vt(f,this._defaultMaterial,u);if(f.skin){const p=i.indexOf(f.skin);m.skinInstance=n[p]}if(f.morph){const p=r.indexOf(f.morph);m.morphInstance=a[p]}h.push(m)}return h}}class HT{constructor(t){this._device=t,this._parsers=[],this._defaultMaterial=zi(t),this.maxRetries=0,this.addParser(new GT(this._device,this._defaultMaterial),function(e,s){return ot.getExtension(e)===".json"}),this.addParser(new OT(this._device,this._defaultMaterial),function(e,s){return ot.getExtension(e)===".glb"})}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};(t.load.startsWith("blob:")||t.load.startsWith("data:"))&&(ot.getExtension(t.original).toLowerCase()===".glb"?s.responseType=dt.ResponseType.ARRAY_BUFFER:s.responseType=dt.ResponseType.JSON),Ft.get(t.load,s,function(i,n){!e||(i?e(`Error loading model: ${t.original} [${i}]`):e(null,n))})}open(t,e){for(let s=0;s<this._parsers.length;s++){const i=this._parsers[s];if(i.decider(t,e))return i.parser.parse(e)}return null}patch(t,e){if(!t.resource)return;const s=t.data,i=this;t.resource.meshInstances.forEach(function(n,r){if(s.mapping){const a=function d(u){u.resource?n.material=u.resource:(u.once("load",d),e.load(u)),u.once("remove",function(f){n.material===f.resource&&(n.material=i._defaultMaterial)})};if(!s.mapping[r]){n.material=i._defaultMaterial;return}const l=s.mapping[r].material,h=s.mapping[r].path;let c;if(l!==void 0)l?(c=e.get(l),c?a(c):e.once("add:"+l,a)):n.material=i._defaultMaterial;else if(h){const d=t.getAbsoluteUrl(s.mapping[r].path);c=e.getByUrl(d),c?a(c):e.once("add:url:"+d,a)}}})}addParser(t,e){this._parsers.push({parser:t,decider:e})}}function al(o){const t=this;if(!t.resource)return;const e=o.resource,s=e.renders&&e.renders[t.data.renderIndex];s&&(t.resource.meshes=s.resource.meshes)}function Xm(o){const t=this;t.registry.off("load:"+o.id,al,t),t.registry.on("load:"+o.id,al,t),t.registry.off("remove:"+o.id,jm,t),t.registry.once("remove:"+o.id,jm,t),o.resource?al.call(t,o):t.registry.load(o)}function jm(o){const t=this;t.registry.off("load:"+o.id,al,t),t.resource&&t.resource.destroy()}class XT{constructor(t){this._registry=t}load(t,e,s){}open(t,e){return new Mm}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);if(!s){e.once("add:"+t.data.containerAsset,Xm,t);return}Xm.call(t,s)}}class jT{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}load(t,e,s,i){const n=this._handlers[e];if(!n){const a="No handler for asset type: "+e;s(a);return}if(!t){this._loadNull(n,s,i);return}const r=t+e;if(this._cache[r]!==void 0)s(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(s);else{this._requests[r]=[s];const a=this,l=function(d,u){if(d){a._onFailure(r,d);return}n.load(u,function(f,m,p){if(!!a._requests[r]){if(f){a._onFailure(r,f);return}try{a._onSuccess(r,n.open(u.original,m,i),p)}catch(_){a._onFailure(r,_)}}},i)},h=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(h)){if(!this._app.bundles.canLoadUrl(h)){l(`Bundle for ${t} not loaded yet`);return}this._app.bundles.loadUrl(h,function(c,d){l(c,{load:d,original:h})})}else l(null,{load:t,original:i&&i.file.filename||t})}}_loadNull(t,e,s){const i=function(r,a,l){if(r)e(r);else try{e(null,t.open(null,a,s),l)}catch(h){e(h)}};t.load(null,i,s)}_onSuccess(t,e,s){this._cache[t]=e;for(let i=0;i<this._requests[t].length;i++)this._requests[t][i](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn("No resource handler found for: "+t),e)}patch(t,e){const s=this._handlers[t.type];if(!s){console.warn("No resource handler found for: "+t.type);return}s.patch&&s.patch(t,e)}clearCache(t,e){delete this._cache[t+e]}getFromCache(t,e){if(this._cache[t+e])return this._cache[t+e]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class qT{constructor(t){this._app=t,this.maxRetries=0}load(t,e){Hm.load(t,this.maxRetries,e)}open(t,e){this._app.systems.script.preloading=!0;const i=new Xc(this._app,!1).parse(e),n=this._app.scene;return n.root=i,this._app.applySceneSettings(e.settings),this._app.systems.script.preloading=!1,n}patch(t,e){}}let jc=!1,qm=!1;const Re={app:null,create:function(o,t){if(!jc)return;const e=t(Re.app);e._pcScriptName=o,je._push(e),this.fire("created",o,t)},attribute:function(o,t,e,s){},createLoadingScreen:function(o){if(qm)return;qm=!0;const t=Ne();o(t)}};Object.defineProperty(Re,"legacy",{get:function(){return jc},set:function(o){jc=o}});Kl.attach(Re);class je{constructor(t){this._app=t,this._scripts={},this._cache={}}static _push(t){Re.legacy&&je._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):je._types.push(t)}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s=this;Re.app=this._app,this._loadScript(t.load,(i,n,r)=>{if(i)e(i);else if(Re.legacy){let a=null;je._types.length&&(a=je._types.pop()),a?this._scripts[n]=a:a=null,e(null,a,r)}else{const a={};for(let l=0;l<je._types.length;l++)a[je._types[l].name]=je._types[l];je._types.length=0,e(null,a,r),delete s._loader._cache[n+"script"]}})}open(t,e){return e}patch(t,e){}_loadScript(t,e){const s=document.head,i=document.createElement("script");this._cache[t]=i,i.async=!1,i.addEventListener("error",function(r){e(`Script: ${r.target.src} failed to load`)},!1);let n=!1;i.onload=i.onreadystatechange=function(){!n&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")&&(n=!0,e(null,t,i))},i.src=t,s.appendChild(i)}}je._types=[];class YT{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e(`Error loading shader resource: ${t.original} [${s}]`):e(null,i)})}open(t,e){return e}patch(t,e){}}const $T=[0,0,1,0,0,1,0,0,1,0,0,1],KT=[0,1,3,2,3,1];class ZT extends at{constructor(t,e){super();this._device=t,this._pixelsPerUnit=e&&e.pixelsPerUnit!==void 0?e.pixelsPerUnit:1,this._renderMode=e&&e.renderMode!==void 0?e.renderMode:oi,this._atlas=e&&e.atlas!==void 0?e.atlas:null,this._frameKeys=e&&e.frameKeys!==void 0?e.frameKeys:null,this._meshes=[],this._updatingProperties=!1,this._meshesDirty=!1,this._atlas&&this._frameKeys&&this._createMeshes()}set frameKeys(t){this._frameKeys=t,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",t)}get frameKeys(){return this._frameKeys}set atlas(t){t!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),this._atlas=t,this._atlas&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",t))}get atlas(){return this._atlas}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this.fire("set:pixelsPerUnit",t),this._atlas&&this._frameKeys&&this.renderMode===oi&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}get pixelsPerUnit(){return this._pixelsPerUnit}set renderMode(t){if(this._renderMode===t)return;const e=this._renderMode;this._renderMode=t,this.fire("set:renderMode",t),(e===oi||t===oi)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}get renderMode(){return this._renderMode}get meshes(){return this._meshes}_createMeshes(){const t=this._meshes.length;for(let i=0;i<t;i++){const n=this._meshes[i];n&&n.destroy()}const e=this._frameKeys.length;this._meshes=new Array(e);const s=this.renderMode===Xt||this._renderMode===Ut?this._create9SliceMesh:this._createSimpleMesh;for(let i=0;i<e;i++){const n=this._atlas.frames[this._frameKeys[i]];this._meshes[i]=n?s.call(this,n):null}this.fire("set:meshes")}_createSimpleMesh(t){const e=t.rect,s=this._atlas.texture.width,i=this._atlas.texture.height,n=e.z/this._pixelsPerUnit,r=e.w/this._pixelsPerUnit,a=t.pivot.x,l=t.pivot.y,h=[-a*n,-l*r,0,(1-a)*n,-l*r,0,(1-a)*n,(1-l)*r,0,-a*n,(1-l)*r,0],c=e.x/s,d=1-e.y/i,u=(e.x+e.z)/s,f=1-(e.y+e.w)/i,m=[c,d,u,d,u,f,c,f];return Os(this._device,h,{uvs:m,normals:$T,indices:KT})}_create9SliceMesh(){const t=H.ONE,e=3,s=3,i=[],n=[],r=[],a=[];let l=0;for(let c=0;c<=e;c++){const d=c===0||c===e?0:1;for(let u=0;u<=s;u++){const f=-t.x+2*t.x*(c<=1?0:3)/e,m=0,p=-(-t.y+2*t.y*(u<=1?0:3)/s),_=u===0||u===s?0:1;i.push(-f,m,p),n.push(0,1,0),r.push(d,_),c<e&&u<s&&(a.push(l+s+1,l+1,l),a.push(l+s+1,l+s+2,l+1)),l++}}const h={normals:n,uvs:r,indices:a};return Os(this._device,i,h)}_onSetFrames(t){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()}_onFrameChanged(t,e){const s=this._frameKeys.indexOf(t);s<0||(e?this.renderMode===oi&&(this._meshes[s]=this._createSimpleMesh(e)):this._meshes[s]=null,this.fire("set:meshes"))}_onFrameRemoved(t){const e=this._frameKeys.indexOf(t);e<0||(this._meshes[e]=null,this.fire("set:meshes"))}startUpdate(){this._updatingProperties=!0,this._meshesDirty=!1}endUpdate(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1}destroy(){for(const t of this._meshes)t&&t.destroy();this._meshes.length=0}}function qc(o){const t=this;t.resource&&(t.resource.atlas=o.resource)}function Yc(o){this.registry.load(o)}class JT{constructor(t,e){this._assets=t,this._device=e,this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),ot.getExtension(t.original)===".json"&&Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e(s):e(null,i)})}open(t,e){const s=new ZT(this._device);return t&&(s.__data=e),s}patch(t,e){const s=t.resource;if(s.__data&&(t.data.pixelsPerUnit=s.__data.pixelsPerUnit,t.data.renderMode=s.__data.renderMode,t.data.frameKeys=s.__data.frameKeys,s.__data.textureAtlasAsset)){const i=e.getByUrl(s.__data.textureAtlasAsset);i?t.data.textureAtlasAsset=i.id:console.warn("Could not find textureatlas with url: "+s.__data.textureAtlasAsset)}s.startUpdate(),s.renderMode=t.data.renderMode,s.pixelsPerUnit=t.data.pixelsPerUnit,s.frameKeys=t.data.frameKeys,this._updateAtlas(t),s.endUpdate(),t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_updateAtlas(t){const e=t.resource;if(!t.data.textureAtlasAsset){e.atlas=null;return}this._assets.off("load:"+t.data.textureAtlasAsset,qc,t),this._assets.on("load:"+t.data.textureAtlasAsset,qc,t);const s=this._assets.get(t.data.textureAtlasAsset);s&&s.resource?e.atlas=s.resource:s?this._assets.load(s):(this._assets.off("add:"+t.data.textureAtlasAsset,Yc,t),this._assets.on("add:"+t.data.textureAtlasAsset,Yc,t))}_onAssetChange(t,e,s,i){e==="data"&&s&&s.textureAtlasAsset&&i&&s.textureAtlasAsset!==i.textureAtlasAsset&&(this._assets.off("load:"+i.textureAtlasAsset,qc,t),this._assets.off("add:"+i.textureAtlasAsset,Yc,t))}}class QT{constructor(t,e){this._app=t,this._data=e,this._templateRoot=null}instantiate(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()}_parseTemplate(){const t=new Xc(this._app,!0);this._templateRoot=t.parse(this._data)}}class tC{constructor(t){this._app=t,this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};Ft.get(t.load,s,function(i,n){i?e("Error requesting template: "+t.original):e(i,n)})}open(t,e){return new QT(this._app,e)}}class eC{constructor(){this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t}),Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(s,i){s?e(`Error loading text resource: ${t.original} [${s}]`):e(null,i)})}open(t,e){return e}patch(t,e){}}class sC extends at{constructor(){super();this._texture=null,this._frames=null}set texture(t){this._texture=t,this.fire("set:texture",t)}get texture(){return this._texture}set frames(t){this._frames=t,this.fire("set:frames",t)}get frames(){return this._frames}setFrame(t,e){let s=this._frames[t];s?(s.rect.copy(e.rect),s.pivot.copy(e.pivot),s.border.copy(e.border)):(s={rect:e.rect.clone(),pivot:e.pivot.clone(),border:e.border.clone()},this._frames[t]=s),this.fire("set:frame",t.toString(),s)}removeFrame(t){const e=this._frames[t];e&&(delete this._frames[t],this.fire("remove:frame",t.toString(),e))}destroy(){this._texture&&this._texture.destroy()}}const ol={repeat:te,clamp:et,mirror:Ch},ll={nearest:bt,linear:Yt,nearest_mip_nearest:_r,linear_mip_nearest:qa,nearest_mip_linear:ja,linear_mip_linear:Ei},iC=/^data\.frames\.(\d+)$/;class nC{constructor(t){this._loader=t,this.maxRetries=0}load(t,e){typeof t=="string"&&(t={load:t,original:t});const s=this,i=this._loader.getHandler("texture");if(ot.getExtension(t.original)===".json")Ft.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(n,r){if(n)e(n);else{const a=t.original.replace(".json",".png");s._loader.load(a,"texture",function(l,h){l?e(l):e(null,{data:r,texture:h})})}});else return i.load(t,e)}open(t,e){const s=new sC;if(e.texture&&e.data)s.texture=e.texture,s.__data=e.data;else{const n=this._loader.getHandler("texture").open(t,e);if(!n)return null;s.texture=n}return s}patch(t,e){t.resource.__data&&(t.resource.__data.minfilter!==void 0&&(t.data.minfilter=t.resource.__data.minfilter),t.resource.__data.magfilter!==void 0&&(t.data.magfilter=t.resource.__data.magfilter),t.resource.__data.addressu!==void 0&&(t.data.addressu=t.resource.__data.addressu),t.resource.__data.addressv!==void 0&&(t.data.addressv=t.resource.__data.addressv),t.resource.__data.mipmaps!==void 0&&(t.data.mipmaps=t.resource.__data.mipmaps),t.resource.__data.anisotropy!==void 0&&(t.data.anisotropy=t.resource.__data.anisotropy),t.resource.__data.rgbm!==void 0&&(t.data.rgbm=!!t.resource.__data.rgbm),t.data.frames=t.resource.__data.frames,delete t.resource.__data);const s=t.resource.texture;if(s&&(s.name=t.name,t.data.hasOwnProperty("minfilter")&&s.minFilter!==ll[t.data.minfilter]&&(s.minFilter=ll[t.data.minfilter]),t.data.hasOwnProperty("magfilter")&&s.magFilter!==ll[t.data.magfilter]&&(s.magFilter=ll[t.data.magfilter]),t.data.hasOwnProperty("addressu")&&s.addressU!==ol[t.data.addressu]&&(s.addressU=ol[t.data.addressu]),t.data.hasOwnProperty("addressv")&&s.addressV!==ol[t.data.addressv]&&(s.addressV=ol[t.data.addressv]),t.data.hasOwnProperty("mipmaps")&&s.mipmaps!==t.data.mipmaps&&(s.mipmaps=t.data.mipmaps),t.data.hasOwnProperty("anisotropy")&&s.anisotropy!==t.data.anisotropy&&(s.anisotropy=t.data.anisotropy),t.data.hasOwnProperty("rgbm"))){const n=t.data.rgbm?jt:_e;s.type!==n&&(s.type=n)}t.resource.texture=s;const i={};for(const n in t.data.frames){const r=t.data.frames[n];i[n]={rect:new Z(r.rect),pivot:new H(r.pivot),border:new Z(r.border)}}t.resource.frames=i,t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)}_onAssetChange(t,e,s){let i;if(e==="data"||e==="data.frames"){const n={};for(const r in s.frames)i=s.frames[r],n[r]={rect:new Z(i.rect),pivot:new H(i.pivot),border:new Z(i.border)};t.resource.frames=n}else{const n=e.match(iC);if(n){const r=n[1];s?(t.resource.frames[r]?(i=t.resource.frames[r],i.rect.set(s.rect[0],s.rect[1],s.rect[2],s.rect[3]),i.pivot.set(s.pivot[0],s.pivot[1]),i.border.set(s.border[0],s.border[1],s.border[2],s.border[3])):t.resource.frames[r]={rect:new Z(s.rect),pivot:new H(s.pivot),border:new Z(s.border)},t.resource.fire("set:frame",r,t.resource.frames[r])):t.resource.frames[r]&&(delete t.resource.frames[r],t.resource.fire("remove:frame",r))}}}}function rC(){const o={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16},t={astc:o.cTFASTC_4x4,dxt:o.cTFBC1,etc1:o.cTFETC1,etc2:o.cTFETC1,pvr:o.cTFPVRTC1_4_RGB,atc:o.cTFATC_RGB,none:o.cTFRGB565},e={astc:o.cTFASTC_4x4,dxt:o.cTFBC3,etc1:o.cTFRGBA4444,etc2:o.cTFETC2,pvr:o.cTFPVRTC1_4_RGBA,atc:o.cTFATC_RGBA_INTERPOLATED_ALPHA,none:o.cTFRGBA4444},s={ETC1:21,ETC2_RGB:22,ETC2_RGBA:23,DXT1:8,DXT5:10,PVRTC_4BPP_RGB_1:26,PVRTC_4BPP_RGBA_1:27,ASTC_4x4:28,ATC_RGB:29,ATC_RGBA:30,R8_G8_B8_A8:7,R5_G6_B5:3,R4_G4_B4_A4:5},i=(x,S)=>{switch(x){case o.cTFETC1:return S.formats.etc1?s.ETC1:s.ETC2_RGB;case o.cTFETC2:return s.ETC2_RGBA;case o.cTFBC1:return s.DXT1;case o.cTFBC3:return s.DXT5;case o.cTFPVRTC1_4_RGB:return s.PVRTC_4BPP_RGB_1;case o.cTFPVRTC1_4_RGBA:return s.PVRTC_4BPP_RGBA_1;case o.cTFASTC_4x4:return s.ASTC_4x4;case o.cTFATC_RGB:return s.ATC_RGB;case o.cTFATC_RGBA_INTERPOLATED_ALPHA:return s.ATC_RGBA;case o.cTFRGBA32:return s.R8_G8_B8_A8;case o.cTFRGB565:return s.R5_G6_B5;case o.cTFRGBA4444:return s.R4_G4_B4_A4}},n=x=>{const S=function(b,C){const M=b*(2/255)-1,E=C*(2/255)-1,D=Math.sqrt(1-Math.min(1,M*M+E*E));return Math.max(0,Math.min(255,Math.floor((D+1)*.5*255)))};for(let T=0;T<x.length;T+=4){const b=x[T+3],C=x[T+1];x[T+0]=b,x[T+2]=S(b,C),x[T+3]=255}return x},r=x=>{const S=new Uint16Array(x.length/4);for(let T=0;T<x.length;T+=4){const b=x[T+0],C=x[T+1],M=x[T+2];S[T/4]=(b&248)<<8|(C&252)<<3|M>>3}return S},a=(x,S)=>(x&x-1)==0&&(S&S-1)==0,l=()=>typeof performance!="undefined"?performance.now():0;let h,c,d;const u=(x,S,T)=>{if(T){if(x.formats.astc)return"astc"}else if(S){if(x.formats.etc2)return"etc2"}else if(x.formats.etc1||x.formats.etc2)return"etc1";return(C=>{for(let M=0;M<C.length;++M){const E=C[M];if(x.formats[E])return E}return"none"})(S?d:c)},f=(x,S,T,b)=>{switch(T){case o.cTFETC1:case o.cTFETC2:return!0;case o.cTFBC1:case o.cTFBC3:return(x&3)==0&&(S&3)==0;case o.cTFPVRTC1_4_RGB:case o.cTFPVRTC1_4_RGBA:return a(x,S)&&(x===S||b);case o.cTFASTC_4x4:return!0;case o.cTFATC_RGB:case o.cTFATC_RGBA_INTERPOLATED_ALPHA:return!0}},m=(x,S,T)=>{if(!h.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const b=l(),C=new h.KTX2File(new Uint8Array(S)),M=C.getWidth(),E=C.getHeight(),D=C.getLevels(),I=!!C.getHasAlpha(),k=C.isUASTC&&C.isUASTC();if(!M||!E||!D)throw C.close(),C.delete(),new Error(`Invalid image dimensions url=${x} width=${M} height=${E} levels=${D}`);const N=u(T.deviceDetails,I,k),X=!!T.isGGGR&&N==="pvr";let q;if(X?q=o.cTFRGBA32:(q=I?e[N]:t[N],f(M,E,q,T.deviceDetails.webgl2)||(q=I?o.cTFRGBA32:o.cTFRGB565)),!C.startTranscoding())throw C.close(),C.delete(),new Error("Failed to start transcoding url="+x);let A;const R=[];for(let L=0;L<D;++L){const O=C.getImageTranscodedSizeInBytes(L,0,0,q),z=new Uint8Array(O);if(!C.transcodeImage(z,L,0,0,q,0,-1,-1))throw C.close(),C.delete(),new Error("Failed to transcode image url="+x);const W=q===o.cTFRGB565||q===o.cTFRGBA4444;R.push(W?new Uint16Array(z.buffer):z)}if(C.close(),C.delete(),X)for(q=o.cTFRGB565,A=0;A<R.length;++A)R[A]=r(n(R[A]));return{format:i(q,T.deviceDetails),width:M,height:E,levels:R,cubemap:!1,transcodeTime:l()-b,url:x,unswizzledGGGR:X}},p=(x,S,T)=>{const b=l(),C=new h.BasisFile(new Uint8Array(S)),M=C.getImageWidth(0,0),E=C.getImageHeight(0,0),D=C.getNumImages(),I=C.getNumLevels(0),k=!!C.getHasAlpha(),N=C.isUASTC&&C.isUASTC();if(!M||!E||!D||!I)throw C.close(),C.delete(),new Error(`Invalid image dimensions url=${x} width=${M} height=${E} images=${D} levels=${I}`);const X=u(T.deviceDetails,k,N),q=!!T.isGGGR&&X==="pvr";let A;if(q?A=o.cTFRGBA32:(A=k?e[X]:t[X],f(M,E,A,T.deviceDetails.webgl2)||(A=k?o.cTFRGBA32:o.cTFRGB565)),!C.startTranscoding())throw C.close(),C.delete(),new Error("Failed to start transcoding url="+x);let R;const L=[];for(let O=0;O<I;++O){const z=C.getImageTranscodedSizeInBytes(0,O,A),W=new Uint8Array(z);if(!C.transcodeImage(W,0,O,A,0,0))throw C.close(),C.delete(),new Error("Failed to transcode image url="+x);const K=A===o.cTFRGB565||A===o.cTFRGBA4444;L.push(K?new Uint16Array(W.buffer):W)}if(C.close(),C.delete(),q)for(A=o.cTFRGB565,R=0;R<L.length;++R)L[R]=r(n(L[R]));return{format:i(A,T.deviceDetails),width:M,height:E,levels:L,cubemap:!1,transcodeTime:l()-b,url:x,unswizzledGGGR:q}},_=(x,S,T)=>T.isKTX2?m(x,S,T):p(x,S,T),g=(x,S,T)=>{try{const b=_(x,S,T);b.levels=b.levels.map(C=>C.buffer),self.postMessage({url:x,data:b},b.levels)}catch(b){self.postMessage({url:x,err:b},null)}},w=(x,S)=>{self.importScripts(x.basisUrl);const T=(b,C)=>(WebAssembly.instantiate(x.module,b).then(M=>{C(M)}).catch(M=>{console.error("instantiate failed + "+M)}),{});self.BASIS(x.module?{instantiateWasm:T}:null).then(b=>{b.initializeBasis(),h=b,c=x.rgbPriority,d=x.rgbaPriority,S(null)})},v=[];self.onmessage=x=>{const S=x.data;switch(S.type){case"init":w(S.config,()=>{for(let T=0;T<v.length;++T)g(v[T].url,v[T].data,v[T].options);v.length=0});break;case"transcode":h?g(S.url,S.data,S.options):v.push(S);break}}}const aC=o=>({astc:!!o.extCompressedTextureASTC,atc:!!o.extCompressedTextureATC,dxt:!!o.extCompressedTextureS3TC,etc1:!!o.extCompressedTextureETC1,etc2:!!o.extCompressedTextureETC,pvr:!!o.extCompressedTexturePVRTC}),oC=(o,t)=>{const e=()=>{const r="("+rC.toString()+`)()

`;return new Blob([r],{type:"application/javascript"})},s=()=>{try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"){const r=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(r instanceof WebAssembly.Module)return new WebAssembly.Instance(r)instanceof WebAssembly.Instance}}catch{}return!1},i=(r,a)=>{t(null,{workerUrl:URL.createObjectURL(e()),basisUrl:URL.createObjectURL(r),module:a,rgbPriority:o.rgbPriority,rgbaPriority:o.rgbaPriority})},n={responseType:"blob",retry:o.maxRetries>0,maxRetries:o.maxRetries};if(o.glueUrl&&o.wasmUrl&&s()){let r=null,a=null;Ft.get(o.glueUrl,n,(c,d)=>{c?t(c):a?i(d,a):r=d});const l=fetch(o.wasmUrl),h=()=>{l.then(c=>c.arrayBuffer()).then(c=>WebAssembly.compile(c)).then(c=>{r?i(r,c):a=c}).catch(c=>{t(c,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(l).then(c=>{r?i(r,c):a=c}).catch(c=>{h()}):h()}else Ft.get(o.fallbackUrl,n,(r,a)=>{r?t(r,null):i(a,null)})};class lC{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,i){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const n={url:t,data:e,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const i=this.callbacks[t];if(e)for(let n=0;n<i.length;++n)i[n](e);else{s.format===Za||s.format===Ja?s.levels=s.levels.map(function(n){return new Uint16Array(n)}):s.levels=s.levels.map(function(n){return new Uint8Array(n)});for(let n=0;n<i.length;++n)i[n](null,s)}delete this.callbacks[t]}}class hC{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",i=>{const n=i.data;this.queue.handleResponse(n.url,n.err,n.data),this.eager||this.queue.enqueueClient(this)}),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const cC=1,dC=["etc1","etc2","astc","dxt","pvr","atc"],uC=["astc","dxt","etc2","pvr","atc"],fC=5,$c=new lC;let Ym=null,Kc=!1;function mC(o){if(!Kc){if(!o)o=Ym||{};else if(o.lazyInit){Ym=o;return}if(!o.glueUrl||!o.wasmUrl||!o.fallbackUrl){const e=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find(function(s){return s.moduleName==="BASIS"});if(e){const s=window.ASSET_PREFIX||"";o.glueUrl||(o.glueUrl=s+e.glueUrl),o.wasmUrl||(o.wasmUrl=s+e.wasmUrl),o.fallbackUrl||(o.fallbackUrl=s+e.fallbackUrl)}}if(o.glueUrl||o.wasmUrl||o.fallbackUrl){Kc=!0;const t=Math.max(1,Math.min(16,o.numWorkers||cC)),e=o.numWorkers===1||(o.hasOwnProperty("eagerWorkers")?o.eagerWorkers:!0);o.rgbPriority=o.rgbPriority||dC,o.rgbaPriority=o.rgbaPriority||uC,o.maxRetries=o.hasOwnProperty("maxRetries")?o.maxRetries:fC,oC(o,(s,i)=>{if(s)console.error(`failed to initialize basis worker: ${s}`);else for(let n=0;n<t;++n)$c.enqueueClient(new hC($c,i,e))})}}}let Zc=null;function $m(o,t,e,s,i){return mC(),Zc||(Zc={webgl2:o.webgl2,formats:aC(o)}),$c.enqueueJob(t,e,s,{deviceDetails:Zc,isGGGR:!!(i!=null&&i.isGGGR),isKTX2:!!(i!=null&&i.isKTX2)}),Kc}class pC{constructor(t,e){this.device=e,this.maxRetries=0}load(t,e,s){const i=this.device,n=r=>{var a,l,h;$m(i,t.load,r,e,{isGGGR:((s==null||(a=s.file)==null||(l=a.variants)==null||(h=l.basis)==null?void 0:h.opt)&8)!=0})||e(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`)};rt.fetchArrayBuffer(t.load,(r,a)=>{r?e(r):n(a)},s,this.maxRetries)}open(t,e,s){const i=new nt(s,{name:t,addressU:e.cubemap?et:te,addressV:e.cubemap?et:te,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}}class _C{constructor(t){this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.useImageBitmap=!1}load(t,e,s){var i;const n=!!(s!=null&&(i=s.file)!=null&&i.contents);n&&(t={load:URL.createObjectURL(new Blob([s.file.contents])),original:t.original});const r=(l,h)=>{n&&URL.revokeObjectURL(t.load),e(l,h)};let a;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?a=s.options.crossOrigin:Zo.test(t.load)&&(a=this.crossOrigin),this.useImageBitmap?this._loadImageBitmap(t.load,t.original,a,r):this._loadImage(t.load,t.original,a,r)}open(t,e,s){const i=ot.getExtension(t).toLowerCase(),n=i===".jpg"||i===".jpeg"?Ls:ct,r=new nt(s,{name:t,width:e.width,height:e.height,format:n});return r.setSource(e),r}_loadImage(t,e,s,i){const n=new Image;s&&(n.crossOrigin=s);let r=0;const a=this.maxRetries;let l;n.onload=function(){i(null,n)},n.onerror=function(){if(!l)if(a>0&&++r<=a){const h=Math.pow(2,r)*100;console.log(`Error loading Texture from: '${e}' - Retrying in ${h}ms...`);const d=t.indexOf("?")>=0?"&":"?";l=setTimeout(function(){n.src=t+d+"retry="+Date.now(),l=null},h)}else i(`Error loading Texture from: '${e}'`)},n.src=t}_loadImageBitmap(t,e,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Ft.get(t,n,function(r,a){r?i(r):createImageBitmap(a,{premultiplyAlpha:"none"}).then(function(l){i(null,l)}).catch(function(l){i(l)})})}}const Jc=[1481919403,3140563232,169478669],gC={33776:dn,33778:gr,33779:Li,36196:Sr,37492:Lh,37496:Dh,35840:eo,35841:br,35842:so,35843:wr,32849:Ls,32856:ct,35905:Rh,35907:Ih,35898:to,34843:yr,34842:ce};function yC(o,t,e,s){return o===to?new Uint32Array(t,e,s/4):new Uint8Array(t,e,s)}class xC{constructor(t){this.maxRetries=0}load(t,e,s){rt.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new nt(s,{name:t,addressU:i.cubemap?et:te,addressV:i.cubemap?et:te,width:i.width,height:i.height,format:i.format,cubemap:i.cubemap,levels:i.levels});return n.upload(),n}parse(t){const e=new Uint32Array(t);if(Jc[0]!==e[0]||Jc[1]!==e[1]||Jc[2]!==e[2])return null;const s={endianness:e[3],glType:e[4],glTypeSize:e[5],glFormat:e[6],glInternalFormat:e[7],glBaseInternalFormat:e[8],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1||s.numberOfArrayElements!==0)return null;const i=gC[s.glInternalFormat];if(i===void 0)return null;let n=16+s.bytesOfKeyValueData/4;const r=s.numberOfFaces>1,a=[];for(let l=0;l<(s.numberOfMipmapLevels||1);l++){const h=e[n++];r&&a.push([]);const c=r?a[l]:a;for(let d=0;d<(r?6:1);++d)c.push(yC(i,t,n*4,h)),n+=h+3>>2}return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}}const vC={KHR_DF_MODEL_ETC1S:163,KHR_DF_MODEL_UASTC:166};class SC{constructor(t,e){this.maxRetries=0,this.device=e}load(t,e,s){rt.fetchArrayBuffer(t.load,(i,n)=>{i?e(i,n):this.parse(n,t,e,s)},s,this.maxRetries)}open(t,e,s){const i=new nt(s,{name:t,addressU:e.cubemap?et:te,addressV:e.cubemap?et:te,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels});return i.upload(),i}parse(t,e,s,i){const n=new gu(t),r=[n.readU32be(),n.readU32be(),n.readU32be()];if(r[0]!==2873840728||r[1]!==540160187||r[2]!==218765834)return null;const a={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},l={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},h=[];for(let p=0;p<Math.max(1,a.levelCount);++p)h.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==l.kvdByteOffset-l.dfdByteOffset)return null;n.skip(8);const d=n.readU8();if(n.skip(l.dfdByteLength-9),n.skip(l.kvdByteLength),a.supercompressionScheme===1||d===vC.KHR_DF_MODEL_UASTC){var u,f,m;$m(this.device,e.load,t,s,{isGGGR:((i==null||(u=i.file)==null||(f=u.variants)==null||(m=f.basis)==null?void 0:m.opt)&8)!=0,isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class bC{constructor(t){this.maxRetries=0}load(t,e,s){rt.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=new Uint32Array(e,0,128/4),n=i[4],r=i[3],a=Math.max(i[7],1),l=i[20]===4,h=i[21],c=i[22],d=i[28]===65024,u=827611204,f=894720068,m=113,p=116,_=826496069,g=825438800,w=825504336,v=825439312,x=825504848;let S=!1,T=!1,b=!1,C=!1,M=null,E=1,D;if(l?h===u?(M=dn,S=!0):h===f?(M=Li,S=!0):h===m?(M=ce,E=2):h===p?(M=Vt,E=4):h===_?(M=Sr,S=!0,T=!0):h===g||h===w?(M=h===g?br:wr,S=!0,b=!0):(h===v||h===x)&&(M=h===v?eo:so,S=!0,C=!0):c===32&&(M=ct),!M)return D=new nt(s,{width:4,height:4,format:Ls}),D.name="dds-legacy-empty",D;D=new nt(s,{name:t,addressU:d?et:te,addressV:d?et:te,width:n,height:r,format:M,cubemap:d,mipmaps:a>1});let I=128;const k=d?6:1;let N;const X=4,q=4,A=h===u?8:16;let R,L,O;for(let z=0;z<k;z++){let W=n,K=r;for(let V=0;V<a;V++){S?T?N=Math.floor((W+3)/4)*Math.floor((K+3)/4)*8:b?N=Math.max(W,16)*Math.max(K,8)/4:C?N=Math.max(W,8)*Math.max(K,8)/2:(R=Math.floor((W+X-1)/X),L=Math.floor((K+q-1)/q),O=R*L,N=O*A):N=W*K*4;const P=M===Vt?new Float32Array(e,I,N):M===ce?new Uint16Array(e,I,N):new Uint8Array(e,I,N);d?(D._levels[V]||(D._levels[V]=[]),D._levels[V][z]=P):D._levels[V]=P,I+=N*E,W=Math.max(W*.5,1),K=Math.max(K*.5,1)}}return D.upload(),D}}class wC{constructor(t){this.maxRetries=0}load(t,e,s){rt.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s){const i=this.parse(e);if(!i)return null;const n=new nt(s,{name:t,addressU:te,addressV:et,minFilter:_r,magFilter:bt,width:i.width,height:i.height,levels:i.levels,format:ct,type:uo,mipmaps:!1});return n.upload(),n}parse(t){const e=new gu(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const i={};for(;;){const h=e.readLine();if(h.length===0)break;{const c=h.split("=");c.length===2&&(i[c[0]]=c[1])}}if(!i.hasOwnProperty("FORMAT"))return null;const n=e.readLine().split(" ");if(n.length!==4)return null;const r=parseInt(n[1],10),a=parseInt(n[3],10),l=this._readPixels(e,a,r,n[0]==="-Y");return l?{width:a,height:r,levels:[l]}:null}_readPixels(t,e,s,i){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const n=[0,0,0,0];if(t.readArray(n),n[0]!==2||n[1]!==2||(n[2]&128)!=0)return t.skip(-4),this._readPixelsFlat(t,e,s);const r=new ArrayBuffer(e*s*4),a=new Uint8Array(r);let l=i?0:e*4*(s-1),h,c,d,u,f,m;for(c=0;c<s;++c){if(c&&t.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(u=0;u<4;++u)for(h=0;h<e;)if(f=t.readU8(),f>128){if(f-=128,h+f>e)return null;for(m=t.readU8(),d=0;d<f;++d)a[l+u+4*h++]=m}else{if(f===0||h+f>e)return null;for(d=0;d<f;++d)a[l+u+4*h++]=t.readU8()}l+=e*4*(i?1:-1)}return a}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const Km={repeat:te,clamp:et,mirror:Ch},Zm={nearest:bt,linear:Yt,nearest_mip_nearest:_r,linear_mip_nearest:qa,nearest_mip_linear:ja,linear_mip_linear:Ei},TC={default:_e,rgbm:jt,rgbe:uo,swizzleGGGR:un},CC=function(t){const e=Math.log2(Math.max(t._width,t._height))+1,s=function(r){return r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof HTMLVideoElement};if(!(t._format===ct||t._format===Vt)||t._volume||t._compressed||t._levels.length===1||t._levels.length===e||s(t._cubemap?t._levels[0][0]:t._levels[0]))return;const i=function(r,a,l){const h=Math.max(1,r>>1),c=Math.max(1,a>>1),d=new l.constructor(h*c*4),u=Math.floor(r/h),f=Math.floor(a/c),m=u*f;for(let p=0;p<c;++p)for(let _=0;_<h;++_)for(let g=0;g<4;++g){let w=0;for(let v=0;v<f;++v)for(let x=0;x<u;++x)w+=l[(_*u+x+(p*f+v)*r)*4+g];d[(_+p*h)*4+g]=w/m}return d};for(let n=t._levels.length;n<e;++n){const r=Math.max(1,t._width>>n-1),a=Math.max(1,t._height>>n-1);if(t._cubemap){const l=[];for(let h=0;h<6;++h)l.push(i(r,a,t._levels[n-1][h]));t._levels.push(l)}else t._levels.push(i(r,a,t._levels[n-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]};class AC{constructor(t,e,s){this._device=t,this._assets=e,this._loader=s,this.imgParser=new _C(e),this.parsers={dds:new bC(e),ktx:new xC(e),ktx2:new SC(e,t),basis:new pC(e,t),hdr:new wC(e)}}set crossOrigin(t){this.imgParser.crossOrigin=t}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=ot.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}load(t,e,s){typeof t=="string"&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){if(!t)return;let i=this._getParser(t).open(t,e,this._device);return i===null?i=new nt(this._device,{width:4,height:4,format:Ls}):(CC(i),e.unswizzledGGGR&&(s.file.variants.basis.opt&=~8)),i}patch(t,e){const s=t.resource;if(!s)return;t.name&&t.name.length>0&&(s.name=t.name);const i=t.data;i.hasOwnProperty("minfilter")&&(s.minFilter=Zm[i.minfilter]),i.hasOwnProperty("magfilter")&&(s.magFilter=Zm[i.magfilter]),s.cubemap||(i.hasOwnProperty("addressu")&&(s.addressU=Km[i.addressu]),i.hasOwnProperty("addressv")&&(s.addressV=Km[i.addressv])),i.hasOwnProperty("mipmaps")&&(s.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(s.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(s.flipY=!!i.flipY),i.hasOwnProperty("type")?s.type=TC[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?s.type=jt:t.file&&(t.file.opt&8)!=0&&(s.type=un)}}class MC{constructor(t=null){this._index={},this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&this._index[t].list.indexOf(e)!==-1||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t]||this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);s!==-1&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],this._index[t].list.length===0&&delete this._index[t])}find(t){const e={},s=[];let i,n,r,a,l;const h=(c,d)=>this._index[c].list.length-this._index[d].list.length;for(let c=0;c<t.length;c++){if(n=t[c],n instanceof Array){if(n.length===0)continue;if(n.length===1)n=n[0];else{l=!1;for(let d=0;d<n.length;d++)if(!this._index[n[d]]){l=!0;break}if(l)continue;r=n.slice(0).sort(h),a=r.slice(1),a.length===1&&(a=a[0]);for(let d=0;d<this._index[r[0]].list.length;d++)i=this._index[r[0]].list[d],(this._key?!e[i[this._key]]:s.indexOf(i)===-1)&&i.tags.has(a)&&(this._key&&(e[i[this._key]]=!0),s.push(i));continue}}if(n&&typeof n=="string"&&this._index[n])for(let d=0;d<this._index[n].list.length;d++)i=this._index[n].list[d],this._key?e[i[this._key]]||(e[i[this._key]]=!0,s.push(i)):s.indexOf(i)===-1&&s.push(i)}return s}}class Jm extends at{constructor(t){super();this._loader=t,this._assets=[],this._cache={},this._names={},this._tags=new MC("_id"),this._urls={},this.prefix=null}list(t){return t=t||{},this._assets.filter(e=>{let s=!0;return t.preload!==void 0&&(s=e.preload===t.preload),s})}add(t){const e=this._assets.push(t)-1;let s;this._cache[t.id]=e,this._names[t.name]||(this._names[t.name]=[]),this._names[t.name].push(e),t.file&&(s=t.file.url,this._urls[s]=e),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),s&&this.fire("add:url:"+s,t),t.preload&&this.load(t)}remove(t){const e=this._cache[t.id],s=t.file?t.file.url:null;if(e!==void 0){this._assets.splice(e,1),delete this._cache[t.id],this._names={},this._urls=[];for(let i=0,n=this._assets.length;i<n;i++){const r=this._assets[i];this._cache[r.id]=i,this._names[r.name]||(this._names[r.name]=[]),this._names[r.name].push(i),r.file&&(this._urls[r.file.url]=i)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),s&&this.fire("remove:url:"+s,t),!0}return!1}get(t){const e=this._cache[t];return this._assets[e]}getByUrl(t){const e=this._urls[t];return this._assets[e]}load(t){if(t.loading||t.loaded)return;const e=t.file,s=n=>{n instanceof Array?t.resources=n:t.resource=n,this._loader.patch(t,this),this.fire("load",t),this.fire("load:"+t.id,t),e&&e.url&&this.fire("load:url:"+e.url,t),t.fire("load",t)},i=(n,r,a)=>{if(t.loaded=!0,t.loading=!1,n)this.fire("error",n,t),this.fire("error:"+t.id,n,t),t.fire("error",n,t);else{if(!Re.legacy&&t.type==="script"){const l=this._loader.getHandler("script");l._cache[t.id]&&l._cache[t.id].parentNode===document.head&&document.head.removeChild(l._cache[t.id]),l._cache[t.id]=a}s(r)}};if(e||t.type==="cubemap")this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0,this._loader.load(t.getFileUrl(),t.type,i,t);else{const n=this._loader.open(t.type,t.data);t.loaded=!0,s(n)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,i){const n=ot.getBasename(e||t),r={filename:e||n,url:t};let a=this.getByUrl(t);if(!a)a=new rt(n,s,r),this.add(a);else if(a.loaded){i(a.loadFromUrlError||null,a);return}const l=h=>{h.once("load",c=>{s==="material"?this._loadTextures(c,(d,u)=>{i(d,c)}):i(null,c)}),h.once("error",c=>{c&&(this.loadFromUrlError=c),i(c,h)}),this.load(h)};a.resource?i(null,a):s==="model"?this._loadModel(a,l):l(a)}_loadModel(t,e){const s=t.getFileUrl(),i=ot.getExtension(s);if(i===".json"||i===".glb"){const n=ot.getDirectory(s),r=ot.getBasename(s),a=ot.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",(l,h)=>{l?(t.data={mapping:[]},e(t)):this._loadMaterials(t,h,(c,d)=>{t.data=h,e(t)})})}else e(t)}_loadMaterials(t,e,s){const i=[];let n=0;const r=(a,l)=>{this._loadTextures(l,(h,c)=>{i.push(l),i.length===n&&s(null,i)})};for(let a=0;a<e.mapping.length;a++){const l=e.mapping[a].path;if(l){n++;const h=t.getAbsoluteUrl(l);this.loadFromUrl(h,"material",r)}}n===0&&s(null,i)}_loadTextures(t,e){const s=[];let i=0;const n=t.data;if(n.mappingFormat!=="path"){e(null,s);return}const r=(l,h)=>{l&&console.error(l),s.push(h),s.length===i&&e(null,s)},a=vo;for(let l=0;l<a.length;l++){const h=n[a[l]];if(h&&typeof h=="string"){i++;const c=t.getAbsoluteUrl(h);this.loadFromUrl(c,"texture",r)}}i===0&&e(null,s)}findAll(t,e){const s=this._names[t];if(s){const i=s.map(n=>this._assets[n]);return e?i.filter(n=>n.type===e):i}return[]}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}findByTag(){return this._tags.find(arguments)}filter(t){return this._assets.filter(e=>t(e))}find(t,e){const s=this.findAll(t,e);return s.length>0?s[0]:null}}class PC{constructor(t){this._assets=t,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}_onAssetAdded(t){if(t.type==="bundle"){this._bundleAssets[t.id]=t,this._registerBundleEventListeners(t.id);for(let e=0,s=t.data.assets.length;e<s;e++)this._indexAssetInBundle(t.data.assets[e],t)}else this._assetsInBundles[t.id]&&this._indexAssetFileUrls(t)}_registerBundleEventListeners(t){this._assets.on("load:"+t,this._onBundleLoaded,this),this._assets.on("error:"+t,this._onBundleError,this)}_unregisterBundleEventListeners(t){this._assets.off("load:"+t,this._onBundleLoaded,this),this._assets.off("error:"+t,this._onBundleError,this)}_indexAssetInBundle(t,e){if(!this._assetsInBundles[t])this._assetsInBundles[t]=[e];else{const i=this._assetsInBundles[t];i.indexOf(e)===-1&&i.push(e)}const s=this._assets.get(t);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(!!e)for(let s=0,i=e.length;s<i;s++){const n=e[s];this._urlsInBundles[n]=this._assetsInBundles[t.id]}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=this._normalizeUrl(e);const s=[e];if(t.type==="font"){const i=t.data.info.maps.length;for(let n=1;n<i;n++)s.push(e.replace(".png",n+".png"))}return s}_normalizeUrl(t){return t&&t.split("?")[0]}_onAssetRemoved(t){if(t.type==="bundle"){delete this._bundleAssets[t.id],this._unregisterBundleEventListeners(t.id);for(const e in this._assetsInBundles){const s=this._assetsInBundles[e],i=s.indexOf(t);if(i!==-1&&(s.splice(i,1),!s.length)){delete this._assetsInBundles[e];for(const n in this._urlsInBundles)this._urlsInBundles[n]===s&&delete this._urlsInBundles[n]}}this._onBundleError(`Bundle ${t.id} was removed`,t)}else if(this._assetsInBundles[t.id]){delete this._assetsInBundles[t.id];const e=this._getAssetFileUrls(t);for(let s=0,i=e.length;s<i;s++)delete this._urlsInBundles[e[s]]}}_onBundleLoaded(t){if(!t.resource){this._onBundleError(`Bundle ${t.id} failed to load`,t);return}requestAnimationFrame(()=>{if(!!this._fileRequests)for(const e in this._fileRequests){const s=this._urlsInBundles[e];if(!s||s.indexOf(t)===-1)continue;const i=decodeURIComponent(e);let n=null;t.resource.hasBlobUrl(i)||(n=`Bundle ${t.id} does not contain URL ${e}`);const r=this._fileRequests[e];for(let a=0,l=r.length;a<l;a++)n?r[a](n):r[a](null,t.resource.getBlobUrl(i));delete this._fileRequests[e]}})}_onBundleError(t,e){for(const s in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(s)){const n=this._fileRequests[s];for(let r=0,a=n.length;r<a;r++)n[r](t);delete this._fileRequests[s]}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsInBundles[t];if(!e)return null;const s=e.length;for(let i=0;i<s;i++)if(e[i].loaded&&e[i].resource)return e[i];for(let i=0;i<s;i++)if(e[i].loading)return e[i];return null}listBundlesForAsset(t){return this._assetsInBundles[t.id]||null}list(){const t=[];for(const e in this._bundleAssets)t.push(this._bundleAssets[e]);return t}hasUrl(t){return!!this._urlsInBundles[t]}canLoadUrl(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(!s){e(`URL ${t} not found in any bundles`);return}if(s.loaded){const i=decodeURIComponent(t);if(!s.resource.hasBlobUrl(i)){e(`Bundle ${s.id} does not contain URL ${t}`);return}e(null,s.resource.getBlobUrl(i))}else this._fileRequests.hasOwnProperty(t)?this._fileRequests[t].push(e):this._fileRequests[t]=[e]}destroy(){this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this);for(const t in this._bundleAssets)this._unregisterBundleEventListeners(t);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null}}const EC=["x","y","z","w"],RC=[void 0,void 0,H,y,Z];function hl(o,t,e,s){switch(t.type){case"boolean":return!!e;case"number":if(typeof e=="number")return e;if(typeof e=="string"){const i=parseInt(e,10);return isNaN(i)?null:i}else if(typeof e=="boolean")return 0+e;return null;case"json":{const i={};if(Array.isArray(t.schema)){(!e||typeof e!="object")&&(e={});for(let n=0;n<t.schema.length;n++){const r=t.schema[n];if(!!r.name)if(r.array){i[r.name]=[];const a=Array.isArray(e[r.name])?e[r.name]:[];for(let l=0;l<a.length;l++)i[r.name].push(hl(o,r,a[l]))}else{const a=e.hasOwnProperty(r.name)?e[r.name]:r.default;i[r.name]=hl(o,r,a)}}}return i}case"asset":return e instanceof rt?e:typeof e=="number"?o.assets.get(e)||null:typeof e=="string"&&o.assets.get(parseInt(e,10))||null;case"entity":return e instanceof xt?e:typeof e=="string"?o.getEntityFromIndex(e):null;case"rgb":case"rgba":if(e instanceof j)return s instanceof j?(s.copy(e),s):e.clone();if(e instanceof Array&&e.length>=3&&e.length<=4){for(let i=0;i<e.length;i++)if(typeof e[i]!="number")return null;return s||(s=new j),s.r=e[0],s.g=e[1],s.b=e[2],s.a=e.length===3?1:e[3],s}else if(typeof e=="string"&&/#([0-9abcdef]{2}){3,4}/i.test(e))return s||(s=new j),s.fromString(e),s;return null;case"vec2":case"vec3":case"vec4":{const i=parseInt(t.type.slice(3),10),n=RC[i];if(e instanceof n)return s instanceof n?(s.copy(e),s):e.clone();if(e instanceof Array&&e.length===i){for(let r=0;r<e.length;r++)if(typeof e[r]!="number")return null;s||(s=new n);for(let r=0;r<i;r++)s[EC[r]]=e[r];return s}return null}case"curve":if(e){let i;if(e instanceof fe||e instanceof us)i=e.clone();else{const n=e.keys[0]instanceof Array?us:fe;i=new n(e.keys),i.type=e.type}return i}break}return e}class En{constructor(t){this.scriptType=t,this.index={}}add(t,e){this.index[t]||En.reservedNames.has(t)||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(s){const i="attr",n="attr:"+t,r=this.__attributes[t];let a=r;if(r&&e.type!=="json"&&r.clone&&(this._callbacks[i]||this._callbacks[n])&&(a=r.clone()),e.array){if(this.__attributes[t]=[],s)for(let l=0,h=s.length;l<h;l++)this.__attributes[t].push(hl(this.app,e,s[l],r?r[l]:null))}else this.__attributes[t]=hl(this.app,e,s,r);this.fire(i,t,this.__attributes[t],a),this.fire(n,this.__attributes[t],a)}}))}remove(t){return this.index[t]?(delete this.index[t],delete this.scriptType.prototype[t],!0):!1}has(t){return!!this.index[t]}get(t){return this.index[t]||null}}En.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);class st extends at{constructor(t,e){super();this.system=void 0,this.entity=void 0,this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(s,i,n){this.fire("set_"+s,s,i,n)}),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach(function(s){const i=typeof s=="object"?s.name:s;Object.defineProperty(t,i,{get:function(){return this.data[i]},set:function(n){const r=this.data,a=r[i];r[i]=n,this.fire("set",i,a,n)},configurable:!0})}),t._accessorsBuilt=!0}buildAccessors(t){st._buildAccessors(this,t)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}}class qe extends st{constructor(t,e){super(t,e);this._scripts=[],this._updateList=new Sa({sortBy:"__executionOrder"}),this._postUpdateList=new Sa({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}set scripts(t){this._scriptsData=t;for(const e in t){if(!t.hasOwnProperty(e))continue;const s=this._scriptsIndex[e];if(s){if(typeof t[e].enabled=="boolean"&&(s.enabled=!!t[e].enabled),typeof t[e].attributes=="object"){for(const i in t[e].attributes)if(!En.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const n=this.system.app.scripts.get(e);n&&n.attributes.add(i,{})}s[i]=t[e].attributes[i]}}}else console.log(this.order)}}get scripts(){return this._scripts}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let e=0,s=this.scripts.length;e<s;e++){const i=this.scripts[e];i._initialized&&!i._postInitialized&&i.enabled&&(i._postInitialized=!0,i.postInitialize&&this._scriptMethod(i,qe.scriptMethods.postInitialize))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let s=0,i=this.scripts.length;s<i;s++){const n=this.scripts[s];n.enabled=n._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let e=0;e<this.scripts.length;e++){const s=this.scripts[e];!s||this.destroy(s.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(!!t){for(let e=0;e<t;e++){const s=this._destroyedScripts[e];this._removeScriptInstance(s)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let s=0,i=t.length;s<i;s++){const n=t[s];!n._initialized&&n.enabled&&(n._initialized=!0,n.initialize&&this._scriptMethod(n,qe.scriptMethods.initialize))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const i=e.items[e.loopIndex];i.enabled&&this._scriptMethod(i,qe.scriptMethods.update,t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const i=e.items[e.loopIndex];i.enabled&&this._scriptMethod(i,qe.scriptMethods.postUpdate,t)}this._endLooping(s)}_insertScriptInstance(t,e,s){e===-1?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return e===-1||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,i,n,r){if(t.array){const a=s.length;if(!a)return;const l=s.slice();for(let h=0;h<a;h++){const c=l[h]instanceof pt?l[h].getGuid():l[h];r[c]&&(l[h]=i?r[c].getGuid():r[c])}n[e]=l}else{if(s instanceof pt)s=s.getGuid();else if(typeof s!="string")return;r[s]&&(n[e]=r[s])}}has(t){if(typeof t=="string")return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof e}get(t){if(typeof t=="string"){const r=this._scriptsIndex[t];return r?r.instance:null}if(!t)return null;const e=t,s=e.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof e?n:null}create(t,e={}){const s=this;let i=t,n=t;if(typeof i=="string"?i=this.system.app.scripts.get(i):i&&(n=i.__name),i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const r=new i({app:this.system.app,entity:this.entity,enabled:e.hasOwnProperty("enabled")?e.enabled:!0,attributes:e.attributes}),a=this._scripts.length;let l=-1;return typeof e.ind=="number"&&e.ind!==-1&&a>e.ind&&(l=e.ind),this._insertScriptInstance(r,l,a),this._scriptsIndex[n]={instance:r,onSwap:function(){s.swap(n)}},this[n]=r,e.preloading||r.__initializeAttributes(),this.fire("create",n,r),this.fire("create:"+n,r),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),e.preloading||(r.enabled&&!r._initialized&&(r._initialized=!0,r.initialize&&this._scriptMethod(r,qe.scriptMethods.initialize)),r.enabled&&!r._postInitialized&&(r._postInitialized=!0,r.postInitialize&&this._scriptMethod(r,qe.scriptMethods.postInitialize))),r}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(t){let e=t,s=t;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!i)return!1;const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const r=this._removeScriptInstance(n);r>=0&&this._resetExecutionOrder(r,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,i.onSwap),delete this[e],this.fire("destroy",e,n||null),this.fire("destroy:"+e,n||null),n&&n.fire("destroy"),!0}swap(t){let e=t,s=t;typeof s=="string"?s=this.system.app.scripts.get(s):s&&(e=s.__name);const i=this._scriptsIndex[e];if(!i||!i.instance)return!1;const n=i.instance,r=this._scripts.indexOf(n),a=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return a.swap?(a.__initializeAttributes(),this._scripts[r]=a,this._scriptsIndex[e].instance=a,this[e]=a,a.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,qe.scriptMethods.swap,n),this.fire("swap",e,a),this.fire("swap:"+e,a),!0):!1}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const i in t._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const r=t._scriptsIndex[i];if(!r||!r.instance)continue;const a=s[i].__attributesRaw,l=s[i].__attributes;if(!a&&!l)continue;const h=!!a,c=r.instance.__attributes;for(const d in c){if(!c[d])continue;const u=n.attributes.get(d);if(!!u){if(u.type==="entity")this._resolveEntityScriptAttribute(u,d,c[d],h,a||l,e);else if(u.type==="json"&&Array.isArray(u.schema)){const f=c[d],m=a?a[d]:l[d];for(let p=0;p<u.schema.length;p++){const _=u.schema[p];if(_.type==="entity")if(u.array)for(let g=0;g<f.length;g++)this._resolveEntityScriptAttribute(_,_.name,f[g][_.name],h,m[g],e);else this._resolveEntityScriptAttribute(_,_.name,f[_.name],h,m,e)}}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let i=t,n=t;typeof n!="string"?n=t.__name:i=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const a=r.instance;if(i&&!(a instanceof i))return!1;const l=this._scripts.indexOf(a);return l===-1||l===e?!1:(this._scripts.splice(e,0,this._scripts.splice(l,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,a,e,l),this.fire("move:"+n,a,e,l),!0)}}qe.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};const IC=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*");class LC extends at{constructor(t){super();this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__attributes=void 0,this.__attributesRaw=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScriptType(t)}set enabled(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,qe.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,qe.scriptMethods.postInitialize)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScriptType(t){const e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled=typeof t.enabled=="boolean"?t.enabled:!0,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=t.attributes||{},this.__scriptType=e,this.__executionOrder=-1}static __getScriptName(t){if(typeof t!="function")return;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";const e=(""+t).match(IC);return e?e[1]:void 0}static get scriptName(){return this.__name}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new En(this)),this.__attributes}__initializeAttributes(t){if(!(!t&&!this.__attributesRaw)){for(const e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null}}static extend(t){for(const e in t)!t.hasOwnProperty(e)||(this.prototype[e]=t[e])}}LC.__name=null;class DC extends at{constructor(t){super();this.app=t,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout(()=>{if(t.prototype.swap){const s=this._scripts[e],i=this._list.indexOf(s);this._list[i]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire("swap:"+e,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)}),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire("add:"+e,t),setTimeout(()=>{if(!this._scripts.hasOwnProperty(e)||!this.app||!this.app.systems||!this.app.systems.script)return;const s=this.app.systems.script._components;let i;const n=[],r=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){const a=s.items[s.loopIndex];if(a._scriptsIndex[e]&&a._scriptsIndex[e].awaiting){a._scriptsData&&a._scriptsData[e]&&(i=a._scriptsData[e].attributes);const l=a.create(e,{preloading:!0,ind:a._scriptsIndex[e].ind,attributes:i});l&&n.push(l)}}for(let a=0;a<n.length;a++)n[a].__initializeAttributes();for(let a=0;a<n.length;a++)n[a].enabled&&(n[a]._initialized=!0,r.push(n[a]),n[a].initialize&&n[a].initialize());for(let a=0;a<r.length;a++)!r[a].enabled||r[a]._postInitialized||(r[a]._postInitialized=!0,r[a].postInitialize&&r[a].postInitialize())}),!0)}remove(t){let e=t,s=t;if(typeof s!="string"?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",s,e),this.fire("remove:"+s,e),!0}get(t){return this._scripts[t]||null}has(t){if(typeof t=="string")return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}class FC{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(t.header.version!==1)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(t.data){if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array')}else throw new Error('pc.I18n#addData: Missing "data" field');for(let e=0,s=t.data.length;e<s;e++){const i=t.data[e];if(!i.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!i.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if(typeof i.info.locale!="string")throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!i.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class OC extends at{constructor(t){super();this.locale=$o,this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new FC}set assets(t){const e={};for(let i=0,n=t.length;i<n;i++){const r=t[i]instanceof rt?t[i].id:t[i];e[r]=!0}let s=this._assets.length;for(;s--;){const i=this._assets[s];if(!e[i]){this._app.assets.off("add:"+i,this._onAssetAdd,this);const n=this._app.assets.get(i);n&&this._onAssetRemove(n),this._assets.splice(s,1)}}for(const i in e){const n=parseInt(i,10);if(this._assets.indexOf(n)!==-1)continue;this._assets.push(n);const r=this._app.assets.get(n);r?this._onAssetAdd(r):this._app.assets.once("add:"+n,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(t){if(this._locale===t)return;let e=Ws(t);if(e==="in"&&(e="id",t=Cw(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=kc(this._lang),this.fire("set:locale",t,s)}get locale(){return this._locale}static findAvailableLocale(t,e){return Im(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=Ws(t);return this._findFallbackLocale(t,e)}getText(t,e){let s=t,i;e||(e=this._locale,i=this._lang);let n=this._translations[e];return n||(i||(i=Ws(e)),e=this._findFallbackLocale(e,i),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(s=n[t],Array.isArray(s)&&(s=s[0]),s==null&&(s=t)),s}getPluralText(t,e,s){let i=t,n,r;s?(n=Ws(s),r=kc(n)):(s=this._locale,n=this._lang,r=this._pluralFn);let a=this._translations[s];if(a||(s=this._findFallbackLocale(s,n),n=Ws(s),r=kc(n),a=this._translations[s]),a&&a[t]&&r){const l=r(e);i=a[t][l],i==null&&(i=t)}return i}addData(t){let e;try{e=this._parser.parse(t)}catch(s){console.error(s);return}for(let s=0,i=e.length;s<i;s++){const n=e[s],r=n.info.locale,a=n.messages;if(!this._translations[r]){this._translations[r]={};const l=Ws(r);this._availableLangs[l]||(this._availableLangs[l]=r)}Object.assign(this._translations[r],a),this.fire("data:add",r,a)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(s){console.error(s);return}for(let s=0,i=e.length;s<i;s++){const n=e[s],r=n.info.locale,a=this._translations[r];if(!a)continue;const l=n.messages;for(const h in l)delete a[h];Object.keys(a).length===0&&(delete this._translations[r],delete this._availableLangs[Ws(r)]),this.fire("data:remove",r,l)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(t,e){let s=Ko[t];return s&&this._translations[s]||(s=Ko[e],s&&this._translations[s])||(s=this._availableLangs[e],s&&this._translations[s])?s:$o}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once("add:"+t.id,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}const Qm="FILL_WINDOW",tp="KEEP_ASPECT",cl="AUTO",BC="FIXED";class kC extends at{constructor(t,e){super();this.id=void 0,this.display=void 0,this.presenting=!1,this._app=t,this._device=t.graphicsDevice,this.id=e.displayId,this._frameData=null,window.VRFrameData&&(this._frameData=new window.VRFrameData),this.display=e,this._camera=null,this.sitToStandInv=new G,this.leftView=new G,this.leftProj=new G,this.leftViewInv=new G,this.leftPos=new y,this.rightView=new G,this.rightProj=new G,this.rightViewInv=new G,this.rightPos=new y,this.combinedPos=new y,this.combinedView=new G,this.combinedProj=new G,this.combinedViewInv=new G,this.combinedFov=0,this.combinedAspect=0,this._presentChange=s=>{let i;if(s.display?i=s.display:s.detail&&s.detail.display?i=s.detail.display:s.detail&&s.detail.vrdisplay?i=s.detail.vrdisplay:i=this.display,i===this.display){if(this.presenting=this.display&&this.display.isPresenting,this.presenting){const n=this.display.getEyeParameters("left"),r=this.display.getEyeParameters("right"),a=Math.max(n.renderWidth,r.renderWidth)*2,l=Math.max(n.renderHeight,r.renderHeight);this._app.graphicsDevice.setResolution(a,l),this._app._allowResize=!1}else this._app.setCanvasResolution(cl),this._app._allowResize=!0;this.fire("beforepresentchange",this),this.fire("presentchange",this)}},window.addEventListener("vrdisplaypresentchange",this._presentChange,!1)}destroy(){window.removeEventListener("vrdisplaypresentchange",this._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null}poll(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;const t=this.display.stageParameters;t?(this.sitToStandInv.set(t.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));let e=this.leftProj.data[3]+this.leftProj.data[0],s=this.leftProj.data[11]+this.leftProj.data[8],i=1/Math.sqrt(e*e+s*s);e*=i,s*=i;let n=-Math.atan2(s,e);e=this.rightProj.data[3]+this.rightProj.data[0],s=this.rightProj.data[11]+this.rightProj.data[8],i=1/Math.sqrt(e*e+s*s),e*=i,s*=i,n=Math.max(n,-Math.atan2(s,e)),n*=2,this.combinedFov=n;const r=this.rightProj.data[5]/this.rightProj.data[0];this.combinedAspect=r;const a=this.combinedView;a.copy(this.leftView),a.invert(),this.leftViewInv.copy(a);const l=this.combinedPos;l.x=this.leftPos.x=a.data[12],l.y=this.leftPos.y=a.data[13],l.z=this.leftPos.z=a.data[14],a.copy(this.rightView),a.invert(),this.rightViewInv.copy(a);const h=l.x-a.data[12],c=l.y-a.data[13],d=l.z-a.data[14],u=Math.sqrt(h*h+c*c+d*d);this.rightPos.x=a.data[12],this.rightPos.y=a.data[13],this.rightPos.z=a.data[14],l.x+=a.data[12],l.y+=a.data[13],l.z+=a.data[14],l.x*=.5,l.y*=.5,l.z*=.5;const f=Math.PI*.5,m=n*.5,p=Math.PI-(f+m),_=u*.5*Math.sin(p),g=a.data[8],w=a.data[9],v=a.data[10];a.data[12]=l.x+g*_,a.data[13]=l.y+w*_,a.data[14]=l.z+v*_,this.combinedViewInv.copy(a),a.invert(),this.combinedProj.setPerspective(n*U.RAD_TO_DEG,r,this.display.depthNear+_,this.display.depthFar+_,!0)}}requestPresent(t){if(!this.display){t&&t(new Error("No VrDisplay to requestPresent"));return}if(this.presenting){t&&t(new Error("VrDisplay already presenting"));return}this.display.requestPresent([{source:this._device.canvas}]).then(function(){t&&t()},function(e){t&&t(e)})}exitPresent(t){if(this.display||t&&t(new Error("No VrDisplay to exitPresent")),!this.presenting){t&&t(new Error("VrDisplay not presenting"));return}this.display.exitPresent().then(function(){t&&t()},function(){t&&t(new Error("exitPresent failed"))})}requestAnimationFrame(t){this.display&&this.display.requestAnimationFrame(t)}submitFrame(){this.display&&this.display.submitFrame()}reset(){this.display&&this.display.resetPose()}setClipPlanes(t,e){this.display&&(this.display.depthNear=t,this.display.depthFar=e)}getFrameData(){if(this.display)return this._frameData}get capabilities(){return this.display?this.display.capabilities:{}}}class dl extends at{constructor(t){super();this.displays=[],this.display=null,this.isSupported=void 0,this._index={},this._app=t,this.isSupported=dl.isSupported,this._onDisplayConnect=this._onDisplayConnect.bind(this),this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this),this._attach(),this._getDisplays((e,s)=>{if(e)this.fire("error",e);else{for(let i=0;i<s.length;i++)this._addDisplay(s[i]);this.fire("ready",this.displays)}})}_attach(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)}_detach(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)}destroy(){this._detach()}poll(){const t=this.displays.length;if(!!t)for(let e=0;e<t;e++)this.displays[e]._camera&&this.displays[e].poll()}_getDisplays(t){navigator.getVRDisplays?navigator.getVRDisplays().then(function(e){t&&t(null,e)}):t&&t(new Error("WebVR not supported"))}_addDisplay(t){if(this._index[t.displayId])return;const e=new kC(this._app,t);this._index[e.id]=e,this.displays.push(e),this.display||(this.display=e),this.fire("displayconnect",e)}_onDisplayConnect(t){t.detail&&t.detail.display?this._addDisplay(t.detail.display):this._addDisplay(t.display)}_onDisplayDisconnect(t){let e;t.detail&&t.detail.display?e=t.detail.display.displayId:e=t.display.displayId;const s=this._index[e];if(!s)return;s.destroy(),delete this._index[s.id];const i=this.displays.indexOf(s);this.displays.splice(i,1),this.display===s&&(this.displays.length?this.display=this.displays[0]:this.display=null),this.fire("displaydisconnect",s)}}dl.isSupported=typeof navigator!="undefined"?!!navigator.getVRDisplays:!1;const zC="inline",ep="immersive-vr",Rn="immersive-ar",UC="viewer",NC="left",sp="cpu-optimized",VC="gpu-optimized",WC="luminance-alpha",ip=[],np=[];class GC extends at{constructor(t,e,s){super();this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this.manager=t,this._xrHitTestSource=e,this._transient=s}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);e!==-1&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let s=0;s<e.length;s++){const i=e[s];let n;i.inputSource&&(n=this.manager.input._getByInputSource(i.inputSource)),this.updateHitResults(i.results,n)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))}updateHitResults(t,e){for(let s=0;s<t.length;s++){const i=t[s].getPose(this.manager._referenceSpace);let n=ip.pop();n||(n=new y),n.copy(i.transform.position);let r=np.pop();r||(r=new tt),r.copy(i.transform.orientation),this.fire("result",n,r,e),this.manager.hitTest.fire("result",this,n,r,e),ip.push(n),np.push(r)}}}class HC extends at{constructor(t){super();this.manager=void 0,this._supported=Dt.browser&&!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this.manager.type===Rn&&(this._session=this.manager.session)}_onSessionEnd(){if(!!this._session){this._session=null;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]}}isAvailable(t,e){let s;return this._supported||(s=new Error("XR HitTest is not supported")),this._session||(s=new Error("XR Session is not started (1)")),this.manager.type!==Rn&&(s=new Error("XR HitTest is available only for AR")),s?(t&&t(s),e&&e.fire("error",s),!1):!0}start(t={}){if(!this.isAvailable(t.callback,this))return;!t.profile&&!t.spaceType&&(t.spaceType=UC);let e;const s=t.offsetRay;s&&(e=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z),new DOMPoint(s.direction.x,s.direction.y,s.direction.z)));const i=t.callback;t.spaceType?this._session.requestReferenceSpace(t.spaceType).then(n=>{if(!this._session){const r=new Error("XR Session is not started (2)");i&&i(r),this.fire("error",r);return}this._session.requestHitTestSource({space:n,entityTypes:t.entityTypes||void 0,offsetRay:e}).then(r=>{this._onHitTestSource(r,!1,i)}).catch(r=>{i&&i(r),this.fire("error",r)})}).catch(n=>{i&&i(n),this.fire("error",n)}):this._session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then(n=>{this._onHitTestSource(n,!0,i)}).catch(n=>{i&&i(n),this.fire("error",n)})}_onHitTestSource(t,e,s){if(!this._session){t.cancel();const n=new Error("XR Session is not started (3)");s&&s(n),this.fire("error",n);return}const i=new GC(this.manager,t,e);this.sources.push(i),s&&s(null,i),this.fire("add",i)}update(t){for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}}class XC{constructor(t,e){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=t,this._hand=e,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const rp=Dt.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],ap={};for(let o=0;o<rp.length;o++)ap[rp[o]]=!0;class op{constructor(t,e,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new G,this._worldTransform=new G,this._localPosition=new y,this._localRotation=new tt,this._position=new y,this._rotation=new tt,this._dirtyLocal=!0,this._index=t,this._id=e,this._hand=s,this._finger=i,this._wrist=e==="wrist",this._tip=this._finger&&!!ap[e]}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,y.ONE));const e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let ul=[];const Xi=new y,fl=new y,lp=new y;Dt.browser&&window.XRHand&&(ul=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class jC extends at{constructor(t){super();this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,e.get("wrist")){const s=new op(0,"wrist",this,null);this._wrist=s,this._joints.push(s),this._jointsById.wrist=s}for(let s=0;s<ul.length;s++){const i=new XC(s,this);for(let n=0;n<ul[s].length;n++){const r=ul[s][n];if(!e.get(r))continue;const a=new op(n,r,this,i);this._joints.push(a),this._jointsById[r]=a,a.tip&&(this._tips.push(a),i._tip=a),i._joints.push(a)}}}update(t){const e=this._inputSource._xrInputSource;for(let c=0;c<this._joints.length;c++){const d=this._joints[c],u=e.hand.get(d._id);if(u){let f;if(t.session.visibilityState!=="hidden"&&(f=t.getJointPose(u,this._manager._referenceSpace)),f)d.update(f),d.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(d.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],l=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&l){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let c=s,d=l;if(this._inputSource.handedness===NC){const u=c;c=d,d=u}Xi.sub2(c._localPosition,this._wrist._localPosition),fl.sub2(d._localPosition,this._wrist._localPosition),lp.cross(Xi,fl).normalize(),Xi.lerp(n._localPosition,a._localPosition,.5),Xi.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(lp,Xi,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return Xi.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),fl.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),Xi.dot(fl)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const hp=new tt;let qC=0;class ml extends at{constructor(t,e){super();this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new hn,this._rayLocal=new hn,this._grip=!1,this._hand=null,this._localTransform=null,this._worldTransform=null,this._position=new y,this._rotation=new tt,this._localPosition=null,this._localRotation=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++qC,this._manager=t,this._xrInputSource=e,e.hand&&(this._hand=new jC(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){const s=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);s&&(this._grip||(this._grip=!0,this._localTransform=new G,this._worldTransform=new G,this._localPosition=new y,this._localRotation=new tt),this._dirtyLocal=!0,this._localPosition.copy(s.transform.position),this._localRotation.copy(s.transform.orientation))}const e=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);e&&(this._dirtyRay=!0,this._rayLocal.origin.copy(e.transform.position),this._rayLocal.direction.set(0,0,-1),hp.copy(e.transform.orientation),hp.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,y.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;if(this._dirtyRay=!1,this._manager.camera.parent){const s=this._manager.camera.parent.getWorldTransform();s.getTranslation(this._position),this._rotation.setFromMat4(s),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(s,i)=>{i&&this.onHitTestSourceAdd(i),e&&e(s,i)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",function(e,s,i){i===this&&this.fire("hittest:result",t,e,s)},this),t.once("remove",function(){this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)},this)}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);e!==-1&&this._hitTestSources.splice(e,1)}}class YC extends at{constructor(t){super();this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.manager=t,this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const t=this.manager.session;t.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),t.addEventListener("select",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("select",s),this.fire("select",i,s)}),t.addEventListener("selectstart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!0,i.fire("selectstart",s),this.fire("selectstart",i,s)}),t.addEventListener("selectend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._selecting=!1,i.fire("selectend",s),this.fire("selectend",i,s)}),t.addEventListener("squeeze",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i.fire("squeeze",s),this.fire("squeeze",i,s)}),t.addEventListener("squeezestart",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!0,i.fire("squeezestart",s),this.fire("squeezestart",i,s)}),t.addEventListener("squeezeend",s=>{const i=this._getByInputSource(s.inputSource);i.update(s.frame),i._squeezing=!1,i.fire("squeezeend",s),this.fire("squeezeend",i,s)});const e=t.inputSources;for(let s=0;s<e.length;s++)this._addInputSource(e[s])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const s=this._inputSources[t];this._inputSources.splice(t,1),s.fire("remove"),this.fire("remove",s)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new ml(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();s.fire("remove"),this.fire("remove",s);return}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const In=new y,cp=new y,Qc=new G,dp=new G;class $C extends at{constructor(t){super();this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new tt,this._color=new j,this._sphericalHarmonics=new Float32Array(27),this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!this._manager.session.requestLightProbe||(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;if(this._manager.session||(t=new Error("XR session is not running")),!t&&this._manager.type!==Rn&&(t=new Error("XR session type is not AR")),!t&&!this._supported&&(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t){this.fire("error",t);return}this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(e=>{const s=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?s&&(this._lightProbe=e):this.fire("error",new Error("XR session is not active"))}).catch(e=>{this._lightProbeRequested=!1,this.fire("error",e)})}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),In.copy(s).mulScalar(1/this._intensity),this._color.set(In.x,In.y,In.z),In.set(0,0,0),cp.copy(e.primaryLightDirection),Qc.setLookAt(cp,In,y.UP),dp.setFromAxisAngle(y.RIGHT,90),Qc.mul(dp),this._rotation.setFromMat4(Qc),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}class KC extends at{constructor(t,e){super();this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new y,this._rotation=new tt,this._image=t,this._width=e}get image(){return this._image}set width(t){this._width=t}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class ZC extends at{constructor(t){super();this._manager=void 0,this._supported=Dt.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new KC(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);e!==-1&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then(t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable=t[e]==="trackable"}).catch(t=>{this._available=!1,this.fire("error",t)})}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++){const e=this._images[t];e._pose=null,e._measuredWidth=0,e._tracking&&(e._tracking=!1,e.fire("untracked"))}}prepareImages(t){this._images.length?Promise.all(this._images.map(function(e){return e.prepare()})).then(function(e){t(null,e)}).catch(function(e){t(e,null)}):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let i=0;i<e.length;i++){s[e[i].index]=e[i];const n=this._images[e[i].index];n._emulated=e[i].trackingState==="emulated",n._measuredWidth=e[i].measuredWidthInMeters,n._pose=t.getPose(e[i].imageSpace,this._manager._referenceSpace)}for(let i=0;i<this._images.length;i++)this._images[i]._tracking&&!s[i]?(this._images[i]._tracking=!1,this._images[i].fire("untracked")):!this._images[i]._tracking&&s[i]&&(this._images[i]._tracking=!0,this._images[i].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class JC{constructor(t){this._manager=void 0,this._supported=Dt.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=t}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}get state(){return!this._supported||!this._manager.active||!this._manager._session.domOverlayState?null:this._manager._session.domOverlayState.type}set root(t){!this._supported||this._manager.active||(this._root=t)}get root(){return this._root}}class QC extends at{constructor(t){super();this._manager=void 0,this._available=!1,this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._matrixDirty=!1,this._matrix=new G,this._emptyBuffer=new Uint8Array(32),this._depthBuffer=null,this._texture=void 0,this._manager=t,this._texture=new nt(this._manager.app.graphicsDevice,{format:Ka,mipmaps:!1,addressU:et,addressV:et,minFilter:Yt,magFilter:Yt}),this.supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const t=this._manager.session;try{this._usage=t.depthUsage,this._dataFormat=t.depthDataFormat}catch(e){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",e)}}_onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()}_updateTexture(){const t=this._depthInfoCpu||this._depthInfoGpu;if(t){let e=!1;if((t.width!==this._texture.width||t.height!==this._texture.height)&&(this._texture._width=t.width,this._texture._height=t.height,this._matrixDirty=!0,e=!0),this._depthInfoCpu){const s=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(s),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());e&&this.fire("resize",t.width,t.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())}update(t,e){if(!this._usage)return;let s=null,i=null;if(this._usage===sp&&e?s=t.getDepthInformation(e):this._usage===VC&&e&&(i=t.getDepthInformation(e)),(this._depthInfoCpu&&!s||!this._depthInfoCpu&&s||this.depthInfoGpu&&!i||!this._depthInfoGpu&&i)&&(this._matrixDirty=!0),this._depthInfoCpu=s,this._depthInfoGpu=i,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;const n=this._depthInfoCpu||this._depthInfoGpu;n?this._matrix.data.set(n.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}(this._depthInfoCpu||this._depthInfoGpu)&&!this._available?(this._available=!0,this.fire("available")):!this._depthInfoCpu&&!this._depthInfoGpu&&this._available&&(this._available=!1,this.fire("unavailable"))}getDepth(t,e){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(t,e):null}get supported(){return Dt.browser&&!!window.XRDepthInformation}get available(){return this._available}get usage(){return this._usage}get dataFormat(){return this._dataFormat}get width(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.width||0}get height(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.height||0}get texture(){return this._texture}get uvMatrix(){return this._matrix}get rawValueToMeters(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.rawValueToMeters||0}}let tA=0;class eA extends at{constructor(t,e){super();this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new y,this._rotation=new tt,this._id=++tA,this._planeDetection=t,this._xrPlane=e,this._lastChangedTime=e.lastChangedTime,this._orientation=e.orientation}destroy(){this.fire("remove")}update(t){const e=this._planeDetection._manager,s=t.getPose(this._xrPlane.planeSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}}class sA extends at{constructor(t){super();this._manager=void 0,this._supported=Dt.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=null,this._manager=t,this._supported&&this._manager.on("end",this._onSessionEnd,this)}_onSessionEnd(){if(this._planes)for(let t=0;t<this._planes.length;t++)this._planes[t].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){let e;if(this._available)e=t.detectedPlanes;else try{e=t.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch{return}for(const[s,i]of this._planesIndex)e.has(s)||(this._planesIndex.delete(s),this._planes.splice(this._planes.indexOf(i),1),i.destroy(),this.fire("remove",i));for(const s of e){let i=this._planesIndex.get(s);i?i.update(t):(i=new eA(this,s),this._planesIndex.set(s,i),this._planes.push(i),i.update(t),this.fire("add",i))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class iA extends at{constructor(t){super();this.app=void 0,this._supported=Dt.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new y,this._localRotation=new tt,this._depthNear=.1,this._depthFar=1e3,this._width=0,this._height=0,this.app=t,this._available[zC]=!1,this._available[ep]=!1,this._available[Rn]=!1,this.depthSensing=new QC(this),this.domOverlay=new JC(this),this.hitTest=new HC(this),this.imageTracking=new ZC(this),this.planeDetection=new sA(this),this.input=new YC(this),this.lightEstimation=new $C(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck())}start(t,e,s,i){let n=i;if(typeof i=="object"&&(n=i.callback),!this._available[e]){n&&n(new Error("XR is not available"));return}if(this._session){n&&n(new Error("XR session is already started"));return}this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._setClipPlanes(t.nearClip,t.farClip);const r={requiredFeatures:[s],optionalFeatures:[]};if(e===Rn){if(r.optionalFeatures.push("light-estimation"),r.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&r.optionalFeatures.push("image-tracking"),i.planeDetection&&r.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(r.optionalFeatures.push("dom-overlay"),r.domOverlay={root:this.domOverlay.root}),i&&i.depthSensing&&this.depthSensing.supported){r.optionalFeatures.push("depth-sensing");const a=[sp],l=[WC];if(i.depthSensing.usagePreference){const h=a.indexOf(i.depthSensing.usagePreference);h!==-1&&a.splice(h,1),a.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const h=l.indexOf(i.depthSensing.dataFormatPreference);h!==-1&&l.splice(h,1),l.unshift(i.depthSensing.dataFormatPreference)}r.depthSensing={usagePreference:a,dataFormatPreference:l}}}else e===ep&&r.optionalFeatures.push("hand-tracking");i&&i.optionalFeatures&&(r.optionalFeatures=r.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((a,l)=>{if(a){n&&n(a),this.fire("error",a);return}l!==null&&(r.trackedImages=l),this._onStartOptionsReady(e,s,r,n)}):this._onStartOptionsReady(e,s,r,n)}_onStartOptionsReady(t,e,s,i){navigator.xr.requestSession(t,s).then(n=>{this._onSessionStart(n,e,i)}).catch(n=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(n),this.fire("error",n)})}end(t){if(!this._session){t&&t(new Error("XR Session is not initialized"));return}t&&this.once("end",t),this._session.end()}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}_sessionSupportCheck(t){navigator.xr.isSessionSupported(t).then(e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire("available:"+t,e))}).catch(e=>{this.fire("error",e)})}_onSessionStart(t,e,s){let i=!1;this._session=t;const n=()=>{this.fire("visibility:change",t.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",a),t.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this.views=[],this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.tick()};t.addEventListener("end",a),t.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl,{alpha:!0,depth:!0,stencil:!0}),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then(l=>{this._referenceSpace=l,this.app.tick(),s&&s(null),this.fire("start")}).catch(l=>{i=!0,t.end(),s&&s(l),this.fire("error",l)})}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,!!this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}update(t){if(!this._session)return;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;(this._width!==e||this._height!==s)&&(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const i=t.getViewerPose(this._referenceSpace),n=i?i.views.length:0;if(n>this.views.length)for(let r=0;r<=n-this.views.length;r++){let a=this.viewsPool.pop();a||(a={viewport:new Z,projMat:new G,viewMat:new G,viewOffMat:new G,viewInvMat:new G,viewInvOffMat:new G,projViewOffMat:new G,viewMat3:new Qt,position:new Float32Array(3),rotation:new tt}),this.views.push(a)}else if(n<=this.views.length)for(let r=0;r<this.views.length-n;r++)this.viewsPool.push(this.views.pop());if(i){const r=i.transform.position,a=i.transform.orientation;this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w);const l=t.session.renderState.baseLayer;for(let h=0;h<i.views.length;h++){const c=i.views[h],d=this.views[h],u=l.getViewport(c);d.viewport.x=u.x,d.viewport.y=u.y,d.viewport.z=u.width,d.viewport.w=u.height,d.projMat.set(c.projectionMatrix),d.viewMat.set(c.transform.inverse.matrix),d.viewInvMat.set(c.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===Rn&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.depthSensing.supported&&this.depthSensing.update(t,i&&i.views[0]),this.imageTracking.supported&&this.imageTracking.update(t),this.planeDetection.supported&&this.planeDetection.update(t)),this.fire("update",t)}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}class Bt extends at{constructor(t){super();this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),i=new this.DataType;return this.store[t.getGuid()]={entity:t,data:i},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),s}removeComponent(t){const e=this.store[t.getGuid()],s=t.c[this.id];this.fire("beforeremove",t,s),delete this.store[t.getGuid()],t[this.id]=void 0,delete t.c[this.id],this.fire("remove",t,e.data)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let i=0,n=s.length;i<n;i++){const r=s[i];let a,l;typeof r=="object"?(a=r.name,l=r.type):(a=r,l=void 0);let h=e[a];h!==void 0?(l!==void 0&&(h=nA(h,l)),t[a]=h):t[a]=t.data[a]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach(function(i){i&&typeof i=="object"&&i.type===t&&e.push(i)}),e}destroy(){this.off()}}function nA(o,t){if(!o)return o;switch(t){case"rgb":return o instanceof j?o.clone():new j(o[0],o[1],o[2]);case"rgba":return o instanceof j?o.clone():new j(o[0],o[1],o[2],o[3]);case"vec2":return o instanceof H?o.clone():new H(o[0],o[1]);case"vec3":return o instanceof y?o.clone():new y(o[0],o[1],o[2]);case"vec4":return o instanceof Z?o.clone():new Z(o[0],o[1],o[2],o[3]);case"boolean":case"number":case"string":return o;case"entity":return o;default:throw new Error("Could not convert unhandled type: "+t)}}class rA{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(!s)this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0;else if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const i=this._findKey(t,e);this._left=e[i],this._right=e[i+1],this._len=this._right-this._left;const n=1/this._len;this._recip=isFinite(n)?n:0,this._p0=i,this._p1=i+1}}this._t=this._recip===0?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const i=s._data,n=s._components,r=this._p0*n;if(e===Rm)for(let a=0;a<n;++a)t[a]=i[r+a];else{const a=this._t,l=this._p1*n;switch(e){case Fc:for(let h=0;h<n;++h)t[h]=U.lerp(i[r+h],i[l+h],a);break;case Oc:{const h=this._hermite;if(!h.valid){const m=a*a,p=a+a,_=1-a,g=_*_;h.valid=!0,h.p0=(1+p)*g,h.m0=a*g,h.p1=m*(3-p),h.m1=m*(a-1)}const c=(this._p0*3+1)*n,d=(this._p0*3+2)*n,u=(this._p1*3+1)*n,f=(this._p1*3+0)*n;for(let m=0;m<n;++m)t[m]=h.p0*i[c+m]+h.m0*i[d+m]*this._len+h.p1*i[u+m]+h.m1*i[f+m]*this._len;break}}}}}class aA{constructor(t){this._name=t.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let i=0;i<t._inputs.length;++i)this._cache[i]=new rA;const e=t._curves,s=t._outputs;for(let i=0;i<e.length;++i){const n=e[i],r=s[n._output],a=[];for(let l=0;l<r._components;++l)a[l]=0;this._results[i]=a}}}class up{constructor(t,e,s,i,n,r){for(this._name=t.name,this._track=t,this._snapshot=new aA(t),this._playing=i,this._time=e,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this._eventCursor=0;this._track.events[this._eventCursor]&&this._track.events[this._eventCursor].time<this.time;)this._eventCursor++}set name(t){this._name=t}get name(){return this._name}get track(){return this._track}get snapshot(){return this._snapshot}set time(t){this._time=t}get time(){return this._time}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}set blendWeight(t){this._blendWeight=t}get blendWeight(){return this._blendWeight}set blendOrder(t){this._blendOrder=t}get blendOrder(){return this._blendOrder}set eventCursor(t){this._eventCursor=t}get eventCursor(){return this._eventCursor}activeEventsForFrame(t,e){t===0&&(this.eventCursor=0);let s;for(e>this.track.duration&&(s=e-this.track.duration,e=this.track.duration);this.track.events[this.eventCursor]&&this.track.events[this.eventCursor].time>=t&&(e===this.track.duration?this.track.events[this.eventCursor].time<=e:this.track.events[this.eventCursor].time<e);){const i=this.track.events[this.eventCursor];this._eventHandler.fire(i.name,Pn({track:this.track},i)),this.eventCursor++}Number.isFinite(s)&&this.activeEventsForFrame(0,s)}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+i*t),e+=i*t,i>=0?e>s&&(n?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(n?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}const fp="NONE",oA="PREV_STATE",lA="NEXT_STATE",hA="PREV_STATE_NEXT_STATE",cA="NEXT_STATE_PREV_STATE",dA="GREATER_THAN",uA="LESS_THAN",fA="GREATER_THAN_EQUAL_TO",mA="LESS_THAN_EQUAL_TO",pA="EQUAL_TO",_A="NOT_EQUAL_TO",mp="INTEGER",pp="FLOAT",_p="BOOLEAN",pl="TRIGGER",gA="1D",yA="2D_DIRECTIONAL",xA="2D_CARTESIAN",vA="DIRECT",Ln="START",_l="END",ji="ANY",gl=[Ln,_l,ji],gp="OVERWRITE",SA="ADDITIVE";class Rt{constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=[0,0,0,1],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(t){return this.dirty&&this.updateWeights(),this._normalizeWeights&&this.totalWeight===0||!this.mask[t]?0:this._normalizeWeights?this.weights[t]/this.totalWeight:U.clamp(this.weights[t],0,1)}_layerBlendType(t){return this._component.layers[t].blendType}setMask(t,e){this.mask[t]=e,this._normalizeWeights&&(this._component.layers[t].blendType===gp&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){if(this.counter===0&&(Jt._set(this.value,Rt.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Jt._blend(this.value,this.baseValue,1,this.valueType)),!(!this.mask[t]||this.getWeight(t)===0)){if(this._layerBlendType(t)===SA&&!this._normalizeWeights)if(this.valueType===Rt.TYPE_QUAT){const s=Rt.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=Rt.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=Rt.q3.set(e[0],e[1],e[2],e[3]),r=i.invert().mul(n);r.slerp(tt.IDENTITY,r,this.getWeight(t)),s.mul(r),Rt.quatArr[0]=s.x,Rt.quatArr[1]=s.y,Rt.quatArr[2]=s.z,Rt.quatArr[3]=s.w,Jt._set(this.value,Rt.quatArr,this.valueType)}else Rt.vecArr[0]=e[0]-this.baseValue[0],Rt.vecArr[1]=e[1]-this.baseValue[1],Rt.vecArr[2]=e[2]-this.baseValue[2],Jt._blend(this.value,Rt.vecArr,this.getWeight(t),this.valueType,!0);else Jt._blend(this.value,e,this.getWeight(t),this.valueType);this.setter(this.value)}}unbind(){this._normalizeWeights||this.setter(this.baseValue)}}Rt.TYPE_QUAT="quaternion";Rt.TYPE_VEC3="vector3";Rt.q1=new tt;Rt.q2=new tt;Rt.q3=new tt;Rt.quatArr=[0,0,0,1];Rt.vecArr=[0,0,0];Rt.IDENTITY_QUAT_ARR=[0,0,0,1];class Jt{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}static _dot(t,e){const s=t.length;let i=0;for(let n=0;n<s;++n)i+=t[n]*e[n];return i}static _normalize(t){let e=Jt._dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let i=0;i<s;++i)t[i]*=e}}static _set(t,e,s){const i=t.length;if(s==="quaternion"){let n=Jt._dot(e,e);n>0&&(n=1/Math.sqrt(n));for(let r=0;r<i;++r)t[r]=e[r]*n}else for(let n=0;n<i;++n)t[n]=e[n]}static _blendVec(t,e,s,i){const n=i?1:1-s,r=t.length;for(let a=0;a<r;++a)t[a]=t[a]*n+e[a]*s}static _blendQuat(t,e,s,i){const n=t.length,r=i?1:1-s;Jt._dot(t,e)<0&&(s=-s);for(let a=0;a<n;++a)t[a]=t[a]*r+e[a]*s;i||Jt._normalize(t)}static _blend(t,e,s,i,n){i==="quaternion"?Jt._blendQuat(t,e,s,n):Jt._blendVec(t,e,s,n)}static _stableSort(t,e){const s=t.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(e(t[n],t[i])){const r=t[i];t[i]=t[n],t[n]=r}}addClip(t){const e=this._targets,s=this._binder,i=t.track.curves,n=t.snapshot,r=[],a=[];for(let l=0;l<i.length;++l){const c=i[l].paths;for(let d=0;d<c.length;++d){const u=c[d],f=s.resolve(u);let m=e[f&&f.targetPath||null];if(!m&&f){m={target:f,value:[],curves:0,blendCounter:0};for(let p=0;p<m.target.components;++p)m.value.push(0);if(e[f.targetPath]=m,s.animComponent){if(!s.animComponent.targets[f.targetPath]){let p;f.targetPath.substring(f.targetPath.length-13)==="localRotation"?p=Rt.TYPE_QUAT:p=Rt.TYPE_VEC3,s.animComponent.targets[f.targetPath]=new Rt(s.animComponent,p)}s.animComponent.targets[f.targetPath].layerCounter++,s.animComponent.targets[f.targetPath].setMask(s.layerIndex,1)}}m&&(m.curves++,r.push(n._results[l]),a.push(m))}}this._clips.push(t),this._inputs.push(r),this._outputs.push(a)}removeClip(t){const e=this._targets,s=this._binder,i=this._clips,r=i[t].track.curves;for(let a=0;a<r.length;++a){const h=r[a].paths;for(let c=0;c<h.length;++c){const d=h[c],u=this._binder.resolve(d);u&&(u.curves--,u.curves===0&&(s.unresolve(d),delete e[u.targetPath],s.animComponent&&s.animComponent.targets[u.targetPath].layerCounter--))}}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const i=e[s];if(i.name===t)return i}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach(e=>{this.addClip(e)})}assignMask(t){return this._binder.assignMask(t)}update(t){const e=this._clips,s=e.map(function(r,a){return a});Jt._stableSort(s,function(r,a){return e[r].blendOrder<e[a].blendOrder});for(let r=0;r<s.length;++r){const a=s[r],l=e[a],h=this._inputs[a],c=this._outputs[a],d=l.blendWeight;d>0&&l._update(t);let u,f,m;if(d>=1)for(let p=0;p<h.length;++p)u=h[p],f=c[p],m=f.value,Jt._set(m,u,f.target.type),f.blendCounter++;else if(d>0)for(let p=0;p<h.length;++p)u=h[p],f=c[p],m=f.value,f.blendCounter===0?Jt._set(m,u,f.target.type):Jt._blend(m,u,d,f.target.type),f.blendCounter++}const i=this._targets,n=this._binder;for(const r in i)if(i.hasOwnProperty(r)){const a=i[r];if(n.animComponent&&a.target.isTransform){const l=n.animComponent.targets[r];l.counter===l.layerCounter&&(l.counter=0),l.path||(l.path=r,l.baseValue=a.target.get(),l.setter=a.target.set),l.updateValue(n.layerIndex,a.value),l.counter++}else a.target.set(a.value);a.blendCounter=0}n.update(t)}}class Dn{static joinPath(t,e){e=e||".";const s=function(n){return n.replace(/\\/g,"\\\\").replace(new RegExp("\\"+e,"g"),"\\"+e)};return t.map(s).join(e)}static splitPath(t,e){e=e||".";const s=[];let i="",n=0;for(;n<t.length;){let r=t[n++];r==="\\"&&n<t.length?(r=t[n++],r==="\\"||r===e?i+=r:i+="\\"+r):r===e?(s.push(i),i=""):i+=r}return i.length>0&&s.push(i),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}class td{constructor(t,e,s,i){t.set?(this._set=t.set,this._get=t.get):this._set=t,this._type=e,this._components=s,this._targetPath=i,this._isTransform=this._targetPath.substring(this._targetPath.length-13)==="localRotation"||this._targetPath.substring(this._targetPath.length-13)==="localPosition"||this._targetPath.substring(this._targetPath.length-10)==="localScale"}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class vi{constructor(t){if(this._isPathInMask=(n,r)=>{const a=this._mask[n];if(a){if(a.children||r&&a.value!==!1)return!0}else return!1;return!1},this.graph=t,!t)return;this._mask=null;const e={};(function n(r){e[r.name]=r;for(let a=0;a<r.children.length;++a)n(r.children[a])})(t),this.nodes=e,this.targetCache={};const i=function(r){let a=r;for(;a&&!(a instanceof pt);)a=a.parent;let l;return a&&(a.render?l=a.render.meshInstances:a.model&&(l=a.model.meshInstances)),l};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(n){const r=n.localPosition,a=function(h){r.set(...h)};return vi.createAnimTarget(a,"vector",3,n,"localPosition")},localRotation:function(n){const r=n.localRotation,a=function(h){r.set(...h)};return vi.createAnimTarget(a,"quaternion",4,n,"localRotation")},localScale:function(n){const r=n.localScale,a=function(h){r.set(...h)};return vi.createAnimTarget(a,"vector",3,n,"localScale")},weights:function(n){const r=i(n);if(r){const a=[];for(let l=0;l<r.length;++l)r[l].node.name===n.name&&r[l].morphInstance&&a.push(r[l].morphInstance);if(a.length>0){const l=function(c){for(let d=0;d<c.length;++d)for(let u=0;u<a.length;u++)a[u].setWeight(d,c[d])};return vi.createAnimTarget(l,"vector",a[0].morph._targets.length,n,"weights")}}return null},materialTexture:(n,r)=>{const a=i(n);if(a){let l;for(let h=0;h<a.length;++h)if(a[h].node.name===n.name){l=a[h];break}if(l){const h=c=>{const d=this.animComponent.system.app.assets.get(c[0]);d&&d.resource&&d.type==="texture"&&(l.material[r]=d.resource,l.material.update())};return vi.createAnimTarget(h,"vector",1,n,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let i=e[s];if(this._isPathInMask(i,t.entityPath.length===1))return!0;for(let n=1;n<t.entityPath.length;n++)if(i+="/"+t.entityPath[n],this._isPathInMask(i,n===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath)),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,i,n,r){const a=Dn.encode(i.path,r||"entity",n);return new td(t,e,s,a)}resolve(t){const e=Dn.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const i=this.findNode(t);if(!i)return null;const n=this.handlers[t.propertyPath];return!n||(s=n(i),!s)?null:(this.targetCache[e]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s)}unresolve(t){if(t.component!=="graph")return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,this.nodeCounts[e.path]===0){const s=this.activeNodes,i=s.indexOf(e.node),n=s.length;i<n-1&&(s[i]=s[n-1]),s.pop()}}update(t){const e=this.activeNodes;for(let s=0;s<e.length;++s)e[s]._dirtifyLocal()}assignMask(t){return t!==this._mask?(this._mask=t,!0):!1}}class bA{constructor(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new tt,this._pos=new y,this._scale=new y,this._targetNode=null}getTarget(){return this._targetNode}setTarget(t){this._targetNode=t}}class Cs{constructor(t){this.looping=!0,this._animation=null,this._time=0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;const e=s=>{const i=new bA;i._name=s.name,this._interpolatedKeys.push(i),this._interpolatedKeyDict[s.name]=i,this._currKeyIndices[s.name]=0;for(let n=0;n<s._children.length;n++)e(s._children[n])};e(t)}set animation(t){this._animation=t,this.currentTime=0}get animation(){return this._animation}set currentTime(t){this._time=t;const e=this._interpolatedKeys.length;for(let s=0;s<e;s++){const n=this._interpolatedKeys[s]._name;this._currKeyIndices[n]=0}this.addTime(0),this.updateGraph()}get currentTime(){return this._time}get numNodes(){return this._interpolatedKeys.length}addTime(t){if(this._animation!==null){const e=this._animation._nodes,s=this._animation.duration;if(this._time===s&&!this.looping)return;if(this._time+=t,this._time>s){this._time=this.looping?0:s;for(let n=0;n<e.length;n++){const a=e[n]._name;this._currKeyIndices[a]=0}}else if(this._time<0){this._time=this.looping?s:0;for(let n=0;n<e.length;n++){const r=e[n],a=r._name;this._currKeyIndices[a]=r._keys.length-2}}const i=t>=0?1:-1;for(let n=0;n<e.length;n++){const r=e[n],a=r._name,l=r._keys,h=this._interpolatedKeyDict[a];if(h===void 0)continue;let c=!1;if(l.length!==1)for(let d=this._currKeyIndices[a];d<l.length-1&&d>=0;d+=i){const u=l[d],f=l[d+1];if(u.time<=this._time&&f.time>=this._time){const m=(this._time-u.time)/(f.time-u.time);h._pos.lerp(u.position,f.position,m),h._quat.slerp(u.rotation,f.rotation,m),h._scale.lerp(u.scale,f.scale,m),h._written=!0,this._currKeyIndices[a]=d,c=!0;break}}(l.length===1||!c&&this._time===0&&this.looping)&&(h._pos.copy(l[0].position),h._quat.copy(l[0].rotation),h._scale.copy(l[0].scale),h._written=!0)}}}blend(t,e,s){const i=this._interpolatedKeys.length;for(let n=0;n<i;n++){const r=t._interpolatedKeys[n],a=e._interpolatedKeys[n],l=this._interpolatedKeys[n];r._written&&a._written?(l._quat.slerp(r._quat,e._interpolatedKeys[n]._quat,s),l._pos.lerp(r._pos,e._interpolatedKeys[n]._pos,s),l._scale.lerp(r._scale,a._scale,s),l._written=!0):r._written?(l._quat.copy(r._quat),l._pos.copy(r._pos),l._scale.copy(r._scale),l._written=!0):a._written&&(l._quat.copy(a._quat),l._pos.copy(a._pos),l._scale.copy(a._scale),l._written=!0)}}setGraph(t){if(this.graph=t,t)for(let e=0;e<this._interpolatedKeys.length;e++){const s=this._interpolatedKeys[e],i=t.findByName(s._name);this._interpolatedKeys[e].setTarget(i)}else for(let e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)}updateGraph(){if(this.graph)for(let t=0;t<this._interpolatedKeys.length;t++){const e=this._interpolatedKeys[t];if(e._written){const s=e.getTarget();s.localPosition.copy(e._pos),s.localRotation.copy(e._quat),s.localScale.copy(e._scale),s._dirtyLocal||s._dirtifyLocal(),e._written=!1}}}}class yp extends st{constructor(t,e){super(t,e);this.animationsIndex={},this.on("set_animations",this.onSetAnimations,this),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this)}set currentTime(t){const e=this.data;if(e.skeleton){const s=e.skeleton;s.currentTime=t,s.addTime(0),s.updateGraph()}if(e.animEvaluator){const s=e.animEvaluator;for(let i=0;i<s.clips.length;++i)s.clips[i].time=t}}get currentTime(){const t=this.data;if(t.skeleton)return this.data.skeleton._time;if(t.animEvaluator){const e=t.animEvaluator.clips;if(e.length>0)return e[e.length-1].time}return 0}get duration(){return this.data.animations[this.data.currAnim].duration}play(t,e=0){if(!this.enabled||!this.entity.enabled)return;const s=this.data;if(!!s.animations[t]){if(s.prevAnim=s.currAnim,s.currAnim=t,s.model){!s.skeleton&&!s.animEvaluator&&this._createAnimationController();const i=s.animations[s.prevAnim],n=s.animations[s.currAnim];if(s.blending=e>0&&s.prevAnim,s.blending&&(s.blend=0,s.blendSpeed=1/e),s.skeleton&&(s.blending?(s.fromSkel.animation=i,s.fromSkel.addTime(s.skeleton._time),s.toSkel.animation=n):s.skeleton.animation=n),s.animEvaluator){const r=s.animEvaluator;if(s.blending)for(;r.clips.length>1;)r.removeClip(0);else s.animEvaluator.removeClips();const a=new up(s.animations[s.currAnim],0,1,!0,s.loop);a.name=s.currAnim,a.blendWeight=s.blending?0:1,a.reset(),s.animEvaluator.addClip(a)}}s.playing=!0}}getAnimation(t){return this.data.animations[t]}setModel(t){const e=this.data;t!==e.model&&(this._resetAnimationController(),e.model=t,e.animations&&e.currAnim&&e.animations[e.currAnim]&&this.play(e.currAnim))}_resetAnimationController(){const t=this.data;t.skeleton=null,t.fromSkel=null,t.toSkel=null,t.animEvaluator=null}_createAnimationController(){const t=this.data,e=t.model,s=t.animations;let i=!1,n=!1;for(const a in s)s.hasOwnProperty(a)&&(s[a].constructor===Yo?n=!0:i=!0);const r=e.getGraph();i?(t.fromSkel=new Cs(r),t.toSkel=new Cs(r),t.skeleton=new Cs(r),t.skeleton.looping=t.loop,t.skeleton.setGraph(r)):n&&(t.animEvaluator=new Jt(new vi(this.entity)))}loadAnimationAssets(t){if(!t||!t.length)return;const e=this.system.app.assets,s=n=>{if(n.resources.length>1)for(let r=0;r<n.resources.length;r++)this.animations[n.resources[r].name]=n.resources[r],this.animationsIndex[n.id]=n.resources[r].name;else this.animations[n.name]=n.resource,this.animationsIndex[n.id]=n.name;this.animations=this.animations},i=n=>{n.off("change",this.onAssetChanged,this),n.on("change",this.onAssetChanged,this),n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this),n.resource?s(n):(n.once("load",s,this),this.enabled&&this.entity.enabled&&e.load(n))};for(let n=0,r=t.length;n<r;n++){const a=e.get(t[n]);a?i(a):e.on("add:"+t[n],i)}}onAssetChanged(t,e,s,i){if(e==="resource"||e==="resources")if(e==="resources"&&s&&s.length===0&&(s=null),s){let n=!1;if(s.length>1){if(i&&i.length>1)for(let r=0;r<i.length;r++)delete this.animations[i[r].name];else delete this.animations[t.name];n=!1;for(let r=0;r<s.length;r++)this.animations[s[r].name]=s[r],!n&&this.data.currAnim===s[r].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(n=!0,this.play(s[r].name));n||(this._stopCurrentAnimation(),this.onSetAnimations())}else{if(i&&i.length>1)for(let r=0;r<i.length;r++)delete this.animations[i[r].name];this.animations[t.name]=s[0]||s,n=!1,this.data.currAnim===t.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(n=!0,this.play(t.name)),n||(this._stopCurrentAnimation(),this.onSetAnimations())}this.animationsIndex[t.id]=t.name}else{if(i.length>1)for(let n=0;n<i.length;n++)delete this.animations[i[n].name],this.data.currAnim===i[n].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}onAssetRemoved(t){if(t.off("remove",this.onAssetRemoved,this),this.animations){if(t.resources.length>1)for(let e=0;e<t.resources.length;e++)delete this.animations[t.resources[e].name],this.data.currAnim===t.resources[e].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}}_stopCurrentAnimation(){const t=this.data;if(t.currAnim=null,t.playing=!1,t.skeleton&&(t.skeleton.currentTime=0,t.skeleton.animation=null),t.animEvaluator){for(let e=0;e<t.animEvaluator.clips.length;++e)t.animEvaluator.clips[e].stop();t.animEvaluator.update(0),t.animEvaluator.removeClips()}}onSetAnimations(t,e,s){const i=this.data,n=this.entity.model;if(n){const r=n.model;r&&r!==i.model&&this.setModel(r)}if(!i.currAnim&&i.activate&&i.enabled&&this.entity.enabled){const r=Object.keys(i.animations);r.length>0&&this.play(r[0])}}onSetAssets(t,e,s){if(e&&e.length){for(let n=0;n<e.length;n++)if(e[n]){const r=this.system.app.assets.get(e[n]);if(r){r.off("change",this.onAssetChanged,this),r.off("remove",this.onAssetRemoved,this);const a=this.animationsIndex[r.id];this.data.currAnim===a&&this._stopCurrentAnimation(),delete this.animations[a],delete this.animationsIndex[r.id]}}}const i=s.map(n=>n instanceof rt?n.id:n);this.loadAnimationAssets(i)}onSetLoop(t,e,s){const i=this.data;if(i.skeleton&&(i.skeleton.looping=i.loop),i.animEvaluator)for(let n=0;n<i.animEvaluator.clips.length;++n)i.animEvaluator.clips[n].loop=i.loop}onEnable(){super.onEnable();const t=this.data,e=t.assets,s=this.system.app.assets;if(e)for(let i=0,n=e.length;i<n;i++){let r=e[i];r instanceof rt||(r=s.get(r)),r&&!r.resource&&s.load(r)}if(t.activate&&!t.currAnim){const i=Object.keys(t.animations);i.length>0&&this.play(i[0])}}onBeforeRemove(){for(let e=0;e<this.assets.length;e++){let s=this.assets[e];typeof s=="number"&&(s=this.system.app.assets.get(s)),!!s&&(s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this))}const t=this.data;delete t.animation,delete t.skeleton,delete t.fromSkel,delete t.toSkel,delete t.animEvaluator}}class wA{constructor(){this.assets=[],this.speed=1,this.loop=!0,this.activate=!0,this.enabled=!0,this.animations={},this.model=null,this.prevAnim=null,this.currAnim=null,this.blending=!1,this.blend=0,this.blendSpeed=0,this.playing=!1,this.skeleton=null,this.fromSkel=null,this.toSkel=null,this.animEvaluator=null}}const xp=["enabled","assets","speed","loop","activate","animations","skeleton","model","prevAnim","currAnim","fromSkel","toSkel","blending","blendTimeRemaining","playing"];class TA extends Bt{constructor(t){super(t);this.id="animation",this.ComponentType=yp,this.DataType=wA,this.schema=xp,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["activate","enabled","loop","speed","assets"],super.initializeComponentData(t,e,s)}cloneComponent(t,e){this.addComponent(e,{}),e.animation.assets=t.animation.assets.slice(),e.animation.data.speed=t.animation.speed,e.animation.data.loop=t.animation.loop,e.animation.data.activate=t.animation.activate,e.animation.data.enabled=t.animation.enabled;const s={},i=t.animation.animations;for(const a in i)i.hasOwnProperty(a)&&(s[a]=i[a]);e.animation.animations=s;const n={},r=t.animation.animationsIndex;for(const a in r)r.hasOwnProperty(a)&&(n[a]=r[a]);return e.animation.animationsIndex=n,e.animation}onBeforeRemove(t,e){e.onBeforeRemove()}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],n=i.data;if(n.enabled&&i.entity.enabled){if(n.blending&&(n.blend+=t*n.blendSpeed,n.blend>=1&&(n.blend=1)),n.playing){const a=n.skeleton;if(a!==null&&n.model!==null){if(n.blending)a.blend(n.fromSkel,n.toSkel,n.blend);else{const l=t*n.speed;a.addTime(l),(n.speed>0&&a._time===a._animation.duration&&!n.loop||n.speed<0&&a._time===0&&!n.loop)&&(n.playing=!1)}n.blending&&n.blend===1&&(a.animation=n.toSkel._animation),a.updateGraph()}}const r=n.animEvaluator;if(r){for(let a=0;a<r.clips.length;++a){const l=r.clips[a];l.speed=n.speed,n.playing?l.resume():l.pause()}n.blending&&r.clips.length>1&&(r.clips[1].blendWeight=n.blend),r.update(t)}n.blending&&n.blend===1&&(n.blending=!1)}}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(yp.prototype,xp);class Jr{constructor(t,e,s,i,n=1){this._state=t,this._parent=e,this._name=s,Array.isArray(i)?(this._point=new H(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(t){this._weight=t}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const t=this._state.totalWeight;return t===0?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(t){this._weightedSpeed=t}get weightedSpeed(){return this._weightedSpeed}set animTrack(t){this._animTrack=t}get animTrack(){return this._animTrack}}class Fn extends Jr{constructor(t,e,s,i,n,r,a,l,h){super(t,e,s,i);this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=h,this._syncAnimations=a!==!1,this._pointCache={};for(let c=0;c<r.length;c++){const d=r[c];d.children?this._children.push(l(d.type,this,null,s,1,d.parameter?[d.parameter]:d.parameters,d.children,l,h)):this._children.push(new Jr(t,this,d.name,d.point,d.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++)this._children[e].constructor===Fn?t+=this._children[e].getNodeCount():t++;return t}}class CA extends Fn{constructor(t,e,s,i,n,r,a,l,h){r.sort((c,d)=>c.point-d.point);super(t,e,s,i,n,r,a,l,h)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const i=this._children[e+1];if(s.point===i.point)s.weight=.5,i.weight=.5;else if(U.between(this._parameterValues[0],s.point,i.point,!0)){const n=Math.abs(s.point-i.point),r=Math.abs(s.point-this._parameterValues[0]),a=(n-r)/n;s.weight=a,i.weight=1-a}else i.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class Gs extends Fn{pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;Gs._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;Gs._pip.set(Gs._p.x,Gs._p.y).sub(n);let r=Number.MAX_VALUE;for(let a=0;a<this._children.length;a++){if(s===a)continue;const l=this.pointDistanceCache(s,a),h=U.clamp(1-Gs._pip.dot(l)/l.lengthSq(),0,1);h<r&&(r=h)}i.weight=r,t+=r,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}Gs._p=new H;Gs._pip=new H;class Hs extends Fn{pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new H((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),H.angleRad(this._children[t].point,this._children[e].point)*2)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;Hs._p.set(...this._parameterValues);const s=Hs._p.length();t=0,e=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],r=n.point,a=n.pointLength;let l=Number.MAX_VALUE;for(let h=0;h<this._children.length;h++){if(i===h)continue;const c=this.pointCache(i,h),d=this._children[h].pointLength;Hs._pip.set((s-a)/((d+a)/2),H.angleRad(r,Hs._p)*2);const u=U.clamp(1-Math.abs(Hs._pip.dot(c)/c.lengthSq()),0,1);u<l&&(l=u)}n.weight=l,t+=l,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let i=0;i<this._children.length;i++){const n=this._children[i];if(n.weight=n._weight/t,this._syncAnimations){const r=n.animTrack.duration/e*t;n.weightedSpeed=n.absoluteSpeed*r}}}}Hs._p=new H;Hs._pip=new H;class AA extends Fn{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const i=this._children[s];e+=i.animTrack.duration/i.absoluteSpeed*i.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=Math.max(this._parameterValues[s],0)/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}class vp{constructor(t,e,s,i,n){this._controller=t,this._name=e,this._animations={},this._animationList=[],this._speed=s||1,this._loop=i===void 0?!0:i;const r=this._controller.findParameter.bind(this._controller);n?this._blendTree=this._createTree(n.type,this,null,e,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,r):this._blendTree=new Jr(this,null,e,1,s)}_createTree(t,e,s,i,n,r,a,l,h,c){switch(t){case gA:return new CA(e,s,i,n,r,a,l,h,c);case xA:return new Gs(e,s,i,n,r,a,l,h,c);case yA:return new Hs(e,s,i,n,r,a,l,h,c);case vA:return new AA(e,s,i,n,r,a,l,h,c)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),i=this._animationList.findIndex(function(n){return n.path===s});if(i>=0)this._animationList[i].animTrack=e;else{const n=this._getNodeFromPath(t);n.animTrack=e,this._animationList.push(n)}}get name(){return this._name}set animations(t){this._animationList=t}get animations(){return this._animationList}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}get nodeCount(){return!this._blendTree||this._blendTree.constructor===Jr?1:this._blendTree.getNodeCount()}get playable(){return gl.indexOf(this.name)!==-1||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=this.name+"."+this.animations[0].animTrack.name,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class yl{constructor({from:t,to:e,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:l=fp}){this._from=t,this._to=e,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=l}get from(){return this._from}set to(t){this._to=t}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class MA{constructor(t,e,s,i,n,r,a){this._animEvaluator=t,this._states={},this._stateNames=[],this._eventHandler=r,this._consumedTriggers=a;for(let l=0;l<e.length;l++)this._states[e[l].name]=new vp(this,e[l].name,e[l].speed,e[l].loop,e[l].blendTree),this._stateNames.push(e[l].name);this._transitions=s.map(l=>new yl(Pn({},l))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=i,this._previousStateName=null,this._activeStateName=Ln,this._playing=!1,this._activate=n,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=fp,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(t){this._activeStateName=t}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(t){this._previousStateName=t}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}set playing(t){this._playing=t}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this.activeStateName===Ln||this.activeStateName===_l)return 0;let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}return t}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if(this.activeStateName===Ln||this.activeStateName===_l||this.activeStateName===ji)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?t/e.track.duration:null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter(function(s){return s.from===t}),Yr(e),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[t+"->"+e];return s||(s=this._transitions.filter(function(i){return i.from===t&&i.to===e}),Yr(s),this._findTransitionsBetweenStatesCache[t+"->"+e]=s),s}_transitionHasConditionsMet(t){const e=t.conditions;for(let s=0;s<e.length;s++){const i=e[s],n=this.findParameter(i.parameterName);switch(i.predicate){case dA:if(!(n.value>i.value))return!1;break;case uA:if(!(n.value<i.value))return!1;break;case fA:if(!(n.value>=i.value))return!1;break;case mA:if(!(n.value<=i.value))return!1;break;case pA:if(n.value!==i.value)return!1;break;case _A:if(n.value===i.value)return!1;break}}return!0}_findTransition(t,e){let s=[];if(t&&e)s=s.concat(this._findTransitionsBetweenStates(t,e));else if(!this._isTransitioning)s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(ji));else switch(this._transitionInterruptionSource){case oA:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(ji));break;case lA:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(ji));break;case hA:s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(ji));break;case cA:s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(ji));break}if(s=s.filter(i=>{if(i.to===this.activeStateName)return!1;if(i.hasExitTime){let n=this._getActiveStateProgressForTime(this._timeInStateBefore),r=this._getActiveStateProgressForTime(this._timeInState);if(i.exitTime<1&&this.activeState.loop&&(n-=Math.floor(n),r-=Math.floor(r)),!(i.exitTime>n&&i.exitTime<=r))return null}return this._transitionHasConditionsMet(i)}),s.length>0){const i=s[0];if(i.to===_l){const n=this._findTransitionsFromState(Ln)[0];i.to=n.to}return i}return null}updateStateFromTransition(t){let e,s,i;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to;for(let h=0;h<t.conditions.length;h++){const c=t.conditions[h];this.findParameter(c.parameterName).type===pl&&this._consumedTriggers.add(c.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const h=Math.min(this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1,1);for(let c=0;c<this._transitionPreviousStates.length;c++){this._isTransitioning?c!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[c].weight*=1-h:this._transitionPreviousStates[c].weight=h:this._transitionPreviousStates[c].weight=1,e=this._findState(this._transitionPreviousStates[c].name);for(let d=0;d<e.animations.length;d++)s=e.animations[d],i=this._animEvaluator.findClip(s.name+".previous."+c),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+c),c!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const n=this.activeState,r=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let a=0,l=0;if(r){const h=n.timelineDuration*t.transitionOffset;a=h,l=h}this._timeInState=a,this._timeInStateBefore=l;for(let h=0;h<n.animations.length;h++){if(i=this._animEvaluator.findClip(n.animations[h].name),i)i.reset();else{const c=Number.isFinite(n.animations[h].speed)?n.animations[h].speed:n.speed;i=new up(n.animations[h].animTrack,this._timeInState,c,!0,n.loop,this._eventHandler),i.name=n.animations[h].name,this._animEvaluator.addClip(i)}if(t.time>0?i.blendWeight=0:i.blendWeight=n.animations[h].normalizedWeight,i.play(),r)i.time=n.timelineDuration*t.transitionOffset;else{const c=n.speed>=0?0:this.activeStateDuration;i.time=c}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new yl({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,i){const n=t.split(".");let r=this._findState(n[0]);r||(r=new vp(this,n[0],1),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,e),s!==void 0&&(r.speed=s),i!==void 0&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play()}removeNodeAnimations(t){if(gl.indexOf(t)!==-1)return;const e=this._findState(t);if(!!e)return e.animations=[],!0}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=Ln,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,i;this._timeInStateBefore=this._timeInState,this._timeInState+=t;const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const r=this._totalTransitionTime!==0?this._currTransitionTime/this._totalTransitionTime:1;for(let a=0;a<this._transitionPreviousStates.length;a++){e=this._findState(this._transitionPreviousStates[a].name);const l=this._transitionPreviousStates[a].weight;for(let h=0;h<e.animations.length;h++)s=e.animations[h],i=this._animEvaluator.findClip(s.name+".previous."+a),i&&(i.blendWeight=(1-r)*s.normalizedWeight*l)}e=this.activeState;for(let a=0;a<e.animations.length;a++)s=e.animations[a],this._animEvaluator.findClip(s.name).blendWeight=r*s.normalizedWeight}else{this._isTransitioning=!1;const r=this.activeStateAnimations.length,a=this._animEvaluator.clips.length;for(let l=0;l<a-r;l++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let l=0;l<e.animations.length;l++)s=e.animations[l],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==Jr){e=this.activeState;for(let r=0;r<e.animations.length;r++)s=e.animations[r],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(t)}findParameter(t){return this._parameters[t]}}const ed=new H,xl=new y,Qr=new Z,ta=new j,ea=new tt;class Xs extends vi{constructor(t,e,s,i,n){super(e);this.animComponent=t,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return ed.x=t[0],ed.y=t[1],ed}static _packVec3(t){return xl.x=t[0],xl.y=t[1],xl.z=t[2],xl}static _packVec4(t){return Qr.x=t[0],Qr.y=t[1],Qr.z=t[2],Qr.w=t[3],Qr}static _packColor(t){return ta.r=t[0],ta.g=t[1],ta.b=t[2],ta.a=t[3],ta}static _packQuat(t){return ea.x=t[0],ea.y=t[1],ea.z=t[2],ea.w=t[3],ea}resolve(t){const e=Dn.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;let i,n,r;switch(t.component){case"entity":i=this._getEntityFromHierarchy(t.entityPath),r=Dn.encode(i.path,"entity",t.propertyPath),n=i;break;case"graph":if(n=this.findNode(t),!n)return null;r=Dn.encode(n.path,"graph",t.propertyPath);break;default:if(i=this._getEntityFromHierarchy(t.entityPath),n=i.findComponent(t.component),!n)return null;r=Dn.encode(i.path,t.component,t.propertyPath);break}return s=this._createAnimTargetForProperty(n,t.propertyPath,r),this.targetCache[e]=s,s}update(t){const e=this.activeNodes;if(e)for(let s=0;s<e.length;s++)e[s]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return t.length===1?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const i=e.length-(s?0:1);for(let n=0;n<i;n++)t=t[e[n]];return t}_setter(t,e,s){const i=this._resolvePath(t,e),n=e[e.length-1],r="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[r]){let h=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();h=[h.x,h.y,h.z,h.w];const c=i[r].bind(i);return{set:d=>{c(s(d))},get:()=>h}}const a=i[n];if(typeof a=="object"&&a.hasOwnProperty("copy"))return function(l){a.copy(s(l))};if([H,y,Z,j,tt].indexOf(i.constructor)!==-1&&e.length>1){const l=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,h=e[e.length-2];return function(c){i[n]=s(c),l[h]=i}}return function(l){i[n]=s(l)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&e[0]==="weights")return this.handlers.weights(t);if(this.handlers&&e[0]==="material"&&e.length===2){const l=e[1];if(l.endsWith("Map"))return this.handlers.materialTexture(t,l)}const i=this._resolvePath(t,e,!0);if(typeof i=="undefined")return null;let n,r,a;if(typeof i=="number")n=this._setter(t,e,Xs._packFloat),r="vector",a=1;else if(typeof i=="boolean")n=this._setter(t,e,Xs._packBoolean),r="vector",a=1;else if(typeof i=="object")switch(i.constructor){case H:n=this._setter(t,e,Xs._packVec2),r="vector",a=2;break;case y:n=this._setter(t,e,Xs._packVec3),r="vector",a=3;break;case Z:n=this._setter(t,e,Xs._packVec4),r="vector",a=4;break;case j:n=this._setter(t,e,Xs._packColor),r="vector",a=4;break;case tt:n=this._setter(t,e,Xs._packQuat),r="quaternion",a=4;break;default:return null}return e.indexOf("material")!==-1?new td(function(l){n(l),t.material.update()},r,a,s):new td(n,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={};(function s(i){t[i.name]=i;for(let n=0;n<i.children.length;++n)s(i.children[n])})(this.graph),this.nodes=t}}class PA{constructor(t,e,s,i=1,n=gp,r=!0){this._name=t,this._controller=e,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=r,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(t){this._controller.playing=t}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(t){const e=this._controller,s=e.playing;e.playing=!0,e.activeStateCurrentTime=t,s||e.update(0),e.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(t){this._weight=t,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(t){t!==this._blendType&&(this._blendType=t,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=U.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=t):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(t)}blendToWeight(t,e){this._startingWeight=this.weight,this._targetWeight=t,this._blendTime=Math.max(0,e),this._blendTimeElapsed=0}assignMask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}assignAnimation(t,e,s,i){e.constructor===Yo&&(this._controller.assignAnimation(t,e,s,i),this._controller._transitions.length===0&&this._controller._transitions.push(new yl({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}getAnimationAsset(t){return this._component.animationAssets[`${this.name}:${t}`]}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new yl({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}}class Sp extends st{constructor(t,e){super(t,e);this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(t){if(t===null){this.removeStateGraph();return}this._stateGraphAsset&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);let e,s;t instanceof rt?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),!(!s||this._stateGraphAsset===e)&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",i=>{this._stateGraph=i.resource,this.loadStateGraph(this._stateGraph)}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(t){this._normalizeWeights=t,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(t){this._speed=t}get speed(){return this._speed}set activate(t){this._activate=t}get activate(){return this._activate}set playing(t){this._playing=t}get playing(){return this._playing}set rootBone(t){if(typeof t=="string"){const e=this.entity.root.findByGuid(t);this._rootBone=e}else t instanceof pt?this._rootBone=t:this._rootBone=null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(t){this._stateGraph=t}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(t){this._layerIndices=t}get layerIndices(){return this._layerIndices}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set targets(t){this._targets=t}get targets(){return this._targets}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map(i=>i.mask);this.removeStateGraph(),this._stateGraph=new sl(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach((i,n)=>{i.mask=s[n]}),this.rebind()}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:i,mask:n,blendType:r}){let a;this.rootBone?a=this.rootBone:a=this.entity;const l=this._layers.length,h=new Xs(this,a,t,n,l),c=new Jt(h),d=new MA(c,e,s,this._parameters,this._activate,this,this._consumedTriggers);return this._layers.push(new PA(t,d,this,i,r)),this._layerIndices[t]=l,this._layers[l]}addLayer(t,e,s,i){const n=this.findAnimationLayer(t);if(n)return n;const r=[{name:"START",speed:1}],a=[];return this._addLayer({name:t,states:r,transitions:a,weight:e,mask:s,blendType:i})}loadStateGraph(t){this._stateGraph=t,this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const i=e[s];this._parameters[i]={type:t.parameters[i].type,value:t.parameters[i].value}}this._layers=[];for(let s=0;s<t.layers.length;s++){const i=t.layers[s];this._addLayer.bind(this)(Pn({},i))}this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let i=0;i<e.states.length;i++){const n=e.states[i];if(gl.indexOf(n)===-1){const r=s+":"+n;this._animationAssets[r]||(this._animationAssets[r]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let s=0;s<e.states.length;s++){const i=e.states[s];if(gl.indexOf(i)!==-1)continue;const n=this._animationAssets[e.name+":"+i];if(!n||!n.asset){this.removeNodeAnimations(i,e.name);continue}const r=n.asset,a=this.system.app.assets.get(r);a&&(a.resource?this.onAnimationAssetLoaded(e.name,i,a):(a.once("load",function(l,h){return function(c){this.onAnimationAssetLoaded(l,h,c)}.bind(this)}.bind(this)(e.name,i)),this.system.app.assets.load(a)))}}}onAnimationAssetLoaded(t,e,s){const i=s.resource;s.data.events&&(i.events=new Em(Object.values(s.data.events))),this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._parameters=Object.assign({},this._stateGraph.parameters);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(t=>{this._targets[t].unbind()})}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new sl({layers:[{name:n,states:[{name:"START",speed:1},{name:t,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const r=this.findAnimationLayer(n);if(r)r.assignAnimation(t,e,s,i);else{var a;(a=this.addLayer(n))==null||a.assignAnimation(t,e,s,i)}}assignAnimation(t,e,s,i=1,n=!0){if(!this._stateGraph&&t.indexOf(".")===-1){this.loadStateGraph(new sl({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),this.baseLayer.assignAnimation(t,e);return}const r=s?this.findAnimationLayer(s):this.baseLayer;!r||r.assignAnimation(t,e,i,n)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;!s||s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const i=this._parameters[t];if(i&&i.type===e){i.value=s;return}}getFloat(t){return this.getParameterValue(t,pp)}setFloat(t,e){this.setParameterValue(t,pp,e)}getInteger(t){return this.getParameterValue(t,mp)}setInteger(t,e){typeof e=="number"&&e%1==0&&this.setParameterValue(t,mp,e)}getBoolean(t){return this.getParameterValue(t,_p)}setBoolean(t,e){this.setParameterValue(t,_p,!!e)}getTrigger(t){return this.getParameterValue(t,pl)}setTrigger(t,e=!1){this.setParameterValue(t,pl,!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,pl,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach(e=>{this.parameters[e].value=!1}),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}}class EA{constructor(){this.enabled=!0}}const sd=["enabled"];class RA extends Bt{constructor(t){super(t);this.id="anim",this.ComponentType=Sp,this.DataType=EA,this.schema=sd,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,sd);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach(n=>{i.includes(n)||(t[n]=e[n])}),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers?e.layers.forEach((n,r)=>{n._controller.states.forEach(a=>{n._controller._states[a]._animationList.forEach(l=>{t.layers[r].assignAnimation(l.name,l.animTrack)})})}):e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach(n=>{if(t.layers[n]){const r=e.masks[n].mask,a={};Object.keys(r).forEach(l=>{a[decodeURI(l)]=r[l]}),t.layers[n].mask=a}})}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(t)}}cloneComponent(t,e){let s;(!t.anim.rootBone||t.anim.rootBone===t)&&(s={},t.anim.layers.forEach((n,r)=>{if(n.mask){const a={};Object.keys(n.mask).forEach(l=>{const h=l.split("/");h.shift();const c=[e.name,...h].join("/");a[c]=n.mask[l]}),s[r]={mask:a}}}));const i={stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters,normalizeWeights:t.anim.normalizeWeights,masks:s};return this.addComponent(e,i)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}st._buildAccessors(Sp.prototype,sd);class bp extends st{constructor(t,e){super(t,e)}setCurrentListener(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;const t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}}onEnable(){this.setCurrentListener()}onDisable(){this.system.current===this.entity&&(this.system.current=null)}}class IA{constructor(){this.enabled=!0}}const wp=["enabled"];class LA extends Bt{constructor(t,e){super(t);this.id="audiolistener",this.ComponentType=bp,this.DataType=IA,this.schema=wp,this.manager=e,this.current=null,this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["enabled"],super.initializeComponentData(t,e,s)}onUpdate(t){if(this.current){const e=this.current.getPosition();this.manager.listener.setPosition(e);const s=this.current.getWorldTransform();this.manager.listener.setOrientation(s)}}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(bp.prototype,wp);class Tp extends st{constructor(t,e){super(t,e);this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}play(t){if(!this.enabled||!this.entity.enabled)return;this.channel&&this.stop();let e;const s=this.data;if(s.sources[t])if(!s["3d"])e=this.system.manager.playSound(s.sources[t],s),s.currentSource=t,s.channel=e;else{const i=this.entity.getPosition();e=this.system.manager.playSound3d(s.sources[t],i,s),s.currentSource=t,s.channel=e}}pause(){this.channel&&this.channel.pause()}unpause(){this.channel&&this.channel.paused&&this.channel.unpause()}stop(){this.channel&&(this.channel.stop(),this.channel=null)}onSetAssets(t,e,s){const i=[],n=s.length;if(e&&e.length){for(let r=0;r<e.length;r++)if(e[r]){const a=this.system.app.assets.get(e[r]);a&&(a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this),this.currentSource===a.name&&this.stop())}}if(n)for(let r=0;r<n;r++)e.indexOf(s[r])<0&&(s[r]instanceof rt?i.push(s[r].id):i.push(s[r]));!this.system._inTools&&i.length&&this.loadAudioSourceAssets(i)}onAssetChanged(t,e,s,i){e==="resource"&&this.data.sources&&(this.data.sources[t.name]=s,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name)))}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))}onSetLoop(t,e,s){e!==s&&this.channel&&this.channel.setLoop(s)}onSetVolume(t,e,s){e!==s&&this.channel&&this.channel.setVolume(s)}onSetPitch(t,e,s){e!==s&&this.channel&&this.channel.setPitch(s)}onSetMaxDistance(t,e,s){e!==s&&this.channel instanceof gi&&this.channel.setMaxDistance(s)}onSetMinDistance(t,e,s){e!==s&&this.channel instanceof gi&&this.channel.setMinDistance(s)}onSetRollOffFactor(t,e,s){e!==s&&this.channel instanceof gi&&this.channel.setRollOffFactor(s)}onSetDistanceModel(t,e,s){e!==s&&this.channel instanceof gi&&this.channel.setDistanceModel(s)}onSet3d(t,e,s){if(e!==s&&this.system.initialized&&this.currentSource){let i=!1,n=!1;this.channel&&(i=this.channel.paused,n=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=i,this.channel.suspended=n)}}onEnable(){const t=this.data.assets;if(t){const e=this.system.app.assets;for(let s=0,i=t.length;s<i;s++){let n=t[s];n instanceof rt||(n=e.get(n)),n&&!n.resource&&e.load(n)}}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())}onDisable(){this.pause()}loadAudioSourceAssets(t){const e=t.map(l=>this.system.app.assets.get(l)),s={};let i=null,n=e.length;const r=l=>{n--},a=()=>{this.data.sources=s,this.data.currentSource=i,this.enabled&&this.activate&&i&&this.onEnable()};e.forEach((l,h)=>{l?(i=i||l.name,l.off("change",this.onAssetChanged,this),l.on("change",this.onAssetChanged,this),l.off("remove",this.onAssetRemoved,this),l.on("remove",this.onAssetRemoved,this),l.off("error",r,this),l.on("error",r,this),l.ready(c=>{s[c.name]=c.resource,n--,n===0&&a()}),!l.resource&&this.enabled&&this.entity.enabled&&this.system.app.assets.load(l)):(n--,n===0&&a(),this.system.app.assets.on("add:"+t[h],c=>{c.ready(d=>{this.data.sources[d.name]=d.resource}),c.resource||this.system.app.assets.load(c)}))})}}class DA{constructor(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=jo,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null}}const Cp=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"];class FA extends Bt{constructor(t,e){super(t);this.id="audiosource",this.ComponentType=Tp,this.DataType=DA,this.schema=Cp,this.manager=e,this.initialized=!1,this.app.systems.on("initialize",this.onInitialize,this),this.app.systems.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){s=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],super.initializeComponentData(t,e,s),t.paused=!(t.enabled&&t.activate)}onInitialize(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);const e=t._children;for(let s=0,i=e.length;s<i;s++)e[s]instanceof pt&&this.onInitialize(e[s]);this.initialized=!0}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s],n=i.entity,r=i.data;if(r.enabled&&n.enabled&&r.channel instanceof gi){const a=n.getPosition();r.channel.setPosition(a)}}}onRemove(t,e){e.channel&&(e.channel.stop(),e.channel=null)}setVolume(t){this.manager.setVolume(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this.onInitialize,this),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(Tp.prototype,Cp);class qi extends at{constructor(t,e,s){super();if(!t||!(t instanceof st))throw new Error("The parentComponent argument is required and must be a Component");if(!e||typeof e!="string")throw new Error("The propertyName argument is required and must be a string");if(s&&typeof s!="object")throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(t,e){const s=this._parseEventListenerConfig(t,"external",this._parentComponent),i=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,s){return Object.keys(t).map(function(i,n){const r=i.split("#"),a=r[0],l=r[1],h=t[i];if(r.length!==2||typeof a!="string"||a.length===0||typeof l!="string"||l.length===0)throw new Error("Invalid event listener description: `"+i+"`");if(typeof h!="function")throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:e+"_"+n+"_"+i,sourceName:a,eventName:l,callback:h,scope:s}},this)}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),this._app.systems[t]("postPostInitialize",this._updateEntityReference,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);const e=[];for(let s=0;s<this._eventListenerConfigs.length;++s){const i=this._eventListenerConfigs[s],n=this._app.systems[i.sourceName];n&&(e.indexOf(n)===-1&&e.push(n),n&&i.eventName==="gain"&&(this._gainListeners[i.sourceName]=i),n&&i.eventName==="lose"&&(this._loseListeners[i.sourceName]=i))}for(let s=0;s<e.length;++s)e[s][t]("add",this._onComponentAdd,this),e[s][t]("beforeremove",this._onComponentRemove,this)}_onSetEntity(t,e,s){if(s instanceof pt)this._updateEntityReference();else{if(s!=null&&typeof s!="string"){console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");return}e!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let t=this._parentComponent.data[this._entityPropertyName],e;if(t instanceof pt)e=t,t=e.getGuid(),this._parentComponent.data[this._entityPropertyName]=t;else{const i=this._parentComponent.system.app.root;e=this._parentComponent.entity.isDescendantOf(i)&&t?i.findByGuid(t):null}this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),this._entity=e,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(t){for(const e in this._entity.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){const s=e[t];s.callback.call(s.scope)}}_toggleEntityListeners(t,e){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(t,this._eventListenerConfigs[s],e)}_toggleComponentListeners(t,e,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===e&&this._safeToggleListener(t,n,s)}}_safeToggleListener(t,e,s){const i=t==="on";if(i&&this._listenerStatusFlags[e.id])return;const n=this._getEventSource(e.sourceName,s);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=i)}_getEventSource(t,e){if(t==="entity")return this._entity;const s=this._entity[t];return s||(e||console.warn("Entity has no component with name "+t),null)}_onEntityDestroy(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(t){return this._entity&&this._entity.c?!!this._entity.c[t]:!1}get entity(){return this._entity}}const id=0,Ap=1,vl="group",nd="image",Mp="text",Gt={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},sa={};sa[Gt.DEFAULT]="_defaultTint";sa[Gt.HOVER]="hoverTint";sa[Gt.PRESSED]="pressedTint";sa[Gt.INACTIVE]="inactiveTint";const ia={};ia[Gt.DEFAULT]="_defaultSpriteAsset";ia[Gt.HOVER]="hoverSpriteAsset";ia[Gt.PRESSED]="pressedSpriteAsset";ia[Gt.INACTIVE]="inactiveSpriteAsset";const na={};na[Gt.DEFAULT]="_defaultSpriteFrame";na[Gt.HOVER]="hoverSpriteFrame";na[Gt.PRESSED]="pressedSpriteFrame";na[Gt.INACTIVE]="inactiveSpriteFrame";class Pp extends st{constructor(t,e){super(t,e);this._visualState=Gt.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new j(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new qi(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",t)}_toggleLifecycleListeners(t,e){this[t]("set_active",this._onSetActive,this),this[t]("set_transitionMode",this._onSetTransitionMode,this),this[t]("set_hoverTint",this._onSetTransitionValue,this),this[t]("set_pressedTint",this._onSetTransitionValue,this),this[t]("set_inactiveTint",this._onSetTransitionValue,this),this[t]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[t]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[t]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[t]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_onSetActive(t,e,s){e!==s&&this._updateVisualState()}_onSetTransitionMode(t,e,s){e!==s&&(this._cancelTween(),this._resetToDefaultVisualState(e),this._forceReapplyVisualState())}_onSetTransitionValue(t,e,s){e!==s&&this._forceReapplyVisualState()}_onElementComponentRemove(t){this.entity===t&&this._toggleHitElementListeners("off")}_onElementComponentAdd(t){this.entity===t&&this._toggleHitElementListeners("on")}_onImageElementLose(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)}_onImageElementGain(){this._storeDefaultVisualState(),this._forceReapplyVisualState()}_toggleHitElementListeners(t){if(this.entity.element){const e=t==="on";if(e&&this._hasHitElementListeners)return;this.entity.element[t]("mouseenter",this._onMouseEnter,this),this.entity.element[t]("mouseleave",this._onMouseLeave,this),this.entity.element[t]("mousedown",this._onMouseDown,this),this.entity.element[t]("mouseup",this._onMouseUp,this),this.entity.element[t]("touchstart",this._onTouchStart,this),this.entity.element[t]("touchend",this._onTouchEnd,this),this.entity.element[t]("touchleave",this._onTouchLeave,this),this.entity.element[t]("touchcancel",this._onTouchCancel,this),this.entity.element[t]("selectstart",this._onSelectStart,this),this.entity.element[t]("selectend",this._onSelectEnd,this),this.entity.element[t]("selectenter",this._onSelectEnter,this),this.entity.element[t]("selectleave",this._onSelectLeave,this),this.entity.element[t]("click",this._onClick,this),this._hasHitElementListeners=e}}_storeDefaultVisualState(){if(this._imageReference.hasComponent("element")){const t=this._imageReference.entity.element;t.type!==vl&&(this._storeDefaultColor(t.color),this._storeDefaultOpacity(t.opacity),this._storeDefaultSpriteAsset(t.spriteAsset),this._storeDefaultSpriteFrame(t.spriteFrame))}}_storeDefaultColor(t){this._defaultTint.r=t.r,this._defaultTint.g=t.g,this._defaultTint.b=t.b}_storeDefaultOpacity(t){this._defaultTint.a=t}_storeDefaultSpriteAsset(t){this._defaultSpriteAsset=t}_storeDefaultSpriteFrame(t){this._defaultSpriteFrame=t}_onSetColor(t){this._isApplyingTint||(this._storeDefaultColor(t),this._forceReapplyVisualState())}_onSetOpacity(t){this._isApplyingTint||(this._storeDefaultOpacity(t),this._forceReapplyVisualState())}_onSetSpriteAsset(t){this._isApplyingSprite||(this._storeDefaultSpriteAsset(t),this._forceReapplyVisualState())}_onSetSpriteFrame(t){this._isApplyingSprite||(this._storeDefaultSpriteFrame(t),this._forceReapplyVisualState())}_onMouseEnter(t){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",t)}_onMouseLeave(t){this._isHovering=!1,this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseleave",t)}_onMouseDown(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",t)}_onMouseUp(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",t)}_onTouchStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",t)}_onTouchEnd(t){t.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",t)}_onTouchLeave(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",t)}_onTouchCancel(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",t)}_onSelectStart(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",t)}_onSelectEnd(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",t)}_onSelectEnter(t){this._hoveringCounter++,this._hoveringCounter===1&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",t)}_onSelectLeave(t){this._hoveringCounter--,this._hoveringCounter===0&&(this._isHovering=!1,this._isPressed=!1,this._updateVisualState()),this._fireIfActive("selectleave",t)}_onClick(t){this._fireIfActive("click",t)}_fireIfActive(t,e){this.data.active&&this.fire(t,e)}_updateVisualState(t){const e=this._visualState,s=this._determineVisualState();if((e!==s||t)&&this.enabled)switch(this._visualState=s,e===Gt.HOVER&&this._fireIfActive("hoverend"),e===Gt.PRESSED&&this._fireIfActive("pressedend"),s===Gt.HOVER&&this._fireIfActive("hoverstart"),s===Gt.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case id:{const i=sa[this._visualState],n=this[i];this._applyTint(n);break}case Ap:{const i=ia[this._visualState],n=na[this._visualState],r=this[i],a=this[n];this._applySprite(r,a);break}}}_forceReapplyVisualState(){this._updateVisualState(!0)}_resetToDefaultVisualState(t){if(this._imageReference.hasComponent("element"))switch(t){case id:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case Ap:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);break}}_determineVisualState(){if(this.active){if(this._isPressed)return Gt.PRESSED;if(this._isHovering)return Gt.HOVER}else return Gt.INACTIVE;return Gt.DEFAULT}_applySprite(t,e){e=e||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset!==t&&(this._imageReference.entity.element.spriteAsset=t),this._imageReference.entity.element.spriteFrame!==e&&(this._imageReference.entity.element.spriteFrame=e),this._isApplyingSprite=!1)}_applyTint(t){this._cancelTween(),this.fadeDuration===0?this._applyTintImmediately(t):this._applyTintWithTween(t)}_applyTintImmediately(t){if(!t||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===vl)return;const e=Ep(t);this._isApplyingTint=!0,e.equals(this._imageReference.entity.element.color)||(this._imageReference.entity.element.color=e),this._imageReference.entity.element.opacity!=t.a&&(this._imageReference.entity.element.opacity=t.a),this._isApplyingTint=!1}_applyTintWithTween(t){if(!t||!this._imageReference.hasComponent("element")||this._imageReference.entity.element.type===vl)return;const e=Ep(t),s=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;e.equals(s)&&t.a==i||(this._tweenInfo={startTime:ds(),from:new j(s.r,s.g,s.b,i),to:t.clone(),lerpColor:new j})}_updateTintTween(){const t=ds()-this._tweenInfo.startTime;let e=this.fadeDuration===0?1:t/this.fadeDuration;if(e=U.clamp(e,0,1),Math.abs(e-1)>1e-5){const s=this._tweenInfo.lerpColor;s.lerp(this._tweenInfo.from,this._tweenInfo.to,e),this._applyTintImmediately(new j(s.r,s.g,s.b,s.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()}_cancelTween(){delete this._tweenInfo}onUpdate(){this._tweenInfo&&this._updateTintTween()}onEnable(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()}onDisable(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)}onRemove(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}}function Ep(o){return new j(o.r,o.g,o.b)}class OA{constructor(){this.enabled=!0,this.active=!0,this.imageEntity=null,this.hitPadding=new Z,this.transitionMode=id,this.hoverTint=new j(.75,.75,.75),this.pressedTint=new j(.5,.5,.5),this.inactiveTint=new j(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}}const rd=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];class BA extends Bt{constructor(t){super(t);this.id="button",this.ComponentType=Pp,this.DataType=OA,this.schema=rd,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,rd)}onUpdate(t){const e=this.store;for(const s in e){const i=e[s].entity,n=i.button;n.enabled&&i.enabled&&n.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(Pp.prototype,rd);let On;class kA{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class zA{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=()=>{this.resizeRenderTargets()},e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){const s=this.camera.rect,i=Math.floor(s.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(s.w*this.app.graphicsDevice.height*this.renderTargetScale);return new nt(this.app.graphicsDevice,{name:e,format:t,width:i,height:n,mipmaps:!1,minFilter:bt,magFilter:bt,addressU:et,addressV:et})}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,i=e?s.getHdrFormat():ct,n=this.camera.entity.name+"-posteffect-"+this.effects.length,r=this._allocateColorBuffer(i,n),a=this.app.graphicsDevice.supportsStencil,l=t?s.samples:1;return new oe({colorBuffer:r,depth:t,stencil:a,samples:l})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s)}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}setRenderTargetScale(t){this.renderTargetScale=t,this.resizeRenderTargets()}addEffect(t){const e=this.effects,s=e.length===0,i=this._createOffscreenTarget(s,t.hdr),n=new kA(t,i);e.push(n),this._sourceTarget=n.inputTarget,e.length>1&&(e[e.length-2].outputTarget=n.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),this.effects.length===0&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const s=this.effects[t].effect;this._newPostEffect!==s&&s.needsDepthBuffer&&this._requestDepthMap()}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}_requestDepthMap(){On||(On=this.app.scene.layers.getLayerById(fs)),On&&On.incrementCounter()}_releaseDepthMap(){On&&On.decrementCounter()}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const i=this.effects[s];let n=i.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,i=this.app.graphicsDevice;this.camera.camera.aspectRatio=i.width*s.z/(i.height*s.w),!this.resizeTimeout&&(ds()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))}resizeRenderTargets(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=ds();const t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),s=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),i=this.effects;for(let n=0,r=i.length;n<r;n++){const a=i[n];(a.inputTarget.width!==e||a.inputTarget.height!==s)&&this._resizeOffscreenTarget(a.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}const Rp=[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"scissorRect",readonly:!1},{name:"vrDisplay",readonly:!1}];class Sl extends st{constructor(t,e){super(t,e);this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._camera=new Or,this._camera.node=e,this._priority=0,this._disablePostEffectsLayer=lr,this._postEffects=new zA(t.app,this)}get camera(){return this._camera}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}get frustum(){return this._camera.frustum}set layers(t){const e=this._camera.layers;for(let s=0;s<e.length;s++){const i=this.system.app.scene.layers.getLayerById(e[s]);!i||i.removeCamera(this)}if(this._camera.layers=t,!(!this.enabled||!this.entity.enabled))for(let s=0;s<t.length;s++){const i=this.system.app.scene.layers.getLayerById(t[s]);!i||i.addCamera(this)}}get layers(){return this._camera.layers}get postEffectsEnabled(){return this._postEffects.enabled}get postEffects(){return this._postEffects}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}get projectionMatrix(){return this._camera.projectionMatrix}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}get viewMatrix(){return this._camera.viewMatrix}dirtyLayerCompositionCameras(){const t=this.system.app.scene.layers;t._dirtyCameras=!0}screenToWorld(t,e,s,i){const n=this.system.app.graphicsDevice,r=n.clientRect.width,a=n.clientRect.height;return this._camera.screenToWorld(t,e,s,r,a,i)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system,e=t.app.scene,s=e.layers;t.addCamera(this),e.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system,e=t.app.scene,s=e.layers;this.postEffects.disable(),this.removeCameraFromLayers(),e.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),t.removeCamera(this)}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(t){const e=t||this.system.app.graphicsDevice,s=this.rect;return e.width*s.z/(e.height*s.w)}frameBegin(t){this.aspectRatioMode===bh&&(this.aspectRatio=this.calculateAspectRatio(t))}frameEnd(){}enterVr(t,e){if(t instanceof Function&&!e&&(e=t,t=null),!this.system.app.vr){e("VrManager not created. Enable VR in project settings.");return}if(t||(t=this.system.app.vr.display),t){const s=this;t.capabilities.canPresent?t.requestPresent(function(i){i||(s.vrDisplay=t,s.vrDisplay.once("beforepresentchange",function(n){n.presenting||(s.vrDisplay=null)})),e(i)}):(s.vrDisplay=t,e())}else e("No pc.VrDisplay to present")}exitVr(t){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){const e=this.vrDisplay;this.vrDisplay=null,e.exitPresent(t)}else this.vrDisplay=null,t();else t("Not presenting VR")}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){if(!this._camera.xr){t&&t(new Error("Camera is not in XR"));return}this._camera.xr.end(t)}copy(t){Rp.forEach(e=>{if(!e.readonly){const s=e.name;this[s]=t[s]}}),this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.layers=t.layers,this.priority=t.priority,this.renderTarget=t.renderTarget,this.rect=t.rect}}Rp.forEach(function(o){const t=o.name,e={};e.get=function(){return this._camera[t]},o.readonly||(e.set=function(s){this._camera[t]=s}),Object.defineProperty(Sl.prototype,t,e)});class UA{constructor(){this.enabled=!0}}const Ip=["enabled"];class NA extends Bt{constructor(t){super(t);this.cameras=[],this.id="camera",this.ComponentType=Sl,this.DataType=UA,this.schema=Ip,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(let i=0;i<s.length;i++){const n=s[i];if(e.hasOwnProperty(n)){const r=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(r)?t[n]=new Z(r[0],r[1],r[2],r[3]):t[n]=r;break;case"clearColor":Array.isArray(r)?t[n]=new j(r[0],r[1],r[2],r[3]):t[n]=r;break;default:t[n]=r;break}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;return this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect})}onBeforeRemove(t,e){this.removeCamera(e)}onUpdate(t){if(this.app.vr){const e=this.store;for(const s in e){const i=e[s];if(i.data.enabled&&i.entity.enabled){const n=i.entity.camera,r=n.vrDisplay;r&&(r.setClipPlanes(n.nearClip,n.farClip),i.entity&&(i.entity.localTransform.copy(r.combinedViewInv),i.entity._dirtyLocal=!1,i.entity._dirtifyWorld()))}}}}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),Yr(this.cameras)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),Yr(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(Sl.prototype,Ip);class Lp extends st{constructor(t,e){super(t,e);this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_model",this.onSetModel,this),this.on("set_render",this.onSetRender,this)}onSetType(t,e,s){e!==s&&this.system.changeType(this,e,s)}onSetHalfExtents(t,e,s){const i=this.data.type;this.data.initialized&&i==="box"&&this.system.recreatePhysicalShapes(this)}onSetRadius(t,e,s){const i=this.data.type;this.data.initialized&&(i==="sphere"||i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetHeight(t,e,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAxis(t,e,s){const i=this.data.type;this.data.initialized&&(i==="capsule"||i==="cylinder"||i==="cone")&&this.system.recreatePhysicalShapes(this)}onSetAsset(t,e,s){const i=this.system.app.assets;if(e){const n=i.get(e);n&&n.off("remove",this.onAssetRemoved,this)}if(s){s instanceof rt&&(this.data.asset=s.id);const n=i.get(this.data.asset);n&&(n.off("remove",this.onAssetRemoved,this),n.on("remove",this.onAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.model=null),this.system.recreatePhysicalShapes(this))}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const n=i.get(e);n&&n.off("remove",this.onRenderAssetRemoved,this)}if(s){s instanceof rt&&(this.data.renderAsset=s.id);const n=i.get(this.data.renderAsset);n&&(n.off("remove",this.onRenderAssetRemoved,this),n.on("remove",this.onRenderAssetRemoved,this))}this.data.initialized&&this.data.type==="mesh"&&(s||(this.data.render=null),this.system.recreatePhysicalShapes(this))}onSetModel(t,e,s){this.data.initialized&&this.data.type==="mesh"&&this.system.implementations.mesh.doRecreatePhysicalShape(this)}onSetRender(t,e,s){this.onSetModel(t,e,s)}onAssetRemoved(t){t.off("remove",this.onAssetRemoved,this),this.data.asset===t.id&&(this.asset=null)}onRenderAssetRemoved(t){t.off("remove",this.onRenderAssetRemoved,this),this.data.renderAsset===t.id&&(this.renderAsset=null)}_getCompoundChildShapeIndex(t){const e=this.data.shape,s=e.getNumChildShapes();for(let i=0;i<s;i++)if(e.getChildShape(i).ptr===t.ptr)return i;return null}_onInsert(t){if(typeof Ammo!="undefined"){if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){let e=this.entity.parent;for(;e;){if(e.collision&&e.collision.type==="compound"){e.collision.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(e.collision):this.system.recreatePhysicalShapes(this);break}e=e.parent}}}}_updateCompound(){const t=this.entity;if(t._dirtyWorld){let e=t._dirtyLocal,s=t;for(;s&&!e&&!(s.collision&&s.collision===this._compoundParent);)s._dirtyLocal&&(e=!0),s=s.parent;if(e){t.forEach(this.system.implementations.compound._updateEachDescendantTransform,t);const i=this._compoundParent.entity.rigidbody;i&&i.activate()}}}onEnable(){if(this.data.type==="mesh"&&(this.data.asset||this.data.renderAsset)&&this.data.initialized){const t=this.system.app.assets.get(this.data.asset||this.data.renderAsset);if(t&&(!t.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody)this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation();else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{const t=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()}else this.entity.trigger&&this.entity.trigger.enable()}onDisable(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()}onBeforeRemove(){this.asset&&(this.asset=null),this.renderAsset&&(this.renderAsset=null),this.entity.off("insert",this._onInsert,this),this.off()}}class VA{constructor(){this.enabled=!0,this.type="box",this.halfExtents=new y(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.asset=null,this.renderAsset=null,this.shape=null,this.model=null,this.render=null,this.initialized=!1}}const ra="static",os="dynamic",Bn="kinematic",WA=2,aa=4,ad=1,Dp=4,Fp=5,GA=1,Op=2,HA=4,Bp=16,kp=65535,od=65535^2;let js,oa,kn;class zp{constructor(t,e,s){this.entity=e.entity,this.component=e,this.app=t,typeof Ammo!="undefined"&&!js&&(js=new Ammo.btVector3,oa=new Ammo.btQuaternion,kn=new Ammo.btTransform),this.initialize(s)}initialize(t){const e=this.entity,s=t.shape;if(s&&typeof Ammo!="undefined"){e.trigger&&e.trigger.destroy();const i=1,n=e.getPosition(),r=e.getRotation();js.setValue(n.x,n.y,n.z),oa.setValue(r.x,r.y,r.z,r.w),kn.setOrigin(js),kn.setRotation(oa);const a=this.app.systems.rigidbody.createBody(i,s,kn);a.setRestitution(0),a.setFriction(0),a.setDamping(0,0),js.setValue(0,0,0),a.setLinearFactor(js),a.setAngularFactor(js),a.setCollisionFlags(a.getCollisionFlags()|aa),a.entity=e,this.body=a,this.component.enabled&&e.enabled&&this.enable()}}destroy(){const t=this.body;!t||(this.disable(),this.app.systems.rigidbody.destroyBody(t))}_getEntityTransform(t){const e=this.entity.getPosition(),s=this.entity.getRotation();js.setValue(e.x,e.y,e.z),oa.setValue(s.x,s.y,s.z,s.w),t.setOrigin(js),t.setRotation(oa)}updateTransform(){this._getEntityTransform(kn);const t=this.body;t.setWorldTransform(kn),t.activate()}enable(){const t=this.body;if(!t)return;const e=this.app.systems;e.rigidbody.addBody(t,Bp,od^Bp),e.rigidbody._triggers.push(this),t.forceActivationState(ad),this.updateTransform()}disable(){const t=this.body;if(!t)return;const e=this.app.systems,s=e.rigidbody._triggers.indexOf(this);s>-1&&e.rigidbody._triggers.splice(s,1),e.rigidbody.removeBody(t),t.forceActivationState(Fp)}}const bl=new G,XA=new y,jA=new tt,qA=new xt,Up=["enabled","type","halfExtents","radius","axis","height","asset","renderAsset","shape","model","render"];class Yi{constructor(t){this.system=t}beforeInitialize(t,e){e.shape=null,e.model=new Ts,e.model.graph=new xt}afterInitialize(t,e){this.recreatePhysicalShapes(t),t.data.initialized=!0}reset(t,e){this.beforeInitialize(t,e),this.afterInitialize(t,e)}recreatePhysicalShapes(t){const e=t.entity,s=t.data;if(typeof Ammo!="undefined"){e.trigger&&(e.trigger.destroy(),delete e.trigger),s.shape&&(t._compoundParent&&(this.system._removeCompoundChild(t._compoundParent,s.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),Ammo.destroy(s.shape),s.shape=null),s.shape=this.createPhysicalShape(t.entity,s);const i=!t._compoundParent;if(s.type==="compound"&&(!t._compoundParent||t===t._compoundParent))t._compoundParent=t,e.forEach(this._addEachDescendant,t);else if(s.type!=="compound"&&(t._compoundParent&&t===t._compoundParent&&e.forEach(this.system.implementations.compound._updateEachDescendant,t),!t.rigidbody)){t._compoundParent=null;let n=e.parent;for(;n;){if(n.collision&&n.collision.type==="compound"){t._compoundParent=n.collision;break}n=n.parent}}t._compoundParent&&t!==t._compoundParent&&(i&&t._compoundParent.shape.getNumChildShapes()===0?this.system.recreatePhysicalShapes(t._compoundParent):(this.system.updateCompoundChildTransform(e),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate())),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):t._compoundParent||(e.trigger?e.trigger.initialize(s):e.trigger=new zp(this.system.app,t,s))}}createPhysicalShape(t,e){}updateTransform(t,e,s,i){t.entity.trigger&&t.entity.trigger.updateTransform()}beforeRemove(t,e){e.data.shape&&(e._compoundParent&&!e._compoundParent.entity._destroying&&(this.system._removeCompoundChild(e._compoundParent,e.data.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),e._compoundParent=null,Ammo.destroy(e.data.shape),e.data.shape=null)}remove(t,e){const s=this.system.app;t.rigidbody&&t.rigidbody.body&&t.rigidbody.disableSimulation(),t.trigger&&(t.trigger.destroy(),delete t.trigger),s.scene.containsModel(e.model)&&(s.root.removeChild(e.model.graph),s.scene.removeModel(e.model))}clone(t,e){const s=this.system.store[t.getGuid()],i={enabled:s.data.enabled,type:s.data.type,halfExtents:[s.data.halfExtents.x,s.data.halfExtents.y,s.data.halfExtents.z],radius:s.data.radius,axis:s.data.axis,height:s.data.height,asset:s.data.asset,renderAsset:s.data.renderAsset,model:s.data.model,render:s.data.render};return this.system.addComponent(e,i)}}class YA extends Yi{createPhysicalShape(t,e){if(typeof Ammo!="undefined"){const s=e.halfExtents,i=new Ammo.btVector3(s?s.x:.5,s?s.y:.5,s?s.z:.5),n=new Ammo.btBoxShape(i);return Ammo.destroy(i),n}}}class $A extends Yi{createPhysicalShape(t,e){if(typeof Ammo!="undefined")return new Ammo.btSphereShape(e.radius)}}class KA extends Yi{createPhysicalShape(t,e){const s=e.axis!==void 0?e.axis:1,i=e.radius||.5,n=Math.max((e.height||2)-2*i,0);let r=null;if(typeof Ammo!="undefined")switch(s){case 0:r=new Ammo.btCapsuleShapeX(i,n);break;case 1:r=new Ammo.btCapsuleShape(i,n);break;case 2:r=new Ammo.btCapsuleShapeZ(i,n);break}return r}}class ZA extends Yi{createPhysicalShape(t,e){const s=e.axis!==void 0?e.axis:1,i=e.radius!==void 0?e.radius:.5,n=e.height!==void 0?e.height:1;let r=null,a=null;if(typeof Ammo!="undefined")switch(s){case 0:r=new Ammo.btVector3(n*.5,i,i),a=new Ammo.btCylinderShapeX(r);break;case 1:r=new Ammo.btVector3(i,n*.5,i),a=new Ammo.btCylinderShape(r);break;case 2:r=new Ammo.btVector3(i,i,n*.5),a=new Ammo.btCylinderShapeZ(r);break}return r&&Ammo.destroy(r),a}}class JA extends Yi{createPhysicalShape(t,e){const s=e.axis!==void 0?e.axis:1,i=e.radius!==void 0?e.radius:.5,n=e.height!==void 0?e.height:1;let r=null;if(typeof Ammo!="undefined")switch(s){case 0:r=new Ammo.btConeShapeX(i,n);break;case 1:r=new Ammo.btConeShape(i,n);break;case 2:r=new Ammo.btConeShapeZ(i,n);break}return r}}class QA extends Yi{beforeInitialize(t,e){}createAmmoMesh(t,e,s){let i;if(this.system._triMeshCache[t.id])i=this.system._triMeshCache[t.id];else{const h=t.vertexBuffer,c=h.getFormat();let d,u;for(let T=0;T<c.elements.length;T++){const b=c.elements[T];if(b.name===Ot){u=new Float32Array(h.lock(),b.offset),d=b.stride/4;break}}const f=[];t.getIndices(f);const m=t.primitive[0].count/3,p=new Ammo.btVector3,_=new Ammo.btVector3,g=new Ammo.btVector3;let w,v,x;const S=t.primitive[0].base;i=new Ammo.btTriangleMesh,this.system._triMeshCache[t.id]=i;for(let T=0;T<m;T++)w=f[S+T*3]*d,v=f[S+T*3+1]*d,x=f[S+T*3+2]*d,p.setValue(u[w],u[w+1],u[w+2]),_.setValue(u[v],u[v+1],u[v+2]),g.setValue(u[x],u[x+1],u[x+2]),i.addTriangle(p,_,g,!0);Ammo.destroy(p),Ammo.destroy(_),Ammo.destroy(g)}const n=!0,r=new Ammo.btBvhTriangleMeshShape(i,n),a=this.system._getNodeScaling(e);r.setLocalScaling(a),Ammo.destroy(a);const l=this.system._getNodeTransform(e);s.addChildShape(l,r),Ammo.destroy(l)}createPhysicalShape(t,e){if(typeof Ammo!="undefined"&&(e.model||e.render)){const s=new Ammo.btCompoundShape;if(e.model){const a=e.model.meshInstances;for(let l=0;l<a.length;l++)this.createAmmoMesh(a[l].mesh,a[l].node,s)}else if(e.render){const a=e.render.meshes;for(let l=0;l<a.length;l++)this.createAmmoMesh(a[l],qA,s)}const n=t.getWorldTransform().getScale(),r=new Ammo.btVector3(n.x,n.y,n.z);return s.setLocalScaling(r),Ammo.destroy(r),s}}recreatePhysicalShapes(t){const e=t.data;if((e.renderAsset||e.asset)&&t.enabled&&t.entity.enabled){this.loadAsset(t,e.renderAsset||e.asset,e.renderAsset?"render":"model");return}this.doRecreatePhysicalShape(t)}loadAsset(t,e,s){const i=t.data,n=this.system.app.assets,r=n.get(e);r?(r.ready(a=>{i[s]=a.resource,this.doRecreatePhysicalShape(t)}),n.load(r)):n.once("add:"+e,a=>{a.ready(l=>{i[s]=l.resource,this.doRecreatePhysicalShape(t)}),n.load(a)})}doRecreatePhysicalShape(t){const e=t.entity,s=t.data;s.model||s.render?(this.destroyShape(s),s.shape=this.createPhysicalShape(e,s),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):e.trigger?e.trigger.initialize(s):e.trigger=new zp(this.system.app,t,s)):(this.beforeRemove(e,t),this.remove(e,s))}updateTransform(t,e,s,i){if(t.shape){const r=t.entity.getWorldTransform().getScale(),a=t.shape.getLocalScaling();(r.x!==a.x()||r.y!==a.y()||r.z!==a.z())&&this.doRecreatePhysicalShape(t)}super.updateTransform(t,e,s,i)}destroyShape(t){if(!t.shape)return;const e=t.shape.getNumChildShapes();for(let s=0;s<e;s++){const i=t.shape.getChildShape(s);Ammo.destroy(i)}Ammo.destroy(t.shape),t.shape=null}remove(t,e){this.destroyShape(e),super.remove(t,e)}}class tM extends Yi{createPhysicalShape(t,e){if(typeof Ammo!="undefined")return new Ammo.btCompoundShape}_addEachDescendant(t){!t.collision||t.rigidbody||(t.collision._compoundParent=this,t!==this.entity&&t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendant(t){!t.collision||t.collision._compoundParent===this&&(t.collision._compoundParent=null,t!==this.entity&&!t.rigidbody&&t.collision.system.recreatePhysicalShapes(t.collision))}_updateEachDescendantTransform(t){!t.collision||t.collision._compoundParent!==this.collision._compoundParent||this.collision.system.updateCompoundChildTransform(t)}}class eM extends Bt{constructor(t){super(t);this.id="collision",this.ComponentType=Lp,this.DataType=VA,this.schema=Up,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}initializeComponentData(t,e,s){s=["type","halfExtents","radius","axis","height","shape","model","asset","render","renderAsset","enabled"];const i={};for(let a=0,l=s.length;a<l;a++){const h=s[a];i[h]=e[h]}let n;e.hasOwnProperty("asset")?(n=s.indexOf("model"),n!==-1&&s.splice(n,1),n=s.indexOf("render"),n!==-1&&s.splice(n,1)):e.hasOwnProperty("model")&&(n=s.indexOf("asset"),n!==-1&&s.splice(n,1)),i.type||(i.type=t.data.type),t.data.type=i.type,i.halfExtents&&Array.isArray(i.halfExtents)&&(i.halfExtents=new y(i.halfExtents[0],i.halfExtents[1],i.halfExtents[2]));const r=this._createImplementation(i.type);r.beforeInitialize(t,i),super.initializeComponentData(t,i,s),r.afterInitialize(t,i)}_createImplementation(t){if(this.implementations[t]===void 0){let e;switch(t){case"box":e=new YA(this);break;case"sphere":e=new $A(this);break;case"capsule":e=new KA(this);break;case"cylinder":e=new ZA(this);break;case"cone":e=new JA(this);break;case"mesh":e=new QA(this);break;case"compound":e=new tM(this);break}this.implementations[t]=e}return this.implementations[t]}_getImplementation(t){return this.implementations[t.collision.data.type]}cloneComponent(t,e){return this._getImplementation(t).clone(t,e)}onBeforeRemove(t,e){this.implementations[e.data.type].beforeRemove(t,e),e.onBeforeRemove()}onRemove(t,e){this.implementations[e.type].remove(t,e)}updateCompoundChildTransform(t){if(this._removeCompoundChild(t.collision._compoundParent,t.collision.data.shape),t.enabled&&t.collision.enabled){const e=this._getNodeTransform(t,t.collision._compoundParent.entity);t.collision._compoundParent.shape.addChildShape(e,t.collision.data.shape),Ammo.destroy(e)}}_removeCompoundChild(t,e){if(t.shape.removeChildShape)t.shape.removeChildShape(e);else{const s=t._getCompoundChildShapeIndex(e);s!==null&&t.shape.removeChildShapeByIndex(s)}}onTransformChanged(t,e,s,i){this.implementations[t.data.type].updateTransform(t,e,s,i)}changeType(t,e,s){this.implementations[e].beforeRemove(t.entity,t),this.implementations[e].remove(t.entity,t.data),this._createImplementation(s).reset(t,t.data)}recreatePhysicalShapes(t){this.implementations[t.data.type].recreatePhysicalShapes(t)}_calculateNodeRelativeTransform(t,e){if(t===e){const s=t.getWorldTransform().getScale();bl.setScale(s.x,s.y,s.z)}else this._calculateNodeRelativeTransform(t.parent,e),bl.mul(t.getLocalTransform())}_getNodeScaling(t){const s=t.getWorldTransform().getScale();return new Ammo.btVector3(s.x,s.y,s.z)}_getNodeTransform(t,e){let s,i;e?(this._calculateNodeRelativeTransform(t,e),s=XA,i=jA,bl.getTranslation(s),i.setFromMat4(bl)):(s=t.getPosition(),i=t.getRotation());const n=new Ammo.btTransform;n.setIdentity();const r=n.getOrigin();r.setValue(s.x,s.y,s.z);const a=new Ammo.btQuaternion;return a.setValue(i.x,i.y,i.z,i.w),n.setRotation(a),Ammo.destroy(a),Ammo.destroy(r),n}destroy(){for(const t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,super.destroy()}}st._buildAccessors(Lp.prototype,Up);class sM extends at{constructor(){super();this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);s!==-1&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class zn{constructor(t){this.func=t.func===void 0?Ri:t.func,this.ref=t.ref||0,this.readMask=t.readMask===void 0?255:t.readMask,this.writeMask=t.writeMask===void 0?255:t.writeMask,this.fail=t.fail||ze,this.zfail=t.zfail||ze,this.zpass=t.zpass||ze}clone(){return new zn({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})}}class iM{constructor(t,e,s){this._entity=t,this._element=t.element,this.model=new Ts,this.node=new xt,this.model.graph=this.node,this.mesh=e,this.meshInstance=new vt(this.mesh,s,this.node),this.meshInstance.name="ImageElement: "+t.name,this.meshInstance.castShadow=!1,this.meshInstance.receiveShadow=!1,this._meshDirty=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}destroy(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this.model=null,this.node=null,this.mesh=null,this.meshInstance=null,this._entity=null,this._element=null}setMesh(t){!this.meshInstance||(this.mesh=t,this.meshInstance.mesh=t,this.meshInstance.visible=!!t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=t),this.forceUpdateAabb())}setMask(t){if(!!this.meshInstance){if(t){this.unmaskMeshInstance=new vt(this.mesh,this.meshInstance.material,this.node),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance);for(const e in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(e,this.meshInstance.parameters[e].data)}else{const e=this.model.meshInstances.indexOf(this.unmaskMeshInstance);e>=0&&this.model.meshInstances.splice(e,1),this.unmaskMeshInstance=null}this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}}setMaterial(t){!this.meshInstance||(this.meshInstance.material=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=t))}setParameter(t,e){!this.meshInstance||(this.meshInstance.setParameter(t,e),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(t,e))}deleteParameter(t){!this.meshInstance||(this.meshInstance.deleteParameter(t),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(t))}setUnmaskDrawOrder(){if(!this.meshInstance)return;const t=function e(s){let i;const n=s.children,r=n.length;if(r){for(let l=0;l<r;l++)n[l].element&&(i=n[l]);if(!i)return null;const a=e(i);return a||i}return null};if(this.unmaskMeshInstance){const e=t(this._entity);e&&e.element?this.unmaskMeshInstance.drawOrder=e.element.drawOrder+e.element.getMaskOffset():this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}}setDrawOrder(t){!this.meshInstance||(this.meshInstance.drawOrder=t)}setCull(t){if(!this.meshInstance)return;const e=this._element;let s=null;t&&e._isScreenCulled()&&(s=function(i){return e.isVisibleForCamera(i)}),this.meshInstance.cull=t,this.meshInstance.isVisibleFunc=s,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=t,this.unmaskMeshInstance.isVisibleFunc=s)}setScreenSpace(t){!this.meshInstance||(this.meshInstance.screenSpace=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=t))}setLayer(t){!this.meshInstance||(this.meshInstance.layer=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=t))}forceUpdateAabb(t){!this.meshInstance||(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))}setAabbFunc(t){!this.meshInstance||(this.meshInstance._updateAabbFunc=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=t))}}class nM{constructor(t){this._element=t,this._entity=t.entity,this._system=t.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._spriteAsset=null,this._sprite=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new Z(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new H,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Z,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Z,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new iM(this._entity,this._defaultMesh,this._material),this._color=new j(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}destroy(){this.textureAsset=null,this.spriteAsset=null,this.materialAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)}_onResolutionChange(t){}_onParentResizeOrPivotChange(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onScreenChange(t,e){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onDrawOrderChange(t){this._renderable.setDrawOrder(t),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)}_hasUserMaterial(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1}_use9Slicing(){return this.sprite&&(this.sprite.renderMode===Xt||this.sprite.renderMode===Ut)}_updateMaterial(t){const e=!!this._mask,s=!!(this.sprite&&this.sprite.renderMode===Xt),i=!!(this.sprite&&this.sprite.renderMode===Ut);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(t,e,s,i)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(t),this._renderable.setLayer(t?Wg:Tu))}_createMesh(){const t=this._element,e=t.calculatedWidth,s=t.calculatedHeight,i=this._rect,n=new ArrayBuffer(4*8*4),r=new Float32Array(n);r[5]=1,r[6]=i.x,r[7]=1-i.y,r[8]=e,r[13]=1,r[14]=i.x+i.z,r[15]=1-i.y,r[16]=e,r[17]=s,r[21]=1,r[22]=i.x+i.z,r[23]=1-(i.y+i.w),r[25]=s,r[29]=1,r[30]=i.x,r[31]=1-(i.y+i.w);const a=[{semantic:Ot,components:3,type:wt},{semantic:pe,components:3,type:wt},{semantic:be,components:2,type:wt}],l=this._system.app.graphicsDevice,h=new re(l,a),c=new Ds(l,h,4,ve,n),d=new is(l);return d.vertexBuffer=c,d.primitive[0].type=Di,d.primitive[0].base=0,d.primitive[0].count=4,d.primitive[0].indexed=!1,d.aabb.setMinMax(y.ZERO,new y(e,s,0)),this._updateMesh(d),d}_updateMesh(t){const e=this._element,s=e.calculatedWidth,i=e.calculatedHeight,n=e._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),this.sprite&&(this.sprite.renderMode===Xt||this.sprite.renderMode===Ut)){const r=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],a=2/r.rect.z,l=2/r.rect.w;this._innerOffset.set(r.border.x*a,r.border.y*l,r.border.z*a,r.border.w*l);const h=this.sprite.atlas.texture;this._atlasRect.set(r.rect.x/h.width,r.rect.y/h.height,r.rect.z/h.width,r.rect.w/h.height);const c=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit,d=r.rect.z/c,u=r.rect.w/c;this._outerScale.set(Math.max(s,this._innerOffset.x*d),Math.max(i,this._innerOffset.y*u));let f=d,m=u;this._outerScale.x/=d,this._outerScale.y/=u,f*=U.clamp(s/(this._innerOffset.x*d),1e-4,1),m*=U.clamp(i/(this._innerOffset.y*u),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(f,m,1),this._renderable.node.setLocalPosition((.5-e.pivot.x)*s,(.5-e.pivot.y)*i,0))}else{const r=t.vertexBuffer,a=new Float32Array(r.lock()),l=e.pivot.x,h=e.pivot.y;a[0]=0-l*s,a[1]=0-h*i,a[8]=s-l*s,a[9]=0-h*i,a[16]=s-l*s,a[17]=i-h*i,a[24]=0-l*s,a[25]=i-h*i;let c=1,d=1,u=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){const p=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];p&&(u=p.rect,c=this._sprite.atlas.texture.width,d=this._sprite.atlas.texture.height)}a[6]=u.x/c,a[7]=1-u.y/d,a[14]=(u.x+u.z)/c,a[15]=1-u.y/d,a[22]=(u.x+u.z)/c,a[23]=1-(u.y+u.w)/d,a[30]=u.x/c,a[31]=1-(u.y+u.w)/d,r.unlock();const f=new y(0-l*s,0-h*i,0),m=new y(s-l*s,i-h*i,0);t.aabb.setMinMax(f,m),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}this._meshDirty=!1}_updateSprite(){let t=!1,e=null;this._sprite&&this._sprite.atlas&&(e=this._sprite.meshes[this.spriteFrame],t=this._sprite.renderMode===Xt||this._sprite.renderMode===Ut),this.mesh=t?e:this._defaultMesh,this.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform()),t}_toggleMask(){this._element._dirtifyMask();const t=this._element._isScreenSpace();this._updateMaterial(t),this._renderable.setMask(!!this._mask)}_onMaterialLoad(t){this.material=t.resource}_onMaterialAdded(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_bindMaterialAsset(t){!this._entity.enabled||(t.on("load",this._onMaterialLoad,this),t.on("change",this._onMaterialChange,this),t.on("remove",this._onMaterialRemove,this),t.resource?this._onMaterialLoad(t):this._system.app.assets.load(t))}_unbindMaterialAsset(t){t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)}_onMaterialChange(){}_onMaterialRemove(){}_onTextureAdded(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this),this._textureAsset===t.id&&this._bindTextureAsset(t)}_bindTextureAsset(t){!this._entity.enabled||(t.on("load",this._onTextureLoad,this),t.on("change",this._onTextureChange,this),t.on("remove",this._onTextureRemove,this),t.resource?this._onTextureLoad(t):this._system.app.assets.load(t))}_unbindTextureAsset(t){t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)}_onTextureLoad(t){this.texture=t.resource}_onTextureChange(t){}_onTextureRemove(t){}_onSpriteAssetAdded(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){!this._entity.enabled||(t.on("load",this._onSpriteAssetLoad,this),t.on("change",this._onSpriteAssetChange,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._system.app.assets.load(t))}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("change",this._onSpriteAssetChange,this),t.off("remove",this._onSpriteAssetRemove,this),t.data.textureAtlasAsset&&this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(!t||!t.resource)this.sprite=null;else if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset;if(e){const s=this._system.app.assets;s.off("load:"+e,this._onTextureAtlasLoad,this),s.once("load:"+e,this._onTextureAtlasLoad,this)}}}_onSpriteAssetChange(t){this._onSpriteAssetLoad(t)}_onSpriteAssetRemove(t){}_bindSprite(t){t.on("set:meshes",this._onSpriteMeshesChange,this),t.on("set:pixelsPerUnit",this._onSpritePpuChange,this),t.on("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.on("set:texture",this._onAtlasTextureChange,this)}_unbindSprite(t){t.off("set:meshes",this._onSpriteMeshesChange,this),t.off("set:pixelsPerUnit",this._onSpritePpuChange,this),t.off("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.off("set:texture",this._onAtlasTextureChange,this)}_onSpriteMeshesChange(){this._sprite&&(this._spriteFrame=U.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}_onSpritePpuChange(){this.sprite.renderMode!==oi&&this._pixelsPerUnit===null&&this._updateSprite()}_onAtlasTextureChange(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof rt?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._system.app.assets.get(e))}onEnable(){if(this._materialAsset){const t=this._system.app.assets.get(this._materialAsset);t&&t.resource!==this._material&&this._bindMaterialAsset(t)}if(this._textureAsset){const t=this._system.app.assets.get(this._textureAsset);t&&t.resource!==this._texture&&this._bindTextureAsset(t)}if(this._spriteAsset){const t=this._system.app.assets.get(this._spriteAsset);t&&t.resource!==this._sprite&&this._bindSpriteAsset(t)}this._element.addModelToLayers(this._renderable.model)}onDisable(){this._element.removeModelFromLayers(this._renderable.model)}_setStencil(t){this._renderable.meshInstance.stencilFront=t,this._renderable.meshInstance.stencilBack=t;let e=0;if(this._element.maskedBy&&(e=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance){const s=new zn({ref:e+1,func:Ya,zpass:Ay});this._renderable.unmaskMeshInstance.stencilFront=s,this._renderable.unmaskMeshInstance.stencilBack=s}}set color(t){const e=t.r,s=t.g,i=t.b;(this._color.r!==e||this._color.g!==s||this._color.b!==i)&&(this._color.r=e,this._color.g=s,this._color.b=i,this._colorUniform[0]=e,this._colorUniform[1]=s,this._colorUniform[2]=i,this._renderable.setParameter("material_emissive",this._colorUniform)),this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(t){t!==this._color.a&&(this._color.a=t,this._renderable.setParameter("material_opacity",t)),this._element&&this._element.fire("set:opacity",t)}get opacity(){return this._color.a}set rect(t){let e,s,i,n;t instanceof Z?(e=t.x,s=t.y,i=t.z,n=t.w):(e=t[0],s=t[1],i=t[2],n=t[3]),!(e===this._rect.x&&s===this._rect.y&&i===this._rect.z&&n===this._rect.w)&&(this._rect.set(e,s,i,n),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}get rect(){return this._rect}set material(t){if(this._material!==t){if(!t){const e=this._element._isScreenSpace();this.mask?t=e?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t=e?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=t,t&&(this._renderable.setMaterial(t),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}get material(){return this._material}set materialAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof rt&&(s=t.id),this._materialAsset!==s){if(this._materialAsset){e.off("add:"+this._materialAsset,this._onMaterialAdded,this);const i=e.get(this._materialAsset);i&&(i.off("load",this._onMaterialLoad,this),i.off("change",this._onMaterialChange,this),i.off("remove",this._onMaterialRemove,this))}if(this._materialAsset=s,this._materialAsset){const i=e.get(this._materialAsset);i?this._bindMaterialAsset(i):(this.material=null,e.on("add:"+this._materialAsset,this._onMaterialAdded,this))}else this.material=null}}get materialAsset(){return this._materialAsset}set texture(t){if(this._texture!==t){if(this._textureAsset){const e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==t&&(this.textureAsset=null)}this._texture=t,t?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}get texture(){return this._texture}set textureAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof rt&&(s=t.id),this._textureAsset!==s){if(this._textureAsset){e.off("add:"+this._textureAsset,this._onTextureAdded,this);const i=e.get(this._textureAsset);i&&(i.off("load",this._onTextureLoad,this),i.off("change",this._onTextureChange,this),i.off("remove",this._onTextureRemove,this))}if(this._textureAsset=s,this._textureAsset){const i=e.get(this._textureAsset);i?this._bindTextureAsset(i):(this.texture=null,e.on("add:"+this._textureAsset,this._onTextureAdded,this))}else this.texture=null}}get textureAsset(){return this._textureAsset}set spriteAsset(t){const e=this._system.app.assets;let s=t;if(t instanceof rt&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){e.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);const i=e.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=e.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}this._element&&this._element.fire("set:spriteAsset",s)}get spriteAsset(){return this._spriteAsset}set sprite(t){if(this._sprite!==t){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){const e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==t&&(this.spriteAsset=null)}this._sprite=t,this._sprite&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=U.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}get sprite(){return this._sprite}set spriteFrame(t){const e=this._spriteFrame;this._sprite?this._spriteFrame=U.clamp(t,0,this._sprite.frameKeys.length-1):this._spriteFrame=t,this._spriteFrame!==e&&this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",t)}get spriteFrame(){return this._spriteFrame}set mesh(t){this._renderable.setMesh(t),this._defaultMesh===t?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}get mesh(){return this._renderable.mesh}set mask(t){this._mask!==t&&(this._mask=t,this._toggleMask())}get mask(){return this._mask}set pixelsPerUnit(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this._sprite&&(this._sprite.renderMode===Xt||this._sprite.renderMode===Ut)&&this._updateSprite())}get pixelsPerUnit(){return this._pixelsPerUnit}get aabb(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}class rM extends at{constructor(t){super();this._app=t,t.i18n.on("set:locale",this._onSetLocale,this),this._autoLoad=!1,this._disableLocalization=!1,this._defaultAsset=null,this._localizedAsset=null}set defaultAsset(t){const e=t instanceof rt?t.id:t;this._defaultAsset!==e&&(this._defaultAsset&&this._unbindDefaultAsset(),this._defaultAsset=e,this._defaultAsset&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}get defaultAsset(){return this._defaultAsset}set localizedAsset(t){const e=t instanceof rt?t.id:t;this._localizedAsset!==e&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=e,this._localizedAsset&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)))}get localizedAsset(){return this._localizedAsset}set autoLoad(t){this._autoLoad!==t&&(this._autoLoad=t,this._autoLoad&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset()))}get autoLoad(){return this._autoLoad}set disableLocalization(t){this._disableLocalization!==t&&(this._disableLocalization=t,this._onSetLocale(this._app.i18n.locale))}get disableLocalization(){return this._disableLocalization}_bindDefaultAsset(){const t=this._app.assets.get(this._defaultAsset);t?this._onDefaultAssetAdd(t):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)}_unbindDefaultAsset(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);const t=this._app.assets.get(this._defaultAsset);!t||(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleRemove,this),t.off("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetAdd(t){this._defaultAsset===t.id&&(t.on("add:localized",this._onLocaleAdd,this),t.on("remove:localized",this._onLocaleRemove,this),t.once("remove",this._onDefaultAssetRemove,this))}_onDefaultAssetRemove(t){this._defaultAsset===t.id&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))}_bindLocalizedAsset(){if(!this._autoLoad)return;const t=this._app.assets.get(this._localizedAsset);!t||(t.on("load",this._onLocalizedAssetLoad,this),t.on("change",this._onLocalizedAssetChange,this),t.on("remove",this._onLocalizedAssetRemove,this),t.resource?this._onLocalizedAssetLoad(t):this._app.assets.load(t))}_unbindLocalizedAsset(){const t=this._app.assets.get(this._localizedAsset);!t||(t.off("load",this._onLocalizedAssetLoad,this),t.off("change",this._onLocalizedAssetChange,this),t.off("remove",this._onLocalizedAssetRemove,this))}_onLocalizedAssetAdd(t){this._localizedAsset===t.id&&this._bindLocalizedAsset()}_onLocalizedAssetLoad(t){this.fire("load",t)}_onLocalizedAssetChange(t,e,s,i){this.fire("change",t,e,s,i)}_onLocalizedAssetRemove(t){this._localizedAsset===t.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",t)}_onLocaleAdd(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onLocaleRemove(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)}_onSetLocale(t){if(!this._defaultAsset){this.localizedAsset=null;return}const e=this._app.assets.get(this._defaultAsset);if(!e||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}const s=e.getLocalizedAssetId(t);if(!s){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=s}destroy(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()}}const la=0,Un=1,ld=2,Np=3,hd=4,cd=5,dd=6,ud=7,Vp=8,aM=` 	
\r\v\f`,oM=/[A-Z|a-z|0-9|_|-|/]/;class lM{constructor(t){this._symbols=t,this._index=0,this._last=0,this._cur=this._symbols.length>0?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}read(){let t=this._read();for(;t===Vp;)t=this._read();return t!==la&&t!==Un&&(this._last=this._index),t}buf(){return this._buf}last(){return this._last}error(){return this._error}debugPrint(){const t=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];let e=this.read(),s="";for(;s+=(s.length>0?`
`:"")+t[e]+" '"+this.buf().join("")+"'",!(e===la||e===Un);)e=this.read();return s}_read(){return this._buf=[],this._eof()?la:this._mode==="text"?this._text():this._tag()}_text(){for(;;)switch(this._cur){case null:return this._buf.length>0?ld:la;case"[":return this._mode="tag",this._buf.length>0?ld:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\");break}break;default:this._store();break}}_tag(){switch(this._cur){case null:return this._error="unexpected end of input reading tag",Un;case"[":return this._store(),Np;case"]":return this._store(),this._mode="text",hd;case"=":return this._store(),cd;case" ":case"	":case`
`:case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",Un)}}_whitespace(){for(this._store();aM.indexOf(this._cur)!==-1;)this._store();return Vp}_string(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",Un;case'"':return this._next(),dd;default:this._store();break}}_identifier(){for(this._store();this._cur!==null&&this._isIdentifierSymbol(this._cur);)this._store();return ud}_isIdentifierSymbol(t){return t.length===1&&t.match(oM)!==null}_eof(){return this._cur===null}_next(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur}_store(){return this._buf.push(this._cur),this._next()}_output(t){this._buf.push(t)}}class hM{constructor(t){this._scanner=new lM(t),this._error=null}parse(t,e){for(;;)switch(this._scanner.read()){case la:return!0;case Un:return!1;case ld:Array.prototype.push.apply(t,this._scanner.buf());break;case Np:if(!this._parseTag(t,e))return!1;break;default:return!1}}error(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"}_parseTag(t,e){let s=this._scanner.read();if(s!==ud)return this._error="expected identifier",!1;const i=this._scanner.buf().join("");if(i[0]==="/"){for(let r=e.length-1;r>=0;--r)if(i==="/"+e[r].name&&e[r].end===null)return e[r].end=t.length,s=this._scanner.read(),s!==hd?(this._error="expected close bracket",!1):!0;return this._error="failed to find matching tag",!1}const n={name:i,value:null,attributes:{},start:t.length,end:null};if(s=this._scanner.read(),s===cd){if(s=this._scanner.read(),s!==dd)return this._error="expected string",!1;n.value=this._scanner.buf().join(""),s=this._scanner.read()}for(;;){switch(s){case hd:return e.push(n),!0;case ud:{const r=this._scanner.buf().join("");if(s=this._scanner.read(),s!==cd)return this._error="expected equals",!1;if(s=this._scanner.read(),s!==dd)return this._error="expected string",!1;const a=this._scanner.buf().join("");n.attributes[r]=a;break}default:return this._error="expected close bracket or identifier",!1}s=this._scanner.read()}}}function Wp(o,t){for(const e in t){if(!t.hasOwnProperty(e))continue;const s=t[e];s instanceof Object?(o.hasOwnProperty(e)||(o[e]={}),Wp(o[e],t[e])):o[e]=s}}function cM(o){if(o.length===0)return null;const t={};for(let e=0;e<o.length;++e){const s=o[e],i={};i[s.name]={value:s.value,attributes:s.attributes},Wp(t,i)}return t}function dM(o,t){if(o.length===0)return null;const e={};for(let c=0;c<o.length;++c){const d=o[c];e.hasOwnProperty(d.start)?e[d.start].open===null?e[d.start].open=[d]:e[d.start].open.push(d):e[d.start]={open:[d],close:null},e.hasOwnProperty(d.end)?e[d.end].close===null?e[d.end].close=[d]:e[d.end].close.push(d):e[d.end]={open:null,close:[d]}}let s=[];function i(c){s=s.filter(function(d){return c.find(function(u){return u===d})===void 0})}function n(c){for(let d=0;d<c.length;++d)s.push(c[d])}const r=Object.keys(e).sort(function(c,d){return c-d}),a=[];for(let c=0;c<r.length;++c){const d=e[r[c]];d.close!==null&&i(d.close),d.open!==null&&n(d.open),a.push({start:r[c],tags:cM(s)})}const l=[];let h=null;for(let c=0;c<a.length;++c){const d=a[c];for(;l.length<d.start;)l.push(h?h.tags:null);h=d}for(;l.length<t;)l.push(null);return l}function uM(o){const t=new hM(o),e=[],s=[];if(!t.parse(e,s))return console.warn(t.error()),{symbols:o,tags:null};const i=s.find(function(r){return r.end===null});if(i)return console.warn(`Markup error: found unclosed tag='${i.name}'`),{symbols:o,tags:null};const n=dM(s,e.length);return{symbols:e,tags:n}}class fM{static evaluate(t){return uM(t)}}class mM{constructor(){this.count=0,this.quad=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null}}const Gp=/^[\r\n]$/,pM=/^[ \t]$/,Hp=/^[ \t\-]|[\u200b]$/,_M=/^[a-z0-9]$/i,Xp=/^[\u1100-\u11ff]|[\u3000-\u9fff]|[\ua960-\ua97f]|[\uac00-\ud7ff]$/,gM=/^[〕〉》」』】〙〗〟ヽヾーァィゥェォッャュョヮヵヶぁぃぅぇぉっゃゅょゎゕゖㇰㇱㇲㇳㇴㇵㇶㇷㇸㇹㇺㇻㇼㇽㇾㇿ々〻]$/,yM=["\u200B","\u061C","\u200E","\u200F","\u202A","\u202B","\u202C","\u202D","\u202E","\u2066","\u2067","\u2068","\u2069"],xM={width:0,height:0,xadvance:0,xoffset:0,yoffset:0};class vM{constructor(t){this._element=t,this._system=t.system,this._entity=t.entity,this._text="",this._symbols=[],this._colorPalette=[],this._symbolColors=null,this._i18nKey=null,this._fontAsset=new rM(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new j(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMinY=0,this._fontMaxY=0,this._originalFontSize=32,this._maxFontSize=32,this._minFontSize=8,this._autoFitWidth=!1,this._autoFitHeight=!1,this._maxLines=-1,this._lineHeight=32,this._scaledLineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new H(.5,.5),this._autoWidth=!0,this._autoHeight=!0,this.width=0,this.height=0,this._node=new xt,this._model=new Ts,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new gt,this._noResize=!1,this._currentMaterialType=null,this._maskedMaterialSrc=null,this._rtlReorder=!1,this._unicodeConverter=!1,this._rtl=!1,this._outlineColor=new j(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new j(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new H(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),t.on("resize",this._onParentResize,this),t.on("set:screen",this._onScreenChange,this),t.on("screen:set:screenspace",this._onScreenSpaceChange,this),t.on("set:draworder",this._onDrawOrderChange,this),t.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeStart=0,this._rangeEnd=0}destroy(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)}_onParentResize(t,e){this._noResize||this._font&&this._updateText()}_onScreenChange(t){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)}_onScreenSpaceChange(t){this._updateMaterial(t)}_onDrawOrderChange(t){if(this._drawOrder=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++)this._model.meshInstances[e].drawOrder=t}_onPivotChange(t){this._font&&this._updateText()}_onLocaleSet(t){if(!!this._i18nKey){if(this.fontAsset){const e=this._system.app.assets.get(this.fontAsset);(!e||!e.resource||e.resource!==this._font)&&(this.font=null)}this._resetLocalizedText()}}_onLocalizationData(t,e){this._i18nKey&&e[this._i18nKey]&&this._resetLocalizedText()}_resetLocalizedText(){this._setText(this._system.app.i18n.getText(this._i18nKey))}_setText(t){if(this.unicodeConverter){const e=this._system.getUnicodeConverter();e?t=e(t):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==t&&(this._font&&this._updateText(t),this._text=t)}_updateText(t){let e;if(t===void 0&&(t=this._text),this._symbols=an.getSymbols(t.normalize?t.normalize("NFC"):t),this._symbols.length===0&&(this._symbols=[" "]),this._enableMarkup){const h=fM.evaluate(this._symbols);this._symbols=h.symbols,e=h.tags}if(this._rtlReorder){const h=this._system.app.systems.element.getRtlReorder();if(h){const c=h(this._symbols);this._rtl=c.rtl,this._symbols=c.mapping.map(function(d){return this._symbols[d]},this),e&&(e=c.mapping.map(function(d){return e[d]}))}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=!1;if(e){const h={};this._colorPalette=[Math.round(this._color.r*255),Math.round(this._color.g*255),Math.round(this._color.b*255)],this._symbolColors=[],h[this._color.toString(!1).toLowerCase()]=0;for(let c=0,d=this._symbols.length;c<d;++c){const u=e[c];let f=0;if(u&&u.color&&u.color.value){const m=u.color.value;if(m.length===7&&m[0]==="#"){const p=m.substring(1).toLowerCase();h.hasOwnProperty(p)?f=h[p]:/^([0-9a-f]{2}){3}$/.test(p)&&(f=this._colorPalette.length/3,h[p]=f,this._colorPalette.push(parseInt(p.substring(0,2),16)),this._colorPalette.push(parseInt(p.substring(2,4),16)),this._colorPalette.push(parseInt(p.substring(4,6),16)))}}this._symbolColors.push(f)}}else this._colorPalette=[],this._symbolColors=null;const s=this._calculateCharsPerTexture();let i=!1;const n=this._element,r=n._isScreenSpace(),a=n._isScreenCulled(),l=function(c){return n.isVisibleForCamera(c)};for(let h=0,c=this._meshInfo.length;h<c;h++){const d=s[h]||0,u=this._meshInfo[h];if(u.count!==d){if(i||(n.removeModelFromLayers(this._model),i=!0),u.count=d,u.positions.length=u.normals.length=d*3*4,u.indices.length=d*3*2,u.uvs.length=d*2*4,u.colors.length=d*4*4,u.meshInstance&&this._removeMeshInstance(u.meshInstance),d===0){u.meshInstance=null;continue}for(let _=0;_<d;_++)u.indices[_*3*2+0]=_*4,u.indices[_*3*2+1]=_*4+1,u.indices[_*3*2+2]=_*4+3,u.indices[_*3*2+3]=_*4+2,u.indices[_*3*2+4]=_*4+3,u.indices[_*3*2+5]=_*4+1,u.normals[_*4*3+0]=0,u.normals[_*4*3+1]=0,u.normals[_*4*3+2]=-1,u.normals[_*4*3+3]=0,u.normals[_*4*3+4]=0,u.normals[_*4*3+5]=-1,u.normals[_*4*3+6]=0,u.normals[_*4*3+7]=0,u.normals[_*4*3+8]=-1,u.normals[_*4*3+9]=0,u.normals[_*4*3+10]=0,u.normals[_*4*3+11]=-1;const f=Os(this._system.app.graphicsDevice,u.positions,{uvs:u.uvs,normals:u.normals,colors:u.colors,indices:u.indices}),m=new vt(f,this._material,this._node);m.name="Text Element: "+this._entity.name,m.castShadow=!1,m.receiveShadow=!1,m.cull=!r,m.screenSpace=r,m.drawOrder=this._drawOrder,a&&(m.cull=!0,m.isVisibleFunc=l),this._setTextureParams(m,this._font.textures[h]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),m.setParameter("material_emissive",this._colorUniform),m.setParameter("material_opacity",this._color.a),m.setParameter("font_sdfIntensity",this._font.intensity),m.setParameter("font_pxrange",this._getPxRange(this._font)),m.setParameter("font_textureWidth",this._font.data.info.maps[h].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,m.setParameter("outline_color",this._outlineColorUniform),m.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,m.setParameter("shadow_color",this._shadowColorUniform);const p=-this._font.data.info.maps[h].width/this._font.data.info.maps[h].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=p*this._shadowOffsetScale*this._shadowOffset.y,m.setParameter("shadow_offset",this._shadowOffsetUniform),u.meshInstance=m,this._model.meshInstances.push(m)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),i&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()}_removeMeshInstance(t){t.destroy();const e=this._model.meshInstances.indexOf(t);e!==-1&&this._model.meshInstances.splice(e,1)}_setMaterial(t){if(this._material=t,this._model)for(let e=0,s=this._model.meshInstances.length;e<s;e++){const i=this._model.meshInstances[e];i.material=t}}_updateMaterial(t){const e=this._element,s=e._isScreenCulled(),i=function(a){return e.isVisibleForCamera(a)},n=this._font&&this._font.type===il;if(this._material=this._system.getTextElementMaterial(t,n),this._model)for(let r=0,a=this._model.meshInstances.length;r<a;r++){const l=this._model.meshInstances[r];l.cull=!t,l.material=this._material,l.screenSpace=t,s?(l.cull=!0,l.isVisibleFunc=i):l.isVisibleFunc=null}}_isWordBoundary(t){return Hp.test(t)}_isValidNextChar(t){return t!==null&&!gM.test(t)}_isNextCJKBoundary(t,e){return Xp.test(t)&&(Hp.test(e)||_M.test(e))}_isNextCJKWholeWord(t){return Xp.test(t)}_updateMeshes(){const t=this._font.data,e=this,s=Math.min(this._minFontSize,this._maxFontSize),i=this._maxFontSize,n=this._shouldAutoFit();n&&(this._fontSize=this._maxFontSize);const r=32,a=this._symbols.length;let l=0,h=0,c=0,d=0,u=1,f=0,m=0,p=0,_=0,g=0,w=0;const v=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;let x=this._element.calculatedWidth;(this.autoWidth&&!v||!this._wrapLines)&&(x=Number.POSITIVE_INFINITY);let S=0,T=0,b,C,M,E;function D(A,R,L){e._lineWidths.push(Math.abs(L));const O=p>R?R+1:p,z=p>R?p+1:R,W=A.slice(O,z);if(w){let K=W.length;for(;K--&&w>0;)Gp.test(W[K])&&(W.splice(K,1),w--)}e._lineContents.push(W.join("")),l=0,h-=e._scaledLineHeight,u++,_=0,g=0,w=0,f=0,p=R}let I=!0;for(;I;){I=!1,n?this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._scaledLineHeight=this._lineHeight,this.width=0,this.height=0,this._lineWidths=[],this._lineContents=[],l=0,h=0,c=0,d=0,u=1,f=0,m=0,p=0,_=0,g=0,w=0;const A=this._fontSize/r;S=this._fontMinY*A,T=this._fontMaxY*A;for(let z=0;z<this._meshInfo.length;z++)this._meshInfo[z].quad=0,this._meshInfo[z].lines={};let R=255,L=255,O=255;for(let z=0;z<a;z++){if(b=this._symbols[z],E=z+1>=a?null:this._symbols[z+1],Gp.test(b)){w++,(!this._wrapLines||this._maxLines<0||u<this._maxLines)&&(D(this._symbols,z,d),m=z+1,p=z+1);continue}let K=0,V=0,P=0,B=1,Y,it;if(C=t.chars[b],!C)if(yM.indexOf(b)!==-1)C=xM;else if(t.chars[" "])C=t.chars[" "];else for(const ie in t.chars){C=t.chars[ie];break}if(C){let ie=0;if(g>0){const ya=this._font.data.kerning;if(ya){const xa=ya[an.getCodePoint(this._symbols[z-1])||0];xa&&(ie=xa[an.getCodePoint(this._symbols[z])||0]||0)}}Y=C.scale||1,it=(C.width+C.height)/2,B=A*it/Y,P=(C.xadvance+ie)*A,K=(C.xoffset-ie)*A,V=C.yoffset*A}else console.error(`Couldn't substitute missing character: '${b}'`);const Tt=pM.test(b),$=this._meshInfo[C&&C.map||0],kt=l+this._spacing*P;if(kt>x&&g>0&&!Tt&&(this._maxLines<0||u<this._maxLines))if(_===0)m=z,D(this._symbols,z,d);else{const ie=Math.max(z-m,0);if(this._meshInfo.length<=1)$.lines[u-1]-=ie,$.quad-=ie;else{const ya=m,xa=z;for(let $l=ya;$l<xa;$l++){const og=this._symbols[$l],$d=t.chars[og],Kd=this._meshInfo[$d&&$d.map||0];Kd.lines[u-1]-=1,Kd.quad-=1}}z-=ie+1,D(this._symbols,m,f);continue}M=$.quad,$.lines[u-1]=M;let Oe=l-K,er=Oe+B;const Yl=h-V,Yd=Yl+B;if(this._rtl){const ie=B-K-this._spacing*P-K;Oe-=ie,er-=ie}$.positions[M*4*3+0]=Oe,$.positions[M*4*3+1]=Yl,$.positions[M*4*3+2]=c,$.positions[M*4*3+3]=er,$.positions[M*4*3+4]=Yl,$.positions[M*4*3+5]=c,$.positions[M*4*3+6]=er,$.positions[M*4*3+7]=Yd,$.positions[M*4*3+8]=c,$.positions[M*4*3+9]=Oe,$.positions[M*4*3+10]=Yd,$.positions[M*4*3+11]=c,this.width=Math.max(this.width,kt);let Js;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(Js=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),Js=U.clamp(Js,s,i),Js!==this._element.fontSize)){this._fontSize=Js,I=!0;break}if(this.height=Math.max(this.height,T-(h+S)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(Js=U.clamp(this._fontSize-1,s,i),Js!==this._element.fontSize)){this._fontSize=Js,I=!0;break}l+=this._spacing*P,Tt||(d=l),(this._isWordBoundary(b)||this._isValidNextChar(E)&&(this._isNextCJKBoundary(b,E)||this._isNextCJKWholeWord(E)))&&(_++,f=d,m=z+1),g++;const Qs=this._getUv(b);if($.uvs[M*4*2+0]=Qs[0],$.uvs[M*4*2+1]=1-Qs[1],$.uvs[M*4*2+2]=Qs[2],$.uvs[M*4*2+3]=1-Qs[1],$.uvs[M*4*2+4]=Qs[2],$.uvs[M*4*2+5]=1-Qs[3],$.uvs[M*4*2+6]=Qs[0],$.uvs[M*4*2+7]=1-Qs[3],this._symbolColors){const ie=this._symbolColors[z]*3;R=this._colorPalette[ie],L=this._colorPalette[ie+1],O=this._colorPalette[ie+2]}$.colors[M*4*4+0]=R,$.colors[M*4*4+1]=L,$.colors[M*4*4+2]=O,$.colors[M*4*4+3]=255,$.colors[M*4*4+4]=R,$.colors[M*4*4+5]=L,$.colors[M*4*4+6]=O,$.colors[M*4*4+7]=255,$.colors[M*4*4+8]=R,$.colors[M*4*4+9]=L,$.colors[M*4*4+10]=O,$.colors[M*4*4+11]=255,$.colors[M*4*4+12]=R,$.colors[M*4*4+13]=L,$.colors[M*4*4+14]=O,$.colors[M*4*4+15]=255,$.quad++}I||p<a&&D(this._symbols,a,l)}this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1;const k=this._element.pivot.x,N=this._element.pivot.y,X=this._alignment.x,q=this._alignment.y;for(let A=0;A<this._meshInfo.length;A++){if(this._meshInfo[A].count===0)continue;let R=0;for(const W in this._meshInfo[A].lines){const K=this._meshInfo[A].lines[W],V=this._lineWidths[parseInt(W,10)],P=-k*this._element.calculatedWidth+X*(this._element.calculatedWidth-V)*(this._rtl?-1:1),B=(1-N)*this._element.calculatedHeight-T-(1-q)*(this._element.calculatedHeight-this.height);for(let Y=R;Y<=K;Y++)this._meshInfo[A].positions[Y*4*3]+=P,this._meshInfo[A].positions[Y*4*3+3]+=P,this._meshInfo[A].positions[Y*4*3+6]+=P,this._meshInfo[A].positions[Y*4*3+9]+=P,this._meshInfo[A].positions[Y*4*3+1]+=B,this._meshInfo[A].positions[Y*4*3+4]+=B,this._meshInfo[A].positions[Y*4*3+7]+=B,this._meshInfo[A].positions[Y*4*3+10]+=B;if(this._rtl)for(let Y=R;Y<=K;Y++){const it=Y*4*3;for(let kt=0;kt<4;++kt)this._meshInfo[A].positions[it+kt*3]=this._element.calculatedWidth-this._meshInfo[A].positions[it+kt*3]+P*2;const Tt=this._meshInfo[A].positions[it+3],$=this._meshInfo[A].positions[it+6];this._meshInfo[A].positions[it+3]=this._meshInfo[A].positions[it+0],this._meshInfo[A].positions[it+6]=this._meshInfo[A].positions[it+9],this._meshInfo[A].positions[it+0]=Tt,this._meshInfo[A].positions[it+9]=$}R=K+1}const L=this._meshInfo[A].count*4,O=this._meshInfo[A].quad*4,z=new Nr(this._meshInfo[A].meshInstance.mesh.vertexBuffer);for(let W=0;W<L;W++)W>=O?(z.element[Ot].set(0,0,0),z.element[be].set(0,0),z.element[de].set(0,0,0,0)):(z.element[Ot].set(this._meshInfo[A].positions[W*3+0],this._meshInfo[A].positions[W*3+1],this._meshInfo[A].positions[W*3+2]),z.element[be].set(this._meshInfo[A].uvs[W*2+0],this._meshInfo[A].uvs[W*2+1]),z.element[de].set(this._meshInfo[A].colors[W*4+0],this._meshInfo[A].colors[W*4+1],this._meshInfo[A].colors[W*4+2],this._meshInfo[A].colors[W*4+3])),z.next();z.end(),this._meshInfo[A].meshInstance.mesh.aabb.compute(this._meshInfo[A].positions),this._meshInfo[A].meshInstance._aabbVer=-1}this._aabbDirty=!0}_onFontRender(){this.font=this._font}_onFontLoad(t){this.font!==t.resource&&(this.font=t.resource)}_onFontChange(t,e,s,i){if(e==="data"){this._font.data=s;const n=this._font.data.info.maps.length;for(let r=0;r<n;r++){if(!this._meshInfo[r])continue;const a=this._meshInfo[r].meshInstance;a&&(a.setParameter("font_sdfIntensity",this._font.intensity),a.setParameter("font_pxrange",this._getPxRange(this._font)),a.setParameter("font_textureWidth",this._font.data.info.maps[r].width))}}}_onFontRemove(t){}_setTextureParams(t,e){this._font&&(this._font.type===il?(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap"),t.setParameter("texture_msdfMap",e)):this._font.type===AT&&(t.deleteParameter("texture_msdfMap"),t.setParameter("texture_emissiveMap",e),t.setParameter("texture_opacityMap",e)))}_getPxRange(t){const e=Object.keys(this._font.data.chars);for(let s=0;s<e.length;s++){const i=this._font.data.chars[e[s]];if(i.range)return(i.scale||1)*i.range}return 2}_getUv(t){const e=this._font.data;if(!e.chars[t]){const f=" ";return e.chars[f]?this._getUv(f):[0,0,0,0]}const s=e.chars[t].map,i=e.info.maps[s].width,n=e.info.maps[s].height,r=e.chars[t].x,a=e.chars[t].y,l=r,h=a,c=r+e.chars[t].width,d=a-e.chars[t].height,u=1-e.chars[t].height/n;return[l/i,u-h/n,c/i,u-d/n]}onEnable(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)}onDisable(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)}_setStencil(t){if(this._model){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].stencilFront=t,e[s].stencilBack=t}}_shouldAutoFitWidth(){return this._autoFitWidth&&!this._autoWidth}_shouldAutoFitHeight(){return this._autoFitHeight&&!this._autoHeight}_shouldAutoFit(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight}_calculateCharsPerTexture(t){const e={};t===void 0&&(t=this._symbols.length);for(let s=0,i=t;s<i;s++){const n=this._symbols[s];let r=this._font.data.chars[n];r||(r=this._font.data.chars[" "],r||(r=this._font.data.chars[Object.keys(this._font.data.chars)[0]]));const a=r.map;e[a]?e[a]++:e[a]=1}return e}_updateRenderRange(){const t=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart),e=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd);for(let s=0,i=this._meshInfo.length;s<i;s++){const n=t[s]||0,r=e[s]||0,a=this._meshInfo[s].meshInstance;if(a){const l=a.mesh;l&&(l.primitive[0].base=n*3*2,l.primitive[0].count=(r-n)*3*2)}}}set text(t){this._i18nKey=null;const e=t!=null&&t.toString()||"";this._setText(e)}get text(){return this._text}set key(t){const e=t!==null?t.toString():null;this._i18nKey!==e&&(this._i18nKey=e,e?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}get key(){return this._i18nKey}set color(t){const e=t.r,s=t.g,i=t.b;if(this._color.r!==e||this._color.g!==s||this._color.b!==i)if(this._color.r=e,this._color.g=s,this._color.b=i,this._symbolColors)this._font&&this._updateText();else{this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b;for(let n=0,r=this._model.meshInstances.length;n<r;n++)this._model.meshInstances[n].setParameter("material_emissive",this._colorUniform)}this._element&&this._element.fire("set:color",this._color)}get color(){return this._color}set opacity(t){if(this._color.a!==t&&(this._color.a=t,this._model))for(let e=0,s=this._model.meshInstances.length;e<s;e++)this._model.meshInstances[e].setParameter("material_opacity",t);this._element&&this._element.fire("set:opacity",t)}get opacity(){return this._color.a}set lineHeight(t){const e=this._lineHeight;this._lineHeight=t,this._scaledLineHeight=t,e!==t&&this._font&&this._updateText()}get lineHeight(){return this._lineHeight}set wrapLines(t){const e=this._wrapLines;this._wrapLines=t,e!==t&&this._font&&this._updateText()}get wrapLines(){return this._wrapLines}get lines(){return this._lineContents}set spacing(t){const e=this._spacing;this._spacing=t,e!==t&&this._font&&this._updateText()}get spacing(){return this._spacing}set fontSize(t){const e=this._fontSize;this._fontSize=t,this._originalFontSize=t,e!==t&&this._font&&this._updateText()}get fontSize(){return this._fontSize}set fontAsset(t){this._fontAsset.defaultAsset=t}get fontAsset(){return this._fontAsset.localizedAsset}set font(t){let e;if(this._font&&(e=this._font.type,this._font.off&&this._font.off("render",this._onFontRender,this)),this._font=t,this._fontMinY=0,this._fontMaxY=0,!t)return;const s=this._font.data;for(const n in s.chars){const r=s.chars[n];r.bounds&&(this._fontMinY=Math.min(this._fontMinY,r.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,r.bounds[3]))}if(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),t.type!==e){const n=this._element._isScreenSpace();this._updateMaterial(n)}for(let n=0,r=this._font.textures.length;n<r;n++)if(!this._meshInfo[n])this._meshInfo[n]=new mM;else{const a=this._meshInfo[n].meshInstance;a&&(a.setParameter("font_sdfIntensity",this._font.intensity),a.setParameter("font_pxrange",this._getPxRange(this._font)),a.setParameter("font_textureWidth",this._font.data.info.maps[n].width),this._setTextureParams(a,this._font.textures[n]))}let i=!1;for(let n=this._font.textures.length;n<this._meshInfo.length;n++)this._meshInfo[n].meshInstance&&(i||(this._element.removeModelFromLayers(this._model),i=!0),this._removeMeshInstance(this._meshInfo[n].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}get font(){return this._font}set alignment(t){t instanceof H?this._alignment.set(t.x,t.y):this._alignment.set(t[0],t[1]),this._font&&this._updateText()}get alignment(){return this._alignment}set autoWidth(t){const e=this._autoWidth;if(this._autoWidth=t,t&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4&&(this._element.width=this.width),e!==t){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoWidth(){return this._autoWidth}set autoHeight(t){const e=this._autoHeight;if(this._autoHeight=t,t&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4&&(this._element.height=this.height),e!==t){const s=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;s!==this._fontSize&&(this._fontSize=s,this._font&&this._updateText())}}get autoHeight(){return this._autoHeight}set rtlReorder(t){this._rtlReorder!==t&&(this._rtlReorder=t,this._font&&this._updateText())}get rtlReorder(){return this._rtlReorder}set unicodeConverter(t){this._unicodeConverter!==t&&(this._unicodeConverter=t,this._setText(this._text))}get unicodeConverter(){return this._unicodeConverter}get aabb(){if(this._aabbDirty){let t=!1;for(let e=0;e<this._meshInfo.length;e++)!this._meshInfo[e].meshInstance||(t?this._aabb.add(this._meshInfo[e].meshInstance.aabb):(this._aabb.copy(this._meshInfo[e].meshInstance.aabb),t=!0));this._aabbDirty=!1}return this._aabb}set outlineColor(t){const e=t instanceof j?t.r:t[0],s=t instanceof j?t.g:t[1],i=t instanceof j?t.b:t[2],n=t instanceof j?t.a:t[3];if(!(this._outlineColor.r===e&&this._outlineColor.g===s&&this._outlineColor.b===i&&this._outlineColor.a===n)&&(this._outlineColor.r=e,this._outlineColor.g=s,this._outlineColor.b=i,this._outlineColor.a=n,this._model)){this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a;for(let r=0,a=this._model.meshInstances.length;r<a;r++)this._model.meshInstances[r].setParameter("outline_color",this._outlineColorUniform)}}get outlineColor(){return this._outlineColor}set outlineThickness(t){const e=this._outlineThickness;if(this._outlineThickness=t,e!==t&&this._font&&this._model)for(let s=0,i=this._model.meshInstances.length;s<i;s++)this._model.meshInstances[s].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}get outlineThickness(){return this._outlineThickness}set shadowColor(t){const e=t instanceof j?t.r:t[0],s=t instanceof j?t.g:t[1],i=t instanceof j?t.b:t[2],n=t instanceof j?t.a:t[3];if(!(this._shadowColor.r===e&&this._shadowColor.g===s&&this._shadowColor.b===i&&this._shadowColor.a===n)&&(this._shadowColor.r=e,this._shadowColor.g=s,this._shadowColor.b=i,this._shadowColor.a=n,this._model)){this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a;for(let r=0,a=this._model.meshInstances.length;r<a;r++)this._model.meshInstances[r].setParameter("shadow_color",this._shadowColorUniform)}}get shadowColor(){return this._shadowColor}set shadowOffset(t){const e=t instanceof H?t.x:t[0],s=t instanceof H?t.y:t[1];if(!(this._shadowOffset.x===e&&this._shadowOffset.y===s)&&(this._shadowOffset.set(e,s),this._font&&this._model))for(let i=0,n=this._model.meshInstances.length;i<n;i++){const r=-this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=r*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[i].setParameter("shadow_offset",this._shadowOffsetUniform)}}get shadowOffset(){return this._shadowOffset}set minFontSize(t){this._minFontSize!==t&&(this._minFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get minFontSize(){return this._minFontSize}set maxFontSize(t){this._maxFontSize!==t&&(this._maxFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}get maxFontSize(){return this._maxFontSize}set autoFitWidth(t){this._autoFitWidth!==t&&(this._autoFitWidth=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitWidth(){return this._autoFitWidth}set autoFitHeight(t){this._autoFitHeight!==t&&(this._autoFitHeight=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}get autoFitHeight(){return this._autoFitHeight}set maxLines(t){this._maxLines!==t&&(t===null&&this._maxLines===-1||(this._maxLines=t===null?-1:t,this.font&&this._wrapLines&&this._updateText()))}get maxLines(){return this._maxLines}set enableMarkup(t){t=!!t,this._enableMarkup!==t&&(this._enableMarkup=t,this.font&&this._updateText())}get enableMarkup(){return this._enableMarkup}get symbols(){return this._symbols}get symbolColors(){return this._symbolColors===null?null:this._symbolColors.map(function(t){return this._colorPalette.slice(t*3,t*3+3)},this)}get rtl(){return this._rtl}set rangeStart(t){t=Math.max(0,Math.min(t,this._symbols.length)),t!==this._rangeStart&&(this._rangeStart=t,this._updateRenderRange())}get rangeStart(){return this._rangeStart}set rangeEnd(t){t=Math.max(this._rangeStart,Math.min(t,this._symbols.length)),t!==this._rangeEnd&&(this._rangeEnd=t,this._updateRenderRange())}get rangeEnd(){return this._rangeEnd}}const fd=new y,jp=new G,qs=new y,SM=new y,Ye=new G,wl=new G,Tl=new G,Nn=new G;class Cl extends st{constructor(t,e){super(t,e);this._beingInitialized=!1,this._anchor=new Z,this._localAnchor=new Z,this._pivot=new H,this._width=this._calculatedWidth=32,this._height=this._calculatedHeight=32,this._margin=new Z(0,0,-32,-32),this._modelTransform=new G,this._screenToWorld=new G,this._anchorTransform=new G,this._anchorDirty=!0,this._parentWorldTransform=new G,this._screenTransform=new G,this._screenCorners=[new y,new y,new y,new y],this._canvasCorners=[new H,new H,new H,new H],this._worldCorners=[new y,new y,new y,new y],this._cornersDirty=!0,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=vl,this._image=null,this._text=null,this._group=null,this._drawOrder=0,this._useInput=!1,this._layers=[lr],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}get _absLeft(){return this._localAnchor.x+this._margin.x}get _absRight(){return this._localAnchor.z-this._margin.z}get _absTop(){return this._localAnchor.w-this._margin.w}get _absBottom(){return this._localAnchor.y+this._margin.y}get _hasSplitAnchorsX(){return Math.abs(this._anchor.x-this._anchor.z)>.001}get _hasSplitAnchorsY(){return Math.abs(this._anchor.y-this._anchor.w)>.001}get aabb(){return this._image?this._image.aabb:this._text?this._text.aabb:null}set anchor(t){t instanceof Z?this._anchor.set(t.x,t.y,t.z,t.w):this._anchor.set(t[0],t[1],t[2],t[3]),!this.entity._parent&&!this.screen?this._calculateLocalAnchors():this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}get anchor(){return this._anchor}set batchGroupId(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher.remove(Wt.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher.insert(Wt.ELEMENT,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=t)}get batchGroupId(){return this._batchGroupId}set bottom(t){this._margin.y=t;const e=this.entity.getLocalPosition(),s=this._absTop,i=this._localAnchor.y+t;this._setHeight(s-i),e.y=t+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(e)}get bottom(){return this._margin.y}set calculatedWidth(t){this._setCalculatedWidth(t,!0)}get calculatedWidth(){return this._calculatedWidth}set calculatedHeight(t){this._setCalculatedHeight(t,!0)}get calculatedHeight(){return this._calculatedHeight}get canvasCorners(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;const t=this.system.app.graphicsDevice,e=this.screenCorners,s=t.canvas.clientWidth/t.width,i=t.canvas.clientHeight/t.height;for(let n=0;n<4;n++)this._canvasCorners[n].set(e[n].x*s,(t.height-e[n].y)*i);return this._canvasCornersDirty=!1,this._canvasCorners}set drawOrder(t){let e=0;this.screen&&(e=this.screen.screen.priority),t>16777215&&(t=16777215),this._drawOrder=(e<<24)+t,this.fire("set:draworder",this._drawOrder)}get drawOrder(){return this._drawOrder}set height(t){this._height=t,this._hasSplitAnchorsY||this._setCalculatedHeight(t,!0),this.fire("set:height",this._height)}get height(){return this._height}set layers(t){if(this._addedModels.length)for(let e=0;e<this._layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);if(s)for(let i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances)}if(this._layers=t,!(!this.enabled||!this.entity.enabled||!this._addedModels.length))for(let e=0;e<this._layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this._layers[e]);if(s)for(let i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}get layers(){return this._layers}set left(t){this._margin.x=t;const e=this.entity.getLocalPosition(),s=this._absRight,i=this._localAnchor.x+t;this._setWidth(s-i),e.x=t+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(e)}get left(){return this._margin.x}set margin(t){this._margin.copy(t),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}get margin(){return this._margin}get maskedBy(){return this._maskedBy}set pivot(t){const e=this._pivot.x,s=this._pivot.y;t instanceof H?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]);const i=this._margin.x+this._margin.z,n=this._pivot.x-e;this._margin.x+=i*n,this._margin.z-=i*n;const r=this._margin.y+this._margin.w,a=this._pivot.y-s;this._margin.y+=r*a,this._margin.w-=r*a,this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}get pivot(){return this._pivot}set right(t){this._margin.z=t;const e=this.entity.getLocalPosition(),s=this._absLeft,i=this._localAnchor.z-t;this._setWidth(i-s),e.x=this._localAnchor.z-this._localAnchor.x-t-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(e)}get right(){return this._margin.z}get screenCorners(){if(!this._cornersDirty||!this.screen)return this._screenCorners;const t=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);const e=this.screen.screen.screenSpace;for(let s=0;s<4;s++)this._screenTransform.transformPoint(this._screenCorners[s],this._screenCorners[s]),e&&this._screenCorners[s].mulScalar(this.screen.screen.scale),t&&this._screenCorners[s].add(t);return this._cornersDirty=!1,this._canvasCornersDirty=!0,this._worldCornersDirty=!0,this._screenCorners}get textWidth(){return this._text?this._text.width:0}get textHeight(){return this._text?this._text.height:0}set top(t){this._margin.w=t;const e=this.entity.getLocalPosition(),s=this._absBottom,i=this._localAnchor.w-t;this._setHeight(i-s),e.y=this._localAnchor.w-this._localAnchor.y-t-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(e)}get top(){return this._margin.w}set type(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),t===nd?this._image=new nM(this):t===Mp&&(this._text=new vM(this)))}get type(){return this._type}set useInput(t){this._useInput!==t&&(this._useInput=t,this.system.app.elementInput?t?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this):this._useInput===!0&&console.warn("Elements will not get any input events because this.system.app.elementInput is not created"),this.fire("set:useInput",t))}get useInput(){return this._useInput}set width(t){this._width=t,this._hasSplitAnchorsX||this._setCalculatedWidth(t,!0),this.fire("set:width",this._width)}get width(){return this._width}get worldCorners(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){const t=this.screenCorners;if(!this.screen.screen.screenSpace){Ye.copy(this.screen.screen._screenMatrix),Ye.data[13]=-Ye.data[13],Ye.mul2(this.screen.getWorldTransform(),Ye);for(let e=0;e<4;e++)Ye.transformPoint(t[e],this._worldCorners[e])}}else{const t=this.entity.getLocalPosition();Ye.setTranslate(-t.x,-t.y,-t.z),wl.setTRS(y.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Tl.setTranslate(t.x,t.y,t.z);const e=this.entity.parent?this.entity.parent:this.entity;Nn.copy(e.getWorldTransform()),Nn.mul(Tl).mul(wl).mul(Ye),qs.set(t.x-this.pivot.x*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),Nn.transformPoint(qs,this._worldCorners[0]),qs.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),Nn.transformPoint(qs,this._worldCorners[1]),qs.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),Nn.transformPoint(qs,this._worldCorners[2]),qs.set(t.x-this.pivot.x*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),Nn.transformPoint(qs,this._worldCorners[3])}return this._worldCornersDirty=!1,this._worldCorners}_patch(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition}_unpatch(){this.entity._sync=pt.prototype._sync,this.entity.setPosition=pt.prototype.setPosition,this.entity.setLocalPosition=pt.prototype.setLocalPosition}_setPosition(t,e,s){if(!this.element.screen)return pt.prototype.setPosition.call(this,t,e,s);t instanceof y?fd.copy(t):fd.set(t,e,s),this.getWorldTransform(),jp.copy(this.element._screenToWorld).invert(),jp.transformPoint(fd,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}_setLocalPosition(t,e,s){t instanceof y?this.localPosition.copy(t):this.localPosition.set(t,e,s);const i=this.element,n=this.localPosition,r=i._pivot;i._margin.x=n.x-i._calculatedWidth*r.x,i._margin.z=i._localAnchor.z-i._localAnchor.x-i._calculatedWidth-i._margin.x,i._margin.y=n.y-i._calculatedHeight*r.y,i._margin.w=i._localAnchor.w-i._localAnchor.y-i._calculatedHeight-i._margin.y,this._dirtyLocal||this._dirtifyLocal()}_sync(){const t=this.element,e=t.screen;if(e){if(t._anchorDirty){let s=0,i=0,n=0,r=1;if(this._parent&&this._parent.element)s=this._parent.element.calculatedWidth,i=this._parent.element.calculatedHeight,n=this._parent.element.pivot.x,r=this._parent.element.pivot.y;else{const a=e.screen.resolution;s=a.x/e.screen.scale,i=a.y/e.screen.scale}t._anchorTransform.setTranslate(s*(t.anchor.x-n),-(i*(r-t.anchor.y)),0),t._anchorDirty=!1,t._calculateLocalAnchors()}t._sizeDirty&&t._calculateSize(!1,!1)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);const s=this.localPosition,i=t._pivot;t._margin.x=s.x-t._calculatedWidth*i.x,t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x,t._margin.y=s.y-t._calculatedHeight*i.y,t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y,this._dirtyLocal=!1}if(!e)return this._dirtyWorld&&(t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0),pt.prototype._sync.call(this);if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this._parent.element?t._screenToWorld.mul2(this._parent.element._modelTransform,t._anchorTransform):t._screenToWorld.copy(t._anchorTransform),t._modelTransform.mul2(t._screenToWorld,this.localTransform),e){t._screenToWorld.mul2(e.screen._screenMatrix,t._screenToWorld),e.screen.screenSpace||t._screenToWorld.mul2(e.worldTransform,t._screenToWorld),this.worldTransform.mul2(t._screenToWorld,this.localTransform);const s=t._parentWorldTransform;s.setIdentity();const i=this._parent;i&&i.element&&i!==e&&(Ye.setTRS(y.ZERO,i.getLocalRotation(),i.getLocalScale()),s.mul2(i.element._parentWorldTransform,Ye));const n=qs;n.set(0,0,this.localPosition.z);const r=SM;r.set(t._absLeft+t._pivot.x*t.calculatedWidth,t._absBottom+t._pivot.y*t.calculatedHeight,0),Ye.setTranslate(-r.x,-r.y,-r.z),wl.setTRS(n,this.getLocalRotation(),this.getLocalScale()),Tl.setTranslate(r.x,r.y,r.z),t._screenTransform.mul2(t._parentWorldTransform,Tl).mul(wl).mul(Ye),t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0}else this.worldTransform.copy(t._modelTransform);this._dirtyWorld=!1}}_onInsert(t){const e=this._parseUpToScreen();this.entity._dirtifyWorld(),this._updateScreen(e.screen),this._dirtifyMask()}_dirtifyMask(){let t=this.entity;for(;t;){const e=t.parent;if((e===null||e.screen)&&t.element){(!this.system._prerender||!this.system._prerender.length)&&(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));const s=this.system._prerender.indexOf(this.entity);s>=0&&this.system._prerender.splice(s,1),this.system._prerender.indexOf(t)<0&&this.system._prerender.push(t)}t=e}}_onPrerender(){for(let t=0;t<this.system._prerender.length;t++){const e=this.system._prerender[t];if(e.element){const s=1;e.element.syncMask(s)}}this.system._prerender.length=0}_bindScreen(t){t._bindElement(this)}_unbindScreen(t){t._unbindElement(this)}_updateScreen(t){this.screen&&this.screen!==t&&this._unbindScreen(this.screen.screen);const e=this.screen;this.screen=t,this.screen&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,e),this._anchorDirty=!0;const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateScreen(t);this.screen&&this.screen.screen.syncDrawOrder()}syncMask(t){const e=this._parseUpToScreen();this._updateMask(e.mask,t)}_setMaskedBy(t){const e=this._image||this._text;if(t){const s=t.element._image._maskRef,i=new zn({ref:s,func:Ya});e&&e._setStencil&&e._setStencil(i),this._maskedBy=t}else e&&e._setStencil&&e._setStencil(null),this._maskedBy=null}_updateMask(t,e){if(t){if(this._setMaskedBy(t),this.mask){const i=t.element._image._maskRef,n=new zn({ref:i,func:Ya,zpass:Cy});this._image._setStencil(n),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}else{if(this._setMaskedBy(null),this.mask){const i=new zn({ref:e,func:Ri,zpass:Ty});this._image._setStencil(i),this._image._maskRef=e,e++,t=this.entity}const s=this.entity.children;for(let i=0,n=s.length;i<n;i++)s[i].element&&s[i].element._updateMask(t,e);this.mask&&e--}}_parseUpToScreen(){const t={screen:null,mask:null};let e=this.entity._parent;for(;e&&!e.screen;)e.element&&e.element.mask&&(t.mask||(t.mask=e)),e=e.parent;return e&&e.screen&&(t.screen=e),t}_onScreenResize(t){this._anchorDirty=!0,this._cornersDirty=!0,this._worldCornersDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",t)}_onScreenSpaceChange(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)}_onScreenRemove(){this.screen&&(this.screen._destroying?this.screen=null:this._updateScreen(null))}_calculateLocalAnchors(){let t=1e3,e=1e3;const s=this.entity._parent;if(s&&s.element)t=s.element.calculatedWidth,e=s.element.calculatedHeight;else if(this.screen){const i=this.screen.screen.resolution,n=this.screen.screen.scale;t=i.x/n,e=i.y/n}this._localAnchor.set(this._anchor.x*t,this._anchor.y*e,this._anchor.z*t,this._anchor.w*e)}getOffsetPosition(t,e){const s=this.entity.getLocalPosition().clone();return s.x+=t,s.y+=e,this._screenToWorld.transformPoint(s,s),s}onLayersChanged(t,e){this.addModelToLayers(this._image?this._image._renderable.model:this._text._model),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||(this._image?t.addMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.addMeshInstances(this._text._model.meshInstances))}onLayerRemoved(t){this.layers.indexOf(t.id)<0||(this._image?t.removeMeshInstances(this._image._renderable.model.meshInstances):this._text&&t.removeMeshInstances(this._text._model.meshInstances))}onEnable(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&this.system.app.batcher.insert(Wt.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this._batchGroupId>=0&&this.system.app.batcher.remove(Wt.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")}onRemove(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()}_calculateSize(t,e){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();const s=this._absRight-this._absLeft,i=this._absTop-this._absBottom;t?this._setWidth(s):this._setCalculatedWidth(s,!1),e?this._setHeight(i):this._setCalculatedHeight(i,!1);const n=this.entity.getLocalPosition();n.x=this._margin.x+this._calculatedWidth*this._pivot.x,n.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(n),this._sizeDirty=!1}_setWidth(t){this._width=t,this._setCalculatedWidth(t,!1),this.fire("set:width",this._width)}_setHeight(t){this._height=t,this._setCalculatedHeight(t,!1),this.fire("set:height",this._height)}_setCalculatedWidth(t,e){if(!(Math.abs(t-this._calculatedWidth)<=1e-4)){if(this._calculatedWidth=t,this.entity._dirtifyLocal(),e){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.x=s.x-this._calculatedWidth*i.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_setCalculatedHeight(t,e){if(!(Math.abs(t-this._calculatedHeight)<=1e-4)){if(this._calculatedHeight=t,this.entity._dirtifyLocal(),e){const s=this.entity.getLocalPosition(),i=this._pivot;this._margin.y=s.y-this._calculatedHeight*i.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight)}}_flagChildrenAsDirty(){const t=this.entity._children;for(let e=0,s=t.length;e<s;e++)t[e].element&&(t[e].element._anchorDirty=!0,t[e].element._sizeDirty=!0)}addModelToLayers(t){this._addedModels.push(t);for(let e=0;e<this.layers.length;e++){const s=this.system.app.scene.layers.getLayerById(this.layers[e]);!s||s.addMeshInstances(t.meshInstances)}}removeModelFromLayers(t){const e=this._addedModels.indexOf(t);e>=0&&this._addedModels.splice(e,1);for(let s=0;s<this.layers.length;s++){const i=this.system.app.scene.layers.getLayerById(this.layers[s]);!i||i.removeMeshInstances(t.meshInstances)}}getMaskOffset(){const t=this.system.app.frame;this._offsetReadAt!==t&&(this._maskOffset=.5,this._offsetReadAt=t);const e=this._maskOffset;return this._maskOffset-=.001,e}isVisibleForCamera(t){let e,s,i,n;if(this.maskedBy){const d=this.maskedBy.element.screenCorners;e=Math.min(Math.min(d[0].x,d[1].x),Math.min(d[2].x,d[3].x)),s=Math.max(Math.max(d[0].x,d[1].x),Math.max(d[2].x,d[3].x)),n=Math.min(Math.min(d[0].y,d[1].y),Math.min(d[2].y,d[3].y)),i=Math.max(Math.max(d[0].y,d[1].y),Math.max(d[2].y,d[3].y))}else{const d=this.system.app.graphicsDevice.width,u=this.system.app.graphicsDevice.height,f=t._rect.z*d,m=t._rect.w*u;e=t._rect.x*d,s=e+f,i=(1-t._rect.y)*u,n=i-m}const r=this.screenCorners,a=Math.min(Math.min(r[0].x,r[1].x),Math.min(r[2].x,r[3].x)),l=Math.max(Math.max(r[0].x,r[1].x),Math.max(r[2].x,r[3].x)),h=Math.min(Math.min(r[0].y,r[1].y),Math.min(r[2].y,r[3].y)),c=Math.max(Math.max(r[0].y,r[1].y),Math.max(r[2].y,r[3].y));return!(l<e||a>s||h>i||c<n)}_isScreenSpace(){return this.screen&&this.screen.screen?this.screen.screen.screenSpace:!1}_isScreenCulled(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}}function mt(o){Object.defineProperty(Cl.prototype,o,{get:function(){return this._text?this._text[o]:this._image?this._image[o]:null},set:function(t){this._text?this._text[o]=t:this._image&&(this._image[o]=t)}})}mt("fontSize");mt("minFontSize");mt("maxFontSize");mt("maxLines");mt("autoFitWidth");mt("autoFitHeight");mt("color");mt("font");mt("fontAsset");mt("spacing");mt("lineHeight");mt("wrapLines");mt("lines");mt("alignment");mt("autoWidth");mt("autoHeight");mt("rtlReorder");mt("unicodeConverter");mt("text");mt("key");mt("texture");mt("textureAsset");mt("material");mt("materialAsset");mt("sprite");mt("spriteAsset");mt("spriteFrame");mt("pixelsPerUnit");mt("opacity");mt("rect");mt("mask");mt("outlineColor");mt("outlineThickness");mt("shadowColor");mt("shadowOffset");mt("enableMarkup");mt("rangeStart");mt("rangeEnd");class bM{constructor(){this.enabled=!0}}const qp=["enabled"];class wM extends Bt{constructor(t){super(t);this.id="element",this.ComponentType=Cl,this.DataType=bM,this.schema=qp,this._unicodeConverter=null,this._rtlReorder=null,this._defaultTexture=new nt(t.graphicsDevice,{width:1,height:1,format:ct}),this._defaultTexture.name="element-system";const e=this._defaultTexture.lock(),s=new Uint8Array(4);s[0]=255,s[1]=255,s[2]=255,s[3]=255,e.set(s),this._defaultTexture.unlock(),this.defaultImageMaterial=null,this.defaultImage9SlicedMaterial=null,this.defaultImage9TiledMaterial=null,this.defaultImageMaskMaterial=null,this.defaultImage9SlicedMaskMaterial=null,this.defaultImage9TiledMaskMaterial=null,this.defaultScreenSpaceImageMaterial=null,this.defaultScreenSpaceImage9SlicedMaterial=null,this.defaultScreenSpaceImage9TiledMaterial=null,this.defaultScreenSpaceImageMask9SlicedMaterial=null,this.defaultScreenSpaceImageMask9TiledMaterial=null,this.defaultScreenSpaceImageMaskMaterial=null,this.defaultTextMaterial=null,this.defaultBitmapTextMaterial=null,this.defaultScreenSpaceTextMaterial=null,this.defaultScreenSpaceBitmapTextMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}destroy(){super.destroy(),this._defaultTexture.destroy()}initializeComponentData(t,e,s){t._beingInitialized=!0,e.anchor!==void 0&&(e.anchor instanceof Z?t.anchor.copy(e.anchor):t.anchor.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),e.pivot!==void 0&&(e.pivot instanceof H?t.pivot.copy(e.pivot):t.pivot.set(e.pivot[0],e.pivot[1]));const i=Math.abs(t.anchor.x-t.anchor.z)>.001,n=Math.abs(t.anchor.y-t.anchor.w)>.001;let r=!1,a;e.margin!==void 0&&(e.margin instanceof Z?t.margin.copy(e.margin):t._margin.set(e.margin[0],e.margin[1],e.margin[2],e.margin[3]),r=!0),e.left!==void 0&&(t._margin.x=e.left,r=!0),e.bottom!==void 0&&(t._margin.y=e.bottom,r=!0),e.right!==void 0&&(t._margin.z=e.right,r=!0),e.top!==void 0&&(t._margin.w=e.top,r=!0),r&&(t.margin=t._margin);let l=!1;e.width!==void 0&&!i?t.width=e.width:i&&(l=!0),e.height!==void 0&&!n?t.height=e.height:n&&(l=!0),l&&(t.anchor=t.anchor),e.enabled!==void 0&&(t.enabled=e.enabled),e.useInput!==void 0&&(t.useInput=e.useInput),t.batchGroupId=e.batchGroupId===void 0||e.batchGroupId===null?-1:e.batchGroupId,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),e.type!==void 0&&(t.type=e.type),t.type===nd?(e.rect!==void 0&&(t.rect=e.rect),e.color!==void 0&&(a=e.color,a instanceof j||(a=new j(e.color[0],e.color[1],e.color[2])),t.color=a),e.opacity!==void 0&&(t.opacity=e.opacity),e.textureAsset!==void 0&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),e.spriteAsset!==void 0&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),e.spriteFrame!==void 0&&(t.spriteFrame=e.spriteFrame),e.pixelsPerUnit!==void 0&&e.pixelsPerUnit!==null&&(t.pixelsPerUnit=e.pixelsPerUnit),e.materialAsset!==void 0&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),e.mask!==void 0&&(t.mask=e.mask)):t.type===Mp&&(e.autoWidth!==void 0&&(t.autoWidth=e.autoWidth),e.autoHeight!==void 0&&(t.autoHeight=e.autoHeight),e.rtlReorder!==void 0&&(t.rtlReorder=e.rtlReorder),e.unicodeConverter!==void 0&&(t.unicodeConverter=e.unicodeConverter),e.text!==null&&e.text!==void 0?t.text=e.text:e.key!==null&&e.key!==void 0&&(t.key=e.key),e.color!==void 0&&(a=e.color,a instanceof j||(a=new j(a[0],a[1],a[2])),t.color=a),e.opacity!==void 0&&(t.opacity=e.opacity),e.spacing!==void 0&&(t.spacing=e.spacing),e.fontSize!==void 0&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),e.lineHeight!==void 0&&(t.lineHeight=e.lineHeight),e.maxLines!==void 0&&(t.maxLines=e.maxLines),e.wrapLines!==void 0&&(t.wrapLines=e.wrapLines),e.minFontSize!==void 0&&(t.minFontSize=e.minFontSize),e.maxFontSize!==void 0&&(t.maxFontSize=e.maxFontSize),e.autoFitWidth&&(t.autoFitWidth=e.autoFitWidth),e.autoFitHeight&&(t.autoFitHeight=e.autoFitHeight),e.fontAsset!==void 0&&(t.fontAsset=e.fontAsset),e.font!==void 0&&(t.font=e.font),e.alignment!==void 0&&(t.alignment=e.alignment),e.outlineColor!==void 0&&(t.outlineColor=e.outlineColor),e.outlineThickness!==void 0&&(t.outlineThickness=e.outlineThickness),e.shadowColor!==void 0&&(t.shadowColor=e.shadowColor),e.shadowOffset!==void 0&&(t.shadowOffset=e.shadowOffset),e.enableMarkup!==void 0&&(t.enableMarkup=e.enableMarkup));const h=t._parseUpToScreen();h.screen&&t._updateScreen(h.screen),super.initializeComponentData(t,e,s),t._beingInitialized=!1,t.type===nd&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)}onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.element,i={enabled:s.enabled,width:s.width,height:s.height,anchor:s.anchor.clone(),pivot:s.pivot.clone(),margin:s.margin.clone(),alignment:s.alignment&&s.alignment.clone()||s.alignment,autoWidth:s.autoWidth,autoHeight:s.autoHeight,type:s.type,rect:s.rect&&s.rect.clone()||s.rect,rtlReorder:s.rtlReorder,unicodeConverter:s.unicodeConverter,materialAsset:s.materialAsset,material:s.material,color:s.color&&s.color.clone()||s.color,opacity:s.opacity,textureAsset:s.textureAsset,texture:s.texture,spriteAsset:s.spriteAsset,sprite:s.sprite,spriteFrame:s.spriteFrame,pixelsPerUnit:s.pixelsPerUnit,spacing:s.spacing,lineHeight:s.lineHeight,wrapLines:s.wrapLines,layers:s.layers,fontSize:s.fontSize,minFontSize:s.minFontSize,maxFontSize:s.maxFontSize,autoFitWidth:s.autoFitWidth,autoFitHeight:s.autoFitHeight,maxLines:s.maxLines,fontAsset:s.fontAsset,font:s.font,useInput:s.useInput,batchGroupId:s.batchGroupId,mask:s.mask,outlineColor:s.outlineColor&&s.outlineColor.clone()||s.outlineColor,outlineThickness:s.outlineThickness,shadowColor:s.shadowColor&&s.shadowColor.clone()||s.shadowColor,shadowOffset:s.shadowOffset&&s.shadowOffset.clone()||s.shadowOffset,enableMarkup:s.enableMarkup};return s.key!==void 0&&s.key!==null?i.key=s.key:i.text=s.text,this.addComponent(e,i)}getTextElementMaterial(t,e){return t?e?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new ue,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=Je,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new ue,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=Je,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):e?(this.defaultTextMaterial||(this.defaultTextMaterial=new ue,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=Je,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new ue,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=Je,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)}_createBaseImageMaterial(){const t=new ue;return t.diffuse.set(0,0,0),t.emissive.set(.5,.5,.5),t.emissiveMap=this._defaultTexture,t.emissiveTint=!0,t.opacityMap=this._defaultTexture,t.opacityMapChannel="a",t.opacityTint=!0,t.opacity=0,t.useLighting=!1,t.useGammaTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=Je,t.depthWrite=!1,t}getImageElementMaterial(t,e,s,i){return t?e?s?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=Xt,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):i?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=Ut,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):s?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=Xt,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):i?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=Ut,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):e?s?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=Xt,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):i?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=Ut,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):s?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=Xt,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):i?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=Ut,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)}registerUnicodeConverter(t){this._unicodeConverter=t}registerRtlReorder(t){this._rtlReorder=t}getUnicodeConverter(){return this._unicodeConverter}getRtlReorder(){return this._rtlReorder}}st._buildAccessors(Cl.prototype,qp);const Vn="free",Wn="limited",Gn="locked",TM=["angularDampingX","angularDampingY","angularDampingZ","angularEquilibriumX","angularEquilibriumY","angularEquilibriumZ","angularLimitsX","angularLimitsY","angularLimitsZ","angularMotionX","angularMotionY","angularMotionZ","angularSpringX","angularSpringY","angularSpringZ","angularStiffnessX","angularStiffnessY","angularStiffnessZ","breakForce","enableCollision","enabled","entityA","entityB","linearDampingX","linearDampingY","linearDampingZ","linearEquilibriumX","linearEquilibriumY","linearEquilibriumZ","linearLimitsX","linearLimitsY","linearLimitsZ","linearMotionX","linearMotionY","linearMotionZ","linearSpringX","linearSpringY","linearSpringZ","linearStiffnessX","linearStiffnessY","linearStiffnessZ"];class md extends st{constructor(t,e){super(t,e);this._constraint=null,this._entityA=null,this._entityB=null,this._breakForce=34e37,this._enableCollision=!0,this._linearMotionX=Gn,this._linearLimitsX=new H(0,0),this._linearSpringX=!1,this._linearStiffnessX=0,this._linearDampingX=1,this._linearEquilibriumX=0,this._linearMotionY=Gn,this._linearLimitsY=new H(0,0),this._linearSpringY=!1,this._linearStiffnessY=0,this._linearDampingY=1,this._linearEquilibriumY=0,this._linearMotionZ=Gn,this._linearLimitsZ=new H(0,0),this._linearSpringZ=!1,this._linearStiffnessZ=0,this._linearDampingZ=1,this._linearEquilibriumZ=0,this._angularMotionX=Gn,this._angularLimitsX=new H(0,0),this._angularSpringX=!1,this._angularStiffnessX=0,this._angularDampingX=1,this._angularEquilibriumX=0,this._angularMotionY=Gn,this._angularLimitsY=new H(0,0),this._angularSpringY=!1,this._angularStiffnessY=0,this._angularDampingY=1,this._angularEquilibriumY=0,this._angularMotionZ=Gn,this._angularLimitsZ=new H(0,0),this._angularSpringZ=!1,this._angularEquilibriumZ=0,this._angularDampingZ=1,this._angularStiffnessZ=0,this.on("set_enabled",this._onSetEnabled,this)}set entityA(t){this._destroyConstraint(),this._entityA=t,this._createConstraint()}get entityA(){return this._entityA}set entityB(t){this._destroyConstraint(),this._entityB=t,this._createConstraint()}get entityB(){return this._entityB}set breakForce(t){this._constraint&&this._breakForce!==t&&(this._constraint.setBreakingImpulseThreshold(t),this._breakForce=t)}get breakForce(){return this._breakForce}set enableCollision(t){this._destroyConstraint(),this._enableCollision=t,this._createConstraint()}get enableCollision(){return this._enableCollision}set angularLimitsX(t){this._angularLimitsX.equals(t)||(this._angularLimitsX.copy(t),this._updateAngularLimits())}get angularLimitsX(){return this._angularLimitsX}set angularMotionX(t){this._angularMotionX!==t&&(this._angularMotionX=t,this._updateAngularLimits())}get angularMotionX(){return this._angularMotionX}set angularLimitsY(t){this._angularLimitsY.equals(t)||(this._angularLimitsY.copy(t),this._updateAngularLimits())}get angularLimitsY(){return this._angularLimitsY}set angularMotionY(t){this._angularMotionY!==t&&(this._angularMotionY=t,this._updateAngularLimits())}get angularMotionY(){return this._angularMotionY}set angularLimitsZ(t){this._angularLimitsZ.equals(t)||(this._angularLimitsZ.copy(t),this._updateAngularLimits())}get angularLimitsZ(){return this._angularLimitsZ}set angularMotionZ(t){this._angularMotionZ!==t&&(this._angularMotionZ=t,this._updateAngularLimits())}get angularMotionZ(){return this._angularMotionZ}set linearLimitsX(t){this._linearLimitsX.equals(t)||(this._linearLimitsX.copy(t),this._updateLinearLimits())}get linearLimitsX(){return this._linearLimitsX}set linearMotionX(t){this._linearMotionX!==t&&(this._linearMotionX=t,this._updateLinearLimits())}get linearMotionX(){return this._linearMotionX}set linearLimitsY(t){this._linearLimitsY.equals(t)||(this._linearLimitsY.copy(t),this._updateLinearLimits())}get linearLimitsY(){return this._linearLimitsY}set linearMotionY(t){this._linearMotionY!==t&&(this._linearMotionY=t,this._updateLinearLimits())}get linearMotionY(){return this._linearMotionY}set linearLimitsZ(t){this._linearLimitsZ.equals(t)||(this._linearLimitsZ.copy(t),this._updateLinearLimits())}get linearLimitsZ(){return this._linearLimitsZ}set linearMotionZ(t){this._linearMotionZ!==t&&(this._linearMotionZ=t,this._updateLinearLimits())}get linearMotionZ(){return this._linearMotionZ}_convertTransform(t,e){const s=t.getTranslation(),i=new tt;i.setFromMat4(t);const n=new Ammo.btVector3(s.x,s.y,s.z),r=new Ammo.btQuaternion(i.x,i.y,i.z,i.w);e.setOrigin(n),e.setRotation(r),Ammo.destroy(n),Ammo.destroy(r)}_updateAngularLimits(){const t=this._constraint;if(t){let e,s,i,n,r,a;this._angularMotionX===Wn?(e=this._angularLimitsX.x*U.DEG_TO_RAD,n=this._angularLimitsX.y*U.DEG_TO_RAD):this._angularMotionX===Vn?(e=1,n=0):e=n=0,this._angularMotionY===Wn?(s=this._angularLimitsY.x*U.DEG_TO_RAD,r=this._angularLimitsY.y*U.DEG_TO_RAD):this._angularMotionY===Vn?(s=1,r=0):s=r=0,this._angularMotionZ===Wn?(i=this._angularLimitsZ.x*U.DEG_TO_RAD,a=this._angularLimitsZ.y*U.DEG_TO_RAD):this._angularMotionZ===Vn?(i=1,a=0):i=a=0;const l=new Ammo.btVector3(e,s,i);t.setAngularLowerLimit(l),l.setValue(n,r,a),t.setAngularUpperLimit(l),Ammo.destroy(l)}}_updateLinearLimits(){const t=this._constraint;if(t){let e,s,i,n,r,a;this._linearMotionX===Wn?(e=this._linearLimitsX.x,n=this._linearLimitsX.y):this._linearMotionX===Vn?(e=1,n=0):e=n=0,this._linearMotionY===Wn?(s=this._linearLimitsY.x,r=this._linearLimitsY.y):this._linearMotionY===Vn?(s=1,r=0):s=r=0,this._linearMotionZ===Wn?(i=this._linearLimitsZ.x,a=this._linearLimitsZ.y):this._linearMotionZ===Vn?(i=1,a=0):i=a=0;const l=new Ammo.btVector3(e,s,i);t.setLinearLowerLimit(l),l.setValue(n,r,a),t.setLinearUpperLimit(l),Ammo.destroy(l)}}_createConstraint(){if(this._entityA&&this._entityA.rigidbody){this._destroyConstraint();const t=new G,e=this._entityA.rigidbody.body;e.activate();const s=this.entity.getWorldTransform(),n=this._entityA.getWorldTransform().clone().invert();t.mul2(n,s);const r=new Ammo.btTransform;if(this._convertTransform(t,r),this._entityB&&this._entityB.rigidbody){const c=this._entityB.rigidbody.body;c.activate();const u=this._entityB.getWorldTransform().clone().invert();t.mul2(u,s);const f=new Ammo.btTransform;this._convertTransform(t,f),this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,c,r,f,!this._enableCollision),Ammo.destroy(f)}else this._constraint=new Ammo.btGeneric6DofSpringConstraint(e,r,!this._enableCollision);Ammo.destroy(r);const a=["X","Y","Z","X","Y","Z"];for(let c=0;c<6;c++){const d=c<3?"_linear":"_angular";this._constraint.enableSpring(c,this[d+"Spring"+a[c]]),this._constraint.setDamping(c,this[d+"Damping"+a[c]]),this._constraint.setEquilibriumPoint(c,this[d+"Equilibrium"+a[c]]),this._constraint.setStiffness(c,this[d+"Stiffness"+a[c]])}this._constraint.setBreakingImpulseThreshold(this._breakForce),this._updateLinearLimits(),this._updateAngularLimits(),this.system.app.systems.rigidbody.dynamicsWorld.addConstraint(this._constraint,!this._enableCollision)}}_destroyConstraint(){this._constraint&&(this.system.app.systems.rigidbody.dynamicsWorld.removeConstraint(this._constraint),Ammo.destroy(this._constraint),this._constraint=null)}initFromData(t){for(const e of TM)t.hasOwnProperty(e)&&(t[e]instanceof H?this["_"+e].copy(t[e]):this["_"+e]=t[e]);this._createConstraint()}onEnable(){this._createConstraint()}onDisable(){this._destroyConstraint()}_onSetEnabled(t,e,s){}_onBeforeRemove(){this.fire("remove")}}const CM={Damping:"setDamping",Equilibrium:"setEquilibriumPoint",Spring:"enableSpring",Stiffness:"setStiffness"};["linear","angular"].forEach(o=>{["Damping","Equilibrium","Spring","Stiffness"].forEach(t=>{["X","Y","Z"].forEach(e=>{const s=o+t+e,i="_"+s;let n=o==="linear"?0:3;e==="Y"&&(n+=1),e==="Z"&&(n+=2),Object.defineProperty(md.prototype,s,{get:function(){return this[i]},set:function(r){this[i]!==r&&(this[i]=r,this._constraint[CM[t]](n,r))}})})})});class AM{constructor(){this.enabled=!0}}const Yp=["enabled"];class MM extends Bt{constructor(t){super(t);this.id="joint",this.app=t,this.ComponentType=md,this.DataType=AM,this.schema=Yp}initializeComponentData(t,e,s){t.initFromData(e)}}st._buildAccessors(md.prototype,Yp);class $p extends st{constructor(t,e){super(t,e);this._minWidth=0,this._minHeight=0,this._maxWidth=null,this._maxHeight=null,this._fitWidthProportion=0,this._fitHeightProportion=0,this._excludeFromLayout=!1}set minWidth(t){t!==this._minWidth&&(this._minWidth=t,this.fire("resize"))}get minWidth(){return this._minWidth}set minHeight(t){t!==this._minHeight&&(this._minHeight=t,this.fire("resize"))}get minHeight(){return this._minHeight}set maxWidth(t){t!==this._maxWidth&&(this._maxWidth=t,this.fire("resize"))}get maxWidth(){return this._maxWidth}set maxHeight(t){t!==this._maxHeight&&(this._maxHeight=t,this.fire("resize"))}get maxHeight(){return this._maxHeight}set fitWidthProportion(t){t!==this._fitWidthProportion&&(this._fitWidthProportion=t,this.fire("resize"))}get fitWidthProportion(){return this._fitWidthProportion}set fitHeightProportion(t){t!==this._fitHeightProportion&&(this._fitHeightProportion=t,this.fire("resize"))}get fitHeightProportion(){return this._fitHeightProportion}set excludeFromLayout(t){t!==this._excludeFromLayout&&(this._excludeFromLayout=t,this.fire("resize"))}get excludeFromLayout(){return this._excludeFromLayout}}class PM{constructor(){this.enabled=!0}}const Kp=["enabled"];class EM extends Bt{constructor(t){super(t);this.id="layoutchild",this.ComponentType=$p,this.DataType=PM,this.schema=Kp}initializeComponentData(t,e,s){e.enabled!==void 0&&(t.enabled=e.enabled),e.minWidth!==void 0&&(t.minWidth=e.minWidth),e.minHeight!==void 0&&(t.minHeight=e.minHeight),e.maxWidth!==void 0&&(t.maxWidth=e.maxWidth),e.maxHeight!==void 0&&(t.maxHeight=e.maxHeight),e.fitWidthProportion!==void 0&&(t.fitWidthProportion=e.fitWidthProportion),e.fitHeightProportion!==void 0&&(t.fitHeightProportion=e.fitHeightProportion),e.excludeFromLayout!==void 0&&(t.excludeFromLayout=e.excludeFromLayout),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutchild;return this.addComponent(e,{enabled:s.enabled,minWidth:s.minWidth,minHeight:s.minHeight,maxWidth:s.maxWidth,maxHeight:s.maxHeight,fitWidthProportion:s.fitWidthProportion,fitHeightProportion:s.fitHeightProportion,excludeFromLayout:s.excludeFromLayout})}}st._buildAccessors($p.prototype,Kp);const pd=0,RM=1,Zp=2,IM=3,Al={};Al[ht]={axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"};Al[St]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};const _d={};_d[ht]=St;_d[St]=ht;const LM={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},Ie={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},Le=new H;function Jp(o){let t;const e=Al[o],s=Al[_d[o]];function i(A,R){return-R[e.size]*A.pivot[e.axis]}function n(A,R){return-R[s.size]*A.pivot[s.axis]}function r(A,R){return R[e.size]*(1-A.pivot[e.axis])}function a(A,R){A=A.filter(l),t=R,Le.x=t.containerSize.x-t.padding.x-t.padding.z,Le.y=t.containerSize.y-t.padding.y-t.padding.w,h(A);const L=d(c(A)),O=f(L,u(L)),z=v(L,O);return x(L,O,z),S(L,O,z),T(L)}function l(A){const R=A.entity.layoutchild;return!R||!R.enabled||!R.excludeFromLayout}function h(A){for(let R=0;R<A.length;++R){const L=A[R],O=L.anchor;(O.x!==0||O.y!==0||O.z!==0||O.w!==0)&&(L.anchor=Z.ZERO)}}function c(A){if(!t.wrap)return[A];const R=[[]],L=b(A);let O=0;const z=t[e.fitting]===Zp;for(let W=0;W<A.length;++W){R[R.length-1].length>0&&(O+=t.spacing[e.axis]);const K=L[W][e.size];O+=K,!z&&O>Le[e.axis]&&R[R.length-1].length!==0&&(O=K,R.push([])),R[R.length-1].push(A[W]),z&&O>Le[e.axis]&&W!==A.length-1&&(O=0,R.push([]))}return R}function d(A){const R=t.orientation===ht&&t.reverseX||t.orientation===St&&t.reverseY,L=t.orientation===ht&&t.reverseY||t.orientation===St&&t.reverseX;if(R)for(let O=0;O<A.length;++O)R&&A[O].reverse();return L&&A.reverse(),A}function u(A){const R=[];for(let L=0;L<A.length;++L){const O=A[L],z=b(O),W=p(z,e),K=m(t[e.fitting],W,Le[e.axis]);K===Ie.APPLY_STRETCHING?_(z,W,e):K===Ie.APPLY_SHRINKING&&g(z,W,e),R.push(z)}return R}function f(A,R){const L=[],O=[];for(let K=0;K<A.length;++K){const V=A[K];V.largestElement=null,V.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(let P=0;P<V.length;++P){const B=R[K][P];B[s.size]>V.largestSize[s.size]&&(V.largestElement=V[P],V.largestSize=B)}L.push(V.largestElement),O.push(V.largestSize)}const z=p(O,s),W=m(t[s.fitting],z,Le[s.axis]);W===Ie.APPLY_STRETCHING?_(O,z,s):W===Ie.APPLY_SHRINKING&&g(O,z,s);for(let K=0;K<A.length;++K){const V=A[K];for(let P=0;P<V.length;++P){const B=R[K][P],Y=B[s.size],it=A.length===1?Le[s.axis]:V.largestSize[s.size],Tt=m(t[s.fitting],Y,it);Tt===Ie.APPLY_STRETCHING?B[s.size]=Math.min(it,B[s.maxSize]):Tt===Ie.APPLY_SHRINKING&&(B[s.size]=Math.max(it,B[s.minSize]))}}return R}function m(A,R,L){switch(A){case pd:return Ie.NONE;case RM:return R<L?Ie.APPLY_STRETCHING:Ie.NONE;case Zp:return R>=L?Ie.APPLY_SHRINKING:Ie.NONE;case IM:return R<L?Ie.APPLY_STRETCHING:Ie.APPLY_SHRINKING;default:throw new Error(`Unrecognized fitting mode: ${A}`)}}function p(A,R){const L=E(A,R.size),O=(A.length-1)*t.spacing[R.axis];return L+O}function _(A,R,L){const O=k(A,L.maxSize),z=D(A,L.fittingProportion),W=q(z,O);let K=Le[L.axis]-R;for(let V=0;V<A.length;++V){const P=O[V],B=w(P,K,z,W),Y=A[P][L.size]+B,it=A[P][L.maxSize],Tt=Math.min(Y,it);A[P][L.size]=Tt;const $=Math.max(Y-Tt,0);K-=B-$}}function g(A,R,L){const O=k(A,L.minSize,!0),z=D(A,L.fittingProportion),W=I(z),K=q(W,O);let V=R-Le[L.axis];for(let P=0;P<A.length;++P){const B=O[P],Y=w(B,V,W,K),it=A[B][L.size]-Y,Tt=A[B][L.minSize],$=Math.max(it,Tt);A[B][L.size]=$;const kt=Math.max($-it,0);V-=Y-kt}}function w(A,R,L,O){const z=L[A],W=O[A];return Math.abs(z)<1e-5&&Math.abs(W)<1e-5?R:R*z/W}function v(A,R){const L={};L[e.axis]=0,L[s.axis]=0,A[e.size]=Number.NEGATIVE_INFINITY;const O=[];for(let z=0;z<A.length;++z){const W=A[z];if(W.length===0){O.push([]);continue}const K=[],V=R[z];for(let P=0;P<W.length;++P){const B=W[P],Y=V[P];L[s.axis]-=n(B,Y),L[e.axis]-=i(B,Y),K[P]={},K[P][e.axis]=L[e.axis],K[P][s.axis]=L[s.axis],L[s.axis]+=n(B,Y),L[e.axis]+=r(B,Y)+t.spacing[e.axis]}W[e.size]=L[e.axis]-t.spacing[e.axis],W[s.size]=W.largestSize[s.size],A[e.size]=Math.max(A[e.size],W[e.size]),L[e.axis]=0,L[s.axis]+=W[s.size]+t.spacing[s.axis],O.push(K)}return A[s.size]=L[s.axis]-t.spacing[s.axis],O}function x(A,R,L){const O=t.alignment[e.axis],z=t.alignment[s.axis],W=t.padding[e.axis],K=t.padding[s.axis];for(let V=0;V<A.length;++V){const P=A[V],B=R[V],Y=L[V],it=(Le[e.axis]-P[e.size])*O+W,Tt=(Le[s.axis]-A[s.size])*z+K;for(let $=0;$<P.length;++$){const kt=(P[s.size]-B[$][s.size])*t.alignment[s.axis];Y[$][e.axis]+=it,Y[$][s.axis]+=Tt+kt}}}function S(A,R,L){for(let O=0;O<A.length;++O){const z=A[O],W=R[O],K=L[O];for(let V=0;V<z.length;++V){const P=z[V];P[e.calculatedSize]=W[V][e.size],P[s.calculatedSize]=W[V][s.size],t.orientation===ht?P.entity.setLocalPosition(K[V][e.axis],K[V][s.axis],P.entity.getLocalPosition().z):P.entity.setLocalPosition(K[V][s.axis],K[V][e.axis],P.entity.getLocalPosition().z)}}}function T(A){const R=A.width,L=A.height,O=(Le.x-R)*t.alignment.x+t.padding.x,z=(Le.y-L)*t.alignment.y+t.padding.y;return{bounds:new Z(O,z,R,L)}}function b(A){const R=[];for(let L=0;L<A.length;++L){const O=A[L],z=Math.max(C(O,"minWidth"),0),W=Math.max(C(O,"minHeight"),0),K=Math.max(C(O,"maxWidth"),z),V=Math.max(C(O,"maxHeight"),W),P=M(C(O,"width"),z,K),B=M(C(O,"height"),W,V),Y=C(O,"fitWidthProportion"),it=C(O,"fitHeightProportion");R.push({minWidth:z,minHeight:W,maxWidth:K,maxHeight:V,width:P,height:B,fitWidthProportion:Y,fitHeightProportion:it})}return R}function C(A,R){const L=A.entity.layoutchild;return L&&L.enabled&&L[R]!==void 0&&L[R]!==null?L[R]:A[R]!==void 0?A[R]:LM[R]}function M(A,R,L){return Math.min(Math.max(A,R),L)}function E(A,R){return A.reduce(function(L,O){return L+O[R]},0)}function D(A,R){const L=E(A,R),O=[],z=A.length;if(L===0)for(let W=0;W<z;++W)O.push(1/z);else for(let W=0;W<z;++W)O.push(A[W][R]/L);return O}function I(A){if(A.length===1)return[1];const R=[],L=A.length;for(let O=0;O<L;++O)R.push((1-A[O])/(L-1));return R}function k(A,R,L){return A.forEach(N),A.slice().sort(function(O,z){return L?z[R]-O[R]:O[R]-z[R]}).map(X)}function N(A,R){A.index=R}function X(A){return A.index}function q(A,R){const L=[];L[R[A.length-1]]=A[R[A.length-1]];for(let O=A.length-2;O>=0;--O)L[R[O]]=L[R[O+1]]+A[R[O]];return L}return a}const gd={};gd[ht]=Jp(ht);gd[St]=Jp(St);class DM{calculateLayout(t,e){const s=gd[e.orientation];if(s)return s(t,e);throw new Error("Unrecognized orientation value: "+e.orientation)}}function Qp(o){return o.element}function FM(o){return o.enabled&&o.element&&o.element.enabled}class t_ extends st{constructor(t,e){super(t,e);this._orientation=ht,this._reverseX=!1,this._reverseY=!0,this._alignment=new H(0,1),this._padding=new Z,this._spacing=new H,this._widthFitting=pd,this._heightFitting=pd,this._wrap=!1,this._layoutCalculator=new DM,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(s=>{this._listenForReflowEvents(s,"on")}),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),t.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),t.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}set orientation(t){t!==this._orientation&&(this._orientation=t,this._scheduleReflow())}get orientation(){return this._orientation}set reverseX(t){t!==this._reverseX&&(this._reverseX=t,this._scheduleReflow())}get reverseX(){return this._reverseX}set reverseY(t){t!==this._reverseY&&(this._reverseY=t,this._scheduleReflow())}get reverseY(){return this._reverseY}set alignment(t){t.equals(this._alignment)||(this._alignment.copy(t),this._scheduleReflow())}get alignment(){return this._alignment}set padding(t){t.equals(this._padding)||(this._padding.copy(t),this._scheduleReflow())}get padding(){return this._padding}set spacing(t){t.equals(this._spacing)||(this._spacing.copy(t),this._scheduleReflow())}get spacing(){return this._spacing}set widthFitting(t){t!==this._widthFitting&&(this._widthFitting=t,this._scheduleReflow())}get widthFitting(){return this._widthFitting}set heightFitting(t){t!==this._heightFitting&&(this._heightFitting=t,this._scheduleReflow())}get heightFitting(){return this._heightFitting}set wrap(t){t!==this._wrap&&(this._wrap=t,this._scheduleReflow())}get wrap(){return this._wrap}_isSelfOrChild(t){return t===this.entity||this.entity.children.indexOf(t)!==-1}_listenForReflowEvents(t,e){t.element&&(t.element[e]("enableelement",this._scheduleReflow,this),t.element[e]("disableelement",this._scheduleReflow,this),t.element[e]("resize",this._scheduleReflow,this),t.element[e]("set:pivot",this._scheduleReflow,this)),t.layoutchild&&(t.layoutchild[e]("set_enabled",this._scheduleReflow,this),t.layoutchild[e]("resize",this._scheduleReflow,this))}_onElementOrLayoutComponentAdd(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"on"),this._scheduleReflow())}_onElementOrLayoutComponentRemove(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"off"),this._scheduleReflow())}_onChildInsert(t){this._listenForReflowEvents(t,"on"),this._scheduleReflow()}_onChildRemove(t){this._listenForReflowEvents(t,"off"),this._scheduleReflow()}_scheduleReflow(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)}reflow(){const t=Qp(this.entity),e=this.entity.children.filter(FM).map(Qp);if(!t||e.length===0)return;const s=Math.max(t.calculatedWidth,0),i=Math.max(t.calculatedHeight,0),n={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new H(s,i)};this._isPerformingReflow=!0;const r=this._layoutCalculator.calculateLayout(e,n);this._isPerformingReflow=!1,this.fire("reflow",r)}onEnable(){this._scheduleReflow()}onRemove(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(t=>{this._listenForReflowEvents(t,"off")}),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}class OM{constructor(){this.enabled=!0}}const e_=["enabled"],BM=100;class kM extends Bt{constructor(t){super(t);this.id="layoutgroup",this.ComponentType=t_,this.DataType=OM,this.schema=e_,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e,s){e.enabled!==void 0&&(t.enabled=e.enabled),e.orientation!==void 0&&(t.orientation=e.orientation),e.reverseX!==void 0&&(t.reverseX=e.reverseX),e.reverseY!==void 0&&(t.reverseY=e.reverseY),e.alignment!==void 0&&(t.alignment=Array.isArray(e.alignment)?new H(e.alignment):e.alignment),e.padding!==void 0&&(t.padding=Array.isArray(e.padding)?new Z(e.padding):e.padding),e.spacing!==void 0&&(t.spacing=Array.isArray(e.spacing)?new H(e.spacing):e.spacing),e.widthFitting!==void 0&&(t.widthFitting=e.widthFitting),e.heightFitting!==void 0&&(t.heightFitting=e.heightFitting),e.wrap!==void 0&&(t.wrap=e.wrap),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.layoutgroup;return this.addComponent(e,{enabled:s.enabled,orientation:s.orientation,reverseX:s.reverseX,reverseY:s.reverseY,alignment:s.alignment,padding:s.padding,spacing:s.spacing,widthFitting:s.widthFitting,heightFitting:s.heightFitting,wrap:s.wrap})}scheduleReflow(t){this._reflowQueue.indexOf(t)===-1&&this._reflowQueue.push(t)}_onPostUpdate(){this._processReflowQueue()}_processReflowQueue(){if(this._reflowQueue.length===0)return;let t=0;for(;this._reflowQueue.length>0;){const e=this._reflowQueue.slice();this._reflowQueue.length=0,e.sort(function(s,i){return s.entity.graphDepth-i.entity.graphDepth});for(let s=0;s<e.length;++s)e[s].reflow();if(++t>=BM){console.warn("Max reflow iterations limit reached, bailing.");break}}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}st._buildAccessors(t_.prototype,e_);const Hn=[],s_=[];class yd extends st{constructor(t,e){super(t,e);this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.addLight(this)}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeLight(this)}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(let t=0;t<Hn.length;t++){const e=Hn[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}updateShadow(){this.light.updateShadow()}onCookieAssetSet(){let t=!1;this._cookieAsset.type==="cubemap"&&!this._cookieAsset.loadFaces&&(this._cookieAsset.loadFaces=!0,t=!0),(!this._cookieAsset.resource||t)&&this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){!this._cookieAsset||!this._cookieAsset.resource||(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){!this._cookieAssetId||(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}}function ft(o,t,e,s){const i=yd.prototype;Hn.push(o),s_.push(t),Object.defineProperty(i,o,{get:function(){return this.data[o]},set:function(n){const r=this.data,a=r[o];!s&&a===n||(r[o]=n,e&&e.call(this,n,a))},configurable:!0})}function zM(){ft("enabled",!0,function(o,t){this.onSetEnabled(null,t,o)}),ft("light",null),ft("type","directional",function(o,t){this.system.changeType(this,t,o),this.refreshProperties()}),ft("color",new j(1,1,1),function(o,t){this.light.setColor(o)},!0),ft("intensity",1,function(o,t){this.light.intensity=o}),ft("shape",ne,function(o,t){this.light.shape=o}),ft("castShadows",!1,function(o,t){this.light.castShadows=o}),ft("shadowDistance",40,function(o,t){this.light.shadowDistance=o}),ft("shadowResolution",1024,function(o,t){this.light.shadowResolution=o}),ft("shadowBias",.05,function(o,t){this.light.shadowBias=-.01*U.clamp(o,0,1)}),ft("numCascades",1,function(o,t){this.light.numCascades=U.clamp(Math.floor(o),1,4)}),ft("bakeNumSamples",1,function(o,t){this.light.bakeNumSamples=U.clamp(Math.floor(o),1,255)}),ft("bakeArea",0,function(o,t){this.light.bakeArea=U.clamp(o,0,180)}),ft("cascadeDistribution",.5,function(o,t){this.light.cascadeDistribution=U.clamp(o,0,1)}),ft("normalOffsetBias",0,function(o,t){this.light.normalOffsetBias=U.clamp(o,0,1)}),ft("range",10,function(o,t){this.light.attenuationEnd=o}),ft("innerConeAngle",40,function(o,t){this.light.innerConeAngle=o}),ft("outerConeAngle",45,function(o,t){this.light.outerConeAngle=o}),ft("falloffMode",dh,function(o,t){this.light.falloffMode=o}),ft("shadowType",Kt,function(o,t){this.light.shadowType=o}),ft("vsmBlurSize",11,function(o,t){this.light.vsmBlurSize=o}),ft("vsmBlurMode",uh,function(o,t){this.light.vsmBlurMode=o}),ft("vsmBias",.01*.25,function(o,t){this.light.vsmBias=U.clamp(o,0,1)}),ft("cookieAsset",null,function(o,t){if(!(this._cookieAssetId&&(o instanceof rt&&o.id===this._cookieAssetId||o===this._cookieAssetId))){if(this.onCookieAssetRemove(),this._cookieAssetId=null,o instanceof rt)this.data.cookieAsset=o.id,this._cookieAssetId=o.id,this.onCookieAssetAdd(o);else if(typeof o=="number"){this._cookieAssetId=o;const e=this.system.app.assets.get(o);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}}),ft("cookie",null,function(o,t){this.light.cookie=o}),ft("cookieIntensity",1,function(o,t){this.light.cookieIntensity=U.clamp(o,0,1)}),ft("cookieFalloff",!0,function(o,t){this.light.cookieFalloff=o}),ft("cookieChannel","rgb",function(o,t){this.light.cookieChannel=o}),ft("cookieAngle",0,function(o,t){if(o!==0||this.cookieScale!==null){this._cookieMatrix||(this._cookieMatrix=new Z);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(o*U.DEG_TO_RAD),n=Math.sin(o*U.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),ft("cookieScale",null,function(o,t){if(o!==null||this.cookieAngle!==0){this._cookieMatrix||(this._cookieMatrix=new Z);const e=o.x,s=o.y,i=Math.cos(this.cookieAngle*U.DEG_TO_RAD),n=Math.sin(this.cookieAngle*U.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),ft("cookieOffset",null,function(o,t){this.light.cookieOffset=o},!0),ft("shadowUpdateMode",za,function(o,t){this.light.shadowUpdateMode=o},!0),ft("mask",1,function(o,t){this.light.mask=o}),ft("affectDynamic",!0,function(o,t){o?this.light.mask|=xs:this.light.mask&=~xs,this.light.layersDirty()}),ft("affectLightmapped",!1,function(o,t){o?(this.light.mask|=Es,this.bake&&(this.light.mask&=~Rs)):(this.light.mask&=~Es,this.bake&&(this.light.mask|=Rs))}),ft("bake",!1,function(o,t){o?(this.light.mask|=Rs,this.affectLightmapped&&(this.light.mask&=~Es)):(this.light.mask&=~Rs,this.affectLightmapped&&(this.light.mask|=Es)),this.light.layersDirty()}),ft("bakeDir",!0,function(o,t){this.light.bakeDir=o}),ft("isStatic",!1,function(o,t){this.light.isStatic=o}),ft("layers",[xe],function(o,t){for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);!s||s.removeLight(this)}for(let e=0;e<o.length;e++){const s=this.system.app.scene.layers.getLayerById(o[e]);!s||this.enabled&&this.entity.enabled&&s.addLight(this)}})}zM();class UM{constructor(){const t=Hn,e=s_;for(let s=0;s<t.length;s++){const i=e[s];i&&i.clone?this[t[s]]=i.clone():this[t[s]]=i}}}const i_={directional:lt,omni:ut,point:ut,spot:_t};class NM extends Bt{constructor(t){super(t);this.id="light",this.ComponentType=yd,this.DataType=UM,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s=Hn,i={};for(let r=0,a=s.length;r<a;r++){const l=s[r];i[l]=e[l]}i.type||(i.type=t.data.type),t.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new j(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new H(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new H(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=ne);const n=new Rc(this.app.graphicsDevice);n.type=i_[i.type],n._node=t.entity,n._scene=this.app.scene,t.data.light=n,super.initializeComponentData(t,i,s)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,i=[];let n;const r=Hn;for(let a=0;a<r.length;a++)n=r[a],n!=="light"&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(e,i)}changeType(t,e,s){e!==s&&(t.light.type=i_[s])}}class Ml extends st{constructor(t,e){super(t,e);this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._material=void 0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[xe],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(t){!this._model||(this._model.meshInstances=t)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(t){if(this._customAabb=t,this._model){const e=this._model.meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(t){if(this._type!==t)if(this._area=null,this._type=t,t==="asset")this._asset!==null?this._bindModelAsset(this._asset):this.model=null;else{const e=Yf(this.system.app.graphicsDevice,t);this._area=e.area;const s=e.mesh,i=new xt,n=new Ts;n.graph=i,n.meshInstances=[new vt(s,this._material,i)],this.model=n,this._asset=null}}get type(){return this._type}set asset(t){const e=this.system.app.assets;let s=t;if(t instanceof rt&&(s=t.id),this._asset!==s){if(this._asset){e.off("add:"+this._asset,this._onModelAssetAdded,this);const i=e.get(this._asset);i&&this._unbindModelAsset(i)}if(this._asset=s,this._asset){const i=e.get(this._asset);i?this._bindModelAsset(i):(this.model=null,e.on("add:"+this._asset,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(t){if(this._model!==t&&!(t&&t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0;const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].castShadow=this._castShadows,e[s].receiveShadow=this._receiveShadows,e[s].isStatic=this._isStatic,e[s].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),this.type==="asset"?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows===t)return;const e=this._model;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let r=0;r<s.length;r++){const a=this.system.app.scene.layers.getLayerById(this.layers[r]);!a||a.removeShadowCasters(e.meshInstances)}const n=e.meshInstances;for(let r=0;r<n.length;r++)n[r].castShadow=t;if(!this._castShadows&&t)for(let r=0;r<s.length;r++){const a=i.layers.getLayerById(s[r]);!a||a.addShadowCasters(e.meshInstances)}}this._castShadows=t}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model)){const e=this._model.meshInstances;for(let s=0,i=e.length;s<i;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t&&(this._isStatic=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++){const i=e[s];i.isStatic=t}}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;if(this.meshInstances)for(let s=0;s<this._layers.length;s++){const i=e.getLayerById(this._layers[s]);!i||i.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let s=0;s<t.length;s++)this._layers[s]=t[s];if(!(!this.enabled||!this.entity.enabled||!this.meshInstances))for(let s=0;s<this._layers.length;s++){const i=e.getLayerById(this._layers[s]);!i||i.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&e.remove(Wt.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&e.insert(Wt.MODEL,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t}get batchGroupId(){return this._batchGroupId}set materialAsset(t){let e=t;t instanceof rt&&(e=t.id);const s=this.system.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);const i=s.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}if(this._materialAsset=e,this._materialAsset){const i=s.get(this._materialAsset);i?this._bindMaterialAsset(i):(this._setMaterial(this.system.defaultMaterial),s.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}get material(){return this._material}set mapping(t){if(this._type!=="asset"||(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,!this._model))return;const e=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,i=s?s.data.mapping:null;let n=null;for(let r=0,a=e.length;r<a;r++)if(t[r]!==void 0)t[r]?(n=this.system.app.assets.get(t[r]),this._loadAndSetMeshInstanceMaterial(n,e[r],r)):e[r].material=this.system.defaultMaterial;else if(i)if(i[r]&&(i[r].material||i[r].path)){if(i[r].material!==void 0)n=this.system.app.assets.get(i[r].material);else if(i[r].path!==void 0){const l=this._getMaterialAssetUrl(i[r].path);l&&(n=this.system.app.assets.getByUrl(l))}this._loadAndSetMeshInstanceMaterial(n,e[r],r)}else e[r].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);!s||s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,i){const n=e+":"+s;this.system.app.assets.on(n,i,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][n]={id:s,handler:i}}_unsetMaterialEvents(){const t=this.system.app.assets,e=this._materialEvents;if(!!e){for(let s=0,i=e.length;s<i;s++){if(!e[s])continue;const n=e[s];for(const r in n)t.off(r,n[r].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){let e=null;if(!isNaN(parseInt(t,10)))e=this.system.app.assets.get(t);else if(this.asset){const i=this._getMaterialAssetUrl(t);i&&(e=this.system.app.assets.getByUrl(i))}return e}_getMaterialAssetUrl(t){if(!this.asset)return null;const e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){const i=this.system.app.assets;!t||(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,function(){e.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",t.id,function(n){e.material=n.resource,this._setMaterialEvent(s,"remove",t.id,function(){e.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&i.load(t)))}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s=this._type==="asset";let i;if(this._model?this.addModelToLayers():s&&this._asset&&(i=t.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=t.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),s&&this._mapping)for(const n in this._mapping)this._mapping[n]&&(i=this._getAssetByIdOrPath(this._mapping[n]),i&&!i.resource&&t.assets.load(i));this._batchGroupId>=0&&t.batcher.insert(Wt.MODEL,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(Wt.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()}hide(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!1}}show(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!0}}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.system.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.system.app.assets.off("add:"+t.id,this._onModelAssetAdded,this),t.id===this._asset&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,i){e==="data"&&(this.mapping=this._mapping)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material===t)return;this._material=t;const e=this._model;if(e&&this._type!=="asset"){const s=e.meshInstances;for(let i=0,n=s.length;i<n;i++)s[i].material=t}}}class VM{constructor(){this.enabled=!0}}const n_=["enabled"];class WM extends Bt{constructor(t){super(t);this.id="model",this.ComponentType=Ml,this.DataType=VM,this.schema=n_,this.defaultMaterial=zi(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){s=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"],(e.batchGroupId===null||e.batchGroupId===void 0)&&(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new gt(new y(e.aabbCenter),new y(e.aabbHalfExtents))),super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:ei({},t.model.mapping)};let i=t.model.materialAsset;!(i instanceof rt)&&i!=null&&(i=this.app.assets.get(i));const n=t.model.material;(!n||n===this.defaultMaterial||!i||n===i.resource)&&(s.materialAsset=i);const r=this.addComponent(e,s);if(t.model.model&&t.model.type==="asset"&&!t.model.asset&&(r.model=t.model.model.clone(),r._clonedModel=!0),s.materialAsset||(r.material=n),t.model.model){const a=t.model.model.meshInstances,l=r.model.meshInstances;for(let h=0;h<a.length;h++)l[h].mask=a[h].mask,l[h].material=a[h].material,l[h].layer=a[h].layer,l[h].receiveShadow=a[h].receiveShadow}return t.model.customAabb&&(r.customAabb=t.model.customAabb.clone()),r}onRemove(t,e){e.onRemove()}}st._buildAccessors(Ml.prototype,n_);class xd extends st{constructor(t,e){super(t,e);this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._layers=[xe],this._renderStyle=cr,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=[],this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new qi(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new rl("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,vt._prepareRenderStyleForArray(this._meshInstances,t))}get renderStyle(){return this._renderStyle}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),t!=="asset")){let e=this._material;(!e||e===this.system.defaultMaterial)&&(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=Yf(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new vt(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const e=this._meshInstances;for(let s=0;s<e.length;s++)e[s].node||(e[s].node=this.entity),e[s].castShadow=this._castShadows,e[s].receiveShadow=this._receiveShadows,e[s].isStatic=this._isStatic,e[s].renderStyle=this._renderStyle,e[s].setLightmapped(this._lightmapped),e[s].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let n=0;n<s.length;n++){const r=i.layers.getLayerById(this.layers[n]);r&&r.removeShadowCasters(e)}for(let n=0;n<e.length;n++)e[n].castShadow=t;if(!this._castShadows&&t)for(let n=0;n<s.length;n++){const r=i.layers.getLayerById(s[n]);r&&r.addShadowCasters(e)}}this._castShadows=t}}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t){this._isStatic=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].isStatic=t}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let i=0;i<this._layers.length;i++)s=e.getLayerById(this._layers[i]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let i=0;i<t.length;i++)this._layers[i]=t[i];if(!(!this.enabled||!this.entity.enabled||!this._meshInstances))for(let i=0;i<this._layers.length;i++)s=e.getLayerById(this._layers[i]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId!==t){const e=this.system.app.batcher;this.entity.enabled&&this._batchGroupId>=0&&e.remove(Wt.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&e.insert(Wt.RENDER,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t}}get batchGroupId(){return this._batchGroupId}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&this._type!=="asset"))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get material(){return this._material}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new rl(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof rt?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map(function(t){return t.id})}set asset(t){const e=t instanceof rt?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(t){const e=t instanceof rt?t.id:t;this._assetReference.id=e}_onSetRootBone(t){t&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s=this._type==="asset";this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let i=0;i<this._materialReferences.length;i++)this._materialReferences[i].asset&&this.system.app.assets.load(this._materialReferences[i].asset);this._batchGroupId>=0&&t.batcher.insert(Wt.RENDER,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0&&t.batcher.remove(Wt.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){!this._assetReference.asset||(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this),t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];Xe.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof xt)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!s.skinInstance&&(e.skinInstance=Xe.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new vt(i,n||this.system.defaultMaterial,this.entity);e.push(r),i.morph&&(r.morphInstance=new Gi(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){this._type==="asset"&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){t===0&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone]&&(this.rootBone=e[t.rootBone]),this._clearSkinInstances()}}class GM{constructor(){this.enabled=!0,this.rootBone=null}}const vd=[{name:"rootBone",type:"entity"},"enabled"],$i=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class HM extends Bt{constructor(t){super(t);this.id="render",this.ComponentType=xd,this.DataType=GM,this.schema=vd,this.defaultMaterial=zi(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){(e.batchGroupId===null||e.batchGroupId===void 0)&&(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let i=0;i<$i.length;i++)e.hasOwnProperty($i[i])&&(t[$i[i]]=e[$i[i]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new gt(new y(e.aabbCenter),new y(e.aabbHalfExtents))),super.initializeComponentData(t,e,vd)}cloneComponent(t,e){const s={};for(let a=0;a<$i.length;a++)s[$i[a]]=t.render[$i[a]];s.enabled=t.render.enabled,delete s.meshInstances;const i=this.addComponent(e,s),n=t.render.meshInstances,r=n.map(a=>a.mesh);i._onSetMeshes(r);for(let a=0;a<n.length;a++)i.meshInstances[a].material=n[a].material;return t.render.customAabb&&(i.customAabb=t.render.customAabb.clone()),i}onRemove(t,e){e.onRemove()}}st._buildAccessors(xd.prototype,vd);let Ys,r_=1;const J=4,Sd=new G,bd=new G,As=new y,Lt=new y,ls=new y,Xn=new y,De=new y,Ht=new y,jn=new y,qn=new y,ha=new y,a_=new y,le=new y,Pl=new y,Ki=new y;function Yn(o){return o-Math.floor(o)}function XM(o){return Math.max(Math.min(o,1),0)}function wd(o,t){return o-t*Math.floor(o/t)}function jM(o){let t=Yn(o),e=Yn(255*o),s=Yn(65025*o),i=Yn(160581375*o);return t-=e/255,e-=s/255,s-=i/255,i-=i/255,[t,e,s,i]}function El(o){let t=Yn(o),e=Yn(255*o);return t-=e/255,e-=e/255,[t,e]}class qM{constructor(t){this._emitter=t}calcSpawnPosition(t,e,s,i,n){const r=this._emitter,a=Math.random(),l=Math.random(),h=Math.random(),c=Math.random();if(r.useCpu&&(t[n*J+0+r.numParticlesPot*2*J]=a,t[n*J+1+r.numParticlesPot*2*J]=l,t[n*J+2+r.numParticlesPot*2*J]=h),Lt.x=a-.5,Lt.y=l-.5,Lt.z=h-.5,r.emitterShape===gs){const f=Math.max(Math.abs(Lt.x),Math.max(Math.abs(Lt.y),Math.abs(Lt.z))),m=f+(.5-f)*s[0],p=f+(.5-f)*s[1],_=f+(.5-f)*s[2];Lt.x=m*(f===Math.abs(Lt.x)?Math.sign(Lt.x):2*Lt.x),Lt.y=p*(f===Math.abs(Lt.y)?Math.sign(Lt.y):2*Lt.y),Lt.z=_*(f===Math.abs(Lt.z)?Math.sign(Lt.z):2*Lt.z),r.localSpace?As.copy(e.transformPoint(Lt)):As.copy(i).add(e.transformPoint(Lt))}else{Lt.normalize();const f=r.emitterRadius===0?0:r.emitterRadiusInner/r.emitterRadius,m=c*(1-f)+f;r.localSpace?As.copy(Lt.mulScalar(m*r.emitterRadius)):As.copy(i).add(Lt.mulScalar(m*r.emitterRadius))}let u=-U.lerp(r.rate,r.rate2,a)*n;if(r.pack8){const f=(As.x-r.worldBounds.center.x)/r.worldBoundsSize.x+.5,m=(As.y-r.worldBounds.center.y)/r.worldBoundsSize.y+.5,p=(As.z-r.worldBounds.center.z)/r.worldBoundsSize.z+.5;let _=U.lerp(r.startAngle*U.DEG_TO_RAD,r.startAngle2*U.DEG_TO_RAD,a);_=_%(Math.PI*2)/(Math.PI*2);const g=El(f);t[n*J]=g[0],t[n*J+1]=g[1];const w=El(m);t[n*J+2]=w[0],t[n*J+3]=w[1];const v=El(p);t[n*J+0+r.numParticlesPot*J]=v[0],t[n*J+1+r.numParticlesPot*J]=v[1];const x=El(_);t[n*J+2+r.numParticlesPot*J]=x[0],t[n*J+3+r.numParticlesPot*J]=x[1];const S=1;t[n*J+3+r.numParticlesPot*J*2]=S;const T=Math.max(r.lifetime,(r.numParticles-1)*Math.max(r.rate,r.rate2)),b=r.lifetime+1;u=(u+T)/(T+b);const C=jM(u);t[n*J+0+r.numParticlesPot*J*3]=C[0],t[n*J+1+r.numParticlesPot*J*3]=C[1],t[n*J+2+r.numParticlesPot*J*3]=C[2],t[n*J+3+r.numParticlesPot*J*3]=C[3]}else t[n*J]=As.x,t[n*J+1]=As.y,t[n*J+2]=As.z,t[n*J+3]=U.lerp(r.startAngle*U.DEG_TO_RAD,r.startAngle2*U.DEG_TO_RAD,a),t[n*J+3+r.numParticlesPot*J]=u}update(t,e,s,i,n,r,a,l){let h,c,d;const u=this._emitter;if(u.meshInstance.node){const M=u.meshInstance.node.worldTransform;for(let E=0;E<12;E++)Sd.data[E]=M.data[E];bd.copy(Sd),bd.invert(),Ys=u.meshInstance.node.localScale,r_=Math.max(Math.max(Ys.x,Ys.y),Ys.z)}r=u.meshInstance.node===null||u.localSpace?y.ZERO:u.meshInstance.node.getPosition();const f=u.camera?u.camera._node.getPosition():y.ZERO,m=u.useMesh?17:15;let p,_,g,w,v,x,S,T,b;const C=u.precision-1;for(let M=0;M<u.numParticles;M++){const E=Math.floor(u.vbCPU[M*u.numParticleVerts*(u.useMesh?6:4)+3]),D=s[E*J+0+u.numParticlesPot*2*J];ls.x=D,ls.y=s[E*J+1+u.numParticlesPot*2*J],ls.z=s[E*J+2+u.numParticlesPot*2*J];const I=u.rate+(u.rate2-u.rate)*D,k=u.lifetime;let N=s[E*J+3+u.numParticlesPot*J]+a;const X=XM(N/k);let q=0,A=0;const R=0;(N-a<=0||N>=k)&&this.calcSpawnPosition(s,i,n,r,E);let O=N>0&&N<k;O&&(d=X*C,p=Math.floor(d),_=Math.ceil(d),d%=1,h=u.qRotSpeed[p],c=u.qRotSpeed[_],g=h+(c-h)*d,h=u.qRotSpeed2[p],c=u.qRotSpeed2[_],w=h+(c-h)*d,h=u.qScale[p],c=u.qScale[_],q=h+(c-h)*d,h=u.qScale2[p],c=u.qScale2[_],v=h+(c-h)*d,h=u.qAlpha[p],c=u.qAlpha[_],x=h+(c-h)*d,h=u.qAlpha2[p],c=u.qAlpha2[_],S=h+(c-h)*d,h=u.qRadialSpeed[p],c=u.qRadialSpeed[_],T=h+(c-h)*d,h=u.qRadialSpeed2[p],c=u.qRadialSpeed2[_],b=h+(c-h)*d,T+=(b-T)*(D*100%1),Xn.x=s[E*J],Xn.y=s[E*J+1],Xn.z=s[E*J+2],u.localSpace?ha.copy(Xn):ha.copy(Xn).sub(r),ha.normalize().mulScalar(T),p*=3,_*=3,h=u.qLocalVelocity[p],c=u.qLocalVelocity[_],Ht.x=h+(c-h)*d,h=u.qLocalVelocity[p+1],c=u.qLocalVelocity[_+1],Ht.y=h+(c-h)*d,h=u.qLocalVelocity[p+2],c=u.qLocalVelocity[_+2],Ht.z=h+(c-h)*d,h=u.qLocalVelocity2[p],c=u.qLocalVelocity2[_],qn.x=h+(c-h)*d,h=u.qLocalVelocity2[p+1],c=u.qLocalVelocity2[_+1],qn.y=h+(c-h)*d,h=u.qLocalVelocity2[p+2],c=u.qLocalVelocity2[_+2],qn.z=h+(c-h)*d,h=u.qVelocity[p],c=u.qVelocity[_],De.x=h+(c-h)*d,h=u.qVelocity[p+1],c=u.qVelocity[_+1],De.y=h+(c-h)*d,h=u.qVelocity[p+2],c=u.qVelocity[_+2],De.z=h+(c-h)*d,h=u.qVelocity2[p],c=u.qVelocity2[_],jn.x=h+(c-h)*d,h=u.qVelocity2[p+1],c=u.qVelocity2[_+1],jn.y=h+(c-h)*d,h=u.qVelocity2[p+2],c=u.qVelocity2[_+2],jn.z=h+(c-h)*d,Ht.x+=(qn.x-Ht.x)*ls.x,Ht.y+=(qn.y-Ht.y)*ls.y,Ht.z+=(qn.z-Ht.z)*ls.z,u.initialVelocity>0&&(u.emitterShape===$g?(Lt.copy(ls).mulScalar(2).sub(y.ONE).normalize(),Ht.add(Lt.mulScalar(u.initialVelocity))):Ht.add(y.FORWARD.mulScalar(u.initialVelocity))),De.x+=(jn.x-De.x)*ls.x,De.y+=(jn.y-De.y)*ls.y,De.z+=(jn.z-De.z)*ls.z,g+=(w-g)*ls.y,q=(q+(v-q)*(D*1e4%1))*r_,A=(S-x)*(D*1e3%1),u.meshInstance.node&&(u.localSpace?(Ht.x/=Ys.x,Ht.y/=Ys.y,Ht.z/=Ys.z):Sd.transformPoint(Ht,Ht)),u.localSpace?(bd.transformPoint(De,De),Ht.add(De).add(ha)):(Ht.add(De.mul(Ys)),Ht.add(ha.mul(Ys))),Pl.copy(Ht),a_.copy(Xn).add(Ht.mulScalar(a)),le.copy(a_),s[E*J]=le.x,s[E*J+1]=le.y,s[E*J+2]=le.z,s[E*J+3]+=g*a,u.wrap&&u.wrapBounds&&(u.localSpace||le.sub(r),le.x=wd(le.x,u.wrapBounds.x)-u.wrapBounds.x*.5,le.y=wd(le.y,u.wrapBounds.y)-u.wrapBounds.y*.5,le.z=wd(le.z,u.wrapBounds.z)-u.wrapBounds.z*.5,u.localSpace||le.add(r)),u.sort>0&&(u.sort===1?(Ki.copy(le).sub(f),u.particleDistance[E]=-(Ki.x*Ki.x+Ki.y*Ki.y+Ki.z*Ki.z)):u.sort===2?u.particleDistance[E]=N:u.sort===3&&(u.particleDistance[E]=-N))),l?N<0&&(s[E*J+3+u.numParticlesPot*2*J]=-1):(N>=k&&(N-=Math.max(k,(u.numParticles-1)*I),s[E*J+3+u.numParticlesPot*2*J]=u.loop?1:-1),N<0&&u.loop&&(s[E*J+3+u.numParticlesPot*2*J]=1)),s[E*J+3+u.numParticlesPot*2*J]<0&&(O=!1),s[E*J+3+u.numParticlesPot*J]=N;for(let z=0;z<u.numParticleVerts;z++){const W=(M*u.numParticleVerts+z)*(u.useMesh?6:4);let K=u.vbCPU[W],V=u.vbCPU[W+1],P=u.vbCPU[W+2];O||(K=V=P=0);const B=M*u.numParticleVerts*m+z*m;t[B]=le.x,t[B+1]=le.y,t[B+2]=le.z,t[B+3]=X,t[B+4]=u.alignToMotion?R:s[E*J+3],t[B+5]=q,t[B+6]=A,t[B+7]=Pl.x,t[B+8]=K,t[B+9]=V,t[B+10]=P,t[B+11]=Pl.y,t[B+12]=E,t[B+13]=Pl.z,t[B+14]=u.vbCPU[W+3],u.useMesh&&(t[B+15]=u.vbCPU[W+4],t[B+16]=u.vbCPU[W+5])}}if(u.sort>fh&&u.camera){const M=u.useMesh?6:4,E=u.particleDistance;for(let D=0;D<u.numParticles;D++)e[D][0]=D,e[D][1]=E[Math.floor(u.vbCPU[D*u.numParticleVerts*M+3])];u.vbOld.set(u.vbCPU),e.sort(function(D,I){return D[1]-I[1]});for(let D=0;D<u.numParticles;D++){const I=e[D][0]*u.numParticleVerts*M,k=D*u.numParticleVerts*M;for(let N=0;N<u.numParticleVerts*M;N++)u.vbCPU[k+N]=u.vbOld[I+N]}}}}const o_=new Qt,l_=new Qt,h_=new Qt;class YM{constructor(t,e){this._emitter=t,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=e.scope.resolve("particleTexIN"),this.constantParticleTexOUT=e.scope.resolve("particleTexOUT"),this.constantEmitterPos=e.scope.resolve("emitterPos"),this.constantEmitterScale=e.scope.resolve("emitterScale"),this.constantSpawnBounds=e.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=e.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=e.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=e.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=e.scope.resolve("initialVelocity"),this.constantFrameRandom=e.scope.resolve("frameRandom"),this.constantDelta=e.scope.resolve("delta"),this.constantRate=e.scope.resolve("rate"),this.constantRateDiv=e.scope.resolve("rateDiv"),this.constantLifetime=e.scope.resolve("lifetime"),this.constantGraphSampleSize=e.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=e.scope.resolve("graphNumSamples"),this.constantInternalTex0=e.scope.resolve("internalTex0"),this.constantInternalTex1=e.scope.resolve("internalTex1"),this.constantInternalTex2=e.scope.resolve("internalTex2"),this.constantInternalTex3=e.scope.resolve("internalTex3"),this.constantEmitterMatrix=e.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=e.scope.resolve("emitterMatrixInv"),this.constantNumParticles=e.scope.resolve("numParticles"),this.constantNumParticlesPot=e.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=e.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=e.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=e.scope.resolve("rotSpeedDivMult"),this.constantSeed=e.scope.resolve("seed"),this.constantStartAngle=e.scope.resolve("startAngle"),this.constantStartAngle2=e.scope.resolve("startAngle2"),this.constantOutBoundsMul=e.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=e.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=e.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=e.scope.resolve("inBoundsCenter"),this.constantMaxVel=e.scope.resolve("maxVel"),this.constantFaceTangent=e.scope.resolve("faceTangent"),this.constantFaceBinorm=e.scope.resolve("faceBinorm")}_setInputBounds(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)}randomize(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()}update(t,e,s,i,n){const r=this._emitter;t.setBlending(!1),t.setColorWrite(!0,!0,!0,!0),t.setCullMode(me),t.setDepthTest(!1),t.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/r.precision),this.constantGraphNumSamples.setValue(r.precision),this.constantNumParticles.setValue(r.numParticles),this.constantNumParticlesPot.setValue(r.numParticlesPot),this.constantInternalTex0.setValue(r.internalTex0),this.constantInternalTex1.setValue(r.internalTex1),this.constantInternalTex2.setValue(r.internalTex2),this.constantInternalTex3.setValue(r.internalTex3);const a=r.meshInstance.node,l=a===null?y.ONE:a.localScale;if(r.pack8){this.worldBoundsMulUniform[0]=r.worldBoundsMul.x,this.worldBoundsMulUniform[1]=r.worldBoundsMul.y,this.worldBoundsMulUniform[2]=r.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=r.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=r.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=r.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();let f=r.maxVel*Math.max(Math.max(l.x,l.y),l.z);f=Math.max(f,1),this.constantMaxVel.setValue(f)}const h=a===null||r.localSpace?y.ZERO:a.getPosition(),c=a===null?G.IDENTITY:a.getWorldTransform();r.emitterShape===gs?(o_.setFromMat4(e),this.constantSpawnBounds.setValue(o_.data),this.constantSpawnPosInnerRatio.setValue(s)):(this.constantSpawnBoundsSphere.setValue(r.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(r.emitterRadius===0?0:r.emitterRadiusInner/r.emitterRadius)),this.constantInitialVelocity.setValue(r.initialVelocity),l_.setFromMat4(c),c.invertTo3x3(h_),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(i),this.constantRate.setValue(r.rate),this.constantRateDiv.setValue(r.rate2-r.rate),this.constantStartAngle.setValue(r.startAngle*U.DEG_TO_RAD),this.constantStartAngle2.setValue(r.startAngle2*U.DEG_TO_RAD),this.constantSeed.setValue(r.seed),this.constantLifetime.setValue(r.lifetime),this.emitterScaleUniform[0]=l.x,this.emitterScaleUniform[1]=l.y,this.emitterScaleUniform[2]=l.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(l_.data),this.constantEmitterMatrixInv.setValue(h_.data),this.constantLocalVelocityDivMult.setValue(r.localVelocityUMax),this.constantVelocityDivMult.setValue(r.velocityUMax),this.constantRotSpeedDivMult.setValue(r.rotSpeedUMax[0]);let d=r.swapTex?r.particleTexOUT:r.particleTexIN;d=r.beenReset?r.particleTexStart:d;const u=r.swapTex?r.particleTexIN:r.particleTexOUT;this.constantParticleTexIN.setValue(d),es(t,r.swapTex?r.rtParticleTexIN:r.rtParticleTexOUT,n?r.shaderParticleUpdateOnStop:r.loop?r.shaderParticleUpdateRespawn:r.shaderParticleUpdateNoRespawn),r.material.setParameter("particleTexOUT",d),r.material.setParameter("particleTexIN",u),r.beenReset=!1,r.swapTex=!r.swapTex,t.setDepthTest(!0),t.setDepthWrite(!0),r.prevWorldBoundsSize.copy(r.worldBoundsSize),r.prevWorldBoundsCenter.copy(r.worldBounds.center),r.pack8&&this._setInputBounds()}}const c_=[[-1,-1],[1,-1],[1,1],[-1,1]];function $e(o,t,e,s,i=Vt,n,r){let a=bt;r&&i===ct&&(a=Yt);const l=new nt(o,{width:t,height:e,format:i,cubemap:!1,mipmaps:!1,minFilter:a,magFilter:a,addressU:et,addressV:et});l.name="PSTexture";const h=l.lock();if(i===ct){const c=new Uint8Array(s.length);for(let d=0;d<s.length;d++)c[d]=s[d]*n*255;s=c}return h.set(s),l.unlock(),l}function d_(o){return Math.max(Math.min(o,1),0)}const u_=new fe([0,0,1,0]),f_=new fe([0,1,1,1]),m_=new us([0,0,1,0],[0,0,1,0],[0,0,1,0]),$M=new us([0,1,1,1],[0,1,1,1],[0,1,1,1]);let $s=2;const Rl=4,Ks=new Float32Array(3),Zi=new G,p_=new y,Il=new y,Ll=new y;let Td,Dl;function Q(o,t){Dl[o]!==void 0&&Dl[o]!==null?Td[o]=Dl[o]:Td[o]=t}function __(o,t,e){return(o*255<<16|t*255<<8|e*255)/(1<<24)}function g_(o,t){const e=o.length/3,s=new Array(e*4);for(let i=0;i<e;i++)s[i*4]=o[i*3],s[i*4+1]=o[i*3+1],s[i*4+2]=o[i*3+2],s[i*4+3]=__(t[i*3],t[i*3+1],t[i*3+2]);return s}function KM(o,t){const e=new Array(t.length*4);for(let s=0;s<t.length;s++)e[s*4]=o[s*3],e[s*4+1]=o[s*3+1],e[s*4+2]=o[s*3+2],e[s*4+3]=t[s];return e}function ZM(o,t,e,s,i){const n=new Array(o.length*4);for(let r=0;r<o.length;r++)n[r*4]=o[r],n[r*4+1]=t[r],n[r*4+2]=0,n[r*4+3]=__(e[r],s[r],i[r]);return n}function JM(o,t){const e=new Array(o.length*4);for(let s=0;s<o.length;s++)e[s*4]=o[s],e[s*4+1]=t[s],e[s*4+2]=0,e[s*4+3]=0;return e}function QM(o){const t=Math.max(o.rate,o.rate2)*o.numParticles+o.lifetime;return Date.now()+t*1e3}function tP(o,t){const e=new Float32Array(o.length);for(let s=0;s<o.length;s++)e[s]=o[s]-t[s];return e}function Ji(o,t){const e=t.length,s=o.length/e;for(let i=0;i<s;i++)for(let n=0;n<e;n++){const r=Math.abs(o[i*e+n]);t[n]=Math.max(t[n],r)}}function eP(o,t){const e=t.length,s=o.length/e;for(let i=0;i<s;i++)for(let n=0;n<e;n++)o[i*e+n]/=t[n]===0?1:t[n],o[i*e+n]*=.5,o[i*e+n]+=.5}function Qi(o,t,e){const s=tP(t,o);return Ji(s,e),eP(s,e),s}const sP=new Rr;class iP{constructor(t,e){this.graphicsDevice=t;const s=t,i=32;this.precision=i,this._addTimeTime=0,Td=this,Dl=e,Q("numParticles",1),this.numParticles>t.maxTextureSize&&(this.numParticles=t.maxTextureSize),Q("rate",1),Q("rate2",this.rate),Q("lifetime",50),Q("emitterExtents",new y(0,0,0)),Q("emitterExtentsInner",new y(0,0,0)),Q("emitterRadius",0),Q("emitterRadiusInner",0),Q("emitterShape",gs),Q("initialVelocity",1),Q("wrap",!1),Q("localSpace",!1),Q("screenSpace",!1),Q("wrapBounds",null),Q("colorMap",this.defaultParamTexture),Q("normalMap",null),Q("loop",!0),Q("preWarm",!1),Q("sort",fh),Q("mode",Au),Q("scene",null),Q("lighting",!1),Q("halfLambert",!1),Q("intensity",1),Q("stretch",0),Q("alignToMotion",!1),Q("depthSoftening",0),Q("mesh",null),Q("particleNormal",new y(0,1,0)),Q("orientation",Ma),Q("depthWrite",!1),Q("noFog",!1),Q("blendType",Be),Q("node",null),Q("startAngle",0),Q("startAngle2",this.startAngle),Q("animTilesX",1),Q("animTilesY",1),Q("animStartFrame",0),Q("animNumFrames",1),Q("animNumAnimations",1),Q("animIndex",0),Q("randomizeAnimIndex",!1),Q("animSpeed",1),Q("animLoop",!0),this._gpuUpdater=new YM(this,s),this._cpuUpdater=new qM(this),this.constantLightCube=s.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Q("colorGraph",$M),Q("colorGraph2",this.colorGraph),Q("scaleGraph",f_),Q("scaleGraph2",this.scaleGraph),Q("alphaGraph",f_),Q("alphaGraph2",this.alphaGraph),Q("localVelocityGraph",m_),Q("localVelocityGraph2",this.localVelocityGraph),Q("velocityGraph",m_),Q("velocityGraph2",this.velocityGraph),Q("rotationSpeedGraph",u_),Q("rotationSpeedGraph2",this.rotationSpeedGraph),Q("radialSpeedGraph",u_),Q("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(6*3),this.lightCubeDir=new Array(6),this.lightCubeDir[0]=new y(-1,0,0),this.lightCubeDir[1]=new y(1,0,0),this.lightCubeDir[2]=new y(0,-1,0),this.lightCubeDir[3]=new y(0,1,0),this.lightCubeDir[4]=new y(0,0,-1),this.lightCubeDir[5]=new y(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.internalTex0=null,this.internalTex1=null,this.internalTex2=null,this.colorParam=null,this.vbToSort=null,this.vbOld=null,this.particleDistance=null,this.camera=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!t.supportsGpuParticles,this.pack8=!0,this.localBounds=new gt,this.worldBoundsNoTrail=new gt,this.worldBoundsTrail=[new gt,new gt],this.worldBounds=new gt,this.worldBoundsSize=new y,this.prevWorldBoundsSize=new y,this.prevWorldBoundsCenter=new y,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new y,this.worldBoundsAdd=new y,this.timeToSwitchBounds=0,this.shaderParticleUpdateRespawn=null,this.shaderParticleUpdateNoRespawn=null,this.shaderParticleUpdateOnStop=null,this.numParticleVerts=0,this.numParticleIndices=0,this.material=null,this.meshInstance=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTime=0,this.simTimeTotal=0,this.beenReset=!1,this._layer=null,this.rebuild()}get defaultParamTexture(){return sP.get(this.graphicsDevice,()=>{const t=16,e=t*.5+.5,s=new Float32Array(t*t*4);for(let n=0;n<t;n++)for(let r=0;r<t;r++){const a=r+1-e,l=n+1-e,h=d_(1-d_(Math.sqrt(a*a+l*l)/t)-.5),c=n*t+r;s[c*4]=1,s[c*4+1]=1,s[c*4+2]=1,s[c*4+3]=h}const i=$e(this.graphicsDevice,t,t,s,ct,1,!0);return i.minFilter=Yt,i.magFilter=Yt,i})}onChangeCamera(){this.regenShader(),this.resetMaterial()}calculateBoundsMad(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).mulScalar(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5}calculateWorldBounds(){if(!this.node)return;if(this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),!this.useCpu){let s=!1;this.emitterShape===gs?s=!this.emitterExtents.equals(this.prevEmitterExtents):s=this.emitterRadius!==this.prevEmitterRadius,s&&this.calculateLocalBounds()}const t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);const e=this.simTimeTotal;e>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=e+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}resetWorldBounds(){!this.node||(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?G.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.simTimeTotal=0,this.timeToSwitchBounds=0)}calculateLocalBounds(){let t=Number.MAX_VALUE,e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=-Number.MAX_VALUE,n=-Number.MAX_VALUE,r=-Number.MAX_VALUE,a=0,l=0;const h=this.lifetime/this.precision,c=[this.qVelocity,this.qVelocity2],d=[this.qLocalVelocity,this.qLocalVelocity2],u=[0,0],f=[0,0],m=[0,0],p=[0,0],_=[0,0];let g,w,v;for(let S=0;S<this.precision+1;S++){const T=Math.min(S,this.precision-1);for(let b=0;b<2;b++)g=d[b][T*3+0]*h+u[b],w=d[b][T*3+1]*h+f[b],v=d[b][T*3+2]*h+m[b],t=Math.min(g,t),e=Math.min(w,e),s=Math.min(v,s),i=Math.max(g,i),n=Math.max(w,n),r=Math.max(v,r),u[b]=g,f[b]=w,m[b]=v;for(let b=0;b<2;b++)_[b]+=h*Math.sqrt(c[b][T*3+0]*c[b][T*3+0]+c[b][T*3+1]*c[b][T*3+1]+c[b][T*3+2]*c[b][T*3+2]);p[0]+=this.qRadialSpeed[T]*h,p[1]+=this.qRadialSpeed2[T]*h,a=Math.max(a,Math.max(Math.abs(p[0]),Math.abs(p[1]))),l=Math.max(l,this.qScale[T])}this.emitterShape===gs?(g=this.emitterExtents.x*.5,w=this.emitterExtents.y*.5,v=this.emitterExtents.z*.5):(g=this.emitterRadius,w=this.emitterRadius,v=this.emitterRadius);const x=Math.max(_[0],_[1]);Il.x=t-l-g-a-x,Il.y=e-l-w-a-x,Il.z=s-l-v-a-x,Ll.x=i+l+g+a+x,Ll.y=n+l+w+a+x,Ll.z=r+l+v+a+x,this.localBounds.setMinMax(Il,Ll)}rebuild(){const t=this.graphicsDevice;this.colorMap===null&&(this.colorMap=this.defaultParamTexture),this.spawnBounds=this.emitterShape===gs?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||this.sort>fh||t.maxVertexTextures<=1||t.fragmentUniformsCount<64||t.forceCpuParticles||!t.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!t.textureFloatRenderable)&&!this.useCpu,$s=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(this.numParticles*this.mesh.vertexBuffer.numVertices>65535||(this.useMesh=!0)),this.numParticlesPot=U.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?G.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).mulScalar(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=new Array(this.numParticles);for(let c=0;c<this.numParticles;c++)this.vbToSort[c]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*$s*Rl);const e=this.node===null||this.localSpace?y.ZERO:this.node.getPosition();this.emitterShape===gs&&(this.node===null||this.localSpace?Zi.setTRS(y.ZERO,tt.IDENTITY,this.spawnBounds):Zi.setTRS(y.ZERO,this.node.getRotation(),p_.copy(this.spawnBounds).mul(this.node.localScale)),Ks[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,Ks[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,Ks[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(let c=0;c<this.numParticles;c++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Zi,Ks,e,c),this.useCpu&&(this.particleTex[c*Rl+3+this.numParticlesPot*2*Rl]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*$s*Rl);for(let c=0;c<this.particleTexStart.length;c++)this.particleTexStart[c]=this.particleTex[c];this.useCpu||(this.pack8?(this.particleTexIN=$e(t,this.numParticlesPot,$s,this.particleTex,ct,1,!1),this.particleTexOUT=$e(t,this.numParticlesPot,$s,this.particleTex,ct,1,!1),this.particleTexStart=$e(t,this.numParticlesPot,$s,this.particleTexStart,ct,1,!1)):(this.particleTexIN=$e(t,this.numParticlesPot,$s,this.particleTex),this.particleTexOUT=$e(t,this.numParticlesPot,$s,this.particleTex),this.particleTexStart=$e(t,this.numParticlesPot,$s,this.particleTexStart)),this.rtParticleTexIN=new oe({colorBuffer:this.particleTexIN,depth:!1}),this.rtParticleTexOUT=new oe({colorBuffer:this.particleTexOUT,depth:!1}),this.swapTex=!1);const s=(this.localSpace?`#define LOCAL_SPACE
`:"")+F.particleUpdaterInitPS+(this.pack8?F.particleInputRgba8PS+F.particleOutputRgba8PS:F.particleInputFloatPS+F.particleOutputFloatPS)+(this.emitterShape===gs?F.particleUpdaterAABBPS:F.particleUpdaterSpherePS)+F.particleUpdaterStartPS,i=s+F.particleUpdaterRespawnPS+F.particleUpdaterEndPS,n=s+F.particleUpdaterNoRespawnPS+F.particleUpdaterEndPS,r=s+F.particleUpdaterOnStopPS+F.particleUpdaterEndPS,a=this.emitterShape+""+this.pack8+""+this.localSpace;this.shaderParticleUpdateRespawn=we(t,F.fullscreenQuadVS,i,"fsQuad0"+a),this.shaderParticleUpdateNoRespawn=we(t,F.fullscreenQuadVS,n,"fsQuad1"+a),this.shaderParticleUpdateOnStop=we(t,F.fullscreenQuadVS,r,"fsQuad2"+a),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles);const l=new is(t);l.vertexBuffer=this.vertexBuffer,l.indexBuffer[0]=this.indexBuffer,l.primitive[0].type=ts,l.primitive[0].base=0,l.primitive[0].count=this.numParticles*this.numParticleIndices,l.primitive[0].indexed=!0,this.material=new Ue,this.material.name=this.node.name,this.material.cull=me,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial();const h=this.meshInstance?this.meshInstance.visible:!0;this.meshInstance=new vt(l,this.material,this.node),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=h,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)}_isAnimated(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==this.defaultParamTexture||this.normalMap)}rebuildGraphs(){const t=this.precision,e=this.graphicsDevice;this.qLocalVelocity=this.localVelocityGraph.quantize(t),this.qVelocity=this.velocityGraph.quantize(t),this.qColor=this.colorGraph.quantizeClamped(t,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(t),this.qScale=this.scaleGraph.quantize(t),this.qAlpha=this.alphaGraph.quantize(t),this.qRadialSpeed=this.radialSpeedGraph.quantize(t),this.qLocalVelocity2=this.localVelocityGraph2.quantize(t),this.qVelocity2=this.velocityGraph2.quantize(t),this.qColor2=this.colorGraph2.quantizeClamped(t,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t),this.qScale2=this.scaleGraph2.quantize(t),this.qAlpha2=this.alphaGraph2.quantize(t),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t);for(let s=0;s<t;s++)this.qRotSpeed[s]*=U.DEG_TO_RAD,this.qRotSpeed2[s]*=U.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=Qi(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=Qi(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=Qi(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=Qi(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=Qi(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=Qi(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=Qi(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){const s=[0,0,0];Ji(this.qVelocity,s);const i=[0,0,0];Ji(this.qVelocity2,i);const n=[0,0,0];Ji(this.qLocalVelocity,n);const r=[0,0,0];Ji(this.qLocalVelocity2,r);const a=[0];Ji(this.qRadialSpeed,a);const l=[0];Ji(this.qRadialSpeed2,l);let h=Math.max(s[0],i[0]);h=Math.max(h,s[1]),h=Math.max(h,i[1]),h=Math.max(h,s[2]),h=Math.max(h,i[2]);let c=Math.max(n[0],r[0]);c=Math.max(c,n[1]),c=Math.max(c,r[1]),c=Math.max(c,n[2]),c=Math.max(c,r[2]);const d=Math.max(a[0],l[0]);this.maxVel=h+c+d}this.useCpu||(this.internalTex0=$e(e,t,1,g_(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=$e(e,t,1,g_(this.qVelocity,this.qVelocityDiv)),this.internalTex2=$e(e,t,1,ZM(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv)),this.internalTex3=$e(e,t,1,JM(this.qRadialSpeed,this.qRadialSpeedDiv))),this.colorParam=$e(e,t,1,KM(this.qColor,this.qAlpha),ct,1,!0)}_initializeTextures(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))}regenShader(){const t=this.graphicsDevice.getProgramLibrary(),e=this.normalMap!==null;this.normalOption=0,this.lighting&&(this.normalOption=e?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!==this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());const s=this.emitter.inTools,i=t.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:s?!1:this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!==Ma});this.shader=i},this.material.updateShader()}resetMaterial(){const t=this.material;t.setParameter("stretch",this.stretch),this._isAnimated()&&(t.setParameter("animTexTilesParams",this.animTilesParams),t.setParameter("animTexParams",this.animParams),t.setParameter("animTexIndexParams",this.animIndexParams)),t.setParameter("colorMult",this.intensity),this.useCpu||(t.setParameter("internalTex0",this.internalTex0),t.setParameter("internalTex1",this.internalTex1),t.setParameter("internalTex2",this.internalTex2),t.setParameter("internalTex3",this.internalTex3)),t.setParameter("colorParam",this.colorParam),t.setParameter("numParticles",this.numParticles),t.setParameter("numParticlesPot",this.numParticlesPot),t.setParameter("lifetime",this.lifetime),t.setParameter("rate",this.rate),t.setParameter("rateDiv",this.rate2-this.rate),t.setParameter("seed",this.seed),t.setParameter("scaleDivMult",this.scaleUMax[0]),t.setParameter("alphaDivMult",this.alphaUMax[0]),t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),t.setParameter("graphNumSamples",this.precision),t.setParameter("graphSampleSize",1/this.precision),t.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),t.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,t.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&t.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&t.setParameter("normalMap",this.normalMap),this.depthSoftening>0&&t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),this.stretch>0&&(t.cull=me),this._compParticleFaceParams()}_compParticleFaceParams(){let t,e;if(this.orientation===Ma)t=new Float32Array([1,0,0]),e=new Float32Array([0,0,1]);else{let s;this.orientation===Kg?s=this.particleNormal.normalize():s=(this.node===null?G.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();const i=new y(1,0,0);Math.abs(i.dot(s))===1&&i.set(0,0,1);const n=new y().cross(s,i).normalize();i.cross(n,s).normalize(),t=new Float32Array([i.x,i.y,i.z]),e=new Float32Array([n.x,n.y,n.z])}this.material.setParameter("faceTangent",t),this.material.setParameter("faceBinorm",e)}_allocate(t){const e=t*this.numParticleVerts,s=t*this.numParticleIndices;if(this.vertexBuffer===void 0||this.vertexBuffer.getNumVertices()!==e){if(this.useCpu){const c=[{semantic:co,components:4,type:wt},{semantic:Fh,components:4,type:wt},{semantic:Zu,components:4,type:wt},{semantic:Ju,components:1,type:wt},{semantic:Qu,components:this.useMesh?4:2,type:wt}],d=new re(this.graphicsDevice,c);this.vertexBuffer=new Ds(this.graphicsDevice,d,e,mr),this.indexBuffer=new ui(this.graphicsDevice,Is,s)}else{const c=[{semantic:co,components:4,type:wt}];this.useMesh&&c.push({semantic:Fh,components:2,type:wt});const d=new re(this.graphicsDevice,c);this.vertexBuffer=new Ds(this.graphicsDevice,d,e,mr),this.indexBuffer=new ui(this.graphicsDevice,Is,s)}const i=new Float32Array(this.vertexBuffer.lock());let n,r,a;if(this.useMesh){n=new Float32Array(this.mesh.vertexBuffer.lock()),r=n.length/this.mesh.vertexBuffer.numVertices;for(let c=0;c<this.mesh.vertexBuffer.format.elements.length;c++)if(this.mesh.vertexBuffer.format.elements[c].name===be){a=this.mesh.vertexBuffer.format.elements[c].offset/4;break}}for(let c=0;c<e;c++){const d=Math.floor(c/this.numParticleVerts);if(this.useMesh){const u=c%this.numParticleVerts;i[c*6]=n[u*r],i[c*6+1]=n[u*r+1],i[c*6+2]=n[u*r+2],i[c*6+3]=d,i[c*6+4]=n[u*r+a+0],i[c*6+5]=1-n[u*r+a+1]}else{const u=c%4;i[c*4]=c_[u][0],i[c*4+1]=c_[u][1],i[c*4+2]=0,i[c*4+3]=d}}this.useCpu&&(this.vbCPU=new Float32Array(i),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock();let l=0;const h=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(let c=0;c<t;c++)if(this.useMesh)for(let d=0;d<this.numParticleIndices;d++)h[c*this.numParticleIndices+d]=n[d]+c*this.numParticleVerts;else{const d=c*4;h[l++]=d,h[l++]=d+1,h[l++]=d+2,h[l++]=d,h[l++]=d+2,h[l++]=d+3}this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}}reset(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(let e=0;e<this.particleTexStart.length;e++)this.particleTex[e]=this.particleTexStart[e];else this._initializeTextures();this.resetWorldBounds(),this.resetTime();const t=this.loop;this.loop=!0,this.addTime(0,!1),this.loop=t,this.preWarm&&this.prewarm(this.lifetime)}prewarm(t){const e=t/this.lifetime,s=Math.min(Math.floor(e*this.precision),this.precision),i=t/s;for(let n=0;n<s;n++)this.addTime(i,!1)}resetTime(){this.endTime=QM(this)}finishFrame(){this.useCpu&&this.vertexBuffer.unlock()}addTime(t,e){const s=this.graphicsDevice;if(this.simTimeTotal+=t,this.calculateWorldBounds(),this._isAnimated()){const r=this.animTilesParams;r[0]=1/this.animTilesX,r[1]=1/this.animTilesY;const a=this.animParams;a[0]=this.animStartFrame,a[1]=this.animNumFrames*this.animSpeed,a[2]=this.animNumFrames-1,a[3]=this.animNumAnimations-1;const l=this.animIndexParams;l[0]=this.animIndex,l[1]=this.randomizeAnimIndex}this.scene&&this.camera!==this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),this.emitterShape===gs&&(Ks[0]=this.emitterExtents.x!==0?this.emitterExtentsInner.x/this.emitterExtents.x:0,Ks[1]=this.emitterExtents.y!==0?this.emitterExtentsInner.y/this.emitterExtents.y:0,Ks[2]=this.emitterExtents.z!==0?this.emitterExtentsInner.z/this.emitterExtents.z:0,this.meshInstance.node===null?Zi.setTRS(y.ZERO,tt.IDENTITY,this.emitterExtents):Zi.setTRS(y.ZERO,this.meshInstance.node.getRotation(),p_.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));let i;const n=this.meshInstance.node===null?y.ONE:this.meshInstance.node.localScale;if(this.emitterScaleUniform[0]=n.x,this.emitterScaleUniform[1]=n.y,this.emitterScaleUniform[2]=n.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node&&(i=this.meshInstance.node.getPosition(),this.emitterPosUniform[0]=i.x,this.emitterPosUniform[1]=i.y,this.emitterPosUniform[2]=i.z,this.material.setParameter("emitterPos",this.emitterPosUniform)),this._compParticleFaceParams(),!this.useCpu)this._gpuUpdater.update(s,Zi,Ks,t,e);else{const r=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(r,this.vbToSort,this.particleTex,Zi,Ks,i,t,e)}this.loop||Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)}_destroyResources(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)}destroy(){this.camera=null,this._destroyResources()}}const nP=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],rP=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],aP=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],Fl=["colorMapAsset","normalMapAsset","meshAsset","renderAsset"];let $n;class y_ extends st{constructor(t,e){super(t,e);this._requestedDepth=!1,this._drawOrder=0,this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_renderAsset",this.onSetRenderAsset,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),nP.forEach(s=>{this.on(`set_${s}`,this.onSetSimpleProperty,this)}),rP.forEach(s=>{this.on(`set_${s}`,this.onSetComplexProperty,this)}),aP.forEach(s=>{this.on(`set_${s}`,this.onSetGraphProperty,this)})}set drawOrder(t){this._drawOrder=t,this.emitter&&(this.emitter.drawOrder=t)}get drawOrder(){return this._drawOrder}addMeshInstanceToLayers(){if(!!this.emitter)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);!e||(e.addMeshInstances([this.emitter.meshInstance]),this.emitter._layer=e)}}removeMeshInstanceFromLayers(){if(!!this.emitter)for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);!e||e.removeMeshInstances([this.emitter.meshInstance])}}onSetLayers(t,e,s){if(!!this.emitter){for(let i=0;i<e.length;i++){const n=this.system.app.scene.layers.getLayerById(e[i]);!n||n.removeMeshInstances([this.emitter.meshInstance])}if(!(!this.enabled||!this.entity.enabled))for(let i=0;i<s.length;i++){const n=this.system.app.scene.layers.getLayerById(s[i]);!n||n.addMeshInstances([this.emitter.meshInstance])}}}onLayersChanged(t,e){this.addMeshInstanceToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){!this.emitter||this.layers.indexOf(t.id)<0||t.addMeshInstances([this.emitter.meshInstance])}onLayerRemoved(t){!this.emitter||this.layers.indexOf(t.id)<0||t.removeMeshInstances([this.emitter.meshInstance])}_bindColorMapAsset(t){if(t.on("load",this._onColorMapAssetLoad,this),t.on("unload",this._onColorMapAssetUnload,this),t.on("remove",this._onColorMapAssetRemove,this),t.on("change",this._onColorMapAssetChange,this),t.resource)this._onColorMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindColorMapAsset(t){t.off("load",this._onColorMapAssetLoad,this),t.off("unload",this._onColorMapAssetUnload,this),t.off("remove",this._onColorMapAssetRemove,this),t.off("change",this._onColorMapAssetChange,this)}_onColorMapAssetLoad(t){this.colorMap=t.resource}_onColorMapAssetUnload(t){this.colorMap=null}_onColorMapAssetRemove(t){this._onColorMapAssetUnload(t)}_onColorMapAssetChange(t){}onSetColorMapAsset(t,e,s){const i=this.system.app.assets;if(e){const n=i.get(e);n&&this._unbindColorMapAsset(n)}if(s){s instanceof rt&&(this.data.colorMapAsset=s.id,s=s.id);const n=i.get(s);n?this._bindColorMapAsset(n):i.once("add:"+s,r=>{this._bindColorMapAsset(r)})}else this.colorMap=null}_bindNormalMapAsset(t){if(t.on("load",this._onNormalMapAssetLoad,this),t.on("unload",this._onNormalMapAssetUnload,this),t.on("remove",this._onNormalMapAssetRemove,this),t.on("change",this._onNormalMapAssetChange,this),t.resource)this._onNormalMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindNormalMapAsset(t){t.off("load",this._onNormalMapAssetLoad,this),t.off("unload",this._onNormalMapAssetUnload,this),t.off("remove",this._onNormalMapAssetRemove,this),t.off("change",this._onNormalMapAssetChange,this)}_onNormalMapAssetLoad(t){this.normalMap=t.resource}_onNormalMapAssetUnload(t){this.normalMap=null}_onNormalMapAssetRemove(t){this._onNormalMapAssetUnload(t)}_onNormalMapAssetChange(t){}onSetNormalMapAsset(t,e,s){const i=this.system.app.assets;if(e){const n=i.get(e);n&&this._unbindNormalMapAsset(n)}if(s){s instanceof rt&&(this.data.normalMapAsset=s.id,s=s.id);const n=i.get(s);n?this._bindNormalMapAsset(n):i.once("add:"+s,r=>{this._bindNormalMapAsset(r)})}else this.normalMap=null}_bindMeshAsset(t){if(t.on("load",this._onMeshAssetLoad,this),t.on("unload",this._onMeshAssetUnload,this),t.on("remove",this._onMeshAssetRemove,this),t.on("change",this._onMeshAssetChange,this),t.resource)this._onMeshAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMeshAsset(t){t.off("load",this._onMeshAssetLoad,this),t.off("unload",this._onMeshAssetUnload,this),t.off("remove",this._onMeshAssetRemove,this),t.off("change",this._onMeshAssetChange,this)}_onMeshAssetLoad(t){this._onMeshChanged(t.resource)}_onMeshAssetUnload(t){this.mesh=null}_onMeshAssetRemove(t){this._onMeshAssetUnload(t)}_onMeshAssetChange(t){}onSetMeshAsset(t,e,s){const i=this.system.app.assets;if(e){const n=i.get(e);n&&this._unbindMeshAsset(n)}if(s){s instanceof rt&&(this.data.meshAsset=s.id,s=s.id);const n=i.get(s);n&&this._bindMeshAsset(n)}else this._onMeshChanged(null)}onSetMesh(t,e,s){!s||s instanceof rt||typeof s=="number"?this.meshAsset=s:this._onMeshChanged(s)}_onMeshChanged(t){t&&!(t instanceof is)&&(t.meshInstances[0]?t=t.meshInstances[0].mesh:t=null),this.data.mesh=t,this.emitter&&(this.emitter.mesh=t,this.emitter.resetMaterial(),this.rebuild())}onSetRenderAsset(t,e,s){const i=this.system.app.assets;if(e){const n=i.get(e);n&&this._unbindRenderAsset(n)}if(s){s instanceof rt&&(this.data.renderAsset=s.id,s=s.id);const n=i.get(s);n&&this._bindRenderAsset(n)}else this._onRenderChanged(null)}_bindRenderAsset(t){if(t.on("load",this._onRenderAssetLoad,this),t.on("unload",this._onRenderAssetUnload,this),t.on("remove",this._onRenderAssetRemove,this),t.resource)this._onRenderAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindRenderAsset(t){t.off("load",this._onRenderAssetLoad,this),t.off("unload",this._onRenderAssetUnload,this),t.off("remove",this._onRenderAssetRemove,this),t.resource&&t.resource.off("set:meshes",this._onRenderSetMeshes,this)}_onRenderAssetLoad(t){this._onRenderChanged(t.resource)}_onRenderAssetUnload(t){this._onRenderChanged(null)}_onRenderAssetRemove(t){this._onRenderAssetUnload(t)}_onRenderChanged(t){if(!t){this._onMeshChanged(null);return}t.off("set:meshes",this._onRenderSetMeshes,this),t.on("set:meshes",this._onRenderSetMeshes,this),t.meshes&&this._onRenderSetMeshes(t.meshes)}_onRenderSetMeshes(t){this._onMeshChanged(t&&t[0])}onSetLoop(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetTime())}onSetBlendType(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.material.blendType=s,this.emitter.resetMaterial(),this.rebuild())}_requestDepth(){this._requestedDepth||($n||($n=this.system.app.scene.layers.getLayerById(fs)),$n&&($n.incrementCounter(),this._requestedDepth=!0))}_releaseDepth(){!this._requestedDepth||$n&&($n.decrementCounter(),this._requestedDepth=!1)}onSetDepthSoftening(t,e,s){e!==s&&(s?(this.enabled&&this.entity.enabled&&this._requestDepth(),this.emitter&&(this.emitter[t]=s)):(this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[t]=s)),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))}onSetSimpleProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial())}onSetComplexProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.resetMaterial(),this.rebuild(),this.reset())}onSetGraphProperty(t,e,s){this.emitter&&(this.emitter[t]=s,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())}onEnable(){const t=this.data;for(let e=0,s=Fl.length;e<s;e++){let i=t[Fl[e]];if(i){if(!(i instanceof rt))if(parseInt(i,10)>=0)i=this.system.app.assets.get(i);else continue;i&&!i.resource&&this.system.app.assets.load(i)}}if(!this.emitter){let e=t.mesh;e instanceof is||(e=null),this.emitter=new iP(this.system.app.graphicsDevice,{numParticles:t.numParticles,emitterExtents:t.emitterExtents,emitterExtentsInner:t.emitterExtentsInner,emitterRadius:t.emitterRadius,emitterRadiusInner:t.emitterRadiusInner,emitterShape:t.emitterShape,initialVelocity:t.initialVelocity,wrap:t.wrap,localSpace:t.localSpace,screenSpace:t.screenSpace,wrapBounds:t.wrapBounds,lifetime:t.lifetime,rate:t.rate,rate2:t.rate2,orientation:t.orientation,particleNormal:t.particleNormal,animTilesX:t.animTilesX,animTilesY:t.animTilesY,animStartFrame:t.animStartFrame,animNumFrames:t.animNumFrames,animNumAnimations:t.animNumAnimations,animIndex:t.animIndex,randomizeAnimIndex:t.randomizeAnimIndex,animSpeed:t.animSpeed,animLoop:t.animLoop,startAngle:t.startAngle,startAngle2:t.startAngle2,scaleGraph:t.scaleGraph,scaleGraph2:t.scaleGraph2,colorGraph:t.colorGraph,colorGraph2:t.colorGraph2,alphaGraph:t.alphaGraph,alphaGraph2:t.alphaGraph2,localVelocityGraph:t.localVelocityGraph,localVelocityGraph2:t.localVelocityGraph2,velocityGraph:t.velocityGraph,velocityGraph2:t.velocityGraph2,rotationSpeedGraph:t.rotationSpeedGraph,rotationSpeedGraph2:t.rotationSpeedGraph2,radialSpeedGraph:t.radialSpeedGraph,radialSpeedGraph2:t.radialSpeedGraph2,colorMap:t.colorMap,normalMap:t.normalMap,loop:t.loop,preWarm:t.preWarm,sort:t.sort,stretch:t.stretch,alignToMotion:t.alignToMotion,lighting:t.lighting,halfLambert:t.halfLambert,intensity:t.intensity,depthSoftening:t.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:t.depthWrite,noFog:t.noFog,node:this.entity,blendType:t.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,t.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)}this.emitter.colorMap&&this.addMeshInstanceToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&t.depthSoftening&&this._requestDepth()}onDisable(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.emitter&&(this.removeMeshInstanceFromLayers(),this.data.depthSoftening&&this._releaseDepth(),this.emitter.camera=null)}onBeforeRemove(){this.enabled&&(this.enabled=!1),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(let t=0;t<Fl.length;t++){const e=Fl[t];this.data[e]&&(this[e]=null)}this.off()}reset(){this.emitter&&this.emitter.reset()}stop(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))}pause(){this.data.paused=!0}unpause(){this.data.paused=!1}play(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())}isPlaying(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime}rebuild(){const t=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity),this.enabled=t}}class oP{constructor(){this.numParticles=1,this.rate=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new y,this.emitterExtentsInner=new y,this.emitterRadius=0,this.emitterRadiusInner=0,this.emitterShape=gs,this.initialVelocity=0,this.wrapBounds=new y,this.localSpace=!1,this.screenSpace=!1,this.colorMap=null,this.colorMapAsset=null,this.normalMap=null,this.normalMapAsset=null,this.loop=!0,this.preWarm=!1,this.sort=0,this.mode=Au,this.scene=null,this.lighting=!1,this.halfLambert=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.meshAsset=null,this.mesh=null,this.depthWrite=!1,this.noFog=!1,this.orientation=Ma,this.particleNormal=new y(0,1,0),this.animTilesX=1,this.animTilesY=1,this.animStartFrame=0,this.animNumFrames=1,this.animNumAnimations=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.scaleGraph=null,this.scaleGraph2=null,this.colorGraph=null,this.colorGraph2=null,this.alphaGraph=null,this.alphaGraph2=null,this.localVelocityGraph=null,this.localVelocityGraph2=null,this.velocityGraph=null,this.velocityGraph2=null,this.rotationSpeedGraph=null,this.rotationSpeedGraph2=null,this.radialSpeedGraph=null,this.radialSpeedGraph2=null,this.blendType=Be,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[xe]}}const x_=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","renderAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"];class lP extends Bt{constructor(t){super(t);this.id="particlesystem",this.ComponentType=y_,this.DataType=oP,this.schema=x_,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i={};s=[];const n=this.propertyTypes;(e.mesh instanceof rt||typeof e.mesh=="number")&&(e.meshAsset=e.mesh,delete e.mesh);for(const r in e){if(e.hasOwnProperty(r)&&(s.push(r),i[r]=e[r]),n[r]==="vec3")Array.isArray(i[r])&&(i[r]=new y(i[r][0],i[r][1],i[r][2]));else if(n[r]==="curve"){if(!(i[r]instanceof fe)){const a=i[r].type;i[r]=new fe(i[r].keys),i[r].type=a}}else if(n[r]==="curveset"&&!(i[r]instanceof us)){const a=i[r].type;i[r]=new us(i[r].keys),i[r].type=a}i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0))}super.initializeComponentData(t,i,s)}cloneComponent(t,e){const s=t.particlesystem.data,i=this.schema,n={};for(let r=0,a=i.length;r<a;r++){const l=i[r];let h=s[l];h instanceof y||h instanceof fe||h instanceof us?(h=h.clone(),n[l]=h):l==="layers"?n.layers=s.layers.slice(0):h!=null&&(n[l]=h)}return this.addComponent(e,n)}onUpdate(t){const e=this.store;let s;const i=this.app.stats.particles;for(const n in e)if(e.hasOwnProperty(n)){const r=e[n],a=r.entity,l=r.data;if(l.enabled&&a.enabled){const h=a.particlesystem.emitter;if(!h.meshInstance.visible)continue;if(h.lighting){const c=l.layers;let d;for(let u=0;u<c.length;u++){const f=this.app.scene.layers.getLayerById(c[u]);if(!f)continue;f._lightCube||(f._lightCube=new Float32Array(6*3)),d=f._lightCube;for(let p=0;p<6;p++)d[p*3]=this.app.scene.ambientLight.r,d[p*3+1]=this.app.scene.ambientLight.g,d[p*3+2]=this.app.scene.ambientLight.b;const m=f._splitLights[lt];for(let p=0;p<m.length;p++)for(let _=0;_<6;_++){const g=Math.max(h.lightCubeDir[_].dot(m[p]._direction),0)*m[p]._intensity;d[_*3]+=m[p]._color.r*g,d[_*3+1]+=m[p]._color.g*g,d[_*3+2]+=m[p]._color.b*g}}h.constantLightCube.setValue(d)}if(!l.paused){if(h.simTime+=t,h.simTime>h.fixedTimeStep&&(s=Math.floor(h.simTime/h.fixedTimeStep),h.simTime-=s*h.fixedTimeStep),s){s=Math.min(s,h.maxSubSteps);for(let c=0;c<s;c++)h.addTime(h.fixedTimeStep,!1);i._updatesPerFrame+=s,i._frameTime+=h._addTimeTime,h._addTimeTime=0}h.finishFrame()}}}}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(y_.prototype,x_);class Cd{constructor(t,e){this._constructor=t,this._pool=[],this._count=0,this._resize(e)}_resize(t){if(t>this._pool.length)for(let e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(this._pool.length*2),this._pool[this._count++]}freeAll(){this._count=0}}let Ke,Mt,ca,Ad,Md;class da extends st{constructor(t,e){super(t,e);this._angularDamping=0,this._angularFactor=new y(1,1,1),this._angularVelocity=new y,this._body=null,this._friction=.5,this._group=Op,this._linearDamping=0,this._linearFactor=new y(1,1,1),this._linearVelocity=new y,this._mask=od,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=ra}static onLibraryLoaded(){typeof Ammo!="undefined"&&!Ke&&(Ke=new Ammo.btTransform,Mt=new Ammo.btVector3,ca=new Ammo.btVector3,Ad=new Ammo.btQuaternion,Md=new Ammo.btVector3(0,0,0))}set angularDamping(t){this._angularDamping!==t&&(this._angularDamping=t,this._body&&this._body.setDamping(this._linearDamping,t))}get angularDamping(){return this._angularDamping}set angularFactor(t){this._angularFactor.equals(t)||(this._angularFactor.copy(t),this._body&&this._type===os&&(Mt.setValue(t.x,t.y,t.z),this._body.setAngularFactor(Mt)))}get angularFactor(){return this._angularFactor}set angularVelocity(t){this._body&&this._type===os&&(this._body.activate(),Mt.setValue(t.x,t.y,t.z),this._body.setAngularVelocity(Mt),this._angularVelocity.copy(t))}get angularVelocity(){if(this._body&&this._type===os){const t=this._body.getAngularVelocity();this._angularVelocity.set(t.x(),t.y(),t.z())}return this._angularVelocity}set body(t){this._body!==t&&(this._body=t,t&&this._simulationEnabled&&t.activate())}get body(){return this._body}set friction(t){this._friction!==t&&(this._friction=t,this._body&&this._body.setFriction(t))}get friction(){return this._friction}set group(t){this._group!==t&&(this._group=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(t){this._linearDamping!==t&&(this._linearDamping=t,this._body&&this._body.setDamping(t,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(t){this._linearFactor.equals(t)||(this._linearFactor.copy(t),this._body&&this._type===os&&(Mt.setValue(t.x,t.y,t.z),this._body.setLinearFactor(Mt)))}get linearFactor(){return this._linearFactor}set linearVelocity(t){this._body&&this._type===os&&(this._body.activate(),Mt.setValue(t.x,t.y,t.z),this._body.setLinearVelocity(Mt),this._linearVelocity.copy(t))}get linearVelocity(){if(this._body&&this._type===os){const t=this._body.getLinearVelocity();this._linearVelocity.set(t.x(),t.y(),t.z())}return this._linearVelocity}set mask(t){this._mask!==t&&(this._mask=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(t){if(this._mass!==t&&(this._mass=t,this._body&&this._type===os)){const e=this.enabled&&this.entity.enabled;e&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(t,Mt),this._body.setMassProps(t,Mt),this._body.updateInertiaTensor(),e&&this.enableSimulation()}}get mass(){return this._mass}set restitution(t){this._restitution!==t&&(this._restitution=t,this._body&&this._body.setRestitution(t))}get restitution(){return this._restitution}set rollingFriction(t){this._rollingFriction!==t&&(this._rollingFriction=t,this._body&&this._body.setRollingFriction(t))}get rollingFriction(){return this._rollingFriction}set type(t){if(this._type!==t){switch(this._type=t,this.disableSimulation(),t){case os:this._group=GA,this._mask=kp;break;case Bn:this._group=HA,this._mask=kp;break;case ra:default:this._group=Op,this._mask=od;break}this.createBody()}}get type(){return this._type}createBody(){const t=this.entity;let e;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&this.system.onRemove(t,this);const s=this._type===os?this._mass:0;this._getEntityTransform(Ke);const i=this.system.createBody(s,e,Ke);if(i.setRestitution(this._restitution),i.setFriction(this._friction),i.setRollingFriction(this._rollingFriction),i.setDamping(this._linearDamping,this._angularDamping),this._type===os){const n=this._linearFactor;Mt.setValue(n.x,n.y,n.z),i.setLinearFactor(Mt);const r=this._angularFactor;Mt.setValue(r.x,r.y,r.z),i.setAngularFactor(Mt)}else this._type===Bn&&(i.setCollisionFlags(i.getCollisionFlags()|WA),i.setActivationState(Dp));i.entity=t,this.body=i,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return this._body?this._body.isActive():!1}activate(){this._body&&this._body.activate()}enableSimulation(){const t=this.entity;if(t.collision&&t.collision.enabled&&!this._simulationEnabled){const e=this._body;if(e){switch(this.system.addBody(e,this._group,this._mask),this._type){case os:this.system._dynamic.push(this),e.forceActivationState(ad),this.syncEntityToBody();break;case Bn:this.system._kinematic.push(this),e.forceActivationState(Dp);break;case ra:e.forceActivationState(ad),this.syncEntityToBody();break}t.collision.type==="compound"&&this.system._compounds.push(t.collision),e.activate(),this._simulationEnabled=!0}}}disableSimulation(){const t=this._body;if(t&&this._simulationEnabled){const e=this.system;let s=e._compounds.indexOf(this.entity.collision);s>-1&&e._compounds.splice(s,1),s=e._dynamic.indexOf(this),s>-1&&e._dynamic.splice(s,1),s=e._kinematic.indexOf(this),s>-1&&e._kinematic.splice(s,1),e.removeBody(t),t.forceActivationState(Fp),this._simulationEnabled=!1}}applyForce(){let t,e,s,i,n,r;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,r=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],r=arguments[5];break}const a=this._body;a&&(a.activate(),Mt.setValue(t,e,s),i!==void 0?(ca.setValue(i,n,r),a.applyForce(Mt,ca)):a.applyForce(Mt,Md))}applyTorque(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),Mt.setValue(t,e,s),i.applyTorque(Mt))}applyImpulse(){let t,e,s,i,n,r;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z,i=arguments[1].x,n=arguments[1].y,r=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;case 6:t=arguments[0],e=arguments[1],s=arguments[2],i=arguments[3],n=arguments[4],r=arguments[5];break;default:return}const a=this._body;a&&(a.activate(),Mt.setValue(t,e,s),i!==void 0?(ca.setValue(i,n,r),a.applyImpulse(Mt,ca)):a.applyImpulse(Mt,Md))}applyTorqueImpulse(){let t,e,s;switch(arguments.length){case 1:t=arguments[0].x,e=arguments[0].y,s=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],s=arguments[2];break;default:return}const i=this._body;i&&(i.activate(),Mt.setValue(t,e,s),i.applyTorqueImpulse(Mt))}isStatic(){return this._type===ra}isStaticOrKinematic(){return this._type===ra||this._type===Bn}isKinematic(){return this._type===Bn}_getEntityTransform(t){const e=this.entity,s=e.getPosition(),i=e.getRotation();Mt.setValue(s.x,s.y,s.z),Ad.setValue(i.x,i.y,i.z,i.w),t.setOrigin(Mt),t.setRotation(Ad)}syncEntityToBody(){const t=this._body;if(t){if(this._getEntityTransform(Ke),t.setWorldTransform(Ke),this._type===Bn){const e=t.getMotionState();e&&e.setWorldTransform(Ke)}t.activate()}}_updateDynamic(){const t=this._body;if(t.isActive()){const e=t.getMotionState();if(e){e.getWorldTransform(Ke);const s=Ke.getOrigin(),i=Ke.getRotation();this.entity.setPosition(s.x(),s.y(),s.z()),this.entity.setRotation(i.x(),i.y(),i.z(),i.w())}}}_updateKinematic(){const t=this._body.getMotionState();t&&(this._getEntityTransform(Ke),t.setWorldTransform(Ke))}teleport(){arguments.length<3?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof tt?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(arguments.length===6&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}}class hP{constructor(){this.enabled=!0}}let tn,en;class v_{constructor(t,e,s){this.entity=t,this.point=e,this.normal=s}}class cP{constructor(t,e,s){arguments.length===0?(this.a=null,this.b=null,this.impulse=0,this.localPointA=new y,this.localPointB=new y,this.pointA=new y,this.pointB=new y,this.normal=new y):(this.a=t,this.b=e,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal)}}class dP{constructor(t=new y,e=new y,s=new y,i=new y,n=new y,r=0){this.localPoint=t,this.localPointOther=e,this.point=s,this.pointOther=i,this.normal=n,this.impulse=r}}class uP{constructor(t,e){this.other=t,this.contacts=e}}const S_=["enabled"];class b_ extends Bt{constructor(t){super(t);this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new y(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=da,this.DataType=hP,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=S_,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}onLibraryLoaded(){if(typeof Ammo!="undefined"){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}tn=new Ammo.btVector3,en=new Ammo.btVector3,da.onLibraryLoaded(),this.contactPointPool=new Cd(dP,1),this.contactResultPool=new Cd(uP,1),this.singleContactResultPool=new Cd(cP,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(t,e,s){const i=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const n of i)if(e.hasOwnProperty(n)){const r=e[n];Array.isArray(r)?t[n]=new y(r[0],r[1],r[2]):t[n]=r}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.rigidbody,i={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&(e.enabled=!1)}onRemove(t,e){const s=e.body;s&&(this.removeBody(s),this.destroyBody(s),e.body=null)}addBody(t,e,s){e!==void 0&&s!==void 0?this.dynamicsWorld.addRigidBody(t,e,s):this.dynamicsWorld.addRigidBody(t)}removeBody(t){this.dynamicsWorld.removeRigidBody(t)}createBody(t,e,s){const i=new Ammo.btVector3(0,0,0);t!==0&&e.calculateLocalInertia(t,i);const n=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(t,n,e,i),a=new Ammo.btRigidBody(r);return Ammo.destroy(r),Ammo.destroy(i),a}destroyBody(t){const e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)}raycastFirst(t,e){let s=null;tn.setValue(t.x,t.y,t.z),en.setValue(e.x,e.y,e.z);const i=new Ammo.ClosestRayResultCallback(tn,en);if(this.dynamicsWorld.rayTest(tn,en,i),i.hasHit()){const n=i.get_m_collisionObject(),r=Ammo.castObject(n,Ammo.btRigidBody);if(r){const a=i.get_m_hitPointWorld(),l=i.get_m_hitNormalWorld();s=new v_(r.entity,new y(a.x(),a.y(),a.z()),new y(l.x(),l.y(),l.z())),arguments.length>2&&arguments[2](s)}}return Ammo.destroy(i),s}raycastAll(t,e){const s=[];tn.setValue(t.x,t.y,t.z),en.setValue(e.x,e.y,e.z);const i=new Ammo.AllHitsRayResultCallback(tn,en);if(this.dynamicsWorld.rayTest(tn,en,i),i.hasHit()){const n=i.get_m_collisionObjects(),r=i.get_m_hitPointWorld(),a=i.get_m_hitNormalWorld(),l=n.size();for(let h=0;h<l;h++){const c=Ammo.castObject(n.at(h),Ammo.btRigidBody);if(c){const d=r.at(h),u=a.at(h),f=new v_(c.entity,new y(d.x(),d.y(),d.z()),new y(u.x(),u.y(),u.z()));s.push(f)}}}return Ammo.destroy(i),s}_storeCollision(t,e){let s=!1;const i=t.getGuid();return this.collisions[i]=this.collisions[i]||{others:[],entity:t},this.collisions[i].others.indexOf(e)<0&&(this.collisions[i].others.push(e),s=!0),this.frameCollisions[i]=this.frameCollisions[i]||{others:[],entity:t},this.frameCollisions[i].others.push(e),s}_createContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),r=t.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(e.x(),e.y(),e.z()),a.localPointOther.set(s.x(),s.y(),s.z()),a.point.set(i.x(),i.y(),i.z()),a.pointOther.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=t.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),i=t.getPositionWorldOnA(),n=t.getPositionWorldOnB(),r=t.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(e.x(),e.y(),e.z()),a.localPoint.set(s.x(),s.y(),s.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.point.set(n.x(),n.y(),n.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=t.getAppliedImpulse(),a}_createSingleContactResult(t,e,s){const i=this.singleContactResultPool.allocate();return i.a=t,i.b=e,i.localPointA=s.localPoint,i.localPointB=s.localPointOther,i.pointA=s.point,i.pointB=s.pointOther,i.normal=s.normal,i.impulse=s.impulse,i}_createContactResult(t,e){const s=this.contactResultPool.allocate();return s.other=t,s.contacts=e,s}_cleanOldCollisions(){for(const t in this.collisions)if(this.collisions.hasOwnProperty(t)){const e=this.frameCollisions[t],s=this.collisions[t],i=s.entity,n=i.collision,r=i.rigidbody,a=s.others;let h=a.length;for(;h--;){const c=a[h];(!e||e.others.indexOf(c)<0)&&(a.splice(h,1),i.trigger?(n&&n.fire("triggerleave",c),c.rigidbody&&c.rigidbody.fire("triggerleave",i)):c.trigger||(r&&r.fire("collisionend",c),n&&n.fire("collisionend",c)))}a.length===0&&delete this.collisions[t]}}_hasContactEvent(t){const e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;const s=t.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(t,e){const i=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),n=i.getNumManifolds();this.frameCollisions={};for(let r=0;r<n;r++){const a=i.getManifoldByIndexInternal(r),l=a.getBody0(),h=a.getBody1(),c=Ammo.castObject(l,Ammo.btRigidBody),d=Ammo.castObject(h,Ammo.btRigidBody),u=c.entity,f=d.entity;if(!u||!f)continue;const m=c.getCollisionFlags(),p=d.getCollisionFlags(),_=a.getNumContacts(),g=[],w=[];let v;if(_>0)if(m&aa||p&aa){const x=u.collision&&(u.collision.hasEvent("triggerenter")||u.collision.hasEvent("triggerleave")),S=f.collision&&(f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave")),T=u.rigidbody&&(u.rigidbody.hasEvent("triggerenter")||u.rigidbody.hasEvent("triggerleave")),b=f.rigidbody&&(f.rigidbody.hasEvent("triggerenter")||f.rigidbody.hasEvent("triggerleave"));x&&(v=this._storeCollision(u,f),v&&!(p&aa)&&u.collision.fire("triggerenter",f)),S&&(v=this._storeCollision(f,u),v&&!(m&aa)&&f.collision.fire("triggerenter",u)),T&&(v||(v=this._storeCollision(f,u)),v&&u.rigidbody.fire("triggerenter",f)),b&&(v||(v=this._storeCollision(u,f)),v&&f.rigidbody.fire("triggerenter",u))}else{const x=this._hasContactEvent(u),S=this._hasContactEvent(f),T=this.hasEvent("contact");if(T||x||S){for(let b=0;b<_;b++){const C=a.getContactPoint(b),M=this._createContactPointFromAmmo(C);if(x||S){g.push(M);const E=this._createReverseContactPointFromAmmo(C);w.push(E)}if(T){const E=this._createSingleContactResult(u,f,M);this.fire("contact",E)}}if(x){const b=this._createContactResult(f,g);v=this._storeCollision(u,f),u.collision&&(u.collision.fire("contact",b),v&&u.collision.fire("collisionstart",b)),u.rigidbody&&(u.rigidbody.fire("contact",b),v&&u.rigidbody.fire("collisionstart",b))}if(S){const b=this._createContactResult(u,w);v=this._storeCollision(f,u),f.collision&&(f.collision.fire("contact",b),v&&f.collision.fire("collisionstart",b)),f.rigidbody&&(f.rigidbody.fire("contact",b),v&&f.rigidbody.fire("collisionstart",b))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(t){let e,s;const i=this.dynamicsWorld.getGravity();(i.x()!==this.gravity.x||i.y()!==this.gravity.y||i.z()!==this.gravity.z)&&(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));const n=this._triggers;for(e=0,s=n.length;e<s;e++)n[e].updateTransform();const r=this._compounds;for(e=0,s=r.length;e<s;e++)r[e]._updateCompound();const a=this._kinematic;for(e=0,s=a.length;e<s;e++)a[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const l=this._dynamic;for(e=0,s=l.length;e<s;e++)l[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),typeof Ammo!="undefined"&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null)}}st._buildAccessors(da.prototype,S_);const Kn="none",fP="blend",w_=new G;class T_ extends st{constructor(t,e){super(t,e);this._resolution=new H(640,320),this._referenceResolution=new H(640,320),this._scaleMode=Kn,this.scale=1,this._scaleBlend=.5,this._priority=0,this._screenSpace=!1,this.cull=this._screenSpace,this._screenMatrix=new G,this._elements=new Set,t.app.graphicsDevice.on("resizecanvas",this._onResize,this)}syncDrawOrder(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)}_recurseDrawOrderSync(t,e){if(!(t instanceof pt))return e;if(t.element){const i=t.element.drawOrder;t.element.drawOrder=e++,t.element._batchGroupId>=0&&i!==t.element.drawOrder&&this.system.app.batcher.markGroupDirty(t.element._batchGroupId)}t.particlesystem&&(t.particlesystem.drawOrder=e++);const s=t.children;for(let i=0;i<s.length;i++)e=this._recurseDrawOrderSync(s[i],e);return e}_processDrawOrderSync(){const t=1;this._recurseDrawOrderSync(this.entity,t),this.fire("syncdraworder")}_calcProjectionMatrix(){const t=this._resolution.x/this.scale,e=this._resolution.y/this.scale,s=0,i=t,n=-e,r=0,a=1,l=-1;this._screenMatrix.setOrtho(s,i,n,r,a,l),this._screenSpace||(w_.setScale(.5*t,.5*e,1),this._screenMatrix.mul2(w_,this._screenMatrix))}_updateScale(){this.scale=this._calcScale(this._resolution,this.referenceResolution)}_calcScale(t,e){const s=Math.log2(t.x/e.x),i=Math.log2(t.y/e.y);return Math.pow(2,s*(1-this._scaleBlend)+i*this._scaleBlend)}_onResize(t,e){this._screenSpace&&(this._resolution.set(t,e),this.resolution=this._resolution)}_bindElement(t){this._elements.add(t)}_unbindElement(t){this._elements.delete(t)}onRemove(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this._elements.forEach(t=>t._onScreenRemove()),this._elements.clear(),this.off()}set resolution(t){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution),this._elements.forEach(e=>e._onScreenResize(this._resolution))}get resolution(){return this._resolution}set referenceResolution(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution),this._elements.forEach(e=>e._onScreenResize(this._resolution))}get referenceResolution(){return this._scaleMode===Kn?this._resolution:this._referenceResolution}set screenSpace(t){this._screenSpace=t,this._screenSpace&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace),this._elements.forEach(e=>e._onScreenSpaceChange())}get screenSpace(){return this._screenSpace}set scaleMode(t){t!==Kn&&t!==fP&&(t=Kn),!this._screenSpace&&t!==Kn&&(t=Kn),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)}get scaleMode(){return this._scaleMode}set scaleBlend(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend),this._elements.forEach(e=>e._onScreenResize(this._resolution))}get scaleBlend(){return this._scaleBlend}set priority(t){t>255&&(t=255),this._priority=t}get priority(){return this._priority}}class mP{constructor(){this.enabled=!0}}const C_=["enabled"];class pP extends Bt{constructor(t){super(t);this.id="screen",this.ComponentType=T_,this.DataType=mP,this.schema=C_,this.windowResolution=new H,this._drawOrderSyncQueue=new Dg,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.app.systems.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}initializeComponentData(t,e,s){e.priority!==void 0&&(t.priority=e.priority),e.screenSpace!==void 0&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,e.scaleMode!==void 0&&(t.scaleMode=e.scaleMode),e.scaleBlend!==void 0&&(t.scaleBlend=e.scaleBlend),e.resolution!==void 0&&(e.resolution instanceof H?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),e.referenceResolution!==void 0&&(e.referenceResolution instanceof H?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),super.initializeComponentData(t,e,s)}destroy(){super.destroy(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.app.systems.off("update",this._onUpdate,this)}_onUpdate(t){const e=this.store;for(const s in e)e[s].entity.screen.update&&e[s].entity.screen.update(t)}_onResize(t,e){this.windowResolution.x=t,this.windowResolution.y=e}cloneComponent(t,e){const s=t.screen;return this.addComponent(e,{enabled:s.enabled,screenSpace:s.screenSpace,scaleMode:s.scaleMode,resolution:s.resolution.clone(),referenceResolution:s.referenceResolution.clone()})}onRemoveComponent(t,e){e.onRemove()}processDrawOrderSyncQueue(){const t=this._drawOrderSyncQueue.list();for(let e=0;e<t.length;e++){const s=t[e];s.callback.call(s.scope)}this._drawOrderSyncQueue.clear()}queueDrawOrderSync(t,e,s){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:s})}}st._buildAccessors(T_.prototype,C_);class _P{constructor(){this.enabled=!0}}const gP="_onInitializeAttributes",yP="_onInitialize",xP="_onPostInitialize",vP="_onUpdate",SP="_onPostUpdate";let Ol=0;class bP extends Bt{constructor(t){super(t);this.id="script",this.ComponentType=qe,this.DataType=_P,this._components=new Sa({sortBy:"_executionOrder"}),this._enabledComponents=new Sa({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e){if(t._executionOrder=Ol++,this._components.append(t),Ol>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=e.hasOwnProperty("enabled")?!!e.enabled:!0,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(let s=0;s<e.order.length;s++)t.create(e.order[s],{enabled:e.scripts[e.order[s]].enabled,attributes:e.scripts[e.order[s]].attributes,preloading:this.preloading})}}cloneComponent(t,e){const s=[],i={};for(let r=0;r<t.script._scripts.length;r++){const a=t.script._scripts[r],l=a.__scriptType.__name;s.push(l);const h={};for(const c in a.__attributes)h[c]=a.__attributes[c];i[l]={enabled:a._enabled,attributes:h}}for(const r in t.script._scriptsIndex)r.awaiting&&s.splice(r.ind,0,r);const n={enabled:t.script.enabled,order:s,scripts:i};return this.addComponent(e,n)}_resetExecutionOrder(){Ol=0;for(let t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=Ol++}_callComponentMethod(t,e,s){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,gP),this._callComponentMethod(this._enabledComponents,yP)}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,xP)}_onUpdate(t){this._callComponentMethod(this._enabledComponents,vP,t)}_onPostUpdate(t){this._callComponentMethod(this._enabledComponents,SP,t)}_addComponentToEnabled(t){this._enabledComponents.insert(t)}_removeComponentFromEnabled(t){this._enabledComponents.remove(t)}_onBeforeRemove(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class A_ extends st{constructor(t,e){super(t,e);this.on("set_scripts",this.onSetScripts,this)}send(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.entity.script.instances;let n;if(i&&i[t]&&(n=i[t].instance[e],n))return n.apply(i[t].instance,s)}onEnable(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))}onDisable(){this.system._disableScriptComponent(this)}onSetScripts(t,e,s){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(e,s))return;this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1;const n=s.map(function(r){return r.url});if(this._loadFromCache(n))return;this._loadScripts(n)}}_updateScriptAttributes(t,e){let s=!0;if(t.length!==e.length)s=!1;else for(let i=0,n=e.length;i<n;i++)if(t[i].url!==e[i].url){s=!1;break}if(s)for(const i in this.instances)this.instances.hasOwnProperty(i)&&this.system._updateAccessors(this.entity,this.instances[i]);return s}_loadFromCache(t){const e=[],s=this.system.app._scriptPrefix||"",i=/^http(s)?:\/\//i;for(let n=0,r=t.length;n<r;n++){let a=t[n];i.test(a)||(a=ot.join(s,a));const l=this.system.app.loader.getFromCache(a,"script");if(!l)return!1;e.push(l)}for(let n=0,r=e.length;n<r;n++){const a=e[n];if(a!==!0&&a&&this.entity.script&&!this.entity.script.instances[a._pcScriptName]){const l=new a(this.entity);this.system._preRegisterInstance(this.entity,t[n],a._pcScriptName,l)}}return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0}_loadScripts(t){let e=t.length;const s=this.system.app._scriptPrefix||"";t.forEach(i=>{let n=null,r=null;i.toLowerCase().startsWith("http://")||i.toLowerCase().startsWith("https://")?(r=i,n=i):(r=i,n=ot.join(s,i)),this.system.app.loader.load(n,"script",(a,l)=>{if(e--,a)console.error(a);else if(l&&this.entity.script&&!this.entity.script.instances[l._pcScriptName]){const h=new l(this.entity);this.system._preRegisterInstance(this.entity,r,l._pcScriptName,h)}e===0&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))})})}}class wP{constructor(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.initialized=!1,this.postInitialized=!1,this.areScriptsLoaded=!1}}const M_=["enabled","scripts","instances","runInTools"],Pd="initialize",Ed="postInitialize",Rd="update",Id="postUpdate",Ld="fixedUpdate",Dd="toolsUpdate",TP="onEnable",CP="onDisable";class AP extends Bt{constructor(t){super(t);this.id="script",this.ComponentType=A_,this.DataType=wP,this.schema=M_,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on(Pd,this.onInitialize,this),this.app.systems.on(Ed,this.onPostInitialize,this),this.app.systems.on(Rd,this.onUpdate,this),this.app.systems.on(Ld,this.onFixedUpdate,this),this.app.systems.on(Id,this.onPostUpdate,this),this.app.systems.on(Dd,this.onToolsUpdate,this)}initializeComponentData(t,e,s){s=["runInTools","enabled","scripts"],e.scripts&&e.scripts.length&&e.scripts.forEach(function(i){if(i.attributes&&Array.isArray(i.attributes)){const n={};for(let r=0;r<i.attributes.length;r++)n[i.attributes[r].name]=i.attributes[r];i.attributes=n}}),super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=this.store[t.getGuid()],i={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled},n=s.data.scripts;for(let r=0,a=n.length;r<a;r++){const l=n[r].attributes;l&&delete n[r].attributes,i.scripts.push(ei({},n[r])),l&&(i.scripts[r].attributes=this._cloneAttributes(l),n[r].attributes=l)}return this.addComponent(e,i)}onBeforeRemove(t,e){e.enabled&&this._disableScriptComponent(e),this._destroyScriptComponent(e)}onInitialize(t){if(this._registerInstances(t),t.enabled){t.script&&t.script.enabled&&this._initializeScriptComponent(t.script);const e=t._children;for(let s=0,i=e.length;s<i;s++)e[s]instanceof pt&&this.onInitialize(e[s])}}onPostInitialize(t){if(t.enabled){t.script&&t.script.enabled&&this._postInitializeScriptComponent(t.script);const e=t._children;for(let s=0,i=e.length;s<i;s++)e[s]instanceof pt&&this.onPostInitialize(e[s])}}_callInstancesMethod(t,e){const s=t.data.instances;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i].instance;n[e]&&n[e]()}}_initializeScriptComponent(t){this._callInstancesMethod(t,Pd),t.data.initialized=!0,t.enabled&&t.entity.enabled&&this._enableScriptComponent(t)}_enableScriptComponent(t){this._callInstancesMethod(t,TP)}_disableScriptComponent(t){this._callInstancesMethod(t,CP)}_destroyScriptComponent(t){const e=t.data.instances;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].instance;if(i.destroy&&i.destroy(),i.update){const n=this.instancesWithUpdate.indexOf(i);n>=0&&this.instancesWithUpdate.splice(n,1)}if(i.fixedUpdate){const n=this.instancesWithFixedUpdate.indexOf(i);n>=0&&this.instancesWithFixedUpdate.splice(n,1)}if(i.postUpdate){const n=this.instancesWithPostUpdate.indexOf(i);n>=0&&this.instancesWithPostUpdate.splice(n,1)}if(i.toolsUpdate){const n=this.instancesWithToolsUpdate.indexOf(i);n>=0&&this.instancesWithToolsUpdate.splice(n,1)}t.instances[s].instance===t[s]&&delete t[s],delete t.instances[s]}}_postInitializeScriptComponent(t){this._callInstancesMethod(t,Ed),t.data.postInitialized=!0}_updateInstances(t,e,s){for(let i=0,n=e.length;i<n;i++){const r=e[i];r&&r.entity&&r.entity.enabled&&r.entity.script.enabled&&r[t](s)}}onUpdate(t){this._updateInstances(Rd,this.instancesWithUpdate,t)}onFixedUpdate(t){this._updateInstances(Ld,this.instancesWithFixedUpdate,t)}onPostUpdate(t){this._updateInstances(Id,this.instancesWithPostUpdate,t)}onToolsUpdate(t){this._updateInstances(Dd,this.instancesWithToolsUpdate,t)}broadcast(t,e){const s=Array.prototype.slice.call(arguments,2),i=this.store;for(const n in i)if(i.hasOwnProperty(n)){const r=i[n].data;if(r.instances[t]){const a=r.instances[t].instance[e];a&&a.apply(r.instances[t].instance,s)}}}_preRegisterInstance(t,e,s,i){if(t.script){if(t.script.data._instances=t.script.data._instances||{},t.script.data._instances[s])throw Error(`Script name collision '${s}'. Scripts from '${e}' and '${t.script.data._instances[s].url}' {${t.getGuid()}}`);t.script.data._instances[s]={url:e,name:s,instance:i}}}_registerInstances(t){if(t.script&&t.script.data._instances){t.script.instances=t.script.data._instances;for(const s in t.script.instances){const i=t.script.instances[s],n=i.instance;if(Kl.attach(n),n.update&&this.instancesWithUpdate.push(n),n.fixedUpdate&&this.instancesWithFixedUpdate.push(n),n.postUpdate&&this.instancesWithPostUpdate.push(n),n.toolsUpdate&&this.instancesWithToolsUpdate.push(n),t.script.scripts&&this._createAccessors(t,i),t.script[s])throw Error(`Script with name '${s}' is already attached to Script Component`);t.script[s]=n}delete t.script.data._instances}const e=t._children;for(let s=0,i=e.length;s<i;s++)e[s]instanceof pt&&this._registerInstances(e[s])}_cloneAttributes(t){const e={};for(const s in t)if(!!t.hasOwnProperty(s))if(t[s].type!=="entity")e[s]=ei({},t[s]);else{const i=t[s].value;delete t[s].value,e[s]=ei({},t[s]),e[s].value=i,t[s].value=i}return e}_createAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const r=t.script.scripts[n];if(r.url===i){const a=r.attributes;if(r.name&&a){for(const l in a)a.hasOwnProperty(l)&&this._createAccessor(a[l],e);t.script.data.attributes[r.name]=this._cloneAttributes(a)}break}}}_createAccessor(t,e){const s=this;t={name:t.name,value:t.value,type:t.type},this._convertAttributeValue(t),Object.defineProperty(e.instance,t.name,{get:function(){return t.value},set:function(i){const n=t.value;t.value=i,s._convertAttributeValue(t),e.instance.fire("set",t.name,n,t.value)},configurable:!0})}_updateAccessors(t,e){const s=t.script.scripts.length,i=e.url;for(let n=0;n<s;n++){const r=t.script,a=r.scripts[n];if(a.url===i){const l=a.name,h=a.attributes;if(l){if(h)for(const d in h)h.hasOwnProperty(d)&&this._createAccessor(h[d],e);const c=r.data.attributes[l];if(c)for(const d in c){const u=c[d];d in h?h[d].value!==u.value&&e.instance.onAttributeChanged&&e.instance.onAttributeChanged(u.name,u.value,h[d].value):delete e.instance[u.name]}h?r.data.attributes[l]=this._cloneAttributes(h):delete r.data.attributes[l]}break}}}_convertAttributeValue(t){if(t.type==="rgb"||t.type==="rgba")Array.isArray(t.value)&&(t.value=t.value.length===3?new j(t.value[0],t.value[1],t.value[2]):new j(t.value[0],t.value[1],t.value[2],t.value[3]));else if(t.type==="vec2")Array.isArray(t.value)&&(t.value=new H(t.value[0],t.value[1]));else if(t.type==="vec3"||t.type==="vector")Array.isArray(t.value)&&(t.value=new y(t.value[0],t.value[1],t.value[2]));else if(t.type==="vec4")Array.isArray(t.value)&&(t.value=new Z(t.value[0],t.value[1],t.value[2],t.value[3]));else if(t.type==="entity")t.value!==null&&typeof t.value=="string"&&(t.value=this.app.root.findByGuid(t.value));else if(t.type==="curve"||t.type==="colorcurve"){const e=t.value.keys[0]instanceof Array?us:fe;t.value=new e(t.value.keys),t.value.type=t.value.type}}destroy(){super.destroy(),this.app.systems.off(Pd,this.onInitialize,this),this.app.systems.off(Ed,this.onPostInitialize,this),this.app.systems.off(Rd,this.onUpdate,this),this.app.systems.off(Ld,this.onFixedUpdate,this),this.app.systems.off(Id,this.onPostUpdate,this),this.app.systems.off(Dd,this.onToolsUpdate,this)}}st._buildAccessors(A_.prototype,M_);const Si=new H,P_=new y,ua=new y,Bl=new y,E_=new y,Fd=new y,MP=new tt,PP={x:"y",y:"x"};class R_ extends at{constructor(t,e){super();if(!t||!(t instanceof Cl))throw new Error("Element was null or not an ElementComponent");if(e&&e!=="x"&&e!=="y")throw new Error("Unrecognized axis: "+e);this._element=t,this._app=t.system.app,this._axis=e||null,this._enabled=!0,this._dragScale=new y,this._dragStartMousePosition=new y,this._dragStartHandlePosition=new y,this._deltaMousePosition=new y,this._deltaHandlePosition=new y,this._isDragging=!1,this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this._element[t]("mousedown",this._onMouseDownOrTouchStart,this),this._element[t]("touchstart",this._onMouseDownOrTouchStart,this)}_toggleDragListeners(t){const e=t==="on",s=e?"addEventListener":"removeEventListener";this._hasDragListeners&&e||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[t]("mousemove",this._onMove,this),window[s]("mouseup",this._handleMouseUpOrTouchEnd,!1)),Dt.touch&&(this._app.touch[t]("touchmove",this._onMove,this),window[s]("touchend",this._handleMouseUpOrTouchEnd,!1),window[s]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=e)}_onMouseDownOrTouchStart(t){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=t.camera,this._calculateDragScale();const e=this._screenToLocal(t);e&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(e),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))}}_onMouseUpOrTouchEnd(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))}_screenToLocal(t){this._determineInputPosition(t),this._chooseRayOriginAndDirection(),E_.copy(this._element.entity.getPosition()),Fd.copy(this._element.entity.forward).mulScalar(-1);const e=Fd.dot(Bl);if(Math.abs(e)>0){const i=E_.sub(ua).dot(Fd)/e,n=ua.add(Bl.mulScalar(i));return MP.copy(this._element.entity.getRotation()).invert().transformVector(n,n),n.mul(this._dragScale),n}return null}_determineInputPosition(t){const e=this._app.graphicsDevice.maxPixelRatio;typeof t.x!="undefined"&&typeof t.y!="undefined"?(Si.x=t.x*e,Si.y=t.y*e):t.changedTouches?(Si.x=t.changedTouches[0].x*e,Si.y=t.changedTouches[0].y*e):console.warn("Could not determine position from input event")}_chooseRayOriginAndDirection(){this._element.screen&&this._element.screen.screen.screenSpace?(ua.set(Si.x,-Si.y,0),Bl.set(0,0,-1)):(P_.copy(this._dragCamera.screenToWorld(Si.x,Si.y,1)),ua.copy(this._dragCamera.entity.getPosition()),Bl.copy(P_).sub(ua).normalize())}_calculateDragScale(){let t=this._element.entity.parent;const e=this._element.screen&&this._element.screen.screen,s=e&&e.screenSpace,i=s?e.scale:1,n=this._dragScale;for(n.set(i,i,i);t&&(n.mul(t.getLocalScale()),t=t.parent,!(s&&t.screen)););n.x=1/n.x,n.y=1/n.y,n.z=1/n.z}_onMove(t){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){const e=this._screenToLocal(t);if(this._dragStartMousePosition&&e){if(this._deltaMousePosition.copy(e).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){const s=this._element.entity.getLocalPosition(),i=PP[this._axis];this._deltaHandlePosition[i]=s[i]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}}}destroy(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}set enabled(t){this._enabled=t}get enabled(){return this._enabled}get isDragging(){return this._isDragging}}const EP=0,I_=1,RP=2,IP=0,LP=1,DP="mousedown",FP="mousemove",OP="mouseup",L_="mousewheel",BP=-1,fa=new H;class D_ extends st{constructor(t,e){super(t,e);this._viewportReference=new qi(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new qi(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[ht]=new qi(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[St]=new qi(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[ht]=null,this._prevContentSizes[St]=null,this._scroll=new H,this._velocity=new y,this._dragStartPosition=new y,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",t),this._toggleElementListeners("on")}_toggleLifecycleListeners(t,e){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)}_toggleElementListeners(t){if(this.entity.element){if(t==="on"&&this._hasElementListeners)return;this.entity.element[t]("resize",this._onSetContentOrViewportSize,this),this.entity.element[t](L_,this._onMouseWheel,this),this._hasElementListeners=t==="on"}}_onElementComponentAdd(t){this.entity===t&&this._toggleElementListeners("on")}_onElementComponentRemove(t){this.entity===t&&this._toggleElementListeners("off")}_onViewportElementGain(){this._syncAll()}_onContentElementGain(){this._destroyDragHelper(),this._contentDragHelper=new R_(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[ht]=null,this._prevContentSizes[St]=null,this._syncAll()}_onContentElementLose(){this._destroyDragHelper()}_onContentDragStart(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())}_onContentDragEnd(){this._prevContentDragPosition=null,this._enableContentInput()}_onContentDragMove(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(t),this._setVelocityFromContentPositionDelta(t),!this._disabledContentInput)){const e=t.x-this._dragStartPosition.x,s=t.y-this._dragStartPosition.y;(Math.abs(e)>this.dragThreshold||Math.abs(s)>this.dragThreshold)&&this._disableContentInput()}}_onSetContentOrViewportSize(){this._syncAll()}_onSetHorizontalScrollbarValue(t){!this._scrollbarUpdateFlags[ht]&&this.enabled&&this.entity.enabled&&this._onSetScroll(t,null)}_onSetVerticalScrollbarValue(t){!this._scrollbarUpdateFlags[St]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,t)}_onSetHorizontalScrollingEnabled(){this._syncScrollbarEnabledState(ht)}_onSetVerticalScrollingEnabled(){this._syncScrollbarEnabledState(St)}_onHorizontalScrollbarGain(){this._syncScrollbarEnabledState(ht),this._syncScrollbarPosition(ht)}_onVerticalScrollbarGain(){this._syncScrollbarEnabledState(St),this._syncScrollbarPosition(St)}_onSetScroll(t,e,s){s!==!1&&this._velocity.set(0,0,0);const i=this._updateAxis(t,"x",ht),n=this._updateAxis(e,"y",St);(i||n)&&this.fire("set:scroll",this._scroll)}_updateAxis(t,e,s){const i=t!==null&&Math.abs(t-this._scroll[e])>1e-5;return(i||this._isDragging()||t===0)&&(this._scroll[e]=this._determineNewScrollValue(t,e,s),this._syncContentPosition(s),this._syncScrollbarPosition(s)),i}_determineNewScrollValue(t,e,s){if(!this._getScrollingEnabled(s))return this._scroll[e];switch(this.scrollMode){case EP:return U.clamp(t,0,this._getMaxScrollValue(s));case I_:return this._setVelocityFromOvershoot(t,e,s),t;case RP:return t;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),t}}_syncAll(){this._syncContentPosition(ht),this._syncContentPosition(St),this._syncScrollbarPosition(ht),this._syncScrollbarPosition(St),this._syncScrollbarEnabledState(ht),this._syncScrollbarEnabledState(St)}_syncContentPosition(t){const e=this._getAxis(t),s=this._getSign(t),i=this._contentReference.entity;if(i){const n=this._prevContentSizes[t],r=this._getContentSize(t);if(n!==null&&Math.abs(n-r)>1e-4){const h=this._getMaxOffset(t,n),c=this._getMaxOffset(t,r);c===0?this._scroll[e]=1:this._scroll[e]=U.clamp(this._scroll[e]*h/c,0,1)}const a=this._scroll[e]*this._getMaxOffset(t),l=i.getLocalPosition();l[e]=a*s,i.setLocalPosition(l),this._prevContentSizes[t]=r}}_syncScrollbarPosition(t){const e=this._getAxis(t),s=this._scrollbarReferences[t].entity;s&&s.scrollbar&&(this._scrollbarUpdateFlags[t]=!0,s.scrollbar.value=this._scroll[e],s.scrollbar.handleSize=this._getScrollbarHandleSize(e,t),this._scrollbarUpdateFlags[t]=!1)}_syncScrollbarEnabledState(t){const e=this._scrollbarReferences[t].entity;if(e){const s=this._getScrollingEnabled(t),i=this._getScrollbarVisibility(t);switch(i){case IP:e.enabled=s;return;case LP:e.enabled=s&&this._contentIsLargerThanViewport(t);return;default:console.warn("Unhandled scrollbar visibility:"+i),e.enabled=s}}}_contentIsLargerThanViewport(t){return this._getContentSize(t)>this._getViewportSize(t)}_contentPositionToScrollValue(t){const e=this._getMaxOffset(ht),s=this._getMaxOffset(St);return e===0?fa.x=0:fa.x=t.x/e,s===0?fa.y=0:fa.y=t.y/-s,fa}_getMaxOffset(t,e){e=e===void 0?this._getContentSize(t):e;const s=this._getViewportSize(t);return e<s?-this._getViewportSize(t):s-e}_getMaxScrollValue(t){return this._contentIsLargerThanViewport(t)?1:0}_getScrollbarHandleSize(t,e){const s=this._getViewportSize(e),i=this._getContentSize(e);if(Math.abs(i)<.001)return 1;const n=Math.min(s/i,1),r=this._toOvershoot(this._scroll[t],e);return r===0?n:n/(1+Math.abs(r))}_getViewportSize(t){return this._getSize(t,this._viewportReference)}_getContentSize(t){return this._getSize(t,this._contentReference)}_getSize(t,e){return e.entity&&e.entity.element?e.entity.element[this._getCalculatedDimension(t)]:0}_getScrollingEnabled(t){if(t===ht)return this.horizontal;if(t===St)return this.vertical;console.warn("Unrecognized orientation: "+t)}_getScrollbarVisibility(t){if(t===ht)return this.horizontalScrollbarVisibility;if(t===St)return this.verticalScrollbarVisibility;console.warn("Unrecognized orientation: "+t)}_getSign(t){return t===ht?1:-1}_getAxis(t){return t===ht?"x":"y"}_getCalculatedDimension(t){return t===ht?"calculatedWidth":"calculatedHeight"}_destroyDragHelper(){this._contentDragHelper&&this._contentDragHelper.destroy()}onUpdate(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(ht),this._syncScrollbarEnabledState(St))}_updateVelocity(){if(!this._isDragging()){if(this.scrollMode===I_&&(this._hasOvershoot("x",ht)&&this._setVelocityFromOvershoot(this.scroll.x,"x",ht),this._hasOvershoot("y",St)&&this._setVelocityFromOvershoot(this.scroll.y,"y",St)),Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){const t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x,t.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(t),this._setScrollFromContentPosition(t)}this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction}}_hasOvershoot(t,e){return Math.abs(this._toOvershoot(this.scroll[t],e))>.001}_toOvershoot(t,e){const s=this._getMaxScrollValue(e);return t<0?t:t>s?t-s:0}_setVelocityFromOvershoot(t,e,s){const n=this._toOvershoot(t,s)*this._getMaxOffset(s)*this._getSign(s);Math.abs(n)>0&&(this._velocity[e]=-n/(this.bounceAmount*50+1))}_setVelocityFromContentPositionDelta(t){this._prevContentDragPosition?(this._velocity.sub2(t,this._prevContentDragPosition),this._prevContentDragPosition.copy(t)):(this._velocity.set(0,0,0),this._prevContentDragPosition=t.clone())}_setScrollFromContentPosition(t){let e=this._contentPositionToScrollValue(t);this._isDragging()&&(e=this._applyScrollValueTension(e)),this._onSetScroll(e.x,e.y,!1)}_applyScrollValueTension(t){const e=1;let s=this._getMaxScrollValue(ht),i=this._toOvershoot(t.x,ht);return i>0?t.x=s+e*Math.log10(1+i):i<0&&(t.x=-e*Math.log10(1-i)),s=this._getMaxScrollValue(St),i=this._toOvershoot(t.y,St),i>0?t.y=s+e*Math.log10(1+i):i<0&&(t.y=-e*Math.log10(1-i)),t}_isDragging(){return this._contentDragHelper&&this._contentDragHelper.isDragging}_setScrollbarComponentsEnabled(t){this._scrollbarReferences[ht].hasComponent("scrollbar")&&(this._scrollbarReferences[ht].entity.scrollbar.enabled=t),this._scrollbarReferences[St].hasComponent("scrollbar")&&(this._scrollbarReferences[St].entity.scrollbar.enabled=t)}_setContentDraggingEnabled(t){this._contentDragHelper&&(this._contentDragHelper.enabled=t)}_onMouseWheel(t){if(this.useMouseWheel){const e=t.event,s=e.deltaX/this._contentReference.entity.element.calculatedWidth*this.mouseWheelSensitivity.x,i=e.deltaY/this._contentReference.entity.element.calculatedHeight*this.mouseWheelSensitivity.y,n=U.clamp(this._scroll.x+s,0,this._getMaxScrollValue(ht)),r=U.clamp(this._scroll.y+i,0,this._getMaxScrollValue(St));this.scroll=new H(n,r)}}_enableContentInput(){for(;this._disabledContentInputEntities.length;){const t=this._disabledContentInputEntities.pop();t.element&&(t.element.useInput=!0)}this._disabledContentInput=!1}_disableContentInput(){const t=s=>{s.element&&s.element.useInput&&(this._disabledContentInputEntities.push(s),s.element.useInput=!1);const i=s.children;for(let n=0,r=i.length;n<r;n++)t(i[n])},e=this._contentReference.entity;if(e){const s=e.children;for(let i=0,n=s.length;i<n;i++)t(s[i])}this._disabledContentInput=!0}onEnable(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[ht].onParentComponentEnable(),this._scrollbarReferences[St].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()}onDisable(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)}onRemove(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}set scroll(t){this._onSetScroll(t.x,t.y)}get scroll(){return this._scroll}}class kP{constructor(){this.enabled=!0}}const Od=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"useMouseWheel",type:"boolean"},{name:"mouseWheelSensitivity",type:"vec2"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],zP=10;class UP extends Bt{constructor(t){super(t);this.id="scrollview",this.ComponentType=D_,this.DataType=kP,this.schema=Od,this.on("beforeremove",this._onRemoveComponent,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){e.dragThreshold===void 0&&(e.dragThreshold=zP),e.useMouseWheel===void 0&&(e.useMouseWheel=!0),e.mouseWheelSensitivity===void 0&&(e.mouseWheelSensitivity=new H(1,1)),super.initializeComponentData(t,e,Od)}onUpdate(t){const e=this.store;for(const s in e){const i=e[s].entity,n=i.scrollview;n.enabled&&i.enabled&&n.onUpdate()}}_onRemoveComponent(t,e){e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(D_.prototype,Od);class F_ extends st{constructor(t,e){super(t,e);this._handleReference=new qi(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}_toggleLifecycleListeners(t){this[t]("set_value",this._onSetValue,this),this[t]("set_handleSize",this._onSetHandleSize,this),this[t]("set_orientation",this._onSetOrientation,this)}_onHandleElementGain(){this._destroyDragHelper(),this._handleDragHelper=new R_(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()}_onHandleElementLose(){this._destroyDragHelper()}_onHandleDrag(t){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(t[this._getAxis()]))}_onSetValue(t,e,s){Math.abs(s-e)>1e-5&&(this.data.value=U.clamp(s,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))}_onSetHandleSize(t,e,s){Math.abs(s-e)>1e-5&&(this.data.handleSize=U.clamp(s,0,1),this._updateHandlePositionAndSize())}_onSetHandleAlignment(){this._updateHandlePositionAndSize()}_onSetOrientation(t,e,s){s!==e&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)}_updateHandlePositionAndSize(){const t=this._handleReference.entity,e=t&&t.element;if(t){const s=t.getLocalPosition();s[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(s)}e&&(e[this._getDimension()]=this._getHandleLength())}_handlePositionToScrollValue(t){return t*this._getSign()/this._getUsableTrackLength()}_scrollValueToHandlePosition(t){return t*this._getSign()*this._getUsableTrackLength()}_getUsableTrackLength(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)}_getTrackLength(){return this.entity.element?this.orientation===ht?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0}_getHandleLength(){return this._getTrackLength()*this.handleSize}_getHandlePosition(){return this._scrollValueToHandlePosition(this.value)}_getSign(){return this.orientation===ht?1:-1}_getAxis(){return this.orientation===ht?"x":"y"}_getDimension(){return this.orientation===ht?"width":"height"}_getOppositeDimension(){return this.orientation===ht?"height":"width"}_destroyDragHelper(){this._handleDragHelper&&this._handleDragHelper.destroy()}_setHandleDraggingEnabled(t){this._handleDragHelper&&(this._handleDragHelper.enabled=t)}onEnable(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)}onDisable(){this._setHandleDraggingEnabled(!1)}onRemove(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}}class NP{constructor(){this.enabled=!0}}const Bd=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];class VP extends Bt{constructor(t){super(t);this.id="scrollbar",this.ComponentType=F_,this.DataType=NP,this.schema=Bd,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,Bd)}_onRemoveComponent(t,e){e.onRemove()}}st._buildAccessors(F_.prototype,Bd);const Fe=0,Zn=1,hs=2;function ye(o,t){return o%t||0}class sn extends at{constructor(t,e,s){super();this.source=null,this._manager=t,this._volume=s.volume!==void 0?U.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0?s.loop:!1),this._sound=e,this._state=hs,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(s.startTime)||0),this._duration=Math.max(0,Number(s.duration)||0),this._startOffset=null,this._onPlayCallback=s.onPlay,this._onPauseCallback=s.onPause,this._onResumeCallback=s.onResume,this._onStopCallback=s.onStop,this._onEndCallback=s.onEnd,as()?(this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._initializeNodes(),this._endedHandler=this._onEnded.bind(this)):(this._isReady=!1,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._createSource())}set currentTime(t){if(!(t<0))if(this._state===Fe){const e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this.stop(),this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._startOffset=t,this._currentTime=t}get currentTime(){return this._startOffset!==null?this._startOffset:this._state===Zn?this._currentTime:this._state===hs||!this.source?0:(this._updateCurrentTime(),this._currentTime)}set duration(t){this._duration=Math.max(0,Number(t)||0);const e=this._state===Fe;this.stop(),e&&this.play()}get duration(){return this._sound?this._duration?ye(this._duration,this._sound.duration):this._sound.duration:0}get isPaused(){return this._state===Zn}get isPlaying(){return this._state===Fe}get isStopped(){return this._state===hs}get isSuspended(){return this._suspended}set loop(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}get loop(){return this._loop}set pitch(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}get pitch(){return this._pitch}set sound(t){this._sound=t,this._state!==hs?this.stop():this._createSource()}get sound(){return this._sound}set startTime(t){this._startTime=Math.max(0,Number(t)||0);const e=this._state===Fe;this.stop(),e&&this.play()}get startTime(){return this._startTime}set volume(t){t=U.clamp(t,0,1),this._volume=t,this.gain&&(this.gain.gain.value=t*this._manager.volume)}get volume(){return this._volume}_onPlay(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)}_onPause(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)}_onResume(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)}_onStop(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)}_onEnded(){if(this._suspendEndEvent){this._suspendEndEvent=!1;return}this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()}_onManagerVolumeChange(){this.volume=this._volume}_onManagerSuspend(){this._state===Fe&&!this._suspended&&(this._suspended=!0,this.pause())}_onManagerResume(){this._suspended&&(this._suspended=!1,this.resume())}_initializeNodes(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}play(){this._state!==hs&&this.stop(),this.source||this._createSource();let t=ye(this._startOffset,this.duration);return t=ye(this._startTime+t,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=Fe,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0}pause(){return this._playWhenLoaded=!1,this._state!==Fe||!this.source?!1:(this._updateCurrentTime(),this._state=Zn,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)}resume(){if(this._state!==Zn)return!1;this.source||this._createSource();let t=this.currentTime;return this._startOffset!==null&&(t=ye(this._startOffset,this.duration),t=ye(this._startTime+t,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=Fe,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0}stop(){return this._playWhenLoaded=!1,this._state===hs||!this.source?!1:(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._suspendEndEvent=!0,this._state===Fe&&this.source.stop(0),this.source=null,this._state=hs,this._suspendInstanceEvents||this._onStop(),!0)}setExternalNodes(t,e){if(!t){console.error("The firstNode must be a valid Audio Node");return}e||(e=t);const s=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(s),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(s),this._lastNode=e,this._lastNode.connect(s))}clearExternalNodes(){const t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)}getExternalNodes(){return[this._firstNode,this._lastNode]}_createSource(){if(!this._sound)return null;const t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=ye(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,ye(this._startTime+this._duration,this.source.buffer.duration)))),this.source}_updateCurrentTime(){this._currentTime=ye((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)}_onManagerDestroy(){this.source&&this._state===Fe&&(this.source.stop(0),this.source=null)}}as()||(Object.assign(sn.prototype,{play:function(){return this._state!==hs&&this.stop(),!this.source&&!this._createSource()?!1:(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=Fe,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!this.source||this._state!==Fe?!1:(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=Zn,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!this.source||this._state!==Zn?!1:(this._state=Fe,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!this.source||this._state===hs?!1:(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=hs,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;let o=ye(this._startOffset,this.duration);o=ye(this._startTime+o,this._sound.duration),this._startOffset=null,this.source.currentTime=o},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){!this._duration||this.source.currentTime>ye(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=ye(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(sn.prototype,"volume",{get:function(){return this._volume},set:function(o){o=U.clamp(o,0,1),this._volume=o,this.source&&(this.source.volume=o*this._manager.volume)}}),Object.defineProperty(sn.prototype,"pitch",{get:function(){return this._pitch},set:function(o){this._pitch=Math.max(Number(o)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(sn.prototype,"sound",{get:function(){return this._sound},set:function(o){this.stop(),this._sound=o}}),Object.defineProperty(sn.prototype,"currentTime",{get:function(){return this._startOffset!==null?this._startOffset:this._state===hs||!this.source?0:this.source.currentTime-this._startTime},set:function(o){o<0||(this._startOffset=o,this.source&&this._isReady&&(this.source.currentTime=ye(this._startTime+ye(o,this.duration),this._sound.duration),this._startOffset=null))}}));const WP=1e4;class Jn extends sn{constructor(t,e,s={}){super(t,e,s);this._position=new y,this._velocity=new y,s.position&&(this.position=s.position),this.maxDistance=s.maxDistance!==void 0?Number(s.maxDistance):WP,this.refDistance=s.refDistance!==void 0?Number(s.refDistance):1,this.rollOffFactor=s.rollOffFactor!==void 0?Number(s.rollOffFactor):1,this.distanceModel=s.distanceModel!==void 0?s.distanceModel:Xo}_initializeNodes(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}set position(t){this._position.copy(t);const e=this.panner;"positionX"in e?(e.positionX.value=t.x,e.positionY.value=t.y,e.positionZ.value=t.z):e.setPosition&&e.setPosition(t.x,t.y,t.z)}get position(){return this._position}set velocity(t){this._velocity.copy(t)}get velocity(){return this._velocity}set maxDistance(t){this.panner.maxDistance=t}get maxDistance(){return this.panner.maxDistance}set refDistance(t){this.panner.refDistance=t}get refDistance(){return this.panner.refDistance}set rollOffFactor(t){this.panner.rolloffFactor=t}get rollOffFactor(){return this.panner.rolloffFactor}set distanceModel(t){this.panner.distanceModel=t}get distanceModel(){return this.panner.distanceModel}}if(!as()){let o=new y;const t=function(s,i,n,r,a,l){o=o.sub2(s,i);const h=o.length();if(h<n)return 1;if(h>r)return 0;let c=0;return l===Xo?c=1-a*(h-n)/(r-n):l===jo?c=n/(n+a*(h-n)):l===xm&&(c=Math.pow(h/n,-a)),U.clamp(c,0,1)};Object.defineProperty(Jn.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copy(e),this.source){const i=this._manager.listener.getPosition(),n=t(i,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),r=this.volume;this.source.volume=r*n*this._manager.volume}}}),Object.defineProperty(Jn.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e}}),Object.defineProperty(Jn.prototype,"refDistance",{get:function(){return this._refDistance},set:function(e){this._refDistance=e}}),Object.defineProperty(Jn.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(e){this._rollOffFactor=e}}),Object.defineProperty(Jn.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(e){this._distanceModel=e}})}const GP={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new y,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};class kd extends at{constructor(t,e="Untitled",s={}){super();this.name=void 0,this.instances=[],this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this.name=e,this._volume=s.volume!==void 0?U.clamp(Number(s.volume)||0,0,1):1,this._pitch=s.pitch!==void 0?Math.max(.01,Number(s.pitch)||0):1,this._loop=!!(s.loop!==void 0?s.loop:!1),this._duration=s.duration>0?s.duration:null,this._startTime=Math.max(0,Number(s.startTime)||0),this._overlap=!!s.overlap,this._autoPlay=!!s.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=s.asset,this._asset instanceof rt&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this)}play(){if(this.overlap||this.stop(),!this.isLoaded&&!this._hasAsset())return;const t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{const e=function(i){const n=t._playWhenLoaded;t.sound=i,n&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t}pause(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].pause()&&(t=!0);return t}resume(){let t=!1;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].resume()&&(t=!0);return t}stop(){let t=!1;const e=this.instances;let s=e.length;for(;s--;)e[s].stop(),t=!0;return e.length=0,t}load(){if(!this._hasAsset())return;const t=this._assets.get(this._asset);if(!t){this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}if(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),!t.resource){t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),this._assets.load(t);return}this.fire("load",t.resource)}setExternalNodes(t,e){if(!t){console.error("The firstNode must have a valid AudioNode");return}if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap){const s=this.instances;for(let i=0,n=s.length;i<n;i++)s[i].setExternalNodes(t,e)}}clearExternalNodes(){if(this._firstNode=null,this._lastNode=null,!this._overlap){const t=this.instances;for(let e=0,s=t.length;e<s;e++)t[e].clearExternalNodes()}}getExternalNodes(){return[this._firstNode,this._lastNode]}_hasAsset(){return this._asset!=null}_createInstance(){let t=null;const e=this._component;let s=null;if(this._hasAsset()){const n=this._assets.get(this._asset);n&&(s=n.resource)}const i=GP;return i.volume=this._volume*e.volume,i.pitch=this._pitch*e.pitch,i.loop=this._loop,i.startTime=this._startTime,i.duration=this._duration,i.onPlay=this._onInstancePlayHandler,i.onPause=this._onInstancePauseHandler,i.onResume=this._onInstanceResumeHandler,i.onStop=this._onInstanceStopHandler,i.onEnd=this._onInstanceEndHandler,e.positional?(i.position.copy(e.entity.getPosition()),i.maxDistance=e.maxDistance,i.refDistance=e.refDistance,i.rollOffFactor=e.rollOffFactor,i.distanceModel=e.distanceModel,t=new Jn(this._manager,s,i)):t=new sn(this._manager,s,i),this._firstNode&&t.setExternalNodes(this._firstNode,this._lastNode),t}_onInstancePlay(t){this.fire("play",t),this._component.fire("play",this,t)}_onInstancePause(t){this.fire("pause",t),this._component.fire("pause",this,t)}_onInstanceResume(t){this.fire("resume",t),this._component.fire("resume",this,t)}_onInstanceStop(t){const e=this.instances.indexOf(t);e!==-1&&this.instances.splice(e,1),this.fire("stop",t),this._component.fire("stop",this,t)}_onInstanceEnd(t){const e=this.instances.indexOf(t);e!==-1&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)}_onAssetAdd(t){this.load()}_onAssetLoad(t){this.load()}_onAssetRemoved(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()}updatePosition(t){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].position=t}set asset(t){const e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);const s=this._assets.get(e);s&&s.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof rt&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}get asset(){return this._asset}set autoPlay(t){this._autoPlay=!!t}get autoPlay(){return this._autoPlay}set duration(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].duration=this._duration}}get duration(){let t=0;if(this._hasAsset()){const e=this._assets.get(this._asset);t=e!=null&&e.resource?e.resource.duration:0}return this._duration!=null?this._duration%(t||1):t}get isLoaded(){if(this._hasAsset()){const t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}get isPaused(){const t=this.instances,e=t.length;if(e===0)return!1;for(let s=0;s<e;s++)if(!t[s].isPaused)return!1;return!0}get isPlaying(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(t[e].isPlaying)return!0;return!1}get isStopped(){const t=this.instances;for(let e=0,s=t.length;e<s;e++)if(!t[e].isStopped)return!1;return!0}set loop(t){this._loop=!!t;const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].loop=this._loop}get loop(){return this._loop}set overlap(t){this._overlap=!!t}get overlap(){return this._overlap}set pitch(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].pitch=this.pitch*this._component.pitch}}get pitch(){return this._pitch}set startTime(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].startTime=this._startTime}}get startTime(){return this._startTime}set volume(t){if(this._volume=U.clamp(Number(t)||0,0,1),!this._overlap){const e=this.instances;for(let s=0,i=e.length;s<i;s++)e[s].volume=this._volume*this._component.volume}}get volume(){return this._volume}}class O_ extends st{constructor(t,e){super(t,e);this._volume=1,this._pitch=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel=Xo,this._slots={},this._playingBeforeDisable={}}_updateSoundInstances(t,e,s){const i=this._slots;for(const n in i){const r=i[n];if(!r.overlap){const a=r.instances;for(let l=0,h=a.length;l<h;l++)a[l][t]=s?r[t]*e:e}}}set distanceModel(t){this._distanceModel=t,this._updateSoundInstances("distanceModel",t,!1)}get distanceModel(){return this._distanceModel}set maxDistance(t){this._maxDistance=t,this._updateSoundInstances("maxDistance",t,!1)}get maxDistance(){return this._maxDistance}set refDistance(t){this._refDistance=t,this._updateSoundInstances("refDistance",t,!1)}get refDistance(){return this._refDistance}set rollOffFactor(t){this._rollOffFactor=t,this._updateSoundInstances("rollOffFactor",t,!1)}get rollOffFactor(){return this._rollOffFactor}set pitch(t){this._pitch=t,this._updateSoundInstances("pitch",t,!0)}get pitch(){return this._pitch}set volume(t){this._volume=t,this._updateSoundInstances("volume",t,!0)}get volume(){return this._volume}set positional(t){this._positional=t;const e=this._slots;for(const s in e){const i=e[s];if(!i.overlap){const n=i.instances,r=n.length;for(let a=r-1;a>=0;a--){const l=n[a].isPlaying||n[a].isSuspended,h=n[a].currentTime;l&&n[a].stop();const c=i._createInstance();l&&(c.play(),c.currentTime=h),n.push(c)}}}}get positional(){return this._positional}set slots(t){const e=this._slots;if(e)for(const i in e)e[i].stop();const s={};for(const i in t)t[i]instanceof kd?s[t[i].name]=t[i]:t[i].name&&(s[t[i].name]=new kd(this,t[i].name,t[i]));this._slots=s,this.enabled&&this.entity.enabled&&this.onEnable()}get slots(){return this._slots}onEnable(){if(this.system._inTools)return;const t=this._slots,e=this._playingBeforeDisable;for(const s in t){const i=t[s];i.autoPlay&&i.isStopped?i.play():e[s]?i.resume():i.isLoaded||i.load()}}onDisable(){const t=this._slots,e={};for(const s in t)t[s].overlap||t[s].isPlaying&&(t[s].pause(),e[s]=!0);this._playingBeforeDisable=e}onRemove(){this.off()}addSlot(t,e){const s=this._slots;if(s[t])return null;const i=new kd(this,t,e);return s[t]=i,i.autoPlay&&this.enabled&&this.entity.enabled&&i.play(),i}removeSlot(t){const e=this._slots;e[t]&&(e[t].stop(),delete e[t])}slot(t){return this._slots[t]}play(t){if(!this.enabled||!this.entity.enabled)return null;const e=this._slots[t];return e?e.play():null}pause(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.pause()}else for(const s in e)e[s].pause()}resume(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.isPaused&&s.resume()}else for(const s in e)e[s].resume()}stop(t){const e=this._slots;if(t){const s=e[t];if(!s)return;s.stop()}else for(const s in e)e[s].stop()}}class HP{constructor(){this.enabled=!0}}const B_=["enabled"];class XP extends Bt{constructor(t,e){super(t);this.id="sound",this.ComponentType=O_,this.DataType=HP,this.schema=B_,this.manager=e,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set volume(t){this.manager.volume=t}get volume(){return this.manager.volume}get context(){return as()?this.manager.context:null}initializeComponentData(t,e,s){s=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(let i=0;i<s.length;i++)e.hasOwnProperty(s[i])&&(t[s[i]]=e[s[i]]);super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.sound,i=s.slots,n={};for(const a in i){const l=i[a];n[a]={name:l.name,volume:l.volume,pitch:l.pitch,loop:l.loop,duration:l.duration,startTime:l.startTime,overlap:l.overlap,autoPlay:l.autoPlay,asset:l.asset}}const r={distanceModel:s.distanceModel,enabled:s.enabled,maxDistance:s.maxDistance,pitch:s.pitch,positional:s.positional,refDistance:s.refDistance,rollOffFactor:s.rollOffFactor,slots:n,volume:s.volume};return this.addComponent(e,r)}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const n=e[s].entity;if(n.enabled){const r=n.sound;if(r.enabled&&r.positional){const a=n.getPosition(),l=r.slots;for(const h in l)l[h].updatePosition(a)}}}}onBeforeRemove(t,e){const s=e.slots;for(const i in s)s[i].overlap||s[i].stop();e.onRemove()}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}st._buildAccessors(O_.prototype,B_);const k_="simple",z_="animated";class zd extends at{constructor(t,e){super();this._component=t,this._frame=0,this._sprite=null,this._spriteAsset=null,this.spriteAsset=e.spriteAsset,this.name=e.name,this.fps=e.fps||0,this.loop=e.loop||!1,this._playing=!1,this._paused=!1,this._time=0}get duration(){if(this._sprite){const t=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(t)}return 0}set frame(t){this._setFrame(t);const e=this.fps||Number.MIN_VALUE;this._setTime(this._frame/e)}get frame(){return this._frame}get isPaused(){return this._paused}get isPlaying(){return this._playing}set sprite(t){if(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),this._sprite=t,this._sprite&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this){let e;!t||!t.atlas?(e=this._component._meshInstance,e&&(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap")),this._component._hideModel()):(t.atlas.texture&&(e=this._component._meshInstance,e&&(e.setParameter("texture_emissiveMap",t.atlas.texture),e.setParameter("texture_opacityMap",t.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame)}}get sprite(){return this._sprite}set spriteAsset(t){const e=this._component.system.app.assets;let s=t;if(t instanceof rt&&(s=t.id),this._spriteAsset!==s){if(this._spriteAsset){const i=e.get(this._spriteAsset);i&&this._unbindSpriteAsset(i)}if(this._spriteAsset=s,this._spriteAsset){const i=e.get(this._spriteAsset);i?this._bindSpriteAsset(i):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this))}else this.sprite=null}}get spriteAsset(){return this._spriteAsset}set time(t){this._setTime(t),this._sprite?this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):this.frame=0}get time(){return this._time}_onSpriteAssetAdded(t){this._component.system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)}_bindSpriteAsset(t){t.on("load",this._onSpriteAssetLoad,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._component.system.app.assets.load(t)}_unbindSpriteAsset(t){t.off("load",this._onSpriteAssetLoad,this),t.off("remove",this._onSpriteAssetRemove,this),t.resource&&t.resource.atlas&&this._component.system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)}_onSpriteAssetLoad(t){if(!t.resource)this.sprite=null;else if(t.resource.atlas)this.sprite=t.resource;else{const e=t.data.textureAtlasAsset,s=this._component.system.app.assets;s.off("load:"+e,this._onTextureAtlasLoad,this),s.once("load:"+e,this._onTextureAtlasLoad,this)}}_onTextureAtlasLoad(t){const e=this._spriteAsset;e instanceof rt?this._onSpriteAssetLoad(e):this._onSpriteAssetLoad(this._component.system.app.assets.get(e))}_onSpriteAssetRemove(t){this.sprite=null}_onSpriteMeshesChange(){this._component.currentClip===this&&this._component._showFrame(this.frame)}_onSpritePpuChanged(){this._component.currentClip===this&&this.sprite.renderMode!==oi&&this._component._showFrame(this.frame)}_update(t){if(this.fps===0||!this._playing||this._paused||!this._sprite)return;const e=this.fps<0?-1:1,s=this._time+t*this._component.speed*e,i=this.duration,n=s>i||s<0;this._setTime(s);let r=this.frame;this._sprite?r=Math.floor(this._sprite.frameKeys.length*this._time/i):r=0,r!==this._frame&&this._setFrame(r),n&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._playing=!1,this._paused=!1,this.fire("end"),this._component.fire("end",this)))}_setTime(t){this._time=t;const e=this.duration;this._time<0?this.loop?this._time=this._time%e+e:this._time=0:this._time>e&&(this.loop?this._time%=e:this._time=e)}_setFrame(t){this._sprite?this._frame=U.clamp(t,0,this._sprite.frameKeys.length-1):this._frame=t,this._component.currentClip===this&&this._component._showFrame(this._frame)}_destroy(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)}play(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))}pause(){!this._playing||this._paused||(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))}resume(){!this._paused||(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))}stop(){!this._playing||(this._playing=!1,this._paused=!1,this._time=0,this.frame=0,this.fire("stop"),this._component.fire("stop",this))}}const U_="texture_emissiveMap",N_="texture_opacityMap",V_="material_emissive",W_="material_opacity",jP="innerOffset",qP="outerScale",YP="atlasRect";class G_ extends st{constructor(t,e){super(t,e);this._type=k_,this._material=t.defaultMaterial,this._color=new j(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipX=!1,this._flipY=!1,this._width=1,this._height=1,this._drawOrder=0,this._layers=[xe],this._outerScale=new H(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new Z,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new Z,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new xt,this._model=new Ts,this._model.graph=this._node,this._meshInstance=null,e.addChild(this._model.graph),this._model._entity=e,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._defaultClip=new zd(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null}),this._currentClip=this._defaultClip}set type(t){this._type!==t&&(this._type=t,this._type===k_?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===z_&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}get type(){return this._type}set frame(t){this._currentClip.frame=t}get frame(){return this._currentClip.frame}set spriteAsset(t){this._defaultClip.spriteAsset=t}get spriteAsset(){return this._defaultClip._spriteAsset}set sprite(t){this._currentClip.sprite=t}get sprite(){return this._currentClip.sprite}set material(t){this._material=t,this._meshInstance&&(this._meshInstance.material=t)}get material(){return this._material}set color(t){this._color.r=t.r,this._color.g=t.g,this._color.b=t.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(V_,this._colorUniform))}get color(){return this._color}set opacity(t){this._color.a=t,this._meshInstance&&this._meshInstance.setParameter(W_,t)}get opacity(){return this._color.a}set clips(t){if(!t){for(const e in this._clips)this.removeClip(e);return}for(const e in this._clips){let s=!1;for(const i in t)if(t[i].name===e){s=!0,this._clips[e].fps=t[i].fps,this._clips[e].loop=t[i].loop,t[i].hasOwnProperty("sprite")?this._clips[e].sprite=t[i].sprite:t[i].hasOwnProperty("spriteAsset")&&(this._clips[e].spriteAsset=t[i].spriteAsset);break}s||this.removeClip(e)}for(const e in t)this._clips[t[e].name]||this.addClip(t[e]);this._autoPlayClip&&this._tryAutoPlay(),(!this._currentClip||!this._currentClip.sprite)&&this._hideModel()}get clips(){return this._clips}get currentClip(){return this._currentClip}set speed(t){this._speed=t}get speed(){return this._speed}set flipX(t){this._flipX!==t&&(this._flipX=t,this._updateTransform())}get flipX(){return this._flipX}set flipY(t){this._flipY!==t&&(this._flipY=t,this._updateTransform())}get flipY(){return this._flipY}set width(t){t!==this._width&&(this._width=t,this._outerScale.x=this._width,this.sprite&&(this.sprite.renderMode===Ut||this.sprite.renderMode===Xt)&&this._updateTransform())}get width(){return this._width}set height(t){t!==this._height&&(this._height=t,this._outerScale.y=this.height,this.sprite&&(this.sprite.renderMode===Ut||this.sprite.renderMode===Xt)&&this._updateTransform())}get height(){return this._height}set batchGroupId(t){if(this._batchGroupId===t)return;const e=this._batchGroupId;this._batchGroupId=t,this.entity.enabled&&e>=0&&this.system.app.batcher.remove(Wt.SPRITE,e,this.entity),this.entity.enabled&&t>=0?this.system.app.batcher.insert(Wt.SPRITE,t,this.entity):e>=0&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}get batchGroupId(){return this._batchGroupId}set autoPlayClip(t){this._autoPlayClip=t instanceof zd?t.name:t,this._tryAutoPlay()}get autoPlayClip(){return this._autoPlayClip}set drawOrder(t){this._drawOrder=t,this._meshInstance&&(this._meshInstance.drawOrder=t)}get drawOrder(){return this._drawOrder}set layers(t){this._addedModel&&this._hideModel(),this._layers=t,!!this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}get layers(){return this._layers}get aabb(){return this._meshInstance?this._meshInstance.aabb:null}onEnable(){const t=this.system.app,e=t.scene;e.on("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.on("add",this._onLayerAdded,this),e.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),this._batchGroupId>=0&&t.batcher.insert(Wt.SPRITE,this._batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene;e.off("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.off("add",this._onLayerAdded,this),e.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),this._batchGroupId>=0&&t.batcher.remove(Wt.SPRITE,this._batchGroupId,this.entity)}onDestroy(){this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(const t in this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance.mesh=null,this._meshInstance=null)}_showModel(){if(this._addedModel||!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const i=this.system.app.scene.layers.getLayerById(this._layers[e]);i&&i.addMeshInstances(t)}this._addedModel=!0}_hideModel(){if(!this._addedModel||!this._meshInstance)return;const t=[this._meshInstance];for(let e=0,s=this._layers.length;e<s;e++){const i=this.system.app.scene.layers.getLayerById(this._layers[e]);i&&i.removeMeshInstances(t)}this._addedModel=!1}_showFrame(t){if(!this.sprite)return;const e=this.sprite.meshes[t];if(!e){this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1);return}let s;if(this.sprite.renderMode===Xt?s=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===Ut?s=this.system.default9SlicedMaterialTiledMode:s=this.system.defaultMaterial,this._meshInstance||(this._meshInstance=new vt(e,this._material,this._node),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter(V_,this._colorUniform),this._meshInstance.setParameter(W_,this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==s&&(this._meshInstance.material=s),this._meshInstance.mesh!==e&&(this._meshInstance.mesh=e,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter(U_,this.sprite.atlas.texture),this._meshInstance.setParameter(N_,this.sprite.atlas.texture)):(this._meshInstance.deleteParameter(U_),this._meshInstance.deleteParameter(N_)),this.sprite.atlas&&(this.sprite.renderMode===Xt||this.sprite.renderMode===Ut)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;const i=this.sprite.atlas.frames[this.sprite.frameKeys[t]];if(i){const n=2/i.rect.z,r=2/i.rect.w;this._innerOffset.set(i.border.x*n,i.border.y*r,i.border.z*n,i.border.w*r);const a=this.sprite.atlas.texture;this._atlasRect.set(i.rect.x/a.width,i.rect.y/a.height,i.rect.z/a.width,i.rect.w/a.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter(jP,this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter(YP,this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()}_updateTransform(){let t=this.flipX?-1:1,e=this.flipY?-1:1,s=0,i=0;if(this.sprite&&(this.sprite.renderMode===Xt||this.sprite.renderMode===Ut)){let n=1,r=1;if(this.sprite.atlas){const h=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];h&&(n=h.rect.z,r=h.rect.w,s=(.5-h.pivot.x)*this._width,i=(.5-h.pivot.y)*this._height)}const a=n/this.sprite.pixelsPerUnit,l=r/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*a),Math.max(this._height,this._innerOffset.y*l)),t*=a,e*=l,this._outerScale.x/=a,this._outerScale.y/=l,t*=U.clamp(this._width/(this._innerOffset.x*a),1e-4,1),e*=U.clamp(this._height/(this._innerOffset.y*l),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter(qP,this._outerScaleUniform))}this._node.setLocalScale(t,e,1),this._node.setLocalPosition(s,i,0)}_updateAabb(t){return t.center.set(0,0,0),t.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001),t.setFromTransformedAabb(t,this._node.getWorldTransform()),t}_tryAutoPlay(){if(!this._autoPlayClip||this.type!==z_)return;const t=this._clips[this._autoPlayClip];t&&!t.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying)&&this.enabled&&this.entity.enabled&&this.play(t.name)}_onLayersChanged(t,e){t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()}_onLayerAdded(t){this.layers.indexOf(t.id)<0||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&t.addMeshInstances([this._meshInstance])}_onLayerRemoved(t){!this._meshInstance||this.layers.indexOf(t.id)<0||t.removeMeshInstances([this._meshInstance])}removeModelFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);!e||e.removeMeshInstances([this._meshInstance])}}addClip(t){const e=new zd(this,{name:t.name,fps:t.fps,loop:t.loop,spriteAsset:t.spriteAsset});return this._clips[t.name]=e,e.name&&e.name===this._autoPlayClip&&this._tryAutoPlay(),e}removeClip(t){delete this._clips[t]}clip(t){return this._clips[t]}play(t){const e=this._clips[t],s=this._currentClip;return s&&s!==e&&(s._playing=!1),this._currentClip=e,this._currentClip&&(this._currentClip=e,this._currentClip.play()),e}pause(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()}resume(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()}stop(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}class $P{constructor(){this.enabled=!0}}const H_=["enabled"];class KP extends Bt{constructor(t){super(t);this.id="sprite",this.ComponentType=G_,this.DataType=$P,this.schema=H_,this._defaultTexture=null,this._defaultMaterial=null,this._default9SlicedMaterialSlicedMode=null,this._default9SlicedMaterialTiledMode=null,this.app.systems.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}set defaultMaterial(t){this._defaultMaterial=t}get defaultMaterial(){if(!this._defaultMaterial){const t=new nt(this.app.graphicsDevice,{width:1,height:1,format:ct}),e=new Uint8Array(t.lock());e[0]=e[1]=e[2]=e[3]=255,t.name="sprite",t.unlock();const s=new ue;s.diffuse.set(0,0,0),s.emissive.set(.5,.5,.5),s.emissiveMap=t,s.emissiveMapTint=!0,s.opacityMap=t,s.opacityMapChannel="a",s.opacityTint=!0,s.opacity=0,s.useLighting=!1,s.useGammaTonemap=!1,s.useFog=!1,s.useSkybox=!1,s.blendType=Je,s.depthWrite=!1,s.pixelSnap=!1,s.cull=me,s.update(),this._defaultTexture=t,this._defaultMaterial=s}return this._defaultMaterial}set default9SlicedMaterialSlicedMode(t){this._default9SlicedMaterialSlicedMode=t}get default9SlicedMaterialSlicedMode(){if(!this._default9SlicedMaterialSlicedMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=Xt,t.update(),this._default9SlicedMaterialSlicedMode=t}return this._default9SlicedMaterialSlicedMode}set default9SlicedMaterialTiledMode(t){this._default9SlicedMaterialTiledMode=t}get default9SlicedMaterialTiledMode(){if(!this._default9SlicedMaterialTiledMode){const t=this.defaultMaterial.clone();t.nineSlicedMode=Ut,t.update(),this._default9SlicedMaterialTiledMode=t}return this._default9SlicedMaterialTiledMode}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)}initializeComponentData(t,e,s){if(e.enabled!==void 0&&(t.enabled=e.enabled),t.type=e.type,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),e.drawOrder!==void 0&&(t.drawOrder=e.drawOrder),e.color!==void 0&&(e.color instanceof j?t.color.set(e.color.r,e.color.g,e.color.b,e.opacity!==void 0?e.opacity:1):t.color.set(e.color[0],e.color[1],e.color[2],e.opacity!==void 0?e.opacity:1),t.color=t.color),e.opacity!==void 0&&(t.opacity=e.opacity),e.flipX!==void 0&&(t.flipX=e.flipX),e.flipY!==void 0&&(t.flipY=e.flipY),e.width!==void 0&&(t.width=e.width),e.height!==void 0&&(t.height=e.height),e.spriteAsset!==void 0&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),e.frame!==void 0&&(t.frame=e.frame),e.clips)for(const i in e.clips)t.addClip(e.clips[i]);e.speed!==void 0&&(t.speed=e.speed),e.autoPlayClip&&(t.autoPlayClip=e.autoPlayClip),t.batchGroupId=e.batchGroupId===void 0||e.batchGroupId===null?-1:e.batchGroupId,super.initializeComponentData(t,e,s)}cloneComponent(t,e){const s=t.sprite;return this.addComponent(e,{enabled:s.enabled,type:s.type,spriteAsset:s.spriteAsset,sprite:s.sprite,frame:s.frame,color:s.color.clone(),opacity:s.opacity,flipX:s.flipX,flipY:s.flipY,speed:s.speed,clips:s.clips,autoPlayClip:s.autoPlayClip,batchGroupId:s.batchGroupId,drawOrder:s.drawOrder,layers:s.layers.slice(0)})}onUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];if(i.data.enabled&&i.entity.enabled){const n=i.entity.sprite;n._currentClip&&n._currentClip._update(t)}}}onBeforeRemove(t,e){e.onDestroy()}}st._buildAccessors(G_.prototype,H_);class X_ extends st{constructor(t,e){super(t,e);this._oldState=!0,this._size=new y,this.on("set_enabled",this._onSetEnabled,this)}set size(t){t instanceof y?this._size.copy(t):t instanceof Array&&t.length>=3&&this.size.set(t[0],t[1],t[2])}get size(){return this._size}onEnable(){this._checkState()}onDisable(){this._checkState()}_onSetEnabled(t,e,s){this._checkState()}_checkState(){const t=this.enabled&&this.entity.enabled;t!==this._oldState&&(this._oldState=t,this.fire("enable"),this.fire("state",this.enabled))}_onBeforeRemove(){this.fire("remove")}}class ZP{constructor(){this.enabled=!0}}const j_=["enabled"];class JP extends Bt{constructor(t){super(t);this.id="zone",this.ComponentType=X_,this.DataType=ZP,this.schema=j_,this.on("beforeremove",this._onBeforeRemove,this)}initializeComponentData(t,e,s){t.enabled=e.hasOwnProperty("enabled")?!!e.enabled:!0,e.size&&(e.size instanceof y?t.size.copy(e.size):e.size instanceof Array&&e.size.length>=3&&t.size.set(e.size[0],e.size[1],e.size[2]))}cloneComponent(t,e){const s={size:t.zone.size};return this.addComponent(e,s)}_onBeforeRemove(t,e){e._onBeforeRemove()}}st._buildAccessors(X_.prototype,j_);class QP{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Ne().scene._stats}get lightmapper(){return Ne().lightmapper.stats}get batcher(){return Ne().batcher._stats}}class Ud{constructor(t,e){this.name=t,this.url=e,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}get loaded(){return!!this.data}get loading(){return this._loading}}class t1{constructor(t){this._app=t,this._list=[],this._index={},this._urlIndex={}}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new Ud(t,e),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let i=0;i<this._list.length;i++)s=this._list[i],this._index[s.name]=i,this._urlIndex[s.url]=i}}_loadSceneData(t,e,s){let i=t;if(t instanceof Ud?i=t.url:(t=this.findByUrl(i),t||(t=new Ud("Untitled",i))),!t.url){s("URL or SceneRegistryItem is null when loading a scene");return}if(t.loaded){s(null,t);return}const n=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!Zo.test(i)&&(i=ot.join(this._app.assets.prefix,i)),t._onLoadedCallbacks.push(s),t._loading||n.load(i,function(r,a){t.data=a,t._loading=!1;for(let l=0;l<t._onLoadedCallbacks.length;l++)t._onLoadedCallbacks[l](r,t);e||(t.data=null),t._onLoadedCallbacks.length=0}),t._loading=!0}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){typeof t=="string"&&(t=this.findByUrl(t)),t&&(t.data=null)}loadSceneHierarchy(t,e){const s=this,i=this._app.loader.getHandler("hierarchy");this._loadSceneData(t,!1,function(n,r){if(n){e&&e(n);return}const a=r.url,l=r.data,h=function(){s._app.systems.script.preloading=!0;const d=i.open(a,l);s._app.systems.script.preloading=!1,s._app.loader.clearCache(a,"hierarchy"),s._app.root.addChild(d),s._app.systems.fire("initialize",d),s._app.systems.fire("postInitialize",d),s._app.systems.fire("postPostInitialize",d),e&&e(n,d)};s._app._preloadScripts(l,h)})}loadSceneSettings(t,e){const s=this;this._loadSceneData(t,!1,function(i,n){i?e&&e(i):(s._app.applySceneSettings(n.data.settings),e&&e(null))})}loadScene(t,e){const s=this,i=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!Zo.test(t)&&(t=ot.join(this._app.assets.prefix,t)),i.load(t,function(n,r){if(n)e&&e(n);else{const a=function(){s._app.systems.script.preloading=!0;const h=i.open(t,r),c=s.findByUrl(t);c&&!c.loaded&&(c.data=r),s._app.systems.script.preloading=!1,s._app.loader.clearCache(t,"scene"),s._app.loader.patch({resource:h,type:"scene"},s._app.assets),s._app.root.addChild(h.root),s._app.systems.rigidbody&&typeof Ammo!="undefined"&&s._app.systems.rigidbody.gravity.set(h._gravity.x,h._gravity.y,h._gravity.z),e&&e(null,h)};s._app._preloadScripts(r,a)}})}}class e1{constructor(t){this.application=t,this.device=t.graphicsDevice,this.clearOptions=null,this.layer=null,this.init()}allocateTexture(t,e,s){const i=new nt(t,{format:s,width:t.width,height:t.height,mipmaps:!1,minFilter:bt,magFilter:bt,addressU:et,addressV:et});return i.name=e,t.scope.resolve("uDepthMap").setValue(i),i}allocateRenderTarget(t,e,s,i,n){const r=this.allocateTexture(e,s,i);return t?(t.destroyFrameBuffers(),n?t._depthBuffer=r:t._colorBuffer=r):t=new oe({colorBuffer:n?null:r,depthBuffer:n?r:null,depth:!n,stencil:e.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}initWebGl2(){const t=this.application,e=this;this.clearOptions={flags:0},this.layer=new Vi({enabled:!1,name:"Depth",id:fs,onEnable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=e.allocateRenderTarget(this.renderTarget,t.graphicsDevice,"rt-depth2",Qa,!0)},onDisable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPreRenderOpaque:function(s){const i=t.graphicsDevice.gl;this.srcFbo=i.getParameter(i.FRAMEBUFFER_BINDING),(this.renderTarget.width!==t.graphicsDevice.width||this.renderTarget.height!==t.graphicsDevice.height)&&this.onEnable(),this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onPostRenderOpaque:function(s){if(this.renderTarget){this.cameras[s].camera._clearOptions=this.oldClear,t.graphicsDevice.setRenderTarget(this.renderTarget),t.graphicsDevice.updateBegin();const i=t.graphicsDevice.gl;i.bindFramebuffer(i.READ_FRAMEBUFFER,this.srcFbo),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this.renderTarget.impl._glFrameBuffer),i.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,i.DEPTH_BUFFER_BIT,i.NEAREST)}}})}initWebGl1(){const t=this.application,e=this;this.clearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:Ha|pr},this.layer=new Vi({enabled:!1,name:"Depth",id:fs,shaderPass:ri,onEnable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=e.allocateRenderTarget(this.renderTarget,t.graphicsDevice,"rt-depth1",ct,!1)},onDisable:function(){e.releaseRenderTarget(this.renderTarget),this.renderTarget=null},onPostCull:function(s){const i=this.instances.visibleOpaque[s],n=i.list,r=t.scene.layers,a=r.subLayerEnabled,l=r.subLayerList,h=t.scene.layers.getLayerById(xe).renderTarget,c=this.cameras[s];let d=0;const u=r.layerList;for(let f=0;f<u.length;f++){const m=u[f];if(m===this)break;if(m.renderTarget!==h||!m.enabled||!a[f])continue;const p=m.cameras.indexOf(c);if(p<0)continue;let g=l[f]?m.instances.visibleTransparent[p]:m.instances.visibleOpaque[p];const w=g.length;g=g.list;for(let v=0;v<w;v++){const x=g[v];x.material&&x.material.depthWrite&&!x._noDepthDrawGl1&&(n[d]=x,d++)}}i.length=d},onPreRenderOpaque:function(s){(this.renderTarget.width!==t.graphicsDevice.width||this.renderTarget.height!==t.graphicsDevice.height)&&this.onEnable(),this.oldClear=this.cameras[s].camera._clearOptions,this.cameras[s].camera._clearOptions=e.clearOptions},onDrawCall:function(){t.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(s){!this.renderTarget||(this.cameras[s].camera._clearOptions=this.oldClear)}})}init(){this.device.webgl2?this.initWebGl2():this.initWebGl1()}patch(t){t.onEnable=this.layer.onEnable,t.onDisable=this.layer.onDisable,t.onPreRenderOpaque=this.layer.onPreRenderOpaque,t.onPostRenderOpaque=this.layer.onPostRenderOpaque,t.shaderPass=this.layer.shaderPass,t.onPostCull=this.layer.onPostCull,t.onDrawCall=this.layer.onDrawCall}}class q_{constructor(t){this.length=t,this.count=0}inc(){this.count++}done(){return this.count===this.length}}class qt extends at{constructor(t,e={}){super();qt._applications[t.id]=this,hc(this),this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Re.legacy,this._librariesLoaded=!1,this._fillMode=tp,this._resolutionMode=BC,this._allowResize=!0,this.context=this,e.graphicsDeviceOptions||(e.graphicsDeviceOptions={}),Dt.browser&&!!navigator.xr&&(e.graphicsDeviceOptions.xrCompatible=!0),e.graphicsDeviceOptions.alpha=e.graphicsDeviceOptions.alpha||!1,this.graphicsDevice=new Mb(t,e.graphicsDeviceOptions),this._initDefaultMaterial(),this.stats=new QP(this.graphicsDevice),this._soundManager=new qo(e),this.loader=new jT(this),Ct.init(this.graphicsDevice),this._entityIndex={},this.scene=new Ic(this.graphicsDevice),this._registerSceneImmediate(this.scene),this.root=new pt,this.root._enabledInHierarchy=!0,this.assets=new Jm(this.loader),e.assetPrefix&&(this.assets.prefix=e.assetPrefix),this.bundles=new PC(this.assets),this.enableBundles=typeof TextDecoder!="undefined",this.scriptsOrder=e.scriptsOrder||[],this.scripts=new DC(this),this.i18n=new OC(this),this.scenes=new t1(this);const s=this;this.defaultLayerWorld=new Vi({name:"World",id:xe}),this.sceneDepth=new e1(this),this.defaultLayerDepth=this.sceneDepth.layer,this.defaultLayerSkybox=new Vi({enabled:!0,name:"Skybox",id:ch,opaqueSortMode:Sh}),this.defaultLayerUi=new Vi({enabled:!0,name:"UI",id:lr,transparentSortMode:oy,passThrough:!1}),this.defaultLayerImmediate=new Vi({enabled:!0,name:"Immediate",id:ke,opaqueSortMode:Sh,passThrough:!0});const i=new mm("default");i.pushOpaque(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerDepth),i.pushOpaque(this.defaultLayerSkybox),i.pushTransparent(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerUi),this.scene.layers=i,this.scene.on("set:layers",function(n,r){const a=r.layerList;let l;for(let h=0;h<a.length;h++)switch(l=a[h],l.id){case fs:s.sceneDepth.patch(l);break;case lr:l.passThrough=s.defaultLayerUi.passThrough;break;case ke:l.passThrough=s.defaultLayerImmediate.passThrough;break}}),Wi.createPlaceholder(this.graphicsDevice),this.renderer=new sw(this.graphicsDevice),this.renderer.scene=this.scene,this.lightmapper=new o1(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this),this.batcher=new Gb(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this),this.keyboard=e.keyboard||null,this.mouse=e.mouse||null,this.touch=e.touch||null,this.gamepads=e.gamepads||null,this.elementInput=e.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.vr=null,this.xr=new iA(this),this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=e.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new ST(this.assets)),this.loader.addHandler("animation",new dT),this.loader.addHandler("animclip",new uT),this.loader.addHandler("animstategraph",new fT),this.loader.addHandler("model",new HT(this.graphicsDevice)),this.loader.addHandler("render",new XT(this.assets)),this.loader.addHandler("material",new FT(this)),this.loader.addHandler("texture",new AC(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("text",new eC),this.loader.addHandler("json",new RT),this.loader.addHandler("audio",new _T(this._soundManager)),this.loader.addHandler("script",new je(this)),this.loader.addHandler("scene",new qT(this)),this.loader.addHandler("cubemap",new TT(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("html",new ET),this.loader.addHandler("css",new wT),this.loader.addHandler("shader",new YT),this.loader.addHandler("hierarchy",new PT(this)),this.loader.addHandler("folder",new CT),this.loader.addHandler("font",new MT(this.loader)),this.loader.addHandler("binary",new gT),this.loader.addHandler("textureatlas",new nC(this.loader)),this.loader.addHandler("sprite",new JT(this.assets,this.graphicsDevice)),this.loader.addHandler("template",new tC(this)),this.loader.addHandler("container",new bT(this.graphicsDevice,this.assets)),this.systems=new sM,this.systems.add(new b_(this)),this.systems.add(new eM(this)),this.systems.add(new MM(this)),this.systems.add(new TA(this)),this.systems.add(new RA(this)),this.systems.add(new WM(this)),this.systems.add(new HM(this)),this.systems.add(new NA(this)),this.systems.add(new NM(this)),Re.legacy?this.systems.add(new AP(this)):this.systems.add(new bP(this)),this.systems.add(new FA(this,this._soundManager)),this.systems.add(new XP(this,this._soundManager)),this.systems.add(new LA(this,this._soundManager)),this.systems.add(new lP(this)),this.systems.add(new pP(this)),this.systems.add(new wM(this)),this.systems.add(new BA(this)),this.systems.add(new UP(this)),this.systems.add(new VP(this)),this.systems.add(new KP(this)),this.systems.add(new kM(this)),this.systems.add(new EM(this)),this.systems.add(new JP(this)),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),typeof document!="undefined"&&(document.hidden!==void 0?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):document.mozHidden!==void 0?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):document.msHidden!==void 0?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):document.webkitHidden!==void 0&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=s1(this)}static getApplication(t){return t?qt._applications[t]:Ne()}_initDefaultMaterial(){const t=new ue;t.name="Default Material",t.shadingModel=Ea,ZS(this.graphicsDevice,t)}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){Ft.get(t,(s,i)=>{if(s){e(s);return}const n=i.application_properties,r=i.scenes,a=i.assets;this._parseApplicationProperties(n,l=>{this._parseScenes(r),this._parseAssets(a),e(l||null)})})}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0}),s=new q_(e.length);let i=!1;const n=()=>{!this.graphicsDevice||!i&&s.done()&&(i=!0,this.fire("preload:end"),t())},r=e.length;if(s.length){const a=h=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()},l=(h,c)=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()};for(let h=0;h<e.length;h++)e[h].loaded?(s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()):(e[h].once("load",a),e[h].once("error",l),this.assets.load(e[h]))}else n()}_preloadScripts(t,e){if(!Re.legacy){e();return}this.systems.script.preloading=!0;const s=this._getScriptReferences(t),i=s.length,n=new q_(i),r=/^http(s)?:\/\//;if(i){const a=(l,h)=>{l&&console.error(l),n.inc(),n.done()&&(this.systems.script.preloading=!1,e())};for(let l=0;l<i;l++){let h=s[l];!r.test(h.toLowerCase())&&this._scriptPrefix&&(h=ot.join(self._scriptPrefix,s[l])),this.loader.load(h,"script",a)}}else this.systems.script.preloading=!1,e()}_handleAreaLightDataProperty(t){const e=this.assets.get(t);e?this.setAreaLightLuts(e):this.assets.once("add:"+t,this.setAreaLightLuts,this)}_parseApplicationProperties(t,e){if(typeof t.maxAssetRetries=="number"&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const s=new mm("application"),i={};for(const n in t.layers){const r=t.layers[n];r.id=parseInt(n,10),r.enabled=r.id!==fs,i[n]=new Vi(r)}for(let n=0,r=t.layerOrder.length;n<r;n++){const a=t.layerOrder[n],l=i[a.layer];!l||(a.transparent?s.pushTransparent(l):s.pushOpaque(l),s.subLayerEnabled[n]=a.enabled)}this.scene.layers=s}if(t.batchGroups)for(let s=0,i=t.batchGroups.length;s<i;s++){const n=t.batchGroups[s];this.batcher.addGroup(n.name,n.dynamic,n.maxAabbSize,n.id,n.layers)}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),t.areaLightDataAsset&&this._handleAreaLightDataProperty(t.areaLightDataAsset),this._loadLibraries(t.libraries,e)}_loadLibraries(t,e){const s=t.length;let i=s;const n=/^http(s)?:\/\//;if(s){const r=(a,l)=>{i--,a?e(a):i===0&&(this.onLibrariesLoaded(),e(null))};for(let a=0;a<s;++a){let l=t[a];!n.test(l.toLowerCase())&&this._scriptPrefix&&(l=ot.join(this._scriptPrefix,l)),this.loader.load(l,"script",r)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(!!t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},i={};if(Re.legacy){if(this.enableBundles)for(const n in t)t[n].type==="bundle"&&(i[n]=!0,e.push(t[n]));for(const n in t)i[n]||e.push(t[n])}else{for(let n=0;n<this.scriptsOrder.length;n++){const r=this.scriptsOrder[n];!t[r]||(s[r]=!0,e.push(t[r]))}if(this.enableBundles)for(const n in t)t[n].type==="bundle"&&(i[n]=!0,e.push(t[n]));for(const n in t)s[n]||i[n]||e.push(t[n])}for(let n=0;n<e.length;n++){const r=e[n],a=new rt(r.name,r.type,r.file,r.data);if(a.id=parseInt(r.id,10),a.preload=r.preload?r.preload:!1,a.loaded=r.type==="script"&&r.data&&r.data.loadingType>0,a.tags.add(r.tags),r.i18n)for(const l in r.i18n)a.addLocalizedAssetId(l,r.i18n[l]);this.assets.add(a)}}_getScriptReferences(t){let e=[];t.settings.priority_scripts&&(e=t.settings.priority_scripts);const s=[],i={};for(let r=0;r<e.length;r++)s.push(e[r]),i[e[r]]=!0;const n=t.entities;for(const r in n){if(!n[r].components.script)continue;const a=n[r].components.script.scripts;for(let l=0;l<a.length;l++)i[a[l].url]||(s.push(a[l].url),i[a[l].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:ds(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(t){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),Re.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}render(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")}_fillFrameStatsBasic(t,e,s){const i=this.stats.frame;i.dt=e,i.ms=s,t>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=t+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[ts]/3+Math.max(e[Cr]-2,0)+Math.max(e[Di]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<ts&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,t===cl&&e===void 0&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()}resizeCanvas(t,e){if(!this._allowResize||this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===tp){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height,r=s/i;n>r?(t=s,e=t/n):(e=i,t=e*n)}else this._fillMode===Qm&&(t=s,e=i);return this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px",this.updateCanvasSize(),{width:t,height:e}}updateCanvasSize(){if(!(!this._allowResize||this.xr.active)&&this._resolutionMode===cl){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){let e;if(this.systems.rigidbody&&typeof Ammo!="undefined"){const s=t.physics.gravity;this.systems.rigidbody.gravity.set(s[0],s[1],s[2])}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(t){if(t){const e=this.graphicsDevice;t.ready(s=>{Wi.set(e,s.resource)}),this.assets.load(t)}}setSkybox(t){if(t!==this._skyboxAsset){const e=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.on("change",s,this),this.scene.skyboxMip===0&&!this._skyboxAsset.loadFaces&&(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}enableVr(){this.vr||(this.vr=new dl(this))}disableVr(){this.vr&&(this.vr.destroy(),this.vr=null)}_firstBake(){this.lightmapper.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher.generate()}_processTimestamp(t){return t}drawLine(t,e,s,i,n){this.scene.drawLine(t,e,s,i,n)}drawLines(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(t,e,s,i)}drawLineArrays(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(t,e,s,i)}drawWireSphere(t,e,s=j.WHITE,i=20,n=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(t,e,s,i,n,r)}drawWireAlignedBox(t,e,s=j.WHITE,i=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireAlignedBox(t,e,s,i,n)}drawMeshInstance(t,e=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,s,t,null,i)}drawQuad(t,e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,t,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,i,n,r,a=this.scene.defaultDrawLayer){const l=new G;l.setTRS(new y(t,e,0),tt.IDENTITY,new y(s,i,0)),r||(r=new Ue,r.setParameter("colorMap",n),r.shader=this.scene.immediate.getTextureShader(),r.update()),this.drawQuad(l,r,a)}drawDepthTexture(t,e,s,i,n=this.scene.defaultDrawLayer){const r=new Ue;r.shader=this.scene.immediate.getDepthTextureShader(),r.update(),this.drawTexture(t,e,s,i,null,r,n)}destroy(){if(this._inFrameUpdate){this._destroyRequested=!0;return}const t=this.graphicsDevice.canvas.id;this.off("librariesloaded"),typeof document!="undefined"&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const e=this.assets.list();for(let s=0;s<e.length;s++)e[s].unload(),e[s].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const s in this.loader.getHandler("script")._cache){const i=this.loader.getHandler("script")._cache[s],n=i.parentNode;n&&n.removeChild(i)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroy(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),Re.app=null,qt._applications[t]=null,Ne()===this&&hc(null)}getEntityFromIndex(t){return this._entityIndex[t]}_registerSceneImmediate(t){this.on("postrender",t.immediate.onPostRender,t.immediate)}}qt._applications={};const kl={},s1=function(t){const e=t;let s;return function(i,n){if(!e.graphicsDevice)return;hc(e),s&&(window.cancelAnimationFrame(s),s=null);const r=e._processTimestamp(i)||ds(),a=r-(e._time||r);let l=a/1e3;l=U.clamp(l,0,e.maxDeltaTime),l*=e.timeScale,e._time=r,e.vr&&e.vr.display?s=e.vr.display.requestAnimationFrame(e.tick):e.xr.session?s=e.xr.session.requestAnimationFrame(e.tick):s=Dt.browser?window.requestAnimationFrame(e.tick):null,!e.graphicsDevice.contextLost&&(e._fillFrameStatsBasic(r,l,a),e._inFrameUpdate=!0,e.fire("frameupdate",a),n?(e.xr.update(n),e.graphicsDevice.defaultFramebuffer=n.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,e.update(l),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.updateCanvasSize(),e.render(),e.renderNextFrame=!1),kl.timestamp=ds(),kl.target=e,e.fire("frameend",kl),e.fire("frameEnd",kl),e.vr&&e.vr.display&&e.vr.display.presenting&&e.vr.display.submitFrame(),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy())}},ma=[];class pt extends xt{constructor(t,e){super(t);if(this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,t instanceof qt&&(e=t),!e&&(e=qt.getApplication(),!e))throw new Error("Couldn't find current application");this._app=e}addComponent(t,e){const s=this._app.systems[t];return!s||this.c[t]?null:s.addComponent(this,e)}removeComponent(t){const e=this._app.systems[t];!e||!this.c[t]||e.removeComponent(this)}findComponent(t){const e=this.findOne(function(s){return s.c&&s.c[t]});return e&&e.c[t]}findComponents(t){return this.find(function(s){return s.c&&s.c[t]}).map(function(s){return s.c[t]})}getGuid(){return this._guid||this.setGuid(Tg.create()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&ma.length===0&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&ma.push(t);const i=t._children;for(let n=0,r=i.length;n<r;n++)i[n]._enabled&&this._notifyHierarchyStateChanged(i[n],e);if(t._beingEnabled=!1,s){for(let n=0;n<ma.length;n++)ma[n]._onHierarchyStatePostChanged();ma.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this.c;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];i.enabled&&(t?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const t=this.c;for(const e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const s in this.c)this.c[s].enabled=!1;for(const s in this.c)this.c[s].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const t=this._children;let e=t.shift();for(;e;)e instanceof pt&&e.destroy(),e._parent=null,e=t.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,Y_(this,this,e,t),e}_cloneRecursively(t){const e=new pt(this._app);super._cloneInternal(e);for(const s in this.c)this.c[s].system.cloneComponent(this,e);for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof pt){const n=i._cloneRecursively(t);e.addChild(n),t[i.getGuid()]=n}}return e}}function Y_(o,t,e,s){if(t instanceof pt){const i=t.c;for(const a in i){const l=i[a],h=l.system.getPropertiesOfType("entity");for(let c=0,d=h.length;c<d;c++){const f=h[c].name,m=l[f];if(!!o.findByGuid(m)){const _=s[m].getGuid();_&&(e.c[a][f]=_)}}}i.script&&!e._app.useLegacyScriptAttributeCloning&&e.script.resolveDuplicatedEntityReferenceProperties(i.script,s),i.render&&e.render.resolveDuplicatedEntityReferenceProperties(i.render,s),i.anim&&e.anim.resolveDuplicatedEntityReferenceProperties(i.anim,s);const n=t.children.filter(function(a){return a instanceof pt}),r=e.children.filter(function(a){return a instanceof pt});for(let a=0,l=n.length;a<l;a++)Y_(o,n[a],r[a],s)}}const $_=new y;class K_ extends _m{constructor(t){const e=new pt("AmbientLight");e.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:Kt,color:j.WHITE,intensity:1,bakeDir:!1});super(t,e.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){kr.spherePointDeterministic($_,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt($_.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/e,1/s)}}class zl{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}const Z_=15;class i1{constructor(t){this.device=t,this.shaderDilate=we(t,F.fullscreenQuadVS,F.dilatePS,"lmDilate"),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e){this.shaderDenoise||(this.shaderDenoise=we(this.device,F.fullscreenQuadVS,F.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}evaluateDenoiseUniforms(t,e){function s(a,l){return .39894*Math.exp(-.5*a*a/(l*l))/l}this.kernel=this.kernel||new Float32Array(Z_);const i=this.kernel,n=Math.floor((Z_-1)/2);for(let a=0;a<=n;++a){const l=s(a,t);i[n+a]=l,i[n-a]=l}this.constantKernel.setValue(this.kernel);const r=1/s(0,e);this.bZnorm.setValue(r)}}const n1=2048,r1=0,a1=1,Ul=new y;class o1{constructor(t,e,s,i,n){this.device=t,this.root=e,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i._shadowRenderer.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new j,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){Bs.decRef(this.blackTex),this.blackTex=null,Bs.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null}initBake(t){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new i1(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new nt(this.device,{width:4,height:4,format:ct,type:jt}),this.blackTex.name="lightmapBlack",Bs.incRef(this.blackTex);const e=new Or;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=hr,e.aspectRatio=1,e.node=new xt,this.camera=e}if(this.scene.clusteredLightingEnabled){const e=new pm(t.supportsAreaLights,t.maxTextureSize,()=>{});this.lightingParams=e;const s=this.scene.lighting;e.shadowsEnabled=s.shadowsEnabled,e.shadowAtlasResolution=s.shadowAtlasResolution,e.cookiesEnabled=s.cookiesEnabled,e.cookieAtlasResolution=s.cookieAtlasResolution,e.areaLightsEnabled=s.areaLightsEnabled,e.cells=new y(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new gc(t),this.worldClusters.name="ClusterLightmapper"}}finishBake(t){this.materials=[];function e(s){Bs.decRef(s.colorBuffer),s.destroy()}this.renderTargets.forEach(s=>{e(s)}),this.renderTargets.clear(),t.forEach(s=>{s.renderTargets.forEach(i=>{e(i)}),s.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(t,e,s,i){const n=new ue;if(n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.transformVS=`#define UV1LAYOUT
`+F.transformVS,s===r1){let r=F.bakeLmEndPS;i?r=`
										dDiffuseLight = ((dDiffuseLight - 0.5) * max(${e.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;
										dDiffuseLight += vec3(${e.ambientBakeOcclusionBrightness.toFixed(1)});
										dDiffuseLight = saturate(dDiffuseLight);
										dDiffuseLight *= dAmbientLight;
								`+r:(n.ambient=new j(0,0,0),n.ambientTint=!0),n.chunks.endPS=r,n.lightMap=this.blackTex}else n.chunks.basePS=F.basePS+`
uniform sampler2D texture_dirLightMap;
uniform float bakeDir;
`,n.chunks.endPS=F.bakeDirLmEndPS;return n.chunks.outputAlphaPS=`
`,n.chunks.outputAlphaOpaquePS=`
`,n.chunks.outputAlphaPremulPS=`
`,n.cull=me,n.forceUv1=!0,n.update(),n.updateShader(t,e),n}createMaterials(t,e,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,e,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,e,0,!0),this.ambientAOMaterial.onUpdateShader=function(i){return i.lightMapWithoutAmbient=!0,i.separateAmbient=!0,i})}createTexture(t,e,s){const i=new nt(this.device,{width:t,height:t,format:ct,mipmaps:!1,type:e,minFilter:bt,magFilter:bt,addressU:et,addressV:et});return i.name=s,i}collectModels(t,e,s){var i,n,r;if(!t.enabled)return;let a;if((i=t.model)!=null&&i.model&&(n=t.model)!=null&&n.enabled&&(s&&s.push(new zl(t)),t.model.lightmapped&&e&&(a=t.model.model.meshInstances)),(r=t.render)!=null&&r.enabled&&(s&&s.push(new zl(t)),t.render.lightmapped&&e&&(a=t.render.meshInstances)),a){let l=!0;for(let h=0;h<a.length;h++)if(!a[h].mesh.vertexBuffer.format.hasUv1){l=!1;break}if(l){const h=[];for(let c=0;c<a.length;c++){const d=a[c].mesh;this._tempSet.has(d)?e.push(new zl(t,[a[c]])):h.push(a[c]),this._tempSet.add(d)}this._tempSet.clear(),h.length>0&&e.push(new zl(t,h))}}for(let l=0;l<t._children.length;l++)this.collectModels(t._children[l],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const n=t[s].meshInstances;for(let r=0;r<n.length;r++)n[r].visibleThisFrame=!0,e.push(n[r])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let i=0;i<s.length;i++)s[i].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,i=Ul;let n,r;t.model?(r=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(n=e.area)):t.model._area&&(e=t.model,e._area&&(n=e._area))):t.render&&(r=t.render.lightmapSizeMultiplier,t.render.type!=="asset"&&t.render._area&&(e=t.render,e._area&&(n=e._area)));const a={x:1,y:1,z:1,uv:1};n&&(a.x=n.x,a.y=n.y,a.z=n.z,a.uv=n.uv);const l=r||1;a.x*=l,a.y*=l,a.z*=l;const h=t.render||t.model,c=this.computeNodeBounds(h.meshInstances);i.copy(c.halfExtents);let d=a.x*i.y*i.z+a.y*i.x*i.z+a.z*i.x*i.y;return d/=a.uv,d=Math.sqrt(d),Math.min(U.nextPowerOfTwo(d*s),this.scene.lightmapMaxResolution||n1)}setLightmapping(t,e,s,i){for(let n=0;n<t.length;n++){const r=t[n],a=r.meshInstances;for(let l=0;l<a.length;l++){const h=a[l];if(h.setLightmapped(e),e){i&&(h._shaderDefs|=i),h.mask=Es;for(let c=0;c<s;c++){const d=r.renderTargets[c].colorBuffer;d.minFilter=Yt,d.magFilter=Yt,h.setRealtimeLightmap(vt.lightmapParamNames[c],d)}}}}}bake(t,e=Ua){const s=this.device,i=ds();this.scene._updateSkybox(s),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,l=[],h=[];if(t){for(let d=0;d<t.length;d++)this.collectModels(t[d],l,null);this.collectModels(this.root,null,h)}else this.collectModels(this.root,l,h);if(l.length>0){const d=e===Ua?2:1;this.setLightmapping(l,!1,d),this.initBake(s),this.bakeInternal(d,l,h);let u=Da;e===Ua&&(u|=gh),this.scene.ambientBake&&(u|=yh),this.setLightmapping(l,!0,d,u),this.finishBake(l)}const c=ds();this.stats.totalRenderTime=c-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=l.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const i=t[s],n=this.calculateLightmapSize(i.node);for(let r=0;r<e;r++){const a=this.createTexture(n,_e,"lightmapper_lightmap_"+s);Bs.incRef(a),i.renderTargets[r]=new oe({colorBuffer:a,depth:!1})}if(!this.renderTargets.has(n)){const r=this.createTexture(n,_e,"lightmapper_temp_lightmap_"+n);Bs.incRef(r),this.renderTargets.set(n,new oe({colorBuffer:r,depth:!1}))}}}prepareLightsToBake(t,e,s){if(this.scene.ambientBake){const n=new K_(this.scene);s.push(n)}const i=t._lights;for(let n=0;n<i.length;n++){const r=i[n],a=new gw(this.scene,r);e.push(a),r.enabled&&(r.mask&Rs)!=0&&(r.isStatic=!1,r.mask=4294967295,r.shadowUpdateMode=r.type===lt?za:ur,s.push(a))}s.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=lh,this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)}computeNodeBounds(t){const e=new gt;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new gt;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let i=1;i<t.length;i++)e.add(t[i].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let i;return s.type===_t&&(i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=ys,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=s._outerConeAngle*2,this.renderer.updateCameraFrustum(i)),i}lightCameraPrepareAndCull(t,e,s,i){const n=t.light;let r=!0;if(n.type===lt){Ul.copy(i.center),Ul.y+=i.halfExtents.y,this.camera.node.setPosition(Ul),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=i.halfExtents.y*2;const a=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=a}else t.lightBounds.intersects(e.bounds)||(r=!1);if(n.type===_t){let a=!1;const l=e.meshInstances;for(let h=0;h<l.length;h++)if(l[h]._isVisible(s)){a=!0;break}a||(r=!1)}return r}setupLightArray(t,e){t[lt].length=0,t[ut].length=0,t[_t].length=0,t[e.type][0]=e,e.visibleThisFrame=!0}renderShadowMap(t,e,s,i){const n=i.light;return!t&&n.castShadows&&(!n.shadowMap&&!this.scene.clusteredLightingEnabled&&(n.shadowMap=this.shadowMapCache.get(this.device,n)),n.type===lt?this.renderer._shadowRenderer.cullDirectional(n,e,this.camera):this.renderer._shadowRenderer.cullLocal(n,e),this.renderer.renderShadows(s[n.type],this.camera)),!0}postprocessTextures(t,e,s){const i=1,n=this.lightmapFilters.shaderDilate,r=this.scene.lightmapFilterEnabled;r&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness);for(let a=0;a<e.length;a++){const l=e[a];for(let h=0;h<s;h++){const c=l.renderTargets[h],d=c.colorBuffer,u=this.renderTargets.get(d.width),f=u.colorBuffer;this.lightmapFilters.prepare(d.width,d.height);for(let m=0;m<i;m++)this.lightmapFilters.setSourceTexture(d),es(t,u,r&&h===0&&m===0?this.lightmapFilters.shaderDenoise:n),this.lightmapFilters.setSourceTexture(f),es(t,c,n)}}}bakeInternal(t,e,s){const i=this.scene,n=this.device,r=i.clusteredLightingEnabled;this.createMaterials(n,i,t),this.setupScene(),i.layers._update(),this.computeNodesBounds(e),this.allocateTextures(e,t);const a=[],l=[];this.prepareLightsToBake(i.layers,a,l),this.updateTransforms(s);const h=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);const c=this.computeBounds(h);let d,u,f,m;for(d=0;d<e.length;d++)for(f=e[d].meshInstances,u=0;u<f.length;u++)m=f[u],m.setLightmapped(!1),m.mask=Rs,m.setRealtimeLightmap(vt.lightmapParamNames[0],m.material.lightMap?m.material.lightMap:this.blackTex),m.setRealtimeLightmap(vt.lightmapParamNames[1],this.blackTex);for(u=0;u<l.length;u++)l[u].light.enabled=!1;const p=[[],[],[]];let _,g,w=!1;for(d=0;d<l.length;d++){const v=l[d],x=v instanceof K_;let S=v.numVirtualLights;t>1&&S>1&&v.light.bakeDir&&(S=1);for(let T=0;T<S;T++){S>1&&v.prepareVirtualLight(T,S),v.startBake();let b=!1;const C=this.lightCameraPrepare(n,v);for(g=0;g<e.length;g++){const M=e[g];if(f=M.meshInstances,!!this.lightCameraPrepareAndCull(v,M,C,c)){if(this.setupLightArray(p,v.light),r&&this.renderer.lightTextureAtlas.update(p[_t],p[ut],this.lightingParams),b=this.renderShadowMap(b,h,p,v),r){const D=p[_t].concat(p[ut]);this.worldClusters.update(D,this.scene.gammaCorrection,this.lightingParams)}for(this.backupMaterials(f),_=0;_<t&&!(_>0&&T>0||x&&_>0);_++){const D=M.renderTargets[_],I=M.renderTargets[_].colorBuffer.width,k=this.renderTargets.get(I),N=k.colorBuffer;_===0?w=i.updateShaders:w&&(i.updateShaders=!0);let X=this.passMaterials[_];for(x&&T+1===S&&_===0&&(X=this.ambientAOMaterial),u=0;u<f.length;u++)f[u].material=X;for(this.renderer.updateShaders(f),this.renderer.setCamera(this.camera,k,!0),_===a1&&this.constantBakeDir.setValue(v.light.bakeDir?1:0),r&&this.worldClusters.activate(this.renderer.lightTextureAtlas),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,f,f.length,p,Qe),M.renderTargets[_]=k,this.renderTargets.set(I,D),u=0;u<f.length;u++)m=f[u],m.setRealtimeLightmap(vt.lightmapParamNames[_],N),m._shaderDefs|=Da}this.restoreMaterials(f)}}v.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,e,t),g=0;g<s.length;g++)s[g].restore();this.restoreLights(a),this.restoreScene(),r||this.shadowMapCache.clear()}}const l1={};En.reservedNames.forEach((o,t,e)=>{l1[o]=1});function Nd(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class nn{constructor(t,e){let s={x:0,y:0};if(e){if(e instanceof nn)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else if(Nd())this.x=0,this.y=0;else return;this.wheelDelta=0,e.type==="wheel"&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),Nd()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),e.type==="mousedown"||e.type==="mouseup"?this.button=e.button:this.button=BP,this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.event=e}}class Vd extends at{constructor(t){super();this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault()},this._target=null,this._attached=!1,this.attach(t)}static isPointerLocked(){return Nd()}attach(t){if(this._target=t,this._attached)return;this._attached=!0;const e=Dt.passiveEvents?{passive:!1}:!1;window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const t=Dt.passiveEvents?{passive:!1}:!1;window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){!this._target||this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){!this._target||this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,e){if(!document.body.requestPointerLock){e&&e();return}const s=()=>{t(),document.removeEventListener("pointerlockchange",s)},i=()=>{e(),document.removeEventListener("pointerlockerror",i)};t&&document.addEventListener("pointerlockchange",s,!1),e&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(t){if(!document.exitPointerLock)return;const e=()=>{t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new nn(this,t);!e.event||this.fire(OP,e)}_handleDown(t){this._buttons[t.button]=!0;const e=new nn(this,t);!e.event||this.fire(DP,e)}_handleMove(t){const e=new nn(this,t);!e.event||(this.fire(FP,e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new nn(this,t);!e.event||this.fire(L_,e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-i}}}let Ze,bi;const J_=new y,Q_=new y,Zs=new hn,Wd=new hn,Gd=new hn;Zs.end=new y;Wd.end=new y;Gd.end=new y;const Qn=new y,Nl=new y,Hd=new y,tg=new y,Xd=new y,Vl=new y,Wl=new y,Gl=new y,Hl=new y,jd=new y,h1=new y,tr=new y,pa=new y,Xl=new y,jl=new y,_a=new y,eg=new y,sg=new y,ig=new y,ng=new y,c1=new Z;function rg(o,t,e){return h1.cross(o,t).dot(e)}function d1(o,t,e){Qn.sub2(t,o),Nl.sub2(e[0],o),Hd.sub2(e[1],o),tg.sub2(e[2],o),Vl.cross(tg,Qn);let s=Nl.dot(Vl),i,n;if(s>=0){if(i=-Hd.dot(Vl),i<0||(n=rg(Qn,Hd,Nl),n<0))return-1;const r=1/(i+s+n);Wl.copy(e[0]).mulScalar(i*r),Gl.copy(e[1]).mulScalar(s*r),Hl.copy(e[2]).mulScalar(n*r),jd.copy(Wl).add(Gl).add(Hl)}else{if(Xd.sub2(e[3],o),i=Xd.dot(Vl),i<0||(n=rg(Qn,Nl,Xd),n<0))return-1;s=-s;const r=1/(i+s+n);Wl.copy(e[0]).mulScalar(i*r),Gl.copy(e[3]).mulScalar(s*r),Hl.copy(e[2]).mulScalar(n*r),jd.copy(Wl).add(Gl).add(Hl)}return Qn.sub2(e[0],e[2]).lengthSq()<1e-4*1e-4||Qn.sub2(e[1],e[3]).lengthSq()<1e-4*1e-4?-1:jd.sub(o).lengthSq()}class qd{constructor(t,e,s){this.event=t,this.element=e,this.camera=s,this._stopPropagation=!1}stopPropagation(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}class ql extends qd{constructor(t,e,s,i,n,r,a){super(t,e,s);this.x=i,this.y=n,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.button=t.button,Vd.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=i-r,this.dy=n-a),this.wheelDelta=0,t.type==="wheel"&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1))}}class ga extends qd{constructor(t,e,s,i,n,r){super(t,e,s);this.touches=t.touches,this.changedTouches=t.changedTouches,this.x=i,this.y=n,this.touch=r}}class rn extends qd{constructor(t,e,s,i){super(t,e,s);this.inputSource=i}}class u1{constructor(t,e){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastX=0,this._lastY=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchendHandler=this._handleTouchEnd.bind(this),this._touchcancelHandler=this._touchendHandler,this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._hoveredElement=null,this._pressedElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!e||e.useMouse!==!1,this._useTouch=!e||e.useTouch!==!1,this._useXr=!e||e.useXr!==!1,this._selectEventsAttached=!1,Dt.touch&&(this._clickedEntities={}),this.attach(t)}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set app(t){this._app=t}get app(){return this._app||Ne()}attach(t){this._attached&&(this._attached=!1,this.detach()),this._target=t,this._attached=!0;const e=Dt.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)),this._useTouch&&Dt.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,e),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()}attachSelectEvents(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))}detach(){if(!this._attached)return;this._attached=!1;const t=Dt.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,t),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}addElement(t){this._elements.indexOf(t)===-1&&this._elements.push(t)}removeElement(t){const e=this._elements.indexOf(t);e!==-1&&this._elements.splice(e,1)}_handleUp(t){!this._enabled||Vd.isPointerLocked()||(this._calcMouseCoords(t),Ze!==null&&this._onElementMouseEvent("mouseup",t))}_handleDown(t){!this._enabled||Vd.isPointerLocked()||(this._calcMouseCoords(t),Ze!==null&&this._onElementMouseEvent("mousedown",t))}_handleMove(t){!this._enabled||(this._calcMouseCoords(t),Ze!==null&&(this._onElementMouseEvent("mousemove",t),this._lastX=Ze,this._lastY=bi))}_handleWheel(t){!this._enabled||(this._calcMouseCoords(t),Ze!==null&&this._onElementMouseEvent("mousewheel",t))}_determineTouchedElements(t){const e={},s=this.app.systems.camera.cameras;for(let i=s.length-1;i>=0;i--){const n=s[i];let r=0;const a=t.changedTouches.length;for(let l=0;l<a;l++){if(e[t.changedTouches[l].identifier]){r++;continue}const h=this._calcTouchCoords(t.changedTouches[l]),c=this._getTargetElement(n,h.x,h.y);c&&(r++,e[t.changedTouches[l].identifier]={element:c,camera:n,x:h.x,y:h.y})}if(r===a)break}return e}_handleTouchStart(t){if(!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const n=t.changedTouches[s],r=e[n.identifier],a=this._touchedElements[n.identifier];r&&(!a||r.element!==a.element)&&(this._fireEvent(t.type,new ga(t,r.element,r.camera,r.x,r.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!1)}for(const s in e)this._touchedElements[s]=e[s]}_handleTouchEnd(t){if(!this._enabled)return;const e=this.app.systems.camera.cameras;for(const s in this._clickedEntities)delete this._clickedEntities[s];for(let s=0,i=t.changedTouches.length;s<i;s++){const n=t.changedTouches[s],r=this._touchedElements[n.identifier];if(!r)continue;const a=r.element,l=r.camera,h=r.x,c=r.y;if(delete this._touchedElements[n.identifier],delete this._touchesForWhichTouchLeaveHasFired[n.identifier],this._fireEvent(t.type,new ga(t,a,l,h,c,n)),t.touches.length===0){const d=this._calcTouchCoords(n);for(let u=e.length-1;u>=0;u--)this._getTargetElement(e[u],d.x,d.y)===a&&(this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new ga(t,a,l,h,c,n)),this._clickedEntities[a.entity.getGuid()]=!0))}}}_handleTouchMove(t){if(t.preventDefault(),!this._enabled)return;const e=this._determineTouchedElements(t);for(let s=0,i=t.changedTouches.length;s<i;s++){const n=t.changedTouches[s],r=e[n.identifier],a=this._touchedElements[n.identifier];if(a){const l=this._calcTouchCoords(n);(!r||r.element!==a.element)&&!this._touchesForWhichTouchLeaveHasFired[n.identifier]&&(this._fireEvent("touchleave",new ga(t,a.element,a.camera,l.x,l.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!0),this._fireEvent("touchmove",new ga(t,a.element,a.camera,l.x,l.y,n))}}}_onElementMouseEvent(t,e){let s;const i=this._hoveredElement;this._hoveredElement=null;const n=this.app.systems.camera.cameras;let r;for(let a=n.length-1;a>=0&&(r=n[a],s=this._getTargetElement(r,Ze,bi),!s);a--);s&&(this._fireEvent(t,new ql(e,s,r,Ze,bi,this._lastX,this._lastY)),this._hoveredElement=s,t==="mousedown"&&(this._pressedElement=s)),i!==this._hoveredElement&&(i&&this._fireEvent("mouseleave",new ql(e,i,r,Ze,bi,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new ql(e,this._hoveredElement,r,Ze,bi,this._lastX,this._lastY))),t==="mouseup"&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,(!this._clickedEntities||!this._clickedEntities[this._hoveredElement.entity.getGuid()])&&this._fireEvent("click",new ql(e,this._hoveredElement,r,Ze,bi,this._lastX,this._lastY))):this._pressedElement=null)}_onXrStart(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)}_onXrEnd(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)}_onXrUpdate(){if(!this._enabled)return;const t=this.app.xr.input.inputSources;for(let e=0;e<t.length;e++)this._onElementSelectEvent("selectmove",t[e],null)}_onXrInputRemove(t){const e=this._selectedElements[t.id];e&&(t._elementEntity=null,this._fireEvent("selectleave",new rn(null,e,null,t))),delete this._selectedElements[t.id],delete this._selectedPressedElements[t.id]}_onSelectStart(t,e){!this._enabled||this._onElementSelectEvent("selectstart",t,e)}_onSelectEnd(t,e){!this._enabled||this._onElementSelectEvent("selectend",t,e)}_onElementSelectEvent(t,e,s){let i;const n=this._selectedElements[e.id];let r;const a=this.app.systems.camera.cameras;let l;if(e.elementInput){Gd.set(e.getOrigin(),e.getDirection());for(let c=a.length-1;c>=0&&(l=a[c],i=this._getTargetElementByRay(Gd,l),!i);c--);}e._elementEntity=i||null,i?(this._selectedElements[e.id]=i,r=i):delete this._selectedElements[e.id],n!==r&&(n&&this._fireEvent("selectleave",new rn(s,n,l,e)),r&&this._fireEvent("selectenter",new rn(s,r,l,e))),t==="selectstart"&&(this._selectedPressedElements[e.id]=r,r&&this._fireEvent("selectstart",new rn(s,r,l,e)));const h=this._selectedPressedElements[e.id];!e.elementInput&&h&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new rn(s,n,l,e))),t==="selectend"&&e.elementInput&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new rn(s,n,l,e)),h&&h===n&&this._fireEvent("click",new rn(s,h,l,e)))}_fireEvent(t,e){let s=e.element;for(;s.fire(t,e),!(e._stopPropagation||!s.entity.parent||(s=s.entity.parent.element,!s)););}_calcMouseCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?(Ze=null,bi=null):(Ze=t.clientX-s,bi=t.clientY-i)}_calcTouchCoords(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent;while(n);return{x:t.pageX-e,y:t.pageY-s}}_sortElements(t,e){const s=this.app.scene.layers.sortTransparentLayers(t.layers,e.layers);return s!==0?s:t.screen&&!e.screen?-1:!t.screen&&e.screen?1:!t.screen&&!e.screen?0:t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?-1:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?1:e.drawOrder-t.drawOrder}_getTargetElement(t,e,s){let i=null,n=1/0;this._elements.sort(this._sortHandler);let r,a;for(let l=0,h=this._elements.length;l<h;l++){const c=this._elements[l];if(c.screen&&c.screen.screen.screenSpace){if(r===void 0&&(r=this._calculateRayScreen(e,s,t,Zs)?Zs:null),!r)continue;if(this._checkElement(r,c,!0)>=0){i=c;break}}else{if(a===void 0&&(a=this._calculateRay3d(e,s,t,Wd)?Wd:null),!a)continue;const d=this._checkElement(a,c,!1);if(d>=0&&(d<n&&(i=c,n=d),c.screen)){i=c;break}}}return i}_getTargetElementByRay(t,e){let s=null;Zs.origin.copy(t.origin),Zs.direction.copy(t.direction),Zs.end.copy(Zs.direction).mulScalar(e.farClip*2).add(Zs.origin),this._elements.sort(this._sortHandler);for(let i=0,n=this._elements.length;i<n;i++){const r=this._elements[i];if((!r.screen||!r.screen.screen.screenSpace)&&this._checkElement(Zs,r,!1)>=0){s=r;break}}return s}_buildHitCorners(t,e,s,i,n){let r=e;if(t.entity&&t.entity.button){const l=t.entity.button.hitPadding||c1;pa.copy(t.entity.up),Xl.copy(pa).mulScalar(-1),_a.copy(t.entity.right),jl.copy(_a).mulScalar(-1),pa.mulScalar(l.w*i),Xl.mulScalar(l.y*i),_a.mulScalar(l.z*s),jl.mulScalar(l.x*s),eg.copy(r[0]).add(Xl).add(jl),sg.copy(r[1]).add(Xl).add(_a),ig.copy(r[2]).add(pa).add(_a),ng.copy(r[3]).add(pa).add(jl),r=[eg,sg,ig,ng]}if(s<0){const l=r[2].x,h=r[0].x;r[0].x=l,r[1].x=h,r[2].x=h,r[3].x=l}if(i<0){const l=r[2].y,h=r[0].y;r[0].y=l,r[1].y=l,r[2].y=h,r[3].y=h}if(n<0){const l=r[2].x,h=r[2].y,c=r[2].z;r[2].x=r[0].x,r[2].y=r[0].y,r[2].z=r[0].z,r[0].x=l,r[0].y=h,r[0].z=c}return r}_calculateScaleToScreen(t){let e=t.entity;const s=t.screen.screen.scale;for(tr.set(s,s,s);e&&!e.screen;)tr.mul(e.getLocalScale()),e=e.parent;return tr}_calculateScaleToWorld(t){let e=t.entity;for(tr.set(1,1,1);e;)tr.mul(e.getLocalScale()),e=e.parent;return tr}_calculateRayScreen(t,e,s,i){const n=this.app.graphicsDevice.width,r=this.app.graphicsDevice.height,a=s.rect.z*n,l=s.rect.w*r,h=s.rect.x*n,c=h+a,d=(1-s.rect.y)*r,u=d-l;let f=t*n/this._target.clientWidth,m=e*r/this._target.clientHeight;return f>=h&&f<=c&&m<=d&&m>=u?(f=n*(f-h)/a,m=r*(m-u)/l,m=r-m,i.origin.set(f,m,1),i.direction.set(0,0,-1),i.end.copy(i.direction).mulScalar(2).add(i.origin),!0):!1}_calculateRay3d(t,e,s,i){const n=this._target.clientWidth,r=this._target.clientHeight,a=s.rect.z*n,l=s.rect.w*r,h=s.rect.x*n,c=h+a,d=(1-s.rect.y)*r,u=d-l;let f=t,m=e;return t>=h&&t<=c&&e<=d&&m>=u?(f=n*(f-h)/a,m=r*(m-u)/l,s.screenToWorld(f,m,s.nearClip,J_),s.screenToWorld(f,m,s.farClip,Q_),i.origin.copy(J_),i.direction.set(0,0,-1),i.end.copy(Q_),!0):!1}_checkElement(t,e,s){if(e.maskedBy&&this._checkElement(t,e.maskedBy.element,s)<0)return-1;let i;s?i=this._calculateScaleToScreen(e):i=this._calculateScaleToWorld(e);const n=this._buildHitCorners(e,s?e.screenCorners:e.worldCorners,i.x,i.y,i.z);return d1(t.origin,t.end,n)}}an.endsWith=function(o,t){return o.endsWith(t)};an.startsWith=function(o,t){return o.startsWith(t)};Object.defineProperty(j.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}});Object.defineProperty(j.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}});U.INV_LOG2=Math.LOG2E;U.intToBytes=U.intToBytes32;U.bytesToInt=U.bytesToInt32;Object.defineProperty(H.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}});H.prototype.scale=H.prototype.mulScalar;Object.defineProperty(y.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}});y.prototype.scale=y.prototype.mulScalar;Object.defineProperty(Z.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}});Z.prototype.scale=Z.prototype.mulScalar;Ci.prototype.intersectRay=Ci.prototype.intersectsRay;Th.prototype.update=function(o,t){const e=new G;e.mul2(o,t),this.setFromMat4(e)};Object.defineProperty(F,"transformSkinnedVS",{get:function(){return`#define SKIN
`+F.transformVS}});const ag={"ambientPrefilteredCube.frag":"ambientEnv.frag","ambientPrefilteredCubeLod.frag":"ambientEnv.frag","dpAtlasQuad.frag":null,"genParaboloid.frag":null,"prefilterCubemap.frag":null,"reflectionDpAtlas.frag":"reflectionEnv.frag","reflectionPrefilteredCube.frag":"reflectionEnv.frag","reflectionPrefilteredCubeLod.frag":"reflectionEnv.frag"};Object.keys(ag).forEach(o=>{ag[o],Object.defineProperty(F,o,{get:function(){return null},set:function(){}})});Object.defineProperties(oe.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(o){}}});re.prototype.update=function(){};Object.defineProperties(nt.prototype,{rgbm:{get:function(){return this.type===jt},set:function(o){this.type=o?jt:_e}},swizzleGGGR:{get:function(){return this.type===un},set:function(o){this.type=o?un:_e}},_glTexture:{get:function(){return this.impl._glTexture}}});Object.defineProperty(Ic.prototype,"defaultMaterial",{get:function(){return zi(Ne().graphicsDevice)}});["128","64","32","16","8","4"].forEach((o,t)=>{Object.defineProperty(Ic.prototype,`skyboxPrefiltered${o}`,{get:function(){return this._prefilteredCubemaps[t]},set:function(e){this._prefilteredCubemaps[t]=e,this.updateShaders=!0}})});Object.defineProperty(dc.prototype,"model",{get:function(){return null}});vt.prototype.syncAabb=function(){};Ee.prototype.getTarget=function(o){return this.targets[o]};xt.prototype._dirtify=function(o){o?this._dirtifyLocal():this._dirtifyWorld()};xt.prototype.addLabel=function(o){this._labels[o]=!0};xt.prototype.getLabels=function(){return Object.keys(this._labels)};xt.prototype.hasLabel=function(o){return!!this._labels[o]};xt.prototype.removeLabel=function(o){delete this._labels[o]};xt.prototype.findByLabel=function(o,t=[]){this.hasLabel(o)&&t.push(this);for(let e=0;e<this._children.length;++e)t=this._children[e].findByLabel(o,t);return t};xt.prototype.getChildren=function(){return this.children};xt.prototype.getName=function(){return this.name};xt.prototype.getPath=function(){return this.path};xt.prototype.getRoot=function(){return this.root};xt.prototype.getParent=function(){return this.parent};xt.prototype.setName=function(o){this.name=o};Ue.prototype.getName=function(){return this.name};Ue.prototype.setName=function(o){this.name=o};Ue.prototype.getShader=function(){return this.shader};Ue.prototype.setShader=function(o){this.shader=o};function cs(o,t){Object.defineProperty(ue.prototype,t,{get:function(){return this[o]},set:function(e){this[o]=e}})}cs("diffuseTint","diffuseMapTint");cs("specularTint","specularMapTint");cs("emissiveTint","emissiveMapTint");cs("aoVertexColor","aoMapVertexColor");cs("diffuseVertexColor","diffuseMapVertexColor");cs("specularVertexColor","specularMapVertexColor");cs("emissiveVertexColor","emissiveMapVertexColor");cs("metalnessVertexColor","metalnessMapVertexColor");cs("glossVertexColor","glossMapVertexColor");cs("opacityVertexColor","opacityMapVertexColor");cs("lightVertexColor","lightMapVertexColor");Hi.prototype.getDuration=function(){return this.duration};Hi.prototype.getName=function(){return this.name};Hi.prototype.getNodes=function(){return this.nodes};Hi.prototype.setDuration=function(o){this.duration=o};Hi.prototype.setName=function(o){this.name=o};Cs.prototype.getAnimation=function(){return this.animation};Cs.prototype.getCurrentTime=function(){return this.currentTime};Cs.prototype.getLooping=function(){return this.looping};Cs.prototype.getNumNodes=function(){return this.numNodes};Cs.prototype.setAnimation=function(o){this.animation=o};Cs.prototype.setCurrentTime=function(o){this.currentTime=o};Cs.prototype.setLooping=function(o){this.looping=o};qo.prototype.getListener=function(){return this.listener};qo.prototype.getVolume=function(){return this.volume};qo.prototype.setVolume=function(o){this.volume=o};Jm.prototype.getAssetById=function(o){return this.get(o)};Object.defineProperty(ml.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(ml.prototype,"position",{get:function(){return this._localPosition}});Object.defineProperty(ml.prototype,"rotation",{get:function(){return this._localRotation}});Object.defineProperty(u1.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});Object.defineProperty(nn.prototype,"wheel",{get:function(){return this.wheelDelta*-2}});qt.prototype.isFullscreen=function(){return!!document.fullscreenElement};qt.prototype.enableFullscreen=function(o,t,e){o=o||this.graphicsDevice.canvas;const s=function n(){t(),document.removeEventListener("fullscreenchange",n)},i=function n(){e(),document.removeEventListener("fullscreenerror",n)};t&&document.addEventListener("fullscreenchange",s,!1),e&&document.addEventListener("fullscreenerror",i,!1),o.requestFullscreen?o.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):e()};qt.prototype.disableFullscreen=function(o){const t=function e(){o(),document.removeEventListener("fullscreenchange",e)};o&&document.addEventListener("fullscreenchange",t,!1),document.exitFullscreen()};qt.prototype.getSceneUrl=function(o){const t=this.scenes.find(o);return t?t.url:null};qt.prototype.loadScene=function(o,t){this.scenes.loadScene(o,t)};qt.prototype.loadSceneHierarchy=function(o,t){this.scenes.loadSceneHierarchy(o,t)};qt.prototype.loadSceneSettings=function(o,t){this.scenes.loadSceneSettings(o,t)};qt.prototype.renderMeshInstance=function(o,t){const e=t!=null&&t.layer?t.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(null,null,null,o,e)};qt.prototype.renderMesh=function(o,t,e,s){const i=s!=null&&s.layer?s.layer:this.scene.defaultDrawLayer;this.scene.immediate.drawMesh(t,e,o,null,i)};qt.prototype._addLines=function(o,t,e){const s=e&&e.layer?e.layer:this.scene.layers.getLayerById(ke),i=e&&e.depthTest!==void 0?e.depthTest:!0;this.scene.immediate.getBatch(s,i).addLines(o,t)};qt.prototype.renderLine=function(o,t,e){let s=e,i;const n=arguments[3],r=arguments[4];n instanceof j?(s=n,typeof r=="number"?r===xh?i={layer:this.scene.layers.getLayerById(ke),depthTest:!1}:i={layer:this.scene.layers.getLayerById(ke),depthTest:!0}:i=r):typeof n=="number"?(s=e,n===xh?i={layer:this.scene.layers.getLayerById(ke),depthTest:!1}:i={layer:this.scene.layers.getLayerById(ke),depthTest:!0}):n&&(i=n),this._addLines([o,t],[e,s],i)};qt.prototype.renderLines=function(o,t,e){if(e?typeof e=="number"&&(e===xh?e={layer:this.scene.layers.getLayerById(ke),depthTest:!1}:e={layer:this.scene.layers.getLayerById(ke),depthTest:!0}):e={layer:this.scene.layers.getLayerById(ke),depthTest:!0},!!t.length&&o.length!==t.length){console.error("renderLines: position/color arrays have different lengths");return}if(o.length%2!=0){console.error("renderLines: array length is not divisible by 2");return}this._addLines(o,t,e)};Object.defineProperty(Sl.prototype,"node",{get:function(){return this.entity}});Object.defineProperty(yd.prototype,"enable",{get:function(){return this.enabled},set:function(o){this.enabled=o}});Ml.prototype.setVisible=function(o){this.enabled=o};Object.defineProperty(Ml.prototype,"aabb",{get:function(){return null},set:function(o){}});Object.defineProperty(xd.prototype,"aabb",{get:function(){return null},set:function(o){}});Object.defineProperty(da.prototype,"bodyType",{get:function(){return this.type},set:function(o){this.type=o}});da.prototype.syncBodyToEntity=function(){this._updateDynamic()};b_.prototype.setGravity=function(){arguments.length===1?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};class f1{constructor(){Zd(this,"app");dg(this)}render(t){const e=new qt(t.current);e.setCanvasFillMode(Qm),e.setCanvasResolution(cl),window.addEventListener("resize",()=>e.resizeCanvas());const s=new pt("cube");s.addComponent("model",{type:"box"});const i=new pt("camera");i.addComponent("camera",{clearColor:new j(.1,.1,.1)}),e.root.addChild(i),i.setPosition(0,0,3);const n=new pt("light");n.addComponent("light"),e.root.addChild(n),n.setEulerAngles(45,0,0),e.on("update",h=>s.rotate(10*h,20*h,30*h));const r=s.clone();r.model.model.generateWireframe(),r.model.model.meshInstances.forEach(h=>{h.renderStyle=1,h.material=h.material.clone(),h.material.diffuse.set(0,0,0,0),h.material.specular.set(0,0,0,0),h.material.shininess=0,h.material.emissive.set(1,0,0,1),h.material.update()}),s.addChild(r);const a=new pt("cube");a.addComponent("model",{type:"sphere"});var l=a.getLocalEulerAngles();a.setLocalEulerAngles(l.x,l.y+90,l.z),a.setPosition(0,1,0),console.log(a.getPosition()),e.root.addChild(a),e.start()}}const m1=()=>{const o=cg(f1),t=Jd.exports.useRef(null);return Jd.exports.useEffect(()=>{o.render(t)},[]),Qd("div",{className:tu.rootRender,children:Qd("canvas",{id:"application-canvas",ref:t,className:tu.rootCanvas})})};var y1=ug(m1);export{y1 as default};
